{% extends 'base.html' %}
{% load static %}

{% block title %}学生仪表板 - 眼科临床训练系统{% endblock %}

{% block content %}
<div class="card">
    <div class="card-header">
        <h2>我的学习进度</h2>
    </div>
    <div class="card-body">
        <div class="stats-grid">
            <div class="stat-card" role="status" aria-label="总体学习进度">
                <div class="stat-number">{{ progress.progress_percentage|floatformat:1|default:0 }}%</div>
                <div class="stat-label">总体进度</div>
            </div>
            <div class="stat-card" role="status" aria-label="已完成病例数量">
                <div class="stat-number">{{ completed_sessions }}</div>
                <div class="stat-label">已完成病例</div>
            </div>
            <div class="stat-card" role="status" aria-label="总病例数量">
                <div class="stat-number">{{ total_clinical_cases }}</div>
                <div class="stat-label">总病例数</div>
            </div>
            <div class="stat-card" role="status" aria-label="总学习时长">
                <div class="stat-number">{{ progress.formatted_study_time|default:"0min" }}</div>
                <div class="stat-label">学习时长</div>
            </div>
        </div>

        <div class="progress-container" style="background: #f8f9fa; padding: 10px; border-radius: 4px; margin: 20px 0;">
            <div class="progress-bar" 
                 style="background: #007bff; height: 20px; border-radius: 10px; transition: width 0.3s; width: 0%;" 
                 data-progress="{{ progress.progress_percentage|floatformat:1|default:0 }}"></div>
            <div style="text-align: center; margin-top: 5px; color: #666;">学习进度：{{ completed_sessions }}/{{ total_clinical_cases }} 个病例</div>
        </div>

        <div style="text-align: center; margin: 30px 0;">
            <a href="{% url 'clinical_case_list' %}" class="btn" style="background: #007bff; color: white; padding: 12px 24px; border-radius: 6px; text-decoration: none;">
                <i class="fas fa-stethoscope"></i> 开始临床推理学习
            </a>
        </div>
    </div>
</div>

{% if recent_sessions %}
<div class="card">
    <div class="card-header">
        <h3>最近的学习记录</h3>
    </div>
    <div class="card-body">
        <table class="table">
            <thead>
                <tr>
                    <th>病例名称</th>
                    <th>学习状态</th>
                    <th>开始时间</th>
                    <th>完成时间</th>
                </tr>
            </thead>
            <tbody>
                {% for session in recent_sessions %}
                <tr>
                    <td>{{ session.clinical_case.title }}</td>
                    <td>
                        {% if session.completed_at %}
                            <span class="badge badge-success">已完成</span>
                        {% else %}
                            <span class="badge badge-warning">学习中</span>
                        {% endif %}
                    </td>
                    <td>{{ session.started_at|date:"Y-m-d H:i" }}</td>
                    <td>
                        {% if session.completed_at %}
                            {{ session.completed_at|date:"Y-m-d H:i" }}
                        {% else %}
                            -
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>
{% else %}
<div class="card">
    <div class="card-header">
        <h3>开始你的学习之旅</h3>
    </div>
    <div class="card-body" style="text-align: center; padding: 40px 20px;">
        <p style="color: #666; margin-bottom: 20px;">还没有学习记录，开始你的第一个临床推理病例吧！</p>
        <a href="{% url 'clinical_case_list' %}" class="btn" style="background: #28a745; color: white;">立即开始学习</a>
    </div>
</div>
{% endif %}

<script>
// 动态设置进度条宽度和颜色
document.addEventListener('DOMContentLoaded', function() {
    const progressBar = document.querySelector('.progress-bar');
    if (progressBar) {
        const progress = parseFloat(progressBar.dataset.progress) || 0;
        
        // 延迟设置宽度以创建动画效果
        setTimeout(() => {
            progressBar.style.width = progress + '%';
            
            // 根据进度设置颜色
            if (progress >= 100) {
                progressBar.style.background = '#28a745'; // 绿色 - 完成
            } else if (progress >= 80) {
                progressBar.style.background = '#20c997'; // 青绿色 - 优秀
            } else if (progress >= 60) {
                progressBar.style.background = '#ffc107'; // 黄色 - 良好
            } else if (progress >= 40) {
                progressBar.style.background = '#fd7e14'; // 橙色 - 一般
            } else {
                progressBar.style.background = '#dc3545'; // 红色 - 需要努力
            }
        }, 300);
        
        // 添加完成度提示
        if (progress >= 100) {
            const congratsMsg = document.createElement('div');
            congratsMsg.style.cssText = 'background: #d4edda; color: #155724; padding: 12px; border-radius: 4px; margin: 10px 0; text-align: center; border: 1px solid #c3e6cb;';
            congratsMsg.innerHTML = '🎉 恭喜你完成了所有病例的学习！继续保持学习的热情！';
            progressBar.parentElement.after(congratsMsg);
        }
    }
    
    // 添加统计卡片的动画效果
    const statCards = document.querySelectorAll('.stat-card');
    statCards.forEach((card, index) => {
        card.style.opacity = '0';
        card.style.transform = 'translateY(20px)';
        card.style.transition = 'all 0.5s ease';
        
        setTimeout(() => {
            card.style.opacity = '1';
            card.style.transform = 'translateY(0)';
        }, 100 + index * 100);
    });
});
</script>
{% endblock %}