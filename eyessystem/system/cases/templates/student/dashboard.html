{% extends 'base.html' %}
{% load static %}

{% block title %}å­¦ç”Ÿä»ªè¡¨æ¿ - çœ¼ç§‘ä¸´åºŠè®­ç»ƒç³»ç»Ÿ{% endblock %}

{% block content %}
<div class="card">
    <div class="card-header">
        <h2>æˆ‘çš„å­¦ä¹ è¿›åº¦</h2>
    </div>
    <div class="card-body">
        <div class="stats-grid">
            <div class="stat-card" role="status" aria-label="æ€»ä½“å­¦ä¹ è¿›åº¦">
                <div class="stat-number">{{ progress.progress_percentage|floatformat:1|default:0 }}%</div>
                <div class="stat-label">æ€»ä½“è¿›åº¦</div>
            </div>
            <div class="stat-card" role="status" aria-label="å·²å®Œæˆç—…ä¾‹æ•°é‡">
                <div class="stat-number">{{ completed_sessions }}</div>
                <div class="stat-label">å·²å®Œæˆç—…ä¾‹</div>
            </div>
            <div class="stat-card" role="status" aria-label="æ€»ç—…ä¾‹æ•°é‡">
                <div class="stat-number">{{ total_clinical_cases }}</div>
                <div class="stat-label">æ€»ç—…ä¾‹æ•°</div>
            </div>
            <div class="stat-card" role="status" aria-label="æ€»å­¦ä¹ æ—¶é•¿">
                <div class="stat-number">{{ progress.formatted_study_time|default:"0min" }}</div>
                <div class="stat-label">å­¦ä¹ æ—¶é•¿</div>
            </div>
        </div>

        <div class="progress-container" style="background: #f8f9fa; padding: 10px; border-radius: 4px; margin: 20px 0;">
            <div class="progress-bar" 
                 style="background: #007bff; height: 20px; border-radius: 10px; transition: width 0.3s; width: 0%;" 
                 data-progress="{{ progress.progress_percentage|floatformat:1|default:0 }}"></div>
            <div style="text-align: center; margin-top: 5px; color: #666;">å­¦ä¹ è¿›åº¦ï¼š{{ completed_sessions }}/{{ total_clinical_cases }} ä¸ªç—…ä¾‹</div>
        </div>

        <div style="text-align: center; margin: 30px 0;">
            <a href="{% url 'clinical_case_list' %}" class="btn" style="background: #007bff; color: white; padding: 12px 24px; border-radius: 6px; text-decoration: none;">
                <i class="fas fa-stethoscope"></i> å¼€å§‹ä¸´åºŠæ¨ç†å­¦ä¹ 
            </a>
        </div>
    </div>
</div>

{% if recent_sessions %}
<div class="card">
    <div class="card-header">
        <h3>æœ€è¿‘çš„å­¦ä¹ è®°å½•</h3>
    </div>
    <div class="card-body">
        <table class="table">
            <thead>
                <tr>
                    <th>ç—…ä¾‹åç§°</th>
                    <th>å­¦ä¹ çŠ¶æ€</th>
                    <th>å¼€å§‹æ—¶é—´</th>
                    <th>å®Œæˆæ—¶é—´</th>
                </tr>
            </thead>
            <tbody>
                {% for session in recent_sessions %}
                <tr>
                    <td>{{ session.clinical_case.title }}</td>
                    <td>
                        {% if session.completed_at %}
                            <span class="badge badge-success">å·²å®Œæˆ</span>
                        {% else %}
                            <span class="badge badge-warning">å­¦ä¹ ä¸­</span>
                        {% endif %}
                    </td>
                    <td>{{ session.started_at|date:"Y-m-d H:i" }}</td>
                    <td>
                        {% if session.completed_at %}
                            {{ session.completed_at|date:"Y-m-d H:i" }}
                        {% else %}
                            -
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>
{% else %}
<div class="card">
    <div class="card-header">
        <h3>å¼€å§‹ä½ çš„å­¦ä¹ ä¹‹æ—…</h3>
    </div>
    <div class="card-body" style="text-align: center; padding: 40px 20px;">
        <p style="color: #666; margin-bottom: 20px;">è¿˜æ²¡æœ‰å­¦ä¹ è®°å½•ï¼Œå¼€å§‹ä½ çš„ç¬¬ä¸€ä¸ªä¸´åºŠæ¨ç†ç—…ä¾‹å§ï¼</p>
        <a href="{% url 'clinical_case_list' %}" class="btn" style="background: #28a745; color: white;">ç«‹å³å¼€å§‹å­¦ä¹ </a>
    </div>
</div>
{% endif %}

<script>
// åŠ¨æ€è®¾ç½®è¿›åº¦æ¡å®½åº¦å’Œé¢œè‰²
document.addEventListener('DOMContentLoaded', function() {
    const progressBar = document.querySelector('.progress-bar');
    if (progressBar) {
        const progress = parseFloat(progressBar.dataset.progress) || 0;
        
        // å»¶è¿Ÿè®¾ç½®å®½åº¦ä»¥åˆ›å»ºåŠ¨ç”»æ•ˆæœ
        setTimeout(() => {
            progressBar.style.width = progress + '%';
            
            // æ ¹æ®è¿›åº¦è®¾ç½®é¢œè‰²
            if (progress >= 100) {
                progressBar.style.background = '#28a745'; // ç»¿è‰² - å®Œæˆ
            } else if (progress >= 80) {
                progressBar.style.background = '#20c997'; // é’ç»¿è‰² - ä¼˜ç§€
            } else if (progress >= 60) {
                progressBar.style.background = '#ffc107'; // é»„è‰² - è‰¯å¥½
            } else if (progress >= 40) {
                progressBar.style.background = '#fd7e14'; // æ©™è‰² - ä¸€èˆ¬
            } else {
                progressBar.style.background = '#dc3545'; // çº¢è‰² - éœ€è¦åŠªåŠ›
            }
        }, 300);
        
        // æ·»åŠ å®Œæˆåº¦æç¤º
        if (progress >= 100) {
            const congratsMsg = document.createElement('div');
            congratsMsg.style.cssText = 'background: #d4edda; color: #155724; padding: 12px; border-radius: 4px; margin: 10px 0; text-align: center; border: 1px solid #c3e6cb;';
            congratsMsg.innerHTML = 'ğŸ‰ æ­å–œä½ å®Œæˆäº†æ‰€æœ‰ç—…ä¾‹çš„å­¦ä¹ ï¼ç»§ç»­ä¿æŒå­¦ä¹ çš„çƒ­æƒ…ï¼';
            progressBar.parentElement.after(congratsMsg);
        }
    }
    
    // æ·»åŠ ç»Ÿè®¡å¡ç‰‡çš„åŠ¨ç”»æ•ˆæœ
    const statCards = document.querySelectorAll('.stat-card');
    statCards.forEach((card, index) => {
        card.style.opacity = '0';
        card.style.transform = 'translateY(20px)';
        card.style.transition = 'all 0.5s ease';
        
        setTimeout(() => {
            card.style.opacity = '1';
            card.style.transform = 'translateY(0)';
        }, 100 + index * 100);
    });
});
</script>
{% endblock %}