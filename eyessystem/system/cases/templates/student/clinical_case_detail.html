{% extends 'base.html' %}
{% load static %}

{% block title %}ä¸´åºŠæ¨ç† - {{ clinical_case.title }}{% endblock %}

{% block content %}
{% csrf_token %}
<div class="container-fluid mt-4">
  <!-- ä¸´åºŠæ¨ç†ç³»ç»Ÿæ ‡é¢˜ -->
  <div class="row mb-4">
    <div class="col-12 text-center">
      <h2 class="text-primary">
        <i class="fas fa-user-md"></i> ä¸´åºŠæ¨ç†å­¦ä¹ ç³»ç»Ÿ
        <small class="text-muted d-block mt-2">åŸºäºçœŸå®æ¡ˆä¾‹çš„ä¸´åºŠæ€ç»´è®­ç»ƒ</small>
      </h2>
    </div>
  </div>
  
  <!-- ä¸´åºŠæŒ‡å¯¼æç¤ºåŒºåŸŸ -->
  <div class="row mb-3">
    <div class="col-12">
      <div id="clinical-guidance">
        <!-- åŠ¨æ€ä¸´åºŠæŒ‡å¯¼å†…å®¹ -->
      </div>
    </div>
  </div>
  
  <!-- æ­¥éª¤è¿›åº¦æ¡ -->
  <div class="row mb-4">
    <div class="col-12">
      <div class="progress-stepper">
        <div class="stepper-items">
          <div class="stepper-item active" data-step="history">
            <div class="stepper-icon">1</div>
            <div class="stepper-title">ç—…å²é‡‡é›†</div>
          </div>
          <div class="stepper-item" data-step="examination">
            <div class="stepper-icon">2</div>
            <div class="stepper-title">æ£€æŸ¥é€‰æ‹©</div>
          </div>
          <div class="stepper-item" data-step="diagnosis">
            <div class="stepper-icon">3</div>
            <div class="stepper-title">è¯Šæ–­æ¨ç†</div>
          </div>
          <div class="stepper-item" data-step="treatment">
            <div class="stepper-icon">4</div>
            <div class="stepper-title">æ²»ç–—æ–¹æ¡ˆ</div>
          </div>
          <div class="stepper-item" data-step="feedback">
            <div class="stepper-icon">5</div>
            <div class="stepper-title">å­¦ä¹ åé¦ˆ</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="row">
    <!-- ä¸»è¦å­¦ä¹ å†…å®¹åŒºåŸŸ -->
    <div class="col-lg-8">
      <div class="card mb-3 shadow-sm">
        <div class="card-header bg-light">
          <!-- ç—…ä¾‹ä¿¡æ¯å¡ç‰‡åŒºåŸŸ -->
          <div class="mb-3">
            <div class="d-flex flex-wrap gap-2 align-items-center">
              <!-- ç—…ä¾‹åç§°å¡ç‰‡ -->
              <div class="case-info-card" style="background: linear-gradient(135deg, #e3f2fd, #bbdefb); border: 1px solid #2196f3; border-radius: 8px; padding: 8px 12px; display: inline-flex; align-items: center;">
                <i class="fas fa-eye text-primary me-2" style="font-size: 0.9em;"></i>
                <span class="fw-bold text-primary" id="case-title" style="font-size: 0.9rem;">{{ clinical_case.title }}</span>
              </div>
              
              <!-- é˜¶æ®µçŠ¶æ€å¡ç‰‡ -->
              <div class="stage-info-card" style="background: linear-gradient(135deg, #e8f5e8, #c8e6c8); border: 1px solid #4caf50; border-radius: 8px; padding: 8px 12px; display: inline-flex; align-items: center;">
                <i class="fas fa-tasks text-success me-2" style="font-size: 0.9em;"></i>
                <span class="fw-bold text-success" id="current-stage-badge" style="font-size: 0.9rem;">ç—…å²é‡‡é›†é˜¶æ®µ</span>
              </div>
            </div>
          </div>
          
          <!-- æ‚£è€…åŸºç¡€ä¿¡æ¯ -->
          <div class="patient-basic-info" id="patient-info">
            <div class="text-muted" style="font-size: 0.95rem; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;">
              <span style="color: #495057; font-weight: 600;">åŸºç¡€ä¿¡æ¯ï¼š</span>
              <span style="font-weight: 500;">{{ clinical_case.patient_age }}å² {{ clinical_case.get_patient_gender_display }}</span>
              <span style="margin: 0 12px; color: #6c757d;">â€¢</span>
              <span style="font-weight: 500;">ç¼–å·ï¼š{{ clinical_case.case_id }}</span>
              {% if clinical_case.patient_occupation %}
                <span style="margin: 0 12px; color: #6c757d;">â€¢</span>
                <span style="font-weight: 500;">èŒä¸šï¼š{{ clinical_case.patient_occupation }}</span>
              {% endif %}
            </div>
          </div>
        </div>
        <div class="card-body">
          <div id="stage-content">
            <div class="text-center p-5">
              <i class="fas fa-spinner fa-spin fa-2x text-primary"></i>
              <p class="mt-3">æ­£åœ¨åŠ è½½ä¸´åºŠæ¡ˆä¾‹æ•°æ®...</p>
            </div>
          </div>
        </div>
      </div>

      <!-- å¯¼èˆªæ§åˆ¶é¢æ¿ -->
      <div class="card" id="navigation-card">
        <div class="card-body">
          <!-- æŒ‰é’®è¡Œ -->
          <div class="d-flex justify-content-between align-items-center mb-3">
            <button class="btn btn-outline-secondary" id="btn-prev" disabled>
              <i class="fas fa-arrow-left me-1"></i> ä¸Šä¸€æ­¥
            </button>
            <button class="btn btn-primary" id="btn-next">
              ä¸‹ä¸€æ­¥ <i class="fas fa-arrow-right ms-1"></i>
            </button>
          </div>
          
          <!-- è¿›åº¦ä¿¡æ¯è¡Œ -->
          <div class="text-center">
            <small class="text-muted d-block mb-2">ä¸´åºŠæ¨ç†è¿›åº¦</small>
            <div style="width: 350px; height: 15px; background-color: #e9ecef; border-radius: 10px; margin: 0 auto; overflow: hidden; border: 1px solid #dee2e6;" class="progress-container">
              <div id="overall-progress" style="height: 100%; background: linear-gradient(90deg, #007bff, #0056b3); border-radius: 10px; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 0.8em; width: 25%; transition: width 0.6s ease;" role="progressbar">
                25%
              </div>
            </div>
            <small class="text-muted d-block mt-2" id="progress-text">æ­¥éª¤ 1/4 (25%)</small>
          </div>
        </div>
      </div>
    </div>

    <!-- ä¾§è¾¹å·¥å…·å’Œåé¦ˆåŒºåŸŸ -->
    <div class="col-lg-4">
      <!-- ä¸´åºŠè®°å½•é¢æ¿ -->
      <div class="card mb-3 border-primary">
        <div class="card-header bg-primary text-white">
          <h6 class="mb-0"><i class="fas fa-clipboard"></i> ä¸´åºŠè®°å½•</h6>
        </div>
        <div class="card-body">
          <div class="nav nav-pills mb-3" id="clinical-tabs" role="tablist">
            <a class="nav-item nav-link active" id="notes-tab" data-toggle="pill" href="#notes-panel" role="tab">ç¬”è®°</a>
            <a class="nav-item nav-link" id="timeline-tab" data-toggle="pill" href="#timeline-panel" role="tab">æ—¶é—´çº¿</a>
          </div>
          <div class="tab-content">
            <div class="tab-pane fade show active" id="notes-panel">
              <textarea id="clinical-notes" class="form-control" rows="5" placeholder="è®°å½•ä¸´åºŠæ€è€ƒè¿‡ç¨‹ã€é‰´åˆ«è¯Šæ–­è¦ç‚¹..."></textarea>
              <small class="text-muted mt-2 d-block">
                <i class="fas fa-lightbulb"></i> è®°å½•æ€ç»´è¿‡ç¨‹æœ‰åŠ©äºä¸´åºŠèƒ½åŠ›æå‡
              </small>
            </div>
            <div class="tab-pane fade" id="timeline-panel">
              <div id="learning-timeline">
                <small class="text-muted">å­¦ä¹ è¿›ç¨‹å°†åœ¨æ­¤æ˜¾ç¤º</small>
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <!-- å®æ—¶åé¦ˆé¢æ¿ -->
      <div class="card mb-3">
        <div class="card-header bg-success text-white">
          <h6 class="mb-0"><i class="fas fa-comments"></i> æ™ºèƒ½æŒ‡å¯¼</h6>
        </div>
        <div class="card-body" id="feedback-panel">
          <div class="text-center text-muted">
            <i class="fas fa-robot fa-2x mb-2"></i>
            <p class="mb-0">AIåŠ©æ•™å°†ä¸ºæ‚¨æä¾›å®æ—¶æŒ‡å¯¼</p>
          </div>
        </div>
      </div>
      
      <!-- å­¦ä¹ ç»Ÿè®¡é¢æ¿ -->
      <div class="card">
        <div class="card-header">
          <h6 class="mb-0"><i class="fas fa-chart-line"></i> å­¦ä¹ ç»Ÿè®¡</h6>
        </div>
        <div class="card-body">
          <div id="learning-stats">
            <div class="row text-center">
              <div class="col-6">
                <div class="border-right">
                  <div class="h4 mb-0" id="time-spent">00:00</div>
                  <small class="text-muted">ç”¨æ—¶</small>
                </div>
              </div>
              <div class="col-6">
                <div class="h4 mb-0" id="current-score">--</div>
                <small class="text-muted">å½“å‰å¾—åˆ†</small>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
/* ==================== ä¸´åºŠæ¨ç†ç³»ç»Ÿæ ·å¼ ==================== */

/* å¯¼èˆªæŒ‰é’®ç»Ÿä¸€æ ·å¼ */
#btn-prev, #btn-next {
  min-width: 120px;
  height: 40px;
  font-size: 14px;
  font-weight: 500;
  border-radius: 8px;
  transition: all 0.3s ease;
}

#btn-prev {
  border: 2px solid #6c757d;
  color: #6c757d;
}

#btn-prev:hover:not(:disabled) {
  background-color: #6c757d;
  color: white;
  transform: translateY(-1px);
}

#btn-next {
  background: linear-gradient(135deg, #007bff, #0056b3);
  border: none;
  color: white;
}

#btn-next:hover:not(:disabled) {
  background: linear-gradient(135deg, #0056b3, #004085);
  transform: translateY(-1px);
  box-shadow: 0 4px 8px rgba(0, 123, 255, 0.3);
}

#btn-prev:disabled, #btn-next:disabled {
  opacity: 0.5;
  cursor: not-allowed;
  transform: none;
}

/* è¿›åº¦æ¡æ ·å¼ä¼˜åŒ– */
.progress-container {
  position: relative;
  border: 1px solid #dee2e6;
  background-color: #e9ecef;
  border-radius: 10px;
  overflow: hidden;
  height: 15px;
  max-width: 350px;
  margin: 0 auto;
}

#overall-progress {
  height: 100%;
  border-radius: 10px;
  display: flex;
  align-items: center;
  justify-content: center;
  color: white;
  font-weight: bold;
  font-size: 0.8em;
  transition: width 0.6s ease, background 0.3s ease;
  min-width: 30px; /* ç¡®ä¿ç™¾åˆ†æ¯”æ–‡å­—æœ‰è¶³å¤Ÿç©ºé—´ */
}

/* æ£€æŸ¥ç»“æœå°å¡ç‰‡æ ·å¼ */
.exam-result-card {
  background: white;
  border: 1px solid #e3e6f0;
  border-radius: 12px;
  padding: 0;
  transition: all 0.3s ease;
  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
  overflow: hidden;
}

.exam-result-card:hover {
  transform: translateY(-2px);
  box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1);
  border-color: #007bff;
}

.exam-header {
  background: linear-gradient(135deg, #f8f9fa, #e9ecef);
  padding: 1rem 1.25rem;
  border-bottom: 1px solid #e3e6f0;
}

.exam-title {
  display: flex;
  align-items: center;
  font-size: 1.1rem;
}

.exam-content {
  padding: 1.25rem;
}

.result-label {
  font-size: 0.875rem;
  font-weight: 600;
  color: #6c757d;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  margin-bottom: 0.5rem;
}

.result-text {
  font-size: 0.95rem;
  line-height: 1.6;
  color: #495057;
  background: #f8f9fa;
  padding: 0.75rem 1rem;
  border-radius: 8px;
  border-left: 4px solid #007bff;
  margin: 0;
}

/* ç‰¹æ®Šæ£€æŸ¥ç»“æœæ ·å¼ */
.exam-result-card .fas.fa-eye {
  font-size: 1.1em;
  color: #007bff;
}

.exam-result-card .badge {
  font-size: 0.75rem;
  padding: 0.4em 0.8em;
  border-radius: 6px;
}

/* å“åº”å¼è®¾è®¡ */
@media (max-width: 768px) {
  .exam-header {
    padding: 0.875rem 1rem;
  }
  
  .exam-content {
    padding: 1rem;
  }
  
  .exam-title {
    font-size: 1rem;
  }
  
  .result-text {
    font-size: 0.9rem;
    padding: 0.625rem 0.875rem;
  }
}

/* æ²»ç–—æ–¹æ¡ˆåˆ†ææ ·å¼ä¼˜åŒ– */
.treatment-summary .card {
  border: none;
  background: linear-gradient(135deg, #f8f9fa, #e9ecef);
}

.treatment-summary .card-body {
  padding: 1.5rem;
}

.treatment-summary .bg-white {
  background: white !important;
  transition: all 0.3s ease;
  border: 1px solid #dee2e6 !important;
}

.treatment-summary .bg-white:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
  border-color: #007bff !important;
}

.treatment-summary .h4 {
  font-weight: 600;
  font-size: 1.8rem;
}

.treatment-summary .fw-500 {
  font-weight: 500;
}

.treatment-summary .rounded {
  border-radius: 8px !important;
}

/* å“åº”å¼ä¼˜åŒ– */
@media (max-width: 768px) {
  .treatment-summary .h4 {
    font-size: 1.5rem;
  }
  
  .treatment-summary .card-body {
    padding: 1rem;
  }
}

/* å­¦ä¹ å®Œæˆé¡µé¢æŒ‰é’®ç»Ÿä¸€æ ·å¼ - å±…ä¸­å¸ƒå±€ */
.action-buttons {
  width: 100%;
  display: flex;
  justify-content: center;
  align-items: center;
}

.action-buttons .btn {
  height: 50px;
  font-size: 15px;
  font-weight: 500;
  padding: 12px 20px;
  border-radius: 8px;
  transition: all 0.3s ease;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  text-decoration: none;
  border-width: 2px;
  white-space: nowrap;
  flex-grow: 1;
  max-width: none;
}

.action-buttons .btn i {
  margin-right: 8px;
  font-size: 1.1em;
  width: 16px;
  text-align: center;
}

.action-buttons .btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 6px 16px rgba(0, 0, 0, 0.15);
  text-decoration: none;
}

/* ç¡®ä¿outlineæ ·å¼çš„æŒ‰é’®ä¹Ÿæœ‰ç›¸åŒçš„è§†è§‰æ•ˆæœ */
.action-buttons .btn-outline-primary:hover {
  background-color: #007bff;
  border-color: #007bff;
  color: white;
}

.action-buttons .btn-outline-secondary:hover {
  background-color: #6c757d;
  border-color: #6c757d;
  color: white;
}

.action-buttons .btn-outline-success:hover {
  background-color: #28a745;
  border-color: #28a745;
  color: white;
}

/* æŒ‰é’®é—´è·è°ƒæ•´ */
.action-buttons .mx-2 {
  margin-left: 8px !important;
  margin-right: 8px !important;
}

/* æŒ‰é’®ç»„å®¹å™¨æ ·å¼ */
.action-buttons .d-flex[style*="max-width"] {
  justify-content: space-between;
  gap: 0;
}

/* å“åº”å¼è®¾è®¡ - å°å±å¹•æ—¶å †å æŒ‰é’® */
@media (max-width: 768px) {
  .action-buttons .d-flex[style*="max-width"] {
    flex-direction: column;
    gap: 10px;
    max-width: 300px !important;
  }
  
  .action-buttons .btn {
    margin: 0 !important;
    height: 45px;
    font-size: 14px;
  }
}

/* è¿›åº¦æŒ‡ç¤ºå™¨æ ·å¼ä¼˜åŒ– */
.progress-stepper {
  display: flex;
  justify-content: center;
  margin-bottom: 2rem;
  padding: 1rem;
  background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
  border-radius: 15px;
}

.stepper-items {
  display: flex;
  align-items: center;
  justify-content: space-between;
  width: 100%;
  max-width: 700px;
}

.stepper-item {
  display: flex;
  flex-direction: column;
  align-items: center;
  text-align: center;
  flex: 1;
  position: relative;
  transition: all 0.3s ease;
}

.stepper-item:not(:last-child)::after {
  content: '';
  position: absolute;
  top: 20px;
  left: 60%;
  width: 80%;
  height: 3px;
  background: linear-gradient(90deg, #dee2e6 0%, #ced4da 100%);
  z-index: 1;
  border-radius: 2px;
}

.stepper-item.active::after {
  background: linear-gradient(90deg, #007bff 0%, #0056b3 100%);
  box-shadow: 0 2px 4px rgba(0, 123, 255, 0.3);
}

.stepper-item.completed::after {
  background: linear-gradient(90deg, #28a745 0%, #1e7e34 100%);
  box-shadow: 0 2px 4px rgba(40, 167, 69, 0.3);
}

.stepper-icon {
  width: 45px;
  height: 45px;
  border-radius: 50%;
  background: linear-gradient(135deg, #e9ecef 0%, #ced4da 100%);
  color: #6c757d;
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: bold;
  font-size: 1.1rem;
  margin-bottom: 8px;
  position: relative;
  z-index: 2;
  border: 3px solid #fff;
  box-shadow: 0 4px 8px rgba(0,0,0,0.1);
  transition: all 0.3s ease;
}

.stepper-item.active .stepper-icon {
  background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
  color: white;
  transform: scale(1.1);
  box-shadow: 0 6px 12px rgba(0, 123, 255, 0.4);
  animation: pulse 2s infinite;
}

.stepper-item.completed .stepper-icon {
  background: linear-gradient(135deg, #28a745 0%, #1e7e34 100%);
  color: white;
  box-shadow: 0 4px 8px rgba(40, 167, 69, 0.3);
}

.stepper-item.thinking .stepper-icon {
  animation: thinking 1.5s ease-in-out infinite;
}

@keyframes pulse {
  0% { box-shadow: 0 6px 12px rgba(0, 123, 255, 0.4); }
  50% { box-shadow: 0 8px 16px rgba(0, 123, 255, 0.6); }
  100% { box-shadow: 0 6px 12px rgba(0, 123, 255, 0.4); }
}

@keyframes thinking {
  0%, 100% { transform: scale(1.1); }
  50% { transform: scale(1.05); }
}

.stepper-title {
  font-size: 0.9rem;
  color: #6c757d;
  margin-top: 4px;
  font-weight: 500;
  transition: all 0.3s ease;
}

.stepper-item.active .stepper-title {
  color: #007bff;
  font-weight: 600;
  transform: translateY(-2px);
}

.stepper-item.completed .stepper-title {
  color: #28a745;
  font-weight: 600;
}

/* ä¸´åºŠæŒ‡å¯¼åŒºåŸŸæ ·å¼ */
.clinical-guidance {
  border-left: 4px solid #007bff;
  background: linear-gradient(135deg, #f8f9ff 0%, #e6f3ff 100%);
  animation: slideIn 0.5s ease-out;
}

@keyframes slideIn {
  from { opacity: 0; transform: translateY(-10px); }
  to { opacity: 1; transform: translateY(0); }
}

.clinical-tips ul {
  list-style: none;
  padding-left: 0;
}

.clinical-tips li {
  position: relative;
  padding-left: 20px;
  margin-bottom: 5px;
}

.clinical-tips li::before {
  content: 'ğŸ’¡';
  position: absolute;
  left: 0;
  top: 0;
}

/* ç—…å²åˆ†æå·¥å…·æ ·å¼ */
/* ç—…å²é‡‡é›†é˜¶æ®µä¸“ç”¨æ ·å¼ */
.patient-history {
  animation: fadeInUp 0.6s ease-out;
}

.info-item {
  padding: 15px;
  border-radius: 8px;
  background: rgba(255, 255, 255, 0.8);
  transition: all 0.3s ease;
  border: 1px solid rgba(0,0,0,0.05);
}

.info-item:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(0,0,0,0.1);
  background: rgba(255, 255, 255, 0.95);
}

.chief-complaint-content blockquote {
  border-left: 4px solid #ff6b6b;
  padding-left: 20px;
  background: rgba(255, 107, 107, 0.05);
  border-radius: 0 8px 8px 0;
}

.illness-timeline {
  position: relative;
}

.formatted-history {
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  line-height: 1.8;
}

.time-marker {
  display: inline-block;
  animation: pulseGlow 2s infinite;
}

.symptom-highlight {
  display: inline-block;
  animation: highlightPulse 3s infinite;
}

@keyframes pulseGlow {
  0%, 100% { box-shadow: 0 0 5px rgba(52, 152, 219, 0.3); }
  50% { box-shadow: 0 0 15px rgba(52, 152, 219, 0.6); }
}

@keyframes highlightPulse {
  0%, 100% { box-shadow: 0 0 3px rgba(231, 76, 60, 0.2); }
  50% { box-shadow: 0 0 8px rgba(231, 76, 60, 0.4); }
}

/* åŒ»å­¦ç—…å²éƒ¨åˆ†æ ·å¼ */
.medical-history-sections {
  margin-top: 20px;
}

.medical-history-sections .card {
  transition: all 0.3s ease;
}

.medical-history-sections .card:hover {
  transform: translateY(-2px);
  box-shadow: 0 8px 25px rgba(0,0,0,0.15);
}

/* å›¾æ ‡å®¹å™¨åŠ¨ç”» */
.icon-container {
  transition: all 0.3s ease;
}

.card:hover .icon-container {
  transform: rotate(5deg) scale(1.1);
}

/* çœ¼åº•æ£€æŸ¥æç¤ºå­—å¹•æ ·å¼ */
#fundus-overlay {
  pointer-events: none;
  user-select: none;
}

#fundus-subtitle {
  letter-spacing: 1px;
  text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
  backdrop-filter: blur(10px);
  border: 2px solid rgba(255,255,255,0.1);
}

@media (max-width: 768px) {
  #fundus-subtitle {
    font-size: 1.4rem !important;
    padding: 15px 25px !important;
    max-width: 90% !important;
  }
}

/* ç—…ä¾‹ä¿¡æ¯å¡ç‰‡æ ·å¼ */
.case-info-card, .stage-info-card {
  transition: all 0.3s ease;
  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
}

.case-info-card:hover, .stage-info-card:hover {
  transform: translateY(-1px);
  box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
}

.case-info-card {
  background: linear-gradient(135deg, #e3f2fd, #bbdefb) !important;
  border: 1px solid #2196f3 !important;
}

.stage-info-card {
  background: linear-gradient(135deg, #e8f5e8, #c8e6c8) !important;
  border: 1px solid #4caf50 !important;
}

/* ä¸åŒé˜¶æ®µçš„å¡ç‰‡é¢œè‰² */
.stage-info-card.stage-history {
  background: linear-gradient(135deg, #e8f5e8, #c8e6c8) !important;
  border-color: #4caf50 !important;
}

.stage-info-card.stage-examination {
  background: linear-gradient(135deg, #fff3e0, #ffe0b2) !important;
  border-color: #ff9800 !important;
}

.stage-info-card.stage-diagnosis {
  background: linear-gradient(135deg, #f3e5f5, #e1bee7) !important;
  border-color: #9c27b0 !important;
}

.stage-info-card.stage-treatment {
  background: linear-gradient(135deg, #e0f2f1, #b2dfdb) !important;
  border-color: #009688 !important;
}

.stage-info-card.stage-complete {
  background: linear-gradient(135deg, #e8f5e8, #c8e6c8) !important;
  border-color: #4caf50 !important;
}

/* å“åº”å¼è®¾è®¡ */
@media (max-width: 576px) {
  .case-info-card, .stage-info-card {
    flex: 1;
    min-width: 0;
    justify-content: center;
  }
}

/* æ‚£è€…ä¿¡æ¯åŒºåŸŸæ ·å¼ */
.patient-basic-info {
  padding: 12px 16px;
  background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
  border-radius: 8px;
  border: 1px solid #dee2e6;
  margin-top: 12px;
  transition: all 0.3s ease;
}

.patient-basic-info:hover {
  background: linear-gradient(135deg, #fff 0%, #f8f9fa 100%);
  box-shadow: 0 2px 8px rgba(0,0,0,0.1);
  transform: translateY(-1px);
}



/* ç—…å²å†…å®¹æç¤ºæ¡† */
.alert-info {
  background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
  border: none;
  border-radius: 8px;
}

.alert-info i {
  color: #1976d2;
}

.symptom-tags .badge {
  margin: 2px;
  font-size: 0.85rem;
  padding: 0.4em 0.8em;
}

.timeline-info {
  background: white;
  padding: 10px;
  border-radius: 5px;
  border-left: 3px solid #007bff;
}

/* æ£€æŸ¥é€‰é¡¹æ ·å¼å¢å¼º */
.examination-option {
  transition: all 0.3s ease;
  cursor: pointer;
}

.examination-option:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(0,0,0,0.1);
}

.examination-option.selected {
  border-color: #007bff;
  background-color: #f8f9ff;
}

.examination-option .form-check-input:checked + .form-check-label {
  color: #007bff;
  font-weight: 600;
}

/* è¯Šæ–­é€‰é¡¹æ ·å¼ */
.diagnosis-option {
  border: 2px solid transparent;
  transition: all 0.3s ease;
  cursor: pointer;
}

.diagnosis-option:hover {
  border-color: #007bff;
  background-color: #f8f9ff;
}

.diagnosis-option.selected {
  border-color: #007bff;
  background-color: #e6f3ff;
}

/* æ²»ç–—æ–¹æ¡ˆæ ·å¼ */
.treatment-option {
  border-left: 4px solid #dee2e6;
  transition: all 0.3s ease;
}

.treatment-option.optimal {
  border-left-color: #28a745;
}

.treatment-option.acceptable {
  border-left-color: #ffc107;
}

.treatment-option.contraindicated {
  border-left-color: #dc3545;
  background-color: #fff5f5;
}

/* å­¦ä¹ ç»Ÿè®¡é¢æ¿ */
.learning-stats .h4 {
  font-family: 'Courier New', monospace;
  font-weight: bold;
}

/* æ—¶é—´çº¿æ ·å¼ */
.learning-timeline {
  max-height: 200px;
  overflow-y: auto;
}

.timeline-item {
  border-left: 2px solid #e9ecef;
  padding-left: 15px;
  margin-bottom: 10px;
  position: relative;
}

.timeline-item::before {
  content: '';
  position: absolute;
  left: -5px;
  top: 5px;
  width: 8px;
  height: 8px;
  background: #007bff;
  border-radius: 50%;
}

/* å“åº”å¼è®¾è®¡ */
@media (max-width: 768px) {
  .stepper-items {
    flex-direction: column;
    align-items: stretch;
  }
  
  .stepper-item {
    margin-bottom: 20px;
    flex-direction: row;
    justify-content: flex-start;
    text-align: left;
  }
  
  .stepper-item::after {
    display: none;
  }
  
  .stepper-icon {
    margin-right: 15px;
    margin-bottom: 0;
  }
}

/* åé¦ˆé¢æ¿åŠ¨ç”» */
.feedback-animation {
  animation: fadeInUp 0.5s ease-out;
}

@keyframes fadeInUp {
  from {
    opacity: 0;
    transform: translateY(20px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

/* æˆåŠŸåé¦ˆæ ·å¼ */
.feedback-positive {
  border-left: 4px solid #28a745;
  background-color: #d4edda;
}

.feedback-corrective {
  border-left: 4px solid #ffc107;
  background-color: #fff3cd;
}

.feedback-guidance {
  border-left: 4px solid #17a2b8;
  background-color: #d1ecf1;
}

/* åŠ¨ç”»æ•ˆæœæ ·å¼ */
.confetti-piece {
  border-radius: 2px;
  box-shadow: 0 1px 2px rgba(0,0,0,0.15);
}

.flash-success {
  animation: flashSuccess 0.9s ease-in-out;
}

.flash-warning {
  animation: flashWarning 0.9s ease-in-out;
}

@keyframes flashSuccess {
  0% { transform: scale(1); box-shadow: 0 0 0 rgba(40,167,69,0); }
  30% { transform: scale(1.04); box-shadow: 0 10px 30px rgba(40,167,69,0.18); }
  100% { transform: scale(1); box-shadow: 0 0 0 rgba(40,167,69,0); }
}

@keyframes flashWarning {
  0% { transform: scale(1); box-shadow: 0 0 0 rgba(255,193,7,0); }
  30% { transform: scale(1.04); box-shadow: 0 10px 30px rgba(255,193,7,0.18); }
  100% { transform: scale(1); box-shadow: 0 0 0 rgba(255,193,7,0); }
}

.step-highlight {
  animation: stepPulse 0.8s ease-out;
}

@keyframes stepPulse {
  0% { transform: scale(1); box-shadow: 0 0 0 rgba(0,123,255,0); }
  50% { transform: scale(1.08); box-shadow: 0 10px 30px rgba(0,123,255,0.22); }
  100% { transform: scale(1); box-shadow: 0 0 0 rgba(0,123,255,0); }
}
</style>
{% endblock %}

{% block extra_js %}
<script>
// ä¸´åºŠæ¨ç†æ•™å­¦ç³»ç»Ÿ - é‡æ–°è®¾è®¡çš„äº¤äº’é€»è¾‘
// ä½œä¸ºåŒ»ç–—æ•™è‚²å·¥ç¨‹å¸ˆï¼Œæˆ‘è®¾è®¡äº†ä¸€ä¸ªæ›´è´´è¿‘çœŸå®ä¸´åºŠæ€ç»´çš„å­¦ä¹ ç³»ç»Ÿ

(function() {
  // ==================== æ ¸å¿ƒçŠ¶æ€ç®¡ç† ====================
  var clinicalSession = {
    caseId: '{{ clinical_case.case_id }}',
    currentStage: 'history',
    stages: ['history', 'examination', 'diagnosis', 'treatment', 'feedback'],
    
    // ä¸´åºŠæ•°æ®æ”¶é›†
    selectedExaminations: [],
    examinationResults: [],
    clinicalFindings: {},
    
    // è¯Šæ–­æ¨ç†
    diagnosticHypotheses: [],
    selectedDiagnosis: null,
    differentialAnalysis: {},
    
    // æ²»ç–—å†³ç­–
    selectedTreatments: [],
    treatmentRationale: '',
    
    // å­¦ä¹ è¯„ä¼°
    scores: {
      examination: 0,
      diagnosis: 0,
      treatment: 0,
      overall: 0,
      clinicalThinking: 0
    },
    
    // æ—¶é—´è·Ÿè¸ª
    timeSpent: {},
    startTime: new Date(),
    
    // æ•™å­¦åé¦ˆ
    feedbackHistory: [],
    clinicalMistakes: [],
    learningInsights: []
  };

  // ==================== åŒ»å­¦æ•™è‚²æ ¸å¿ƒåŠŸèƒ½ ====================
  
  function updateClinicalProgress() {
    // æ›´æ–°å¯è§†åŒ–è¿›åº¦æŒ‡ç¤ºå™¨
    $('.stepper-item').removeClass('active completed thinking');
    var currentIndex = clinicalSession.stages.indexOf(clinicalSession.currentStage);
    
    for (var i = 0; i <= currentIndex; i++) {
      var $step = $('.stepper-item[data-step="' + clinicalSession.stages[i] + '"]');
      if (i === currentIndex) {
        $step.addClass('active thinking');
        // æ·»åŠ æ€è€ƒåŠ¨ç”»æ•ˆæœ
        $step.find('.stepper-icon').html('<i class="fas fa-brain fa-pulse"></i>');
      } else {
        $step.addClass('completed');
        $step.find('.stepper-icon').html('<i class="fas fa-check"></i>');
      }
    }
    // é«˜äº®å½“å‰æ­¥éª¤ä¸€æ¬¡
    highlightStep(clinicalSession.currentStage);
    
    // æ›´æ–°é˜¶æ®µæç¤º
    updateStageGuidance();
  }
  
  function updateStageGuidance() {
    var guidance = {
      'history': {
        title: 'ğŸ“‹ ç—…å²é‡‡é›†é˜¶æ®µ',
        instruction: 'ä»”ç»†é˜…è¯»æ‚£è€…çš„ä¸»è¯‰å’Œç—…å²ä¿¡æ¯ï¼Œè¿™æ˜¯ä¸´åºŠæ¨ç†çš„åŸºç¡€ã€‚æ€è€ƒï¼šæ‚£è€…çš„ä¸»è¦é—®é¢˜æ˜¯ä»€ä¹ˆï¼Ÿå¯èƒ½çš„ç—…å› æœ‰å“ªäº›ï¼Ÿ',
        tips: ['æ³¨æ„ç—‡çŠ¶çš„æ—¶é—´é¡ºåº', 'å…³æ³¨æ—¢å¾€å²çš„ç›¸å…³æ€§', 'æ€è€ƒç—‡çŠ¶çš„ä¸¥é‡ç¨‹åº¦']
      },
      'examination': {
        title: 'ğŸ” ä¸´åºŠæ£€æŸ¥é˜¶æ®µ', 
        instruction: 'åŸºäºç—…å²åˆ†æï¼Œé€‰æ‹©æœ€æœ‰ä»·å€¼çš„æ£€æŸ¥é¡¹ç›®ã€‚è®°ä½ï¼šåˆç†çš„æ£€æŸ¥é€‰æ‹©ä½“ç°ä¸´åºŠæ€ç»´èƒ½åŠ›ã€‚',
        tips: ['ä¼˜å…ˆé€‰æ‹©æ€§ä»·æ¯”é«˜çš„æ£€æŸ¥', 'é¿å…è¿‡åº¦æ£€æŸ¥', 'è€ƒè™‘æ£€æŸ¥çš„è¯Šæ–­ä»·å€¼']
      },
      'diagnosis': {
        title: 'ğŸ¯ è¯Šæ–­æ¨ç†é˜¶æ®µ',
        instruction: 'ç»¼åˆç—…å²å’Œæ£€æŸ¥ç»“æœï¼Œè¿›è¡Œé‰´åˆ«è¯Šæ–­ã€‚æ€è€ƒå„ç§å¯èƒ½æ€§çš„æ¦‚ç‡ï¼Œé€‰æ‹©æœ€å¯èƒ½çš„è¯Šæ–­ã€‚',
        tips: ['åˆ—å‡ºé‰´åˆ«è¯Šæ–­', 'åˆ†ææ”¯æŒå’Œåå¯¹è¯æ®', 'è€ƒè™‘ç–¾ç—…çš„æµè¡Œç—…å­¦ç‰¹ç‚¹']
      },
      'treatment': {
        title: 'ğŸ’Š æ²»ç–—å†³ç­–é˜¶æ®µ',
        instruction: 'åŸºäºç¡®å®šçš„è¯Šæ–­ï¼Œåˆ¶å®šåˆç†çš„æ²»ç–—æ–¹æ¡ˆã€‚è€ƒè™‘æ²»ç–—çš„æœ‰æ•ˆæ€§ã€å®‰å…¨æ€§å’Œæˆæœ¬æ•ˆç›Šã€‚',
        tips: ['ä¸ªä½“åŒ–æ²»ç–—æ–¹æ¡ˆ', 'è€ƒè™‘æ‚£è€…æ‰¿å—èƒ½åŠ›', 'æƒè¡¡è·ç›Šå’Œé£é™©']
      },
      'feedback': {
        title: 'ğŸ“š å­¦ä¹ æ€»ç»“é˜¶æ®µ',
        instruction: 'å›é¡¾æ•´ä¸ªä¸´åºŠæ¨ç†è¿‡ç¨‹ï¼Œæ€»ç»“å­¦ä¹ è¦ç‚¹å’Œæ”¹è¿›æ–¹å‘ã€‚',
        tips: ['åæ€å†³ç­–è¿‡ç¨‹', 'å·©å›ºå…³é”®çŸ¥è¯†ç‚¹', 'åˆ¶å®šå­¦ä¹ è®¡åˆ’']
      }
    };
    
    var current = guidance[clinicalSession.currentStage];
    if (current) {
      var html = '<div class="clinical-guidance card mb-3">';
      html += '<div class="card-body">';
      html += '<h6 class="card-title text-primary">' + current.title + '</h6>';
      html += '<p class="card-text">' + current.instruction + '</p>';
      html += '<div class="clinical-tips">';
      html += '<small class="text-muted"><strong>ä¸´åºŠæ€ç»´è¦ç‚¹ï¼š</strong></small>';
      html += '<ul class="small text-muted mb-0">';
      current.tips.forEach(function(tip) {
        html += '<li>' + tip + '</li>';
      });
      html += '</ul>';
      html += '</div>';
      html += '</div>';
      html += '</div>';
      
      $('#clinical-guidance').html(html);
    }
  }

  
  // ==================== ç—…å²é˜¶æ®µï¼šå»ºç«‹ä¸´åºŠå°è±¡ ====================
  
  function updatePatientInfoInHeader(data) {
    // æ›´æ–°æ ‡é¢˜åŒºåŸŸçš„æ‚£è€…ä¿¡æ¯ - å¸¦æ ‡ç­¾æ˜¾ç¤º
    var patientInfoHtml = '<div class="text-muted" style="font-size: 0.95rem; font-family: -apple-system, BlinkMacSystemFont, \'Segoe UI\', Roboto, Arial, sans-serif;">';
    
    // æ·»åŠ åŸºç¡€ä¿¡æ¯æ ‡ç­¾ï¼Œç„¶åæ˜¯å¹´é¾„æ€§åˆ«ã€ç¼–å·ã€èŒä¸š
    patientInfoHtml += '<span style="color: #495057; font-weight: 600;">åŸºç¡€ä¿¡æ¯ï¼š</span>';
    patientInfoHtml += '<span style="font-weight: 500;">' + (data.patient_info.age || 'æœªçŸ¥') + 'å² ' + (data.patient_info.gender || 'æœªçŸ¥') + '</span>';
    patientInfoHtml += '<span style="margin: 0 12px; color: #6c757d;">â€¢</span>';
    patientInfoHtml += '<span style="font-weight: 500;">ç¼–å·ï¼š' + data.case_id + '</span>';
    
    // èŒä¸šï¼ˆå¦‚æœæœ‰ï¼‰
    if (data.patient_info.occupation) {
      patientInfoHtml += '<span style="margin: 0 12px; color: #6c757d;">â€¢</span>';
      patientInfoHtml += '<span style="font-weight: 500;">èŒä¸šï¼š' + data.patient_info.occupation + '</span>';
    }
    
    patientInfoHtml += '</div>';
    
    // æ›´æ–°DOM
    $('#patient-info').html(patientInfoHtml);
  }
  
  function initializeHistoryStage() {
    clinicalSession.currentStage = 'history';
    updateClinicalProgress();
    
    // è®°å½•å¼€å§‹æ—¶é—´
    clinicalSession.timeSpent.history = new Date();
    
    $('#btn-prev').prop('disabled', true);
    $('#btn-next').text('å¼€å§‹æ£€æŸ¥é€‰æ‹© â†’').removeClass('btn-secondary').addClass('btn-primary');
    
    $.getJSON('/api/clinical/case/' + clinicalSession.caseId + '/', function(resp) {
      if (resp.success) {
        window.caseData = resp.data;
        
        // æ›´æ–°æ ‡é¢˜åŒºåŸŸçš„æ‚£è€…ä¿¡æ¯
        updatePatientInfoInHeader(resp.data);
        
        // æ¸²æŸ“ç—…å²å†…å®¹
        renderPatientHistory(resp.data);
        
        // æ·»åŠ ä¸´åºŠæ€è€ƒæç¤º
        showClinicalThinkingPrompt('history');
      } else {
        showErrorMessage('åŠ è½½ç—…å²ä¿¡æ¯å¤±è´¥: ' + resp.message);
      }
    }).fail(function() {
      showErrorMessage('ç½‘ç»œé”™è¯¯ï¼Œè¯·æ£€æŸ¥è¿æ¥åé‡è¯•');
    });
  }
  
  function renderPatientHistory(data) {
    var html = '<div class="patient-history">';
    
    // ç›´æ¥å¼€å§‹ä¸»è¯‰ï¼Œæ‚£è€…åŸºæœ¬ä¿¡æ¯å·²åœ¨æ ‡é¢˜åŒºåŸŸæ˜¾ç¤º
    
    // ä¸»è¯‰å¡ç‰‡ - é‡æ–°è®¾è®¡
    html += '<div class="card mb-4 shadow-sm border-0">';
    html += '<div class="card-header border-0" style="background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%); border-radius: 12px 12px 0 0;">';
    html += '<div class="d-flex align-items-center justify-content-between">';
    html += '<h5 class="mb-0 text-white d-flex align-items-center" style="font-weight: 600; letter-spacing: 0.5px;">';
    html += '<i class="fas fa-exclamation-circle me-2" style="font-size: 1.2rem;"></i>';
    html += 'ä¸»è¯‰ <span style="font-size: 0.9rem; font-weight: 400; opacity: 0.8; margin-left: 8px;">Chief Complaint</span>';
    html += '</h5>';
    html += '</div>';
    html += '</div>';
    html += '<div class="card-body" style="padding: 1.5rem; background: #fff8f0;">';
    html += '<div class="chief-complaint-content">';
    html += '<blockquote class="blockquote text-center mb-0">';
    html += '<p class="mb-0" style="font-size: 1.1rem; color: #2c3e50; font-weight: 500; line-height: 1.6; font-style: italic;">"' + (data.clinical_info.chief_complaint || 'æ— è®°å½•') + '"</p>';
    html += '</blockquote>';
    html += '</div>';
    html += '</div>';
    html += '</div>';
    
    // ç°ç—…å²å¡ç‰‡ - é‡æ–°è®¾è®¡
    html += '<div class="card mb-4 shadow-sm border-0">';
    html += '<div class="card-header border-0" style="background: linear-gradient(135deg, #2980b9 0%, #3498db 100%); border-radius: 12px 12px 0 0;">';
    html += '<div class="d-flex align-items-center justify-content-between">';
    html += '<h5 class="mb-0 text-white d-flex align-items-center" style="font-weight: 600; letter-spacing: 0.5px;">';
    html += '<i class="fas fa-clipboard-list me-2" style="font-size: 1.2rem;"></i>';
    html += 'ç°ç—…å² <span style="font-size: 0.9rem; font-weight: 400; opacity: 0.8; margin-left: 8px;">History of Present Illness</span>';
    html += '</h5>';
    html += '</div>';
    html += '</div>';
    html += '<div class="card-body" style="padding: 1.5rem; background: #f0f8ff;">';
    html += '<div class="present-illness-content" style="line-height: 1.8; font-size: 1rem; color: #2c3e50;">';
    
    var presentIllness = data.clinical_info.present_illness || data.clinical_info.history_of_present_illness || 'æ— è®°å½•';
    
    html += '<div class="illness-timeline">';
    html += formatMedicalHistory(presentIllness);
    html += '</div>';
    
    html += '</div>';
    html += '</div>';
    html += '</div>';
    
    // æ—¢å¾€å²ã€ä¸ªäººå²ã€å®¶æ—å² - æŒ‰æ ‡å‡†åŒ»å­¦ç—…å²æ ¼å¼æ’åˆ—
    html += '<div class="medical-history-sections">';
    
    // æ—¢å¾€å²
    if (data.clinical_info.past_history || data.clinical_info.past_medical_history) {
      html += '<div class="card mb-4 shadow-sm border-0">';
      html += '<div class="card-header border-0" style="background: linear-gradient(135deg, #27ae60 0%, #2ecc71 100%); border-radius: 12px 12px 0 0;">';
      html += '<div class="d-flex align-items-center justify-content-between">';
      html += '<h5 class="mb-0 text-white d-flex align-items-center" style="font-weight: 600; letter-spacing: 0.5px;">';
      html += '<i class="fas fa-history me-2" style="font-size: 1.2rem;"></i>';
      html += 'æ—¢å¾€å² <span style="font-size: 0.9rem; font-weight: 400; opacity: 0.8; margin-left: 8px;">Past Medical History</span>';
      html += '</h5>';
      html += '</div>';
      html += '</div>';
      html += '<div class="card-body" style="padding: 1.5rem; background: #f8fff8;">';
      var pastHistory = data.clinical_info.past_history || data.clinical_info.past_medical_history || 'æ— ç‰¹æ®Šæ—¢å¾€å²';
      html += '<p class="mb-0" style="line-height: 1.6; color: #2c3e50; font-size: 1rem;">' + formatMedicalHistory(pastHistory) + '</p>';
      html += '</div>';
      html += '</div>';
    }
    
    // ä¸ªäººå²
    if (data.clinical_info.personal_history || data.clinical_info.social_history) {
      html += '<div class="card mb-4 shadow-sm border-0">';
      html += '<div class="card-header border-0" style="background: linear-gradient(135deg, #8e44ad 0%, #9b59b6 100%); border-radius: 12px 12px 0 0;">';
      html += '<div class="d-flex align-items-center justify-content-between">';
      html += '<h5 class="mb-0 text-white d-flex align-items-center" style="font-weight: 600; letter-spacing: 0.5px;">';
      html += '<i class="fas fa-user-cog me-2" style="font-size: 1.2rem;"></i>';
      html += 'ä¸ªäººå² <span style="font-size: 0.9rem; font-weight: 400; opacity: 0.8; margin-left: 8px;">Personal & Social History</span>';
      html += '</h5>';
      html += '</div>';
      html += '</div>';
      html += '<div class="card-body" style="padding: 1.5rem; background: #faf8ff;">';
      var personalHistory = data.clinical_info.personal_history || data.clinical_info.social_history || 'æ— ç‰¹æ®Šä¸ªäººå²è®°å½•';
      html += '<p class="mb-0" style="line-height: 1.6; color: #2c3e50; font-size: 1rem;">' + formatMedicalHistory(personalHistory) + '</p>';
      html += '</div>';
      html += '</div>';
    }
    
    // å®¶æ—å²
    if (data.clinical_info.family_history) {
      html += '<div class="card mb-4 shadow-sm border-0">';
      html += '<div class="card-header border-0" style="background: linear-gradient(135deg, #e67e22 0%, #f39c12 100%); border-radius: 12px 12px 0 0;">';
      html += '<div class="d-flex align-items-center justify-content-between">';
      html += '<h5 class="mb-0 text-white d-flex align-items-center" style="font-weight: 600; letter-spacing: 0.5px;">';
      html += '<i class="fas fa-users me-2" style="font-size: 1.2rem;"></i>';
      html += 'å®¶æ—å² <span style="font-size: 0.9rem; font-weight: 400; opacity: 0.8; margin-left: 8px;">Family History</span>';
      html += '</h5>';
      html += '</div>';
      html += '</div>';
      html += '<div class="card-body" style="padding: 1.5rem; background: #fffaf0;">';
      html += '<p class="mb-0" style="line-height: 1.6; color: #2c3e50; font-size: 1rem;">' + formatMedicalHistory(data.clinical_info.family_history) + '</p>';
      html += '</div>';
      html += '</div>';
    }
    
    html += '</div>';
    
    html += '</div>';
    $('#stage-content').html(html);
  }
  
  function formatMedicalHistory(text) {
    // æ ¼å¼åŒ–ç—…å²æ–‡æœ¬ï¼Œçªå‡ºå…³é”®ä¿¡æ¯å¹¶æ”¹å–„å¯è¯»æ€§
    var formatted = text
      // æ—¶é—´æ ‡è®°
      .replace(/(\d+[å¤©æœˆå¹´å‘¨])/g, '<span class="time-marker" style="background: linear-gradient(135deg, #3498db, #2980b9); color: white; padding: 2px 8px; border-radius: 12px; font-size: 0.85rem; font-weight: 500; margin: 0 2px;">$1</span>')
      // ç—‡çŠ¶å…³é”®è¯
      .replace(/(ç–¼ç—›|ä¸é€‚|æ¨¡ç³Š|ä¸‹é™|å‡ºè¡€|çº¢è‚¿|ç˜™ç—’|å¹²æ¶©|æµæ³ª|ç•å…‰|å¤è§†|é»‘å½±|é—ªå…‰)/g, '<span class="symptom-highlight" style="background: #ffe6e6; color: #c0392b; padding: 1px 4px; border-radius: 4px; font-weight: 600; border-left: 3px solid #e74c3c;">$1</span>')
      // å¦å®šè¯æ±‡
      .replace(/(æ— |å¦è®¤|æœªè§|æ­£å¸¸|é˜´æ€§)/g, '<span class="negative-finding" style="background: #e8f5e8; color: #27ae60; padding: 1px 4px; border-radius: 4px; font-weight: 500;">$1</span>')
      // ç¨‹åº¦è¯æ±‡
      .replace(/(è½»åº¦|ä¸­åº¦|é‡åº¦|ä¸¥é‡|æ˜æ˜¾|æ˜¾è‘—)/g, '<span class="severity-marker" style="background: #fff3cd; color: #856404; padding: 1px 4px; border-radius: 4px; font-weight: 500;">$1</span>');
    
    // å°†æ–‡æœ¬åˆ†æ®µå¹¶æ·»åŠ é€‚å½“çš„é—´è·
    return '<div class="formatted-history">' + formatted.replace(/ã€‚/g, 'ã€‚<br style="margin-bottom: 8px;">') + '</div>';
  }
  

  


  
  // ==================== æ£€æŸ¥é˜¶æ®µï¼šå¾ªè¯åŒ»å­¦æŒ‡å¯¼ ====================
  
  function loadExaminationStage() {
    clinicalSession.currentStage = 'examination';
    updateClinicalProgress();
    updateStageProgress();
    
    $('#btn-prev').prop('disabled', false);
    $('#btn-next').text('æäº¤æ£€æŸ¥é€‰æ‹© â†’').removeClass('btn-secondary').addClass('btn-warning');
    updateStageCard('æ£€æŸ¥é€‰æ‹©é˜¶æ®µ', 'examination');
    
    $.getJSON('/api/clinical/case/' + clinicalSession.caseId + '/examinations/', function(resp) {
      if (resp.success) {
        renderExaminationOptions(resp.data.examination_options || []);
        addExaminationGuidance();
        showClinicalThinkingPrompt('examination');
      } else {
        showErrorMessage('åŠ è½½æ£€æŸ¥é€‰é¡¹å¤±è´¥: ' + resp.message);
      }
    }).fail(function() {
      showErrorMessage('ç½‘ç»œé”™è¯¯ï¼Œè¯·æ£€æŸ¥è¿æ¥åé‡è¯•');
    });
  }
  
  function renderExaminationOptions(options) {
    var html = '<div class="examination-selection">';
    
    // æ£€æŸ¥é€‰æ‹©è¯´æ˜
    html += '<div class="alert alert-info" style="background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%); border: none; border-radius: 12px; padding: 20px;">';
    html += '<h4 class="mb-3" style="color: #1565c0; font-weight: 700; display: flex; align-items: center;">';
    html += '<i class="fas fa-lightbulb me-2" style="font-size: 1.2rem; color: #ffa726;"></i>æ£€æŸ¥é€‰æ‹©æŒ‡å¯¼';
    html += '</h4>';
    html += '<p class="mb-0" style="font-size: 1rem; line-height: 1.6; color: #424242;">åŸºäºæ‚£è€…ç—…å²ï¼Œé€‰æ‹©æœ€æœ‰ä»·å€¼çš„æ£€æŸ¥é¡¹ç›®ã€‚è€ƒè™‘è¯Šæ–­ä»·å€¼ã€æˆæœ¬æ•ˆç›Šå’Œæ‚£è€…å®‰å…¨ã€‚</p>';
    html += '</div>';
    
    // æŒ‰ç±»å‹åˆ†ç»„æ˜¾ç¤ºæ£€æŸ¥é€‰é¡¹
    var groupedOptions = groupExaminationsByType(options);
    
    Object.keys(groupedOptions).forEach(function(type) {
  var typeOptions = groupedOptions[type];
      var typeDisplayName = getExaminationTypeDisplay(type);
      var typeIcon = getExaminationTypeIcon(type);
      
      html += '<div class="examination-group mb-4">';
      html += '<h4 class="text-primary mb-3" style="font-weight: 700; display: flex; align-items: center;">';
      html += '<i class="' + typeIcon + ' me-2" style="font-size: 1.3rem;"></i>' + typeDisplayName;
      html += '<span class="text-muted ms-2" style="font-size: 1rem; font-weight: 500;">(' + typeOptions.length + 'é¡¹)</span>';
      html += '</h4>';
      
      html += '<div class="row">';
      typeOptions.forEach(function(option) {
        // encode images array as JSON string for data attribute
        var imagesAttr = (option.images && option.images.length) ? JSON.stringify(option.images) : '[]';
        var isRequiredAttr = option.is_required ? 1 : 0;
        var allowMultipleAttr = option.is_multiple_choice ? 1 : 0;
        html += '<div class="col-md-6 mb-3">';
        html += '<div class="card examination-option h-100" data-exam-id="' + option.id + '" data-images=\'' + imagesAttr + '\' data-is-required="' + isRequiredAttr + '" data-allow-multiple="' + allowMultipleAttr + '">';
        html += '<div class="card-body">';
        
        html += '<div class="form-check d-flex align-items-start">';
  // è‹¥åç«¯æ ‡æ³¨äº†å¤šé€‰å…è®¸æˆ–å¿…é€‰ï¼ˆåç«¯ may not provide theseâ€”use defaults if absentï¼‰
  var inputType = option.is_multiple_choice ? 'checkbox' : 'checkbox'; // frontend will validate single/multi via option.allow_multiple if provided
  html += '<input class="form-check-input examination-checkbox me-3 mt-1" type="' + inputType + '" ';
  html += 'value="' + option.id + '" id="exam_' + option.id + '" data-is-recommended="' + (option.is_recommended ? '1' : '0') + '" data-is-fundus="' + ((option.type && option.type.toLowerCase().indexOf('çœ¼åº•') !== -1) ? '1' : '0') + '" data-is-required="' + isRequiredAttr + '" data-allow-multiple="' + allowMultipleAttr + '" style="width: 18px; height: 18px;">';
        html += '<label class="form-check-label flex-grow-1" for="exam_' + option.id + '">';
        html += '<div class="d-flex justify-content-between align-items-start mb-2">';
        html += '<strong style="font-size: 1.1rem; color: #2c3e50;">' + option.name + '</strong>';
        
        // æ˜¾ç¤ºæ£€æŸ¥ç‰¹æ€§æ ‡ç­¾
        html += '<div class="examination-badges">';
        // ä½¿ç”¨åç«¯è¿”å›çš„å­—æ®µå±•ç¤ºæ ‡ç­¾
        if (option.is_recommended) {
          html += '<span class="badge badge-success">æ¨è</span>';
        }
        if (option.diagnostic_value && option.diagnostic_value.toLowerCase().indexOf('é«˜') !== -1) {
          html += '<span class="badge badge-success">é«˜ä»·å€¼</span>';
        }
        html += '</div>';
        
        html += '</div>';
        html += '<div class="text-muted small mt-2">' + (option.description || '') + '</div>';
        
        // æ˜¾ç¤ºé£é™©å’Œæˆæœ¬ä¿¡æ¯
  // æ£€æŸ¥é¢å¤–ä¿¡æ¯ï¼ˆåç«¯å¯èƒ½æ²¡æœ‰é£é™©/è´¹ç”¨å­—æ®µï¼Œä½œå…¼å®¹å¤„ç†ï¼‰
  html += '<div class="examination-info mt-2">';
  html += '<div class="row small text-muted">';
  html += '<div class="col-6">é£é™©: ' + (option.risk_level || 'æœªçŸ¥') + '</div>';
  html += '<div class="col-6">è´¹ç”¨: Â¥' + (option.cost || 0) + '</div>';
  html += '</div>';
  html += '</div>';
        
        html += '</label>';
        html += '</div>';
        html += '</div>';
        html += '</div>';
        html += '</div>';
      });
      html += '</div>';
      html += '</div>';
    });
    
    html += '</div>';
    
    // æ·»åŠ é€‰æ‹©ç»Ÿè®¡
    html += '<div class="examination-summary mt-4">';
    html += '<div class="card bg-light">';
    html += '<div class="card-body">';
    html += '<h6><i class="fas fa-calculator"></i> é€‰æ‹©ç»Ÿè®¡</h6>';
    html += '<div class="row text-center">';
    html += '<div class="col-3">';
    html += '<div class="h5 mb-0" id="selected-count">0</div>';
    html += '<small class="text-muted">å·²é€‰æ£€æŸ¥</small>';
    html += '</div>';
    html += '<div class="col-3">';
    html += '<div class="h5 mb-0" id="total-cost">Â¥0</div>';
    html += '<small class="text-muted">æ€»è´¹ç”¨</small>';
    html += '</div>';
    html += '<div class="col-3">';
    html += '<div class="h5 mb-0" id="high-value-count">0</div>';
    html += '<small class="text-muted">é«˜ä»·å€¼æ£€æŸ¥</small>';
    html += '</div>';
    html += '<div class="col-3">';
    html += '<div class="h5 mb-0" id="risk-assessment">ä½</div>';
    html += '<small class="text-muted">ç»¼åˆé£é™©</small>';
    html += '</div>';
    html += '</div>';
    html += '</div>';
    html += '</div>';
    html += '</div>';
    
    $('#stage-content').html(html);
    
    // ç»‘å®šæ£€æŸ¥é€‰æ‹©äº‹ä»¶
    bindExaminationEvents();
  }
  
  function groupExaminationsByType(options) {
    var grouped = {};
    options.forEach(function(option) {
      var type = option.examination_type || 'basic';
      if (!grouped[type]) {
        grouped[type] = [];
      }
      grouped[type].push(option);
    });
    return grouped;
  }
  
  function getExaminationTypeDisplay(type) {
    var displays = {
      'basic': 'åŸºç¡€æ£€æŸ¥',
      'imaging': 'å½±åƒå­¦æ£€æŸ¥', 
      'laboratory': 'å®éªŒå®¤æ£€æŸ¥',
      'special': 'ç‰¹æ®Šæ£€æŸ¥'
    };
    return displays[type] || type;
  }
  
  function getExaminationTypeIcon(type) {
    var icons = {
      'basic': 'fas fa-stethoscope',
      'imaging': 'fas fa-x-ray',
      'laboratory': 'fas fa-flask',
      'special': 'fas fa-microscope'
    };
    return icons[type] || 'fas fa-medical-kit';
  }
  
  function getRiskLevelDisplay(level) {
    var displays = {
      'low': '<span class="text-success">ä½</span>',
      'medium': '<span class="text-warning">ä¸­</span>',
      'high': '<span class="text-danger">é«˜</span>'
    };
    return displays[level] || level;
  }
  
  function bindExaminationEvents() {
    $('.examination-checkbox').on('change', function() {
      var $card = $(this).closest('.examination-option');
      var examId = parseInt($(this).val());
      var isChecked = $(this).is(':checked');
      var isFundus = $(this).data('is-fundus') == 1;

      // å•é€‰/å¤šé€‰æ§åˆ¶ï¼ˆå¦‚æœåç«¯ä¼ å› is_multiple_choice å¯ä½¿ç”¨ï¼›å¦åˆ™ä½¿ç”¨é¡µé¢çº¦æŸï¼šåŒä¸€ç±»å‹é™åˆ¶å•é€‰ç¤ºä¾‹ï¼‰
      var allowMultiple = $(this).data('allow-multiple') === 1;

      if (!allowMultiple && isChecked) {
        // å–æ¶ˆåŒä¸€ç±»å‹ä¸‹å…¶ä»–å·²é€‰é¡¹ï¼ˆä¿æŒå•é€‰è¡Œä¸ºï¼‰
        var name = $(this).attr('name');
        $('.examination-checkbox[name="' + name + '"]').not(this).prop('checked', false).trigger('change');
      }

      if (isChecked) {
        $card.addClass('selected');
        if (clinicalSession.selectedExaminations.indexOf(examId) === -1) clinicalSession.selectedExaminations.push(examId);
        addToLearningTimeline('é€‰æ‹©æ£€æŸ¥', $card.find('strong').text());

        // è‹¥ä¸ºçœ¼åº•æ£€æŸ¥ï¼Œæ˜¾ç¤ºå®æ“æç¤º
        var examName = $card.find('strong').text().toLowerCase();
        if (isFundus || examName.includes('çœ¼åº•') || examName.includes('fundus') || examName.includes('ç…§ç‰‡') || examName.includes('é€ å½±')) {
          showFundusReminder();
        }
      } else {
        $card.removeClass('selected');
        var index = clinicalSession.selectedExaminations.indexOf(examId);
        if (index > -1) {
          clinicalSession.selectedExaminations.splice(index, 1);
        }
      }

      updateExaminationSummary();
      provideLiveExaminationFeedback();

      // å¦‚æœè¯¥é€‰é¡¹åŒ…å«å›¾ç‰‡ï¼Œç‚¹å‡»æŸ¥çœ‹å›¾ç‰‡åˆ™è®°å½•
      var images = $card.data('images');
      if (images && images.length > 0) {
        // render images preview when selected
        renderExaminationImagesForCard($card, images);
      }
    });
    
    $('.examination-option').on('click', function(e) {
      if (e.target.type !== 'checkbox') {
        var checkbox = $(this).find('.examination-checkbox');
        checkbox.prop('checked', !checkbox.prop('checked')).trigger('change');
      }
    });
  }

  function showFundusReminder() {
    // é˜²æ­¢é‡å¤æ˜¾ç¤º
    if ($('#fundus-overlay').length > 0) return;
    
    // åˆ›å»ºå…¨å±è¦†ç›–å±‚å’Œå­—å¹•
    var overlayHtml = '';
    overlayHtml += '<div id="fundus-overlay" style="';
    overlayHtml += 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 9999;';
    overlayHtml += 'background: rgba(0, 0, 0, 0.6); display: flex; align-items: center; justify-content: center;';
    overlayHtml += 'opacity: 0; transition: opacity 0.8s ease-in-out;';
    overlayHtml += '">';
    overlayHtml += '<div id="fundus-subtitle" style="';
    overlayHtml += 'background: rgba(0, 0, 0, 0.8); color: white; padding: 20px 40px;';
    overlayHtml += 'border-radius: 12px; font-size: 1.8rem; font-weight: 600;';
    overlayHtml += 'text-align: center; max-width: 80%; box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);';
    overlayHtml += 'transform: translateY(20px); transition: all 0.8s ease-in-out;';
    overlayHtml += '">';
    overlayHtml += 'è¯·ç§»æ­¥æ—è¾¹ï¼Œå¯¹çœ¼åº•æ£€æŸ¥è¿›è¡Œå®æ“';
    overlayHtml += '</div>';
    overlayHtml += '</div>';
    
    // æ·»åŠ åˆ°é¡µé¢
    $('body').append(overlayHtml);
    
    // åŠ¨ç”»åºåˆ—ï¼šæ·¡å…¥ â†’ åœç•™ â†’ æ·¡å‡º â†’ è‡ªåŠ¨è¿›å…¥ä¸‹ä¸€ç¯èŠ‚
    setTimeout(function() {
      // æ·¡å…¥åŠ¨ç”»
      $('#fundus-overlay').css('opacity', '1');
      $('#fundus-subtitle').css('transform', 'translateY(0)');
    }, 100);
    
    setTimeout(function() {
      // æ·¡å‡ºåŠ¨ç”»
      $('#fundus-overlay').css('opacity', '0');
      $('#fundus-subtitle').css('transform', 'translateY(-20px)');
    }, 4600); // 0.8sæ·¡å…¥ + 3såœç•™ + 0.8så‡†å¤‡æ·¡å‡º
    
    setTimeout(function() {
      // ç§»é™¤è¦†ç›–å±‚
      $('#fundus-overlay').remove();
      
      // è‡ªåŠ¨è¿›å…¥ä¸‹ä¸€ç¯èŠ‚ï¼ˆæäº¤æ£€æŸ¥é€‰æ‹©ï¼‰
      autoSubmitExaminations();
    }, 5400); // æ€»è®¡ 5.4s åå®Œæˆ
  }
  
  function autoSubmitExaminations() {
    // æ£€æŸ¥æ˜¯å¦æœ‰é€‰ä¸­çš„æ£€æŸ¥é¡¹ç›®
    if (clinicalSession.selectedExaminations.length > 0) {
      // æ˜¾ç¤ºè‡ªåŠ¨æäº¤æç¤º
      showFeedbackMessage('çœ¼åº•æ£€æŸ¥å®Œæˆï¼Œæ­£åœ¨è¿›å…¥ä¸‹ä¸€ç¯èŠ‚...', 'info');
      
      // å»¶è¿Ÿä¸€ç§’åè‡ªåŠ¨æäº¤
      setTimeout(function() {
        submitExaminations();
      }, 1000);
    }
  }

  function renderExaminationImagesForCard($card, images) {
    // images ä¸ºæ•°ç»„è·¯å¾„
    if (!images || images.length === 0) return;
    var html = '<div class="examination-images mt-3">';
    images.forEach(function(img) {
      html += '<img src="' + img + '" class="img-fluid mb-2 exam-image" style="max-height:220px; cursor:zoom-in;" data-src="' + img + '">';
    });
    html += '</div>';

    // é˜²æ­¢é‡å¤æ’å…¥
    $card.find('.examination-images').remove();
    $card.find('.card-body').append(html);

    // ç‚¹å‡»å›¾ç‰‡è®°å½•ä¸ºå·²æŸ¥çœ‹
    $card.find('.exam-image').on('click', function() {
      var src = $(this).data('src');
      if (clinicalSession.examination_images_viewed.indexOf(src) === -1) {
        clinicalSession.examination_images_viewed.push(src);
      }
      showImageModal(src);
    });
  }

  function showImageModal(src) {
    var modalHtml = '';
    modalHtml += '<div class="modal fade" id="examImageModal" tabindex="-1" role="dialog">';
    modalHtml += '<div class="modal-dialog modal-lg" role="document">';
    modalHtml += '<div class="modal-content">';
    modalHtml += '<div class="modal-body text-center">';
    modalHtml += '<img src="' + src + '" class="img-fluid">';
    modalHtml += '</div>';
    modalHtml += '<div class="modal-footer">';
    modalHtml += '<button type="button" class="btn btn-secondary" data-dismiss="modal">å…³é—­</button>'; 
    modalHtml += '</div></div></div></div>';

    $('#examImageModal').remove();
    $('body').append(modalHtml);
    $('#examImageModal').modal('show');
  }
  
  function updateExaminationSummary() {
    var selectedCount = clinicalSession.selectedExaminations.length;
    var totalCost = 0;
    var highValueCount = 0;
    var riskLevels = [];
    
    $('.examination-checkbox:checked').each(function() {
      var $card = $(this).closest('.examination-option');
      var cost = parseInt($card.find('.examination-info').text().match(/Â¥(\d+)/)?.[1] || 0);
      totalCost += cost;
      
      if ($card.find('.badge-success').length > 0) {
        highValueCount++;
      }
      
      var riskText = $card.find('.examination-info').text();
      if (riskText.includes('é«˜')) riskLevels.push('high');
      else if (riskText.includes('ä¸­')) riskLevels.push('medium');
      else riskLevels.push('low');
    });
    
    // ç»¼åˆé£é™©è¯„ä¼°
    var overallRisk = 'low';
    if (riskLevels.includes('high')) overallRisk = 'high';
    else if (riskLevels.includes('medium')) overallRisk = 'medium';
    
    $('#selected-count').text(selectedCount);
    $('#total-cost').text('Â¥' + totalCost);
    $('#high-value-count').text(highValueCount);
    $('#risk-assessment').html(getRiskLevelDisplay(overallRisk));
  }
  
  function provideLiveExaminationFeedback() {
    var selectedCount = clinicalSession.selectedExaminations.length;
    var feedback = '';
    
    if (selectedCount === 0) {
      feedback = '<div class="alert alert-info">è¯·å¼€å§‹é€‰æ‹©æ£€æŸ¥é¡¹ç›®</div>';
    } else if (selectedCount < 3) {
      feedback = '<div class="alert alert-warning">è€ƒè™‘æ˜¯å¦éœ€è¦æ›´å¤šæ£€æŸ¥æ¥æ˜ç¡®è¯Šæ–­</div>';
    } else if (selectedCount > 8) {
      feedback = '<div class="alert alert-danger">æ£€æŸ¥è¿‡å¤šå¯èƒ½å¢åŠ æˆæœ¬å’Œæ‚£è€…è´Ÿæ‹…</div>';
    } else {
      feedback = '<div class="alert alert-success">æ£€æŸ¥é€‰æ‹©åˆç†ï¼Œè¯·ç»§ç»­</div>';
    }
    
    $('#feedback-panel').html(feedback);
  }

  function submitExaminations() {
    // éªŒè¯å¿…é€‰æ£€æŸ¥æ˜¯å¦è¢«é€‰ä¸­
    var requiredMissing = [];
    $('.examination-checkbox').each(function() {
      var isRequired = $(this).data('is-required') === 1 || $(this).data('is-required') === true;
      if (isRequired) {
        var id = parseInt($(this).val());
        if (clinicalSession.selectedExaminations.indexOf(id) === -1) {
          requiredMissing.push(id);
        }
      }
    });

    if (requiredMissing.length > 0) {
      showFeedbackMessage('å­˜åœ¨å¿…é€‰æ£€æŸ¥æœªé€‰æ‹©ï¼Œè¯·å…ˆå®Œæˆå¿…é€‰æ£€æŸ¥', 'danger');
      return;
    }

    // æ˜¾ç¤ºæäº¤ä¸­çŠ¶æ€
    $('#btn-next').prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i> æäº¤ä¸­...');
    showFeedbackMessage('æ­£åœ¨æäº¤æ£€æŸ¥é€‰æ‹©...', 'info');

    // å‡†å¤‡æäº¤æ•°æ®
    var submitData = {
      case_id: clinicalSession.caseId,
      selected_examinations: clinicalSession.selectedExaminations,
      images_viewed: clinicalSession.examination_images_viewed
    };

    $.ajax({
      url: '/api/clinical/submit-examinations/',
      method: 'POST',
      contentType: 'application/json',
      headers: {
        'X-CSRFToken': $('[name=csrfmiddlewaretoken]').val() || getCsrfToken()
      },
      data: JSON.stringify(submitData),
      success: function(resp) {
        $('#btn-next').prop('disabled', false).html('ä¸‹ä¸€æ­¥ <i class="fas fa-arrow-right"></i>');

        if (resp.success) {
          // è®°å½•æ£€æŸ¥é˜¶æ®µå®Œæˆ
          addToLearningTimeline('å®Œæˆæ£€æŸ¥é€‰æ‹©', 'é€‰æ‹©äº† ' + clinicalSession.selectedExaminations.length + ' é¡¹æ£€æŸ¥');

          // æ›´æ–°åˆ†æ•°
          if (resp.data.examination_score !== undefined) {
            clinicalSession.scores.examination = resp.data.examination_score;
            $('#current-score').text(resp.data.examination_score.toFixed(1));
          }

          // è¿›å…¥è¯Šæ–­é˜¶æ®µ
          renderDiagnosisStage(resp.data);
          showFeedbackMessage('æ£€æŸ¥ç»“æœå·²è·å¾—ï¼Œè¯·å¼€å§‹è¯Šæ–­åˆ†æ', 'success');
          // è§†è§‰åé¦ˆ
          flashCard($('#feedback-panel'), 'success');
          launchConfetti(25);
        } else {
          showFeedbackMessage('æäº¤å¤±è´¥: ' + resp.message, 'danger');
        }
      },
      error: function(xhr, status, error) {
        $('#btn-next').prop('disabled', false).html('ä¸‹ä¸€æ­¥ <i class="fas fa-arrow-right"></i>');
        console.error('Submit examination error:', error, xhr.responseText);

        if (xhr.status === 404) {
          showFeedbackMessage('APIæ¥å£æœªæ‰¾åˆ°ï¼Œè¯·æ£€æŸ¥åç«¯é…ç½®', 'danger');
        } else if (xhr.status === 403) {
          showFeedbackMessage('æƒé™ä¸è¶³ï¼Œè¯·é‡æ–°ç™»å½•', 'danger');
        } else if (xhr.status === 500) {
          showFeedbackMessage('æœåŠ¡å™¨å†…éƒ¨é”™è¯¯ï¼Œè¯·è”ç³»ç®¡ç†å‘˜', 'danger');
        } else {
          showFeedbackMessage('ç½‘ç»œé”™è¯¯ï¼Œè¯·æ£€æŸ¥è¿æ¥: ' + error, 'danger');
        }
      }
    });
  }

  
  // ==================== è¯Šæ–­é˜¶æ®µï¼šé‰´åˆ«è¯Šæ–­æ¨ç† ====================
  
  function renderDiagnosisStage(data) {
    clinicalSession.currentStage = 'diagnosis';
    updateClinicalProgress();
    updateStageProgress();
    
    $('#btn-next').text('æäº¤è¯Šæ–­é€‰æ‹© â†’').removeClass('btn-warning').addClass('btn-info');
    updateStageCard('è¯Šæ–­æ¨ç†é˜¶æ®µ', 'diagnosis');
    
    var html = '<div class="diagnosis-stage">';
    
    // æ£€æŸ¥ç»“æœå±•ç¤º - å°å¡ç‰‡å½¢å¼
    html += '<div class="examination-results mb-4">';
    html += '<h5 class="text-primary mb-3"><i class="fas fa-microscope me-2"></i> æ£€æŸ¥ç»“æœ</h5>';
    
    if (data.examination_results && data.examination_results.length > 0) {
      html += '<div class="row g-3">';
      data.examination_results.forEach(function(result) {
        html += '<div class="col-12">';
        html += '<div class="exam-result-card">';
        
        // æ£€æŸ¥é¡¹ç›®å¤´éƒ¨
        html += '<div class="exam-header">';
        html += '<div class="d-flex align-items-center justify-content-between">';
        html += '<div class="exam-title">';
        html += '<i class="fas fa-eye text-primary me-2"></i>';
        html += '<span class="fw-bold text-dark">' + result.name + '</span>';
        html += '</div>';
        if (result.is_recommended) {
          html += '<span class="badge bg-success">æ¨èæ£€æŸ¥</span>';
        }
        html += '</div>';
        html += '</div>';
        
        // æ£€æŸ¥ç»“æœå†…å®¹
        html += '<div class="exam-content">';
        html += '<div class="result-label">æ£€æŸ¥ç»“æœ</div>';
        html += '<div class="result-text">' + (result.result || 'æœªè®°å½•') + '</div>';
        html += '</div>';
        
        html += '</div>';
        html += '</div>';
      });
      html += '</div>';
    } else {
      html += '<div class="alert alert-warning border-0 bg-warning bg-opacity-10">';
      html += '<i class="fas fa-exclamation-triangle text-warning me-2"></i>';
      html += 'æš‚æ— æ£€æŸ¥ç»“æœæ•°æ®';
      html += '</div>';
    }
    html += '</div>';
    
    // è¯Šæ–­é€‰é¡¹
    html += '<div class="diagnosis-options">';
    html += '<h4 class="text-info mb-4" style="font-weight: 700; display: flex; align-items: center;">';
    html += '<i class="fas fa-user-md me-2" style="font-size: 1.3rem; color: #17a2b8;"></i>é‰´åˆ«è¯Šæ–­';
    html += '</h4>';
    html += '<div class="alert alert-info" style="background: linear-gradient(135deg, #d1ecf1 0%, #bee5eb 100%); border: none; border-radius: 12px; padding: 20px;">';
    html += '<h5 class="mb-3" style="color: #0c5460; font-weight: 700; display: flex; align-items: center;">';
    html += '<i class="fas fa-brain me-2" style="font-size: 1.2rem; color: #6f42c1;"></i>è¯Šæ–­æ€ç»´æŒ‡å¯¼';
    html += '</h5>';
    html += '<p class="mb-0" style="font-size: 1rem; line-height: 1.6; color: #0c5460;">ç»¼åˆæ‚£è€…ç—…å²å’Œæ£€æŸ¥ç»“æœï¼Œè¿›è¡Œé‰´åˆ«è¯Šæ–­ã€‚ä»”ç»†åˆ†ææ¯ä¸ªè¯Šæ–­çš„ç¬¦åˆåº¦ï¼Œé€‰æ‹©æœ€å¯èƒ½çš„è¯Šæ–­é€‰é¡¹ã€‚</p>';
    html += '</div>';
    
    // å¦‚æœåç«¯æ²¡æœ‰è¯Šæ–­é€‰é¡¹ï¼Œåˆ›å»ºåŸºäºæ¡ˆä¾‹çš„ä¸´åºŠè¯Šæ–­é€‰é¡¹
    var diagnosisOptions = data.diagnosis_options;
    if (!diagnosisOptions || diagnosisOptions.length === 0) {
      // åŸºäºçœ¼åº•å‡ºè¡€ç—…ä¾‹çš„å¸¸è§è¯Šæ–­é€‰é¡¹
      diagnosisOptions = [
        {
          id: 1,
          name: 'ç³–å°¿ç—…è§†ç½‘è†œç—…å˜',
          code: 'H36.0',
          description: 'ç³–å°¿ç—…å¼•èµ·çš„è§†ç½‘è†œå¾®è¡€ç®¡ç—…å˜ï¼Œå‡ºç°å‡ºè¡€ã€æ¸—å‡ºç­‰',
          probability_score: 0.75,
          is_correct: false
        },
        {
          id: 2, 
          name: 'é«˜è¡€å‹æ€§è§†ç½‘è†œç—…å˜',
          code: 'H35.0',
          description: 'é«˜è¡€å‹å¼•èµ·çš„è§†ç½‘è†œè¡€ç®¡æ”¹å˜ï¼Œå¯è§å‡ºè¡€ã€æ¸—å‡º',
          probability_score: 0.65,
          is_correct: false
        },
        {
          id: 3,
          name: 'è§†ç½‘è†œé™è„‰é˜»å¡',
          code: 'H34.8',
          description: 'è§†ç½‘è†œé™è„‰è¡€æµå—é˜»ï¼Œå¯¼è‡´è§†ç½‘è†œå‡ºè¡€å’Œæ°´è‚¿',
          probability_score: 0.85,
          is_correct: true
        },
        {
          id: 4,
          name: 'Valsalvaè§†ç½‘è†œç—…å˜',
          code: 'H35.6',
          description: 'ç”¨åŠ›è¿‡åº¦å¼•èµ·çš„è§†ç½‘è†œè¡¨å±‚å‡ºè¡€ï¼Œå¤šè§äºå¹´è½»äºº',
          probability_score: 0.90,
          is_correct: true
        },
        {
          id: 5,
          name: 'å¤–ä¼¤æ€§è§†ç½‘è†œç—…å˜',
          code: 'S05.8',
          description: 'çœ¼å¤–ä¼¤å¯¼è‡´çš„è§†ç½‘è†œå‡ºè¡€ï¼Œéœ€è¯¢é—®å¤–ä¼¤å²',
          probability_score: 0.45,
          is_correct: false
        }
      ];
    }
    
    if (diagnosisOptions && diagnosisOptions.length > 0) {
      html += '<form id="diagnosis-form">';
      diagnosisOptions.forEach(function(option) {
        html += '<div class="card diagnosis-option mb-3" data-diagnosis-id="' + option.id + '" style="border: 2px solid transparent; transition: all 0.3s ease;">';
        html += '<div class="card-body">';
        html += '<div class="form-check">';
        html += '<input class="form-check-input diagnosis-radio" type="radio" name="diagnosis" ';
        html += 'value="' + option.id + '" id="diag_' + option.id + '">';
        html += '<label class="form-check-label w-100" for="diag_' + option.id + '">';
        html += '<div class="d-flex justify-content-between align-items-start">';
        html += '<div class="flex-grow-1">';
        html += '<h6 class="mb-1" style="color: #2c3e50; font-weight: 600;">' + option.name + '</h6>';
        if (option.code) {
          html += '<small class="text-muted d-block mb-2"><i class="fas fa-code me-1"></i>ICDç¼–ç : ' + option.code + '</small>';
        }
        if (option.description) {
          html += '<p class="text-muted small mb-0" style="line-height: 1.4;">' + option.description + '</p>';
        }
        html += '</div>';
        if (option.probability_score !== undefined) {
          html += '<div class="diagnosis-probability ms-3">';
          var percentage = (option.probability_score * 100).toFixed(0);
          var badgeClass = percentage >= 80 ? 'badge-success' : percentage >= 60 ? 'badge-warning' : 'badge-secondary';
          html += '<span class="badge ' + badgeClass + '">ç¬¦åˆåº¦: ' + percentage + '%</span>';
          html += '</div>';
        }
        html += '</div>';
        html += '</label>';
        html += '</div>';
        html += '</div>';
        html += '</div>';
      });
      html += '</form>';
    } else {
      html += '<div class="alert alert-warning">æš‚æ— è¯Šæ–­é€‰é¡¹æ•°æ®</div>';
    }
    
    html += '</div>';
    html += '</div>';
    
    $('#stage-content').html(html);
    
    // ç»‘å®šè¯Šæ–­é€‰æ‹©äº‹ä»¶
    bindDiagnosisEvents();
    showClinicalThinkingPrompt('diagnosis');
  }
  
  function bindDiagnosisEvents() {
    $('.diagnosis-radio').on('change', function() {
      var diagnosisId = parseInt($(this).val());
      var $card = $(this).closest('.diagnosis-option');
      
      // ç§»é™¤å…¶ä»–é€‰ä¸­çŠ¶æ€
      $('.diagnosis-option').removeClass('selected');
      
      // è®¾ç½®å½“å‰é€‰ä¸­
      $card.addClass('selected');
      clinicalSession.selectedDiagnosis = diagnosisId;
      
      // è®°å½•é€‰æ‹©
      var diagnosisName = $(this).siblings('label').find('h6').text();
      addToLearningTimeline('é€‰æ‹©è¯Šæ–­', diagnosisName);
      
      // æä¾›å³æ—¶åé¦ˆ
      showFeedbackMessage('å·²é€‰æ‹©è¯Šæ–­ï¼š' + diagnosisName, 'info');
    });
    
    $('.diagnosis-option').on('click', function(e) {
      if (e.target.type !== 'radio') {
        var radio = $(this).find('.diagnosis-radio');
        radio.prop('checked', true).trigger('change');
      }
    });
  }
  
  // ==================== å·¥å…·å‡½æ•° ====================
  
  function getCsrfToken() {
    // å°è¯•ä»cookieè·å–CSRF token
    var cookieValue = null;
    if (document.cookie && document.cookie !== '') {
      var cookies = document.cookie.split(';');
      for (var i = 0; i < cookies.length; i++) {
        var cookie = cookies[i].trim();
        if (cookie.substring(0, 10) === 'csrftoken=') {
          cookieValue = decodeURIComponent(cookie.substring(10));
          break;
        }
      }
    }
    return cookieValue;
  }

  function submitDiagnosis() {
    // æ˜¾ç¤ºæäº¤ä¸­çŠ¶æ€
    $('#btn-next').prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i> æäº¤ä¸­...');
    showFeedbackMessage('æ­£åœ¨æäº¤è¯Šæ–­é€‰æ‹©...', 'info');
    
    // å‡†å¤‡æäº¤æ•°æ®
    var submitData = {
      case_id: clinicalSession.caseId,
      selected_diagnosis_id: clinicalSession.selectedDiagnosis,
      reasoning: $('#clinical-notes').val() || ''
    };
    
    $.ajax({
      url: '/api/clinical/submit-diagnosis/',
      method: 'POST',
      contentType: 'application/json',
      headers: {
        'X-CSRFToken': $('[name=csrfmiddlewaretoken]').val() || getCsrfToken()
      },
      data: JSON.stringify(submitData),
      success: function(resp) {
        $('#btn-next').prop('disabled', false).html('ä¸‹ä¸€æ­¥ <i class="fas fa-arrow-right"></i>');
        
        if (resp.success) {
          // è®°å½•è¯Šæ–­é˜¶æ®µå®Œæˆ
          var selectedDiagName = $('.diagnosis-option.selected').find('h6').text();
          addToLearningTimeline('æäº¤è¯Šæ–­', selectedDiagName);
          
          // æ›´æ–°åˆ†æ•°
          if (resp.data.diagnosis_score !== undefined) {
            clinicalSession.scores.diagnosis = resp.data.diagnosis_score;
            $('#current-score').text(resp.data.diagnosis_score.toFixed(1));
          }
          
          // æ˜¾ç¤ºè¯Šæ–­åé¦ˆ
          if (resp.data.diagnosis_feedback) {
            showFeedbackMessage(resp.data.diagnosis_feedback, 'success');
          }
          
          // è¿›å…¥æ²»ç–—é˜¶æ®µ
          renderTreatmentStage(resp.data);
          // è§†è§‰åé¦ˆ
          flashCard($('#feedback-panel'), 'success');
          launchConfetti(20);
        } else {
          showFeedbackMessage('æäº¤å¤±è´¥: ' + resp.message, 'danger');
        }
      },
      error: function(xhr, status, error) {
        $('#btn-next').prop('disabled', false).html('ä¸‹ä¸€æ­¥ <i class="fas fa-arrow-right"></i>');
        console.error('Submit diagnosis error:', error, xhr.responseText);
        
        if (xhr.status === 404) {
          showFeedbackMessage('APIæ¥å£æœªæ‰¾åˆ°ï¼Œè¯·æ£€æŸ¥åç«¯é…ç½®', 'danger');
        } else if (xhr.status === 403) {
          showFeedbackMessage('æƒé™ä¸è¶³ï¼Œè¯·é‡æ–°ç™»å½•', 'danger');
        } else if (xhr.status === 500) {
          showFeedbackMessage('æœåŠ¡å™¨å†…éƒ¨é”™è¯¯ï¼Œè¯·è”ç³»ç®¡ç†å‘˜', 'danger');
        } else {
          showFeedbackMessage('ç½‘ç»œé”™è¯¯ï¼Œè¯·æ£€æŸ¥è¿æ¥: ' + error, 'danger');
        }
      }
    });
  }

  
  // ==================== æ²»ç–—é˜¶æ®µï¼šæ²»ç–—å†³ç­– ====================
  
  function renderTreatmentStage(data) {
    clinicalSession.currentStage = 'treatment';
    
    // æ¸…ç©ºæ²»ç–—é€‰æ‹©æ•°æ®ï¼Œé¿å…å†å²æ•°æ®æ±¡æŸ“
    clinicalSession.selectedTreatments = [];
    
    updateClinicalProgress();
    updateStageProgress();
    
    $('#btn-next').text('æäº¤æ²»ç–—æ–¹æ¡ˆ â†’').removeClass('btn-info').addClass('btn-success');
    updateStageCard('æ²»ç–—å†³ç­–é˜¶æ®µ', 'treatment');
    
    var html = '<div class="treatment-stage">';
    
    // è¯Šæ–­ç¡®è®¤å±•ç¤º
    if (data.selected_diagnosis) {
      html += '<div class="diagnosis-confirmation mb-4">';
      html += '<h5 class="text-success"><i class="fas fa-check-circle"></i> ç¡®è®¤è¯Šæ–­</h5>';
      html += '<div class="card border-success">';
      html += '<div class="card-body">';
      html += '<h6>' + data.selected_diagnosis.name + '</h6>';
      if (data.selected_diagnosis.code) {
        html += '<small class="text-muted">ICDç¼–ç : ' + data.selected_diagnosis.code + '</small><br>';
      }
      if (data.selected_diagnosis.is_correct) {
        html += '<span class="badge badge-success">è¯Šæ–­æ­£ç¡®</span>';
      } else {
        html += '<span class="badge badge-warning">éœ€è¦è¿›ä¸€æ­¥ç¡®è®¤</span>';
      }
      html += '</div>';
      html += '</div>';
      html += '</div>';
    }
    
    // æ²»ç–—æ–¹æ¡ˆé€‰æ‹©
    html += '<div class="treatment-options">';
    html += '<h5 class="text-success"><i class="fas fa-prescription-bottle-alt"></i> æ²»ç–—æ–¹æ¡ˆé€‰æ‹©</h5>';
    html += '<div class="alert alert-success">';
    html += '<h6><i class="fas fa-medkit"></i> æ²»ç–—å†³ç­–æŒ‡å¯¼</h6>';
    html += '<p class="mb-0">åŸºäºç¡®å®šçš„è¯Šæ–­ï¼Œé€‰æ‹©åˆé€‚çš„æ²»ç–—æ–¹æ¡ˆã€‚è€ƒè™‘æ²»ç–—çš„æœ‰æ•ˆæ€§ã€å®‰å…¨æ€§ã€æˆæœ¬æ•ˆç›Šå’Œæ‚£è€…ä¸ªä½“æƒ…å†µã€‚</p>';
    html += '</div>';
    
    if (data.treatment_options && data.treatment_options.length > 0) {
      html += '<form id="treatment-form">';
      
      // æŒ‰æ²»ç–—ç±»å‹åˆ†ç»„
      var groupedTreatments = groupTreatmentsByType(data.treatment_options);
      
      Object.keys(groupedTreatments).forEach(function(type) {
        var typeOptions = groupedTreatments[type];
        var typeDisplayName = getTreatmentTypeDisplay(type);
        var typeIcon = getTreatmentTypeIcon(type);
        
        html += '<div class="treatment-group mb-4">';
        html += '<h6 class="text-primary mb-3">';
        html += '<i class="' + typeIcon + '"></i> ' + typeDisplayName;
        html += '<small class="text-muted ml-2">(' + typeOptions.length + 'é¡¹)</small>';
        html += '</h6>';
        
        html += '<div class="row">';
        typeOptions.forEach(function(option) {
          html += '<div class="col-md-6 mb-3">';
          html += '<div class="card treatment-option h-100';
          
          // æ ¹æ®æ²»ç–—é€‚å®œæ€§æ·»åŠ æ ·å¼ç±»
          if (option.is_optimal) {
            html += ' optimal';
          } else if (option.is_contraindicated) {
            html += ' contraindicated';
          } else if (option.is_acceptable) {
            html += ' acceptable';
          }
          
          html += '" data-treatment-id="' + option.id + '">';
          html += '<div class="card-body">';
          
          html += '<div class="form-check">';
          html += '<input class="form-check-input treatment-checkbox" type="checkbox" ';
          html += 'value="' + option.id + '" id="treat_' + option.id + '">';
          html += '<label class="form-check-label w-100" for="treat_' + option.id + '">';
          html += '<div class="d-flex justify-content-between align-items-start">';
          html += '<strong>' + option.name + '</strong>';
          
          // æ˜¾ç¤ºæ²»ç–—ç‰¹æ€§æ ‡ç­¾
          html += '<div class="treatment-badges">';
          if (option.is_optimal) {
            html += '<span class="badge badge-success">æœ€ä½³</span>';
          }
          if (option.is_contraindicated) {
            html += '<span class="badge badge-danger">ç¦å¿Œ</span>';
          }
          if (option.efficacy_score === 'high') {
            html += '<span class="badge badge-info">é«˜æ•ˆ</span>';
          }
          html += '</div>';
          
          html += '</div>';
          html += '<div class="text-muted small mt-2">' + (option.description || '') + '</div>';
          
          // æ˜¾ç¤ºç–—æ•ˆå’Œå®‰å…¨æ€§ä¿¡æ¯
          html += '<div class="treatment-info mt-2">';
          html += '<div class="row small text-muted">';
          html += '<div class="col-4">ç–—æ•ˆ: ' + (option.efficacy_score || 'ä¸­') + '</div>';
          html += '<div class="col-4">å®‰å…¨: ' + (option.safety_score || 'ä¸­') + '</div>';
          html += '<div class="col-4">æˆæœ¬: ' + (option.cost_score || 'ä¸­') + '</div>';
          html += '</div>';
          html += '</div>';
          
          // é¢„æœŸç»“æœ
          if (option.expected_outcome) {
            html += '<div class="expected-outcome mt-2">';
            html += '<small class="text-info"><i class="fas fa-bullseye"></i> ' + option.expected_outcome + '</small>';
          }
          
          html += '</label>';
          html += '</div>';
          html += '</div>';
          html += '</div>';
          html += '</div>';
        });
        html += '</div>';
        html += '</div>';
      });
      
      html += '</form>';
    } else {
      html += '<div class="alert alert-warning">æš‚æ— æ²»ç–—æ–¹æ¡ˆæ•°æ®</div>';
    }
    
    html += '</div>';
    
    // æ·»åŠ æ²»ç–—æ–¹æ¡ˆé€‰æ‹©ç»Ÿè®¡ - æ”¹è¿›æ’ç‰ˆ
    html += '<div class="treatment-summary mt-4">';
    html += '<div class="card bg-light border-0 shadow-sm">';
    html += '<div class="card-body p-4">';
    html += '<h6 class="mb-3"><i class="fas fa-chart-pie text-primary me-2"></i> æ²»ç–—æ–¹æ¡ˆåˆ†æ</h6>';
    
    // ä½¿ç”¨æ›´å¥½çš„ç½‘æ ¼å¸ƒå±€
    html += '<div class="row g-3">';
    
    // å·²é€‰æ–¹æ¡ˆ
    html += '<div class="col-6 col-md-3">';
    html += '<div class="text-center p-3 bg-white rounded border">';
    html += '<div class="h4 mb-1 text-primary" id="selected-treatments-count">0</div>';
    html += '<small class="text-muted fw-500">å·²é€‰æ–¹æ¡ˆ</small>';
    html += '</div>';
    html += '</div>';
    
    // æœ€ä½³æ–¹æ¡ˆ
    html += '<div class="col-6 col-md-3">';
    html += '<div class="text-center p-3 bg-white rounded border">';
    html += '<div class="h4 mb-1 text-success" id="optimal-treatments-count">0</div>';
    html += '<small class="text-muted fw-500">æœ€ä½³æ–¹æ¡ˆ</small>';
    html += '</div>';
    html += '</div>';
    
    // ç»¼åˆç–—æ•ˆ
    html += '<div class="col-6 col-md-3">';
    html += '<div class="text-center p-3 bg-white rounded border">';
    html += '<div class="h4 mb-1 text-warning" id="treatment-efficacy">--</div>';
    html += '<small class="text-muted fw-500">ç»¼åˆç–—æ•ˆ</small>';
    html += '</div>';
    html += '</div>';
    
    // å®‰å…¨è¯„çº§
    html += '<div class="col-6 col-md-3">';
    html += '<div class="text-center p-3 bg-white rounded border">';
    html += '<div class="h4 mb-1 text-info" id="treatment-safety">--</div>';
    html += '<small class="text-muted fw-500">å®‰å…¨è¯„çº§</small>';
    html += '</div>';
    html += '</div>';
    
    html += '</div>'; // rowç»“æŸ
    html += '</div>';
    html += '</div>';
    html += '</div>';
    
    html += '</div>';
    
    $('#stage-content').html(html);
    
    // ç»‘å®šæ²»ç–—é€‰æ‹©äº‹ä»¶
    bindTreatmentEvents();
    showClinicalThinkingPrompt('treatment');
  }
  
  function groupTreatmentsByType(options) {
    var grouped = {};
    options.forEach(function(option) {
      var type = option.type || 'medication';
      if (!grouped[type]) {
        grouped[type] = [];
      }
      grouped[type].push(option);
    });
    return grouped;
  }
  
  function getTreatmentTypeDisplay(type) {
    var displays = {
      'medication': 'è¯ç‰©æ²»ç–—',
      'surgery': 'æ‰‹æœ¯æ²»ç–—',
      'observation': 'è§‚å¯Ÿéšè®¿',
      'referral': 'è½¬è¯Šæ²»ç–—',
      'education': 'å¥åº·æ•™è‚²'
    };
    return displays[type] || type;
  }
  
  function getTreatmentTypeIcon(type) {
    var icons = {
      'medication': 'fas fa-pills',
      'surgery': 'fas fa-scalpel-path',
      'observation': 'fas fa-eye',
      'referral': 'fas fa-hospital',
      'education': 'fas fa-graduation-cap'
    };
    return icons[type] || 'fas fa-medical-kit';
  }
  
  function bindTreatmentEvents() {
    $('.treatment-checkbox').on('change', function() {
      var $card = $(this).closest('.treatment-option');
      var treatmentId = parseInt($(this).val());
      
      if ($(this).is(':checked')) {
        $card.addClass('selected');
        clinicalSession.selectedTreatments.push(treatmentId);
        addToLearningTimeline('é€‰æ‹©æ²»ç–—', $(this).siblings('label').find('strong').text());
      } else {
        $card.removeClass('selected');
        var index = clinicalSession.selectedTreatments.indexOf(treatmentId);
        if (index > -1) {
          clinicalSession.selectedTreatments.splice(index, 1);
        }
      }
      
      updateTreatmentSummary();
      provideLiveTreatmentFeedback();
    });
    
    $('.treatment-option').on('click', function(e) {
      if (e.target.type !== 'checkbox') {
        var checkbox = $(this).find('.treatment-checkbox');
        checkbox.prop('checked', !checkbox.prop('checked')).trigger('change');
      }
    });
  }
  
  function updateTreatmentSummary() {
    // ç›´æ¥ä»DOMè·å–å®é™…é€‰æ‹©çŠ¶æ€ï¼Œé¿å…ä¼šè¯æ•°æ®æ±¡æŸ“
    var $checkedTreatments = $('.treatment-checkbox:checked');
    var selectedCount = $checkedTreatments.length;
    var optimalCount = 0;
    var efficacyScores = [];
    var safetyScores = [];
    
    // åŒæ—¶æ›´æ–°ä¼šè¯æ•°æ®ä»¥ä¿æŒä¸€è‡´æ€§
    clinicalSession.selectedTreatments = [];
    
    $checkedTreatments.each(function() {
      var treatmentId = $(this).val();
      var $card = $(this).closest('.treatment-option');
      
      // æ›´æ–°ä¼šè¯æ•°æ®
      clinicalSession.selectedTreatments.push(parseInt(treatmentId));
      
      if ($card.find('.badge-success').length > 0) {
        optimalCount++;
      }
      
      // ç®€å•çš„è¯„åˆ†é€»è¾‘
      var efficacyText = $card.find('.treatment-info').text();
      if (efficacyText.includes('ç–—æ•ˆ: é«˜')) efficacyScores.push(3);
      else if (efficacyText.includes('ç–—æ•ˆ: ä¸­')) efficacyScores.push(2);
      else efficacyScores.push(1);
      
      if (efficacyText.includes('å®‰å…¨: é«˜')) safetyScores.push(3);
      else if (efficacyText.includes('å®‰å…¨: ä¸­')) safetyScores.push(2);
      else safetyScores.push(1);
    });
    
    // è®¡ç®—å¹³å‡ç–—æ•ˆå’Œå®‰å…¨æ€§
    var avgEfficacy = efficacyScores.length > 0 ? efficacyScores.reduce((a, b) => a + b, 0) / efficacyScores.length : 0;
    var avgSafety = safetyScores.length > 0 ? safetyScores.reduce((a, b) => a + b, 0) / safetyScores.length : 0;
    
    var efficacyLevel = avgEfficacy >= 2.5 ? 'é«˜' : avgEfficacy >= 1.5 ? 'ä¸­' : 'ä½';
    var safetyLevel = avgSafety >= 2.5 ? 'é«˜' : avgSafety >= 1.5 ? 'ä¸­' : 'ä½';
    
    $('#selected-treatments-count').text(selectedCount);
    $('#optimal-treatments-count').text(optimalCount);
    $('#treatment-efficacy').text(efficacyLevel);
    $('#treatment-safety').text(safetyLevel);
  }
  
  function provideLiveTreatmentFeedback() {
    var selectedCount = clinicalSession.selectedTreatments.length;
    var feedback = '';
    
    if (selectedCount === 0) {
      feedback = '<div class="alert alert-info">è¯·å¼€å§‹é€‰æ‹©æ²»ç–—æ–¹æ¡ˆ</div>';
    } else if (selectedCount === 1) {
      feedback = '<div class="alert alert-warning">è€ƒè™‘æ˜¯å¦éœ€è¦è”åˆæ²»ç–—</div>';
    } else if (selectedCount > 5) {
      feedback = '<div class="alert alert-danger">æ²»ç–—æ–¹æ¡ˆè¿‡å¤šå¯èƒ½å¢åŠ å‰¯ä½œç”¨é£é™©</div>';
    } else {
      feedback = '<div class="alert alert-success">æ²»ç–—æ–¹æ¡ˆé€‰æ‹©åˆç†</div>';
    }
    
    $('#feedback-panel').html(feedback);
  }

  function submitTreatments() {
    // æ˜¾ç¤ºæäº¤ä¸­çŠ¶æ€
    $('#btn-next').prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i> æäº¤ä¸­...');
    showFeedbackMessage('æ­£åœ¨æäº¤æ²»ç–—æ–¹æ¡ˆ...', 'info');
    
    // å‡†å¤‡æäº¤æ•°æ®
    var submitData = {
      case_id: clinicalSession.caseId,
      selected_treatments: clinicalSession.selectedTreatments,
      reasoning: $('#clinical-notes').val() || ''
    };
    
    $.ajax({
      url: '/api/clinical/submit-treatments/',
      method: 'POST',
      contentType: 'application/json',
      headers: {
        'X-CSRFToken': $('[name=csrfmiddlewaretoken]').val() || getCsrfToken()
      },
      data: JSON.stringify(submitData),
      success: function(resp) {
        $('#btn-next').prop('disabled', false).html('å®Œæˆå­¦ä¹  <i class="fas fa-check"></i>');
        
        if (resp.success) {
          // è®°å½•æ²»ç–—é˜¶æ®µå®Œæˆ
          addToLearningTimeline('å®Œæˆæ²»ç–—é€‰æ‹©', 'é€‰æ‹©äº† ' + clinicalSession.selectedTreatments.length + ' ç§æ²»ç–—æ–¹æ¡ˆ');
          
          // æ›´æ–°åˆ†æ•°
          if (resp.data.treatment_score !== undefined) {
            clinicalSession.scores.treatment = resp.data.treatment_score;
          }
          
          // è®¡ç®—æ€»åˆ†
          if (resp.data.scores && resp.data.scores.overall_score !== undefined) {
            clinicalSession.scores.overall = resp.data.scores.overall_score;
            $('#current-score').text(resp.data.scores.overall_score.toFixed(1));
          }
          
          // è¿›å…¥åé¦ˆé˜¶æ®µ
          clinicalSession.currentStage = 'feedback';
          updateClinicalProgress();
          showFinalFeedback(resp.data);
          // è§†è§‰ä¸åŠ¨ç”»åé¦ˆ
          flashCard($('#stage-content'), 'success');
          launchConfetti(40);
        } else {
          showFeedbackMessage('æäº¤å¤±è´¥: ' + resp.message, 'danger');
        }
      },
      error: function(xhr, status, error) {
        $('#btn-next').prop('disabled', false).html('ä¸‹ä¸€æ­¥ <i class="fas fa-arrow-right"></i>');
        console.error('Submit treatment error:', error, xhr.responseText);
        
        if (xhr.status === 404) {
          showFeedbackMessage('APIæ¥å£æœªæ‰¾åˆ°ï¼Œè¯·æ£€æŸ¥åç«¯é…ç½®', 'danger');
        } else if (xhr.status === 403) {
          showFeedbackMessage('æƒé™ä¸è¶³ï¼Œè¯·é‡æ–°ç™»å½•', 'danger');
        } else if (xhr.status === 500) {
          showFeedbackMessage('æœåŠ¡å™¨å†…éƒ¨é”™è¯¯ï¼Œè¯·è”ç³»ç®¡ç†å‘˜', 'danger');
        } else {
          showFeedbackMessage('ç½‘ç»œé”™è¯¯ï¼Œè¯·æ£€æŸ¥è¿æ¥: ' + error, 'danger');
        }
      }
    });
  }

  function showFinalFeedback(data) {
    clinicalSession.currentStage = 'feedback';
    updateClinicalProgress();
    updateStageProgress();
    
    updateStageCard('å­¦ä¹ å®Œæˆ', 'complete');
    
    // æ˜¾ç¤ºæœ€ç»ˆåé¦ˆ
    var feedbackHtml = '<div class="alert alert-success feedback-animation">';
    feedbackHtml += '<h6><i class="fas fa-trophy"></i> å­¦ä¹ å®Œæˆï¼</h6>';
    feedbackHtml += (data.overall_feedback || 'æ­å–œæ‚¨å®Œæˆäº†æœ¬æ¬¡ä¸´åºŠæ¨ç†å­¦ä¹ ï¼');
    feedbackHtml += '</div>';
    $('#feedback-panel').html(feedbackHtml);
    
    // æ„å»ºæœ€ç»ˆå­¦ä¹ æ€»ç»“é¡µé¢
    var html = '<div class="final-feedback text-center">';
    
    // æ ‡é¢˜
    html += '<div class="completion-header mb-4">';
    html += '<h3 class="text-success"><i class="fas fa-graduation-cap"></i> ä¸´åºŠæ¨ç†å­¦ä¹ å®Œæˆ</h3>';
    html += '<p class="text-muted">æ‚¨å·²æˆåŠŸå®Œæˆæœ¬æ¡ˆä¾‹çš„å®Œæ•´ä¸´åºŠæ¨ç†è¿‡ç¨‹</p>';
    html += '</div>';
    
    // æˆç»©å±•ç¤º
    html += '<div class="row mb-4">';
    
    // æ€»ä½“å¾—åˆ†
    html += '<div class="col-md-6 offset-md-3">';
    html += '<div class="card border-success">';
    html += '<div class="card-body text-center">';
    html += '<h4 class="text-success">æ€»ä½“å¾—åˆ†</h4>';
    var overallScore = (data.scores && data.scores.overall_score) ? data.scores.overall_score : clinicalSession.scores.overall;
    html += '<div class="display-3 text-primary font-weight-bold">' + (overallScore ? overallScore.toFixed(1) : '0.0') + '</div>';
    html += '<p class="text-muted">æ»¡åˆ† 100 åˆ†</p>';
    
    // è¯„çº§
    var grade = 'A';
    var gradeColor = 'success';
    if (overallScore < 60) {
      grade = 'D'; gradeColor = 'danger';
    } else if (overallScore < 70) {
      grade = 'C'; gradeColor = 'warning';
    } else if (overallScore < 85) {
      grade = 'B'; gradeColor = 'info';
    }
    html += '<h5><span class="badge badge-' + gradeColor + ' p-2">' + grade + ' çº§</span></h5>';
    html += '</div>';
    html += '</div>';
    html += '</div>';
    html += '</div>';
    
    // åˆ†é¡¹å¾—åˆ†
    html += '<div class="row mb-4">';
    html += '<div class="col-md-12">';
    html += '<div class="card">';
    html += '<div class="card-body">';
    html += '<h5 class="card-title"><i class="fas fa-chart-bar"></i> åˆ†é¡¹æˆç»©</h5>';
    html += '<div class="row text-center">';
    
    html += '<div class="col-4">';
    html += '<div class="score-item">';
    html += '<div class="h4 text-warning">' + (clinicalSession.scores.examination || 0).toFixed(1) + '</div>';
    html += '<small class="text-muted">æ£€æŸ¥é€‰æ‹© (30%)</small>';
    html += '</div>';
    html += '</div>';
    
    html += '<div class="col-4">';
    html += '<div class="score-item">';
    html += '<div class="h4 text-info">' + (clinicalSession.scores.diagnosis || 0).toFixed(1) + '</div>';
    html += '<small class="text-muted">è¯Šæ–­å‡†ç¡®æ€§ (50%)</small>';
    html += '</div>';
    html += '</div>';
    
    html += '<div class="col-4">';
    html += '<div class="score-item">';
    html += '<div class="h4 text-success">' + (clinicalSession.scores.treatment || 0).toFixed(1) + '</div>';
    html += '<small class="text-muted">æ²»ç–—æ–¹æ¡ˆ (20%)</small>';
    html += '</div>';
    html += '</div>';
    
    html += '</div>';
    html += '</div>';
    html += '</div>';
    html += '</div>';
    html += '</div>';
    
    // å­¦ä¹ æ€»ç»“
    if (data.overall_feedback || data.improvement_suggestions) {
      html += '<div class="row mb-4">';
      html += '<div class="col-md-12">';
      html += '<div class="card">';
      html += '<div class="card-body text-left">';
      html += '<h5 class="card-title"><i class="fas fa-lightbulb"></i> å­¦ä¹ æ€»ç»“</h5>';
      if (data.overall_feedback) {
        html += '<p>' + data.overall_feedback + '</p>';
      }
      if (data.improvement_suggestions) {
        html += '<h6 class="text-primary">æ”¹è¿›å»ºè®®ï¼š</h6>';
        html += '<p>' + data.improvement_suggestions + '</p>';
      }
      html += '</div>';
      html += '</div>';
      html += '</div>';
      html += '</div>';
    }
    
    // æ“ä½œæŒ‰é’® - æ’‘æ»¡æ•´è¡Œå¹¶å±…ä¸­
    html += '<div class="action-buttons mt-4">';
    html += '<div class="d-flex justify-content-center align-items-center">';
    html += '<div class="d-flex w-100" style="max-width: 600px;">';
    html += '<button class="btn btn-outline-primary flex-fill mx-2" onclick="location.reload()">';
    html += '<i class="fas fa-redo"></i> é‡æ–°å­¦ä¹ ';
    html += '</button>';
    html += '<a href="/student/clinical-cases/" class="btn btn-outline-secondary flex-fill mx-2">';
    html += '<i class="fas fa-list"></i> è¿”å›æ¡ˆä¾‹åˆ—è¡¨';
    html += '</a>';
    html += '<a href="/student/" class="btn btn-outline-success flex-fill mx-2">';
    html += '<i class="fas fa-home"></i> è¿”å›é¦–é¡µ';
    html += '</a>';
    html += '</div>';
    html += '</div>';
    html += '</div>';
    
    html += '</div>';
    
    $('#stage-content').html(html);
    
    // å®Œå…¨é‡æ„å¯¼èˆªå¡ç‰‡ä»¥æ˜¾ç¤ºå®ŒæˆçŠ¶æ€
    var completionNavHtml = '<div class="card-body">';
    completionNavHtml += '<div class="text-center">';
    completionNavHtml += '<div style="padding: 20px; background: linear-gradient(135deg, #d4edda, #c3e6cb); border-radius: 10px; border: 2px solid #28a745; box-shadow: 0 4px 8px rgba(40, 167, 69, 0.2);">';
    completionNavHtml += '<i class="fas fa-check-circle text-success me-2" style="font-size: 1.2em;"></i>';
    completionNavHtml += '<span class="text-success fw-bold" style="font-size: 1.1em;">ä¸´åºŠæ¨ç†è¿›åº¦å·²ç»å®Œæˆ</span>';
    completionNavHtml += '<div class="mt-3">';
    completionNavHtml += '<div style="width: 350px; height: 15px; background-color: #e9ecef; border-radius: 10px; margin: 0 auto; overflow: hidden; border: 1px solid #28a745;">';
    completionNavHtml += '<div style="width: 100%; height: 100%; background: linear-gradient(90deg, #28a745, #20c997); border-radius: 10px; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 0.8em;">';
    completionNavHtml += '100%';
    completionNavHtml += '</div>';
    completionNavHtml += '</div>';
    completionNavHtml += '<small class="text-success mt-2 d-block fw-bold">å­¦ä¹ å®Œæˆ</small>';
    completionNavHtml += '</div>';
    completionNavHtml += '</div>';
    completionNavHtml += '</div>';
    completionNavHtml += '</div>';
    
    $('#navigation-card').html(completionNavHtml);
    
    // æ¸…é™¤ä¿å­˜çš„è¿›åº¦
    localStorage.removeItem('clinical_progress_' + clinicalSession.caseId);
    
    // è®°å½•å®Œæˆæ—¶é—´
    clinicalSession.timeSpent.total = new Date() - clinicalSession.startTime;
    addToLearningTimeline('å®Œæˆå­¦ä¹ ', 'æ€»ç”¨æ—¶: ' + Math.floor(clinicalSession.timeSpent.total / 60000) + ' åˆ†é’Ÿ');
  }

  // ==================== åŠ¨ç”»ä¸è§†è§‰æ•ˆæœ ====================
  
  // ç®€å• confetti æ•ˆæœï¼ˆæ— å¤–éƒ¨åº“ï¼Œè½»é‡ï¼‰
  function launchConfetti(count) {
    count = count || 30;
    for (var i = 0; i < count; i++) {
      (function() {
        var conf = document.createElement('div');
        conf.className = 'confetti-piece';
        var size = Math.floor(Math.random() * 8) + 6;
        conf.style.width = size + 'px';
        conf.style.height = (size * 0.6) + 'px';
        conf.style.background = ['#28a745','#007bff','#ffc107','#dc3545','#6610f2'][Math.floor(Math.random() * 5)];
        conf.style.position = 'fixed';
        conf.style.zIndex = 9999;
        conf.style.left = (Math.random() * window.innerWidth) + 'px';
        conf.style.top = '-20px';
        conf.style.opacity = Math.random() * 0.9 + 0.1;
        conf.style.transform = 'rotate(' + (Math.random() * 360) + 'deg)';
        conf.style.pointerEvents = 'none';
        document.body.appendChild(conf);
        var endY = window.innerHeight + 100 + Math.random() * 200;
        var duration = 1000 + Math.random() * 1200;
        conf.animate([
          { transform: conf.style.transform + ' translateY(0px)', opacity: conf.style.opacity },
          { transform: conf.style.transform + ' translateY(' + endY + 'px)', opacity: 0.6 }
        ], { duration: duration, easing: 'cubic-bezier(.2,.8,.2,1)' });
        setTimeout(function() { conf.remove(); }, duration + 200);
      })();
    }
  }

  // å¡ç‰‡é«˜äº®è·³åŠ¨ï¼Œç”¨äºå¼ºè°ƒæˆåŠŸ/é”™è¯¯
  function flashCard($el, type) {
    var cls = (type === 'success') ? 'flash-success' : 'flash-warning';
    $el.addClass(cls);
    setTimeout(function() { $el.removeClass(cls); }, 900);
  }

  // æ­¥éª¤é—ªå…‰ï¼ˆçŸ­æš‚æ”¾å¤§ã€å…‰æ™•ï¼‰
  function highlightStep(stepName) {
    var $step = $('.stepper-item[data-step="' + stepName + '"]');
    $step.addClass('step-highlight');
    setTimeout(function() { $step.removeClass('step-highlight'); }, 800);
  }


  
  // ==================== é€šç”¨åŠŸèƒ½å‡½æ•° ====================
  
  function showClinicalThinkingPrompt(stage) {
    var prompts = {
      'history': 'æ€è€ƒï¼šæ‚£è€…çš„ç—‡çŠ¶ç‰¹ç‚¹æ˜¯ä»€ä¹ˆï¼Ÿå¯èƒ½çš„ç—…å› æœ‰å“ªäº›ï¼Ÿéœ€è¦é‡ç‚¹å…³æ³¨ä»€ä¹ˆï¼Ÿ',
      'examination': 'æ€è€ƒï¼šåŸºäºç—…å²ï¼Œå“ªäº›æ£€æŸ¥æœ€æœ‰åŠ©äºæ˜ç¡®è¯Šæ–­ï¼Ÿå¦‚ä½•å¹³è¡¡è¯Šæ–­ä»·å€¼å’Œæˆæœ¬ï¼Ÿ',
      'diagnosis': 'æ€è€ƒï¼šæ£€æŸ¥ç»“æœæ”¯æŒå“ªäº›è¯Šæ–­ï¼Ÿå¦‚ä½•è¿›è¡Œé‰´åˆ«è¯Šæ–­ï¼Ÿæ¦‚ç‡æœ€é«˜çš„æ˜¯ä»€ä¹ˆï¼Ÿ',
      'treatment': 'æ€è€ƒï¼šé’ˆå¯¹ç¡®å®šçš„è¯Šæ–­ï¼Œæœ€ä½³æ²»ç–—æ–¹æ¡ˆæ˜¯ä»€ä¹ˆï¼Ÿå¦‚ä½•è¯„ä¼°é£é™©è·ç›Šæ¯”ï¼Ÿ',
      'feedback': 'æ€è€ƒï¼šå›é¡¾æ•´ä¸ªè¯Šç–—è¿‡ç¨‹ï¼Œæœ‰å“ªäº›å€¼å¾—æ€»ç»“çš„ç»éªŒï¼Ÿ'
    };
    
    if (prompts[stage]) {
      showFeedbackMessage(prompts[stage], 'guidance');
    }
  }
  
  function showFeedbackMessage(message, type = 'info') {
    var alertClass = {
      'info': 'alert-info',
      'success': 'alert-success feedback-positive',
      'warning': 'alert-warning feedback-corrective', 
      'danger': 'alert-danger',
      'guidance': 'alert-info feedback-guidance'
    }[type] || 'alert-info';
    
    var icon = {
      'info': 'fas fa-info-circle',
      'success': 'fas fa-check-circle',
      'warning': 'fas fa-exclamation-triangle',
      'danger': 'fas fa-times-circle',
      'guidance': 'fas fa-lightbulb'
    }[type] || 'fas fa-info-circle';
    
    var html = '<div class="alert ' + alertClass + ' feedback-animation">';
    html += '<i class="' + icon + '"></i> ' + message;
    html += '</div>';
    
    $('#feedback-panel').html(html);
    
    // è®°å½•åé¦ˆå†å²
    clinicalSession.feedbackHistory.push({
      timestamp: new Date(),
      stage: clinicalSession.currentStage,
      message: message,
      type: type
    });
  }
  
  function showErrorMessage(message) {
    showFeedbackMessage('é”™è¯¯ï¼š' + message, 'danger');
  }
  
  function addToLearningTimeline(action, detail) {
    var timestamp = new Date().toLocaleTimeString();
    var html = '<div class="timeline-item">';
    html += '<div class="d-flex justify-content-between">';
    html += '<strong>' + action + '</strong>';
    html += '<small class="text-muted">' + timestamp + '</small>';
    html += '</div>';
    html += '<div class="text-muted small">' + detail + '</div>';
    html += '</div>';
    
    $('#learning-timeline').prepend(html);
    
    // ä¿æŒæœ€å¤šæ˜¾ç¤º10æ¡è®°å½•
    var items = $('#learning-timeline .timeline-item');
    if (items.length > 10) {
      items.slice(10).remove();
    }
  }
  
  function updateTimeSpent() {
    var now = new Date();
    var elapsed = Math.floor((now - clinicalSession.startTime) / 1000); // ç§’
    var minutes = Math.floor(elapsed / 60);
    var seconds = elapsed % 60;
    
    var timeStr = String(minutes).padStart(2, '0') + ':' + String(seconds).padStart(2, '0');
    $('#time-spent').text(timeStr);
  }
  
  function updateStageProgress() {
    var stages = clinicalSession.stages;
    var currentIndex = stages.indexOf(clinicalSession.currentStage);
    var progress = Math.round(((currentIndex + 1) / stages.length) * 100);
    
    // ä½¿ç”¨ç»Ÿä¸€çš„è¿›åº¦æ›´æ–°å‡½æ•°
    updateNavigationProgress();
    $('#current-stage-text').text(getStageDisplayName(clinicalSession.currentStage));
  }
  
  function getStageDisplayName(stage) {
    var names = {
      'history': 'ç—…å²é‡‡é›†',
      'examination': 'æ£€æŸ¥é€‰æ‹©',
      'diagnosis': 'è¯Šæ–­æ¨ç†',
      'treatment': 'æ²»ç–—å†³ç­–',
      'feedback': 'å­¦ä¹ åé¦ˆ'
    };
    return names[stage] || stage;
  }
  
  function saveCurrentProgress() {
    // ä¿å­˜å½“å‰å­¦ä¹ è¿›åº¦åˆ°æœ¬åœ°å­˜å‚¨
    var progressData = {
      caseId: clinicalSession.caseId,
      stage: clinicalSession.currentStage,
      selectedExaminations: clinicalSession.selectedExaminations,
      selectedDiagnosis: clinicalSession.selectedDiagnosis,
      selectedTreatments: clinicalSession.selectedTreatments,
      notes: $('#clinical-notes').val(),
      timestamp: new Date().toISOString()
    };
    
    localStorage.setItem('clinical_progress_' + clinicalSession.caseId, JSON.stringify(progressData));
  }
  
  function loadSavedProgress() {
    // å°è¯•åŠ è½½ä¹‹å‰ä¿å­˜çš„è¿›åº¦
    var saved = localStorage.getItem('clinical_progress_' + clinicalSession.caseId);
    if (saved) {
      try {
        var progressData = JSON.parse(saved);
        // å¦‚æœæ˜¯å½“å¤©çš„è¿›åº¦ï¼Œåˆ™æ¢å¤
        var savedTime = new Date(progressData.timestamp);
        var now = new Date();
        if (now.toDateString() === savedTime.toDateString()) {
          return progressData;
        }
      } catch (e) {
        console.log('Failed to load saved progress:', e);
      }
    }
    return null;
  }
  
  // ==================== ä¸»ç¨‹åºå…¥å£å’Œäº‹ä»¶ç»‘å®š ====================
  
  // æ›´æ–°é˜¶æ®µå¡ç‰‡æ ·å¼å’Œå†…å®¹
  function updateStageCard(stageName, stageKey) {
    const stageConfig = {
      'history': {
        text: 'ç—…å²é‡‡é›†é˜¶æ®µ',
        icon: 'fas fa-clipboard-list',
        textColor: 'text-success',
        cardClass: 'stage-history'
      },
      'examination': {
        text: 'æ£€æŸ¥é€‰æ‹©é˜¶æ®µ', 
        icon: 'fas fa-stethoscope',
        textColor: 'text-warning',
        cardClass: 'stage-examination'
      },
      'diagnosis': {
        text: 'è¯Šæ–­æ¨ç†é˜¶æ®µ',
        icon: 'fas fa-brain',
        textColor: 'text-purple',
        cardClass: 'stage-diagnosis'
      },
      'treatment': {
        text: 'æ²»ç–—å†³ç­–é˜¶æ®µ',
        icon: 'fas fa-pills',
        textColor: 'text-info',
        cardClass: 'stage-treatment'
      },
      'complete': {
        text: 'å­¦ä¹ å®Œæˆ',
        icon: 'fas fa-check-circle',
        textColor: 'text-success',
        cardClass: 'stage-complete'
      }
    };
    
    const config = stageConfig[stageKey] || stageConfig['history'];
    const $stageBadge = $('#current-stage-badge');
    const $stageCard = $stageBadge.closest('.stage-info-card');
    
    // æ›´æ–°æ–‡å­—å’Œå›¾æ ‡
    $stageBadge.text(config.text)
              .removeClass()
              .addClass('fw-bold ' + config.textColor)
              .css('font-size', '0.9rem');
    
    // æ›´æ–°å¡ç‰‡æ ·å¼
    $stageCard.removeClass('stage-history stage-examination stage-diagnosis stage-treatment stage-complete')
              .addClass(config.cardClass);
    
    // æ›´æ–°å›¾æ ‡
    $stageCard.find('i').removeClass().addClass(config.icon + ' me-2').css('font-size', '0.9em');
    
    // æ›´æ–°å›¾æ ‡é¢œè‰²
    const iconColorClass = config.textColor.replace('text-', '');
    if (iconColorClass === 'purple') {
      $stageCard.find('i').removeClass().addClass(config.icon + ' me-2').css({'font-size': '0.9em', 'color': '#9c27b0'});
    } else {
      $stageCard.find('i').removeClass().addClass(config.icon + ' ' + config.textColor + ' me-2').css('font-size', '0.9em');
    }
  }

  // è¿›åº¦æ¡æ›´æ–°å‡½æ•°
  function updateNavigationProgress() {
    const stageMapping = {
      'history': 1,
      'examination': 2, 
      'diagnosis': 3,
      'treatment': 4,
      'feedback': 4
    };
    
    const totalSteps = 4;
    const currentStepNum = stageMapping[clinicalSession.currentStage] || 1;
    const progressPercent = Math.round((currentStepNum / totalSteps) * 100);
    
    // æ›´æ–°è¿›åº¦æ¡
    const progressBar = document.getElementById('overall-progress');
    if (progressBar) {
      progressBar.style.width = progressPercent + '%';
      progressBar.textContent = progressPercent + '%';
      progressBar.setAttribute('aria-valuenow', progressPercent);
      
      // æ ¹æ®è¿›åº¦è°ƒæ•´é¢œè‰²
      let gradient;
      if (progressPercent <= 25) {
        gradient = 'linear-gradient(90deg, #dc3545, #c82333)'; // çº¢è‰²
      } else if (progressPercent <= 50) {
        gradient = 'linear-gradient(90deg, #ffc107, #e0a800)'; // é»„è‰²
      } else if (progressPercent <= 75) {
        gradient = 'linear-gradient(90deg, #007bff, #0056b3)'; // è“è‰²
      } else {
        gradient = 'linear-gradient(90deg, #28a745, #20c997)'; // ç»¿è‰²
      }
      progressBar.style.background = gradient;
    }
    
    // æ›´æ–°è¿›åº¦æ–‡æœ¬
    const progressText = document.getElementById('progress-text');
    if (progressText) {
      progressText.textContent = `æ­¥éª¤ ${currentStepNum}/${totalSteps} (${progressPercent}%)`;
    }
  }
  
  $(document).ready(function() {
    // åˆå§‹åŒ–æ—¶é—´æ˜¾ç¤ºæ›´æ–°
    setInterval(updateTimeSpent, 1000);
    
    // æ¸…ç©ºå¯èƒ½çš„å†å²è¿›åº¦æ•°æ®ï¼Œé¿å…æ±¡æŸ“
    localStorage.removeItem('clinical_progress_' + clinicalSession.caseId);
    
    // ç¡®ä¿ä¼šè¯æ•°æ®å¹²å‡€åˆå§‹åŒ–
    clinicalSession.selectedExaminations = [];
    clinicalSession.selectedTreatments = [];
    clinicalSession.selectedDiagnosis = null;
    
    // å°è¯•æ¢å¤ä¹‹å‰çš„å­¦ä¹ è¿›åº¦ï¼ˆå·²ç¦ç”¨ï¼Œé¿å…æ•°æ®æ±¡æŸ“ï¼‰
    /*
    var savedProgress = loadSavedProgress();
    if (savedProgress && confirm('æ£€æµ‹åˆ°ä¹‹å‰çš„å­¦ä¹ è¿›åº¦ï¼Œæ˜¯å¦ç»§ç»­ä¹‹å‰çš„å­¦ä¹ ï¼Ÿ')) {
      // æ¢å¤è¿›åº¦é€»è¾‘
      clinicalSession.currentStage = savedProgress.stage;
      clinicalSession.selectedExaminations = savedProgress.selectedExaminations || [];
      clinicalSession.selectedDiagnosis = savedProgress.selectedDiagnosis;
      clinicalSession.selectedTreatments = savedProgress.selectedTreatments || [];
      $('#clinical-notes').val(savedProgress.notes || '');
    }
    */
    
    // å¼€å§‹ç—…å²é˜¶æ®µ
    initializeHistoryStage();
    
    // åˆå§‹åŒ–è¿›åº¦æ˜¾ç¤º
    updateNavigationProgress();
    
    // ç»‘å®šå¯¼èˆªæŒ‰é’®äº‹ä»¶
    $('#btn-next').on('click', function() {
      handleNextStage();
    });

    $('#btn-prev').on('click', function() {
      handlePreviousStage();
    });
    
    // ç»‘å®šä¸´åºŠç¬”è®°è‡ªåŠ¨ä¿å­˜
    $('#clinical-notes').on('input', function() {
      clearTimeout(window.notesSaveTimeout);
      window.notesSaveTimeout = setTimeout(saveCurrentProgress, 2000);
    });
    
    // é¡µé¢ç¦»å¼€æ—¶ä¿å­˜è¿›åº¦
    $(window).on('beforeunload', function() {
      saveCurrentProgress();
    });
  });
  
  function handleNextStage() {
    var currentStage = clinicalSession.currentStage;
    
    switch (currentStage) {
      case 'history':
        // è®°å½•ç—…å²é˜¶æ®µç”¨æ—¶
        clinicalSession.timeSpent.history = new Date() - clinicalSession.timeSpent.history;
        loadExaminationStage();
        break;
        
      case 'examination':
        if (clinicalSession.selectedExaminations.length === 0) {
          showFeedbackMessage('è¯·è‡³å°‘é€‰æ‹©ä¸€é¡¹æ£€æŸ¥', 'warning');
          return;
        }
        submitExaminations();
        break;
        
      case 'diagnosis':
        if (!clinicalSession.selectedDiagnosis) {
          showFeedbackMessage('è¯·é€‰æ‹©ä¸€ä¸ªè¯Šæ–­', 'warning');
          return;
        }
        submitDiagnosis();
        break;
        
      case 'treatment':
        if (clinicalSession.selectedTreatments.length === 0) {
          showFeedbackMessage('è¯·é€‰æ‹©è‡³å°‘ä¸€ç§æ²»ç–—æ–¹æ¡ˆ', 'warning');
          return;
        }
        submitTreatments();
        break;
        
      default:
        showFeedbackMessage('å½“å‰é˜¶æ®µæ— æ³•ç»§ç»­', 'warning');
    }
    
    // æ›´æ–°å¯¼èˆªè¿›åº¦
    updateNavigationProgress();
  }
  
  function handlePreviousStage() {
    var currentStage = clinicalSession.currentStage;
    var stages = clinicalSession.stages;
    var currentIndex = stages.indexOf(currentStage);
    
    if (currentIndex > 0) {
      var previousStage = stages[currentIndex - 1];
      
      // ç®€å•çš„è¿”å›é€»è¾‘ - å®é™…åº”ç”¨ä¸­å¯èƒ½éœ€è¦æ›´å¤æ‚çš„çŠ¶æ€æ¢å¤
      if (previousStage === 'history') {
        initializeHistoryStage();
      } else if (previousStage === 'examination') {
        loadExaminationStage();
      }
      // å¯ä»¥ç»§ç»­æ·»åŠ å…¶ä»–é˜¶æ®µçš„è¿”å›é€»è¾‘
    }
    
    // æ›´æ–°å¯¼èˆªè¿›åº¦
    updateNavigationProgress();
  }
  
  // è¿™é‡Œçœç•¥äº†submitExaminationChoices, submitDiagnosisChoice, submitTreatmentChoicesç­‰å‡½æ•°
  // è¿™äº›å‡½æ•°ä¼šè°ƒç”¨å®é™…çš„APIï¼Œå¹¶å¤„ç†æœåŠ¡å™¨å“åº”
  // ç”±äºç¯‡å¹…é™åˆ¶ï¼Œä¿æŒåŸæœ‰çš„ç®€åŒ–APIè°ƒç”¨é€»è¾‘
  
})();
</script>
{% endblock %}