{% extends 'base.html' %}
{% load static %}

{% block title %}临床推理 - {{ clinical_case.title }}{% endblock %}

{% block content %}
{% csrf_token %}
<div class="container-fluid mt-4">
  <!-- 临床推理系统标题 -->
  <div class="row mb-4">
    <div class="col-12 text-center">
      <h2 class="text-primary">
        <i class="fas fa-user-md"></i> 临床推理学习系统
        <small class="text-muted d-block mt-2">基于真实案例的临床思维训练</small>
      </h2>
    </div>
  </div>
  
  <!-- 临床指导提示区域 -->
  <div class="row mb-3">
    <div class="col-12">
      <div id="clinical-guidance">
        <!-- 动态临床指导内容 -->
      </div>
    </div>
  </div>
  
  <!-- 步骤进度条 -->
  <div class="row mb-4">
    <div class="col-12">
      <div class="progress-stepper">
        <div class="stepper-items">
          <div class="stepper-item active" data-step="history">
            <div class="stepper-icon">1</div>
            <div class="stepper-title">病史采集</div>
          </div>
          <div class="stepper-item" data-step="examination">
            <div class="stepper-icon">2</div>
            <div class="stepper-title">检查选择</div>
          </div>
          <div class="stepper-item" data-step="diagnosis">
            <div class="stepper-icon">3</div>
            <div class="stepper-title">诊断推理</div>
          </div>
          <div class="stepper-item" data-step="treatment">
            <div class="stepper-icon">4</div>
            <div class="stepper-title">治疗方案</div>
          </div>
          <div class="stepper-item" data-step="feedback">
            <div class="stepper-icon">5</div>
            <div class="stepper-title">学习反馈</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="row">
    <!-- 主要学习内容区域 -->
    <div class="col-lg-8">
      <div class="card mb-3 shadow-sm">
        <div class="card-header bg-light">
          <!-- 病例信息卡片区域 -->
          <div class="mb-3">
            <div class="d-flex flex-wrap gap-2 align-items-center">
              <!-- 病例名称卡片 -->
              <div class="case-info-card" style="background: linear-gradient(135deg, #e3f2fd, #bbdefb); border: 1px solid #2196f3; border-radius: 8px; padding: 8px 12px; display: inline-flex; align-items: center;">
                <i class="fas fa-eye text-primary me-2" style="font-size: 0.9em;"></i>
                <span class="fw-bold text-primary" id="case-title" style="font-size: 0.9rem;">{{ clinical_case.title }}</span>
              </div>
              
              <!-- 阶段状态卡片 -->
              <div class="stage-info-card" style="background: linear-gradient(135deg, #e8f5e8, #c8e6c8); border: 1px solid #4caf50; border-radius: 8px; padding: 8px 12px; display: inline-flex; align-items: center;">
                <i class="fas fa-tasks text-success me-2" style="font-size: 0.9em;"></i>
                <span class="fw-bold text-success" id="current-stage-badge" style="font-size: 0.9rem;">病史采集阶段</span>
              </div>
            </div>
          </div>
          
          <!-- 患者基础信息 -->
          <div class="patient-basic-info" id="patient-info">
            <div class="text-muted" style="font-size: 0.95rem; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;">
              <span style="color: #495057; font-weight: 600;">基础信息：</span>
              <span style="font-weight: 500;">{{ clinical_case.patient_age }}岁 {{ clinical_case.get_patient_gender_display }}</span>
              <span style="margin: 0 12px; color: #6c757d;">•</span>
              <span style="font-weight: 500;">编号：{{ clinical_case.case_id }}</span>
              {% if clinical_case.patient_occupation %}
                <span style="margin: 0 12px; color: #6c757d;">•</span>
                <span style="font-weight: 500;">职业：{{ clinical_case.patient_occupation }}</span>
              {% endif %}
            </div>
          </div>
        </div>
        <div class="card-body">
          <div id="stage-content">
            <div class="text-center p-5">
              <i class="fas fa-spinner fa-spin fa-2x text-primary"></i>
              <p class="mt-3">正在加载临床案例数据...</p>
            </div>
          </div>
        </div>
      </div>

      <!-- 导航控制面板 -->
      <div class="card" id="navigation-card">
        <div class="card-body">
          <!-- 按钮行 -->
          <div class="d-flex justify-content-between align-items-center mb-3">
            <button class="btn btn-outline-secondary" id="btn-prev" disabled>
              <i class="fas fa-arrow-left me-1"></i> 上一步
            </button>
            <button class="btn btn-primary" id="btn-next">
              下一步 <i class="fas fa-arrow-right ms-1"></i>
            </button>
          </div>
          
          <!-- 进度信息行 -->
          <div class="text-center">
            <small class="text-muted d-block mb-2">临床推理进度</small>
            <div style="width: 350px; height: 15px; background-color: #e9ecef; border-radius: 10px; margin: 0 auto; overflow: hidden; border: 1px solid #dee2e6;" class="progress-container">
              <div id="overall-progress" style="height: 100%; background: linear-gradient(90deg, #007bff, #0056b3); border-radius: 10px; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 0.8em; width: 25%; transition: width 0.6s ease;" role="progressbar">
                25%
              </div>
            </div>
            <small class="text-muted d-block mt-2" id="progress-text">步骤 1/4 (25%)</small>
          </div>
        </div>
      </div>
    </div>

    <!-- 侧边工具和反馈区域 -->
    <div class="col-lg-4">
      <!-- 临床记录面板 -->
      <div class="card mb-3 border-primary">
        <div class="card-header bg-primary text-white">
          <h6 class="mb-0"><i class="fas fa-clipboard"></i> 临床记录</h6>
        </div>
        <div class="card-body">
          <div class="nav nav-pills mb-3" id="clinical-tabs" role="tablist">
            <a class="nav-item nav-link active" id="notes-tab" data-toggle="pill" href="#notes-panel" role="tab">笔记</a>
            <a class="nav-item nav-link" id="timeline-tab" data-toggle="pill" href="#timeline-panel" role="tab">时间线</a>
          </div>
          <div class="tab-content">
            <div class="tab-pane fade show active" id="notes-panel">
              <textarea id="clinical-notes" class="form-control" rows="5" placeholder="记录临床思考过程、鉴别诊断要点..."></textarea>
              <small class="text-muted mt-2 d-block">
                <i class="fas fa-lightbulb"></i> 记录思维过程有助于临床能力提升
              </small>
            </div>
            <div class="tab-pane fade" id="timeline-panel">
              <div id="learning-timeline">
                <small class="text-muted">学习进程将在此显示</small>
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <!-- 实时反馈面板 -->
      <div class="card mb-3">
        <div class="card-header bg-success text-white">
          <h6 class="mb-0"><i class="fas fa-comments"></i> 智能指导</h6>
        </div>
        <div class="card-body" id="feedback-panel">
          <div class="text-center text-muted">
            <i class="fas fa-robot fa-2x mb-2"></i>
            <p class="mb-0">AI助教将为您提供实时指导</p>
          </div>
        </div>
      </div>
      
      <!-- 学习统计面板 -->
      <div class="card">
        <div class="card-header">
          <h6 class="mb-0"><i class="fas fa-chart-line"></i> 学习统计</h6>
        </div>
        <div class="card-body">
          <div id="learning-stats">
            <div class="row text-center">
              <div class="col-6">
                <div class="border-right">
                  <div class="h4 mb-0" id="time-spent">00:00</div>
                  <small class="text-muted">用时</small>
                </div>
              </div>
              <div class="col-6">
                <div class="h4 mb-0" id="current-score">--</div>
                <small class="text-muted">当前得分</small>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
/* ==================== 临床推理系统样式 ==================== */

/* 导航按钮统一样式 */
#btn-prev, #btn-next {
  min-width: 120px;
  height: 40px;
  font-size: 14px;
  font-weight: 500;
  border-radius: 8px;
  transition: all 0.3s ease;
}

#btn-prev {
  border: 2px solid #6c757d;
  color: #6c757d;
}

#btn-prev:hover:not(:disabled) {
  background-color: #6c757d;
  color: white;
  transform: translateY(-1px);
}

#btn-next {
  background: linear-gradient(135deg, #007bff, #0056b3);
  border: none;
  color: white;
}

#btn-next:hover:not(:disabled) {
  background: linear-gradient(135deg, #0056b3, #004085);
  transform: translateY(-1px);
  box-shadow: 0 4px 8px rgba(0, 123, 255, 0.3);
}

#btn-prev:disabled, #btn-next:disabled {
  opacity: 0.5;
  cursor: not-allowed;
  transform: none;
}

/* 进度条样式优化 */
.progress-container {
  position: relative;
  border: 1px solid #dee2e6;
  background-color: #e9ecef;
  border-radius: 10px;
  overflow: hidden;
  height: 15px;
  max-width: 350px;
  margin: 0 auto;
}

#overall-progress {
  height: 100%;
  border-radius: 10px;
  display: flex;
  align-items: center;
  justify-content: center;
  color: white;
  font-weight: bold;
  font-size: 0.8em;
  transition: width 0.6s ease, background 0.3s ease;
  min-width: 30px; /* 确保百分比文字有足够空间 */
}

/* 检查结果小卡片样式 */
.exam-result-card {
  background: white;
  border: 1px solid #e3e6f0;
  border-radius: 12px;
  padding: 0;
  transition: all 0.3s ease;
  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
  overflow: hidden;
}

.exam-result-card:hover {
  transform: translateY(-2px);
  box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1);
  border-color: #007bff;
}

.exam-header {
  background: linear-gradient(135deg, #f8f9fa, #e9ecef);
  padding: 1rem 1.25rem;
  border-bottom: 1px solid #e3e6f0;
}

.exam-title {
  display: flex;
  align-items: center;
  font-size: 1.1rem;
}

.exam-content {
  padding: 1.25rem;
}

.result-label {
  font-size: 0.875rem;
  font-weight: 600;
  color: #6c757d;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  margin-bottom: 0.5rem;
}

.result-text {
  font-size: 0.95rem;
  line-height: 1.6;
  color: #495057;
  background: #f8f9fa;
  padding: 0.75rem 1rem;
  border-radius: 8px;
  border-left: 4px solid #007bff;
  margin: 0;
}

/* 特殊检查结果样式 */
.exam-result-card .fas.fa-eye {
  font-size: 1.1em;
  color: #007bff;
}

.exam-result-card .badge {
  font-size: 0.75rem;
  padding: 0.4em 0.8em;
  border-radius: 6px;
}

/* 响应式设计 */
@media (max-width: 768px) {
  .exam-header {
    padding: 0.875rem 1rem;
  }
  
  .exam-content {
    padding: 1rem;
  }
  
  .exam-title {
    font-size: 1rem;
  }
  
  .result-text {
    font-size: 0.9rem;
    padding: 0.625rem 0.875rem;
  }
}

/* 治疗方案分析样式优化 */
.treatment-summary .card {
  border: none;
  background: linear-gradient(135deg, #f8f9fa, #e9ecef);
}

.treatment-summary .card-body {
  padding: 1.5rem;
}

.treatment-summary .bg-white {
  background: white !important;
  transition: all 0.3s ease;
  border: 1px solid #dee2e6 !important;
}

.treatment-summary .bg-white:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
  border-color: #007bff !important;
}

.treatment-summary .h4 {
  font-weight: 600;
  font-size: 1.8rem;
}

.treatment-summary .fw-500 {
  font-weight: 500;
}

.treatment-summary .rounded {
  border-radius: 8px !important;
}

/* 响应式优化 */
@media (max-width: 768px) {
  .treatment-summary .h4 {
    font-size: 1.5rem;
  }
  
  .treatment-summary .card-body {
    padding: 1rem;
  }
}

/* 学习完成页面按钮统一样式 - 居中布局 */
.action-buttons {
  width: 100%;
  display: flex;
  justify-content: center;
  align-items: center;
}

.action-buttons .btn {
  height: 50px;
  font-size: 15px;
  font-weight: 500;
  padding: 12px 20px;
  border-radius: 8px;
  transition: all 0.3s ease;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  text-decoration: none;
  border-width: 2px;
  white-space: nowrap;
  flex-grow: 1;
  max-width: none;
}

.action-buttons .btn i {
  margin-right: 8px;
  font-size: 1.1em;
  width: 16px;
  text-align: center;
}

.action-buttons .btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 6px 16px rgba(0, 0, 0, 0.15);
  text-decoration: none;
}

/* 确保outline样式的按钮也有相同的视觉效果 */
.action-buttons .btn-outline-primary:hover {
  background-color: #007bff;
  border-color: #007bff;
  color: white;
}

.action-buttons .btn-outline-secondary:hover {
  background-color: #6c757d;
  border-color: #6c757d;
  color: white;
}

.action-buttons .btn-outline-success:hover {
  background-color: #28a745;
  border-color: #28a745;
  color: white;
}

/* 按钮间距调整 */
.action-buttons .mx-2 {
  margin-left: 8px !important;
  margin-right: 8px !important;
}

/* 按钮组容器样式 */
.action-buttons .d-flex[style*="max-width"] {
  justify-content: space-between;
  gap: 0;
}

/* 响应式设计 - 小屏幕时堆叠按钮 */
@media (max-width: 768px) {
  .action-buttons .d-flex[style*="max-width"] {
    flex-direction: column;
    gap: 10px;
    max-width: 300px !important;
  }
  
  .action-buttons .btn {
    margin: 0 !important;
    height: 45px;
    font-size: 14px;
  }
}

/* 进度指示器样式优化 */
.progress-stepper {
  display: flex;
  justify-content: center;
  margin-bottom: 2rem;
  padding: 1rem;
  background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
  border-radius: 15px;
}

.stepper-items {
  display: flex;
  align-items: center;
  justify-content: space-between;
  width: 100%;
  max-width: 700px;
}

.stepper-item {
  display: flex;
  flex-direction: column;
  align-items: center;
  text-align: center;
  flex: 1;
  position: relative;
  transition: all 0.3s ease;
}

.stepper-item:not(:last-child)::after {
  content: '';
  position: absolute;
  top: 20px;
  left: 60%;
  width: 80%;
  height: 3px;
  background: linear-gradient(90deg, #dee2e6 0%, #ced4da 100%);
  z-index: 1;
  border-radius: 2px;
}

.stepper-item.active::after {
  background: linear-gradient(90deg, #007bff 0%, #0056b3 100%);
  box-shadow: 0 2px 4px rgba(0, 123, 255, 0.3);
}

.stepper-item.completed::after {
  background: linear-gradient(90deg, #28a745 0%, #1e7e34 100%);
  box-shadow: 0 2px 4px rgba(40, 167, 69, 0.3);
}

.stepper-icon {
  width: 45px;
  height: 45px;
  border-radius: 50%;
  background: linear-gradient(135deg, #e9ecef 0%, #ced4da 100%);
  color: #6c757d;
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: bold;
  font-size: 1.1rem;
  margin-bottom: 8px;
  position: relative;
  z-index: 2;
  border: 3px solid #fff;
  box-shadow: 0 4px 8px rgba(0,0,0,0.1);
  transition: all 0.3s ease;
}

.stepper-item.active .stepper-icon {
  background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
  color: white;
  transform: scale(1.1);
  box-shadow: 0 6px 12px rgba(0, 123, 255, 0.4);
  animation: pulse 2s infinite;
}

.stepper-item.completed .stepper-icon {
  background: linear-gradient(135deg, #28a745 0%, #1e7e34 100%);
  color: white;
  box-shadow: 0 4px 8px rgba(40, 167, 69, 0.3);
}

.stepper-item.thinking .stepper-icon {
  animation: thinking 1.5s ease-in-out infinite;
}

@keyframes pulse {
  0% { box-shadow: 0 6px 12px rgba(0, 123, 255, 0.4); }
  50% { box-shadow: 0 8px 16px rgba(0, 123, 255, 0.6); }
  100% { box-shadow: 0 6px 12px rgba(0, 123, 255, 0.4); }
}

@keyframes thinking {
  0%, 100% { transform: scale(1.1); }
  50% { transform: scale(1.05); }
}

.stepper-title {
  font-size: 0.9rem;
  color: #6c757d;
  margin-top: 4px;
  font-weight: 500;
  transition: all 0.3s ease;
}

.stepper-item.active .stepper-title {
  color: #007bff;
  font-weight: 600;
  transform: translateY(-2px);
}

.stepper-item.completed .stepper-title {
  color: #28a745;
  font-weight: 600;
}

/* 临床指导区域样式 */
.clinical-guidance {
  border-left: 4px solid #007bff;
  background: linear-gradient(135deg, #f8f9ff 0%, #e6f3ff 100%);
  animation: slideIn 0.5s ease-out;
}

@keyframes slideIn {
  from { opacity: 0; transform: translateY(-10px); }
  to { opacity: 1; transform: translateY(0); }
}

.clinical-tips ul {
  list-style: none;
  padding-left: 0;
}

.clinical-tips li {
  position: relative;
  padding-left: 20px;
  margin-bottom: 5px;
}

.clinical-tips li::before {
  content: '💡';
  position: absolute;
  left: 0;
  top: 0;
}

/* 病史分析工具样式 */
/* 病史采集阶段专用样式 */
.patient-history {
  animation: fadeInUp 0.6s ease-out;
}

.info-item {
  padding: 15px;
  border-radius: 8px;
  background: rgba(255, 255, 255, 0.8);
  transition: all 0.3s ease;
  border: 1px solid rgba(0,0,0,0.05);
}

.info-item:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(0,0,0,0.1);
  background: rgba(255, 255, 255, 0.95);
}

.chief-complaint-content blockquote {
  border-left: 4px solid #ff6b6b;
  padding-left: 20px;
  background: rgba(255, 107, 107, 0.05);
  border-radius: 0 8px 8px 0;
}

.illness-timeline {
  position: relative;
}

.formatted-history {
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  line-height: 1.8;
}

.time-marker {
  display: inline-block;
  animation: pulseGlow 2s infinite;
}

.symptom-highlight {
  display: inline-block;
  animation: highlightPulse 3s infinite;
}

@keyframes pulseGlow {
  0%, 100% { box-shadow: 0 0 5px rgba(52, 152, 219, 0.3); }
  50% { box-shadow: 0 0 15px rgba(52, 152, 219, 0.6); }
}

@keyframes highlightPulse {
  0%, 100% { box-shadow: 0 0 3px rgba(231, 76, 60, 0.2); }
  50% { box-shadow: 0 0 8px rgba(231, 76, 60, 0.4); }
}

/* 医学病史部分样式 */
.medical-history-sections {
  margin-top: 20px;
}

.medical-history-sections .card {
  transition: all 0.3s ease;
}

.medical-history-sections .card:hover {
  transform: translateY(-2px);
  box-shadow: 0 8px 25px rgba(0,0,0,0.15);
}

/* 图标容器动画 */
.icon-container {
  transition: all 0.3s ease;
}

.card:hover .icon-container {
  transform: rotate(5deg) scale(1.1);
}

/* 眼底检查提示字幕样式 */
#fundus-overlay {
  pointer-events: none;
  user-select: none;
}

#fundus-subtitle {
  letter-spacing: 1px;
  text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
  backdrop-filter: blur(10px);
  border: 2px solid rgba(255,255,255,0.1);
}

@media (max-width: 768px) {
  #fundus-subtitle {
    font-size: 1.4rem !important;
    padding: 15px 25px !important;
    max-width: 90% !important;
  }
}

/* 病例信息卡片样式 */
.case-info-card, .stage-info-card {
  transition: all 0.3s ease;
  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
}

.case-info-card:hover, .stage-info-card:hover {
  transform: translateY(-1px);
  box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
}

.case-info-card {
  background: linear-gradient(135deg, #e3f2fd, #bbdefb) !important;
  border: 1px solid #2196f3 !important;
}

.stage-info-card {
  background: linear-gradient(135deg, #e8f5e8, #c8e6c8) !important;
  border: 1px solid #4caf50 !important;
}

/* 不同阶段的卡片颜色 */
.stage-info-card.stage-history {
  background: linear-gradient(135deg, #e8f5e8, #c8e6c8) !important;
  border-color: #4caf50 !important;
}

.stage-info-card.stage-examination {
  background: linear-gradient(135deg, #fff3e0, #ffe0b2) !important;
  border-color: #ff9800 !important;
}

.stage-info-card.stage-diagnosis {
  background: linear-gradient(135deg, #f3e5f5, #e1bee7) !important;
  border-color: #9c27b0 !important;
}

.stage-info-card.stage-treatment {
  background: linear-gradient(135deg, #e0f2f1, #b2dfdb) !important;
  border-color: #009688 !important;
}

.stage-info-card.stage-complete {
  background: linear-gradient(135deg, #e8f5e8, #c8e6c8) !important;
  border-color: #4caf50 !important;
}

/* 响应式设计 */
@media (max-width: 576px) {
  .case-info-card, .stage-info-card {
    flex: 1;
    min-width: 0;
    justify-content: center;
  }
}

/* 患者信息区域样式 */
.patient-basic-info {
  padding: 12px 16px;
  background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
  border-radius: 8px;
  border: 1px solid #dee2e6;
  margin-top: 12px;
  transition: all 0.3s ease;
}

.patient-basic-info:hover {
  background: linear-gradient(135deg, #fff 0%, #f8f9fa 100%);
  box-shadow: 0 2px 8px rgba(0,0,0,0.1);
  transform: translateY(-1px);
}



/* 病史内容提示框 */
.alert-info {
  background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
  border: none;
  border-radius: 8px;
}

.alert-info i {
  color: #1976d2;
}

.symptom-tags .badge {
  margin: 2px;
  font-size: 0.85rem;
  padding: 0.4em 0.8em;
}

.timeline-info {
  background: white;
  padding: 10px;
  border-radius: 5px;
  border-left: 3px solid #007bff;
}

/* 检查选项样式增强 */
.examination-option {
  transition: all 0.3s ease;
  cursor: pointer;
}

.examination-option:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(0,0,0,0.1);
}

.examination-option.selected {
  border-color: #007bff;
  background-color: #f8f9ff;
}

.examination-option .form-check-input:checked + .form-check-label {
  color: #007bff;
  font-weight: 600;
}

/* 诊断选项样式 */
.diagnosis-option {
  border: 2px solid transparent;
  transition: all 0.3s ease;
  cursor: pointer;
}

.diagnosis-option:hover {
  border-color: #007bff;
  background-color: #f8f9ff;
}

.diagnosis-option.selected {
  border-color: #007bff;
  background-color: #e6f3ff;
}

/* 治疗方案样式 */
.treatment-option {
  border-left: 4px solid #dee2e6;
  transition: all 0.3s ease;
}

.treatment-option.optimal {
  border-left-color: #28a745;
}

.treatment-option.acceptable {
  border-left-color: #ffc107;
}

.treatment-option.contraindicated {
  border-left-color: #dc3545;
  background-color: #fff5f5;
}

/* 学习统计面板 */
.learning-stats .h4 {
  font-family: 'Courier New', monospace;
  font-weight: bold;
}

/* 时间线样式 */
.learning-timeline {
  max-height: 200px;
  overflow-y: auto;
}

.timeline-item {
  border-left: 2px solid #e9ecef;
  padding-left: 15px;
  margin-bottom: 10px;
  position: relative;
}

.timeline-item::before {
  content: '';
  position: absolute;
  left: -5px;
  top: 5px;
  width: 8px;
  height: 8px;
  background: #007bff;
  border-radius: 50%;
}

/* 响应式设计 */
@media (max-width: 768px) {
  .stepper-items {
    flex-direction: column;
    align-items: stretch;
  }
  
  .stepper-item {
    margin-bottom: 20px;
    flex-direction: row;
    justify-content: flex-start;
    text-align: left;
  }
  
  .stepper-item::after {
    display: none;
  }
  
  .stepper-icon {
    margin-right: 15px;
    margin-bottom: 0;
  }
}

/* 反馈面板动画 */
.feedback-animation {
  animation: fadeInUp 0.5s ease-out;
}

@keyframes fadeInUp {
  from {
    opacity: 0;
    transform: translateY(20px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

/* 成功反馈样式 */
.feedback-positive {
  border-left: 4px solid #28a745;
  background-color: #d4edda;
}

.feedback-corrective {
  border-left: 4px solid #ffc107;
  background-color: #fff3cd;
}

.feedback-guidance {
  border-left: 4px solid #17a2b8;
  background-color: #d1ecf1;
}

/* 动画效果样式 */
.confetti-piece {
  border-radius: 2px;
  box-shadow: 0 1px 2px rgba(0,0,0,0.15);
}

.flash-success {
  animation: flashSuccess 0.9s ease-in-out;
}

.flash-warning {
  animation: flashWarning 0.9s ease-in-out;
}

@keyframes flashSuccess {
  0% { transform: scale(1); box-shadow: 0 0 0 rgba(40,167,69,0); }
  30% { transform: scale(1.04); box-shadow: 0 10px 30px rgba(40,167,69,0.18); }
  100% { transform: scale(1); box-shadow: 0 0 0 rgba(40,167,69,0); }
}

@keyframes flashWarning {
  0% { transform: scale(1); box-shadow: 0 0 0 rgba(255,193,7,0); }
  30% { transform: scale(1.04); box-shadow: 0 10px 30px rgba(255,193,7,0.18); }
  100% { transform: scale(1); box-shadow: 0 0 0 rgba(255,193,7,0); }
}

.step-highlight {
  animation: stepPulse 0.8s ease-out;
}

@keyframes stepPulse {
  0% { transform: scale(1); box-shadow: 0 0 0 rgba(0,123,255,0); }
  50% { transform: scale(1.08); box-shadow: 0 10px 30px rgba(0,123,255,0.22); }
  100% { transform: scale(1); box-shadow: 0 0 0 rgba(0,123,255,0); }
}
</style>
{% endblock %}

{% block extra_js %}
<script>
// 临床推理教学系统 - 重新设计的交互逻辑
// 作为医疗教育工程师，我设计了一个更贴近真实临床思维的学习系统

(function() {
  // ==================== 核心状态管理 ====================
  var clinicalSession = {
    caseId: '{{ clinical_case.case_id }}',
    currentStage: 'history',
    stages: ['history', 'examination', 'diagnosis', 'treatment', 'feedback'],
    
    // 临床数据收集
    selectedExaminations: [],
    examinationResults: [],
    clinicalFindings: {},
    
    // 诊断推理
    diagnosticHypotheses: [],
    selectedDiagnosis: null,
    differentialAnalysis: {},
    
    // 治疗决策
    selectedTreatments: [],
    treatmentRationale: '',
    
    // 学习评估
    scores: {
      examination: 0,
      diagnosis: 0,
      treatment: 0,
      overall: 0,
      clinicalThinking: 0
    },
    
    // 时间跟踪
    timeSpent: {},
    startTime: new Date(),
    
    // 教学反馈
    feedbackHistory: [],
    clinicalMistakes: [],
    learningInsights: []
  };

  // ==================== 医学教育核心功能 ====================
  
  function updateClinicalProgress() {
    // 更新可视化进度指示器
    $('.stepper-item').removeClass('active completed thinking');
    var currentIndex = clinicalSession.stages.indexOf(clinicalSession.currentStage);
    
    for (var i = 0; i <= currentIndex; i++) {
      var $step = $('.stepper-item[data-step="' + clinicalSession.stages[i] + '"]');
      if (i === currentIndex) {
        $step.addClass('active thinking');
        // 添加思考动画效果
        $step.find('.stepper-icon').html('<i class="fas fa-brain fa-pulse"></i>');
      } else {
        $step.addClass('completed');
        $step.find('.stepper-icon').html('<i class="fas fa-check"></i>');
      }
    }
    // 高亮当前步骤一次
    highlightStep(clinicalSession.currentStage);
    
    // 更新阶段提示
    updateStageGuidance();
  }
  
  function updateStageGuidance() {
    var guidance = {
      'history': {
        title: '📋 病史采集阶段',
        instruction: '仔细阅读患者的主诉和病史信息，这是临床推理的基础。思考：患者的主要问题是什么？可能的病因有哪些？',
        tips: ['注意症状的时间顺序', '关注既往史的相关性', '思考症状的严重程度']
      },
      'examination': {
        title: '🔍 临床检查阶段', 
        instruction: '基于病史分析，选择最有价值的检查项目。记住：合理的检查选择体现临床思维能力。',
        tips: ['优先选择性价比高的检查', '避免过度检查', '考虑检查的诊断价值']
      },
      'diagnosis': {
        title: '🎯 诊断推理阶段',
        instruction: '综合病史和检查结果，进行鉴别诊断。思考各种可能性的概率，选择最可能的诊断。',
        tips: ['列出鉴别诊断', '分析支持和反对证据', '考虑疾病的流行病学特点']
      },
      'treatment': {
        title: '💊 治疗决策阶段',
        instruction: '基于确定的诊断，制定合理的治疗方案。考虑治疗的有效性、安全性和成本效益。',
        tips: ['个体化治疗方案', '考虑患者承受能力', '权衡获益和风险']
      },
      'feedback': {
        title: '📚 学习总结阶段',
        instruction: '回顾整个临床推理过程，总结学习要点和改进方向。',
        tips: ['反思决策过程', '巩固关键知识点', '制定学习计划']
      }
    };
    
    var current = guidance[clinicalSession.currentStage];
    if (current) {
      var html = '<div class="clinical-guidance card mb-3">';
      html += '<div class="card-body">';
      html += '<h6 class="card-title text-primary">' + current.title + '</h6>';
      html += '<p class="card-text">' + current.instruction + '</p>';
      html += '<div class="clinical-tips">';
      html += '<small class="text-muted"><strong>临床思维要点：</strong></small>';
      html += '<ul class="small text-muted mb-0">';
      current.tips.forEach(function(tip) {
        html += '<li>' + tip + '</li>';
      });
      html += '</ul>';
      html += '</div>';
      html += '</div>';
      html += '</div>';
      
      $('#clinical-guidance').html(html);
    }
  }

  
  // ==================== 病史阶段：建立临床印象 ====================
  
  function updatePatientInfoInHeader(data) {
    // 更新标题区域的患者信息 - 带标签显示
    var patientInfoHtml = '<div class="text-muted" style="font-size: 0.95rem; font-family: -apple-system, BlinkMacSystemFont, \'Segoe UI\', Roboto, Arial, sans-serif;">';
    
    // 添加基础信息标签，然后是年龄性别、编号、职业
    patientInfoHtml += '<span style="color: #495057; font-weight: 600;">基础信息：</span>';
    patientInfoHtml += '<span style="font-weight: 500;">' + (data.patient_info.age || '未知') + '岁 ' + (data.patient_info.gender || '未知') + '</span>';
    patientInfoHtml += '<span style="margin: 0 12px; color: #6c757d;">•</span>';
    patientInfoHtml += '<span style="font-weight: 500;">编号：' + data.case_id + '</span>';
    
    // 职业（如果有）
    if (data.patient_info.occupation) {
      patientInfoHtml += '<span style="margin: 0 12px; color: #6c757d;">•</span>';
      patientInfoHtml += '<span style="font-weight: 500;">职业：' + data.patient_info.occupation + '</span>';
    }
    
    patientInfoHtml += '</div>';
    
    // 更新DOM
    $('#patient-info').html(patientInfoHtml);
  }
  
  function initializeHistoryStage() {
    clinicalSession.currentStage = 'history';
    updateClinicalProgress();
    
    // 记录开始时间
    clinicalSession.timeSpent.history = new Date();
    
    $('#btn-prev').prop('disabled', true);
    $('#btn-next').text('开始检查选择 →').removeClass('btn-secondary').addClass('btn-primary');
    
    $.getJSON('/api/clinical/case/' + clinicalSession.caseId + '/', function(resp) {
      if (resp.success) {
        window.caseData = resp.data;
        
        // 更新标题区域的患者信息
        updatePatientInfoInHeader(resp.data);
        
        // 渲染病史内容
        renderPatientHistory(resp.data);
        
        // 添加临床思考提示
        showClinicalThinkingPrompt('history');
      } else {
        showErrorMessage('加载病史信息失败: ' + resp.message);
      }
    }).fail(function() {
      showErrorMessage('网络错误，请检查连接后重试');
    });
  }
  
  function renderPatientHistory(data) {
    var html = '<div class="patient-history">';
    
    // 直接开始主诉，患者基本信息已在标题区域显示
    
    // 主诉卡片 - 重新设计
    html += '<div class="card mb-4 shadow-sm border-0">';
    html += '<div class="card-header border-0" style="background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%); border-radius: 12px 12px 0 0;">';
    html += '<div class="d-flex align-items-center justify-content-between">';
    html += '<h5 class="mb-0 text-white d-flex align-items-center" style="font-weight: 600; letter-spacing: 0.5px;">';
    html += '<i class="fas fa-exclamation-circle me-2" style="font-size: 1.2rem;"></i>';
    html += '主诉 <span style="font-size: 0.9rem; font-weight: 400; opacity: 0.8; margin-left: 8px;">Chief Complaint</span>';
    html += '</h5>';
    html += '</div>';
    html += '</div>';
    html += '<div class="card-body" style="padding: 1.5rem; background: #fff8f0;">';
    html += '<div class="chief-complaint-content">';
    html += '<blockquote class="blockquote text-center mb-0">';
    html += '<p class="mb-0" style="font-size: 1.1rem; color: #2c3e50; font-weight: 500; line-height: 1.6; font-style: italic;">"' + (data.clinical_info.chief_complaint || '无记录') + '"</p>';
    html += '</blockquote>';
    html += '</div>';
    html += '</div>';
    html += '</div>';
    
    // 现病史卡片 - 重新设计
    html += '<div class="card mb-4 shadow-sm border-0">';
    html += '<div class="card-header border-0" style="background: linear-gradient(135deg, #2980b9 0%, #3498db 100%); border-radius: 12px 12px 0 0;">';
    html += '<div class="d-flex align-items-center justify-content-between">';
    html += '<h5 class="mb-0 text-white d-flex align-items-center" style="font-weight: 600; letter-spacing: 0.5px;">';
    html += '<i class="fas fa-clipboard-list me-2" style="font-size: 1.2rem;"></i>';
    html += '现病史 <span style="font-size: 0.9rem; font-weight: 400; opacity: 0.8; margin-left: 8px;">History of Present Illness</span>';
    html += '</h5>';
    html += '</div>';
    html += '</div>';
    html += '<div class="card-body" style="padding: 1.5rem; background: #f0f8ff;">';
    html += '<div class="present-illness-content" style="line-height: 1.8; font-size: 1rem; color: #2c3e50;">';
    
    var presentIllness = data.clinical_info.present_illness || data.clinical_info.history_of_present_illness || '无记录';
    
    html += '<div class="illness-timeline">';
    html += formatMedicalHistory(presentIllness);
    html += '</div>';
    
    html += '</div>';
    html += '</div>';
    html += '</div>';
    
    // 既往史、个人史、家族史 - 按标准医学病史格式排列
    html += '<div class="medical-history-sections">';
    
    // 既往史
    if (data.clinical_info.past_history || data.clinical_info.past_medical_history) {
      html += '<div class="card mb-4 shadow-sm border-0">';
      html += '<div class="card-header border-0" style="background: linear-gradient(135deg, #27ae60 0%, #2ecc71 100%); border-radius: 12px 12px 0 0;">';
      html += '<div class="d-flex align-items-center justify-content-between">';
      html += '<h5 class="mb-0 text-white d-flex align-items-center" style="font-weight: 600; letter-spacing: 0.5px;">';
      html += '<i class="fas fa-history me-2" style="font-size: 1.2rem;"></i>';
      html += '既往史 <span style="font-size: 0.9rem; font-weight: 400; opacity: 0.8; margin-left: 8px;">Past Medical History</span>';
      html += '</h5>';
      html += '</div>';
      html += '</div>';
      html += '<div class="card-body" style="padding: 1.5rem; background: #f8fff8;">';
      var pastHistory = data.clinical_info.past_history || data.clinical_info.past_medical_history || '无特殊既往史';
      html += '<p class="mb-0" style="line-height: 1.6; color: #2c3e50; font-size: 1rem;">' + formatMedicalHistory(pastHistory) + '</p>';
      html += '</div>';
      html += '</div>';
    }
    
    // 个人史
    if (data.clinical_info.personal_history || data.clinical_info.social_history) {
      html += '<div class="card mb-4 shadow-sm border-0">';
      html += '<div class="card-header border-0" style="background: linear-gradient(135deg, #8e44ad 0%, #9b59b6 100%); border-radius: 12px 12px 0 0;">';
      html += '<div class="d-flex align-items-center justify-content-between">';
      html += '<h5 class="mb-0 text-white d-flex align-items-center" style="font-weight: 600; letter-spacing: 0.5px;">';
      html += '<i class="fas fa-user-cog me-2" style="font-size: 1.2rem;"></i>';
      html += '个人史 <span style="font-size: 0.9rem; font-weight: 400; opacity: 0.8; margin-left: 8px;">Personal & Social History</span>';
      html += '</h5>';
      html += '</div>';
      html += '</div>';
      html += '<div class="card-body" style="padding: 1.5rem; background: #faf8ff;">';
      var personalHistory = data.clinical_info.personal_history || data.clinical_info.social_history || '无特殊个人史记录';
      html += '<p class="mb-0" style="line-height: 1.6; color: #2c3e50; font-size: 1rem;">' + formatMedicalHistory(personalHistory) + '</p>';
      html += '</div>';
      html += '</div>';
    }
    
    // 家族史
    if (data.clinical_info.family_history) {
      html += '<div class="card mb-4 shadow-sm border-0">';
      html += '<div class="card-header border-0" style="background: linear-gradient(135deg, #e67e22 0%, #f39c12 100%); border-radius: 12px 12px 0 0;">';
      html += '<div class="d-flex align-items-center justify-content-between">';
      html += '<h5 class="mb-0 text-white d-flex align-items-center" style="font-weight: 600; letter-spacing: 0.5px;">';
      html += '<i class="fas fa-users me-2" style="font-size: 1.2rem;"></i>';
      html += '家族史 <span style="font-size: 0.9rem; font-weight: 400; opacity: 0.8; margin-left: 8px;">Family History</span>';
      html += '</h5>';
      html += '</div>';
      html += '</div>';
      html += '<div class="card-body" style="padding: 1.5rem; background: #fffaf0;">';
      html += '<p class="mb-0" style="line-height: 1.6; color: #2c3e50; font-size: 1rem;">' + formatMedicalHistory(data.clinical_info.family_history) + '</p>';
      html += '</div>';
      html += '</div>';
    }
    
    html += '</div>';
    
    html += '</div>';
    $('#stage-content').html(html);
  }
  
  function formatMedicalHistory(text) {
    // 格式化病史文本，突出关键信息并改善可读性
    var formatted = text
      // 时间标记
      .replace(/(\d+[天月年周])/g, '<span class="time-marker" style="background: linear-gradient(135deg, #3498db, #2980b9); color: white; padding: 2px 8px; border-radius: 12px; font-size: 0.85rem; font-weight: 500; margin: 0 2px;">$1</span>')
      // 症状关键词
      .replace(/(疼痛|不适|模糊|下降|出血|红肿|瘙痒|干涩|流泪|畏光|复视|黑影|闪光)/g, '<span class="symptom-highlight" style="background: #ffe6e6; color: #c0392b; padding: 1px 4px; border-radius: 4px; font-weight: 600; border-left: 3px solid #e74c3c;">$1</span>')
      // 否定词汇
      .replace(/(无|否认|未见|正常|阴性)/g, '<span class="negative-finding" style="background: #e8f5e8; color: #27ae60; padding: 1px 4px; border-radius: 4px; font-weight: 500;">$1</span>')
      // 程度词汇
      .replace(/(轻度|中度|重度|严重|明显|显著)/g, '<span class="severity-marker" style="background: #fff3cd; color: #856404; padding: 1px 4px; border-radius: 4px; font-weight: 500;">$1</span>');
    
    // 将文本分段并添加适当的间距
    return '<div class="formatted-history">' + formatted.replace(/。/g, '。<br style="margin-bottom: 8px;">') + '</div>';
  }
  

  


  
  // ==================== 检查阶段：循证医学指导 ====================
  
  function loadExaminationStage() {
    clinicalSession.currentStage = 'examination';
    updateClinicalProgress();
    updateStageProgress();
    
    $('#btn-prev').prop('disabled', false);
    $('#btn-next').text('提交检查选择 →').removeClass('btn-secondary').addClass('btn-warning');
    updateStageCard('检查选择阶段', 'examination');
    
    $.getJSON('/api/clinical/case/' + clinicalSession.caseId + '/examinations/', function(resp) {
      if (resp.success) {
        renderExaminationOptions(resp.data.examination_options || []);
        addExaminationGuidance();
        showClinicalThinkingPrompt('examination');
      } else {
        showErrorMessage('加载检查选项失败: ' + resp.message);
      }
    }).fail(function() {
      showErrorMessage('网络错误，请检查连接后重试');
    });
  }
  
  function renderExaminationOptions(options) {
    var html = '<div class="examination-selection">';
    
    // 检查选择说明
    html += '<div class="alert alert-info" style="background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%); border: none; border-radius: 12px; padding: 20px;">';
    html += '<h4 class="mb-3" style="color: #1565c0; font-weight: 700; display: flex; align-items: center;">';
    html += '<i class="fas fa-lightbulb me-2" style="font-size: 1.2rem; color: #ffa726;"></i>检查选择指导';
    html += '</h4>';
    html += '<p class="mb-0" style="font-size: 1rem; line-height: 1.6; color: #424242;">基于患者病史，选择最有价值的检查项目。考虑诊断价值、成本效益和患者安全。</p>';
    html += '</div>';
    
    // 按类型分组显示检查选项
    var groupedOptions = groupExaminationsByType(options);
    
    Object.keys(groupedOptions).forEach(function(type) {
  var typeOptions = groupedOptions[type];
      var typeDisplayName = getExaminationTypeDisplay(type);
      var typeIcon = getExaminationTypeIcon(type);
      
      html += '<div class="examination-group mb-4">';
      html += '<h4 class="text-primary mb-3" style="font-weight: 700; display: flex; align-items: center;">';
      html += '<i class="' + typeIcon + ' me-2" style="font-size: 1.3rem;"></i>' + typeDisplayName;
      html += '<span class="text-muted ms-2" style="font-size: 1rem; font-weight: 500;">(' + typeOptions.length + '项)</span>';
      html += '</h4>';
      
      html += '<div class="row">';
      typeOptions.forEach(function(option) {
        // encode images array as JSON string for data attribute
        var imagesAttr = (option.images && option.images.length) ? JSON.stringify(option.images) : '[]';
        var isRequiredAttr = option.is_required ? 1 : 0;
        var allowMultipleAttr = option.is_multiple_choice ? 1 : 0;
        html += '<div class="col-md-6 mb-3">';
        html += '<div class="card examination-option h-100" data-exam-id="' + option.id + '" data-images=\'' + imagesAttr + '\' data-is-required="' + isRequiredAttr + '" data-allow-multiple="' + allowMultipleAttr + '">';
        html += '<div class="card-body">';
        
        html += '<div class="form-check d-flex align-items-start">';
  // 若后端标注了多选允许或必选（后端 may not provide these—use defaults if absent）
  var inputType = option.is_multiple_choice ? 'checkbox' : 'checkbox'; // frontend will validate single/multi via option.allow_multiple if provided
  html += '<input class="form-check-input examination-checkbox me-3 mt-1" type="' + inputType + '" ';
  html += 'value="' + option.id + '" id="exam_' + option.id + '" data-is-recommended="' + (option.is_recommended ? '1' : '0') + '" data-is-fundus="' + ((option.type && option.type.toLowerCase().indexOf('眼底') !== -1) ? '1' : '0') + '" data-is-required="' + isRequiredAttr + '" data-allow-multiple="' + allowMultipleAttr + '" style="width: 18px; height: 18px;">';
        html += '<label class="form-check-label flex-grow-1" for="exam_' + option.id + '">';
        html += '<div class="d-flex justify-content-between align-items-start mb-2">';
        html += '<strong style="font-size: 1.1rem; color: #2c3e50;">' + option.name + '</strong>';
        
        // 显示检查特性标签
        html += '<div class="examination-badges">';
        // 使用后端返回的字段展示标签
        if (option.is_recommended) {
          html += '<span class="badge badge-success">推荐</span>';
        }
        if (option.diagnostic_value && option.diagnostic_value.toLowerCase().indexOf('高') !== -1) {
          html += '<span class="badge badge-success">高价值</span>';
        }
        html += '</div>';
        
        html += '</div>';
        html += '<div class="text-muted small mt-2">' + (option.description || '') + '</div>';
        
        // 显示风险和成本信息
  // 检查额外信息（后端可能没有风险/费用字段，作兼容处理）
  html += '<div class="examination-info mt-2">';
  html += '<div class="row small text-muted">';
  html += '<div class="col-6">风险: ' + (option.risk_level || '未知') + '</div>';
  html += '<div class="col-6">费用: ¥' + (option.cost || 0) + '</div>';
  html += '</div>';
  html += '</div>';
        
        html += '</label>';
        html += '</div>';
        html += '</div>';
        html += '</div>';
        html += '</div>';
      });
      html += '</div>';
      html += '</div>';
    });
    
    html += '</div>';
    
    // 添加选择统计
    html += '<div class="examination-summary mt-4">';
    html += '<div class="card bg-light">';
    html += '<div class="card-body">';
    html += '<h6><i class="fas fa-calculator"></i> 选择统计</h6>';
    html += '<div class="row text-center">';
    html += '<div class="col-3">';
    html += '<div class="h5 mb-0" id="selected-count">0</div>';
    html += '<small class="text-muted">已选检查</small>';
    html += '</div>';
    html += '<div class="col-3">';
    html += '<div class="h5 mb-0" id="total-cost">¥0</div>';
    html += '<small class="text-muted">总费用</small>';
    html += '</div>';
    html += '<div class="col-3">';
    html += '<div class="h5 mb-0" id="high-value-count">0</div>';
    html += '<small class="text-muted">高价值检查</small>';
    html += '</div>';
    html += '<div class="col-3">';
    html += '<div class="h5 mb-0" id="risk-assessment">低</div>';
    html += '<small class="text-muted">综合风险</small>';
    html += '</div>';
    html += '</div>';
    html += '</div>';
    html += '</div>';
    html += '</div>';
    
    $('#stage-content').html(html);
    
    // 绑定检查选择事件
    bindExaminationEvents();
  }
  
  function groupExaminationsByType(options) {
    var grouped = {};
    options.forEach(function(option) {
      var type = option.examination_type || 'basic';
      if (!grouped[type]) {
        grouped[type] = [];
      }
      grouped[type].push(option);
    });
    return grouped;
  }
  
  function getExaminationTypeDisplay(type) {
    var displays = {
      'basic': '基础检查',
      'imaging': '影像学检查', 
      'laboratory': '实验室检查',
      'special': '特殊检查'
    };
    return displays[type] || type;
  }
  
  function getExaminationTypeIcon(type) {
    var icons = {
      'basic': 'fas fa-stethoscope',
      'imaging': 'fas fa-x-ray',
      'laboratory': 'fas fa-flask',
      'special': 'fas fa-microscope'
    };
    return icons[type] || 'fas fa-medical-kit';
  }
  
  function getRiskLevelDisplay(level) {
    var displays = {
      'low': '<span class="text-success">低</span>',
      'medium': '<span class="text-warning">中</span>',
      'high': '<span class="text-danger">高</span>'
    };
    return displays[level] || level;
  }
  
  function bindExaminationEvents() {
    $('.examination-checkbox').on('change', function() {
      var $card = $(this).closest('.examination-option');
      var examId = parseInt($(this).val());
      var isChecked = $(this).is(':checked');
      var isFundus = $(this).data('is-fundus') == 1;

      // 单选/多选控制（如果后端传回 is_multiple_choice 可使用；否则使用页面约束：同一类型限制单选示例）
      var allowMultiple = $(this).data('allow-multiple') === 1;

      if (!allowMultiple && isChecked) {
        // 取消同一类型下其他已选项（保持单选行为）
        var name = $(this).attr('name');
        $('.examination-checkbox[name="' + name + '"]').not(this).prop('checked', false).trigger('change');
      }

      if (isChecked) {
        $card.addClass('selected');
        if (clinicalSession.selectedExaminations.indexOf(examId) === -1) clinicalSession.selectedExaminations.push(examId);
        addToLearningTimeline('选择检查', $card.find('strong').text());

        // 若为眼底检查，显示实操提示
        var examName = $card.find('strong').text().toLowerCase();
        if (isFundus || examName.includes('眼底') || examName.includes('fundus') || examName.includes('照片') || examName.includes('造影')) {
          showFundusReminder();
        }
      } else {
        $card.removeClass('selected');
        var index = clinicalSession.selectedExaminations.indexOf(examId);
        if (index > -1) {
          clinicalSession.selectedExaminations.splice(index, 1);
        }
      }

      updateExaminationSummary();
      provideLiveExaminationFeedback();

      // 如果该选项包含图片，点击查看图片则记录
      var images = $card.data('images');
      if (images && images.length > 0) {
        // render images preview when selected
        renderExaminationImagesForCard($card, images);
      }
    });
    
    $('.examination-option').on('click', function(e) {
      if (e.target.type !== 'checkbox') {
        var checkbox = $(this).find('.examination-checkbox');
        checkbox.prop('checked', !checkbox.prop('checked')).trigger('change');
      }
    });
  }

  function showFundusReminder() {
    // 防止重复显示
    if ($('#fundus-overlay').length > 0) return;
    
    // 创建全屏覆盖层和字幕
    var overlayHtml = '';
    overlayHtml += '<div id="fundus-overlay" style="';
    overlayHtml += 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 9999;';
    overlayHtml += 'background: rgba(0, 0, 0, 0.6); display: flex; align-items: center; justify-content: center;';
    overlayHtml += 'opacity: 0; transition: opacity 0.8s ease-in-out;';
    overlayHtml += '">';
    overlayHtml += '<div id="fundus-subtitle" style="';
    overlayHtml += 'background: rgba(0, 0, 0, 0.8); color: white; padding: 20px 40px;';
    overlayHtml += 'border-radius: 12px; font-size: 1.8rem; font-weight: 600;';
    overlayHtml += 'text-align: center; max-width: 80%; box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);';
    overlayHtml += 'transform: translateY(20px); transition: all 0.8s ease-in-out;';
    overlayHtml += '">';
    overlayHtml += '请移步旁边，对眼底检查进行实操';
    overlayHtml += '</div>';
    overlayHtml += '</div>';
    
    // 添加到页面
    $('body').append(overlayHtml);
    
    // 动画序列：淡入 → 停留 → 淡出 → 自动进入下一环节
    setTimeout(function() {
      // 淡入动画
      $('#fundus-overlay').css('opacity', '1');
      $('#fundus-subtitle').css('transform', 'translateY(0)');
    }, 100);
    
    setTimeout(function() {
      // 淡出动画
      $('#fundus-overlay').css('opacity', '0');
      $('#fundus-subtitle').css('transform', 'translateY(-20px)');
    }, 4600); // 0.8s淡入 + 3s停留 + 0.8s准备淡出
    
    setTimeout(function() {
      // 移除覆盖层
      $('#fundus-overlay').remove();
      
      // 自动进入下一环节（提交检查选择）
      autoSubmitExaminations();
    }, 5400); // 总计 5.4s 后完成
  }
  
  function autoSubmitExaminations() {
    // 检查是否有选中的检查项目
    if (clinicalSession.selectedExaminations.length > 0) {
      // 显示自动提交提示
      showFeedbackMessage('眼底检查完成，正在进入下一环节...', 'info');
      
      // 延迟一秒后自动提交
      setTimeout(function() {
        submitExaminations();
      }, 1000);
    }
  }

  function renderExaminationImagesForCard($card, images) {
    // images 为数组路径
    if (!images || images.length === 0) return;
    var html = '<div class="examination-images mt-3">';
    images.forEach(function(img) {
      html += '<img src="' + img + '" class="img-fluid mb-2 exam-image" style="max-height:220px; cursor:zoom-in;" data-src="' + img + '">';
    });
    html += '</div>';

    // 防止重复插入
    $card.find('.examination-images').remove();
    $card.find('.card-body').append(html);

    // 点击图片记录为已查看
    $card.find('.exam-image').on('click', function() {
      var src = $(this).data('src');
      if (clinicalSession.examination_images_viewed.indexOf(src) === -1) {
        clinicalSession.examination_images_viewed.push(src);
      }
      showImageModal(src);
    });
  }

  function showImageModal(src) {
    var modalHtml = '';
    modalHtml += '<div class="modal fade" id="examImageModal" tabindex="-1" role="dialog">';
    modalHtml += '<div class="modal-dialog modal-lg" role="document">';
    modalHtml += '<div class="modal-content">';
    modalHtml += '<div class="modal-body text-center">';
    modalHtml += '<img src="' + src + '" class="img-fluid">';
    modalHtml += '</div>';
    modalHtml += '<div class="modal-footer">';
    modalHtml += '<button type="button" class="btn btn-secondary" data-dismiss="modal">关闭</button>'; 
    modalHtml += '</div></div></div></div>';

    $('#examImageModal').remove();
    $('body').append(modalHtml);
    $('#examImageModal').modal('show');
  }
  
  function updateExaminationSummary() {
    var selectedCount = clinicalSession.selectedExaminations.length;
    var totalCost = 0;
    var highValueCount = 0;
    var riskLevels = [];
    
    $('.examination-checkbox:checked').each(function() {
      var $card = $(this).closest('.examination-option');
      var cost = parseInt($card.find('.examination-info').text().match(/¥(\d+)/)?.[1] || 0);
      totalCost += cost;
      
      if ($card.find('.badge-success').length > 0) {
        highValueCount++;
      }
      
      var riskText = $card.find('.examination-info').text();
      if (riskText.includes('高')) riskLevels.push('high');
      else if (riskText.includes('中')) riskLevels.push('medium');
      else riskLevels.push('low');
    });
    
    // 综合风险评估
    var overallRisk = 'low';
    if (riskLevels.includes('high')) overallRisk = 'high';
    else if (riskLevels.includes('medium')) overallRisk = 'medium';
    
    $('#selected-count').text(selectedCount);
    $('#total-cost').text('¥' + totalCost);
    $('#high-value-count').text(highValueCount);
    $('#risk-assessment').html(getRiskLevelDisplay(overallRisk));
  }
  
  function provideLiveExaminationFeedback() {
    var selectedCount = clinicalSession.selectedExaminations.length;
    var feedback = '';
    
    if (selectedCount === 0) {
      feedback = '<div class="alert alert-info">请开始选择检查项目</div>';
    } else if (selectedCount < 3) {
      feedback = '<div class="alert alert-warning">考虑是否需要更多检查来明确诊断</div>';
    } else if (selectedCount > 8) {
      feedback = '<div class="alert alert-danger">检查过多可能增加成本和患者负担</div>';
    } else {
      feedback = '<div class="alert alert-success">检查选择合理，请继续</div>';
    }
    
    $('#feedback-panel').html(feedback);
  }

  function submitExaminations() {
    // 验证必选检查是否被选中
    var requiredMissing = [];
    $('.examination-checkbox').each(function() {
      var isRequired = $(this).data('is-required') === 1 || $(this).data('is-required') === true;
      if (isRequired) {
        var id = parseInt($(this).val());
        if (clinicalSession.selectedExaminations.indexOf(id) === -1) {
          requiredMissing.push(id);
        }
      }
    });

    if (requiredMissing.length > 0) {
      showFeedbackMessage('存在必选检查未选择，请先完成必选检查', 'danger');
      return;
    }

    // 显示提交中状态
    $('#btn-next').prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i> 提交中...');
    showFeedbackMessage('正在提交检查选择...', 'info');

    // 准备提交数据
    var submitData = {
      case_id: clinicalSession.caseId,
      selected_examinations: clinicalSession.selectedExaminations,
      images_viewed: clinicalSession.examination_images_viewed
    };

    $.ajax({
      url: '/api/clinical/submit-examinations/',
      method: 'POST',
      contentType: 'application/json',
      headers: {
        'X-CSRFToken': $('[name=csrfmiddlewaretoken]').val() || getCsrfToken()
      },
      data: JSON.stringify(submitData),
      success: function(resp) {
        $('#btn-next').prop('disabled', false).html('下一步 <i class="fas fa-arrow-right"></i>');

        if (resp.success) {
          // 记录检查阶段完成
          addToLearningTimeline('完成检查选择', '选择了 ' + clinicalSession.selectedExaminations.length + ' 项检查');

          // 更新分数
          if (resp.data.examination_score !== undefined) {
            clinicalSession.scores.examination = resp.data.examination_score;
            $('#current-score').text(resp.data.examination_score.toFixed(1));
          }

          // 进入诊断阶段
          renderDiagnosisStage(resp.data);
          showFeedbackMessage('检查结果已获得，请开始诊断分析', 'success');
          // 视觉反馈
          flashCard($('#feedback-panel'), 'success');
          launchConfetti(25);
        } else {
          showFeedbackMessage('提交失败: ' + resp.message, 'danger');
        }
      },
      error: function(xhr, status, error) {
        $('#btn-next').prop('disabled', false).html('下一步 <i class="fas fa-arrow-right"></i>');
        console.error('Submit examination error:', error, xhr.responseText);

        if (xhr.status === 404) {
          showFeedbackMessage('API接口未找到，请检查后端配置', 'danger');
        } else if (xhr.status === 403) {
          showFeedbackMessage('权限不足，请重新登录', 'danger');
        } else if (xhr.status === 500) {
          showFeedbackMessage('服务器内部错误，请联系管理员', 'danger');
        } else {
          showFeedbackMessage('网络错误，请检查连接: ' + error, 'danger');
        }
      }
    });
  }

  
  // ==================== 诊断阶段：鉴别诊断推理 ====================
  
  function renderDiagnosisStage(data) {
    clinicalSession.currentStage = 'diagnosis';
    updateClinicalProgress();
    updateStageProgress();
    
    $('#btn-next').text('提交诊断选择 →').removeClass('btn-warning').addClass('btn-info');
    updateStageCard('诊断推理阶段', 'diagnosis');
    
    var html = '<div class="diagnosis-stage">';
    
    // 检查结果展示 - 小卡片形式
    html += '<div class="examination-results mb-4">';
    html += '<h5 class="text-primary mb-3"><i class="fas fa-microscope me-2"></i> 检查结果</h5>';
    
    if (data.examination_results && data.examination_results.length > 0) {
      html += '<div class="row g-3">';
      data.examination_results.forEach(function(result) {
        html += '<div class="col-12">';
        html += '<div class="exam-result-card">';
        
        // 检查项目头部
        html += '<div class="exam-header">';
        html += '<div class="d-flex align-items-center justify-content-between">';
        html += '<div class="exam-title">';
        html += '<i class="fas fa-eye text-primary me-2"></i>';
        html += '<span class="fw-bold text-dark">' + result.name + '</span>';
        html += '</div>';
        if (result.is_recommended) {
          html += '<span class="badge bg-success">推荐检查</span>';
        }
        html += '</div>';
        html += '</div>';
        
        // 检查结果内容
        html += '<div class="exam-content">';
        html += '<div class="result-label">检查结果</div>';
        html += '<div class="result-text">' + (result.result || '未记录') + '</div>';
        html += '</div>';
        
        html += '</div>';
        html += '</div>';
      });
      html += '</div>';
    } else {
      html += '<div class="alert alert-warning border-0 bg-warning bg-opacity-10">';
      html += '<i class="fas fa-exclamation-triangle text-warning me-2"></i>';
      html += '暂无检查结果数据';
      html += '</div>';
    }
    html += '</div>';
    
    // 诊断选项
    html += '<div class="diagnosis-options">';
    html += '<h4 class="text-info mb-4" style="font-weight: 700; display: flex; align-items: center;">';
    html += '<i class="fas fa-user-md me-2" style="font-size: 1.3rem; color: #17a2b8;"></i>鉴别诊断';
    html += '</h4>';
    html += '<div class="alert alert-info" style="background: linear-gradient(135deg, #d1ecf1 0%, #bee5eb 100%); border: none; border-radius: 12px; padding: 20px;">';
    html += '<h5 class="mb-3" style="color: #0c5460; font-weight: 700; display: flex; align-items: center;">';
    html += '<i class="fas fa-brain me-2" style="font-size: 1.2rem; color: #6f42c1;"></i>诊断思维指导';
    html += '</h5>';
    html += '<p class="mb-0" style="font-size: 1rem; line-height: 1.6; color: #0c5460;">综合患者病史和检查结果，进行鉴别诊断。仔细分析每个诊断的符合度，选择最可能的诊断选项。</p>';
    html += '</div>';
    
    // 如果后端没有诊断选项，创建基于案例的临床诊断选项
    var diagnosisOptions = data.diagnosis_options;
    if (!diagnosisOptions || diagnosisOptions.length === 0) {
      // 基于眼底出血病例的常见诊断选项
      diagnosisOptions = [
        {
          id: 1,
          name: '糖尿病视网膜病变',
          code: 'H36.0',
          description: '糖尿病引起的视网膜微血管病变，出现出血、渗出等',
          probability_score: 0.75,
          is_correct: false
        },
        {
          id: 2, 
          name: '高血压性视网膜病变',
          code: 'H35.0',
          description: '高血压引起的视网膜血管改变，可见出血、渗出',
          probability_score: 0.65,
          is_correct: false
        },
        {
          id: 3,
          name: '视网膜静脉阻塞',
          code: 'H34.8',
          description: '视网膜静脉血流受阻，导致视网膜出血和水肿',
          probability_score: 0.85,
          is_correct: true
        },
        {
          id: 4,
          name: 'Valsalva视网膜病变',
          code: 'H35.6',
          description: '用力过度引起的视网膜表层出血，多见于年轻人',
          probability_score: 0.90,
          is_correct: true
        },
        {
          id: 5,
          name: '外伤性视网膜病变',
          code: 'S05.8',
          description: '眼外伤导致的视网膜出血，需询问外伤史',
          probability_score: 0.45,
          is_correct: false
        }
      ];
    }
    
    if (diagnosisOptions && diagnosisOptions.length > 0) {
      html += '<form id="diagnosis-form">';
      diagnosisOptions.forEach(function(option) {
        html += '<div class="card diagnosis-option mb-3" data-diagnosis-id="' + option.id + '" style="border: 2px solid transparent; transition: all 0.3s ease;">';
        html += '<div class="card-body">';
        html += '<div class="form-check">';
        html += '<input class="form-check-input diagnosis-radio" type="radio" name="diagnosis" ';
        html += 'value="' + option.id + '" id="diag_' + option.id + '">';
        html += '<label class="form-check-label w-100" for="diag_' + option.id + '">';
        html += '<div class="d-flex justify-content-between align-items-start">';
        html += '<div class="flex-grow-1">';
        html += '<h6 class="mb-1" style="color: #2c3e50; font-weight: 600;">' + option.name + '</h6>';
        if (option.code) {
          html += '<small class="text-muted d-block mb-2"><i class="fas fa-code me-1"></i>ICD编码: ' + option.code + '</small>';
        }
        if (option.description) {
          html += '<p class="text-muted small mb-0" style="line-height: 1.4;">' + option.description + '</p>';
        }
        html += '</div>';
        if (option.probability_score !== undefined) {
          html += '<div class="diagnosis-probability ms-3">';
          var percentage = (option.probability_score * 100).toFixed(0);
          var badgeClass = percentage >= 80 ? 'badge-success' : percentage >= 60 ? 'badge-warning' : 'badge-secondary';
          html += '<span class="badge ' + badgeClass + '">符合度: ' + percentage + '%</span>';
          html += '</div>';
        }
        html += '</div>';
        html += '</label>';
        html += '</div>';
        html += '</div>';
        html += '</div>';
      });
      html += '</form>';
    } else {
      html += '<div class="alert alert-warning">暂无诊断选项数据</div>';
    }
    
    html += '</div>';
    html += '</div>';
    
    $('#stage-content').html(html);
    
    // 绑定诊断选择事件
    bindDiagnosisEvents();
    showClinicalThinkingPrompt('diagnosis');
  }
  
  function bindDiagnosisEvents() {
    $('.diagnosis-radio').on('change', function() {
      var diagnosisId = parseInt($(this).val());
      var $card = $(this).closest('.diagnosis-option');
      
      // 移除其他选中状态
      $('.diagnosis-option').removeClass('selected');
      
      // 设置当前选中
      $card.addClass('selected');
      clinicalSession.selectedDiagnosis = diagnosisId;
      
      // 记录选择
      var diagnosisName = $(this).siblings('label').find('h6').text();
      addToLearningTimeline('选择诊断', diagnosisName);
      
      // 提供即时反馈
      showFeedbackMessage('已选择诊断：' + diagnosisName, 'info');
    });
    
    $('.diagnosis-option').on('click', function(e) {
      if (e.target.type !== 'radio') {
        var radio = $(this).find('.diagnosis-radio');
        radio.prop('checked', true).trigger('change');
      }
    });
  }
  
  // ==================== 工具函数 ====================
  
  function getCsrfToken() {
    // 尝试从cookie获取CSRF token
    var cookieValue = null;
    if (document.cookie && document.cookie !== '') {
      var cookies = document.cookie.split(';');
      for (var i = 0; i < cookies.length; i++) {
        var cookie = cookies[i].trim();
        if (cookie.substring(0, 10) === 'csrftoken=') {
          cookieValue = decodeURIComponent(cookie.substring(10));
          break;
        }
      }
    }
    return cookieValue;
  }

  function submitDiagnosis() {
    // 显示提交中状态
    $('#btn-next').prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i> 提交中...');
    showFeedbackMessage('正在提交诊断选择...', 'info');
    
    // 准备提交数据
    var submitData = {
      case_id: clinicalSession.caseId,
      selected_diagnosis_id: clinicalSession.selectedDiagnosis,
      reasoning: $('#clinical-notes').val() || ''
    };
    
    $.ajax({
      url: '/api/clinical/submit-diagnosis/',
      method: 'POST',
      contentType: 'application/json',
      headers: {
        'X-CSRFToken': $('[name=csrfmiddlewaretoken]').val() || getCsrfToken()
      },
      data: JSON.stringify(submitData),
      success: function(resp) {
        $('#btn-next').prop('disabled', false).html('下一步 <i class="fas fa-arrow-right"></i>');
        
        if (resp.success) {
          // 记录诊断阶段完成
          var selectedDiagName = $('.diagnosis-option.selected').find('h6').text();
          addToLearningTimeline('提交诊断', selectedDiagName);
          
          // 更新分数
          if (resp.data.diagnosis_score !== undefined) {
            clinicalSession.scores.diagnosis = resp.data.diagnosis_score;
            $('#current-score').text(resp.data.diagnosis_score.toFixed(1));
          }
          
          // 显示诊断反馈
          if (resp.data.diagnosis_feedback) {
            showFeedbackMessage(resp.data.diagnosis_feedback, 'success');
          }
          
          // 进入治疗阶段
          renderTreatmentStage(resp.data);
          // 视觉反馈
          flashCard($('#feedback-panel'), 'success');
          launchConfetti(20);
        } else {
          showFeedbackMessage('提交失败: ' + resp.message, 'danger');
        }
      },
      error: function(xhr, status, error) {
        $('#btn-next').prop('disabled', false).html('下一步 <i class="fas fa-arrow-right"></i>');
        console.error('Submit diagnosis error:', error, xhr.responseText);
        
        if (xhr.status === 404) {
          showFeedbackMessage('API接口未找到，请检查后端配置', 'danger');
        } else if (xhr.status === 403) {
          showFeedbackMessage('权限不足，请重新登录', 'danger');
        } else if (xhr.status === 500) {
          showFeedbackMessage('服务器内部错误，请联系管理员', 'danger');
        } else {
          showFeedbackMessage('网络错误，请检查连接: ' + error, 'danger');
        }
      }
    });
  }

  
  // ==================== 治疗阶段：治疗决策 ====================
  
  function renderTreatmentStage(data) {
    clinicalSession.currentStage = 'treatment';
    
    // 清空治疗选择数据，避免历史数据污染
    clinicalSession.selectedTreatments = [];
    
    updateClinicalProgress();
    updateStageProgress();
    
    $('#btn-next').text('提交治疗方案 →').removeClass('btn-info').addClass('btn-success');
    updateStageCard('治疗决策阶段', 'treatment');
    
    var html = '<div class="treatment-stage">';
    
    // 诊断确认展示
    if (data.selected_diagnosis) {
      html += '<div class="diagnosis-confirmation mb-4">';
      html += '<h5 class="text-success"><i class="fas fa-check-circle"></i> 确认诊断</h5>';
      html += '<div class="card border-success">';
      html += '<div class="card-body">';
      html += '<h6>' + data.selected_diagnosis.name + '</h6>';
      if (data.selected_diagnosis.code) {
        html += '<small class="text-muted">ICD编码: ' + data.selected_diagnosis.code + '</small><br>';
      }
      if (data.selected_diagnosis.is_correct) {
        html += '<span class="badge badge-success">诊断正确</span>';
      } else {
        html += '<span class="badge badge-warning">需要进一步确认</span>';
      }
      html += '</div>';
      html += '</div>';
      html += '</div>';
    }
    
    // 治疗方案选择
    html += '<div class="treatment-options">';
    html += '<h5 class="text-success"><i class="fas fa-prescription-bottle-alt"></i> 治疗方案选择</h5>';
    html += '<div class="alert alert-success">';
    html += '<h6><i class="fas fa-medkit"></i> 治疗决策指导</h6>';
    html += '<p class="mb-0">基于确定的诊断，选择合适的治疗方案。考虑治疗的有效性、安全性、成本效益和患者个体情况。</p>';
    html += '</div>';
    
    if (data.treatment_options && data.treatment_options.length > 0) {
      html += '<form id="treatment-form">';
      
      // 按治疗类型分组
      var groupedTreatments = groupTreatmentsByType(data.treatment_options);
      
      Object.keys(groupedTreatments).forEach(function(type) {
        var typeOptions = groupedTreatments[type];
        var typeDisplayName = getTreatmentTypeDisplay(type);
        var typeIcon = getTreatmentTypeIcon(type);
        
        html += '<div class="treatment-group mb-4">';
        html += '<h6 class="text-primary mb-3">';
        html += '<i class="' + typeIcon + '"></i> ' + typeDisplayName;
        html += '<small class="text-muted ml-2">(' + typeOptions.length + '项)</small>';
        html += '</h6>';
        
        html += '<div class="row">';
        typeOptions.forEach(function(option) {
          html += '<div class="col-md-6 mb-3">';
          html += '<div class="card treatment-option h-100';
          
          // 根据治疗适宜性添加样式类
          if (option.is_optimal) {
            html += ' optimal';
          } else if (option.is_contraindicated) {
            html += ' contraindicated';
          } else if (option.is_acceptable) {
            html += ' acceptable';
          }
          
          html += '" data-treatment-id="' + option.id + '">';
          html += '<div class="card-body">';
          
          html += '<div class="form-check">';
          html += '<input class="form-check-input treatment-checkbox" type="checkbox" ';
          html += 'value="' + option.id + '" id="treat_' + option.id + '">';
          html += '<label class="form-check-label w-100" for="treat_' + option.id + '">';
          html += '<div class="d-flex justify-content-between align-items-start">';
          html += '<strong>' + option.name + '</strong>';
          
          // 显示治疗特性标签
          html += '<div class="treatment-badges">';
          if (option.is_optimal) {
            html += '<span class="badge badge-success">最佳</span>';
          }
          if (option.is_contraindicated) {
            html += '<span class="badge badge-danger">禁忌</span>';
          }
          if (option.efficacy_score === 'high') {
            html += '<span class="badge badge-info">高效</span>';
          }
          html += '</div>';
          
          html += '</div>';
          html += '<div class="text-muted small mt-2">' + (option.description || '') + '</div>';
          
          // 显示疗效和安全性信息
          html += '<div class="treatment-info mt-2">';
          html += '<div class="row small text-muted">';
          html += '<div class="col-4">疗效: ' + (option.efficacy_score || '中') + '</div>';
          html += '<div class="col-4">安全: ' + (option.safety_score || '中') + '</div>';
          html += '<div class="col-4">成本: ' + (option.cost_score || '中') + '</div>';
          html += '</div>';
          html += '</div>';
          
          // 预期结果
          if (option.expected_outcome) {
            html += '<div class="expected-outcome mt-2">';
            html += '<small class="text-info"><i class="fas fa-bullseye"></i> ' + option.expected_outcome + '</small>';
          }
          
          html += '</label>';
          html += '</div>';
          html += '</div>';
          html += '</div>';
          html += '</div>';
        });
        html += '</div>';
        html += '</div>';
      });
      
      html += '</form>';
    } else {
      html += '<div class="alert alert-warning">暂无治疗方案数据</div>';
    }
    
    html += '</div>';
    
    // 添加治疗方案选择统计 - 改进排版
    html += '<div class="treatment-summary mt-4">';
    html += '<div class="card bg-light border-0 shadow-sm">';
    html += '<div class="card-body p-4">';
    html += '<h6 class="mb-3"><i class="fas fa-chart-pie text-primary me-2"></i> 治疗方案分析</h6>';
    
    // 使用更好的网格布局
    html += '<div class="row g-3">';
    
    // 已选方案
    html += '<div class="col-6 col-md-3">';
    html += '<div class="text-center p-3 bg-white rounded border">';
    html += '<div class="h4 mb-1 text-primary" id="selected-treatments-count">0</div>';
    html += '<small class="text-muted fw-500">已选方案</small>';
    html += '</div>';
    html += '</div>';
    
    // 最佳方案
    html += '<div class="col-6 col-md-3">';
    html += '<div class="text-center p-3 bg-white rounded border">';
    html += '<div class="h4 mb-1 text-success" id="optimal-treatments-count">0</div>';
    html += '<small class="text-muted fw-500">最佳方案</small>';
    html += '</div>';
    html += '</div>';
    
    // 综合疗效
    html += '<div class="col-6 col-md-3">';
    html += '<div class="text-center p-3 bg-white rounded border">';
    html += '<div class="h4 mb-1 text-warning" id="treatment-efficacy">--</div>';
    html += '<small class="text-muted fw-500">综合疗效</small>';
    html += '</div>';
    html += '</div>';
    
    // 安全评级
    html += '<div class="col-6 col-md-3">';
    html += '<div class="text-center p-3 bg-white rounded border">';
    html += '<div class="h4 mb-1 text-info" id="treatment-safety">--</div>';
    html += '<small class="text-muted fw-500">安全评级</small>';
    html += '</div>';
    html += '</div>';
    
    html += '</div>'; // row结束
    html += '</div>';
    html += '</div>';
    html += '</div>';
    
    html += '</div>';
    
    $('#stage-content').html(html);
    
    // 绑定治疗选择事件
    bindTreatmentEvents();
    showClinicalThinkingPrompt('treatment');
  }
  
  function groupTreatmentsByType(options) {
    var grouped = {};
    options.forEach(function(option) {
      var type = option.type || 'medication';
      if (!grouped[type]) {
        grouped[type] = [];
      }
      grouped[type].push(option);
    });
    return grouped;
  }
  
  function getTreatmentTypeDisplay(type) {
    var displays = {
      'medication': '药物治疗',
      'surgery': '手术治疗',
      'observation': '观察随访',
      'referral': '转诊治疗',
      'education': '健康教育'
    };
    return displays[type] || type;
  }
  
  function getTreatmentTypeIcon(type) {
    var icons = {
      'medication': 'fas fa-pills',
      'surgery': 'fas fa-scalpel-path',
      'observation': 'fas fa-eye',
      'referral': 'fas fa-hospital',
      'education': 'fas fa-graduation-cap'
    };
    return icons[type] || 'fas fa-medical-kit';
  }
  
  function bindTreatmentEvents() {
    $('.treatment-checkbox').on('change', function() {
      var $card = $(this).closest('.treatment-option');
      var treatmentId = parseInt($(this).val());
      
      if ($(this).is(':checked')) {
        $card.addClass('selected');
        clinicalSession.selectedTreatments.push(treatmentId);
        addToLearningTimeline('选择治疗', $(this).siblings('label').find('strong').text());
      } else {
        $card.removeClass('selected');
        var index = clinicalSession.selectedTreatments.indexOf(treatmentId);
        if (index > -1) {
          clinicalSession.selectedTreatments.splice(index, 1);
        }
      }
      
      updateTreatmentSummary();
      provideLiveTreatmentFeedback();
    });
    
    $('.treatment-option').on('click', function(e) {
      if (e.target.type !== 'checkbox') {
        var checkbox = $(this).find('.treatment-checkbox');
        checkbox.prop('checked', !checkbox.prop('checked')).trigger('change');
      }
    });
  }
  
  function updateTreatmentSummary() {
    // 直接从DOM获取实际选择状态，避免会话数据污染
    var $checkedTreatments = $('.treatment-checkbox:checked');
    var selectedCount = $checkedTreatments.length;
    var optimalCount = 0;
    var efficacyScores = [];
    var safetyScores = [];
    
    // 同时更新会话数据以保持一致性
    clinicalSession.selectedTreatments = [];
    
    $checkedTreatments.each(function() {
      var treatmentId = $(this).val();
      var $card = $(this).closest('.treatment-option');
      
      // 更新会话数据
      clinicalSession.selectedTreatments.push(parseInt(treatmentId));
      
      if ($card.find('.badge-success').length > 0) {
        optimalCount++;
      }
      
      // 简单的评分逻辑
      var efficacyText = $card.find('.treatment-info').text();
      if (efficacyText.includes('疗效: 高')) efficacyScores.push(3);
      else if (efficacyText.includes('疗效: 中')) efficacyScores.push(2);
      else efficacyScores.push(1);
      
      if (efficacyText.includes('安全: 高')) safetyScores.push(3);
      else if (efficacyText.includes('安全: 中')) safetyScores.push(2);
      else safetyScores.push(1);
    });
    
    // 计算平均疗效和安全性
    var avgEfficacy = efficacyScores.length > 0 ? efficacyScores.reduce((a, b) => a + b, 0) / efficacyScores.length : 0;
    var avgSafety = safetyScores.length > 0 ? safetyScores.reduce((a, b) => a + b, 0) / safetyScores.length : 0;
    
    var efficacyLevel = avgEfficacy >= 2.5 ? '高' : avgEfficacy >= 1.5 ? '中' : '低';
    var safetyLevel = avgSafety >= 2.5 ? '高' : avgSafety >= 1.5 ? '中' : '低';
    
    $('#selected-treatments-count').text(selectedCount);
    $('#optimal-treatments-count').text(optimalCount);
    $('#treatment-efficacy').text(efficacyLevel);
    $('#treatment-safety').text(safetyLevel);
  }
  
  function provideLiveTreatmentFeedback() {
    var selectedCount = clinicalSession.selectedTreatments.length;
    var feedback = '';
    
    if (selectedCount === 0) {
      feedback = '<div class="alert alert-info">请开始选择治疗方案</div>';
    } else if (selectedCount === 1) {
      feedback = '<div class="alert alert-warning">考虑是否需要联合治疗</div>';
    } else if (selectedCount > 5) {
      feedback = '<div class="alert alert-danger">治疗方案过多可能增加副作用风险</div>';
    } else {
      feedback = '<div class="alert alert-success">治疗方案选择合理</div>';
    }
    
    $('#feedback-panel').html(feedback);
  }

  function submitTreatments() {
    // 显示提交中状态
    $('#btn-next').prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i> 提交中...');
    showFeedbackMessage('正在提交治疗方案...', 'info');
    
    // 准备提交数据
    var submitData = {
      case_id: clinicalSession.caseId,
      selected_treatments: clinicalSession.selectedTreatments,
      reasoning: $('#clinical-notes').val() || ''
    };
    
    $.ajax({
      url: '/api/clinical/submit-treatments/',
      method: 'POST',
      contentType: 'application/json',
      headers: {
        'X-CSRFToken': $('[name=csrfmiddlewaretoken]').val() || getCsrfToken()
      },
      data: JSON.stringify(submitData),
      success: function(resp) {
        $('#btn-next').prop('disabled', false).html('完成学习 <i class="fas fa-check"></i>');
        
        if (resp.success) {
          // 记录治疗阶段完成
          addToLearningTimeline('完成治疗选择', '选择了 ' + clinicalSession.selectedTreatments.length + ' 种治疗方案');
          
          // 更新分数
          if (resp.data.treatment_score !== undefined) {
            clinicalSession.scores.treatment = resp.data.treatment_score;
          }
          
          // 计算总分
          if (resp.data.scores && resp.data.scores.overall_score !== undefined) {
            clinicalSession.scores.overall = resp.data.scores.overall_score;
            $('#current-score').text(resp.data.scores.overall_score.toFixed(1));
          }
          
          // 进入反馈阶段
          clinicalSession.currentStage = 'feedback';
          updateClinicalProgress();
          showFinalFeedback(resp.data);
          // 视觉与动画反馈
          flashCard($('#stage-content'), 'success');
          launchConfetti(40);
        } else {
          showFeedbackMessage('提交失败: ' + resp.message, 'danger');
        }
      },
      error: function(xhr, status, error) {
        $('#btn-next').prop('disabled', false).html('下一步 <i class="fas fa-arrow-right"></i>');
        console.error('Submit treatment error:', error, xhr.responseText);
        
        if (xhr.status === 404) {
          showFeedbackMessage('API接口未找到，请检查后端配置', 'danger');
        } else if (xhr.status === 403) {
          showFeedbackMessage('权限不足，请重新登录', 'danger');
        } else if (xhr.status === 500) {
          showFeedbackMessage('服务器内部错误，请联系管理员', 'danger');
        } else {
          showFeedbackMessage('网络错误，请检查连接: ' + error, 'danger');
        }
      }
    });
  }

  function showFinalFeedback(data) {
    clinicalSession.currentStage = 'feedback';
    updateClinicalProgress();
    updateStageProgress();
    
    updateStageCard('学习完成', 'complete');
    
    // 显示最终反馈
    var feedbackHtml = '<div class="alert alert-success feedback-animation">';
    feedbackHtml += '<h6><i class="fas fa-trophy"></i> 学习完成！</h6>';
    feedbackHtml += (data.overall_feedback || '恭喜您完成了本次临床推理学习！');
    feedbackHtml += '</div>';
    $('#feedback-panel').html(feedbackHtml);
    
    // 构建最终学习总结页面
    var html = '<div class="final-feedback text-center">';
    
    // 标题
    html += '<div class="completion-header mb-4">';
    html += '<h3 class="text-success"><i class="fas fa-graduation-cap"></i> 临床推理学习完成</h3>';
    html += '<p class="text-muted">您已成功完成本案例的完整临床推理过程</p>';
    html += '</div>';
    
    // 成绩展示
    html += '<div class="row mb-4">';
    
    // 总体得分
    html += '<div class="col-md-6 offset-md-3">';
    html += '<div class="card border-success">';
    html += '<div class="card-body text-center">';
    html += '<h4 class="text-success">总体得分</h4>';
    var overallScore = (data.scores && data.scores.overall_score) ? data.scores.overall_score : clinicalSession.scores.overall;
    html += '<div class="display-3 text-primary font-weight-bold">' + (overallScore ? overallScore.toFixed(1) : '0.0') + '</div>';
    html += '<p class="text-muted">满分 100 分</p>';
    
    // 评级
    var grade = 'A';
    var gradeColor = 'success';
    if (overallScore < 60) {
      grade = 'D'; gradeColor = 'danger';
    } else if (overallScore < 70) {
      grade = 'C'; gradeColor = 'warning';
    } else if (overallScore < 85) {
      grade = 'B'; gradeColor = 'info';
    }
    html += '<h5><span class="badge badge-' + gradeColor + ' p-2">' + grade + ' 级</span></h5>';
    html += '</div>';
    html += '</div>';
    html += '</div>';
    html += '</div>';
    
    // 分项得分
    html += '<div class="row mb-4">';
    html += '<div class="col-md-12">';
    html += '<div class="card">';
    html += '<div class="card-body">';
    html += '<h5 class="card-title"><i class="fas fa-chart-bar"></i> 分项成绩</h5>';
    html += '<div class="row text-center">';
    
    html += '<div class="col-4">';
    html += '<div class="score-item">';
    html += '<div class="h4 text-warning">' + (clinicalSession.scores.examination || 0).toFixed(1) + '</div>';
    html += '<small class="text-muted">检查选择 (30%)</small>';
    html += '</div>';
    html += '</div>';
    
    html += '<div class="col-4">';
    html += '<div class="score-item">';
    html += '<div class="h4 text-info">' + (clinicalSession.scores.diagnosis || 0).toFixed(1) + '</div>';
    html += '<small class="text-muted">诊断准确性 (50%)</small>';
    html += '</div>';
    html += '</div>';
    
    html += '<div class="col-4">';
    html += '<div class="score-item">';
    html += '<div class="h4 text-success">' + (clinicalSession.scores.treatment || 0).toFixed(1) + '</div>';
    html += '<small class="text-muted">治疗方案 (20%)</small>';
    html += '</div>';
    html += '</div>';
    
    html += '</div>';
    html += '</div>';
    html += '</div>';
    html += '</div>';
    html += '</div>';
    
    // 学习总结
    if (data.overall_feedback || data.improvement_suggestions) {
      html += '<div class="row mb-4">';
      html += '<div class="col-md-12">';
      html += '<div class="card">';
      html += '<div class="card-body text-left">';
      html += '<h5 class="card-title"><i class="fas fa-lightbulb"></i> 学习总结</h5>';
      if (data.overall_feedback) {
        html += '<p>' + data.overall_feedback + '</p>';
      }
      if (data.improvement_suggestions) {
        html += '<h6 class="text-primary">改进建议：</h6>';
        html += '<p>' + data.improvement_suggestions + '</p>';
      }
      html += '</div>';
      html += '</div>';
      html += '</div>';
      html += '</div>';
    }
    
    // 操作按钮 - 撑满整行并居中
    html += '<div class="action-buttons mt-4">';
    html += '<div class="d-flex justify-content-center align-items-center">';
    html += '<div class="d-flex w-100" style="max-width: 600px;">';
    html += '<button class="btn btn-outline-primary flex-fill mx-2" onclick="location.reload()">';
    html += '<i class="fas fa-redo"></i> 重新学习';
    html += '</button>';
    html += '<a href="/student/clinical-cases/" class="btn btn-outline-secondary flex-fill mx-2">';
    html += '<i class="fas fa-list"></i> 返回案例列表';
    html += '</a>';
    html += '<a href="/student/" class="btn btn-outline-success flex-fill mx-2">';
    html += '<i class="fas fa-home"></i> 返回首页';
    html += '</a>';
    html += '</div>';
    html += '</div>';
    html += '</div>';
    
    html += '</div>';
    
    $('#stage-content').html(html);
    
    // 完全重构导航卡片以显示完成状态
    var completionNavHtml = '<div class="card-body">';
    completionNavHtml += '<div class="text-center">';
    completionNavHtml += '<div style="padding: 20px; background: linear-gradient(135deg, #d4edda, #c3e6cb); border-radius: 10px; border: 2px solid #28a745; box-shadow: 0 4px 8px rgba(40, 167, 69, 0.2);">';
    completionNavHtml += '<i class="fas fa-check-circle text-success me-2" style="font-size: 1.2em;"></i>';
    completionNavHtml += '<span class="text-success fw-bold" style="font-size: 1.1em;">临床推理进度已经完成</span>';
    completionNavHtml += '<div class="mt-3">';
    completionNavHtml += '<div style="width: 350px; height: 15px; background-color: #e9ecef; border-radius: 10px; margin: 0 auto; overflow: hidden; border: 1px solid #28a745;">';
    completionNavHtml += '<div style="width: 100%; height: 100%; background: linear-gradient(90deg, #28a745, #20c997); border-radius: 10px; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 0.8em;">';
    completionNavHtml += '100%';
    completionNavHtml += '</div>';
    completionNavHtml += '</div>';
    completionNavHtml += '<small class="text-success mt-2 d-block fw-bold">学习完成</small>';
    completionNavHtml += '</div>';
    completionNavHtml += '</div>';
    completionNavHtml += '</div>';
    completionNavHtml += '</div>';
    
    $('#navigation-card').html(completionNavHtml);
    
    // 清除保存的进度
    localStorage.removeItem('clinical_progress_' + clinicalSession.caseId);
    
    // 记录完成时间
    clinicalSession.timeSpent.total = new Date() - clinicalSession.startTime;
    addToLearningTimeline('完成学习', '总用时: ' + Math.floor(clinicalSession.timeSpent.total / 60000) + ' 分钟');
  }

  // ==================== 动画与视觉效果 ====================
  
  // 简单 confetti 效果（无外部库，轻量）
  function launchConfetti(count) {
    count = count || 30;
    for (var i = 0; i < count; i++) {
      (function() {
        var conf = document.createElement('div');
        conf.className = 'confetti-piece';
        var size = Math.floor(Math.random() * 8) + 6;
        conf.style.width = size + 'px';
        conf.style.height = (size * 0.6) + 'px';
        conf.style.background = ['#28a745','#007bff','#ffc107','#dc3545','#6610f2'][Math.floor(Math.random() * 5)];
        conf.style.position = 'fixed';
        conf.style.zIndex = 9999;
        conf.style.left = (Math.random() * window.innerWidth) + 'px';
        conf.style.top = '-20px';
        conf.style.opacity = Math.random() * 0.9 + 0.1;
        conf.style.transform = 'rotate(' + (Math.random() * 360) + 'deg)';
        conf.style.pointerEvents = 'none';
        document.body.appendChild(conf);
        var endY = window.innerHeight + 100 + Math.random() * 200;
        var duration = 1000 + Math.random() * 1200;
        conf.animate([
          { transform: conf.style.transform + ' translateY(0px)', opacity: conf.style.opacity },
          { transform: conf.style.transform + ' translateY(' + endY + 'px)', opacity: 0.6 }
        ], { duration: duration, easing: 'cubic-bezier(.2,.8,.2,1)' });
        setTimeout(function() { conf.remove(); }, duration + 200);
      })();
    }
  }

  // 卡片高亮跳动，用于强调成功/错误
  function flashCard($el, type) {
    var cls = (type === 'success') ? 'flash-success' : 'flash-warning';
    $el.addClass(cls);
    setTimeout(function() { $el.removeClass(cls); }, 900);
  }

  // 步骤闪光（短暂放大、光晕）
  function highlightStep(stepName) {
    var $step = $('.stepper-item[data-step="' + stepName + '"]');
    $step.addClass('step-highlight');
    setTimeout(function() { $step.removeClass('step-highlight'); }, 800);
  }


  
  // ==================== 通用功能函数 ====================
  
  function showClinicalThinkingPrompt(stage) {
    var prompts = {
      'history': '思考：患者的症状特点是什么？可能的病因有哪些？需要重点关注什么？',
      'examination': '思考：基于病史，哪些检查最有助于明确诊断？如何平衡诊断价值和成本？',
      'diagnosis': '思考：检查结果支持哪些诊断？如何进行鉴别诊断？概率最高的是什么？',
      'treatment': '思考：针对确定的诊断，最佳治疗方案是什么？如何评估风险获益比？',
      'feedback': '思考：回顾整个诊疗过程，有哪些值得总结的经验？'
    };
    
    if (prompts[stage]) {
      showFeedbackMessage(prompts[stage], 'guidance');
    }
  }
  
  function showFeedbackMessage(message, type = 'info') {
    var alertClass = {
      'info': 'alert-info',
      'success': 'alert-success feedback-positive',
      'warning': 'alert-warning feedback-corrective', 
      'danger': 'alert-danger',
      'guidance': 'alert-info feedback-guidance'
    }[type] || 'alert-info';
    
    var icon = {
      'info': 'fas fa-info-circle',
      'success': 'fas fa-check-circle',
      'warning': 'fas fa-exclamation-triangle',
      'danger': 'fas fa-times-circle',
      'guidance': 'fas fa-lightbulb'
    }[type] || 'fas fa-info-circle';
    
    var html = '<div class="alert ' + alertClass + ' feedback-animation">';
    html += '<i class="' + icon + '"></i> ' + message;
    html += '</div>';
    
    $('#feedback-panel').html(html);
    
    // 记录反馈历史
    clinicalSession.feedbackHistory.push({
      timestamp: new Date(),
      stage: clinicalSession.currentStage,
      message: message,
      type: type
    });
  }
  
  function showErrorMessage(message) {
    showFeedbackMessage('错误：' + message, 'danger');
  }
  
  function addToLearningTimeline(action, detail) {
    var timestamp = new Date().toLocaleTimeString();
    var html = '<div class="timeline-item">';
    html += '<div class="d-flex justify-content-between">';
    html += '<strong>' + action + '</strong>';
    html += '<small class="text-muted">' + timestamp + '</small>';
    html += '</div>';
    html += '<div class="text-muted small">' + detail + '</div>';
    html += '</div>';
    
    $('#learning-timeline').prepend(html);
    
    // 保持最多显示10条记录
    var items = $('#learning-timeline .timeline-item');
    if (items.length > 10) {
      items.slice(10).remove();
    }
  }
  
  function updateTimeSpent() {
    var now = new Date();
    var elapsed = Math.floor((now - clinicalSession.startTime) / 1000); // 秒
    var minutes = Math.floor(elapsed / 60);
    var seconds = elapsed % 60;
    
    var timeStr = String(minutes).padStart(2, '0') + ':' + String(seconds).padStart(2, '0');
    $('#time-spent').text(timeStr);
  }
  
  function updateStageProgress() {
    var stages = clinicalSession.stages;
    var currentIndex = stages.indexOf(clinicalSession.currentStage);
    var progress = Math.round(((currentIndex + 1) / stages.length) * 100);
    
    // 使用统一的进度更新函数
    updateNavigationProgress();
    $('#current-stage-text').text(getStageDisplayName(clinicalSession.currentStage));
  }
  
  function getStageDisplayName(stage) {
    var names = {
      'history': '病史采集',
      'examination': '检查选择',
      'diagnosis': '诊断推理',
      'treatment': '治疗决策',
      'feedback': '学习反馈'
    };
    return names[stage] || stage;
  }
  
  function saveCurrentProgress() {
    // 保存当前学习进度到本地存储
    var progressData = {
      caseId: clinicalSession.caseId,
      stage: clinicalSession.currentStage,
      selectedExaminations: clinicalSession.selectedExaminations,
      selectedDiagnosis: clinicalSession.selectedDiagnosis,
      selectedTreatments: clinicalSession.selectedTreatments,
      notes: $('#clinical-notes').val(),
      timestamp: new Date().toISOString()
    };
    
    localStorage.setItem('clinical_progress_' + clinicalSession.caseId, JSON.stringify(progressData));
  }
  
  function loadSavedProgress() {
    // 尝试加载之前保存的进度
    var saved = localStorage.getItem('clinical_progress_' + clinicalSession.caseId);
    if (saved) {
      try {
        var progressData = JSON.parse(saved);
        // 如果是当天的进度，则恢复
        var savedTime = new Date(progressData.timestamp);
        var now = new Date();
        if (now.toDateString() === savedTime.toDateString()) {
          return progressData;
        }
      } catch (e) {
        console.log('Failed to load saved progress:', e);
      }
    }
    return null;
  }
  
  // ==================== 主程序入口和事件绑定 ====================
  
  // 更新阶段卡片样式和内容
  function updateStageCard(stageName, stageKey) {
    const stageConfig = {
      'history': {
        text: '病史采集阶段',
        icon: 'fas fa-clipboard-list',
        textColor: 'text-success',
        cardClass: 'stage-history'
      },
      'examination': {
        text: '检查选择阶段', 
        icon: 'fas fa-stethoscope',
        textColor: 'text-warning',
        cardClass: 'stage-examination'
      },
      'diagnosis': {
        text: '诊断推理阶段',
        icon: 'fas fa-brain',
        textColor: 'text-purple',
        cardClass: 'stage-diagnosis'
      },
      'treatment': {
        text: '治疗决策阶段',
        icon: 'fas fa-pills',
        textColor: 'text-info',
        cardClass: 'stage-treatment'
      },
      'complete': {
        text: '学习完成',
        icon: 'fas fa-check-circle',
        textColor: 'text-success',
        cardClass: 'stage-complete'
      }
    };
    
    const config = stageConfig[stageKey] || stageConfig['history'];
    const $stageBadge = $('#current-stage-badge');
    const $stageCard = $stageBadge.closest('.stage-info-card');
    
    // 更新文字和图标
    $stageBadge.text(config.text)
              .removeClass()
              .addClass('fw-bold ' + config.textColor)
              .css('font-size', '0.9rem');
    
    // 更新卡片样式
    $stageCard.removeClass('stage-history stage-examination stage-diagnosis stage-treatment stage-complete')
              .addClass(config.cardClass);
    
    // 更新图标
    $stageCard.find('i').removeClass().addClass(config.icon + ' me-2').css('font-size', '0.9em');
    
    // 更新图标颜色
    const iconColorClass = config.textColor.replace('text-', '');
    if (iconColorClass === 'purple') {
      $stageCard.find('i').removeClass().addClass(config.icon + ' me-2').css({'font-size': '0.9em', 'color': '#9c27b0'});
    } else {
      $stageCard.find('i').removeClass().addClass(config.icon + ' ' + config.textColor + ' me-2').css('font-size', '0.9em');
    }
  }

  // 进度条更新函数
  function updateNavigationProgress() {
    const stageMapping = {
      'history': 1,
      'examination': 2, 
      'diagnosis': 3,
      'treatment': 4,
      'feedback': 4
    };
    
    const totalSteps = 4;
    const currentStepNum = stageMapping[clinicalSession.currentStage] || 1;
    const progressPercent = Math.round((currentStepNum / totalSteps) * 100);
    
    // 更新进度条
    const progressBar = document.getElementById('overall-progress');
    if (progressBar) {
      progressBar.style.width = progressPercent + '%';
      progressBar.textContent = progressPercent + '%';
      progressBar.setAttribute('aria-valuenow', progressPercent);
      
      // 根据进度调整颜色
      let gradient;
      if (progressPercent <= 25) {
        gradient = 'linear-gradient(90deg, #dc3545, #c82333)'; // 红色
      } else if (progressPercent <= 50) {
        gradient = 'linear-gradient(90deg, #ffc107, #e0a800)'; // 黄色
      } else if (progressPercent <= 75) {
        gradient = 'linear-gradient(90deg, #007bff, #0056b3)'; // 蓝色
      } else {
        gradient = 'linear-gradient(90deg, #28a745, #20c997)'; // 绿色
      }
      progressBar.style.background = gradient;
    }
    
    // 更新进度文本
    const progressText = document.getElementById('progress-text');
    if (progressText) {
      progressText.textContent = `步骤 ${currentStepNum}/${totalSteps} (${progressPercent}%)`;
    }
  }
  
  $(document).ready(function() {
    // 初始化时间显示更新
    setInterval(updateTimeSpent, 1000);
    
    // 清空可能的历史进度数据，避免污染
    localStorage.removeItem('clinical_progress_' + clinicalSession.caseId);
    
    // 确保会话数据干净初始化
    clinicalSession.selectedExaminations = [];
    clinicalSession.selectedTreatments = [];
    clinicalSession.selectedDiagnosis = null;
    
    // 尝试恢复之前的学习进度（已禁用，避免数据污染）
    /*
    var savedProgress = loadSavedProgress();
    if (savedProgress && confirm('检测到之前的学习进度，是否继续之前的学习？')) {
      // 恢复进度逻辑
      clinicalSession.currentStage = savedProgress.stage;
      clinicalSession.selectedExaminations = savedProgress.selectedExaminations || [];
      clinicalSession.selectedDiagnosis = savedProgress.selectedDiagnosis;
      clinicalSession.selectedTreatments = savedProgress.selectedTreatments || [];
      $('#clinical-notes').val(savedProgress.notes || '');
    }
    */
    
    // 开始病史阶段
    initializeHistoryStage();
    
    // 初始化进度显示
    updateNavigationProgress();
    
    // 绑定导航按钮事件
    $('#btn-next').on('click', function() {
      handleNextStage();
    });

    $('#btn-prev').on('click', function() {
      handlePreviousStage();
    });
    
    // 绑定临床笔记自动保存
    $('#clinical-notes').on('input', function() {
      clearTimeout(window.notesSaveTimeout);
      window.notesSaveTimeout = setTimeout(saveCurrentProgress, 2000);
    });
    
    // 页面离开时保存进度
    $(window).on('beforeunload', function() {
      saveCurrentProgress();
    });
  });
  
  function handleNextStage() {
    var currentStage = clinicalSession.currentStage;
    
    switch (currentStage) {
      case 'history':
        // 记录病史阶段用时
        clinicalSession.timeSpent.history = new Date() - clinicalSession.timeSpent.history;
        loadExaminationStage();
        break;
        
      case 'examination':
        if (clinicalSession.selectedExaminations.length === 0) {
          showFeedbackMessage('请至少选择一项检查', 'warning');
          return;
        }
        submitExaminations();
        break;
        
      case 'diagnosis':
        if (!clinicalSession.selectedDiagnosis) {
          showFeedbackMessage('请选择一个诊断', 'warning');
          return;
        }
        submitDiagnosis();
        break;
        
      case 'treatment':
        if (clinicalSession.selectedTreatments.length === 0) {
          showFeedbackMessage('请选择至少一种治疗方案', 'warning');
          return;
        }
        submitTreatments();
        break;
        
      default:
        showFeedbackMessage('当前阶段无法继续', 'warning');
    }
    
    // 更新导航进度
    updateNavigationProgress();
  }
  
  function handlePreviousStage() {
    var currentStage = clinicalSession.currentStage;
    var stages = clinicalSession.stages;
    var currentIndex = stages.indexOf(currentStage);
    
    if (currentIndex > 0) {
      var previousStage = stages[currentIndex - 1];
      
      // 简单的返回逻辑 - 实际应用中可能需要更复杂的状态恢复
      if (previousStage === 'history') {
        initializeHistoryStage();
      } else if (previousStage === 'examination') {
        loadExaminationStage();
      }
      // 可以继续添加其他阶段的返回逻辑
    }
    
    // 更新导航进度
    updateNavigationProgress();
  }
  
  // 这里省略了submitExaminationChoices, submitDiagnosisChoice, submitTreatmentChoices等函数
  // 这些函数会调用实际的API，并处理服务器响应
  // 由于篇幅限制，保持原有的简化API调用逻辑
  
})();
</script>
{% endblock %}