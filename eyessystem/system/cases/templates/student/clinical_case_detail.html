{% extends 'base.html' %}
{% load static %}

{% block title %}ä¸´åºŠæ¨ç† - {{ clinical_case.title }}{% endblock %}

{% block content %}
{% csrf_token %}
<div class="container-fluid mt-4">
  <!-- ä¸´åºŠæ¨ç†ç³»ç»Ÿæ ‡é¢˜ -->
  <div class="row mb-4">
    <div class="col-12 text-center">
      <h2 class="text-primary">
        <i class="fas fa-user-md"></i> ä¸´åºŠæ¨ç†å­¦ä¹ ç³»ç»Ÿ
        <small class="text-muted d-block mt-2">åŸºäºçœŸå®æ¡ˆä¾‹çš„ä¸´åºŠæ€ç»´è®­ç»ƒ</small>
      </h2>
    </div>
  </div>
  
  <!-- ä¸´åºŠæŒ‡å¯¼æç¤ºåŒºåŸŸ -->
  <div class="row mb-3">
    <div class="col-12">
      <div id="clinical-guidance">
        <!-- åŠ¨æ€ä¸´åºŠæŒ‡å¯¼å†…å®¹ -->
      </div>
    </div>
  </div>
  
  <!-- æ­¥éª¤è¿›åº¦æ¡ -->
  <div class="row mb-4">
    <div class="col-12">
      <div class="progress-stepper">
        <div class="stepper-items">
          <div class="stepper-item active" data-step="history">
            <div class="stepper-icon">1</div>
            <div class="stepper-title">ç—…å²é‡‡é›†</div>
          </div>
          <div class="stepper-item" data-step="examination">
            <div class="stepper-icon">2</div>
            <div class="stepper-title">æ£€æŸ¥é€‰æ‹©</div>
          </div>
          <div class="stepper-item" data-step="diagnosis">
            <div class="stepper-icon">3</div>
            <div class="stepper-title">è¯Šæ–­æ¨ç†</div>
          </div>
          <div class="stepper-item" data-step="treatment">
            <div class="stepper-icon">4</div>
            <div class="stepper-title">æ²»ç–—æ–¹æ¡ˆ</div>
          </div>
          <div class="stepper-item" data-step="feedback">
            <div class="stepper-icon">5</div>
            <div class="stepper-title">å­¦ä¹ åé¦ˆ</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="row">
    <!-- ä¸»è¦å­¦ä¹ å†…å®¹åŒºåŸŸ -->
    <div class="col-lg-8">
      <div class="card mb-3 shadow-sm">
        <div class="card-header bg-light">
          <div class="d-flex justify-content-between align-items-center">
            <h5 class="mb-0" id="case-title">{{ clinical_case.title }}</h5>
            <div class="badge badge-info" id="current-stage-badge">ç—…å²é‡‡é›†é˜¶æ®µ</div>
          </div>
          <p class="text-muted mb-0 mt-2" id="patient-info">
            <i class="fas fa-user"></i> {{ clinical_case.patient_age }}å² - {{ clinical_case.get_patient_gender_display }}
          </p>
        </div>
        <div class="card-body">
          <div id="stage-content">
            <div class="text-center p-5">
              <i class="fas fa-spinner fa-spin fa-2x text-primary"></i>
              <p class="mt-3">æ­£åœ¨åŠ è½½ä¸´åºŠæ¡ˆä¾‹æ•°æ®...</p>
            </div>
          </div>
        </div>
      </div>

      <!-- å¯¼èˆªæ§åˆ¶é¢æ¿ -->
      <div class="card" id="navigation-card">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-center">
            <button class="btn btn-outline-secondary" id="btn-prev" disabled>
              <i class="fas fa-arrow-left"></i> ä¸Šä¸€æ­¥
            </button>
            <div class="text-center">
              <small class="text-muted">ä¸´åºŠæ¨ç†è¿›åº¦</small>
              <div class="progress mt-1" style="width: 200px;">
                <div id="overall-progress" class="progress-bar bg-success" role="progressbar" style="width: 20%"></div>
              </div>
            </div>
            <button class="btn btn-primary" id="btn-next">
              ä¸‹ä¸€æ­¥ <i class="fas fa-arrow-right"></i>
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- ä¾§è¾¹å·¥å…·å’Œåé¦ˆåŒºåŸŸ -->
    <div class="col-lg-4">
      <!-- ä¸´åºŠè®°å½•é¢æ¿ -->
      <div class="card mb-3 border-primary">
        <div class="card-header bg-primary text-white">
          <h6 class="mb-0"><i class="fas fa-clipboard"></i> ä¸´åºŠè®°å½•</h6>
        </div>
        <div class="card-body">
          <div class="nav nav-pills mb-3" id="clinical-tabs" role="tablist">
            <a class="nav-item nav-link active" id="notes-tab" data-toggle="pill" href="#notes-panel" role="tab">ç¬”è®°</a>
            <a class="nav-item nav-link" id="timeline-tab" data-toggle="pill" href="#timeline-panel" role="tab">æ—¶é—´çº¿</a>
          </div>
          <div class="tab-content">
            <div class="tab-pane fade show active" id="notes-panel">
              <textarea id="clinical-notes" class="form-control" rows="5" placeholder="è®°å½•ä¸´åºŠæ€è€ƒè¿‡ç¨‹ã€é‰´åˆ«è¯Šæ–­è¦ç‚¹..."></textarea>
              <small class="text-muted mt-2 d-block">
                <i class="fas fa-lightbulb"></i> è®°å½•æ€ç»´è¿‡ç¨‹æœ‰åŠ©äºä¸´åºŠèƒ½åŠ›æå‡
              </small>
            </div>
            <div class="tab-pane fade" id="timeline-panel">
              <div id="learning-timeline">
                <small class="text-muted">å­¦ä¹ è¿›ç¨‹å°†åœ¨æ­¤æ˜¾ç¤º</small>
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <!-- å®æ—¶åé¦ˆé¢æ¿ -->
      <div class="card mb-3">
        <div class="card-header bg-success text-white">
          <h6 class="mb-0"><i class="fas fa-comments"></i> æ™ºèƒ½æŒ‡å¯¼</h6>
        </div>
        <div class="card-body" id="feedback-panel">
          <div class="text-center text-muted">
            <i class="fas fa-robot fa-2x mb-2"></i>
            <p class="mb-0">AIåŠ©æ•™å°†ä¸ºæ‚¨æä¾›å®æ—¶æŒ‡å¯¼</p>
          </div>
        </div>
      </div>
      
      <!-- å­¦ä¹ ç»Ÿè®¡é¢æ¿ -->
      <div class="card">
        <div class="card-header">
          <h6 class="mb-0"><i class="fas fa-chart-line"></i> å­¦ä¹ ç»Ÿè®¡</h6>
        </div>
        <div class="card-body">
          <div id="learning-stats">
            <div class="row text-center">
              <div class="col-6">
                <div class="border-right">
                  <div class="h4 mb-0" id="time-spent">00:00</div>
                  <small class="text-muted">ç”¨æ—¶</small>
                </div>
              </div>
              <div class="col-6">
                <div class="h4 mb-0" id="current-score">--</div>
                <small class="text-muted">å½“å‰å¾—åˆ†</small>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
/* ==================== ä¸´åºŠæ¨ç†ç³»ç»Ÿæ ·å¼ ==================== */

/* è¿›åº¦æŒ‡ç¤ºå™¨æ ·å¼ä¼˜åŒ– */
.progress-stepper {
  display: flex;
  justify-content: center;
  margin-bottom: 2rem;
  padding: 1rem;
  background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
  border-radius: 15px;
}

.stepper-items {
  display: flex;
  align-items: center;
  justify-content: space-between;
  width: 100%;
  max-width: 700px;
}

.stepper-item {
  display: flex;
  flex-direction: column;
  align-items: center;
  text-align: center;
  flex: 1;
  position: relative;
  transition: all 0.3s ease;
}

.stepper-item:not(:last-child)::after {
  content: '';
  position: absolute;
  top: 20px;
  left: 60%;
  width: 80%;
  height: 3px;
  background: linear-gradient(90deg, #dee2e6 0%, #ced4da 100%);
  z-index: 1;
  border-radius: 2px;
}

.stepper-item.active::after {
  background: linear-gradient(90deg, #007bff 0%, #0056b3 100%);
  box-shadow: 0 2px 4px rgba(0, 123, 255, 0.3);
}

.stepper-item.completed::after {
  background: linear-gradient(90deg, #28a745 0%, #1e7e34 100%);
  box-shadow: 0 2px 4px rgba(40, 167, 69, 0.3);
}

.stepper-icon {
  width: 45px;
  height: 45px;
  border-radius: 50%;
  background: linear-gradient(135deg, #e9ecef 0%, #ced4da 100%);
  color: #6c757d;
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: bold;
  font-size: 1.1rem;
  margin-bottom: 8px;
  position: relative;
  z-index: 2;
  border: 3px solid #fff;
  box-shadow: 0 4px 8px rgba(0,0,0,0.1);
  transition: all 0.3s ease;
}

.stepper-item.active .stepper-icon {
  background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
  color: white;
  transform: scale(1.1);
  box-shadow: 0 6px 12px rgba(0, 123, 255, 0.4);
  animation: pulse 2s infinite;
}

.stepper-item.completed .stepper-icon {
  background: linear-gradient(135deg, #28a745 0%, #1e7e34 100%);
  color: white;
  box-shadow: 0 4px 8px rgba(40, 167, 69, 0.3);
}

.stepper-item.thinking .stepper-icon {
  animation: thinking 1.5s ease-in-out infinite;
}

@keyframes pulse {
  0% { box-shadow: 0 6px 12px rgba(0, 123, 255, 0.4); }
  50% { box-shadow: 0 8px 16px rgba(0, 123, 255, 0.6); }
  100% { box-shadow: 0 6px 12px rgba(0, 123, 255, 0.4); }
}

@keyframes thinking {
  0%, 100% { transform: scale(1.1); }
  50% { transform: scale(1.05); }
}

.stepper-title {
  font-size: 0.9rem;
  color: #6c757d;
  margin-top: 4px;
  font-weight: 500;
  transition: all 0.3s ease;
}

.stepper-item.active .stepper-title {
  color: #007bff;
  font-weight: 600;
  transform: translateY(-2px);
}

.stepper-item.completed .stepper-title {
  color: #28a745;
  font-weight: 600;
}

/* ä¸´åºŠæŒ‡å¯¼åŒºåŸŸæ ·å¼ */
.clinical-guidance {
  border-left: 4px solid #007bff;
  background: linear-gradient(135deg, #f8f9ff 0%, #e6f3ff 100%);
  animation: slideIn 0.5s ease-out;
}

@keyframes slideIn {
  from { opacity: 0; transform: translateY(-10px); }
  to { opacity: 1; transform: translateY(0); }
}

.clinical-tips ul {
  list-style: none;
  padding-left: 0;
}

.clinical-tips li {
  position: relative;
  padding-left: 20px;
  margin-bottom: 5px;
}

.clinical-tips li::before {
  content: 'ğŸ’¡';
  position: absolute;
  left: 0;
  top: 0;
}

/* ç—…å²åˆ†æå·¥å…·æ ·å¼ */
.clinical-analysis-tools {
  background: #f8f9fa;
  border-radius: 8px;
  border: 1px solid #e9ecef;
}

.symptom-tags .badge {
  margin: 2px;
  font-size: 0.85rem;
  padding: 0.4em 0.8em;
}

.timeline-info {
  background: white;
  padding: 10px;
  border-radius: 5px;
  border-left: 3px solid #007bff;
}

/* æ£€æŸ¥é€‰é¡¹æ ·å¼å¢å¼º */
.examination-option {
  transition: all 0.3s ease;
  cursor: pointer;
}

.examination-option:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(0,0,0,0.1);
}

.examination-option.selected {
  border-color: #007bff;
  background-color: #f8f9ff;
}

.examination-option .form-check-input:checked + .form-check-label {
  color: #007bff;
  font-weight: 600;
}

/* è¯Šæ–­é€‰é¡¹æ ·å¼ */
.diagnosis-option {
  border: 2px solid transparent;
  transition: all 0.3s ease;
  cursor: pointer;
}

.diagnosis-option:hover {
  border-color: #007bff;
  background-color: #f8f9ff;
}

.diagnosis-option.selected {
  border-color: #007bff;
  background-color: #e6f3ff;
}

/* æ²»ç–—æ–¹æ¡ˆæ ·å¼ */
.treatment-option {
  border-left: 4px solid #dee2e6;
  transition: all 0.3s ease;
}

.treatment-option.optimal {
  border-left-color: #28a745;
}

.treatment-option.acceptable {
  border-left-color: #ffc107;
}

.treatment-option.contraindicated {
  border-left-color: #dc3545;
  background-color: #fff5f5;
}

/* å­¦ä¹ ç»Ÿè®¡é¢æ¿ */
.learning-stats .h4 {
  font-family: 'Courier New', monospace;
  font-weight: bold;
}

/* æ—¶é—´çº¿æ ·å¼ */
.learning-timeline {
  max-height: 200px;
  overflow-y: auto;
}

.timeline-item {
  border-left: 2px solid #e9ecef;
  padding-left: 15px;
  margin-bottom: 10px;
  position: relative;
}

.timeline-item::before {
  content: '';
  position: absolute;
  left: -5px;
  top: 5px;
  width: 8px;
  height: 8px;
  background: #007bff;
  border-radius: 50%;
}

/* å“åº”å¼è®¾è®¡ */
@media (max-width: 768px) {
  .stepper-items {
    flex-direction: column;
    align-items: stretch;
  }
  
  .stepper-item {
    margin-bottom: 20px;
    flex-direction: row;
    justify-content: flex-start;
    text-align: left;
  }
  
  .stepper-item::after {
    display: none;
  }
  
  .stepper-icon {
    margin-right: 15px;
    margin-bottom: 0;
  }
}

/* åé¦ˆé¢æ¿åŠ¨ç”» */
.feedback-animation {
  animation: fadeInUp 0.5s ease-out;
}

@keyframes fadeInUp {
  from {
    opacity: 0;
    transform: translateY(20px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

/* æˆåŠŸåé¦ˆæ ·å¼ */
.feedback-positive {
  border-left: 4px solid #28a745;
  background-color: #d4edda;
}

.feedback-corrective {
  border-left: 4px solid #ffc107;
  background-color: #fff3cd;
}

.feedback-guidance {
  border-left: 4px solid #17a2b8;
  background-color: #d1ecf1;
}

/* åŠ¨ç”»æ•ˆæœæ ·å¼ */
.confetti-piece {
  border-radius: 2px;
  box-shadow: 0 1px 2px rgba(0,0,0,0.15);
}

.flash-success {
  animation: flashSuccess 0.9s ease-in-out;
}

.flash-warning {
  animation: flashWarning 0.9s ease-in-out;
}

@keyframes flashSuccess {
  0% { transform: scale(1); box-shadow: 0 0 0 rgba(40,167,69,0); }
  30% { transform: scale(1.04); box-shadow: 0 10px 30px rgba(40,167,69,0.18); }
  100% { transform: scale(1); box-shadow: 0 0 0 rgba(40,167,69,0); }
}

@keyframes flashWarning {
  0% { transform: scale(1); box-shadow: 0 0 0 rgba(255,193,7,0); }
  30% { transform: scale(1.04); box-shadow: 0 10px 30px rgba(255,193,7,0.18); }
  100% { transform: scale(1); box-shadow: 0 0 0 rgba(255,193,7,0); }
}

.step-highlight {
  animation: stepPulse 0.8s ease-out;
}

@keyframes stepPulse {
  0% { transform: scale(1); box-shadow: 0 0 0 rgba(0,123,255,0); }
  50% { transform: scale(1.08); box-shadow: 0 10px 30px rgba(0,123,255,0.22); }
  100% { transform: scale(1); box-shadow: 0 0 0 rgba(0,123,255,0); }
}
</style>
{% endblock %}

{% block extra_js %}
<script>
// ä¸´åºŠæ¨ç†æ•™å­¦ç³»ç»Ÿ - é‡æ–°è®¾è®¡çš„äº¤äº’é€»è¾‘
// ä½œä¸ºåŒ»ç–—æ•™è‚²å·¥ç¨‹å¸ˆï¼Œæˆ‘è®¾è®¡äº†ä¸€ä¸ªæ›´è´´è¿‘çœŸå®ä¸´åºŠæ€ç»´çš„å­¦ä¹ ç³»ç»Ÿ

(function() {
  // ==================== æ ¸å¿ƒçŠ¶æ€ç®¡ç† ====================
  var clinicalSession = {
    caseId: '{{ clinical_case.case_id }}',
    currentStage: 'history',
    stages: ['history', 'examination', 'diagnosis', 'treatment', 'feedback'],
    
    // ä¸´åºŠæ•°æ®æ”¶é›†
    selectedExaminations: [],
    examinationResults: [],
    clinicalFindings: {},
    
    // è¯Šæ–­æ¨ç†
    diagnosticHypotheses: [],
    selectedDiagnosis: null,
    differentialAnalysis: {},
    
    // æ²»ç–—å†³ç­–
    selectedTreatments: [],
    treatmentRationale: '',
    
    // å­¦ä¹ è¯„ä¼°
    scores: {
      examination: 0,
      diagnosis: 0,
      treatment: 0,
      overall: 0,
      clinicalThinking: 0
    },
    
    // æ—¶é—´è·Ÿè¸ª
    timeSpent: {},
    startTime: new Date(),
    
    // æ•™å­¦åé¦ˆ
    feedbackHistory: [],
    clinicalMistakes: [],
    learningInsights: []
  };

  // ==================== åŒ»å­¦æ•™è‚²æ ¸å¿ƒåŠŸèƒ½ ====================
  
  function updateClinicalProgress() {
    // æ›´æ–°å¯è§†åŒ–è¿›åº¦æŒ‡ç¤ºå™¨
    $('.stepper-item').removeClass('active completed thinking');
    var currentIndex = clinicalSession.stages.indexOf(clinicalSession.currentStage);
    
    for (var i = 0; i <= currentIndex; i++) {
      var $step = $('.stepper-item[data-step="' + clinicalSession.stages[i] + '"]');
      if (i === currentIndex) {
        $step.addClass('active thinking');
        // æ·»åŠ æ€è€ƒåŠ¨ç”»æ•ˆæœ
        $step.find('.stepper-icon').html('<i class="fas fa-brain fa-pulse"></i>');
      } else {
        $step.addClass('completed');
        $step.find('.stepper-icon').html('<i class="fas fa-check"></i>');
      }
    }
    // é«˜äº®å½“å‰æ­¥éª¤ä¸€æ¬¡
    highlightStep(clinicalSession.currentStage);
    
    // æ›´æ–°é˜¶æ®µæç¤º
    updateStageGuidance();
  }
  
  function updateStageGuidance() {
    var guidance = {
      'history': {
        title: 'ğŸ“‹ ç—…å²é‡‡é›†é˜¶æ®µ',
        instruction: 'ä»”ç»†é˜…è¯»æ‚£è€…çš„ä¸»è¯‰å’Œç—…å²ä¿¡æ¯ï¼Œè¿™æ˜¯ä¸´åºŠæ¨ç†çš„åŸºç¡€ã€‚æ€è€ƒï¼šæ‚£è€…çš„ä¸»è¦é—®é¢˜æ˜¯ä»€ä¹ˆï¼Ÿå¯èƒ½çš„ç—…å› æœ‰å“ªäº›ï¼Ÿ',
        tips: ['æ³¨æ„ç—‡çŠ¶çš„æ—¶é—´é¡ºåº', 'å…³æ³¨æ—¢å¾€å²çš„ç›¸å…³æ€§', 'æ€è€ƒç—‡çŠ¶çš„ä¸¥é‡ç¨‹åº¦']
      },
      'examination': {
        title: 'ğŸ” ä¸´åºŠæ£€æŸ¥é˜¶æ®µ', 
        instruction: 'åŸºäºç—…å²åˆ†æï¼Œé€‰æ‹©æœ€æœ‰ä»·å€¼çš„æ£€æŸ¥é¡¹ç›®ã€‚è®°ä½ï¼šåˆç†çš„æ£€æŸ¥é€‰æ‹©ä½“ç°ä¸´åºŠæ€ç»´èƒ½åŠ›ã€‚',
        tips: ['ä¼˜å…ˆé€‰æ‹©æ€§ä»·æ¯”é«˜çš„æ£€æŸ¥', 'é¿å…è¿‡åº¦æ£€æŸ¥', 'è€ƒè™‘æ£€æŸ¥çš„è¯Šæ–­ä»·å€¼']
      },
      'diagnosis': {
        title: 'ğŸ¯ è¯Šæ–­æ¨ç†é˜¶æ®µ',
        instruction: 'ç»¼åˆç—…å²å’Œæ£€æŸ¥ç»“æœï¼Œè¿›è¡Œé‰´åˆ«è¯Šæ–­ã€‚æ€è€ƒå„ç§å¯èƒ½æ€§çš„æ¦‚ç‡ï¼Œé€‰æ‹©æœ€å¯èƒ½çš„è¯Šæ–­ã€‚',
        tips: ['åˆ—å‡ºé‰´åˆ«è¯Šæ–­', 'åˆ†ææ”¯æŒå’Œåå¯¹è¯æ®', 'è€ƒè™‘ç–¾ç—…çš„æµè¡Œç—…å­¦ç‰¹ç‚¹']
      },
      'treatment': {
        title: 'ğŸ’Š æ²»ç–—å†³ç­–é˜¶æ®µ',
        instruction: 'åŸºäºç¡®å®šçš„è¯Šæ–­ï¼Œåˆ¶å®šåˆç†çš„æ²»ç–—æ–¹æ¡ˆã€‚è€ƒè™‘æ²»ç–—çš„æœ‰æ•ˆæ€§ã€å®‰å…¨æ€§å’Œæˆæœ¬æ•ˆç›Šã€‚',
        tips: ['ä¸ªä½“åŒ–æ²»ç–—æ–¹æ¡ˆ', 'è€ƒè™‘æ‚£è€…æ‰¿å—èƒ½åŠ›', 'æƒè¡¡è·ç›Šå’Œé£é™©']
      },
      'feedback': {
        title: 'ğŸ“š å­¦ä¹ æ€»ç»“é˜¶æ®µ',
        instruction: 'å›é¡¾æ•´ä¸ªä¸´åºŠæ¨ç†è¿‡ç¨‹ï¼Œæ€»ç»“å­¦ä¹ è¦ç‚¹å’Œæ”¹è¿›æ–¹å‘ã€‚',
        tips: ['åæ€å†³ç­–è¿‡ç¨‹', 'å·©å›ºå…³é”®çŸ¥è¯†ç‚¹', 'åˆ¶å®šå­¦ä¹ è®¡åˆ’']
      }
    };
    
    var current = guidance[clinicalSession.currentStage];
    if (current) {
      var html = '<div class="clinical-guidance card mb-3">';
      html += '<div class="card-body">';
      html += '<h6 class="card-title text-primary">' + current.title + '</h6>';
      html += '<p class="card-text">' + current.instruction + '</p>';
      html += '<div class="clinical-tips">';
      html += '<small class="text-muted"><strong>ä¸´åºŠæ€ç»´è¦ç‚¹ï¼š</strong></small>';
      html += '<ul class="small text-muted mb-0">';
      current.tips.forEach(function(tip) {
        html += '<li>' + tip + '</li>';
      });
      html += '</ul>';
      html += '</div>';
      html += '</div>';
      html += '</div>';
      
      $('#clinical-guidance').html(html);
    }
  }

  
  // ==================== ç—…å²é˜¶æ®µï¼šå»ºç«‹ä¸´åºŠå°è±¡ ====================
  
  function initializeHistoryStage() {
    clinicalSession.currentStage = 'history';
    updateClinicalProgress();
    
    // è®°å½•å¼€å§‹æ—¶é—´
    clinicalSession.timeSpent.history = new Date();
    
    $('#btn-prev').prop('disabled', true);
    $('#btn-next').text('å¼€å§‹æ£€æŸ¥é€‰æ‹© â†’').removeClass('btn-secondary').addClass('btn-primary');
    
    $.getJSON('/api/clinical/case/' + clinicalSession.caseId + '/', function(resp) {
      if (resp.success) {
        window.caseData = resp.data;
        renderPatientHistory(resp.data);
        
        // æ·»åŠ ä¸´åºŠæ€è€ƒæç¤º
        showClinicalThinkingPrompt('history');
      } else {
        showErrorMessage('åŠ è½½ç—…å²ä¿¡æ¯å¤±è´¥: ' + resp.message);
      }
    }).fail(function() {
      showErrorMessage('ç½‘ç»œé”™è¯¯ï¼Œè¯·æ£€æŸ¥è¿æ¥åé‡è¯•');
    });
  }
  
  function renderPatientHistory(data) {
    var html = '<div class="patient-history">';
    
    // æ‚£è€…åŸºæœ¬ä¿¡æ¯å¡ç‰‡
    html += '<div class="card mb-3 border-primary">';
    html += '<div class="card-header bg-primary text-white">';
    html += '<h6 class="mb-0"><i class="fas fa-user-injured"></i> æ‚£è€…åŸºæœ¬ä¿¡æ¯</h6>';
    html += '</div>';
    html += '<div class="card-body">';
    html += '<div class="row">';
    html += '<div class="col-md-6">';
    html += '<p><strong>å¹´é¾„ï¼š</strong>' + (data.patient_info.age || 'æœªçŸ¥') + '</p>';
    html += '<p><strong>æ€§åˆ«ï¼š</strong>' + (data.patient_info.gender || 'æœªçŸ¥') + '</p>';
    html += '</div>';
    html += '<div class="col-md-6">';
    html += '<p><strong>ç—…ä¾‹ç¼–å·ï¼š</strong>' + data.case_id + '</p>';
    html += '</div>';
    html += '</div>';
    html += '</div>';
    html += '</div>';
    
    // ä¸»è¯‰
    html += '<div class="card mb-3">';
    html += '<div class="card-header bg-warning text-dark">';
    html += '<h6 class="mb-0"><i class="fas fa-exclamation-triangle"></i> ä¸»è¯‰ (Chief Complaint)</h6>';
    html += '</div>';
    html += '<div class="card-body">';
    html += '<div class="alert alert-warning mb-0">';
    html += '<p class="mb-0">' + (data.clinical_info.chief_complaint || 'æ— è®°å½•') + '</p>';
    html += '</div>';
    html += '</div>';
    html += '</div>';
    
    // ç°ç—…å²
    html += '<div class="card mb-3">';
    html += '<div class="card-header bg-info text-white">';
    html += '<h6 class="mb-0"><i class="fas fa-notes-medical"></i> ç°ç—…å² (History of Present Illness)</h6>';
    html += '</div>';
    html += '<div class="card-body">';
    html += '<div class="present-illness-content">';
    html += formatMedicalHistory(data.clinical_info.present_illness || 'æ— è®°å½•');
    html += '</div>';
    html += '</div>';
    html += '</div>';
    
    // æ—¢å¾€å²å’Œå®¶æ—å²ï¼ˆå¦‚æœæœ‰ï¼‰
    if (data.clinical_info.past_history || data.clinical_info.family_history) {
      html += '<div class="row">';
      if (data.clinical_info.past_history) {
        html += '<div class="col-md-6">';
        html += '<div class="card mb-3">';
        html += '<div class="card-header bg-secondary text-white">';
        html += '<h6 class="mb-0"><i class="fas fa-history"></i> æ—¢å¾€å²</h6>';
        html += '</div>';
        html += '<div class="card-body">';
        html += '<p>' + data.clinical_info.past_history + '</p>';
        html += '</div>';
        html += '</div>';
        html += '</div>';
      }
      
      if (data.clinical_info.family_history) {
        html += '<div class="col-md-6">';
        html += '<div class="card mb-3">';
        html += '<div class="card-header bg-secondary text-white">';
        html += '<h6 class="mb-0"><i class="fas fa-users"></i> å®¶æ—å²</h6>';
        html += '</div>';
        html += '<div class="card-body">';
        html += '<p>' + data.clinical_info.family_history + '</p>';
        html += '</div>';
        html += '</div>';
        html += '</div>';
      }
      html += '</div>';
    }
    
    html += '</div>';
    $('#stage-content').html(html);
    
    // æ·»åŠ ç—…å²åˆ†æå·¥å…·
    addHistoryAnalysisTools();
  }
  
  function formatMedicalHistory(text) {
    // æ ¼å¼åŒ–ç—…å²æ–‡æœ¬ï¼Œçªå‡ºå…³é”®ä¿¡æ¯
    return text.replace(/(\d+[å¤©æœˆå¹´])/g, '<span class="badge badge-secondary">$1</span>')
               .replace(/(ç–¼ç—›|ä¸é€‚|æ¨¡ç³Š|ä¸‹é™)/g, '<span class="text-danger"><strong>$1</strong></span>')
               .replace(/(æ— |å¦è®¤|æœªè§)/g, '<span class="text-success">$1</span>');
  }
  
  function addHistoryAnalysisTools() {
    var toolsHtml = '<div class="clinical-analysis-tools mt-3">';
    toolsHtml += '<div class="card">';
    toolsHtml += '<div class="card-header">';
    toolsHtml += '<h6 class="mb-0"><i class="fas fa-lightbulb"></i> ä¸´åºŠåˆ†æå·¥å…·</h6>';
    toolsHtml += '</div>';
    toolsHtml += '<div class="card-body">';
    toolsHtml += '<div class="row">';
    
    // ç—‡çŠ¶åˆ†æ
    toolsHtml += '<div class="col-md-4">';
    toolsHtml += '<h6>å…³é”®ç—‡çŠ¶</h6>';
    toolsHtml += '<div id="key-symptoms" class="symptom-tags"></div>';
    toolsHtml += '</div>';
    
    // æ—¶é—´è½´
    toolsHtml += '<div class="col-md-4">';
    toolsHtml += '<h6>ç—…ç¨‹æ—¶é—´</h6>';
    toolsHtml += '<div id="disease-timeline" class="timeline-info"></div>';
    toolsHtml += '</div>';
    
    // åˆæ­¥å°è±¡
    toolsHtml += '<div class="col-md-4">';
    toolsHtml += '<h6>åˆæ­¥ä¸´åºŠå°è±¡</h6>';
    toolsHtml += '<textarea id="clinical-impression" class="form-control" placeholder="è®°å½•æ‚¨çš„åˆæ­¥ä¸´åºŠå°è±¡..." rows="3"></textarea>';
    toolsHtml += '</div>';
    
    toolsHtml += '</div>';
    toolsHtml += '</div>';
    toolsHtml += '</div>';
    toolsHtml += '</div>';
    
    $('#stage-content').append(toolsHtml);
    
    // è‡ªåŠ¨æå–å…³é”®ç—‡çŠ¶
    extractKeySymptoms();
  }
  
  function extractKeySymptoms() {
    // ç®€å•çš„ç—‡çŠ¶æå–é€»è¾‘
    var symptoms = ['è§†åŠ›ä¸‹é™', 'çœ¼ç—›', 'å¤´ç—›', 'æ¶å¿ƒ', 'å‘•å', 'è§†é‡ç¼ºæŸ', 'çœ¼å‹é«˜', 'å……è¡€'];
    var content = $('#stage-content').text();
    var foundSymptoms = [];
    
    symptoms.forEach(function(symptom) {
      if (content.includes(symptom)) {
        foundSymptoms.push(symptom);
      }
    });
    
    if (foundSymptoms.length > 0) {
      var html = foundSymptoms.map(function(symptom) {
        return '<span class="badge badge-warning mr-1 mb-1">' + symptom + '</span>';
      }).join('');
      $('#key-symptoms').html(html);
    } else {
      $('#key-symptoms').html('<small class="text-muted">æœªè¯†åˆ«åˆ°æ˜æ˜¾ç—‡çŠ¶</small>');
    }
  }

  
  // ==================== æ£€æŸ¥é˜¶æ®µï¼šå¾ªè¯åŒ»å­¦æŒ‡å¯¼ ====================
  
  function loadExaminationStage() {
    clinicalSession.currentStage = 'examination';
    updateClinicalProgress();
    updateStageProgress();
    
    $('#btn-prev').prop('disabled', false);
    $('#btn-next').text('æäº¤æ£€æŸ¥é€‰æ‹© â†’').removeClass('btn-secondary').addClass('btn-warning');
    $('#current-stage-badge').text('æ£€æŸ¥é€‰æ‹©é˜¶æ®µ').removeClass().addClass('badge badge-warning');
    
    $.getJSON('/api/clinical/case/' + clinicalSession.caseId + '/examinations/', function(resp) {
      if (resp.success) {
        renderExaminationOptions(resp.data.examination_options || []);
        addExaminationGuidance();
        showClinicalThinkingPrompt('examination');
      } else {
        showErrorMessage('åŠ è½½æ£€æŸ¥é€‰é¡¹å¤±è´¥: ' + resp.message);
      }
    }).fail(function() {
      showErrorMessage('ç½‘ç»œé”™è¯¯ï¼Œè¯·æ£€æŸ¥è¿æ¥åé‡è¯•');
    });
  }
  
  function renderExaminationOptions(options) {
    var html = '<div class="examination-selection">';
    
    // æ£€æŸ¥é€‰æ‹©è¯´æ˜
    html += '<div class="alert alert-info">';
    html += '<h6><i class="fas fa-lightbulb"></i> æ£€æŸ¥é€‰æ‹©æŒ‡å¯¼</h6>';
    html += '<p class="mb-0">åŸºäºæ‚£è€…ç—…å²ï¼Œé€‰æ‹©æœ€æœ‰ä»·å€¼çš„æ£€æŸ¥é¡¹ç›®ã€‚è€ƒè™‘è¯Šæ–­ä»·å€¼ã€æˆæœ¬æ•ˆç›Šå’Œæ‚£è€…å®‰å…¨ã€‚</p>';
    html += '</div>';
    
    // æŒ‰ç±»å‹åˆ†ç»„æ˜¾ç¤ºæ£€æŸ¥é€‰é¡¹
    var groupedOptions = groupExaminationsByType(options);
    
    Object.keys(groupedOptions).forEach(function(type) {
  var typeOptions = groupedOptions[type];
      var typeDisplayName = getExaminationTypeDisplay(type);
      var typeIcon = getExaminationTypeIcon(type);
      
      html += '<div class="examination-group mb-4">';
      html += '<h6 class="text-primary mb-3">';
      html += '<i class="' + typeIcon + '"></i> ' + typeDisplayName;
      html += '<small class="text-muted ml-2">(' + typeOptions.length + 'é¡¹)</small>';
      html += '</h6>';
      
      html += '<div class="row">';
      typeOptions.forEach(function(option) {
        // encode images array as JSON string for data attribute
        var imagesAttr = (option.images && option.images.length) ? JSON.stringify(option.images) : '[]';
        var isRequiredAttr = option.is_required ? 1 : 0;
        var allowMultipleAttr = option.is_multiple_choice ? 1 : 0;
        html += '<div class="col-md-6 mb-3">';
        html += '<div class="card examination-option h-100" data-exam-id="' + option.id + '" data-images=\'' + imagesAttr + '\' data-is-required="' + isRequiredAttr + '" data-allow-multiple="' + allowMultipleAttr + '">';
        html += '<div class="card-body">';
        
        html += '<div class="form-check">';
  // è‹¥åç«¯æ ‡æ³¨äº†å¤šé€‰å…è®¸æˆ–å¿…é€‰ï¼ˆåç«¯ may not provide theseâ€”use defaults if absentï¼‰
  var inputType = option.is_multiple_choice ? 'checkbox' : 'checkbox'; // frontend will validate single/multi via option.allow_multiple if provided
  html += '<input class="form-check-input examination-checkbox" type="' + inputType + '" ';
  html += 'value="' + option.id + '" id="exam_' + option.id + '" data-is-recommended="' + (option.is_recommended ? '1' : '0') + '" data-is-fundus="' + ((option.type && option.type.toLowerCase().indexOf('çœ¼åº•') !== -1) ? '1' : '0') + '" data-is-required="' + isRequiredAttr + '" data-allow-multiple="' + allowMultipleAttr + '">';
        html += '<label class="form-check-label w-100" for="exam_' + option.id + '">';
        html += '<div class="d-flex justify-content-between align-items-start">';
        html += '<strong>' + option.name + '</strong>';
        
        // æ˜¾ç¤ºæ£€æŸ¥ç‰¹æ€§æ ‡ç­¾
        html += '<div class="examination-badges">';
        // ä½¿ç”¨åç«¯è¿”å›çš„å­—æ®µå±•ç¤ºæ ‡ç­¾
        if (option.is_recommended) {
          html += '<span class="badge badge-success">æ¨è</span>';
        }
        if (option.diagnostic_value && option.diagnostic_value.toLowerCase().indexOf('é«˜') !== -1) {
          html += '<span class="badge badge-success">é«˜ä»·å€¼</span>';
        }
        html += '</div>';
        
        html += '</div>';
        html += '<div class="text-muted small mt-2">' + (option.description || '') + '</div>';
        
        // æ˜¾ç¤ºé£é™©å’Œæˆæœ¬ä¿¡æ¯
  // æ£€æŸ¥é¢å¤–ä¿¡æ¯ï¼ˆåç«¯å¯èƒ½æ²¡æœ‰é£é™©/è´¹ç”¨å­—æ®µï¼Œä½œå…¼å®¹å¤„ç†ï¼‰
  html += '<div class="examination-info mt-2">';
  html += '<div class="row small text-muted">';
  html += '<div class="col-6">é£é™©: ' + (option.risk_level || 'æœªçŸ¥') + '</div>';
  html += '<div class="col-6">è´¹ç”¨: Â¥' + (option.cost || 0) + '</div>';
  html += '</div>';
  html += '</div>';
        
        html += '</label>';
        html += '</div>';
        html += '</div>';
        html += '</div>';
        html += '</div>';
      });
      html += '</div>';
      html += '</div>';
    });
    
    html += '</div>';
    
    // æ·»åŠ é€‰æ‹©ç»Ÿè®¡
    html += '<div class="examination-summary mt-4">';
    html += '<div class="card bg-light">';
    html += '<div class="card-body">';
    html += '<h6><i class="fas fa-calculator"></i> é€‰æ‹©ç»Ÿè®¡</h6>';
    html += '<div class="row text-center">';
    html += '<div class="col-3">';
    html += '<div class="h5 mb-0" id="selected-count">0</div>';
    html += '<small class="text-muted">å·²é€‰æ£€æŸ¥</small>';
    html += '</div>';
    html += '<div class="col-3">';
    html += '<div class="h5 mb-0" id="total-cost">Â¥0</div>';
    html += '<small class="text-muted">æ€»è´¹ç”¨</small>';
    html += '</div>';
    html += '<div class="col-3">';
    html += '<div class="h5 mb-0" id="high-value-count">0</div>';
    html += '<small class="text-muted">é«˜ä»·å€¼æ£€æŸ¥</small>';
    html += '</div>';
    html += '<div class="col-3">';
    html += '<div class="h5 mb-0" id="risk-assessment">ä½</div>';
    html += '<small class="text-muted">ç»¼åˆé£é™©</small>';
    html += '</div>';
    html += '</div>';
    html += '</div>';
    html += '</div>';
    html += '</div>';
    
    $('#stage-content').html(html);
    
    // ç»‘å®šæ£€æŸ¥é€‰æ‹©äº‹ä»¶
    bindExaminationEvents();
  }
  
  function groupExaminationsByType(options) {
    var grouped = {};
    options.forEach(function(option) {
      var type = option.examination_type || 'basic';
      if (!grouped[type]) {
        grouped[type] = [];
      }
      grouped[type].push(option);
    });
    return grouped;
  }
  
  function getExaminationTypeDisplay(type) {
    var displays = {
      'basic': 'åŸºç¡€æ£€æŸ¥',
      'imaging': 'å½±åƒå­¦æ£€æŸ¥', 
      'laboratory': 'å®éªŒå®¤æ£€æŸ¥',
      'special': 'ç‰¹æ®Šæ£€æŸ¥'
    };
    return displays[type] || type;
  }
  
  function getExaminationTypeIcon(type) {
    var icons = {
      'basic': 'fas fa-stethoscope',
      'imaging': 'fas fa-x-ray',
      'laboratory': 'fas fa-flask',
      'special': 'fas fa-microscope'
    };
    return icons[type] || 'fas fa-medical-kit';
  }
  
  function getRiskLevelDisplay(level) {
    var displays = {
      'low': '<span class="text-success">ä½</span>',
      'medium': '<span class="text-warning">ä¸­</span>',
      'high': '<span class="text-danger">é«˜</span>'
    };
    return displays[level] || level;
  }
  
  function bindExaminationEvents() {
    $('.examination-checkbox').on('change', function() {
      var $card = $(this).closest('.examination-option');
      var examId = parseInt($(this).val());
      var isChecked = $(this).is(':checked');
      var isFundus = $(this).data('is-fundus') == 1;

      // å•é€‰/å¤šé€‰æ§åˆ¶ï¼ˆå¦‚æœåç«¯ä¼ å› is_multiple_choice å¯ä½¿ç”¨ï¼›å¦åˆ™ä½¿ç”¨é¡µé¢çº¦æŸï¼šåŒä¸€ç±»å‹é™åˆ¶å•é€‰ç¤ºä¾‹ï¼‰
      var allowMultiple = $(this).data('allow-multiple') === 1;

      if (!allowMultiple && isChecked) {
        // å–æ¶ˆåŒä¸€ç±»å‹ä¸‹å…¶ä»–å·²é€‰é¡¹ï¼ˆä¿æŒå•é€‰è¡Œä¸ºï¼‰
        var name = $(this).attr('name');
        $('.examination-checkbox[name="' + name + '"]').not(this).prop('checked', false).trigger('change');
      }

      if (isChecked) {
        $card.addClass('selected');
        if (clinicalSession.selectedExaminations.indexOf(examId) === -1) clinicalSession.selectedExaminations.push(examId);
        addToLearningTimeline('é€‰æ‹©æ£€æŸ¥', $card.find('strong').text());

        // è‹¥ä¸ºçœ¼åº•æ£€æŸ¥ï¼Œæ˜¾ç¤ºæ˜æ˜¾æç¤º
        if (isFundus) {
          showFundusReminder();
        }
      } else {
        $card.removeClass('selected');
        var index = clinicalSession.selectedExaminations.indexOf(examId);
        if (index > -1) {
          clinicalSession.selectedExaminations.splice(index, 1);
        }
      }

      updateExaminationSummary();
      provideLiveExaminationFeedback();

      // å¦‚æœè¯¥é€‰é¡¹åŒ…å«å›¾ç‰‡ï¼Œç‚¹å‡»æŸ¥çœ‹å›¾ç‰‡åˆ™è®°å½•
      var images = $card.data('images');
      if (images && images.length > 0) {
        // render images preview when selected
        renderExaminationImagesForCard($card, images);
      }
    });
    
    $('.examination-option').on('click', function(e) {
      if (e.target.type !== 'checkbox') {
        var checkbox = $(this).find('.examination-checkbox');
        checkbox.prop('checked', !checkbox.prop('checked')).trigger('change');
      }
    });
  }

  function showFundusReminder() {
    var reminderHtml = '<div class="alert alert-danger text-center" id="fundus-reminder" style="font-size:1.6rem;font-weight:bold;">è¯·ç§»æ­¥æ—è¾¹è¿›è¡Œè§‚å¯Ÿ</div>';
    if ($('#fundus-reminder').length === 0) {
      $('#stage-content').prepend(reminderHtml);
    }
  }

  function renderExaminationImagesForCard($card, images) {
    // images ä¸ºæ•°ç»„è·¯å¾„
    if (!images || images.length === 0) return;
    var html = '<div class="examination-images mt-3">';
    images.forEach(function(img) {
      html += '<img src="' + img + '" class="img-fluid mb-2 exam-image" style="max-height:220px; cursor:zoom-in;" data-src="' + img + '">';
    });
    html += '</div>';

    // é˜²æ­¢é‡å¤æ’å…¥
    $card.find('.examination-images').remove();
    $card.find('.card-body').append(html);

    // ç‚¹å‡»å›¾ç‰‡è®°å½•ä¸ºå·²æŸ¥çœ‹
    $card.find('.exam-image').on('click', function() {
      var src = $(this).data('src');
      if (clinicalSession.examination_images_viewed.indexOf(src) === -1) {
        clinicalSession.examination_images_viewed.push(src);
      }
      showImageModal(src);
    });
  }

  function showImageModal(src) {
    var modalHtml = '';
    modalHtml += '<div class="modal fade" id="examImageModal" tabindex="-1" role="dialog">';
    modalHtml += '<div class="modal-dialog modal-lg" role="document">';
    modalHtml += '<div class="modal-content">';
    modalHtml += '<div class="modal-body text-center">';
    modalHtml += '<img src="' + src + '" class="img-fluid">';
    modalHtml += '</div>';
    modalHtml += '<div class="modal-footer">';
    modalHtml += '<button type="button" class="btn btn-secondary" data-dismiss="modal">å…³é—­</button>'; 
    modalHtml += '</div></div></div></div>';

    $('#examImageModal').remove();
    $('body').append(modalHtml);
    $('#examImageModal').modal('show');
  }
  
  function updateExaminationSummary() {
    var selectedCount = clinicalSession.selectedExaminations.length;
    var totalCost = 0;
    var highValueCount = 0;
    var riskLevels = [];
    
    $('.examination-checkbox:checked').each(function() {
      var $card = $(this).closest('.examination-option');
      var cost = parseInt($card.find('.examination-info').text().match(/Â¥(\d+)/)?.[1] || 0);
      totalCost += cost;
      
      if ($card.find('.badge-success').length > 0) {
        highValueCount++;
      }
      
      var riskText = $card.find('.examination-info').text();
      if (riskText.includes('é«˜')) riskLevels.push('high');
      else if (riskText.includes('ä¸­')) riskLevels.push('medium');
      else riskLevels.push('low');
    });
    
    // ç»¼åˆé£é™©è¯„ä¼°
    var overallRisk = 'low';
    if (riskLevels.includes('high')) overallRisk = 'high';
    else if (riskLevels.includes('medium')) overallRisk = 'medium';
    
    $('#selected-count').text(selectedCount);
    $('#total-cost').text('Â¥' + totalCost);
    $('#high-value-count').text(highValueCount);
    $('#risk-assessment').html(getRiskLevelDisplay(overallRisk));
  }
  
  function provideLiveExaminationFeedback() {
    var selectedCount = clinicalSession.selectedExaminations.length;
    var feedback = '';
    
    if (selectedCount === 0) {
      feedback = '<div class="alert alert-info">è¯·å¼€å§‹é€‰æ‹©æ£€æŸ¥é¡¹ç›®</div>';
    } else if (selectedCount < 3) {
      feedback = '<div class="alert alert-warning">è€ƒè™‘æ˜¯å¦éœ€è¦æ›´å¤šæ£€æŸ¥æ¥æ˜ç¡®è¯Šæ–­</div>';
    } else if (selectedCount > 8) {
      feedback = '<div class="alert alert-danger">æ£€æŸ¥è¿‡å¤šå¯èƒ½å¢åŠ æˆæœ¬å’Œæ‚£è€…è´Ÿæ‹…</div>';
    } else {
      feedback = '<div class="alert alert-success">æ£€æŸ¥é€‰æ‹©åˆç†ï¼Œè¯·ç»§ç»­</div>';
    }
    
    $('#feedback-panel').html(feedback);
  }

  function submitExaminations() {
    // éªŒè¯å¿…é€‰æ£€æŸ¥æ˜¯å¦è¢«é€‰ä¸­
    var requiredMissing = [];
    $('.examination-checkbox').each(function() {
      var isRequired = $(this).data('is-required') === 1 || $(this).data('is-required') === true;
      if (isRequired) {
        var id = parseInt($(this).val());
        if (clinicalSession.selectedExaminations.indexOf(id) === -1) {
          requiredMissing.push(id);
        }
      }
    });

    if (requiredMissing.length > 0) {
      showFeedbackMessage('å­˜åœ¨å¿…é€‰æ£€æŸ¥æœªé€‰æ‹©ï¼Œè¯·å…ˆå®Œæˆå¿…é€‰æ£€æŸ¥', 'danger');
      return;
    }

    // æ˜¾ç¤ºæäº¤ä¸­çŠ¶æ€
    $('#btn-next').prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i> æäº¤ä¸­...');
    showFeedbackMessage('æ­£åœ¨æäº¤æ£€æŸ¥é€‰æ‹©...', 'info');

    // å‡†å¤‡æäº¤æ•°æ®
    var submitData = {
      case_id: clinicalSession.caseId,
      selected_examinations: clinicalSession.selectedExaminations,
      images_viewed: clinicalSession.examination_images_viewed
    };

    $.ajax({
      url: '/api/clinical/submit-examinations/',
      method: 'POST',
      contentType: 'application/json',
      headers: {
        'X-CSRFToken': $('[name=csrfmiddlewaretoken]').val() || getCsrfToken()
      },
      data: JSON.stringify(submitData),
      success: function(resp) {
        $('#btn-next').prop('disabled', false).html('ä¸‹ä¸€æ­¥ <i class="fas fa-arrow-right"></i>');

        if (resp.success) {
          // è®°å½•æ£€æŸ¥é˜¶æ®µå®Œæˆ
          addToLearningTimeline('å®Œæˆæ£€æŸ¥é€‰æ‹©', 'é€‰æ‹©äº† ' + clinicalSession.selectedExaminations.length + ' é¡¹æ£€æŸ¥');

          // æ›´æ–°åˆ†æ•°
          if (resp.data.examination_score !== undefined) {
            clinicalSession.scores.examination = resp.data.examination_score;
            $('#current-score').text(resp.data.examination_score.toFixed(1));
          }

          // è¿›å…¥è¯Šæ–­é˜¶æ®µ
          renderDiagnosisStage(resp.data);
          showFeedbackMessage('æ£€æŸ¥ç»“æœå·²è·å¾—ï¼Œè¯·å¼€å§‹è¯Šæ–­åˆ†æ', 'success');
          // è§†è§‰åé¦ˆ
          flashCard($('#feedback-panel'), 'success');
          launchConfetti(25);
        } else {
          showFeedbackMessage('æäº¤å¤±è´¥: ' + resp.message, 'danger');
        }
      },
      error: function(xhr, status, error) {
        $('#btn-next').prop('disabled', false).html('ä¸‹ä¸€æ­¥ <i class="fas fa-arrow-right"></i>');
        console.error('Submit examination error:', error, xhr.responseText);

        if (xhr.status === 404) {
          showFeedbackMessage('APIæ¥å£æœªæ‰¾åˆ°ï¼Œè¯·æ£€æŸ¥åç«¯é…ç½®', 'danger');
        } else if (xhr.status === 403) {
          showFeedbackMessage('æƒé™ä¸è¶³ï¼Œè¯·é‡æ–°ç™»å½•', 'danger');
        } else if (xhr.status === 500) {
          showFeedbackMessage('æœåŠ¡å™¨å†…éƒ¨é”™è¯¯ï¼Œè¯·è”ç³»ç®¡ç†å‘˜', 'danger');
        } else {
          showFeedbackMessage('ç½‘ç»œé”™è¯¯ï¼Œè¯·æ£€æŸ¥è¿æ¥: ' + error, 'danger');
        }
      }
    });
  }

  
  // ==================== è¯Šæ–­é˜¶æ®µï¼šé‰´åˆ«è¯Šæ–­æ¨ç† ====================
  
  function renderDiagnosisStage(data) {
    clinicalSession.currentStage = 'diagnosis';
    updateClinicalProgress();
    updateStageProgress();
    
    $('#btn-next').text('æäº¤è¯Šæ–­é€‰æ‹© â†’').removeClass('btn-warning').addClass('btn-info');
    $('#current-stage-badge').text('è¯Šæ–­æ¨ç†é˜¶æ®µ').removeClass().addClass('badge badge-info');
    
    var html = '<div class="diagnosis-stage">';
    
    // æ£€æŸ¥ç»“æœå±•ç¤º
    html += '<div class="examination-results mb-4">';
    html += '<h5 class="text-primary"><i class="fas fa-flask"></i> æ£€æŸ¥ç»“æœ</h5>';
    
    if (data.examination_results && data.examination_results.length > 0) {
      html += '<div class="row">';
      data.examination_results.forEach(function(result) {
        html += '<div class="col-md-6 mb-3">';
        html += '<div class="card border-left-primary">';
        html += '<div class="card-body">';
        html += '<h6>' + result.name + '</h6>';
        html += '<div class="examination-result">';
        html += '<strong>ç»“æœï¼š</strong>' + (result.result || 'æœªè®°å½•');
        html += '</div>';
        if (result.is_recommended) {
          html += '<span class="badge badge-success">æ¨èæ£€æŸ¥</span>';
        }
        html += '</div>';
        html += '</div>';
        html += '</div>';
      });
      html += '</div>';
    } else {
      html += '<div class="alert alert-warning">æš‚æ— æ£€æŸ¥ç»“æœæ•°æ®</div>';
    }
    html += '</div>';
    
    // è¯Šæ–­é€‰é¡¹
    html += '<div class="diagnosis-options">';
    html += '<h5 class="text-info"><i class="fas fa-diagnoses"></i> é‰´åˆ«è¯Šæ–­</h5>';
    html += '<div class="alert alert-info">';
    html += '<h6><i class="fas fa-brain"></i> è¯Šæ–­æ€ç»´æŒ‡å¯¼</h6>';
    html += '<p class="mb-0">ç»¼åˆæ‚£è€…ç—…å²å’Œæ£€æŸ¥ç»“æœï¼Œè¿›è¡Œé‰´åˆ«è¯Šæ–­ã€‚é€‰æ‹©æ¦‚ç‡æœ€é«˜çš„è¯Šæ–­é€‰é¡¹ã€‚</p>';
    html += '</div>';
    
    if (data.diagnosis_options && data.diagnosis_options.length > 0) {
      html += '<form id="diagnosis-form">';
      data.diagnosis_options.forEach(function(option) {
        html += '<div class="card diagnosis-option mb-3" data-diagnosis-id="' + option.id + '">';
        html += '<div class="card-body">';
        html += '<div class="form-check">';
        html += '<input class="form-check-input diagnosis-radio" type="radio" name="diagnosis" ';
        html += 'value="' + option.id + '" id="diag_' + option.id + '">';
        html += '<label class="form-check-label w-100" for="diag_' + option.id + '">';
        html += '<div class="d-flex justify-content-between align-items-center">';
        html += '<div>';
        html += '<h6 class="mb-1">' + option.name + '</h6>';
        if (option.code) {
          html += '<small class="text-muted">ICDç¼–ç : ' + option.code + '</small>';
        }
        html += '</div>';
        if (option.probability_score !== undefined) {
          html += '<div class="diagnosis-probability">';
          html += '<span class="badge badge-outline-secondary">æ¦‚ç‡: ' + (option.probability_score * 100).toFixed(0) + '%</span>';
          html += '</div>';
        }
        html += '</div>';
        html += '</label>';
        html += '</div>';
        html += '</div>';
        html += '</div>';
      });
      html += '</form>';
    } else {
      html += '<div class="alert alert-warning">æš‚æ— è¯Šæ–­é€‰é¡¹æ•°æ®</div>';
    }
    
    html += '</div>';
    html += '</div>';
    
    $('#stage-content').html(html);
    
    // ç»‘å®šè¯Šæ–­é€‰æ‹©äº‹ä»¶
    bindDiagnosisEvents();
    showClinicalThinkingPrompt('diagnosis');
  }
  
  function bindDiagnosisEvents() {
    $('.diagnosis-radio').on('change', function() {
      var diagnosisId = parseInt($(this).val());
      var $card = $(this).closest('.diagnosis-option');
      
      // ç§»é™¤å…¶ä»–é€‰ä¸­çŠ¶æ€
      $('.diagnosis-option').removeClass('selected');
      
      // è®¾ç½®å½“å‰é€‰ä¸­
      $card.addClass('selected');
      clinicalSession.selectedDiagnosis = diagnosisId;
      
      // è®°å½•é€‰æ‹©
      var diagnosisName = $(this).siblings('label').find('h6').text();
      addToLearningTimeline('é€‰æ‹©è¯Šæ–­', diagnosisName);
      
      // æä¾›å³æ—¶åé¦ˆ
      showFeedbackMessage('å·²é€‰æ‹©è¯Šæ–­ï¼š' + diagnosisName, 'info');
    });
    
    $('.diagnosis-option').on('click', function(e) {
      if (e.target.type !== 'radio') {
        var radio = $(this).find('.diagnosis-radio');
        radio.prop('checked', true).trigger('change');
      }
    });
  }
  
  // ==================== å·¥å…·å‡½æ•° ====================
  
  function getCsrfToken() {
    // å°è¯•ä»cookieè·å–CSRF token
    var cookieValue = null;
    if (document.cookie && document.cookie !== '') {
      var cookies = document.cookie.split(';');
      for (var i = 0; i < cookies.length; i++) {
        var cookie = cookies[i].trim();
        if (cookie.substring(0, 10) === 'csrftoken=') {
          cookieValue = decodeURIComponent(cookie.substring(10));
          break;
        }
      }
    }
    return cookieValue;
  }

  function submitDiagnosis() {
    // æ˜¾ç¤ºæäº¤ä¸­çŠ¶æ€
    $('#btn-next').prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i> æäº¤ä¸­...');
    showFeedbackMessage('æ­£åœ¨æäº¤è¯Šæ–­é€‰æ‹©...', 'info');
    
    // å‡†å¤‡æäº¤æ•°æ®
    var submitData = {
      case_id: clinicalSession.caseId,
      selected_diagnosis_id: clinicalSession.selectedDiagnosis,
      reasoning: $('#clinical-notes').val() || ''
    };
    
    $.ajax({
      url: '/api/clinical/submit-diagnosis/',
      method: 'POST',
      contentType: 'application/json',
      headers: {
        'X-CSRFToken': $('[name=csrfmiddlewaretoken]').val() || getCsrfToken()
      },
      data: JSON.stringify(submitData),
      success: function(resp) {
        $('#btn-next').prop('disabled', false).html('ä¸‹ä¸€æ­¥ <i class="fas fa-arrow-right"></i>');
        
        if (resp.success) {
          // è®°å½•è¯Šæ–­é˜¶æ®µå®Œæˆ
          var selectedDiagName = $('.diagnosis-option.selected').find('h6').text();
          addToLearningTimeline('æäº¤è¯Šæ–­', selectedDiagName);
          
          // æ›´æ–°åˆ†æ•°
          if (resp.data.diagnosis_score !== undefined) {
            clinicalSession.scores.diagnosis = resp.data.diagnosis_score;
            $('#current-score').text(resp.data.diagnosis_score.toFixed(1));
          }
          
          // æ˜¾ç¤ºè¯Šæ–­åé¦ˆ
          if (resp.data.diagnosis_feedback) {
            showFeedbackMessage(resp.data.diagnosis_feedback, 'success');
          }
          
          // è¿›å…¥æ²»ç–—é˜¶æ®µ
          renderTreatmentStage(resp.data);
          // è§†è§‰åé¦ˆ
          flashCard($('#feedback-panel'), 'success');
          launchConfetti(20);
        } else {
          showFeedbackMessage('æäº¤å¤±è´¥: ' + resp.message, 'danger');
        }
      },
      error: function(xhr, status, error) {
        $('#btn-next').prop('disabled', false).html('ä¸‹ä¸€æ­¥ <i class="fas fa-arrow-right"></i>');
        console.error('Submit diagnosis error:', error, xhr.responseText);
        
        if (xhr.status === 404) {
          showFeedbackMessage('APIæ¥å£æœªæ‰¾åˆ°ï¼Œè¯·æ£€æŸ¥åç«¯é…ç½®', 'danger');
        } else if (xhr.status === 403) {
          showFeedbackMessage('æƒé™ä¸è¶³ï¼Œè¯·é‡æ–°ç™»å½•', 'danger');
        } else if (xhr.status === 500) {
          showFeedbackMessage('æœåŠ¡å™¨å†…éƒ¨é”™è¯¯ï¼Œè¯·è”ç³»ç®¡ç†å‘˜', 'danger');
        } else {
          showFeedbackMessage('ç½‘ç»œé”™è¯¯ï¼Œè¯·æ£€æŸ¥è¿æ¥: ' + error, 'danger');
        }
      }
    });
  }

  
  // ==================== æ²»ç–—é˜¶æ®µï¼šæ²»ç–—å†³ç­– ====================
  
  function renderTreatmentStage(data) {
    clinicalSession.currentStage = 'treatment';
    updateClinicalProgress();
    updateStageProgress();
    
    $('#btn-next').text('æäº¤æ²»ç–—æ–¹æ¡ˆ â†’').removeClass('btn-info').addClass('btn-success');
    $('#current-stage-badge').text('æ²»ç–—å†³ç­–é˜¶æ®µ').removeClass().addClass('badge badge-success');
    
    var html = '<div class="treatment-stage">';
    
    // è¯Šæ–­ç¡®è®¤å±•ç¤º
    if (data.selected_diagnosis) {
      html += '<div class="diagnosis-confirmation mb-4">';
      html += '<h5 class="text-success"><i class="fas fa-check-circle"></i> ç¡®è®¤è¯Šæ–­</h5>';
      html += '<div class="card border-success">';
      html += '<div class="card-body">';
      html += '<h6>' + data.selected_diagnosis.name + '</h6>';
      if (data.selected_diagnosis.code) {
        html += '<small class="text-muted">ICDç¼–ç : ' + data.selected_diagnosis.code + '</small><br>';
      }
      if (data.selected_diagnosis.is_correct) {
        html += '<span class="badge badge-success">è¯Šæ–­æ­£ç¡®</span>';
      } else {
        html += '<span class="badge badge-warning">éœ€è¦è¿›ä¸€æ­¥ç¡®è®¤</span>';
      }
      html += '</div>';
      html += '</div>';
      html += '</div>';
    }
    
    // æ²»ç–—æ–¹æ¡ˆé€‰æ‹©
    html += '<div class="treatment-options">';
    html += '<h5 class="text-success"><i class="fas fa-prescription-bottle-alt"></i> æ²»ç–—æ–¹æ¡ˆé€‰æ‹©</h5>';
    html += '<div class="alert alert-success">';
    html += '<h6><i class="fas fa-medkit"></i> æ²»ç–—å†³ç­–æŒ‡å¯¼</h6>';
    html += '<p class="mb-0">åŸºäºç¡®å®šçš„è¯Šæ–­ï¼Œé€‰æ‹©åˆé€‚çš„æ²»ç–—æ–¹æ¡ˆã€‚è€ƒè™‘æ²»ç–—çš„æœ‰æ•ˆæ€§ã€å®‰å…¨æ€§ã€æˆæœ¬æ•ˆç›Šå’Œæ‚£è€…ä¸ªä½“æƒ…å†µã€‚</p>';
    html += '</div>';
    
    if (data.treatment_options && data.treatment_options.length > 0) {
      html += '<form id="treatment-form">';
      
      // æŒ‰æ²»ç–—ç±»å‹åˆ†ç»„
      var groupedTreatments = groupTreatmentsByType(data.treatment_options);
      
      Object.keys(groupedTreatments).forEach(function(type) {
        var typeOptions = groupedTreatments[type];
        var typeDisplayName = getTreatmentTypeDisplay(type);
        var typeIcon = getTreatmentTypeIcon(type);
        
        html += '<div class="treatment-group mb-4">';
        html += '<h6 class="text-primary mb-3">';
        html += '<i class="' + typeIcon + '"></i> ' + typeDisplayName;
        html += '<small class="text-muted ml-2">(' + typeOptions.length + 'é¡¹)</small>';
        html += '</h6>';
        
        html += '<div class="row">';
        typeOptions.forEach(function(option) {
          html += '<div class="col-md-6 mb-3">';
          html += '<div class="card treatment-option h-100';
          
          // æ ¹æ®æ²»ç–—é€‚å®œæ€§æ·»åŠ æ ·å¼ç±»
          if (option.is_optimal) {
            html += ' optimal';
          } else if (option.is_contraindicated) {
            html += ' contraindicated';
          } else if (option.is_acceptable) {
            html += ' acceptable';
          }
          
          html += '" data-treatment-id="' + option.id + '">';
          html += '<div class="card-body">';
          
          html += '<div class="form-check">';
          html += '<input class="form-check-input treatment-checkbox" type="checkbox" ';
          html += 'value="' + option.id + '" id="treat_' + option.id + '">';
          html += '<label class="form-check-label w-100" for="treat_' + option.id + '">';
          html += '<div class="d-flex justify-content-between align-items-start">';
          html += '<strong>' + option.name + '</strong>';
          
          // æ˜¾ç¤ºæ²»ç–—ç‰¹æ€§æ ‡ç­¾
          html += '<div class="treatment-badges">';
          if (option.is_optimal) {
            html += '<span class="badge badge-success">æœ€ä½³</span>';
          }
          if (option.is_contraindicated) {
            html += '<span class="badge badge-danger">ç¦å¿Œ</span>';
          }
          if (option.efficacy_score === 'high') {
            html += '<span class="badge badge-info">é«˜æ•ˆ</span>';
          }
          html += '</div>';
          
          html += '</div>';
          html += '<div class="text-muted small mt-2">' + (option.description || '') + '</div>';
          
          // æ˜¾ç¤ºç–—æ•ˆå’Œå®‰å…¨æ€§ä¿¡æ¯
          html += '<div class="treatment-info mt-2">';
          html += '<div class="row small text-muted">';
          html += '<div class="col-4">ç–—æ•ˆ: ' + (option.efficacy_score || 'ä¸­') + '</div>';
          html += '<div class="col-4">å®‰å…¨: ' + (option.safety_score || 'ä¸­') + '</div>';
          html += '<div class="col-4">æˆæœ¬: ' + (option.cost_score || 'ä¸­') + '</div>';
          html += '</div>';
          html += '</div>';
          
          // é¢„æœŸç»“æœ
          if (option.expected_outcome) {
            html += '<div class="expected-outcome mt-2">';
            html += '<small class="text-info"><i class="fas fa-bullseye"></i> ' + option.expected_outcome + '</small>';
          }
          
          html += '</label>';
          html += '</div>';
          html += '</div>';
          html += '</div>';
          html += '</div>';
        });
        html += '</div>';
        html += '</div>';
      });
      
      html += '</form>';
    } else {
      html += '<div class="alert alert-warning">æš‚æ— æ²»ç–—æ–¹æ¡ˆæ•°æ®</div>';
    }
    
    html += '</div>';
    
    // æ·»åŠ æ²»ç–—æ–¹æ¡ˆé€‰æ‹©ç»Ÿè®¡
    html += '<div class="treatment-summary mt-4">';
    html += '<div class="card bg-light">';
    html += '<div class="card-body">';
    html += '<h6><i class="fas fa-chart-pie"></i> æ²»ç–—æ–¹æ¡ˆåˆ†æ</h6>';
    html += '<div class="row text-center">';
    html += '<div class="col-3">';
    html += '<div class="h5 mb-0" id="selected-treatments-count">0</div>';
    html += '<small class="text-muted">å·²é€‰æ–¹æ¡ˆ</small>';
    html += '</div>';
    html += '<div class="col-3">';
    html += '<div class="h5 mb-0" id="optimal-treatments-count">0</div>';
    html += '<small class="text-muted">æœ€ä½³æ–¹æ¡ˆ</small>';
    html += '</div>';
    html += '<div class="col-3">';
    html += '<div class="h5 mb-0" id="treatment-efficacy">--</div>';
    html += '<small class="text-muted">ç»¼åˆç–—æ•ˆ</small>';
    html += '</div>';
    html += '<div class="col-3">';
    html += '<div class="h5 mb-0" id="treatment-safety">--</div>';
    html += '<small class="text-muted">å®‰å…¨è¯„çº§</small>';
    html += '</div>';
    html += '</div>';
    html += '</div>';
    html += '</div>';
    html += '</div>';
    
    html += '</div>';
    
    $('#stage-content').html(html);
    
    // ç»‘å®šæ²»ç–—é€‰æ‹©äº‹ä»¶
    bindTreatmentEvents();
    showClinicalThinkingPrompt('treatment');
  }
  
  function groupTreatmentsByType(options) {
    var grouped = {};
    options.forEach(function(option) {
      var type = option.type || 'medication';
      if (!grouped[type]) {
        grouped[type] = [];
      }
      grouped[type].push(option);
    });
    return grouped;
  }
  
  function getTreatmentTypeDisplay(type) {
    var displays = {
      'medication': 'è¯ç‰©æ²»ç–—',
      'surgery': 'æ‰‹æœ¯æ²»ç–—',
      'observation': 'è§‚å¯Ÿéšè®¿',
      'referral': 'è½¬è¯Šæ²»ç–—',
      'education': 'å¥åº·æ•™è‚²'
    };
    return displays[type] || type;
  }
  
  function getTreatmentTypeIcon(type) {
    var icons = {
      'medication': 'fas fa-pills',
      'surgery': 'fas fa-scalpel-path',
      'observation': 'fas fa-eye',
      'referral': 'fas fa-hospital',
      'education': 'fas fa-graduation-cap'
    };
    return icons[type] || 'fas fa-medical-kit';
  }
  
  function bindTreatmentEvents() {
    $('.treatment-checkbox').on('change', function() {
      var $card = $(this).closest('.treatment-option');
      var treatmentId = parseInt($(this).val());
      
      if ($(this).is(':checked')) {
        $card.addClass('selected');
        clinicalSession.selectedTreatments.push(treatmentId);
        addToLearningTimeline('é€‰æ‹©æ²»ç–—', $(this).siblings('label').find('strong').text());
      } else {
        $card.removeClass('selected');
        var index = clinicalSession.selectedTreatments.indexOf(treatmentId);
        if (index > -1) {
          clinicalSession.selectedTreatments.splice(index, 1);
        }
      }
      
      updateTreatmentSummary();
      provideLiveTreatmentFeedback();
    });
    
    $('.treatment-option').on('click', function(e) {
      if (e.target.type !== 'checkbox') {
        var checkbox = $(this).find('.treatment-checkbox');
        checkbox.prop('checked', !checkbox.prop('checked')).trigger('change');
      }
    });
  }
  
  function updateTreatmentSummary() {
    var selectedCount = clinicalSession.selectedTreatments.length;
    var optimalCount = 0;
    var efficacyScores = [];
    var safetyScores = [];
    
    $('.treatment-checkbox:checked').each(function() {
      var $card = $(this).closest('.treatment-option');
      
      if ($card.find('.badge-success').length > 0) {
        optimalCount++;
      }
      
      // ç®€å•çš„è¯„åˆ†é€»è¾‘
      var efficacyText = $card.find('.treatment-info').text();
      if (efficacyText.includes('ç–—æ•ˆ: é«˜')) efficacyScores.push(3);
      else if (efficacyText.includes('ç–—æ•ˆ: ä¸­')) efficacyScores.push(2);
      else efficacyScores.push(1);
      
      if (efficacyText.includes('å®‰å…¨: é«˜')) safetyScores.push(3);
      else if (efficacyText.includes('å®‰å…¨: ä¸­')) safetyScores.push(2);
      else safetyScores.push(1);
    });
    
    // è®¡ç®—å¹³å‡ç–—æ•ˆå’Œå®‰å…¨æ€§
    var avgEfficacy = efficacyScores.length > 0 ? efficacyScores.reduce((a, b) => a + b, 0) / efficacyScores.length : 0;
    var avgSafety = safetyScores.length > 0 ? safetyScores.reduce((a, b) => a + b, 0) / safetyScores.length : 0;
    
    var efficacyLevel = avgEfficacy >= 2.5 ? 'é«˜' : avgEfficacy >= 1.5 ? 'ä¸­' : 'ä½';
    var safetyLevel = avgSafety >= 2.5 ? 'é«˜' : avgSafety >= 1.5 ? 'ä¸­' : 'ä½';
    
    $('#selected-treatments-count').text(selectedCount);
    $('#optimal-treatments-count').text(optimalCount);
    $('#treatment-efficacy').text(efficacyLevel);
    $('#treatment-safety').text(safetyLevel);
  }
  
  function provideLiveTreatmentFeedback() {
    var selectedCount = clinicalSession.selectedTreatments.length;
    var feedback = '';
    
    if (selectedCount === 0) {
      feedback = '<div class="alert alert-info">è¯·å¼€å§‹é€‰æ‹©æ²»ç–—æ–¹æ¡ˆ</div>';
    } else if (selectedCount === 1) {
      feedback = '<div class="alert alert-warning">è€ƒè™‘æ˜¯å¦éœ€è¦è”åˆæ²»ç–—</div>';
    } else if (selectedCount > 5) {
      feedback = '<div class="alert alert-danger">æ²»ç–—æ–¹æ¡ˆè¿‡å¤šå¯èƒ½å¢åŠ å‰¯ä½œç”¨é£é™©</div>';
    } else {
      feedback = '<div class="alert alert-success">æ²»ç–—æ–¹æ¡ˆé€‰æ‹©åˆç†</div>';
    }
    
    $('#feedback-panel').html(feedback);
  }

  function submitTreatments() {
    // æ˜¾ç¤ºæäº¤ä¸­çŠ¶æ€
    $('#btn-next').prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i> æäº¤ä¸­...');
    showFeedbackMessage('æ­£åœ¨æäº¤æ²»ç–—æ–¹æ¡ˆ...', 'info');
    
    // å‡†å¤‡æäº¤æ•°æ®
    var submitData = {
      case_id: clinicalSession.caseId,
      selected_treatments: clinicalSession.selectedTreatments,
      reasoning: $('#clinical-notes').val() || ''
    };
    
    $.ajax({
      url: '/api/clinical/submit-treatments/',
      method: 'POST',
      contentType: 'application/json',
      headers: {
        'X-CSRFToken': $('[name=csrfmiddlewaretoken]').val() || getCsrfToken()
      },
      data: JSON.stringify(submitData),
      success: function(resp) {
        $('#btn-next').prop('disabled', false).html('å®Œæˆå­¦ä¹  <i class="fas fa-check"></i>');
        
        if (resp.success) {
          // è®°å½•æ²»ç–—é˜¶æ®µå®Œæˆ
          addToLearningTimeline('å®Œæˆæ²»ç–—é€‰æ‹©', 'é€‰æ‹©äº† ' + clinicalSession.selectedTreatments.length + ' ç§æ²»ç–—æ–¹æ¡ˆ');
          
          // æ›´æ–°åˆ†æ•°
          if (resp.data.treatment_score !== undefined) {
            clinicalSession.scores.treatment = resp.data.treatment_score;
          }
          
          // è®¡ç®—æ€»åˆ†
          if (resp.data.scores && resp.data.scores.overall_score !== undefined) {
            clinicalSession.scores.overall = resp.data.scores.overall_score;
            $('#current-score').text(resp.data.scores.overall_score.toFixed(1));
          }
          
          // è¿›å…¥åé¦ˆé˜¶æ®µ
          clinicalSession.currentStage = 'feedback';
          updateClinicalProgress();
          showFinalFeedback(resp.data);
          // è§†è§‰ä¸åŠ¨ç”»åé¦ˆ
          flashCard($('#stage-content'), 'success');
          launchConfetti(40);
        } else {
          showFeedbackMessage('æäº¤å¤±è´¥: ' + resp.message, 'danger');
        }
      },
      error: function(xhr, status, error) {
        $('#btn-next').prop('disabled', false).html('ä¸‹ä¸€æ­¥ <i class="fas fa-arrow-right"></i>');
        console.error('Submit treatment error:', error, xhr.responseText);
        
        if (xhr.status === 404) {
          showFeedbackMessage('APIæ¥å£æœªæ‰¾åˆ°ï¼Œè¯·æ£€æŸ¥åç«¯é…ç½®', 'danger');
        } else if (xhr.status === 403) {
          showFeedbackMessage('æƒé™ä¸è¶³ï¼Œè¯·é‡æ–°ç™»å½•', 'danger');
        } else if (xhr.status === 500) {
          showFeedbackMessage('æœåŠ¡å™¨å†…éƒ¨é”™è¯¯ï¼Œè¯·è”ç³»ç®¡ç†å‘˜', 'danger');
        } else {
          showFeedbackMessage('ç½‘ç»œé”™è¯¯ï¼Œè¯·æ£€æŸ¥è¿æ¥: ' + error, 'danger');
        }
      }
    });
  }

  function showFinalFeedback(data) {
    clinicalSession.currentStage = 'feedback';
    updateClinicalProgress();
    updateStageProgress();
    
    $('#current-stage-badge').text('å­¦ä¹ å®Œæˆ').removeClass().addClass('badge badge-success');
    
    // æ˜¾ç¤ºæœ€ç»ˆåé¦ˆ
    var feedbackHtml = '<div class="alert alert-success feedback-animation">';
    feedbackHtml += '<h6><i class="fas fa-trophy"></i> å­¦ä¹ å®Œæˆï¼</h6>';
    feedbackHtml += (data.overall_feedback || 'æ­å–œæ‚¨å®Œæˆäº†æœ¬æ¬¡ä¸´åºŠæ¨ç†å­¦ä¹ ï¼');
    feedbackHtml += '</div>';
    $('#feedback-panel').html(feedbackHtml);
    
    // æ„å»ºæœ€ç»ˆå­¦ä¹ æ€»ç»“é¡µé¢
    var html = '<div class="final-feedback text-center">';
    
    // æ ‡é¢˜
    html += '<div class="completion-header mb-4">';
    html += '<h3 class="text-success"><i class="fas fa-graduation-cap"></i> ä¸´åºŠæ¨ç†å­¦ä¹ å®Œæˆ</h3>';
    html += '<p class="text-muted">æ‚¨å·²æˆåŠŸå®Œæˆæœ¬æ¡ˆä¾‹çš„å®Œæ•´ä¸´åºŠæ¨ç†è¿‡ç¨‹</p>';
    html += '</div>';
    
    // æˆç»©å±•ç¤º
    html += '<div class="row mb-4">';
    
    // æ€»ä½“å¾—åˆ†
    html += '<div class="col-md-6 offset-md-3">';
    html += '<div class="card border-success">';
    html += '<div class="card-body text-center">';
    html += '<h4 class="text-success">æ€»ä½“å¾—åˆ†</h4>';
    var overallScore = (data.scores && data.scores.overall_score) ? data.scores.overall_score : clinicalSession.scores.overall;
    html += '<div class="display-3 text-primary font-weight-bold">' + (overallScore ? overallScore.toFixed(1) : '0.0') + '</div>';
    html += '<p class="text-muted">æ»¡åˆ† 100 åˆ†</p>';
    
    // è¯„çº§
    var grade = 'A';
    var gradeColor = 'success';
    if (overallScore < 60) {
      grade = 'D'; gradeColor = 'danger';
    } else if (overallScore < 70) {
      grade = 'C'; gradeColor = 'warning';
    } else if (overallScore < 85) {
      grade = 'B'; gradeColor = 'info';
    }
    html += '<h5><span class="badge badge-' + gradeColor + ' p-2">' + grade + ' çº§</span></h5>';
    html += '</div>';
    html += '</div>';
    html += '</div>';
    html += '</div>';
    
    // åˆ†é¡¹å¾—åˆ†
    html += '<div class="row mb-4">';
    html += '<div class="col-md-12">';
    html += '<div class="card">';
    html += '<div class="card-body">';
    html += '<h5 class="card-title"><i class="fas fa-chart-bar"></i> åˆ†é¡¹æˆç»©</h5>';
    html += '<div class="row text-center">';
    
    html += '<div class="col-4">';
    html += '<div class="score-item">';
    html += '<div class="h4 text-warning">' + (clinicalSession.scores.examination || 0).toFixed(1) + '</div>';
    html += '<small class="text-muted">æ£€æŸ¥é€‰æ‹© (30%)</small>';
    html += '</div>';
    html += '</div>';
    
    html += '<div class="col-4">';
    html += '<div class="score-item">';
    html += '<div class="h4 text-info">' + (clinicalSession.scores.diagnosis || 0).toFixed(1) + '</div>';
    html += '<small class="text-muted">è¯Šæ–­å‡†ç¡®æ€§ (50%)</small>';
    html += '</div>';
    html += '</div>';
    
    html += '<div class="col-4">';
    html += '<div class="score-item">';
    html += '<div class="h4 text-success">' + (clinicalSession.scores.treatment || 0).toFixed(1) + '</div>';
    html += '<small class="text-muted">æ²»ç–—æ–¹æ¡ˆ (20%)</small>';
    html += '</div>';
    html += '</div>';
    
    html += '</div>';
    html += '</div>';
    html += '</div>';
    html += '</div>';
    html += '</div>';
    
    // å­¦ä¹ æ€»ç»“
    if (data.overall_feedback || data.improvement_suggestions) {
      html += '<div class="row mb-4">';
      html += '<div class="col-md-12">';
      html += '<div class="card">';
      html += '<div class="card-body text-left">';
      html += '<h5 class="card-title"><i class="fas fa-lightbulb"></i> å­¦ä¹ æ€»ç»“</h5>';
      if (data.overall_feedback) {
        html += '<p>' + data.overall_feedback + '</p>';
      }
      if (data.improvement_suggestions) {
        html += '<h6 class="text-primary">æ”¹è¿›å»ºè®®ï¼š</h6>';
        html += '<p>' + data.improvement_suggestions + '</p>';
      }
      html += '</div>';
      html += '</div>';
      html += '</div>';
      html += '</div>';
    }
    
    // æ“ä½œæŒ‰é’®
    html += '<div class="action-buttons mt-4">';
    html += '<div class="btn-group" role="group">';
    html += '<button class="btn btn-outline-primary" onclick="location.reload()">';
    html += '<i class="fas fa-redo"></i> é‡æ–°å­¦ä¹ ';
    html += '</button>';
    html += '<a href="/student/clinical-cases/" class="btn btn-secondary">';
    html += '<i class="fas fa-list"></i> è¿”å›æ¡ˆä¾‹åˆ—è¡¨';
    html += '</a>';
    html += '<a href="/student/dashboard/" class="btn btn-success">';
    html += '<i class="fas fa-home"></i> è¿”å›é¦–é¡µ';
    html += '</a>';
    html += '</div>';
    html += '</div>';
    
    html += '</div>';
    
    $('#stage-content').html(html);
    $('#btn-next').prop('disabled', true).text('å­¦ä¹ å·²å®Œæˆ');
    
    // æ¸…é™¤ä¿å­˜çš„è¿›åº¦
    localStorage.removeItem('clinical_progress_' + clinicalSession.caseId);
    
    // è®°å½•å®Œæˆæ—¶é—´
    clinicalSession.timeSpent.total = new Date() - clinicalSession.startTime;
    addToLearningTimeline('å®Œæˆå­¦ä¹ ', 'æ€»ç”¨æ—¶: ' + Math.floor(clinicalSession.timeSpent.total / 60000) + ' åˆ†é’Ÿ');
  }

  // ==================== åŠ¨ç”»ä¸è§†è§‰æ•ˆæœ ====================
  
  // ç®€å• confetti æ•ˆæœï¼ˆæ— å¤–éƒ¨åº“ï¼Œè½»é‡ï¼‰
  function launchConfetti(count) {
    count = count || 30;
    for (var i = 0; i < count; i++) {
      (function() {
        var conf = document.createElement('div');
        conf.className = 'confetti-piece';
        var size = Math.floor(Math.random() * 8) + 6;
        conf.style.width = size + 'px';
        conf.style.height = (size * 0.6) + 'px';
        conf.style.background = ['#28a745','#007bff','#ffc107','#dc3545','#6610f2'][Math.floor(Math.random() * 5)];
        conf.style.position = 'fixed';
        conf.style.zIndex = 9999;
        conf.style.left = (Math.random() * window.innerWidth) + 'px';
        conf.style.top = '-20px';
        conf.style.opacity = Math.random() * 0.9 + 0.1;
        conf.style.transform = 'rotate(' + (Math.random() * 360) + 'deg)';
        conf.style.pointerEvents = 'none';
        document.body.appendChild(conf);
        var endY = window.innerHeight + 100 + Math.random() * 200;
        var duration = 1000 + Math.random() * 1200;
        conf.animate([
          { transform: conf.style.transform + ' translateY(0px)', opacity: conf.style.opacity },
          { transform: conf.style.transform + ' translateY(' + endY + 'px)', opacity: 0.6 }
        ], { duration: duration, easing: 'cubic-bezier(.2,.8,.2,1)' });
        setTimeout(function() { conf.remove(); }, duration + 200);
      })();
    }
  }

  // å¡ç‰‡é«˜äº®è·³åŠ¨ï¼Œç”¨äºå¼ºè°ƒæˆåŠŸ/é”™è¯¯
  function flashCard($el, type) {
    var cls = (type === 'success') ? 'flash-success' : 'flash-warning';
    $el.addClass(cls);
    setTimeout(function() { $el.removeClass(cls); }, 900);
  }

  // æ­¥éª¤é—ªå…‰ï¼ˆçŸ­æš‚æ”¾å¤§ã€å…‰æ™•ï¼‰
  function highlightStep(stepName) {
    var $step = $('.stepper-item[data-step="' + stepName + '"]');
    $step.addClass('step-highlight');
    setTimeout(function() { $step.removeClass('step-highlight'); }, 800);
  }


  
  // ==================== é€šç”¨åŠŸèƒ½å‡½æ•° ====================
  
  function showClinicalThinkingPrompt(stage) {
    var prompts = {
      'history': 'æ€è€ƒï¼šæ‚£è€…çš„ç—‡çŠ¶ç‰¹ç‚¹æ˜¯ä»€ä¹ˆï¼Ÿå¯èƒ½çš„ç—…å› æœ‰å“ªäº›ï¼Ÿéœ€è¦é‡ç‚¹å…³æ³¨ä»€ä¹ˆï¼Ÿ',
      'examination': 'æ€è€ƒï¼šåŸºäºç—…å²ï¼Œå“ªäº›æ£€æŸ¥æœ€æœ‰åŠ©äºæ˜ç¡®è¯Šæ–­ï¼Ÿå¦‚ä½•å¹³è¡¡è¯Šæ–­ä»·å€¼å’Œæˆæœ¬ï¼Ÿ',
      'diagnosis': 'æ€è€ƒï¼šæ£€æŸ¥ç»“æœæ”¯æŒå“ªäº›è¯Šæ–­ï¼Ÿå¦‚ä½•è¿›è¡Œé‰´åˆ«è¯Šæ–­ï¼Ÿæ¦‚ç‡æœ€é«˜çš„æ˜¯ä»€ä¹ˆï¼Ÿ',
      'treatment': 'æ€è€ƒï¼šé’ˆå¯¹ç¡®å®šçš„è¯Šæ–­ï¼Œæœ€ä½³æ²»ç–—æ–¹æ¡ˆæ˜¯ä»€ä¹ˆï¼Ÿå¦‚ä½•è¯„ä¼°é£é™©è·ç›Šæ¯”ï¼Ÿ',
      'feedback': 'æ€è€ƒï¼šå›é¡¾æ•´ä¸ªè¯Šç–—è¿‡ç¨‹ï¼Œæœ‰å“ªäº›å€¼å¾—æ€»ç»“çš„ç»éªŒï¼Ÿ'
    };
    
    if (prompts[stage]) {
      showFeedbackMessage(prompts[stage], 'guidance');
    }
  }
  
  function showFeedbackMessage(message, type = 'info') {
    var alertClass = {
      'info': 'alert-info',
      'success': 'alert-success feedback-positive',
      'warning': 'alert-warning feedback-corrective', 
      'danger': 'alert-danger',
      'guidance': 'alert-info feedback-guidance'
    }[type] || 'alert-info';
    
    var icon = {
      'info': 'fas fa-info-circle',
      'success': 'fas fa-check-circle',
      'warning': 'fas fa-exclamation-triangle',
      'danger': 'fas fa-times-circle',
      'guidance': 'fas fa-lightbulb'
    }[type] || 'fas fa-info-circle';
    
    var html = '<div class="alert ' + alertClass + ' feedback-animation">';
    html += '<i class="' + icon + '"></i> ' + message;
    html += '</div>';
    
    $('#feedback-panel').html(html);
    
    // è®°å½•åé¦ˆå†å²
    clinicalSession.feedbackHistory.push({
      timestamp: new Date(),
      stage: clinicalSession.currentStage,
      message: message,
      type: type
    });
  }
  
  function showErrorMessage(message) {
    showFeedbackMessage('é”™è¯¯ï¼š' + message, 'danger');
  }
  
  function addToLearningTimeline(action, detail) {
    var timestamp = new Date().toLocaleTimeString();
    var html = '<div class="timeline-item">';
    html += '<div class="d-flex justify-content-between">';
    html += '<strong>' + action + '</strong>';
    html += '<small class="text-muted">' + timestamp + '</small>';
    html += '</div>';
    html += '<div class="text-muted small">' + detail + '</div>';
    html += '</div>';
    
    $('#learning-timeline').prepend(html);
    
    // ä¿æŒæœ€å¤šæ˜¾ç¤º10æ¡è®°å½•
    var items = $('#learning-timeline .timeline-item');
    if (items.length > 10) {
      items.slice(10).remove();
    }
  }
  
  function updateTimeSpent() {
    var now = new Date();
    var elapsed = Math.floor((now - clinicalSession.startTime) / 1000); // ç§’
    var minutes = Math.floor(elapsed / 60);
    var seconds = elapsed % 60;
    
    var timeStr = String(minutes).padStart(2, '0') + ':' + String(seconds).padStart(2, '0');
    $('#time-spent').text(timeStr);
  }
  
  function updateStageProgress() {
    var stages = clinicalSession.stages;
    var currentIndex = stages.indexOf(clinicalSession.currentStage);
    var progress = ((currentIndex + 1) / stages.length) * 100;
    
    $('#overall-progress').css('width', progress + '%');
    $('#current-stage-text').text(getStageDisplayName(clinicalSession.currentStage));
  }
  
  function getStageDisplayName(stage) {
    var names = {
      'history': 'ç—…å²é‡‡é›†',
      'examination': 'æ£€æŸ¥é€‰æ‹©',
      'diagnosis': 'è¯Šæ–­æ¨ç†',
      'treatment': 'æ²»ç–—å†³ç­–',
      'feedback': 'å­¦ä¹ åé¦ˆ'
    };
    return names[stage] || stage;
  }
  
  function saveCurrentProgress() {
    // ä¿å­˜å½“å‰å­¦ä¹ è¿›åº¦åˆ°æœ¬åœ°å­˜å‚¨
    var progressData = {
      caseId: clinicalSession.caseId,
      stage: clinicalSession.currentStage,
      selectedExaminations: clinicalSession.selectedExaminations,
      selectedDiagnosis: clinicalSession.selectedDiagnosis,
      selectedTreatments: clinicalSession.selectedTreatments,
      notes: $('#clinical-notes').val(),
      timestamp: new Date().toISOString()
    };
    
    localStorage.setItem('clinical_progress_' + clinicalSession.caseId, JSON.stringify(progressData));
  }
  
  function loadSavedProgress() {
    // å°è¯•åŠ è½½ä¹‹å‰ä¿å­˜çš„è¿›åº¦
    var saved = localStorage.getItem('clinical_progress_' + clinicalSession.caseId);
    if (saved) {
      try {
        var progressData = JSON.parse(saved);
        // å¦‚æœæ˜¯å½“å¤©çš„è¿›åº¦ï¼Œåˆ™æ¢å¤
        var savedTime = new Date(progressData.timestamp);
        var now = new Date();
        if (now.toDateString() === savedTime.toDateString()) {
          return progressData;
        }
      } catch (e) {
        console.log('Failed to load saved progress:', e);
      }
    }
    return null;
  }
  
  // ==================== ä¸»ç¨‹åºå…¥å£å’Œäº‹ä»¶ç»‘å®š ====================
  
  $(document).ready(function() {
    // åˆå§‹åŒ–æ—¶é—´æ˜¾ç¤ºæ›´æ–°
    setInterval(updateTimeSpent, 1000);
    
    // å°è¯•æ¢å¤ä¹‹å‰çš„å­¦ä¹ è¿›åº¦
    var savedProgress = loadSavedProgress();
    if (savedProgress && confirm('æ£€æµ‹åˆ°ä¹‹å‰çš„å­¦ä¹ è¿›åº¦ï¼Œæ˜¯å¦ç»§ç»­ä¹‹å‰çš„å­¦ä¹ ï¼Ÿ')) {
      // æ¢å¤è¿›åº¦é€»è¾‘
      clinicalSession.currentStage = savedProgress.stage;
      clinicalSession.selectedExaminations = savedProgress.selectedExaminations || [];
      clinicalSession.selectedDiagnosis = savedProgress.selectedDiagnosis;
      clinicalSession.selectedTreatments = savedProgress.selectedTreatments || [];
      $('#clinical-notes').val(savedProgress.notes || '');
    }
    
    // å¼€å§‹ç—…å²é˜¶æ®µ
    initializeHistoryStage();
    
    // ç»‘å®šå¯¼èˆªæŒ‰é’®äº‹ä»¶
    $('#btn-next').on('click', function() {
      handleNextStage();
    });

    $('#btn-prev').on('click', function() {
      handlePreviousStage();
    });
    
    // ç»‘å®šä¸´åºŠç¬”è®°è‡ªåŠ¨ä¿å­˜
    $('#clinical-notes').on('input', function() {
      clearTimeout(window.notesSaveTimeout);
      window.notesSaveTimeout = setTimeout(saveCurrentProgress, 2000);
    });
    
    // é¡µé¢ç¦»å¼€æ—¶ä¿å­˜è¿›åº¦
    $(window).on('beforeunload', function() {
      saveCurrentProgress();
    });
  });
  
  function handleNextStage() {
    var currentStage = clinicalSession.currentStage;
    
    switch (currentStage) {
      case 'history':
        // è®°å½•ç—…å²é˜¶æ®µç”¨æ—¶
        clinicalSession.timeSpent.history = new Date() - clinicalSession.timeSpent.history;
        loadExaminationStage();
        break;
        
      case 'examination':
        if (clinicalSession.selectedExaminations.length === 0) {
          showFeedbackMessage('è¯·è‡³å°‘é€‰æ‹©ä¸€é¡¹æ£€æŸ¥', 'warning');
          return;
        }
        submitExaminations();
        break;
        
      case 'diagnosis':
        if (!clinicalSession.selectedDiagnosis) {
          showFeedbackMessage('è¯·é€‰æ‹©ä¸€ä¸ªè¯Šæ–­', 'warning');
          return;
        }
        submitDiagnosis();
        break;
        
      case 'treatment':
        if (clinicalSession.selectedTreatments.length === 0) {
          showFeedbackMessage('è¯·é€‰æ‹©è‡³å°‘ä¸€ç§æ²»ç–—æ–¹æ¡ˆ', 'warning');
          return;
        }
        submitTreatments();
        break;
        
      default:
        showFeedbackMessage('å½“å‰é˜¶æ®µæ— æ³•ç»§ç»­', 'warning');
    }
  }
  
  function handlePreviousStage() {
    var currentStage = clinicalSession.currentStage;
    var stages = clinicalSession.stages;
    var currentIndex = stages.indexOf(currentStage);
    
    if (currentIndex > 0) {
      var previousStage = stages[currentIndex - 1];
      
      // ç®€å•çš„è¿”å›é€»è¾‘ - å®é™…åº”ç”¨ä¸­å¯èƒ½éœ€è¦æ›´å¤æ‚çš„çŠ¶æ€æ¢å¤
      if (previousStage === 'history') {
        initializeHistoryStage();
      } else if (previousStage === 'examination') {
        loadExaminationStage();
      }
      // å¯ä»¥ç»§ç»­æ·»åŠ å…¶ä»–é˜¶æ®µçš„è¿”å›é€»è¾‘
    }
  }
  
  // è¿™é‡Œçœç•¥äº†submitExaminationChoices, submitDiagnosisChoice, submitTreatmentChoicesç­‰å‡½æ•°
  // è¿™äº›å‡½æ•°ä¼šè°ƒç”¨å®é™…çš„APIï¼Œå¹¶å¤„ç†æœåŠ¡å™¨å“åº”
  // ç”±äºç¯‡å¹…é™åˆ¶ï¼Œä¿æŒåŸæœ‰çš„ç®€åŒ–APIè°ƒç”¨é€»è¾‘
  
})();
</script>
{% endblock %}