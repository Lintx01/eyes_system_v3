{% extends 'base.html' %}
{% load static %}

{% block title %}ä¸´åºŠæ¨ç† - {{ clinical_case.title }}{% endblock %}

{% block content %}
{% csrf_token %}
<div class="container-fluid mt-4">
  <!-- ä¸´åºŠæ¨ç†ç³»ç»Ÿæ ‡é¢˜ -->
  <div class="row mb-4">
    <div class="col-12 text-center">
      <h2 class="text-primary">
        <i class="fas fa-user-md"></i> ä¸´åºŠæ¨ç†å­¦ä¹ ç³»ç»Ÿ
        <small class="text-muted d-block mt-2">åŸºäºçœŸå®æ¡ˆä¾‹çš„ä¸´åºŠæ€ç»´è®­ç»ƒ</small>
      </h2>
    </div>
  </div>
  
  <!-- ä¸´åºŠæŒ‡å¯¼æç¤ºåŒºåŸŸ -->
  <div class="row mb-3">
    <div class="col-12">
      <div id="clinical-guidance">
        <!-- åŠ¨æ€ä¸´åºŠæŒ‡å¯¼å†…å®¹ -->
      </div>
    </div>
  </div>
  
  <!-- æ­¥éª¤è¿›åº¦æ¡ -->
  <div class="row mb-4">
    <div class="col-12">
      <div class="progress-stepper">
        <div class="stepper-items">
          <div class="stepper-item active" data-step="history">
            <div class="stepper-icon">1</div>
            <div class="stepper-title">ç—…å²é‡‡é›†</div>
          </div>
          <div class="stepper-item" data-step="examination">
            <div class="stepper-icon">2</div>
            <div class="stepper-title">æ£€æŸ¥é€‰æ‹©</div>
          </div>
          <div class="stepper-item" data-step="diagnosis">
            <div class="stepper-icon">3</div>
            <div class="stepper-title">è¯Šæ–­æ¨ç†</div>
          </div>
          <div class="stepper-item" data-step="treatment">
            <div class="stepper-icon">4</div>
            <div class="stepper-title">æ²»ç–—æ–¹æ¡ˆ</div>
          </div>
          <div class="stepper-item" data-step="feedback">
            <div class="stepper-icon">5</div>
            <div class="stepper-title">å­¦ä¹ åé¦ˆ</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="row">
    <!-- ä¸»è¦å­¦ä¹ å†…å®¹åŒºåŸŸ -->
    <div class="col-lg-8">
      <div class="card mb-3 shadow-sm">
        <div class="card-header bg-light">
          <!-- ç—…ä¾‹ä¿¡æ¯å¡ç‰‡åŒºåŸŸ -->
          <div class="mb-3">
            <div class="d-flex flex-wrap gap-2 align-items-center">
              <!-- ç—…ä¾‹åç§°å¡ç‰‡ -->
              <div class="case-info-card" style="background: linear-gradient(135deg, #e3f2fd, #bbdefb); border: 1px solid #2196f3; border-radius: 8px; padding: 8px 12px; display: inline-flex; align-items: center;">
                <i class="fas fa-eye text-primary me-2" style="font-size: 0.9em;"></i>
                <span class="fw-bold text-primary" id="case-title" style="font-size: 0.9rem;">{{ clinical_case.title }}</span>
              </div>
              
              <!-- é˜¶æ®µçŠ¶æ€å¡ç‰‡ -->
              <div class="stage-info-card" style="background: linear-gradient(135deg, #e8f5e8, #c8e6c8); border: 1px solid #4caf50; border-radius: 8px; padding: 8px 12px; display: inline-flex; align-items: center;">
                <i class="fas fa-tasks text-success me-2" style="font-size: 0.9em;"></i>
                <span class="fw-bold text-success" id="current-stage-badge" style="font-size: 0.9rem;">ç—…å²é‡‡é›†é˜¶æ®µ</span>
              </div>
            </div>
          </div>
          
          <!-- æ‚£è€…åŸºç¡€ä¿¡æ¯ -->
          <div class="patient-basic-info" id="patient-info">
            <div class="text-muted" style="font-size: 0.95rem; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;">
              <span style="color: #495057; font-weight: 600;">åŸºç¡€ä¿¡æ¯ï¼š</span>
              <span style="font-weight: 500;">{{ clinical_case.patient_age }}å² {{ clinical_case.get_patient_gender_display }}</span>
              <span style="margin: 0 12px; color: #6c757d;">â€¢</span>
              <span style="font-weight: 500;">ç¼–å·ï¼š{{ clinical_case.case_id }}</span>
              {% if clinical_case.patient_occupation %}
                <span style="margin: 0 12px; color: #6c757d;">â€¢</span>
                <span style="font-weight: 500;">èŒä¸šï¼š{{ clinical_case.patient_occupation }}</span>
              {% endif %}
            </div>
          </div>
        </div>
        <div class="card-body">
          <!-- é™æ€æç¤ºåŒºåŸŸ -->
          <div id="start-examination-hint" class="start-examination-prompt" style="display: none;">
            <div class="text-center p-3 bg-light rounded border" style="background-color: #f8f9fa;">
              <h5 class="text-primary fw-bold mb-2" style="font-size: 1.2rem;">å‡†å¤‡å¼€å§‹æ£€æŸ¥</h5>
              <p class="text-muted mb-0" style="font-size: 0.9rem;">ç‚¹å‡»ä¸‹æ–¹"æŸ¥çœ‹æ£€æŸ¥ç»“æœ"æŒ‰é’®å¼€å§‹é€ä¸€æŸ¥çœ‹æ£€æŸ¥ç»“æœ</p>
            </div>
          </div>
          
          <div id="stage-content">
            <div class="text-center p-5">
              <i class="fas fa-spinner fa-spin fa-2x text-primary"></i>
              <p class="mt-3">æ­£åœ¨åŠ è½½ä¸´åºŠæ¡ˆä¾‹æ•°æ®...</p>
            </div>
          </div>
        </div>
      </div>

      <!-- å¯¼èˆªæ§åˆ¶é¢æ¿ -->
      <div class="card" id="navigation-card">
        <div class="card-body">
          <!-- æŒ‰é’®è¡Œ -->
          <div class="d-flex justify-content-between align-items-center mb-3">
            <button class="btn btn-outline-secondary" id="btn-prev" disabled>
              <i class="fas fa-arrow-left me-1"></i> ä¸Šä¸€æ­¥
            </button>
            <button class="btn btn-primary" id="btn-next">
              ä¸‹ä¸€æ­¥ <i class="fas fa-arrow-right ms-1"></i>
            </button>
          </div>
          
          <!-- è¿›åº¦ä¿¡æ¯è¡Œ -->
          <div class="text-center">
            <small class="text-muted d-block mb-2">ä¸´åºŠæ¨ç†è¿›åº¦</small>
            <div style="width: 350px; height: 15px; background-color: #e9ecef; border-radius: 10px; margin: 0 auto; overflow: hidden; border: 1px solid #dee2e6;" class="progress-container">
              <div id="overall-progress" style="height: 100%; background: linear-gradient(90deg, #007bff, #0056b3); border-radius: 10px; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 0.8em; width: 25%; transition: width 0.6s ease;" role="progressbar">
                25%
              </div>
            </div>
            <small class="text-muted d-block mt-2" id="progress-text">æ­¥éª¤ 1/4 (25%)</small>
          </div>
        </div>
      </div>
    </div>

    <!-- ä¾§è¾¹å·¥å…·å’Œåé¦ˆåŒºåŸŸ -->
    <div class="col-lg-4">
      <!-- ä¸´åºŠè®°å½•é¢æ¿ -->
      <div class="card mb-3 border-primary">
        <div class="card-header bg-primary text-white">
          <h6 class="mb-0"><i class="fas fa-clipboard"></i> ä¸´åºŠè®°å½•</h6>
        </div>
        <div class="card-body">
          <div class="nav nav-pills mb-3" id="clinical-tabs" role="tablist">
            <a class="nav-item nav-link active" id="notes-tab" data-toggle="pill" href="#notes-panel" role="tab">ç¬”è®°</a>
            <a class="nav-item nav-link" id="timeline-tab" data-toggle="pill" href="#timeline-panel" role="tab">æ—¶é—´çº¿</a>
          </div>
          <div class="tab-content">
            <div class="tab-pane fade show active" id="notes-panel">
              <textarea id="clinical-notes" class="form-control" rows="5" placeholder="è®°å½•ä¸´åºŠæ€è€ƒè¿‡ç¨‹ã€é‰´åˆ«è¯Šæ–­è¦ç‚¹..."></textarea>
              <small class="text-muted mt-2 d-block">
                <i class="fas fa-lightbulb"></i> è®°å½•æ€ç»´è¿‡ç¨‹æœ‰åŠ©äºä¸´åºŠèƒ½åŠ›æå‡
              </small>
            </div>
            <div class="tab-pane fade" id="timeline-panel">
              <div id="learning-timeline">
                <small class="text-muted">å­¦ä¹ è¿›ç¨‹å°†åœ¨æ­¤æ˜¾ç¤º</small>
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <!-- å®æ—¶åé¦ˆé¢æ¿ -->
      <div class="card mb-3">
        <div class="card-header bg-success text-white">
          <h6 class="mb-0"><i class="fas fa-comments"></i> æ™ºèƒ½æŒ‡å¯¼</h6>
        </div>
        <div class="card-body" id="feedback-panel">
          <div class="text-center text-muted">
            <i class="fas fa-robot fa-2x mb-2"></i>
            <p class="mb-0">AIåŠ©æ•™å°†ä¸ºæ‚¨æä¾›å®æ—¶æŒ‡å¯¼</p>
          </div>
        </div>
      </div>
      
      <!-- å­¦ä¹ ç»Ÿè®¡é¢æ¿ -->
      <div class="card">
        <div class="card-header">
          <h6 class="mb-0"><i class="fas fa-chart-line"></i> å­¦ä¹ ç»Ÿè®¡</h6>
        </div>
        <div class="card-body">
          <div id="learning-stats">
            <div class="row text-center">
              <div class="col-6">
                <div class="border-right">
                  <div class="h4 mb-0" id="time-spent">00:00</div>
                  <small class="text-muted">ç”¨æ—¶</small>
                </div>
              </div>
              <div class="col-6">
                <div class="h4 mb-0" id="current-score">--</div>
                <small class="text-muted">å½“å‰å¾—åˆ†</small>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
/* ==================== ä¸´åºŠæ¨ç†ç³»ç»Ÿæ ·å¼ ==================== */

/* å¯¼èˆªæŒ‰é’®ç»Ÿä¸€æ ·å¼ */
#btn-prev, #btn-next {
  min-width: 120px;
  height: 40px;
  font-size: 14px;
  font-weight: 500;
  border-radius: 8px;
  transition: all 0.3s ease;
}

#btn-prev {
  border: 2px solid #6c757d;
  color: #6c757d;
}

#btn-prev:hover:not(:disabled) {
  background-color: #6c757d;
  color: white;
  transform: translateY(-1px);
}

#btn-next {
  background: linear-gradient(135deg, #007bff, #0056b3);
  border: none;
  color: white;
}

#btn-next:hover:not(:disabled) {
  background: linear-gradient(135deg, #0056b3, #004085);
  transform: translateY(-1px);
  box-shadow: 0 4px 8px rgba(0, 123, 255, 0.3);
}

#btn-prev:disabled, #btn-next:disabled {
  opacity: 0.5;
  cursor: not-allowed;
  transform: none;
}

/* è¿›åº¦æ¡æ ·å¼ä¼˜åŒ– */
.progress-container {
  position: relative;
  border: 1px solid #dee2e6;
  background-color: #e9ecef;
  border-radius: 10px;
  overflow: hidden;
  height: 15px;
  max-width: 350px;
  margin: 0 auto;
}

#overall-progress {
  height: 100%;
  border-radius: 10px;
  display: flex;
  align-items: center;
  justify-content: center;
  color: white;
  font-weight: bold;
  font-size: 0.8em;
  transition: width 0.6s ease, background 0.3s ease;
  min-width: 30px; /* ç¡®ä¿ç™¾åˆ†æ¯”æ–‡å­—æœ‰è¶³å¤Ÿç©ºé—´ */
}

/* æ£€æŸ¥ç»“æœå°å¡ç‰‡æ ·å¼ */
.exam-result-card {
  background: white;
  border: 1px solid #e3e6f0;
  border-radius: 12px;
  padding: 0;
  transition: all 0.3s ease;
  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
  overflow: hidden;
}

.exam-result-card:hover {
  transform: translateY(-2px);
  box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1);
  border-color: #007bff;
}

.exam-header {
  background: linear-gradient(135deg, #f8f9fa, #e9ecef);
  padding: 1rem 1.25rem;
  border-bottom: 1px solid #e3e6f0;
}

.exam-title {
  display: flex;
  align-items: center;
  font-size: 1.1rem;
}

.exam-content {
  padding: 1.25rem;
}

.result-label {
  font-size: 0.875rem;
  font-weight: 600;
  color: #6c757d;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  margin-bottom: 0.5rem;
}

.result-text {
  font-size: 0.95rem;
  line-height: 1.6;
  color: #495057;
  background: #f8f9fa;
  padding: 0.75rem 1rem;
  border-radius: 8px;
  border-left: 4px solid #007bff;
  margin: 0;
}

/* ç‰¹æ®Šæ£€æŸ¥ç»“æœæ ·å¼ */
.exam-result-card .fas.fa-eye {
  font-size: 1.1em;
  color: #007bff;
}

.exam-result-card .badge {
  font-size: 0.75rem;
  padding: 0.4em 0.8em;
  border-radius: 6px;
}

/* å“åº”å¼è®¾è®¡ */
@media (max-width: 768px) {
  .exam-header {
    padding: 0.875rem 1rem;
  }
  
  .exam-content {
    padding: 1rem;
  }
  
  .exam-title {
    font-size: 1rem;
  }
  
  .result-text {
    font-size: 0.9rem;
    padding: 0.625rem 0.875rem;
  }
}

/* æ²»ç–—æ–¹æ¡ˆåˆ†ææ ·å¼ä¼˜åŒ– */
.treatment-summary .card {
  border: none;
  background: linear-gradient(135deg, #f8f9fa, #e9ecef);
}

.treatment-summary .card-body {
  padding: 1.5rem;
}

.treatment-summary .bg-white {
  background: white !important;
  transition: all 0.3s ease;
  border: 1px solid #dee2e6 !important;
}

.treatment-summary .bg-white:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
  border-color: #007bff !important;
}

.treatment-summary .h4 {
  font-weight: 600;
  font-size: 1.8rem;
}

.treatment-summary .fw-500 {
  font-weight: 500;
}

.treatment-summary .rounded {
  border-radius: 8px !important;
}

/* å“åº”å¼ä¼˜åŒ– */
@media (max-width: 768px) {
  .treatment-summary .h4 {
    font-size: 1.5rem;
  }
  
  .treatment-summary .card-body {
    padding: 1rem;
  }
}

/* å­¦ä¹ å®Œæˆé¡µé¢æŒ‰é’®ç»Ÿä¸€æ ·å¼ - å±…ä¸­å¸ƒå±€ */
.action-buttons {
  width: 100%;
  display: flex;
  justify-content: center;
  align-items: center;
}

.action-buttons .btn {
  height: 50px;
  font-size: 15px;
  font-weight: 500;
  padding: 12px 20px;
  border-radius: 8px;
  transition: all 0.3s ease;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  text-decoration: none;
  border-width: 2px;
  white-space: nowrap;
  flex-grow: 1;
  max-width: none;
}

.action-buttons .btn i {
  margin-right: 8px;
  font-size: 1.1em;
  width: 16px;
  text-align: center;
}

.action-buttons .btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 6px 16px rgba(0, 0, 0, 0.15);
  text-decoration: none;
}

/* ç¡®ä¿outlineæ ·å¼çš„æŒ‰é’®ä¹Ÿæœ‰ç›¸åŒçš„è§†è§‰æ•ˆæœ */
.action-buttons .btn-outline-primary:hover {
  background-color: #007bff;
  border-color: #007bff;
  color: white;
}

.action-buttons .btn-outline-secondary:hover {
  background-color: #6c757d;
  border-color: #6c757d;
  color: white;
}

.action-buttons .btn-outline-success:hover {
  background-color: #28a745;
  border-color: #28a745;
  color: white;
}

/* æŒ‰é’®é—´è·è°ƒæ•´ */
.action-buttons .mx-2 {
  margin-left: 8px !important;
  margin-right: 8px !important;
}

/* æŒ‰é’®ç»„å®¹å™¨æ ·å¼ */
.action-buttons .d-flex[style*="max-width"] {
  justify-content: space-between;
  gap: 0;
}

/* å“åº”å¼è®¾è®¡ - å°å±å¹•æ—¶å †å æŒ‰é’® */
@media (max-width: 768px) {
  .action-buttons .d-flex[style*="max-width"] {
    flex-direction: column;
    gap: 10px;
    max-width: 300px !important;
  }
  
  .action-buttons .btn {
    margin: 0 !important;
    height: 45px;
    font-size: 14px;
  }
}

/* è¿›åº¦æŒ‡ç¤ºå™¨æ ·å¼ä¼˜åŒ– */
.progress-stepper {
  display: flex;
  justify-content: center;
  margin-bottom: 2rem;
  padding: 1rem;
  background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
  border-radius: 15px;
}

.stepper-items {
  display: flex;
  align-items: center;
  justify-content: space-between;
  width: 100%;
  max-width: 700px;
}

.stepper-item {
  display: flex;
  flex-direction: column;
  align-items: center;
  text-align: center;
  flex: 1;
  position: relative;
  transition: all 0.3s ease;
}

.stepper-item:not(:last-child)::after {
  content: '';
  position: absolute;
  top: 20px;
  left: 60%;
  width: 80%;
  height: 3px;
  background: linear-gradient(90deg, #dee2e6 0%, #ced4da 100%);
  z-index: 1;
  border-radius: 2px;
}

.stepper-item.active::after {
  background: linear-gradient(90deg, #007bff 0%, #0056b3 100%);
  box-shadow: 0 2px 4px rgba(0, 123, 255, 0.3);
}

.stepper-item.completed::after {
  background: linear-gradient(90deg, #28a745 0%, #1e7e34 100%);
  box-shadow: 0 2px 4px rgba(40, 167, 69, 0.3);
}

.stepper-icon {
  width: 45px;
  height: 45px;
  border-radius: 50%;
  background: linear-gradient(135deg, #e9ecef 0%, #ced4da 100%);
  color: #6c757d;
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: bold;
  font-size: 1.1rem;
  margin-bottom: 8px;
  position: relative;
  z-index: 2;
  border: 3px solid #fff;
  box-shadow: 0 4px 8px rgba(0,0,0,0.1);
  transition: all 0.3s ease;
}

.stepper-item.active .stepper-icon {
  background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
  color: white;
  transform: scale(1.1);
  box-shadow: 0 6px 12px rgba(0, 123, 255, 0.4);
  animation: pulse 2s infinite;
}

.stepper-item.completed .stepper-icon {
  background: linear-gradient(135deg, #28a745 0%, #1e7e34 100%);
  color: white;
  box-shadow: 0 4px 8px rgba(40, 167, 69, 0.3);
}

.stepper-item.thinking .stepper-icon {
  animation: thinking 1.5s ease-in-out infinite;
}

@keyframes pulse {
  0% { box-shadow: 0 6px 12px rgba(0, 123, 255, 0.4); }
  50% { box-shadow: 0 8px 16px rgba(0, 123, 255, 0.6); }
  100% { box-shadow: 0 6px 12px rgba(0, 123, 255, 0.4); }
}

@keyframes thinking {
  0%, 100% { transform: scale(1.1); }
  50% { transform: scale(1.05); }
}

.stepper-title {
  font-size: 0.9rem;
  color: #6c757d;
  margin-top: 4px;
  font-weight: 500;
  transition: all 0.3s ease;
}

.stepper-item.active .stepper-title {
  color: #007bff;
  font-weight: 600;
  transform: translateY(-2px);
}

.stepper-item.completed .stepper-title {
  color: #28a745;
  font-weight: 600;
}

/* ä¸´åºŠæŒ‡å¯¼åŒºåŸŸæ ·å¼ */
.clinical-guidance {
  border-left: 4px solid #007bff;
  background: linear-gradient(135deg, #f8f9ff 0%, #e6f3ff 100%);
  animation: slideIn 0.5s ease-out;
}

@keyframes slideIn {
  from { opacity: 0; transform: translateY(-10px); }
  to { opacity: 1; transform: translateY(0); }
}

.clinical-tips ul {
  list-style: none;
  padding-left: 0;
}

.clinical-tips li {
  position: relative;
  padding-left: 20px;
  margin-bottom: 5px;
}

.clinical-tips li::before {
  content: 'ğŸ’¡';
  position: absolute;
  left: 0;
  top: 0;
}

/* ç—…å²åˆ†æå·¥å…·æ ·å¼ */
/* ç—…å²é‡‡é›†é˜¶æ®µä¸“ç”¨æ ·å¼ */
.patient-history {
  animation: fadeInUp 0.6s ease-out;
}

.info-item {
  padding: 15px;
  border-radius: 8px;
  background: rgba(255, 255, 255, 0.8);
  transition: all 0.3s ease;
  border: 1px solid rgba(0,0,0,0.05);
}

.info-item:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(0,0,0,0.1);
  background: rgba(255, 255, 255, 0.95);
}

.chief-complaint-content blockquote {
  border-left: 4px solid #ff6b6b;
  padding-left: 20px;
  background: rgba(255, 107, 107, 0.05);
  border-radius: 0 8px 8px 0;
}

.illness-timeline {
  position: relative;
}

.formatted-history {
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  line-height: 1.8;
}

.time-marker {
  display: inline-block;
  animation: pulseGlow 2s infinite;
}

.symptom-highlight {
  display: inline-block;
  animation: highlightPulse 3s infinite;
}

@keyframes pulseGlow {
  0%, 100% { box-shadow: 0 0 5px rgba(52, 152, 219, 0.3); }
  50% { box-shadow: 0 0 15px rgba(52, 152, 219, 0.6); }
}

@keyframes highlightPulse {
  0%, 100% { box-shadow: 0 0 3px rgba(231, 76, 60, 0.2); }
  50% { box-shadow: 0 0 8px rgba(231, 76, 60, 0.4); }
}

/* åŒ»å­¦ç—…å²éƒ¨åˆ†æ ·å¼ */
.medical-history-sections {
  margin-top: 20px;
}

.medical-history-sections .card {
  transition: all 0.3s ease;
}

.medical-history-sections .card:hover {
  transform: translateY(-2px);
  box-shadow: 0 8px 25px rgba(0,0,0,0.15);
}

/* å›¾æ ‡å®¹å™¨åŠ¨ç”» */
.icon-container {
  transition: all 0.3s ease;
}

.card:hover .icon-container {
  transform: rotate(5deg) scale(1.1);
}

/* çœ¼åº•æ£€æŸ¥æç¤ºå­—å¹•æ ·å¼ */
#fundus-overlay {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.3);
  display: flex;
  justify-content: center;
  align-items: center;
  z-index: 9999;
  pointer-events: none;
  user-select: none;
  opacity: 0;
  transition: opacity 0.8s ease-in-out;
}

#fundus-overlay.show {
  opacity: 1;
}

#fundus-subtitle {
  background: rgba(0, 0, 0, 0.75);
  color: white;
  font-size: 2rem;
  font-weight: bold;
  padding: 20px 40px;
  border-radius: 15px;
  text-align: center;
  letter-spacing: 2px;
  text-shadow: 2px 2px 8px rgba(0, 0, 0, 0.8);
  backdrop-filter: blur(15px);
  border: 3px solid rgba(255, 255, 255, 0.2);
  box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
  transform: translateY(20px);
  transition: all 0.8s ease-out;
  animation: pulse-glow 3s ease-in-out infinite;
}

#fundus-overlay.show #fundus-subtitle {
  transform: translateY(0);
}

@keyframes pulse-glow {
  0%, 100% {
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5), 0 0 20px rgba(255, 255, 255, 0.1);
  }
  50% {
    box-shadow: 0 15px 40px rgba(0, 0, 0, 0.6), 0 0 30px rgba(255, 255, 255, 0.2);
  }
}

/* çœ¼åº•æ£€æŸ¥ç»“æœç•™ç™½æ ·å¼ */
.fundus-examination-blank {
  background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
  border: 2px dashed #6c757d;
  border-radius: 15px;
  padding: 80px 40px;
  text-align: center;
  color: #6c757d;
  position: relative;
  overflow: hidden;
}

.fundus-examination-blank::before {
  content: "";
  position: absolute;
  top: 0;
  left: -100%;
  width: 100%;
  height: 100%;
  background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
  animation: shine 3s ease-in-out infinite;
}

@keyframes shine {
  0% { left: -100%; }
  50% { left: 100%; }
  100% { left: 100%; }
}

.fundus-examination-blank .icon {
  font-size: 4rem;
  margin-bottom: 20px;
  opacity: 0.5;
}

.fundus-examination-blank .message {
  font-size: 1.5rem;
  font-weight: 500;
  margin-bottom: 10px;
}

.fundus-examination-blank .submessage {
  font-size: 1.1rem;
  opacity: 0.8;
}

@media (max-width: 768px) {
  #fundus-subtitle {
    font-size: 1.4rem !important;
    padding: 15px 25px !important;
    max-width: 90% !important;
  }
  
  .fundus-examination-blank {
    padding: 60px 20px;
  }
  
  .fundus-examination-blank .icon {
    font-size: 3rem;
  }
  
  .fundus-examination-blank .message {
    font-size: 1.2rem;
  }
  
  .fundus-examination-blank .submessage {
    font-size: 1rem;
  }
}

/* ç—…ä¾‹ä¿¡æ¯å¡ç‰‡æ ·å¼ */
.case-info-card, .stage-info-card {
  transition: all 0.3s ease;
  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
}

.case-info-card:hover, .stage-info-card:hover {
  transform: translateY(-1px);
  box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
}

.case-info-card {
  background: linear-gradient(135deg, #e3f2fd, #bbdefb) !important;
  border: 1px solid #2196f3 !important;
}

.stage-info-card {
  background: linear-gradient(135deg, #e8f5e8, #c8e6c8) !important;
  border: 1px solid #4caf50 !important;
}

/* ä¸åŒé˜¶æ®µçš„å¡ç‰‡é¢œè‰² */
.stage-info-card.stage-history {
  background: linear-gradient(135deg, #e8f5e8, #c8e6c8) !important;
  border-color: #4caf50 !important;
}

.stage-info-card.stage-examination {
  background: linear-gradient(135deg, #fff3e0, #ffe0b2) !important;
  border-color: #ff9800 !important;
}

.stage-info-card.stage-diagnosis {
  background: linear-gradient(135deg, #f3e5f5, #e1bee7) !important;
  border-color: #9c27b0 !important;
}

.stage-info-card.stage-treatment {
  background: linear-gradient(135deg, #e0f2f1, #b2dfdb) !important;
  border-color: #009688 !important;
}

.stage-info-card.stage-complete {
  background: linear-gradient(135deg, #e8f5e8, #c8e6c8) !important;
  border-color: #4caf50 !important;
}

/* å“åº”å¼è®¾è®¡ */
@media (max-width: 576px) {
  .case-info-card, .stage-info-card {
    flex: 1;
    min-width: 0;
    justify-content: center;
  }
}

/* æ‚£è€…ä¿¡æ¯åŒºåŸŸæ ·å¼ */
.patient-basic-info {
  padding: 12px 16px;
  background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
  border-radius: 8px;
  border: 1px solid #dee2e6;
  margin-top: 12px;
  transition: all 0.3s ease;
}

.patient-basic-info:hover {
  background: linear-gradient(135deg, #fff 0%, #f8f9fa 100%);
  box-shadow: 0 2px 8px rgba(0,0,0,0.1);
  transform: translateY(-1px);
}



/* ç—…å²å†…å®¹æç¤ºæ¡† */
.alert-info {
  background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
  border: none;
  border-radius: 8px;
}

.alert-info i {
  color: #1976d2;
}

.symptom-tags .badge {
  margin: 2px;
  font-size: 0.85rem;
  padding: 0.4em 0.8em;
}

.timeline-info {
  background: white;
  padding: 10px;
  border-radius: 5px;
  border-left: 3px solid #007bff;
}

/* æ£€æŸ¥é¡ºåºæ’åˆ—æ ·å¼ */
.examination-order-section {
  background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
  border-radius: 12px;
  padding: 20px;
  border: 1px solid #dee2e6;
}

.examination-order-list {
  min-height: 120px;
  border-radius: 8px;
  transition: all 0.3s ease;
}

.empty-drag-area {
  transition: all 0.4s ease;
}

.empty-drag-area:hover {
  background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%) !important;
  border-color: #2196f3 !important;
  transform: scale(1.02);
}

.examination-order-item {
  cursor: move;
  transition: all 0.3s ease;
  background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%) !important;
  border: 2px solid #2196f3 !important;
  border-radius: 8px;
  position: relative;
  overflow: hidden;
}

.examination-order-item::before {
  content: "";
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  height: 4px;
  background: linear-gradient(90deg, #1976d2, #42a5f5, #64b5f6);
  animation: shimmer 2s ease-in-out infinite;
}

@keyframes shimmer {
  0% { transform: translateX(-100%); }
  50% { transform: translateX(100%); }
  100% { transform: translateX(100%); }
}

.examination-order-item:hover {
  transform: translateY(-3px);
  box-shadow: 0 6px 20px rgba(33, 150, 243, 0.3);
  background: linear-gradient(135deg, #bbdefb 0%, #90caf9 100%) !important;
  border-color: #1976d2 !important;
}

.examination-order-item.dragging {
  opacity: 0.8;
  transform: rotate(3deg) scale(1.05);
  box-shadow: 0 10px 30px rgba(33, 150, 243, 0.4);
  z-index: 1000;
}

.examination-order-item .fas.fa-grip-vertical {
  color: #1976d2;
  font-size: 1.2rem;
  text-shadow: 0 1px 2px rgba(25, 118, 210, 0.3);
  transition: all 0.3s ease;
}

.examination-order-item:hover .fas.fa-grip-vertical {
  color: #0d47a1;
  transform: scale(1.1);
  text-shadow: 0 2px 4px rgba(13, 71, 161, 0.5);
}

.order-number {
  font-size: 1rem;
  font-weight: bold;
  min-width: 40px;
  height: 40px;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.3s ease;
}

.examination-order-item:hover .order-number {
  transform: scale(1.1);
  box-shadow: 0 4px 12px rgba(25, 118, 210, 0.5) !important;
}

.pulse-badge {
  animation: pulse 2s infinite;
}

@keyframes pulse {
  0% {
    box-shadow: 0 0 0 0 rgba(220, 53, 69, 0.7);
  }
  70% {
    box-shadow: 0 0 0 10px rgba(220, 53, 69, 0);
  }
  100% {
    box-shadow: 0 0 0 0 rgba(220, 53, 69, 0);
  }
}

@keyframes pulse-border {
  0% { border-color: #f44336; }
  50% { border-color: #e57373; }
  100% { border-color: #f44336; }
}

@keyframes bounce {
  0%, 20%, 50%, 80%, 100% {
    transform: translateY(0);
  }
  40% {
    transform: translateY(-5px);
  }
  60% {
    transform: translateY(-3px);
  }
}

@keyframes pulse-text {
  0% { opacity: 1; transform: scale(1); }
  50% { opacity: 0.7; transform: scale(1.1); }
  100% { opacity: 1; transform: scale(1); }
}

.pulse-text {
  animation: pulse-text 1.5s ease-in-out infinite;
}

/* å¾—åˆ†è¯¦æƒ…æ ·å¼ */
.score-details-alert {
  border-left: 4px solid #007bff;
  background: linear-gradient(135deg, #f8f9ff 0%, #e6f3ff 100%);
  animation: slideInUp 0.6s ease-out;
}

.score-item {
  padding: 10px;
  background: white;
  border-radius: 8px;
  box-shadow: 0 2px 4px rgba(0,0,0,0.1);
  transition: transform 0.3s ease;
}

.score-item:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 8px rgba(0,0,0,0.15);
}

.score-value {
  font-size: 1.1rem;
  margin-bottom: 2px;
}

.score-label {
  font-weight: 500;
  margin-bottom: 1px;
}

.score-stats {
  font-size: 0.8rem;
}

@keyframes slideInUp {
  from {
    opacity: 0;
    transform: translateY(30px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

.examination-order-section .alert-warning {
  background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%);
  border: 2px solid #ffc107;
  border-radius: 8px;
}

.examination-order-section h5 {
  color: #1976d2;
  text-shadow: 0 1px 2px rgba(25, 118, 210, 0.2);
}



/* æ‹–åŠ¨çŠ¶æ€æ ·å¼ */
.examination-order-list.drag-active {
  background: linear-gradient(135deg, #e8f5e8 0%, #f1f8e9 100%);
  border: 2px dashed #4caf50;
  border-radius: 10px;
  padding: 10px;
}

.examination-order-item.drop-target {
  background: linear-gradient(135deg, #f3e5f5 0%, #e1bee7 100%) !important;
  border-color: #9c27b0 !important;
  opacity: 0.7;
  transform: scale(0.98);
}

.examination-order-item.drag-hover {
  background: linear-gradient(135deg, #fff3e0 0%, #ffcc02 100%) !important;
  border-color: #ff9800 !important;
  transform: translateY(-5px) scale(1.02);
  box-shadow: 0 8px 25px rgba(255, 152, 0, 0.4);
}

.examination-order-item.dragging {
  opacity: 0.8;
  transform: rotate(3deg) scale(1.05);
  box-shadow: 0 10px 30px rgba(33, 150, 243, 0.4);
  z-index: 1000;
  background: linear-gradient(135deg, #c8e6c9 0%, #a5d6a7 100%) !important;
  border-color: #4caf50 !important;
}

.remove-exam-btn {
  opacity: 0;
  transition: opacity 0.3s ease;
}

.examination-order-item:hover .remove-exam-btn {
  opacity: 1;
}

/* å•ä¸ªæ£€æŸ¥ç»“æœå±•ç¤ºæ ·å¼ */
.single-examination-result {
  animation: fadeInUp 0.6s ease-out;
}

.examination-progress .progress {
  background-color: #e9ecef;
  border-radius: 10px;
  overflow: hidden;
}

.examination-progress .progress-bar {
  background: linear-gradient(90deg, #007bff, #0056b3);
  transition: width 0.8s ease;
}

.current-examination-result .card {
  border: 2px solid #007bff;
  box-shadow: 0 8px 25px rgba(0, 123, 255, 0.15);
}

.result-box {
  border-left: 4px solid #007bff !important;
  background: linear-gradient(135deg, #f8f9ff 0%, #e6f3ff 100%) !important;
}

.examination-data .data-item {
  border-left: 3px solid #28a745;
  transition: all 0.3s ease;
}

.examination-data .data-item:hover {
  transform: translateX(5px);
  box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.examination-image {
  transition: all 0.3s ease;
  border: 2px solid transparent;
}

.examination-image:hover {
  transform: scale(1.05);
  border-color: #007bff;
  box-shadow: 0 8px 25px rgba(0, 123, 255, 0.3);
}

/* OCTæ£€æŸ¥ç‰¹æ®Šæ ·å¼ */
.oct-examination-display {
  background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
  border-radius: 12px;
  padding: 20px;
  margin-bottom: 20px;
}

.oct-image-container {
  background: white;
  border-radius: 8px;
  padding: 15px;
  box-shadow: 0 2px 10px rgba(0,0,0,0.1);
  transition: transform 0.3s ease, box-shadow 0.3s ease;
}

.oct-image-container:hover {
  transform: translateY(-3px);
  box-shadow: 0 4px 20px rgba(0,0,0,0.15);
}

.oct-image {
  border-radius: 6px;
  transition: all 0.3s ease;
}

.oct-image:hover {
  filter: brightness(1.05);
}

.eye-section {
  background: white;
  border-radius: 10px;
  padding: 20px;
  box-shadow: 0 2px 15px rgba(0,0,0,0.08);
}

.measurement-card {
  transition: all 0.3s ease;
  text-align: center;
}

.measurement-card:hover {
  transform: translateY(-2px);
  box-shadow: 0 2px 10px rgba(0,0,0,0.1);
}

.measurement-label {
  font-weight: 500;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

.measurement-value {
  font-weight: 600;
  font-family: 'Courier New', monospace;
}

.oct-report .report-content {
  background: white;
  box-shadow: 0 2px 10px rgba(0,0,0,0.05);
}

.image-overlay {
  position: absolute;
  top: 10px;
  right: 10px;
  z-index: 10;
}

.overlay-controls {
  display: flex;
  gap: 5px;
}

.overlay-controls .btn {
  opacity: 0.8;
  backdrop-filter: blur(5px);
  border: none;
}

.overlay-controls .btn:hover {
  opacity: 1;
}

/* æ ‡å‡†å›¾åƒæ˜¾ç¤ºæ ·å¼ */
.standard-image-container {
  background: white;
  border-radius: 8px;
  padding: 15px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.08);
  transition: all 0.3s ease;
}

.standard-image-container:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 15px rgba(0,0,0,0.12);
}

.image-findings {
  border-left: 3px solid #007bff;
}

/* æ£€æŸ¥ç¡®è®¤ç•Œé¢æ ·å¼ */
.examination-confirmed {
  animation: fadeInUp 0.6s ease-out;
}

.examination-sequence-preview .card {
  transition: all 0.3s ease;
}

.examination-sequence-preview .card:hover {
  transform: translateY(-2px);
  box-shadow: 0 8px 25px rgba(0, 123, 255, 0.15);
}

.start-examination-prompt {
  animation: pulse 2s infinite;
}

@keyframes pulse {
  0% { transform: scale(1); }
  50% { transform: scale(1.02); }
  100% { transform: scale(1); }
}

/* ç»§ç»­æç¤ºæ ·å¼ */
.continue-prompt {
  border-top: 2px dashed #dee2e6;
  padding-top: 20px;
  margin-top: 20px;
}

/* å“åº”å¼è®¾è®¡ */
@media (max-width: 768px) {
  .examination-order-section {
    padding: 15px;
  }
  
  .examination-order-item {
    margin-bottom: 10px;
  }
  
  .order-number {
    min-width: 30px;
    height: 30px;
    font-size: 0.9rem;
  }
  
  .current-examination-result .card-header h4 {
    font-size: 1.2rem;
  }
  
  .examination-data .row {
    margin: 0;
  }
  
  .examination-data .col-md-6 {
    padding: 5px;
  }
}

/* è¯Šæ–­é€‰é¡¹æ ·å¼ */
.diagnosis-option {
  border: 2px solid transparent;
  transition: all 0.3s ease;
  cursor: pointer;
}

.diagnosis-option .d-flex {
  align-items: flex-start !important;
}

.diagnosis-option .form-check-input {
  margin-top: 2px !important;
  flex-shrink: 0 !important;
}

.diagnosis-option .form-check-label {
  cursor: pointer;
  margin-bottom: 0 !important;
}

.diagnosis-option:hover {
  border-color: #007bff;
  background-color: #f8f9ff;
}

.diagnosis-option.selected {
  border-color: #007bff;
  background-color: #e6f3ff;
}

/* æ²»ç–—æ–¹æ¡ˆæ ·å¼ */
.treatment-option {
  border-left: 4px solid #dee2e6;
  transition: all 0.3s ease;
}

.treatment-option.optimal {
  border-left-color: #28a745;
}

.treatment-option.acceptable {
  border-left-color: #ffc107;
}

.treatment-option.contraindicated {
  border-left-color: #dc3545;
  background-color: #fff5f5;
}

/* å­¦ä¹ ç»Ÿè®¡é¢æ¿ */
.learning-stats .h4 {
  font-family: 'Courier New', monospace;
  font-weight: bold;
}

/* æ—¶é—´çº¿æ ·å¼ */
.learning-timeline {
  max-height: 200px;
  overflow-y: auto;
}

.timeline-item {
  border-left: 2px solid #e9ecef;
  padding-left: 15px;
  margin-bottom: 10px;
  position: relative;
}

.timeline-item::before {
  content: '';
  position: absolute;
  left: -5px;
  top: 5px;
  width: 8px;
  height: 8px;
  background: #007bff;
  border-radius: 50%;
}

/* å“åº”å¼è®¾è®¡ */
@media (max-width: 768px) {
  .stepper-items {
    flex-direction: column;
    align-items: stretch;
  }
  
  .stepper-item {
    margin-bottom: 20px;
    flex-direction: row;
    justify-content: flex-start;
    text-align: left;
  }
  
  .stepper-item::after {
    display: none;
  }
  
  .stepper-icon {
    margin-right: 15px;
    margin-bottom: 0;
  }
}

/* åé¦ˆé¢æ¿åŠ¨ç”» */
.feedback-animation {
  animation: fadeInUp 0.5s ease-out;
}

@keyframes fadeInUp {
  from {
    opacity: 0;
    transform: translateY(20px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

/* æˆåŠŸåé¦ˆæ ·å¼ */
.feedback-positive {
  border-left: 4px solid #28a745;
  background-color: #d4edda;
}

.feedback-corrective {
  border-left: 4px solid #ffc107;
  background-color: #fff3cd;
}

.feedback-guidance {
  border-left: 4px solid #17a2b8;
  background-color: #d1ecf1;
}

/* åŠ¨ç”»æ•ˆæœæ ·å¼ */
.confetti-piece {
  border-radius: 2px;
  box-shadow: 0 1px 2px rgba(0,0,0,0.15);
}

.flash-success {
  animation: flashSuccess 0.9s ease-in-out;
}

.flash-warning {
  animation: flashWarning 0.9s ease-in-out;
}

@keyframes flashSuccess {
  0% { transform: scale(1); box-shadow: 0 0 0 rgba(40,167,69,0); }
  30% { transform: scale(1.04); box-shadow: 0 10px 30px rgba(40,167,69,0.18); }
  100% { transform: scale(1); box-shadow: 0 0 0 rgba(40,167,69,0); }
}

@keyframes flashWarning {
  0% { transform: scale(1); box-shadow: 0 0 0 rgba(255,193,7,0); }
  30% { transform: scale(1.04); box-shadow: 0 10px 30px rgba(255,193,7,0.18); }
  100% { transform: scale(1); box-shadow: 0 0 0 rgba(255,193,7,0); }
}

.step-highlight {
  animation: stepPulse 0.8s ease-out;
}

@keyframes stepPulse {
  0% { transform: scale(1); box-shadow: 0 0 0 rgba(0,123,255,0); }
  50% { transform: scale(1.08); box-shadow: 0 10px 30px rgba(0,123,255,0.22); }
  100% { transform: scale(1); box-shadow: 0 0 0 rgba(0,123,255,0); }
}

/* æ£€æŸ¥é€‰é¡¹å¸ƒå±€ä¼˜åŒ– */
.examination-option .form-check {
  margin-bottom: 0;
}

.examination-option .form-check-input {
  margin-top: 2px;
  flex-shrink: 0;
}

.examination-option .form-check-label {
  cursor: pointer;
  line-height: 1.4;
}

.examination-option .text-muted {
  padding-left: 0;
  margin-left: 0;
}

.examination-option .examination-info {
  padding-left: 0;
  margin-left: 0;
}

/* é€‰ä¸­çŠ¶æ€æ ·å¼ */
.examination-option.selected {
  background-color: #e7f3ff;
  border-color: #007bff;
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(0, 123, 255, 0.15);
}

.examination-option:hover {
  transform: translateY(-1px);
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
  transition: all 0.2s ease;
}

/* ç»Ÿè®¡åŒºåŸŸæ ·å¼ä¼˜åŒ– */
.examination-summary h5 {
  border-bottom: 2px solid #007bff;
  padding-bottom: 8px;
  display: inline-block;
  margin-bottom: 25px;
}

.examination-summary .card-body {
  padding: 2rem;
}

/* æ£€æŸ¥é¡ºåºé¢„è§ˆæ ·å¼ */
.examination-sequence-preview h3 {
  text-shadow: 0 2px 4px rgba(0,123,255,0.1);
}

.sequence-cards-container {
  max-width: 100%;
  margin: 0 auto;
  overflow-x: auto;
}

.sequence-cards-container > div {
  display: flex !important;
  flex-wrap: wrap !important;
  gap: 15px !important;
  justify-content: flex-start !important;
}

.sequence-card {
  background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
  border: 2px solid #007bff;
  border-radius: 12px;
  padding: 15px 20px;
  text-align: center;
  min-width: 140px;
  width: calc(33.333% - 10px); /* æ¯è¡Œæœ€å¤š3ä¸ªï¼Œè€ƒè™‘é—´è· */
  max-width: 200px;
  box-shadow: 0 4px 12px rgba(0, 123, 255, 0.15);
  transition: all 0.3s ease;
  position: relative;
  flex: 0 0 calc(33.333% - 10px) !important;
  display: inline-block !important;
}

.sequence-card:hover {
  transform: translateY(-3px);
  box-shadow: 0 8px 20px rgba(0, 123, 255, 0.25);
}

.sequence-number {
  background: #007bff;
  color: white;
  width: 30px;
  height: 30px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: bold;
  font-size: 1.1rem;
  margin: 0 auto 10px auto;
}

.sequence-name {
  font-weight: 600;
  color: #2c3e50;
  font-size: 0.9rem;
  line-height: 1.3;
  word-wrap: break-word;
}

/* å“åº”å¼è°ƒæ•´ */
@media (max-width: 768px) {
  .examination-summary .card-body {
    padding: 1.5rem;
  }
  
  .examination-summary h5 {
    font-size: 1.1rem;
    margin-bottom: 20px;
  }
  
  .examination-sequence-preview h3 {
    font-size: 1.4rem !important;
  }
  
  .sequence-cards-container > div {
    flex-direction: row !important;
    flex-wrap: wrap !important;
    justify-content: flex-start !important;
  }
  
  .sequence-card {
    min-width: 100px;
    width: calc(33.333% - 10px); /* ç§»åŠ¨ç«¯ä¹Ÿä¿æŒæ¯è¡Œ3ä¸ª */
    max-width: 130px;
    flex: 0 0 calc(33.333% - 10px) !important;
    margin: 5px 0;
  }
}
</style>
{% endblock %}

{% block extra_js %}
<script>
// ä¸´åºŠæ¨ç†æ•™å­¦ç³»ç»Ÿ - é‡æ–°è®¾è®¡çš„äº¤äº’é€»è¾‘
// ä½œä¸ºåŒ»ç–—æ•™è‚²å·¥ç¨‹å¸ˆï¼Œæˆ‘è®¾è®¡äº†ä¸€ä¸ªæ›´è´´è¿‘çœŸå®ä¸´åºŠæ€ç»´çš„å­¦ä¹ ç³»ç»Ÿ

(function() {
  // ==================== æ ¸å¿ƒçŠ¶æ€ç®¡ç† ====================
  var clinicalSession = {
    caseId: '{{ clinical_case.case_id }}',
    currentStage: 'history',
    stages: ['history', 'examination', 'diagnosis', 'treatment', 'feedback'],
    
    // ä¸´åºŠæ•°æ®æ”¶é›†
    selectedExaminations: [],
    examinationResults: [],
    clinicalFindings: {},
    
    // è¯Šæ–­æ¨ç†
    diagnosticHypotheses: [],
    selectedDiagnosis: null,
    differentialAnalysis: {},
    
    // æ²»ç–—å†³ç­–
    selectedTreatments: [],
    treatmentRationale: '',
    
    // å­¦ä¹ è¯„ä¼°
    scores: {
      examination: 0,
      diagnosis: 0,
      treatment: 0,
      overall: 0,
      clinicalThinking: 0
    },
    
    // æ—¶é—´è·Ÿè¸ª
    timeSpent: {},
    startTime: new Date(),
    
    // çœ¼åº•æ£€æŸ¥å­—å¹•æ§åˆ¶
    fundusSubtitleDismissed: false,
    
    // ç¼“å­˜çš„æ•°æ®é€‰é¡¹
    diagnosisOptions: [],
    treatmentOptions: [],
    
    // æ•™å­¦åé¦ˆ
    feedbackHistory: [],
    clinicalMistakes: [],
    learningInsights: []
  };

  // ==================== åŒ»å­¦æ•™è‚²æ ¸å¿ƒåŠŸèƒ½ ====================
  
  // ç´§æ€¥ä¿®å¤ï¼šç¡®ä¿æŒ‰é’®å¯ç”¨çš„å‡½æ•°
  function ensureButtonEnabled() {
    var stage = clinicalSession.currentStage;
    console.log('ç¡®ä¿æŒ‰é’®å¯ç”¨ - å½“å‰é˜¶æ®µ:', stage);
    
    $('#btn-next').prop('disabled', false);
    
    switch(stage) {
      case 'examination':
        $('#btn-next').removeClass('btn-secondary btn-info btn-success').addClass('btn-warning').text('ç¡®è®¤æ£€æŸ¥é€‰æ‹© â†’');
        break;
      case 'diagnosis':
        $('#btn-next').removeClass('btn-warning btn-secondary btn-success').addClass('btn-info').text('æäº¤è¯Šæ–­é€‰æ‹© â†’');
        break;
      case 'treatment':
        $('#btn-next').removeClass('btn-warning btn-info btn-secondary').addClass('btn-success').text('æäº¤æ²»ç–—æ–¹æ¡ˆ â†’');
        break;
    }
    
    console.log('æŒ‰é’®çŠ¶æ€å·²å¼ºåˆ¶å¯ç”¨:', $('#btn-next').prop('disabled'));
  }
  
  // è°ƒè¯•å‡½æ•°
  function debugButtonStatus() {
    console.log('=== æŒ‰é’®çŠ¶æ€è°ƒè¯• ===');
    console.log('æŒ‰é’®æ˜¯å¦ç¦ç”¨:', $('#btn-next').prop('disabled'));
    console.log('æŒ‰é’®æ–‡æœ¬:', $('#btn-next').text());
    console.log('æŒ‰é’®ç±»å:', $('#btn-next').attr('class'));
    console.log('å½“å‰é˜¶æ®µ:', clinicalSession.currentStage);
    console.log('å·²é€‰æ‹©è¯Šæ–­:', clinicalSession.selectedDiagnosis);
    console.log('====================');
  }
  
  function updateClinicalProgress() {
    // æ›´æ–°å¯è§†åŒ–è¿›åº¦æŒ‡ç¤ºå™¨
    $('.stepper-item').removeClass('active completed thinking');
    var currentIndex = clinicalSession.stages.indexOf(clinicalSession.currentStage);
    
    for (var i = 0; i <= currentIndex; i++) {
      var $step = $('.stepper-item[data-step="' + clinicalSession.stages[i] + '"]');
      if (i === currentIndex) {
        $step.addClass('active thinking');
        // æ·»åŠ æ€è€ƒåŠ¨ç”»æ•ˆæœ
        $step.find('.stepper-icon').html('<i class="fas fa-brain fa-pulse"></i>');
      } else {
        $step.addClass('completed');
        $step.find('.stepper-icon').html('<i class="fas fa-check"></i>');
      }
    }
    // é«˜äº®å½“å‰æ­¥éª¤ä¸€æ¬¡
    highlightStep(clinicalSession.currentStage);
    
    // æ›´æ–°é˜¶æ®µæç¤º
    updateStageGuidance();
  }
  
  function updateStageGuidance() {
    var guidance = {
      'history': {
        title: 'ğŸ“‹ ç—…å²é‡‡é›†é˜¶æ®µ',
        instruction: 'ä»”ç»†é˜…è¯»æ‚£è€…çš„ä¸»è¯‰å’Œç—…å²ä¿¡æ¯ï¼Œè¿™æ˜¯ä¸´åºŠæ¨ç†çš„åŸºç¡€ã€‚æ€è€ƒï¼šæ‚£è€…çš„ä¸»è¦é—®é¢˜æ˜¯ä»€ä¹ˆï¼Ÿå¯èƒ½çš„ç—…å› æœ‰å“ªäº›ï¼Ÿ',
        tips: ['æ³¨æ„ç—‡çŠ¶çš„æ—¶é—´é¡ºåº', 'å…³æ³¨æ—¢å¾€å²çš„ç›¸å…³æ€§', 'æ€è€ƒç—‡çŠ¶çš„ä¸¥é‡ç¨‹åº¦']
      },
      'examination': {
        title: 'ğŸ” ä¸´åºŠæ£€æŸ¥é˜¶æ®µ', 
        instruction: 'åŸºäºç—…å²åˆ†æï¼Œé€‰æ‹©æœ€æœ‰ä»·å€¼çš„æ£€æŸ¥é¡¹ç›®ã€‚è®°ä½ï¼šåˆç†çš„æ£€æŸ¥é€‰æ‹©ä½“ç°ä¸´åºŠæ€ç»´èƒ½åŠ›ã€‚',
        tips: ['ä¼˜å…ˆé€‰æ‹©æ€§ä»·æ¯”é«˜çš„æ£€æŸ¥', 'é¿å…è¿‡åº¦æ£€æŸ¥', 'è€ƒè™‘æ£€æŸ¥çš„è¯Šæ–­ä»·å€¼']
      },
      'diagnosis': {
        title: 'ğŸ¯ è¯Šæ–­æ¨ç†é˜¶æ®µ',
        instruction: 'ç»¼åˆç—…å²å’Œæ£€æŸ¥ç»“æœï¼Œè¿›è¡Œé‰´åˆ«è¯Šæ–­ã€‚æ€è€ƒå„ç§å¯èƒ½æ€§çš„æ¦‚ç‡ï¼Œé€‰æ‹©æœ€å¯èƒ½çš„è¯Šæ–­ã€‚',
        tips: ['åˆ—å‡ºé‰´åˆ«è¯Šæ–­', 'åˆ†ææ”¯æŒå’Œåå¯¹è¯æ®', 'è€ƒè™‘ç–¾ç—…çš„æµè¡Œç—…å­¦ç‰¹ç‚¹']
      },
      'treatment': {
        title: 'ğŸ’Š æ²»ç–—å†³ç­–é˜¶æ®µ',
        instruction: 'åŸºäºç¡®å®šçš„è¯Šæ–­ï¼Œåˆ¶å®šåˆç†çš„æ²»ç–—æ–¹æ¡ˆã€‚è€ƒè™‘æ²»ç–—çš„æœ‰æ•ˆæ€§ã€å®‰å…¨æ€§å’Œæˆæœ¬æ•ˆç›Šã€‚',
        tips: ['ä¸ªä½“åŒ–æ²»ç–—æ–¹æ¡ˆ', 'è€ƒè™‘æ‚£è€…æ‰¿å—èƒ½åŠ›', 'æƒè¡¡è·ç›Šå’Œé£é™©']
      },
      'feedback': {
        title: 'ğŸ“š å­¦ä¹ æ€»ç»“é˜¶æ®µ',
        instruction: 'å›é¡¾æ•´ä¸ªä¸´åºŠæ¨ç†è¿‡ç¨‹ï¼Œæ€»ç»“å­¦ä¹ è¦ç‚¹å’Œæ”¹è¿›æ–¹å‘ã€‚',
        tips: ['åæ€å†³ç­–è¿‡ç¨‹', 'å·©å›ºå…³é”®çŸ¥è¯†ç‚¹', 'åˆ¶å®šå­¦ä¹ è®¡åˆ’']
      }
    };
    
    var current = guidance[clinicalSession.currentStage];
    if (current) {
      var html = '<div class="clinical-guidance card mb-3">';
      html += '<div class="card-body">';
      html += '<h6 class="card-title text-primary">' + current.title + '</h6>';
      html += '<p class="card-text">' + current.instruction + '</p>';
      html += '<div class="clinical-tips">';
      html += '<small class="text-muted"><strong>ä¸´åºŠæ€ç»´è¦ç‚¹ï¼š</strong></small>';
      html += '<ul class="small text-muted mb-0">';
      current.tips.forEach(function(tip) {
        html += '<li>' + tip + '</li>';
      });
      html += '</ul>';
      html += '</div>';
      html += '</div>';
      html += '</div>';
      
      $('#clinical-guidance').html(html);
    }
  }

  
  // ==================== ç—…å²é˜¶æ®µï¼šå»ºç«‹ä¸´åºŠå°è±¡ ====================
  
  function updatePatientInfoInHeader(data) {
    // æ›´æ–°æ ‡é¢˜åŒºåŸŸçš„æ‚£è€…ä¿¡æ¯ - å¸¦æ ‡ç­¾æ˜¾ç¤º
    var patientInfoHtml = '<div class="text-muted" style="font-size: 0.95rem; font-family: -apple-system, BlinkMacSystemFont, \'Segoe UI\', Roboto, Arial, sans-serif;">';
    
    // æ·»åŠ åŸºç¡€ä¿¡æ¯æ ‡ç­¾ï¼Œç„¶åæ˜¯å¹´é¾„æ€§åˆ«ã€ç¼–å·ã€èŒä¸š
    patientInfoHtml += '<span style="color: #495057; font-weight: 600;">åŸºç¡€ä¿¡æ¯ï¼š</span>';
    patientInfoHtml += '<span style="font-weight: 500;">' + (data.patient_info.age || 'æœªçŸ¥') + 'å² ' + (data.patient_info.gender || 'æœªçŸ¥') + '</span>';
    patientInfoHtml += '<span style="margin: 0 12px; color: #6c757d;">â€¢</span>';
    patientInfoHtml += '<span style="font-weight: 500;">ç¼–å·ï¼š' + data.case_id + '</span>';
    
    // èŒä¸šï¼ˆå¦‚æœæœ‰ï¼‰
    if (data.patient_info.occupation) {
      patientInfoHtml += '<span style="margin: 0 12px; color: #6c757d;">â€¢</span>';
      patientInfoHtml += '<span style="font-weight: 500;">èŒä¸šï¼š' + data.patient_info.occupation + '</span>';
    }
    
    patientInfoHtml += '</div>';
    
    // æ›´æ–°DOM
    $('#patient-info').html(patientInfoHtml);
  }
  
  function initializeHistoryStage() {
    clinicalSession.currentStage = 'history';
    updateClinicalProgress();
    
    // è®°å½•å¼€å§‹æ—¶é—´
    clinicalSession.timeSpent.history = new Date();
    
    $('#btn-prev').prop('disabled', true);
    $('#btn-next').text('å¼€å§‹æ£€æŸ¥é€‰æ‹© â†’').removeClass('btn-secondary').addClass('btn-primary');
    
    $.getJSON('/api/clinical/case/' + clinicalSession.caseId + '/', function(resp) {
      if (resp.success) {
        window.caseData = resp.data;
        
        // æ›´æ–°æ ‡é¢˜åŒºåŸŸçš„æ‚£è€…ä¿¡æ¯
        updatePatientInfoInHeader(resp.data);
        
        // æ¸²æŸ“ç—…å²å†…å®¹
        renderPatientHistory(resp.data);
        
        // æ·»åŠ ä¸´åºŠæ€è€ƒæç¤º
        showClinicalThinkingPrompt('history');
      } else {
        showErrorMessage('åŠ è½½ç—…å²ä¿¡æ¯å¤±è´¥: ' + resp.message);
      }
    }).fail(function() {
      showErrorMessage('ç½‘ç»œé”™è¯¯ï¼Œè¯·æ£€æŸ¥è¿æ¥åé‡è¯•');
    });
  }
  
  function renderPatientHistory(data) {
    var html = '<div class="patient-history">';
    
    // ç›´æ¥å¼€å§‹ä¸»è¯‰ï¼Œæ‚£è€…åŸºæœ¬ä¿¡æ¯å·²åœ¨æ ‡é¢˜åŒºåŸŸæ˜¾ç¤º
    
    // ä¸»è¯‰å¡ç‰‡ - é‡æ–°è®¾è®¡
    html += '<div class="card mb-4 shadow-sm border-0">';
    html += '<div class="card-header border-0" style="background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%); border-radius: 12px 12px 0 0;">';
    html += '<div class="d-flex align-items-center justify-content-between">';
    html += '<h5 class="mb-0 text-white d-flex align-items-center" style="font-weight: 600; letter-spacing: 0.5px;">';
    html += '<i class="fas fa-exclamation-circle me-2" style="font-size: 1.2rem;"></i>';
    html += 'ä¸»è¯‰ <span style="font-size: 0.9rem; font-weight: 400; opacity: 0.8; margin-left: 8px;">Chief Complaint</span>';
    html += '</h5>';
    html += '</div>';
    html += '</div>';
    html += '<div class="card-body" style="padding: 1.5rem; background: #fff8f0;">';
    html += '<div class="chief-complaint-content">';
    html += '<blockquote class="blockquote text-center mb-0">';
    html += '<p class="mb-0" style="font-size: 1.1rem; color: #2c3e50; font-weight: 500; line-height: 1.6; font-style: italic;">"' + (data.clinical_info.chief_complaint || 'æ— è®°å½•') + '"</p>';
    html += '</blockquote>';
    html += '</div>';
    html += '</div>';
    html += '</div>';
    
    // ç°ç—…å²å¡ç‰‡ - é‡æ–°è®¾è®¡
    html += '<div class="card mb-4 shadow-sm border-0">';
    html += '<div class="card-header border-0" style="background: linear-gradient(135deg, #2980b9 0%, #3498db 100%); border-radius: 12px 12px 0 0;">';
    html += '<div class="d-flex align-items-center justify-content-between">';
    html += '<h5 class="mb-0 text-white d-flex align-items-center" style="font-weight: 600; letter-spacing: 0.5px;">';
    html += '<i class="fas fa-clipboard-list me-2" style="font-size: 1.2rem;"></i>';
    html += 'ç°ç—…å² <span style="font-size: 0.9rem; font-weight: 400; opacity: 0.8; margin-left: 8px;">History of Present Illness</span>';
    html += '</h5>';
    html += '</div>';
    html += '</div>';
    html += '<div class="card-body" style="padding: 1.5rem; background: #f0f8ff;">';
    html += '<div class="present-illness-content" style="line-height: 1.8; font-size: 1rem; color: #2c3e50;">';
    
    var presentIllness = data.clinical_info.present_illness || data.clinical_info.history_of_present_illness || 'æ— è®°å½•';
    
    html += '<div class="illness-timeline">';
    html += formatMedicalHistory(presentIllness);
    html += '</div>';
    
    html += '</div>';
    html += '</div>';
    html += '</div>';
    
    // æ—¢å¾€å²ã€ä¸ªäººå²ã€å®¶æ—å² - æŒ‰æ ‡å‡†åŒ»å­¦ç—…å²æ ¼å¼æ’åˆ—
    html += '<div class="medical-history-sections">';
    
    // æ—¢å¾€å²
    if (data.clinical_info.past_history || data.clinical_info.past_medical_history) {
      html += '<div class="card mb-4 shadow-sm border-0">';
      html += '<div class="card-header border-0" style="background: linear-gradient(135deg, #27ae60 0%, #2ecc71 100%); border-radius: 12px 12px 0 0;">';
      html += '<div class="d-flex align-items-center justify-content-between">';
      html += '<h5 class="mb-0 text-white d-flex align-items-center" style="font-weight: 600; letter-spacing: 0.5px;">';
      html += '<i class="fas fa-history me-2" style="font-size: 1.2rem;"></i>';
      html += 'æ—¢å¾€å² <span style="font-size: 0.9rem; font-weight: 400; opacity: 0.8; margin-left: 8px;">Past Medical History</span>';
      html += '</h5>';
      html += '</div>';
      html += '</div>';
      html += '<div class="card-body" style="padding: 1.5rem; background: #f8fff8;">';
      var pastHistory = data.clinical_info.past_history || data.clinical_info.past_medical_history || 'æ— ç‰¹æ®Šæ—¢å¾€å²';
      html += '<p class="mb-0" style="line-height: 1.6; color: #2c3e50; font-size: 1rem;">' + formatMedicalHistory(pastHistory) + '</p>';
      html += '</div>';
      html += '</div>';
    }
    
    // ä¸ªäººå²
    if (data.clinical_info.personal_history || data.clinical_info.social_history) {
      html += '<div class="card mb-4 shadow-sm border-0">';
      html += '<div class="card-header border-0" style="background: linear-gradient(135deg, #8e44ad 0%, #9b59b6 100%); border-radius: 12px 12px 0 0;">';
      html += '<div class="d-flex align-items-center justify-content-between">';
      html += '<h5 class="mb-0 text-white d-flex align-items-center" style="font-weight: 600; letter-spacing: 0.5px;">';
      html += '<i class="fas fa-user-cog me-2" style="font-size: 1.2rem;"></i>';
      html += 'ä¸ªäººå² <span style="font-size: 0.9rem; font-weight: 400; opacity: 0.8; margin-left: 8px;">Personal & Social History</span>';
      html += '</h5>';
      html += '</div>';
      html += '</div>';
      html += '<div class="card-body" style="padding: 1.5rem; background: #faf8ff;">';
      var personalHistory = data.clinical_info.personal_history || data.clinical_info.social_history || 'æ— ç‰¹æ®Šä¸ªäººå²è®°å½•';
      html += '<p class="mb-0" style="line-height: 1.6; color: #2c3e50; font-size: 1rem;">' + formatMedicalHistory(personalHistory) + '</p>';
      html += '</div>';
      html += '</div>';
    }
    
    // å®¶æ—å²
    if (data.clinical_info.family_history) {
      html += '<div class="card mb-4 shadow-sm border-0">';
      html += '<div class="card-header border-0" style="background: linear-gradient(135deg, #e67e22 0%, #f39c12 100%); border-radius: 12px 12px 0 0;">';
      html += '<div class="d-flex align-items-center justify-content-between">';
      html += '<h5 class="mb-0 text-white d-flex align-items-center" style="font-weight: 600; letter-spacing: 0.5px;">';
      html += '<i class="fas fa-users me-2" style="font-size: 1.2rem;"></i>';
      html += 'å®¶æ—å² <span style="font-size: 0.9rem; font-weight: 400; opacity: 0.8; margin-left: 8px;">Family History</span>';
      html += '</h5>';
      html += '</div>';
      html += '</div>';
      html += '<div class="card-body" style="padding: 1.5rem; background: #fffaf0;">';
      html += '<p class="mb-0" style="line-height: 1.6; color: #2c3e50; font-size: 1rem;">' + formatMedicalHistory(data.clinical_info.family_history) + '</p>';
      html += '</div>';
      html += '</div>';
    }
    
    html += '</div>';
    
    html += '</div>';
    $('#stage-content').html(html);
  }
  
  function formatMedicalHistory(text) {
    // æ ¼å¼åŒ–ç—…å²æ–‡æœ¬ï¼Œçªå‡ºå…³é”®ä¿¡æ¯å¹¶æ”¹å–„å¯è¯»æ€§
    var formatted = text
      // æ—¶é—´æ ‡è®°
      .replace(/(\d+[å¤©æœˆå¹´å‘¨])/g, '<span class="time-marker" style="background: linear-gradient(135deg, #3498db, #2980b9); color: white; padding: 2px 8px; border-radius: 12px; font-size: 0.85rem; font-weight: 500; margin: 0 2px;">$1</span>')
      // ç—‡çŠ¶å…³é”®è¯
      .replace(/(ç–¼ç—›|ä¸é€‚|æ¨¡ç³Š|ä¸‹é™|å‡ºè¡€|çº¢è‚¿|ç˜™ç—’|å¹²æ¶©|æµæ³ª|ç•å…‰|å¤è§†|é»‘å½±|é—ªå…‰)/g, '<span class="symptom-highlight" style="background: #ffe6e6; color: #c0392b; padding: 1px 4px; border-radius: 4px; font-weight: 600; border-left: 3px solid #e74c3c;">$1</span>')
      // å¦å®šè¯æ±‡
      .replace(/(æ— |å¦è®¤|æœªè§|æ­£å¸¸|é˜´æ€§)/g, '<span class="negative-finding" style="background: #e8f5e8; color: #27ae60; padding: 1px 4px; border-radius: 4px; font-weight: 500;">$1</span>')
      // ç¨‹åº¦è¯æ±‡
      .replace(/(è½»åº¦|ä¸­åº¦|é‡åº¦|ä¸¥é‡|æ˜æ˜¾|æ˜¾è‘—)/g, '<span class="severity-marker" style="background: #fff3cd; color: #856404; padding: 1px 4px; border-radius: 4px; font-weight: 500;">$1</span>');
    
    // å°†æ–‡æœ¬åˆ†æ®µå¹¶æ·»åŠ é€‚å½“çš„é—´è·
    return '<div class="formatted-history">' + formatted.replace(/ã€‚/g, 'ã€‚<br style="margin-bottom: 8px;">') + '</div>';
  }
  

  


  
  // ==================== æ£€æŸ¥é˜¶æ®µï¼šå¾ªè¯åŒ»å­¦æŒ‡å¯¼ ====================
  
  function loadExaminationStage() {
    clinicalSession.currentStage = 'examination';
    updateClinicalProgress();
    updateStageProgress();
    
    $('#btn-prev').prop('disabled', false);
    $('#btn-next').prop('disabled', false).text('ç¡®è®¤æ£€æŸ¥é€‰æ‹© â†’').removeClass('btn-secondary').addClass('btn-warning');
    updateStageCard('æ£€æŸ¥é€‰æ‹©é˜¶æ®µ', 'examination');
    
    $.getJSON('/api/clinical/case/' + clinicalSession.caseId + '/examinations/', function(resp) {
      if (resp.success) {
        renderExaminationOptions(resp.data.examination_options || []);
        addExaminationGuidance();
        showClinicalThinkingPrompt('examination');
        
        // åˆå§‹åŒ–æ£€æŸ¥é€‰æ‹©é¡ºåºæ•°ç»„
        clinicalSession.examinationOrder = [];
        clinicalSession.isExaminationConfirmed = false;
        clinicalSession.currentExaminationIndex = 0;
      } else {
        showErrorMessage('åŠ è½½æ£€æŸ¥é€‰é¡¹å¤±è´¥: ' + resp.message);
      }
    }).fail(function() {
      showErrorMessage('ç½‘ç»œé”™è¯¯ï¼Œè¯·æ£€æŸ¥è¿æ¥åé‡è¯•');
    });
  }
  
  function renderExaminationOptions(options) {
    var html = '<div class="examination-selection">';
    
    // æ£€æŸ¥é€‰æ‹©è¯´æ˜
    html += '<div class="alert alert-info" style="background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%); border: none; border-radius: 12px; padding: 20px; margin-bottom: 15px;">';
    html += '<h4 class="mb-3" style="color: #1565c0; font-weight: 700; display: flex; align-items: center;">';
    html += '<i class="fas fa-lightbulb me-2" style="font-size: 1.2rem; color: #ffa726;"></i>æ£€æŸ¥é€‰æ‹©æŒ‡å¯¼';
    html += '</h4>';
    html += '<p class="mb-2" style="font-size: 1rem; line-height: 1.6; color: #424242;">è¯·é€‰æ‹©æ‚¨è®¤ä¸ºæœ‰åŠ©äºè¯Šæ–­çš„æ£€æŸ¥é¡¹ç›®ï¼Œç„¶åå®‰æ’æ£€æŸ¥é¡ºåºã€‚</p>';
    html += '<p class="mb-0" style="font-size: 0.9rem; line-height: 1.6; color: #424242;"><strong>æç¤ºï¼š</strong>é€‰æ‹©æ£€æŸ¥é¡¹ç›®åï¼Œå¯ä»¥æ‹–æ‹½è°ƒæ•´æ£€æŸ¥é¡ºåºï¼Œç³»ç»Ÿå°†æŒ‰é¡ºåºé€ä¸€å±•ç¤ºæ£€æŸ¥ç»“æœã€‚</p>';
    html += '</div>';
    



    
    // æŒ‰ç±»å‹åˆ†ç»„æ˜¾ç¤ºæ£€æŸ¥é€‰é¡¹
    var groupedOptions = groupExaminationsByType(options);
    
    Object.keys(groupedOptions).forEach(function(type) {
      var typeOptions = groupedOptions[type];
      var typeDisplayName = getExaminationTypeDisplay(type);
      var typeIcon = getExaminationTypeIcon(type);
      
      html += '<div class="examination-group mb-4">';
      html += '<h4 class="text-primary mb-3" style="font-weight: 700; display: flex; align-items: center;">';
      html += '<i class="' + typeIcon + ' me-2" style="font-size: 1.3rem;"></i>' + typeDisplayName;
      html += '<span class="text-muted ms-2" style="font-size: 1rem; font-weight: 500;">(' + typeOptions.length + 'é¡¹)</span>';
      html += '</h4>';
      
      html += '<div class="row">';
      typeOptions.forEach(function(option) {
        var imagesAttr = (option.images && option.images.length) ? JSON.stringify(option.images) : '[]';
        var isRequiredAttr = option.is_required ? 1 : 0;
        var allowMultipleAttr = option.is_multiple_choice ? 1 : 0;
        html += '<div class="col-md-6 mb-3">';
        var cardClass = 'card examination-option h-100';
        html += '<div class="' + cardClass + '" data-exam-id="' + option.id + '" data-images=\'' + imagesAttr + '\' data-is-required="' + isRequiredAttr + '" data-allow-multiple="' + allowMultipleAttr + '">';
        html += '<div class="card-body">';
        
        html += '<div class="form-check">';
        html += '<div class="d-flex align-items-center mb-2">';
        html += '<input class="form-check-input examination-checkbox me-3" type="checkbox" ';
        html += 'value="' + option.id + '" id="exam_' + option.id + '" data-is-recommended="' + (option.is_recommended ? '1' : '0') + '" data-is-fundus="' + ((option.type && option.type.toLowerCase().indexOf('çœ¼åº•') !== -1) ? '1' : '0') + '" data-is-required="' + isRequiredAttr + '" data-allow-multiple="' + allowMultipleAttr + '" style="width: 18px; height: 18px; flex-shrink: 0;">';
        html += '<label class="form-check-label flex-grow-1 mb-0" for="exam_' + option.id + '">';
        html += '<strong style="font-size: 1.1rem; color: #2c3e50;">' + option.name + '</strong>';
        html += '</label>';
        html += '</div>';
        
        // ç§»é™¤æ£€æŸ¥ç‰¹æ€§æ ‡ç­¾ï¼Œé¿å…ç»™å­¦ç”Ÿéšæ€§æç¤º
        // html += '<div class="examination-badges d-flex gap-1">';
        // if (option.is_recommended) {
        //   html += '<span class="badge bg-success text-white" style="font-size: 0.8rem;">æ¨è</span>';
        // }
        // if (option.diagnostic_value && option.diagnostic_value.toLowerCase().indexOf('é«˜') !== -1) {
        //   html += '<span class="badge bg-warning text-dark" style="font-size: 0.8rem;"><i class="fas fa-star me-1"></i>é«˜ä»·å€¼</span>';
        // }
        // html += '</div>';
        
        html += '<div class="text-muted small mt-2 ms-0">' + (option.description || '') + '</div>';
        
        // æ˜¾ç¤ºé£é™©å’Œæˆæœ¬ä¿¡æ¯
        html += '<div class="examination-info mt-2 ms-0">';
        html += '<div class="row small text-muted">';
        html += '<div class="col-6">é£é™©: ' + (option.risk_level || 'ä½') + '</div>';
        html += '<div class="col-6">è´¹ç”¨: Â¥' + (option.cost || 50) + '</div>';
        html += '</div>';
        html += '</div>';
        
        html += '</div>';
        html += '</div>';
        html += '</div>';
        html += '</div>';
      });
      html += '</div>';
      html += '</div>';
    });
    
    // æ£€æŸ¥é¡ºåºå®‰æ’åŒºåŸŸ
    html += '<div class="examination-order-section mt-4" id="examination-order-section" style="display: none;">';
    html += '<h5 class="mb-3" style="background: linear-gradient(135deg, #1976d2, #42a5f5); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; font-weight: bold; font-size: 1.3rem;"><i class="fas fa-sort" style="color: #1976d2; margin-right: 8px;"></i> å®‰æ’æ£€æŸ¥é¡ºåº</h5>';
    html += '<div class="alert alert-info" style="background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%); border: 2px solid #2196f3; border-radius: 10px;">';
    html += '<i class="fas fa-hand-rock" style="color: #1976d2; margin-right: 8px;"></i> <strong>è¯·æ‹–æ‹½ä¸‹æ–¹çš„æ£€æŸ¥é¡¹ç›®è°ƒæ•´æ£€æŸ¥é¡ºåº</strong>ï¼Œç³»ç»Ÿå°†æŒ‰é¡ºåºé€ä¸€å±•ç¤ºæ£€æŸ¥ç»“æœã€‚';
    html += '<br><small class="text-muted mt-1 d-block"><i class="fas fa-lightbulb"></i> æç¤ºï¼šæŠ“ä½ <i class="fas fa-grip-vertical" style="color: #1976d2;"></i> å›¾æ ‡æ‹–åŠ¨é¡¹ç›®æ¥æ”¹å˜é¡ºåº</small>';
    html += '</div>';
    html += '<div id="examination-order-list" class="examination-order-list">';
    html += '<!-- æ£€æŸ¥é¡¹ç›®æ’åºåŒºåŸŸ -->';
    html += '</div>';
    html += '</div>';
    
    html += '</div>';
    
    // æ·»åŠ é€‰æ‹©ç»Ÿè®¡ - æ”¹è¿›å¸ƒå±€
    html += '<div class="examination-summary mt-4">';
    html += '<div class="card bg-light">';
    html += '<div class="card-body text-center">';
    
    // æ ‡é¢˜ç‹¬ç«‹ä¸€è¡Œ
    html += '<h5 class="mb-4" style="color: #2c3e50; font-weight: 600;">';
    html += '<i class="fas fa-calculator me-2"></i>é€‰æ‹©ç»Ÿè®¡';
    html += '</h5>';
    
    // ç»Ÿè®¡é¡¹ç›®ï¼šä½¿ç”¨inline-blockç¡®ä¿æ°´å¹³å¸ƒå±€
    html += '<div style="text-align: center;">';
    
    // æ ‡ç­¾è¡Œ
    html += '<div style="margin-bottom: 10px;">';
    html += '<span style="display: inline-block; width: 120px; text-align: center; font-size: 0.9rem; font-weight: 500;" class="text-muted">å·²é€‰æ£€æŸ¥</span>';
    html += '<span style="display: inline-block; width: 40px;"></span>'; // é—´è·
    html += '<span style="display: inline-block; width: 120px; text-align: center; font-size: 0.9rem; font-weight: 500;" class="text-muted">æ€»è´¹ç”¨</span>';
    html += '</div>';
    
    // æ•°å€¼è¡Œ
    html += '<div>';
    html += '<span style="display: inline-block; width: 120px; text-align: center;" class="h3 mb-0 text-primary fw-bold" id="selected-count">0</span>';
    html += '<span style="display: inline-block; width: 40px;"></span>'; // é—´è·
    html += '<span style="display: inline-block; width: 120px; text-align: center;" class="h3 mb-0 text-success fw-bold" id="total-cost">Â¥0</span>';
    html += '</div>';
    
    html += '</div>';
    html += '</div>';
    html += '</div>';
    html += '</div>';
    
    $('#stage-content').html(html);
    
    // ç»‘å®šæ£€æŸ¥é€‰æ‹©äº‹ä»¶
    bindExaminationEvents();
    
    // åˆå§‹åŒ–æ‹–æ‹½æ’åºåŠŸèƒ½
    initializeExaminationOrderSorting();
    
    // ç¡®ä¿æŒ‰é’®çŠ¶æ€æ­£ç¡® - æ£€æŸ¥é˜¶æ®µæŒ‰é’®åº”å§‹ç»ˆå¯ç”¨
    setTimeout(function() {
      ensureButtonEnabled();
    }, 100);
  }
  
  function groupExaminationsByType(options) {
    var grouped = {};
    options.forEach(function(option) {
      var type = option.examination_type || 'basic';
      if (!grouped[type]) {
        grouped[type] = [];
      }
      grouped[type].push(option);
    });
    return grouped;
  }
  
  function getExaminationTypeDisplay(type) {
    var displays = {
      'basic': 'åŸºç¡€æ£€æŸ¥',
      'imaging': 'å½±åƒå­¦æ£€æŸ¥', 
      'laboratory': 'å®éªŒå®¤æ£€æŸ¥',
      'special': 'ç‰¹æ®Šæ£€æŸ¥'
    };
    return displays[type] || type;
  }
  
  function getExaminationTypeIcon(type) {
    var icons = {
      'basic': 'fas fa-stethoscope',
      'imaging': 'fas fa-x-ray',
      'laboratory': 'fas fa-flask',
      'special': 'fas fa-microscope'
    };
    return icons[type] || 'fas fa-medical-kit';
  }
  
  function getRiskLevelDisplay(level) {
    var displays = {
      'low': '<span class="text-success">ä½</span>',
      'medium': '<span class="text-warning">ä¸­</span>',
      'high': '<span class="text-danger">é«˜</span>'
    };
    return displays[level] || level;
  }
  
  function bindExaminationEvents() {
    $('.examination-checkbox').off('change').on('change', function() {
      var $card = $(this).closest('.examination-option');
      var examId = parseInt($(this).val());
      var isChecked = $(this).is(':checked');
      var isFundus = $(this).data('is-fundus') == 1;

      if (isChecked) {
        $card.addClass('selected');
        if (clinicalSession.selectedExaminations.indexOf(examId) === -1) {
          clinicalSession.selectedExaminations.push(examId);
        }
        addToLearningTimeline('é€‰æ‹©æ£€æŸ¥', $card.find('strong').text());
      } else {
        $card.removeClass('selected');
        var index = clinicalSession.selectedExaminations.indexOf(examId);
        if (index > -1) {
          clinicalSession.selectedExaminations.splice(index, 1);
        }
      }

      updateExaminationSummary();
      updateExaminationOrderList();
      provideLiveExaminationFeedback();
    });
    
    $('.examination-option').on('click', function(e) {
      if (e.target.type !== 'checkbox') {
        var checkbox = $(this).find('.examination-checkbox');
        checkbox.prop('checked', !checkbox.prop('checked')).trigger('change');
      }
    });
  }
  
  function updateExaminationOrderList() {
    var $orderSection = $('#examination-order-section');
    var $orderList = $('#examination-order-list');
    
    if (clinicalSession.selectedExaminations.length === 0) {
      $orderSection.hide();
      return;
    }
    
    $orderSection.show();
    
    var html = '';
    clinicalSession.selectedExaminations.forEach(function(examId, index) {
      var $examCard = $('.examination-option[data-exam-id="' + examId + '"]');
      var examName = $examCard.find('strong').text();
      var isRequired = $examCard.data('is-required');
      
      html += '<div class="examination-order-item" data-exam-id="' + examId + '" draggable="true">';
      html += '<div class="d-flex align-items-center justify-content-between p-3 mb-2 border rounded position-relative">';
      html += '<div class="d-flex align-items-center">';
      html += '<i class="fas fa-grip-vertical me-3" style="cursor: grab;" title="æ‹–æ‹½è°ƒæ•´é¡ºåº"></i>';
      html += '<span class="order-number badge me-3" style="background: linear-gradient(135deg, #1976d2, #42a5f5); color: white; font-size: 0.9rem; padding: 8px 12px; border-radius: 50%; min-width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; box-shadow: 0 2px 8px rgba(25, 118, 210, 0.3);">' + (index + 1) + '</span>';
      html += '<div class="exam-info">';
      html += '<span class="exam-name fw-bold d-block" style="color: #0d47a1; font-size: 1rem;">' + examName + '</span>';
      html += '<small class="text-muted"><i class="fas fa-hand-rock"></i> å¯æ‹–æ‹½æ’åº</small>';
      html += '</div>';

      html += '</div>';
      html += '<button class="btn btn-sm btn-outline-danger remove-exam-btn" data-exam-id="' + examId + '" title="ç§»é™¤æ­¤é¡¹æ£€æŸ¥">';
      html += '<i class="fas fa-times"></i>';
      html += '</button>';
      html += '</div>';
      html += '</div>';
    });
    
    // å¦‚æœæ²¡æœ‰é€‰ä¸­ä»»ä½•é¡¹ç›®ï¼Œæ˜¾ç¤ºç©ºæç¤º
    if (clinicalSession.selectedExaminations.length === 0) {
      html += '<div class="empty-drag-area text-center py-4" style="background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); border: 2px dashed #ced4da; border-radius: 10px; color: #6c757d;">';
      html += '<i class="fas fa-mouse-pointer fa-2x mb-2" style="color: #adb5bd;"></i>';
      html += '<p class="mb-0">é€‰ä¸­çš„æ£€æŸ¥é¡¹ç›®å°†åœ¨è¿™é‡Œæ˜¾ç¤ºï¼Œå¯æ‹–æ‹½æ’åº</p>';
      html += '<small class="text-muted">è¯·å…ˆä»ä¸Šæ–¹é€‰æ‹©æ£€æŸ¥é¡¹ç›®</small>';
      html += '</div>';
    }
    
    $orderList.html(html);
    
    // ç»‘å®šç§»é™¤æŒ‰é’®äº‹ä»¶
    $('.remove-exam-btn').on('click', function() {
      var examId = parseInt($(this).data('exam-id'));
      var $checkbox = $('.examination-checkbox[value="' + examId + '"]');
      $checkbox.prop('checked', false).trigger('change');
    });
    
    // é‡æ–°åˆå§‹åŒ–æ‹–æ‹½æ’åº
    initializeExaminationOrderSorting();
  }
  
  function initializeExaminationOrderSorting() {
    var $orderList = $('#examination-order-list');
    
    if (!$orderList.length) return;
    
    // ç®€å•çš„æ‹–æ‹½æ’åºå®ç°ï¼ˆä¸ä¾èµ–å¤–éƒ¨åº“ï¼‰
    var draggedItem = null;
    
    $orderList.off('dragstart dragover drop dragend');
    
    $orderList.on('dragstart', '.examination-order-item', function(e) {
      draggedItem = this;
      $(this).addClass('dragging');
      $('.examination-order-item').not(this).addClass('drop-target');
      $('#examination-order-list').addClass('drag-active');
      e.originalEvent.dataTransfer.effectAllowed = 'move';
    });
    
    $orderList.on('dragover', '.examination-order-item', function(e) {
      e.preventDefault();
      e.originalEvent.dataTransfer.dropEffect = 'move';
      
      var $this = $(this);
      $('.examination-order-item').removeClass('drag-hover');
      
      if (this !== draggedItem) {
        $this.addClass('drag-hover');
        var draggedRect = draggedItem.getBoundingClientRect();
        var targetRect = this.getBoundingClientRect();
        
        if (e.originalEvent.clientY < targetRect.top + targetRect.height / 2) {
          $this.before(draggedItem);
        } else {
          $this.after(draggedItem);
        }
      }
    });
    
    $orderList.on('dragleave', '.examination-order-item', function(e) {
      $(this).removeClass('drag-hover');
    });
    
    $orderList.on('dragend', '.examination-order-item', function(e) {
      $(this).removeClass('dragging');
      $('.examination-order-item').removeClass('drop-target drag-hover');
      $('#examination-order-list').removeClass('drag-active');
      draggedItem = null;
      
      // æ›´æ–°æ£€æŸ¥é¡ºåº
      updateExaminationOrder();
    });
    
    $orderList.on('drop', function(e) {
      e.preventDefault();
    });
  }
  
  function updateExaminationOrder() {
    var newOrder = [];
    $('#examination-order-list .examination-order-item').each(function(index) {
      var examId = parseInt($(this).data('exam-id'));
      newOrder.push(examId);
      
      // æ›´æ–°é¡ºåºå·æ˜¾ç¤º
      $(this).find('.order-number').text(index + 1);
    });
    
    clinicalSession.selectedExaminations = newOrder;
    clinicalSession.examinationOrder = newOrder;
  }

  function confirmExaminationSelection() {
    // éªŒè¯å¿…é€‰æ£€æŸ¥æ˜¯å¦éƒ½è¢«é€‰æ‹©
    var requiredMissing = [];
    $('.examination-checkbox').each(function() {
      var isRequired = $(this).data('is-required') === 1 || $(this).data('is-required') === true;
      if (isRequired) {
        var id = parseInt($(this).val());
        if (clinicalSession.selectedExaminations.indexOf(id) === -1) {
          requiredMissing.push(id);
        }
      }
    });

    if (requiredMissing.length > 0) {
      showFeedbackMessage('å­˜åœ¨é‡è¦æ£€æŸ¥é¡¹ç›®æœªé€‰æ‹©ï¼Œå»ºè®®å®Œå–„æ£€æŸ¥åå†ç»§ç»­', 'warning');
      return;
    }

    // æ˜¾ç¤ºç¡®è®¤ä¸­çŠ¶æ€
    $('#btn-next').prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i> ç¡®è®¤ä¸­...');
    showFeedbackMessage('æ­£åœ¨ç¡®è®¤æ£€æŸ¥é€‰æ‹©...', 'info');

    // å‡†å¤‡æäº¤æ•°æ®
    var submitData = {
      case_id: clinicalSession.caseId,
      selected_examinations: clinicalSession.selectedExaminations,
      examination_order: clinicalSession.examinationOrder || clinicalSession.selectedExaminations
    };

    $.ajax({
      url: '/api/clinical/confirm-examination-selection/',
      method: 'POST',
      contentType: 'application/json',
      headers: {
        'X-CSRFToken': $('[name=csrfmiddlewaretoken]').val() || getCsrfToken()
      },
      data: JSON.stringify(submitData),
      success: function(resp) {
        if (resp.success) {
          // æ ‡è®°æ£€æŸ¥å·²ç¡®è®¤
          clinicalSession.isExaminationConfirmed = true;
          clinicalSession.examinationOrder = resp.data.examination_order;
          clinicalSession.currentExaminationIndex = 0;
          
          // æ›´æ–°æŒ‰é’®çŠ¶æ€
          $('#btn-next').prop('disabled', false).html('æŸ¥çœ‹æ£€æŸ¥ç»“æœ <i class="fas fa-arrow-right"></i>');
          
          // æ˜¾ç¤ºç¡®è®¤æˆåŠŸç•Œé¢
          showExaminationConfirmedInterface();
          showFeedbackMessage('æ£€æŸ¥é€‰æ‹©å·²ç¡®è®¤ï¼Œå‡†å¤‡æŸ¥çœ‹æ£€æŸ¥ç»“æœ', 'success');
          
          // è®°å½•åˆ°æ—¶é—´çº¿
          addToLearningTimeline('ç¡®è®¤æ£€æŸ¥é€‰æ‹©', 'å…±é€‰æ‹© ' + clinicalSession.selectedExaminations.length + ' é¡¹æ£€æŸ¥');
        } else {
          $('#btn-next').prop('disabled', false).html('ç¡®è®¤æ£€æŸ¥é€‰æ‹© â†’');
          showFeedbackMessage('ç¡®è®¤å¤±è´¥: ' + resp.message, 'danger');
        }
      },
      error: function(xhr, status, error) {
        $('#btn-next').prop('disabled', false).html('ç¡®è®¤æ£€æŸ¥é€‰æ‹© â†’');
        console.error('Confirm examination error:', error, xhr.responseText);
        showFeedbackMessage('ç½‘ç»œé”™è¯¯ï¼Œè¯·æ£€æŸ¥è¿æ¥: ' + error, 'danger');
      }
    });
  }
  
  function showExaminationConfirmedInterface() {
    var html = '<div class="examination-confirmed">';
    
    // ç¡®è®¤çŠ¶æ€æç¤º
    html += '<div class="alert alert-success" style="background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%); border: none; border-radius: 12px; padding: 20px;">';
    html += '<h4 class="mb-3" style="color: #155724; font-weight: 700; display: flex; align-items: center;">';
    html += '<i class="fas fa-check-circle me-2" style="font-size: 1.2rem; color: #28a745;"></i>æ£€æŸ¥é€‰æ‹©å·²ç¡®è®¤';
    html += '</h4>';
    html += '<p class="mb-0" style="font-size: 1rem; line-height: 1.6; color: #155724;">æ‚¨å·²é€‰æ‹© ' + clinicalSession.selectedExaminations.length + ' é¡¹æ£€æŸ¥ï¼Œç³»ç»Ÿå°†æŒ‰é¡ºåºé€ä¸€å±•ç¤ºæ£€æŸ¥ç»“æœã€‚</p>';
    html += '</div>';
    
    // æ£€æŸ¥é¡ºåºé¢„è§ˆ - ä¼˜åŒ–è®¾è®¡
    html += '<div class="examination-sequence-preview mb-5">';
    
    // å¤§æ ‡é¢˜
    html += '<div class="text-center mb-4">';
    html += '<h3 class="text-primary fw-bold" style="font-size: 1.8rem; border-bottom: 3px solid #007bff; display: inline-block; padding-bottom: 10px;">';
    html += '<i class="fas fa-list-ol me-3"></i>æ£€æŸ¥é¡ºåºé¢„è§ˆ';
    html += '</h3>';
    html += '</div>';
    
    // æ£€æŸ¥é¡¹ç›®å¡ç‰‡ - å¼ºåˆ¶æ°´å¹³æ’åˆ—
    html += '<div class="sequence-cards-container mb-4">';
    html += '<div style="display: flex; flex-wrap: wrap; gap: 10px; align-items: flex-start;">';
    
    clinicalSession.examinationOrder.forEach(function(examId, index) {
      var $examCard = $('.examination-option[data-exam-id="' + examId + '"]');
      var examName = $examCard.find('strong').text();
      var isRequired = $examCard.data('is-required');
      
      // å°å¡ç‰‡æ ·å¼ - ä½¿ç”¨flexå­é¡¹
      html += '<div class="sequence-card" style="flex: 0 0 auto;">';
      html += '<div class="sequence-number">' + (index + 1) + '</div>';
      html += '<div class="sequence-name">' + examName + '</div>';
      html += '</div>';
    });
    
    html += '</div>';
    html += '</div>';
    
    // æ˜¾ç¤ºé™æ€å¼€å§‹æ£€æŸ¥æç¤º
    $('#start-examination-hint').show();
    
    html += '</div>';
    
    $('#stage-content').html(html);
  }
  
  function showNextExaminationResult() {
    var currentIndex = clinicalSession.currentExaminationIndex;
    var examId = clinicalSession.examinationOrder[currentIndex];
    
    // éšè—é™æ€æç¤ºå¹¶æ˜¾ç¤ºåŠ è½½çŠ¶æ€
    $('#start-examination-hint').hide();
    $('#btn-next').prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i> åŠ è½½ä¸­...');
    
    // è·å–æ£€æŸ¥ç»“æœ
    $.getJSON('/api/clinical/case/' + clinicalSession.caseId + '/examination/' + examId + '/', function(resp) {
      if (resp.success) {
        renderSingleExaminationResult(resp.data, currentIndex);
        
        // æ›´æ–°ç´¢å¼•
        clinicalSession.currentExaminationIndex++;
        
        // æ›´æ–°æŒ‰é’®æ–‡æœ¬
        if (clinicalSession.currentExaminationIndex < clinicalSession.examinationOrder.length) {
          $('#btn-next').prop('disabled', false).html('æŸ¥çœ‹ä¸‹ä¸€é¡¹æ£€æŸ¥ <i class="fas fa-arrow-right"></i>');
        } else {
          $('#btn-next').prop('disabled', false).html('å®Œæˆæ£€æŸ¥é˜¶æ®µ <i class="fas fa-check"></i>');
        }
        
        // è®°å½•åˆ°æ—¶é—´çº¿
        addToLearningTimeline('æŸ¥çœ‹æ£€æŸ¥ç»“æœ', resp.data.name);
      } else {
        $('#btn-next').prop('disabled', false).html('æŸ¥çœ‹æ£€æŸ¥ç»“æœ <i class="fas fa-arrow-right"></i>');
        showFeedbackMessage('è·å–æ£€æŸ¥ç»“æœå¤±è´¥: ' + resp.message, 'danger');
      }
    }).fail(function() {
      $('#btn-next').prop('disabled', false).html('æŸ¥çœ‹æ£€æŸ¥ç»“æœ <i class="fas fa-arrow-right"></i>');
      showFeedbackMessage('ç½‘ç»œé”™è¯¯ï¼Œè¯·æ£€æŸ¥è¿æ¥åé‡è¯•', 'danger');
    });
  }
  
  function renderSingleExaminationResult(resultData, examIndex) {
    var html = '<div class="single-examination-result">';
    
    // æ£€æŸ¥è¿›åº¦æŒ‡ç¤º
    var totalExams = clinicalSession.examinationOrder.length;
    var progressPercent = Math.round(((examIndex + 1) / totalExams) * 100);
    
    html += '<div class="examination-progress mb-4">';
    html += '<div class="d-flex justify-content-between align-items-center mb-2">';
    html += '<h5 class="text-primary mb-0">æ£€æŸ¥è¿›åº¦</h5>';
    html += '<span class="text-muted">' + (examIndex + 1) + ' / ' + totalExams + '</span>';
    html += '</div>';
    html += '<div class="progress" style="height: 8px;">';
    html += '<div class="progress-bar bg-primary" style="width: ' + progressPercent + '%"></div>';
    html += '</div>';
    html += '</div>';
    
    // å½“å‰æ£€æŸ¥ç»“æœå±•ç¤º
    html += '<div class="current-examination-result">';
    html += '<div class="card border-primary">';
    html += '<div class="card-header bg-primary text-white">';
    html += '<h4 class="mb-0"><i class="fas fa-microscope me-2"></i>' + resultData.name + '</h4>';
    html += '</div>';
    html += '<div class="card-body">';
    
    // æ£€æŸ¥æè¿° - å·²éšè—ï¼Œä¸å†æ˜¾ç¤ºæ£€æŸ¥è¯´æ˜
    // if (resultData.description) {
    //   html += '<div class="examination-description mb-3">';
    //   html += '<h6 class="text-muted">æ£€æŸ¥è¯´æ˜</h6>';
    //   html += '<p class="text-muted">' + resultData.description + '</p>';
    //   html += '</div>';
    // }
    
    // ç‰¹æ®Šå¤„ç†ï¼šçœ¼åº•æ£€æŸ¥ - ç•™ç™½æ˜¾ç¤º
    var isFundusExam = resultData.is_fundus_exam || 
                      (resultData.name && (
                        resultData.name.toLowerCase().indexOf('çœ¼åº•') !== -1 ||
                        resultData.name.toLowerCase().indexOf('fundus') !== -1 ||
                        resultData.name.toLowerCase().indexOf('çœ¼åº•ç…§ç‰‡') !== -1 ||
                        resultData.name.toLowerCase().indexOf('çœ¼åº•é•œ') !== -1 ||
                        resultData.name.toLowerCase().indexOf('çœ¼åº•æ£€æŸ¥') !== -1
                      )) ||
                      (resultData.type && (
                        resultData.type.toLowerCase().indexOf('çœ¼åº•') !== -1 ||
                        resultData.type.toLowerCase().indexOf('fundus') !== -1
                      ));
    
    if (isFundusExam) {
      // çœ¼åº•æ£€æŸ¥ç•™ç™½åŒºåŸŸ
      html += '<div class="fundus-examination-blank">';
      html += '<div class="icon">';
      html += '<i class="fas fa-eye"></i>';
      html += '</div>';
      html += '<div class="message">è¯·ç§»æ­¥æ—è¾¹è¿›è¡Œè§‚å¯Ÿ</div>';
      html += '<div class="submessage">çœ¼åº•æ£€æŸ¥éœ€è¦å®é™…æ“ä½œè§‚å¯Ÿ</div>';
      html += '</div>';
      
      // æ˜¾ç¤ºæµ®ç°å­—å¹•
      setTimeout(function() {
        showFundusSubtitle();
      }, 500);
    } else {
      // æ™®é€šæ£€æŸ¥æ˜¾ç¤ºå®Œæ•´ç»“æœ
      // æ£€æŸ¥æè¿° - å·²éšè—ï¼Œä¸å†æ˜¾ç¤ºæ£€æŸ¥è¯´æ˜
      // if (resultData.description) {
      //   html += '<div class="examination-description mb-3">';
      //   html += '<h6 class="text-muted">æ£€æŸ¥è¯´æ˜</h6>';
      //   html += '<p class="text-muted">' + resultData.description + '</p>';
      //   html += '</div>';
      // }
      
      // æ£€æŸ¥ç»“æœ
      html += '<div class="examination-result-content">';
      html += '<h6 class="text-primary">æ£€æŸ¥ç»“æœ</h6>';
      html += '<div class="result-box p-3 bg-light rounded border-left-primary">';
      html += '<p class="mb-0" style="font-size: 1.1rem; line-height: 1.6;">' + resultData.result + '</p>';
      html += '</div>';
      html += '</div>';
      
      // æ£€æŸ¥æ•°æ®ï¼ˆè§†åŠ›ã€çœ¼å‹ç­‰ï¼‰
      if (resultData.examination_data && Object.keys(resultData.examination_data).length > 0) {
        html += '<div class="examination-data mt-3">';
        html += '<h6 class="text-primary">æ£€æŸ¥æ•°æ®</h6>';
        html += '<div class="row">';
        
        if (resultData.examination_data.left_eye_vision) {
          html += '<div class="col-md-6">';
          html += '<div class="data-item p-2 bg-light rounded">';
          html += '<strong>å·¦çœ¼è§†åŠ›:</strong> ' + resultData.examination_data.left_eye_vision;
          html += '</div>';
          html += '</div>';
        }
        
        if (resultData.examination_data.right_eye_vision) {
          html += '<div class="col-md-6">';
          html += '<div class="data-item p-2 bg-light rounded">';
          html += '<strong>å³çœ¼è§†åŠ›:</strong> ' + resultData.examination_data.right_eye_vision;
          html += '</div>';
          html += '</div>';
        }
        
        if (resultData.examination_data.left_eye_pressure) {
          html += '<div class="col-md-6">';
          html += '<div class="data-item p-2 bg-light rounded">';
          html += '<strong>å·¦çœ¼çœ¼å‹:</strong> ' + resultData.examination_data.left_eye_pressure + ' mmHg';
          html += '</div>';
          html += '</div>';
        }
        
        if (resultData.examination_data.right_eye_pressure) {
          html += '<div class="col-md-6">';
          html += '<div class="data-item p-2 bg-light rounded">';
          html += '<strong>å³çœ¼çœ¼å‹:</strong> ' + resultData.examination_data.right_eye_pressure + ' mmHg';
          html += '</div>';
          html += '</div>';
        }
        
        html += '</div>';
        html += '</div>';
      }
      
      // æ£€æŸ¥å›¾åƒ - å¢å¼ºæ˜¾ç¤º
      console.log('æ£€æŸ¥ç»“æœæ•°æ®:', resultData); // è°ƒè¯•ä¿¡æ¯
      console.log('å›¾åƒæ•°æ®:', resultData.images); // è°ƒè¯•ä¿¡æ¯
      
      if (resultData.images && resultData.images.length > 0) {
        html += '<div class="examination-images mt-3">';
        html += '<h6 class="text-primary mb-3"><i class="fas fa-image me-2"></i>æ£€æŸ¥å›¾åƒ</h6>';
        
        // æ£€æŸ¥æ˜¯å¦ä¸ºOCTæ£€æŸ¥
        var isOctExam = resultData.is_oct_exam || 
                       (resultData.name && (
                         resultData.name.indexOf('OCT') !== -1 ||
                         resultData.name.indexOf('å…‰å­¦ç›¸å¹²æ–­å±‚æ‰«æ') !== -1 ||
                         resultData.name.indexOf('å…‰ç›¸å¹²æ–­å±‚') !== -1
                       ));
        
        console.log('æ˜¯å¦OCTæ£€æŸ¥:', isOctExam); // è°ƒè¯•ä¿¡æ¯
        
        if (isOctExam) {
          // OCTæ£€æŸ¥ç‰¹æ®Šæ˜¾ç¤º
          html += renderOctImages(resultData);
        } else {
          // æ™®é€šæ£€æŸ¥å›¾åƒæ˜¾ç¤º
          html += renderStandardImages(resultData);
        }
        
        html += '</div>';
      } else {
        // æ·»åŠ è°ƒè¯•ä¿¡æ¯æ˜¾ç¤ºæ²¡æœ‰å›¾åƒçš„æƒ…å†µ
        html += '<div class="alert alert-warning mt-3">';
        html += '<i class="fas fa-info-circle me-2"></i>';
        html += 'æš‚æ— æ£€æŸ¥å›¾åƒæ•°æ®';
        if (resultData.is_oct_exam) {
          html += ' (OCTæ£€æŸ¥)';
        }
        html += '</div>';
        console.log('æ²¡æœ‰å›¾åƒæ•°æ®æˆ–å›¾åƒæ•°ç»„ä¸ºç©º'); // è°ƒè¯•ä¿¡æ¯
      }
    }
    
    html += '</div>';
    html += '</div>';
    html += '</div>';
    
    // ç»§ç»­æç¤º
    html += '<div class="continue-prompt mt-4">';
    html += '<div class="text-center p-3 bg-light rounded">';
    if (examIndex + 1 < totalExams) {
      html += '<p class="text-muted mb-0">è¯·ä»”ç»†æŸ¥çœ‹æ£€æŸ¥ç»“æœï¼Œå‡†å¤‡æŸ¥çœ‹ä¸‹ä¸€é¡¹æ£€æŸ¥</p>';
    } else {
      html += '<p class="text-muted mb-0">æ‰€æœ‰æ£€æŸ¥ç»“æœå·²å±•ç¤ºå®Œæ¯•ï¼Œå‡†å¤‡è¿›å…¥è¯Šæ–­é˜¶æ®µ</p>';
    }
    html += '</div>';
    html += '</div>';
    
    html += '</div>';
    
    $('#stage-content').html(html);
    
    // ç»‘å®šå›¾åƒç‚¹å‡»äº‹ä»¶
    $('.examination-image').on('click', function() {
      var imageSrc = $(this).data('image-src');
      showImageModal(imageSrc);
    });
    
    // ç»‘å®šOCTå›¾åƒç‚¹å‡»äº‹ä»¶
    $('.oct-image').on('click', function() {
      var imageSrc = $(this).data('image-src') || $(this).attr('src');
      var eye = $(this).data('eye') || 'unknown';
      var measurements = $(this).data('measurements') || {};
      
      if (clinicalSession.examination_images_viewed.indexOf(imageSrc) === -1) {
        clinicalSession.examination_images_viewed.push(imageSrc);
        saveSessionData();
      }
      
      showOctImageModal(imageSrc, eye, measurements);
    });
  }

  function renderExaminationImagesForCard($card, images) {
    // images ä¸ºæ•°ç»„è·¯å¾„
    if (!images || images.length === 0) return;
    var html = '<div class="examination-images mt-3">';
    images.forEach(function(img) {
      html += '<img src="' + img + '" class="img-fluid mb-2 exam-image" style="max-height:220px; cursor:zoom-in;" data-src="' + img + '">';
    });
    html += '</div>';

    // é˜²æ­¢é‡å¤æ’å…¥
    $card.find('.examination-images').remove();
    $card.find('.card-body').append(html);

    // ç‚¹å‡»å›¾ç‰‡è®°å½•ä¸ºå·²æŸ¥çœ‹
    $card.find('.exam-image').on('click', function() {
      var src = $(this).data('src');
      if (clinicalSession.examination_images_viewed.indexOf(src) === -1) {
        clinicalSession.examination_images_viewed.push(src);
      }
      showImageModal(src);
    });
  }

  function showImageModal(src) {
    var modalHtml = '';
    modalHtml += '<div class="modal fade" id="examImageModal" tabindex="-1" role="dialog">';
    modalHtml += '<div class="modal-dialog modal-lg" role="document">';
    modalHtml += '<div class="modal-content">';
    modalHtml += '<div class="modal-body text-center">';
    modalHtml += '<img src="' + src + '" class="img-fluid">';
    modalHtml += '</div>';
    modalHtml += '<div class="modal-footer">';
    modalHtml += '<button type="button" class="btn btn-secondary" data-dismiss="modal">å…³é—­</button>'; 
    modalHtml += '</div></div></div></div>';

    $('#examImageModal').remove();
    $('body').append(modalHtml);
    $('#examImageModal').modal('show');
  }
  
  // OCTå›¾åƒä¸“ç”¨æ¨¡æ€æ¡†
  function showOctImageModal(src, eye, measurements) {
    var modalHtml = '';
    modalHtml += '<div class="modal fade" id="octImageModal" tabindex="-1" role="dialog">';
    modalHtml += '<div class="modal-dialog modal-xl" role="document">';
    modalHtml += '<div class="modal-content">';
    
    // æ¨¡æ€æ¡†å¤´éƒ¨
    modalHtml += '<div class="modal-header bg-primary text-white">';
    modalHtml += '<h5 class="modal-title">';
    modalHtml += '<i class="fas fa-microscope me-2"></i>OCTæ£€æŸ¥å›¾åƒ - ' + (eye === 'left' ? 'å·¦çœ¼' : 'å³çœ¼');
    modalHtml += '</h5>';
    modalHtml += '<button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>';
    modalHtml += '</div>';
    
    // æ¨¡æ€æ¡†å†…å®¹
    modalHtml += '<div class="modal-body">';
    modalHtml += '<div class="row">';
    
    // å›¾åƒæ˜¾ç¤ºåŒºåŸŸ
    modalHtml += '<div class="col-md-8">';
    modalHtml += '<div class="oct-modal-image-container">';
    modalHtml += '<img src="' + src + '" class="img-fluid oct-modal-image" ';
    modalHtml += 'style="width: 100%; border-radius: 8px; border: 2px solid #dee2e6;">';
    
    // å›¾åƒå·¥å…·æ 
    modalHtml += '<div class="image-toolbar mt-3">';
    modalHtml += '<div class="btn-group" role="group">';
    modalHtml += '<button type="button" class="btn btn-outline-primary btn-sm" onclick="zoomImage(\'in\')">';
    modalHtml += '<i class="fas fa-search-plus"></i> æ”¾å¤§</button>';
    modalHtml += '<button type="button" class="btn btn-outline-primary btn-sm" onclick="zoomImage(\'out\')">';
    modalHtml += '<i class="fas fa-search-minus"></i> ç¼©å°</button>';
    modalHtml += '<button type="button" class="btn btn-outline-primary btn-sm" onclick="resetImageZoom()">';
    modalHtml += '<i class="fas fa-expand-arrows-alt"></i> é‡ç½®</button>';
    modalHtml += '<button type="button" class="btn btn-outline-secondary btn-sm" onclick="toggleImageMeasurement()">';
    modalHtml += '<i class="fas fa-ruler"></i> æµ‹é‡</button>';
    modalHtml += '</div>';
    modalHtml += '</div>';
    
    modalHtml += '</div>';
    modalHtml += '</div>';
    
    // æµ‹é‡æ•°æ®å’Œåˆ†æé¢æ¿
    modalHtml += '<div class="col-md-4">';
    modalHtml += '<div class="oct-analysis-panel">';
    
    modalHtml += '<h6 class="text-primary mb-3">';
    modalHtml += '<i class="fas fa-chart-line me-2"></i>åˆ†ææ•°æ®';
    modalHtml += '</h6>';
    
    if (measurements && Object.keys(measurements).length > 0) {
      modalHtml += '<div class="measurements-list">';
      Object.keys(measurements).forEach(function(key) {
        var value = measurements[key];
        var displayName = getOctMeasurementDisplayName(key);
        modalHtml += '<div class="measurement-item mb-3 p-3 bg-light rounded">';
        modalHtml += '<div class="measurement-name small text-muted mb-1">' + displayName + '</div>';
        modalHtml += '<div class="measurement-value h6 text-primary mb-0">' + value + '</div>';
        modalHtml += '</div>';
      });
      modalHtml += '</div>';
    } else {
      modalHtml += '<div class="alert alert-light">';
      modalHtml += '<small class="text-muted">æš‚æ— æµ‹é‡æ•°æ®</small>';
      modalHtml += '</div>';
    }
    
    // åˆ†æè¦ç‚¹
    modalHtml += '<div class="analysis-points mt-4">';
    modalHtml += '<h6 class="text-secondary mb-3">';
    modalHtml += '<i class="fas fa-eye me-2"></i>è§‚å¯Ÿè¦ç‚¹';
    modalHtml += '</h6>';
    modalHtml += '<ul class="list-unstyled small">';
    modalHtml += '<li class="mb-2"><i class="fas fa-arrow-right text-primary me-2"></i>è§†ç½‘è†œå„å±‚ç»“æ„</li>';
    modalHtml += '<li class="mb-2"><i class="fas fa-arrow-right text-primary me-2"></i>è§†ç½‘è†œåšåº¦å˜åŒ–</li>';
    modalHtml += '<li class="mb-2"><i class="fas fa-arrow-right text-primary me-2"></i>ç—…ç†æ€§æ”¹å˜</li>';
    modalHtml += '<li class="mb-2"><i class="fas fa-arrow-right text-primary me-2"></i>ç§¯æ¶²æˆ–å‡ºè¡€</li>';
    modalHtml += '</ul>';
    modalHtml += '</div>';
    
    modalHtml += '</div>';
    modalHtml += '</div>';
    
    modalHtml += '</div>';
    modalHtml += '</div>';
    
    // æ¨¡æ€æ¡†åº•éƒ¨
    modalHtml += '<div class="modal-footer">';
    modalHtml += '<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">';
    modalHtml += '<i class="fas fa-times me-2"></i>å…³é—­';
    modalHtml += '</button>';
    modalHtml += '<button type="button" class="btn btn-primary" onclick="saveImageAnnotation()">';
    modalHtml += '<i class="fas fa-save me-2"></i>ä¿å­˜æ ‡æ³¨';
    modalHtml += '</button>';
    modalHtml += '</div>';
    
    modalHtml += '</div></div></div>';

    // ç§»é™¤å·²å­˜åœ¨çš„æ¨¡æ€æ¡†å¹¶æ·»åŠ æ–°çš„
    $('#octImageModal').remove();
    $('body').append(modalHtml);
    
    // æ˜¾ç¤ºæ¨¡æ€æ¡†
    $('#octImageModal').modal('show');
  }

  // æ˜¾ç¤ºçœ¼åº•æ£€æŸ¥å­—å¹•
  function showFundusSubtitle() {
    // åˆ›å»ºå­—å¹•è¦†ç›–å±‚
    if (!$('#fundus-overlay').length) {
      var overlayHtml = '<div id="fundus-overlay">';
      overlayHtml += '<div id="fundus-subtitle">è¯·ç§»æ­¥æ—è¾¹è¿›è¡Œè§‚å¯Ÿ</div>';
      overlayHtml += '</div>';
      $('body').append(overlayHtml);
    }
    
    var $overlay = $('#fundus-overlay');
    var $subtitle = $('#fundus-subtitle');
    
    // æ˜¾ç¤ºåŠ¨ç”»åºåˆ—
    $overlay.addClass('show');
    
    // 3ç§’åå¼€å§‹æ·¡å‡ºï¼Œä½†ä¿æŒæ˜¾ç¤ºç›´åˆ°ç”¨æˆ·æ“ä½œ
    setTimeout(function() {
      if (!clinicalSession.fundusSubtitleDismissed) {
        // æ·»åŠ è½»å¾®çš„è„‰å†²æé†’ï¼Œä½†ä¸å®Œå…¨æ¶ˆå¤±
        $subtitle.css('animation', 'pulse-glow 2s ease-in-out infinite');
      }
    }, 3000);
  }
  
  // éšè—çœ¼åº•æ£€æŸ¥å­—å¹•
  function hideFundusSubtitle() {
    var $overlay = $('#fundus-overlay');
    clinicalSession.fundusSubtitleDismissed = true;
    
    $overlay.removeClass('show');
    setTimeout(function() {
      $overlay.remove();
    }, 800); // ç­‰å¾…æ·¡å‡ºåŠ¨ç”»å®Œæˆ
  }

  function updateExaminationSummary() {
    var selectedCount = clinicalSession.selectedExaminations.length;
    var totalCost = 0;
    var riskLevels = [];
    var efficiencyScore = 100; // åŸºç¡€æ•ˆç‡åˆ†
    
    $('.examination-checkbox:checked').each(function() {
      var $card = $(this).closest('.examination-option');
      var cost = parseInt($card.find('.examination-info').text().match(/Â¥(\d+)/)?.[1] || 0);
      totalCost += cost;
      
      // ç§»é™¤é«˜ä»·å€¼æ£€æŸ¥ç»Ÿè®¡ï¼Œé¿å…éšæ€§æç¤º
      
      var riskText = $card.find('.examination-info').text();
      if (riskText.includes('é«˜')) riskLevels.push('high');
      else if (riskText.includes('ä¸­')) riskLevels.push('medium');
      else riskLevels.push('low');
    });
    
    // ç»¼åˆé£é™©è¯„ä¼°
    var overallRisk = 'ä½';
    if (riskLevels.includes('high')) overallRisk = 'é«˜';
    else if (riskLevels.includes('medium')) overallRisk = 'ä¸­';
    
    // è®¡ç®—æ£€æŸ¥æ•ˆç‡ï¼ˆåŸºäºé€‰æ‹©æ•°é‡çš„åˆç†æ€§ï¼‰
    if (selectedCount > 8) efficiencyScore -= (selectedCount - 8) * 10;
    if (selectedCount < 2) efficiencyScore -= (2 - selectedCount) * 20;
    
    $('#selected-count').text(selectedCount);
    $('#total-cost').text('Â¥' + totalCost);
  }
  
  // æ˜¾ç¤ºæ£€æŸ¥é€‰æ‹©å¾—åˆ†è¯¦æƒ…
  function showExaminationScoreDetails(scoreDetails) {
    var html = '<div class="alert alert-info score-details-alert" style="margin-top: 15px;">';
    html += '<h6 class="mb-3"><i class="fas fa-chart-bar me-2"></i>æ£€æŸ¥é€‰æ‹©å¾—åˆ†è¯¦æƒ…</h6>';
    html += '<div class="row text-center">';
    
    html += '<div class="col-md-3 col-6 mb-2">';
    html += '<div class="score-item">';
    html += '<div class="score-value text-primary fw-bold" style="font-size: 1.2rem;">' + scoreDetails.total_score + '</div>';
    html += '<div class="score-label small text-muted">æ€»åˆ†</div>';
    html += '</div>';
    html += '</div>';
    
    html += '<div class="col-md-3 col-6 mb-2">';
    html += '<div class="score-item">';
    html += '<div class="score-value text-danger fw-bold">' + scoreDetails.required_score + '</div>';
    html += '<div class="score-label small text-muted">å¿…é€‰æ£€æŸ¥ (60%)</div>';
    html += '<div class="score-stats small text-muted">(' + scoreDetails.required_stats + ')</div>';
    html += '</div>';
    html += '</div>';
    
    html += '<div class="col-md-4 col-6 mb-2">';
    html += '<div class="score-item">';
    html += '<div class="score-value text-info fw-bold">' + scoreDetails.required_score + '</div>';
    html += '<div class="score-label small text-muted">å¿…é€‰æ£€æŸ¥ (70%)</div>';
    html += '<div class="score-stats small text-muted">(' + scoreDetails.required_stats + ')</div>';
    html += '</div>';
    html += '</div>';
    
    html += '<div class="col-md-4 col-6 mb-2">';
    html += '<div class="score-item">';
    html += '<div class="score-value text-warning fw-bold">' + scoreDetails.efficiency_score + '</div>';
    html += '<div class="score-label small text-muted">æ£€æŸ¥æ•ˆç‡ (30%)</div>';
    html += '<div class="score-stats small text-muted">(' + scoreDetails.efficiency_stats + ')</div>';
    html += '</div>';
    html += '</div>';
    
    html += '</div>';
    
    // æ·»åŠ å¾—åˆ†è¯´æ˜
    html += '<div class="mt-3 p-2 bg-light rounded">';
    html += '<small class="text-muted">';
    html += '<i class="fas fa-info-circle me-1"></i>';
    html += '<strong>è¯„åˆ†è¯´æ˜ï¼š</strong> ';
    html += 'å¿…é€‰æ£€æŸ¥å 70%ï¼ˆä¸´åºŠè¯Šæ–­å¿…éœ€ï¼‰ï¼Œæ£€æŸ¥æ•ˆç‡å 30%ï¼ˆé¿å…ä¸å¿…è¦çš„é‡å¤æ£€æŸ¥ï¼Œæé«˜è¯Šæ–­æ•ˆç‡ï¼‰';
    html += '</small>';
    html += '</div>';
    
    html += '</div>';
    
    // æ˜¾ç¤ºå¾—åˆ†è¯¦æƒ…ï¼Œ8ç§’åè‡ªåŠ¨éšè—
    $('#feedback-panel').append(html);
    
    setTimeout(function() {
      $('.score-details-alert').fadeOut(800, function() {
        $(this).remove();
      });
    }, 8000);
  }

  function provideLiveExaminationFeedback() {
    var selectedCount = clinicalSession.selectedExaminations.length;
    var feedback = '';
    
    if (selectedCount === 0) {
      feedback = '<div class="alert alert-info">è¯·å¼€å§‹é€‰æ‹©æ£€æŸ¥é¡¹ç›®</div>';
    } else if (selectedCount < 3) {
      feedback = '<div class="alert alert-warning">è€ƒè™‘æ˜¯å¦éœ€è¦æ›´å¤šæ£€æŸ¥æ¥æ˜ç¡®è¯Šæ–­</div>';
    } else if (selectedCount > 8) {
      feedback = '<div class="alert alert-danger">æ£€æŸ¥è¿‡å¤šå¯èƒ½å¢åŠ æˆæœ¬å’Œæ‚£è€…è´Ÿæ‹…</div>';
    } else {
      feedback = '<div class="alert alert-success">æ£€æŸ¥é€‰æ‹©åˆç†ï¼Œè¯·ç»§ç»­</div>';
    }
    
    $('#feedback-panel').html(feedback);
  }

  function submitExaminations() {
    // éªŒè¯å¿…é€‰æ£€æŸ¥æ˜¯å¦è¢«é€‰ä¸­
    var requiredMissing = [];
    $('.examination-checkbox').each(function() {
      var isRequired = $(this).data('is-required') === 1 || $(this).data('is-required') === true;
      if (isRequired) {
        var id = parseInt($(this).val());
        if (clinicalSession.selectedExaminations.indexOf(id) === -1) {
          requiredMissing.push(id);
        }
      }
    });

    if (requiredMissing.length > 0) {
      showFeedbackMessage('å­˜åœ¨é‡è¦æ£€æŸ¥é¡¹ç›®æœªé€‰æ‹©ï¼Œå»ºè®®å®Œå–„æ£€æŸ¥åå†ç»§ç»­', 'warning');
      return;
    }

    // æ˜¾ç¤ºæäº¤ä¸­çŠ¶æ€
    $('#btn-next').prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i> æäº¤ä¸­...');
    showFeedbackMessage('æ­£åœ¨æäº¤æ£€æŸ¥é€‰æ‹©...', 'info');

    // å‡†å¤‡æäº¤æ•°æ®
    var submitData = {
      case_id: clinicalSession.caseId,
      selected_examinations: clinicalSession.selectedExaminations,
      images_viewed: clinicalSession.examination_images_viewed
    };

    $.ajax({
      url: '/api/clinical/submit-examinations/',
      method: 'POST',
      contentType: 'application/json',
      headers: {
        'X-CSRFToken': $('[name=csrfmiddlewaretoken]').val() || getCsrfToken()
      },
      data: JSON.stringify(submitData),
      success: function(resp) {
        $('#btn-next').prop('disabled', false).html('ä¸‹ä¸€æ­¥ <i class="fas fa-arrow-right"></i>');

        if (resp.success) {
          // è®°å½•æ£€æŸ¥é˜¶æ®µå®Œæˆ
          addToLearningTimeline('å®Œæˆæ£€æŸ¥é€‰æ‹©', 'é€‰æ‹©äº† ' + clinicalSession.selectedExaminations.length + ' é¡¹æ£€æŸ¥');

          // æ›´æ–°åˆ†æ•°
          if (resp.data.examination_score !== undefined) {
            clinicalSession.scores.examination = resp.data.examination_score;
            $('#current-score').text(resp.data.examination_score.toFixed(1));
            
            // æ˜¾ç¤ºå¾—åˆ†è¯¦æƒ…
            if (resp.data.score_details) {
              showExaminationScoreDetails(resp.data.score_details);
            }
          }

          // è¿›å…¥è¯Šæ–­é˜¶æ®µ
          renderDiagnosisStage(resp.data);
          showFeedbackMessage('æ£€æŸ¥ç»“æœå·²è·å¾—ï¼Œè¯·å¼€å§‹è¯Šæ–­åˆ†æ', 'success');
          // è§†è§‰åé¦ˆ
          flashCard($('#feedback-panel'), 'success');
          launchConfetti(25);
        } else {
          showFeedbackMessage('æäº¤å¤±è´¥: ' + resp.message, 'danger');
        }
      },
      error: function(xhr, status, error) {
        $('#btn-next').prop('disabled', false).html('ä¸‹ä¸€æ­¥ <i class="fas fa-arrow-right"></i>');
        console.error('Submit examination error:', error, xhr.responseText);

        if (xhr.status === 404) {
          showFeedbackMessage('APIæ¥å£æœªæ‰¾åˆ°ï¼Œè¯·æ£€æŸ¥åç«¯é…ç½®', 'danger');
        } else if (xhr.status === 403) {
          showFeedbackMessage('æƒé™ä¸è¶³ï¼Œè¯·é‡æ–°ç™»å½•', 'danger');
        } else if (xhr.status === 500) {
          showFeedbackMessage('æœåŠ¡å™¨å†…éƒ¨é”™è¯¯ï¼Œè¯·è”ç³»ç®¡ç†å‘˜', 'danger');
        } else {
          showFeedbackMessage('ç½‘ç»œé”™è¯¯ï¼Œè¯·æ£€æŸ¥è¿æ¥: ' + error, 'danger');
        }
      }
    });
  }

  
  // ==================== è¯Šæ–­é˜¶æ®µï¼šé‰´åˆ«è¯Šæ–­æ¨ç† ====================
  
  function renderDiagnosisStage(data) {
    clinicalSession.currentStage = 'diagnosis';
    updateClinicalProgress();
    updateStageProgress();
    
    $('#btn-next').prop('disabled', false).text('æäº¤è¯Šæ–­é€‰æ‹© â†’').removeClass('btn-warning').addClass('btn-info');
    updateStageCard('è¯Šæ–­æ¨ç†é˜¶æ®µ', 'diagnosis');
    
    var html = '<div class="diagnosis-stage">';
    
    // æ£€æŸ¥ç»“æœå±•ç¤º - å°å¡ç‰‡å½¢å¼
    html += '<div class="examination-results mb-4">';
    html += '<h5 class="text-primary mb-3"><i class="fas fa-microscope me-2"></i> æ£€æŸ¥ç»“æœ</h5>';
    
    if (data.examination_results && data.examination_results.length > 0) {
      html += '<div class="row g-3">';
      data.examination_results.forEach(function(result) {
        html += '<div class="col-12">';
        html += '<div class="exam-result-card">';
        
        // æ£€æŸ¥é¡¹ç›®å¤´éƒ¨
        html += '<div class="exam-header">';
        html += '<div class="d-flex align-items-center justify-content-between">';
        html += '<div class="exam-title">';
        html += '<i class="fas fa-eye text-primary me-2"></i>';
        html += '<span class="fw-bold text-dark">' + result.name + '</span>';
        html += '</div>';
        // ç§»é™¤æ¨èæ£€æŸ¥æ ‡ç­¾ï¼Œé¿å…éšæ€§æç¤º
        // if (result.is_recommended) {
        //   html += '<span class="badge bg-success">æ¨èæ£€æŸ¥</span>';
        // }
        html += '</div>';
        html += '</div>';
        
        // æ£€æŸ¥ç»“æœå†…å®¹
        html += '<div class="exam-content">';
        html += '<div class="result-label">æ£€æŸ¥ç»“æœ</div>';
        html += '<div class="result-text">' + (result.result || 'æœªè®°å½•') + '</div>';
        html += '</div>';
        
        html += '</div>';
        html += '</div>';
      });
      html += '</div>';
    } else {
      html += '<div class="alert alert-warning border-0 bg-warning bg-opacity-10">';
      html += '<i class="fas fa-exclamation-triangle text-warning me-2"></i>';
      html += 'æš‚æ— æ£€æŸ¥ç»“æœæ•°æ®';
      html += '</div>';
    }
    html += '</div>';
    
    // è¯Šæ–­é€‰é¡¹
    html += '<div class="diagnosis-options">';
    html += '<h4 class="text-info mb-4" style="font-weight: 700; display: flex; align-items: center;">';
    html += '<i class="fas fa-user-md me-2" style="font-size: 1.3rem; color: #17a2b8;"></i>é‰´åˆ«è¯Šæ–­';
    html += '</h4>';
    html += '<div class="alert alert-info" style="background: linear-gradient(135deg, #d1ecf1 0%, #bee5eb 100%); border: none; border-radius: 12px; padding: 20px;">';
    html += '<h5 class="mb-3" style="color: #0c5460; font-weight: 700; display: flex; align-items: center;">';
    html += '<i class="fas fa-brain me-2" style="font-size: 1.2rem; color: #6f42c1;"></i>è¯Šæ–­æ€ç»´æŒ‡å¯¼';
    html += '</h5>';
    html += '<p class="mb-0" style="font-size: 1rem; line-height: 1.6; color: #0c5460;">ç»¼åˆæ‚£è€…ç—…å²å’Œæ£€æŸ¥ç»“æœï¼Œè¿›è¡Œé‰´åˆ«è¯Šæ–­ã€‚ä»”ç»†åˆ†ææ¯ä¸ªè¯Šæ–­çš„ç¬¦åˆåº¦ï¼Œé€‰æ‹©æœ€å¯èƒ½çš„è¯Šæ–­é€‰é¡¹ã€‚</p>';
    html += '</div>';
    
    // å¦‚æœåç«¯æ²¡æœ‰è¯Šæ–­é€‰é¡¹ï¼Œåˆ›å»ºåŸºäºæ¡ˆä¾‹çš„ä¸´åºŠè¯Šæ–­é€‰é¡¹
    var diagnosisOptions = data.diagnosis_options;
    if (!diagnosisOptions || diagnosisOptions.length === 0) {
      // åŸºäºçœ¼åº•å‡ºè¡€ç—…ä¾‹çš„å¸¸è§è¯Šæ–­é€‰é¡¹
      diagnosisOptions = [
        {
          id: 1,
          name: 'ç³–å°¿ç—…è§†ç½‘è†œç—…å˜',
          code: 'H36.0',
          description: 'ç³–å°¿ç—…å¼•èµ·çš„è§†ç½‘è†œå¾®è¡€ç®¡ç—…å˜ï¼Œå‡ºç°å‡ºè¡€ã€æ¸—å‡ºç­‰',
          probability_score: 0.75,
          is_correct: false
        },
        {
          id: 2, 
          name: 'é«˜è¡€å‹æ€§è§†ç½‘è†œç—…å˜',
          code: 'H35.0',
          description: 'é«˜è¡€å‹å¼•èµ·çš„è§†ç½‘è†œè¡€ç®¡æ”¹å˜ï¼Œå¯è§å‡ºè¡€ã€æ¸—å‡º',
          probability_score: 0.65,
          is_correct: false
        },
        {
          id: 3,
          name: 'è§†ç½‘è†œé™è„‰é˜»å¡',
          code: 'H34.8',
          description: 'è§†ç½‘è†œé™è„‰è¡€æµå—é˜»ï¼Œå¯¼è‡´è§†ç½‘è†œå‡ºè¡€å’Œæ°´è‚¿',
          probability_score: 0.85,
          is_correct: true
        },
        {
          id: 4,
          name: 'Valsalvaè§†ç½‘è†œç—…å˜',
          code: 'H35.6',
          description: 'ç”¨åŠ›è¿‡åº¦å¼•èµ·çš„è§†ç½‘è†œè¡¨å±‚å‡ºè¡€ï¼Œå¤šè§äºå¹´è½»äºº',
          probability_score: 0.90,
          is_correct: true
        },
        {
          id: 5,
          name: 'å¤–ä¼¤æ€§è§†ç½‘è†œç—…å˜',
          code: 'S05.8',
          description: 'çœ¼å¤–ä¼¤å¯¼è‡´çš„è§†ç½‘è†œå‡ºè¡€ï¼Œéœ€è¯¢é—®å¤–ä¼¤å²',
          probability_score: 0.45,
          is_correct: false
        }
      ];
    }
    
    // ç¼“å­˜è¯Šæ–­é€‰é¡¹æ•°æ®
    clinicalSession.diagnosisOptions = diagnosisOptions;
    
    if (diagnosisOptions && diagnosisOptions.length > 0) {
      html += '<form id="diagnosis-form">';
      diagnosisOptions.forEach(function(option) {
        html += '<div class="card diagnosis-option mb-3" data-diagnosis-id="' + option.id + '" style="border: 2px solid transparent; transition: all 0.3s ease;">';
        html += '<div class="card-body">';
        html += '<div class="d-flex align-items-start">';
        html += '<input class="form-check-input diagnosis-radio me-3 mt-1" type="radio" name="diagnosis" ';
        html += 'value="' + option.id + '" id="diag_' + option.id + '" style="flex-shrink: 0;">';
        html += '<label class="form-check-label flex-grow-1" for="diag_' + option.id + '">';
        html += '<div class="d-flex justify-content-between align-items-start">';
        html += '<div class="flex-grow-1">';
        html += '<h6 class="mb-1" style="color: #2c3e50; font-weight: 600;">' + option.name + '</h6>';
        if (option.code) {
          html += '<small class="text-muted d-block mb-2"><i class="fas fa-code me-1"></i>ICDç¼–ç : ' + option.code + '</small>';
        }
        if (option.description) {
          html += '<p class="text-muted small mb-0" style="line-height: 1.4;">' + option.description + '</p>';
        }
        html += '</div>';
        if (option.probability_score !== undefined) {
          html += '<div class="diagnosis-probability ms-3">';
          var percentage = (option.probability_score * 100).toFixed(0);
          var badgeClass = percentage >= 80 ? 'badge-success' : percentage >= 60 ? 'badge-warning' : 'badge-secondary';
          html += '<span class="badge ' + badgeClass + '">ç¬¦åˆåº¦: ' + percentage + '%</span>';
          html += '</div>';
        }
        html += '</div>';
        html += '</label>';
        html += '</div>';
        html += '</div>';
        html += '</div>';
      });
      html += '</form>';
    } else {
      html += '<div class="alert alert-warning">æš‚æ— è¯Šæ–­é€‰é¡¹æ•°æ®</div>';
    }
    
    html += '</div>';
    html += '</div>';
    
    $('#stage-content').html(html);
    
    // æ¢å¤ä¹‹å‰çš„é€‰æ‹©çŠ¶æ€ï¼ˆå¦‚æœæœ‰çš„è¯ï¼‰
    if (clinicalSession.selectedDiagnosis) {
      $('input[name="diagnosis"][value="' + clinicalSession.selectedDiagnosis + '"]').prop('checked', true);
      $('.diagnosis-option[data-diagnosis-id="' + clinicalSession.selectedDiagnosis + '"]').addClass('selected');
    }
    
    // ç»‘å®šè¯Šæ–­é€‰æ‹©äº‹ä»¶
    bindDiagnosisEvents();
    showClinicalThinkingPrompt('diagnosis');
    
    // ç¡®ä¿æŒ‰é’®çŠ¶æ€æ­£ç¡® - è¯Šæ–­é˜¶æ®µæŒ‰é’®åº”å§‹ç»ˆå¯ç”¨
    setTimeout(function() {
      ensureButtonEnabled();
    }, 100);
  }
  
  function bindDiagnosisEvents() {
    $('.diagnosis-radio').off('change').on('change', function() {
      var diagnosisId = parseInt($(this).val());
      var $card = $(this).closest('.diagnosis-option');
      
      console.log('=== è¯Šæ–­é€‰æ‹©äº‹ä»¶è§¦å‘ ===');
      console.log('é€‰ä¸­çš„è¯Šæ–­ID:', diagnosisId);
      console.log('è¯Šæ–­é€‰é¡¹å¡:', $card);
      
      // ç§»é™¤å…¶ä»–é€‰ä¸­çŠ¶æ€
      $('.diagnosis-option').removeClass('selected');
      
      // è®¾ç½®å½“å‰é€‰ä¸­
      $card.addClass('selected');
      clinicalSession.selectedDiagnosis = diagnosisId;
      
      console.log('clinicalSession.selectedDiagnosiså·²è®¾ç½®ä¸º:', clinicalSession.selectedDiagnosis);
      
      // éªŒè¯é€‰æ‹©æ˜¯å¦æˆåŠŸ
      setTimeout(function() {
        console.log('å»¶æ—¶éªŒè¯ - selectedDiagnosis:', clinicalSession.selectedDiagnosis);
        if (clinicalSession.selectedDiagnosis) {
          console.log('âœ… è¯Šæ–­é€‰æ‹©æˆåŠŸï¼');
        } else {
          console.log('âŒ è¯Šæ–­é€‰æ‹©å¤±è´¥ï¼');
        }
      }, 100);
      
      // è®°å½•é€‰æ‹©
      var diagnosisName = $(this).siblings('label').find('h6').text();
      addToLearningTimeline('é€‰æ‹©è¯Šæ–­', diagnosisName);
      
      // æä¾›å³æ—¶åé¦ˆ
      showFeedbackMessage('å·²é€‰æ‹©è¯Šæ–­ï¼š' + diagnosisName + 'ï¼Œå¯ä»¥ç‚¹å‡»æäº¤æŒ‰é’®ç»§ç»­', 'success');
      
      // æŒ‰é’®å§‹ç»ˆä¿æŒå¯ç”¨çŠ¶æ€
      ensureButtonEnabled();
      console.log('è¯Šæ–­å·²é€‰æ‹©ï¼ŒæŒ‰é’®ä¿æŒå¯ç”¨:', clinicalSession.selectedDiagnosis);
    });
    
    $('.diagnosis-option').off('click').on('click', function(e) {
      console.log('è¯Šæ–­é€‰é¡¹å¡ç‰‡è¢«ç‚¹å‡»:', $(this));
      if (e.target.type !== 'radio') {
        var radio = $(this).find('.diagnosis-radio');
        console.log('æ‰¾åˆ°çš„radioæŒ‰é’®:', radio);
        radio.prop('checked', true).trigger('change');
      }
    });
  }
  
  // ==================== å½±åƒæ£€æŸ¥æ¸²æŸ“å‡½æ•° ====================
  
  // OCTæ£€æŸ¥å›¾åƒæ¸²æŸ“
  function renderOctImages(resultData) {
    var html = '';
    
    html += '<div class="oct-examination-display">';
    html += '<div class="oct-header mb-3">';
    html += '<div class="alert alert-info border-0" style="background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);">';
    html += '<div class="d-flex align-items-center">';
    html += '<i class="fas fa-microscope text-primary me-3" style="font-size: 1.5rem;"></i>';
    html += '<div>';
    html += '<h6 class="mb-1" style="color: #1565c0;">OCTå…‰å­¦ç›¸å¹²æ–­å±‚æ‰«æ</h6>';
    html += '<small class="text-muted">è¯·ä»”ç»†è§‚å¯Ÿè§†ç½‘è†œå„å±‚ç»“æ„å’Œç—…ç†æ”¹å˜</small>';
    html += '</div>';
    html += '</div>';
    html += '</div>';
    html += '</div>';
    
    // OCTæµ‹é‡æ•°æ®æ˜¾ç¤ºï¼ˆå¦‚æœæœ‰ï¼‰
    if (resultData.oct_measurement_data) {
      html += '<div class="oct-measurements mb-4">';
      html += '<h6 class="text-primary mb-3"><i class="fas fa-ruler me-2"></i>æµ‹é‡æ•°æ®</h6>';
      html += '<div class="row g-3">';
      
      Object.keys(resultData.oct_measurement_data).forEach(function(key) {
        var value = resultData.oct_measurement_data[key];
        var displayName = getOctMeasurementDisplayName(key);
        html += '<div class="col-md-4 col-6">';
        html += '<div class="measurement-card p-3 bg-light rounded border">';
        html += '<div class="measurement-label small text-muted mb-1">' + displayName + '</div>';
        html += '<div class="measurement-value h6 mb-0 text-primary">' + value + '</div>';
        html += '</div>';
        html += '</div>';
      });
      
      html += '</div>';
      html += '</div>';
    }
    
    // åŒçœ¼å¯¹æ¯”æ˜¾ç¤º
    html += '<div class="oct-images-display">';
    html += '<div class="row g-4">';
    
    // å¤„ç†å›¾åƒæ•°ç»„
    var leftEyeImages = [];
    var rightEyeImages = [];
    
    resultData.images.forEach(function(image) {
      var imageObj = typeof image === 'string' ? {url: image} : image;
      
      if (imageObj.eye === 'left' || imageObj.label === 'å·¦çœ¼' || 
          (imageObj.description && imageObj.description.indexOf('å·¦çœ¼') !== -1)) {
        leftEyeImages.push(imageObj);
      } else if (imageObj.eye === 'right' || imageObj.label === 'å³çœ¼' || 
                (imageObj.description && imageObj.description.indexOf('å³çœ¼') !== -1)) {
        rightEyeImages.push(imageObj);
      } else {
        // å¦‚æœæ— æ³•ç¡®å®šï¼Œé»˜è®¤æŒ‰é¡ºåºåˆ†é…
        if (leftEyeImages.length <= rightEyeImages.length) {
          leftEyeImages.push(imageObj);
        } else {
          rightEyeImages.push(imageObj);
        }
      }
    });
    
    // å·¦çœ¼æ˜¾ç¤º
    if (leftEyeImages.length > 0) {
      html += '<div class="col-md-6">';
      html += '<div class="eye-section">';
      html += '<h6 class="text-center mb-3 p-2 bg-primary text-white rounded">';
      html += '<i class="fas fa-eye me-2"></i>å·¦çœ¼ OCT</h6>';
      
      leftEyeImages.forEach(function(image) {
        html += '<div class="oct-image-container mb-3">';
        html += '<div class="position-relative">';
        html += '<img src="' + (image.url || image) + '" class="img-fluid rounded oct-image" ';
        html += 'style="width: 100%; cursor: zoom-in; border: 2px solid #dee2e6;" ';
        html += 'data-bs-toggle="modal" data-bs-target="#octImageModal" ';
        html += 'data-image-src="' + (image.url || image) + '" ';
        html += 'data-eye="left">';
        
        // å›¾åƒæ ‡æ³¨å±‚
        html += '<div class="image-overlay d-none">';
        html += '<div class="overlay-controls">';
        html += '<button class="btn btn-sm btn-light me-2" onclick="toggleImageAnnotations(this)">';
        html += '<i class="fas fa-tags"></i> æ ‡æ³¨</button>';
        html += '<button class="btn btn-sm btn-light" onclick="toggleImageMeasurement(this)">';
        html += '<i class="fas fa-ruler"></i> æµ‹é‡</button>';
        html += '</div>';
        html += '</div>';
        
        html += '</div>';
        
        if (image.description) {
          html += '<p class="text-muted small mt-2 text-center">' + image.description + '</p>';
        }
        html += '</div>';
      });
      
      html += '</div>';
      html += '</div>';
    }
    
    // å³çœ¼æ˜¾ç¤º
    if (rightEyeImages.length > 0) {
      html += '<div class="col-md-6">';
      html += '<div class="eye-section">';
      html += '<h6 class="text-center mb-3 p-2 bg-success text-white rounded">';
      html += '<i class="fas fa-eye me-2"></i>å³çœ¼ OCT</h6>';
      
      rightEyeImages.forEach(function(image) {
        html += '<div class="oct-image-container mb-3">';
        html += '<div class="position-relative">';
        html += '<img src="' + (image.url || image) + '" class="img-fluid rounded oct-image" ';
        html += 'style="width: 100%; cursor: zoom-in; border: 2px solid #dee2e6;" ';
        html += 'data-bs-toggle="modal" data-bs-target="#octImageModal" ';
        html += 'data-image-src="' + (image.url || image) + '" ';
        html += 'data-eye="right">';
        
        // å›¾åƒæ ‡æ³¨å±‚
        html += '<div class="image-overlay d-none">';
        html += '<div class="overlay-controls">';
        html += '<button class="btn btn-sm btn-light me-2" onclick="toggleImageAnnotations(this)">';
        html += '<i class="fas fa-tags"></i> æ ‡æ³¨</button>';
        html += '<button class="btn btn-sm btn-light" onclick="toggleImageMeasurement(this)">';
        html += '<i class="fas fa-ruler"></i> æµ‹é‡</button>';
        html += '</div>';
        html += '</div>';
        
        html += '</div>';
        
        if (image.description) {
          html += '<p class="text-muted small mt-2 text-center">' + image.description + '</p>';
        }
        html += '</div>';
      });
      
      html += '</div>';
      html += '</div>';
    }
    
    html += '</div>';
    html += '</div>';
    
    // OCTæŠ¥å‘Šæ–‡å­—ï¼ˆå¦‚æœæœ‰ï¼‰
    if (resultData.oct_report_text) {
      html += '<div class="oct-report mt-4">';
      html += '<h6 class="text-primary mb-3"><i class="fas fa-file-medical-alt me-2"></i>OCTæŠ¥å‘Š</h6>';
      html += '<div class="report-content p-4 bg-light rounded border-start border-primary border-4">';
      html += '<div class="report-text" style="line-height: 1.8; font-size: 0.95rem;">';
      html += resultData.oct_report_text.replace(/\n/g, '<br>');
      html += '</div>';
      html += '</div>';
      html += '</div>';
    }
    
    html += '</div>';
    
    return html;
  }
  
  // æ ‡å‡†æ£€æŸ¥å›¾åƒæ¸²æŸ“
  function renderStandardImages(resultData) {
    var html = '';
    
    html += '<div class="standard-images-display">';
    html += '<div class="row g-3">';
    
    resultData.images.forEach(function(image, index) {
      var imageObj = typeof image === 'string' ? {url: image} : image;
      var colClass = resultData.images.length === 1 ? 'col-12' : 
                    resultData.images.length === 2 ? 'col-md-6' : 'col-md-4';
      
      html += '<div class="' + colClass + ' mb-3">';
      html += '<div class="standard-image-container">';
      html += '<div class="position-relative">';
      html += '<img src="' + (imageObj.url || imageObj) + '" class="img-fluid rounded examination-image" ';
      html += 'style="max-height: 400px; width: 100%; object-fit: contain; cursor: zoom-in; border: 1px solid #dee2e6;" ';
      html += 'data-bs-toggle="modal" data-bs-target="#imageModal" ';
      html += 'data-image-src="' + (imageObj.url || imageObj) + '" ';
      html += 'data-image-index="' + index + '">';
      html += '</div>';
      
      if (imageObj.description) {
        html += '<p class="text-muted small mt-2 text-center">' + imageObj.description + '</p>';
      }
      
      // å›¾åƒæ‰€è§ï¼ˆå¦‚æœæœ‰ï¼‰
      if (imageObj.findings) {
        html += '<div class="image-findings mt-2 p-2 bg-light rounded">';
        html += '<small class="text-muted"><strong>å½±åƒæ‰€è§ï¼š</strong>' + imageObj.findings + '</small>';
        html += '</div>';
      }
      
      html += '</div>';
      html += '</div>';
    });
    
    html += '</div>';
    html += '</div>';
    
    return html;
  }
  
  // OCTæµ‹é‡æ•°æ®æ˜¾ç¤ºåç§°è½¬æ¢
  function getOctMeasurementDisplayName(key) {
    var displayNames = {
      'central_thickness': 'ä¸­å¿ƒå‡¹åšåº¦',
      'average_thickness': 'å¹³å‡åšåº¦',
      'volume': 'é»„æ–‘ä½“ç§¯',
      'rnfl_superior': 'ä¸Šæ–¹RNFLåšåº¦',
      'rnfl_inferior': 'ä¸‹æ–¹RNFLåšåº¦',
      'rnfl_nasal': 'é¼»ä¾§RNFLåšåº¦',
      'rnfl_temporal': 'é¢ä¾§RNFLåšåº¦',
      'cup_disc_ratio': 'æ¯ç›˜æ¯”',
      'rim_area': 'è§†ç›˜ç¼˜é¢ç§¯'
    };
    return displayNames[key] || key;
  }
  
  // ==================== å·¥å…·å‡½æ•° ====================
  
  function getCsrfToken() {
    // å°è¯•ä»cookieè·å–CSRF token
    var cookieValue = null;
    if (document.cookie && document.cookie !== '') {
      var cookies = document.cookie.split(';');
      for (var i = 0; i < cookies.length; i++) {
        var cookie = cookies[i].trim();
        if (cookie.substring(0, 10) === 'csrftoken=') {
          cookieValue = decodeURIComponent(cookie.substring(10));
          break;
        }
      }
    }
    return cookieValue;
  }

  function submitDiagnosis() {
    console.log('=== å¼€å§‹æäº¤è¯Šæ–­ ===');
    console.log('å½“å‰é€‰ä¸­è¯Šæ–­ID:', clinicalSession.selectedDiagnosis);
    console.log('æ¡ˆä¾‹ID:', clinicalSession.caseId);
    
    // æ˜¾ç¤ºæäº¤ä¸­çŠ¶æ€
    $('#btn-next').prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i> æäº¤ä¸­...');
    showFeedbackMessage('æ­£åœ¨æäº¤è¯Šæ–­é€‰æ‹©...', 'info');
    
    // å‡†å¤‡æäº¤æ•°æ®
    var submitData = {
      case_id: clinicalSession.caseId,
      selected_diagnosis_id: clinicalSession.selectedDiagnosis,
      reasoning: $('#clinical-notes').val() || ''
    };
    
    console.log('æäº¤æ•°æ®:', submitData);
    
    $.ajax({
      url: '/api/clinical/submit-diagnosis/',
      method: 'POST',
      contentType: 'application/json',
      headers: {
        'X-CSRFToken': $('[name=csrfmiddlewaretoken]').val() || getCsrfToken()
      },
      data: JSON.stringify(submitData),
      success: function(resp) {
        console.log('è¯Šæ–­æäº¤æˆåŠŸå“åº”:', resp);
        $('#btn-next').prop('disabled', false).html('ä¸‹ä¸€æ­¥ <i class="fas fa-arrow-right"></i>');
        
        if (resp.success) {
          // è®°å½•è¯Šæ–­é˜¶æ®µå®Œæˆ
          var selectedDiagName = $('.diagnosis-option.selected').find('h6').text();
          addToLearningTimeline('æäº¤è¯Šæ–­', selectedDiagName);
          
          // æ›´æ–°åˆ†æ•°
          if (resp.data.diagnosis_score !== undefined) {
            clinicalSession.scores.diagnosis = resp.data.diagnosis_score;
            $('#current-score').text(resp.data.diagnosis_score.toFixed(1));
          }
          
          // æ˜¾ç¤ºè¯Šæ–­åé¦ˆ
          if (resp.data.diagnosis_feedback) {
            showFeedbackMessage(resp.data.diagnosis_feedback, 'success');
          }
          
          // è¿›å…¥æ²»ç–—é˜¶æ®µ
          renderTreatmentStage(resp.data);
          // è§†è§‰åé¦ˆ
          flashCard($('#feedback-panel'), 'success');
          launchConfetti(20);
        } else {
          showFeedbackMessage('æäº¤å¤±è´¥: ' + resp.message + 'ã€‚è¯·é‡æ–°é€‰æ‹©è¯Šæ–­', 'danger');
          // æ¢å¤æŒ‰é’®çŠ¶æ€ï¼Œå…è®¸ç”¨æˆ·é‡æ–°é€‰æ‹©
          $('#btn-next').prop('disabled', false).html('æäº¤è¯Šæ–­é€‰æ‹© â†’').removeClass('btn-primary').addClass('btn-info');
        }
      },
      error: function(xhr, status, error) {
        console.log('=== è¯Šæ–­æäº¤å¤±è´¥ ===');
        console.log('é”™è¯¯çŠ¶æ€:', status);
        console.log('é”™è¯¯ä¿¡æ¯:', error);
        console.log('å“åº”çŠ¶æ€ç :', xhr.status);
        console.log('å“åº”å†…å®¹:', xhr.responseText);
        console.log('====================');
        
        $('#btn-next').prop('disabled', false).html('æäº¤è¯Šæ–­é€‰æ‹© â†’').removeClass('btn-primary').addClass('btn-info');
        console.error('Submit diagnosis error:', error, xhr.responseText);
        
        if (xhr.status === 404) {
          showFeedbackMessage('APIæ¥å£æœªæ‰¾åˆ°ï¼Œè¯·æ£€æŸ¥åç«¯é…ç½®ã€‚è¯·é‡æ–°é€‰æ‹©è¯Šæ–­', 'danger');
        } else if (xhr.status === 403) {
          showFeedbackMessage('æƒé™ä¸è¶³ï¼Œè¯·é‡æ–°ç™»å½•ã€‚è¯·é‡æ–°é€‰æ‹©è¯Šæ–­', 'danger');
        } else if (xhr.status === 500) {
          showFeedbackMessage('æœåŠ¡å™¨å†…éƒ¨é”™è¯¯ï¼Œè¯·è”ç³»ç®¡ç†å‘˜ã€‚è¯·é‡æ–°é€‰æ‹©è¯Šæ–­', 'danger');
        } else {
          showFeedbackMessage('ç½‘ç»œé”™è¯¯ï¼Œè¯·æ£€æŸ¥è¿æ¥: ' + error + 'ã€‚è¯·é‡æ–°é€‰æ‹©è¯Šæ–­', 'danger');
        }
      }
    });
  }

  
  // ==================== æ²»ç–—é˜¶æ®µï¼šæ²»ç–—å†³ç­– ====================
  
  function renderTreatmentStage(data) {
    clinicalSession.currentStage = 'treatment';
    
    // å¦‚æœè¿™æ˜¯ä»å…¶ä»–é˜¶æ®µå¯¼èˆªå›æ¥çš„ï¼Œä¸è¦æ¸…ç©ºé€‰æ‹©æ•°æ®
    // åªæœ‰åœ¨é¦–æ¬¡è¿›å…¥æ²»ç–—é˜¶æ®µæ—¶æ‰æ¸…ç©º
    if (!clinicalSession.treatmentOptions || clinicalSession.treatmentOptions.length === 0) {
      clinicalSession.selectedTreatments = [];
    }
    
    updateClinicalProgress();
    updateStageProgress();
    
    $('#btn-next').prop('disabled', false).text('æäº¤æ²»ç–—æ–¹æ¡ˆ â†’').removeClass('btn-info').addClass('btn-success');
    updateStageCard('æ²»ç–—å†³ç­–é˜¶æ®µ', 'treatment');
    
    var html = '<div class="treatment-stage">';
    
    // è¯Šæ–­ç¡®è®¤å±•ç¤º
    if (data.selected_diagnosis) {
      html += '<div class="diagnosis-confirmation mb-4">';
      html += '<h5 class="text-success"><i class="fas fa-check-circle"></i> ç¡®è®¤è¯Šæ–­</h5>';
      html += '<div class="card border-success">';
      html += '<div class="card-body">';
      html += '<h6>' + data.selected_diagnosis.name + '</h6>';
      if (data.selected_diagnosis.code) {
        html += '<small class="text-muted">ICDç¼–ç : ' + data.selected_diagnosis.code + '</small><br>';
      }
      if (data.selected_diagnosis.is_correct) {
        html += '<span class="badge badge-success">è¯Šæ–­æ­£ç¡®</span>';
      } else {
        html += '<span class="badge badge-warning">éœ€è¦è¿›ä¸€æ­¥ç¡®è®¤</span>';
      }
      html += '</div>';
      html += '</div>';
      html += '</div>';
    }
    
    // æ²»ç–—æ–¹æ¡ˆé€‰æ‹©
    html += '<div class="treatment-options">';
    html += '<h5 class="text-success"><i class="fas fa-prescription-bottle-alt"></i> æ²»ç–—æ–¹æ¡ˆé€‰æ‹©</h5>';
    html += '<div class="alert alert-success">';
    html += '<h6><i class="fas fa-medkit"></i> æ²»ç–—å†³ç­–æŒ‡å¯¼</h6>';
    html += '<p class="mb-0">åŸºäºç¡®å®šçš„è¯Šæ–­ï¼Œé€‰æ‹©åˆé€‚çš„æ²»ç–—æ–¹æ¡ˆã€‚è€ƒè™‘æ²»ç–—çš„æœ‰æ•ˆæ€§ã€å®‰å…¨æ€§ã€æˆæœ¬æ•ˆç›Šå’Œæ‚£è€…ä¸ªä½“æƒ…å†µã€‚</p>';
    html += '</div>';
    
    // ç¼“å­˜æ²»ç–—é€‰é¡¹æ•°æ®
    if (data.treatment_options) {
      clinicalSession.treatmentOptions = data.treatment_options;
    }
    
    if (clinicalSession.treatmentOptions && clinicalSession.treatmentOptions.length > 0) {
      html += '<form id="treatment-form">';
      
      // æŒ‰æ²»ç–—ç±»å‹åˆ†ç»„
      var groupedTreatments = groupTreatmentsByType(clinicalSession.treatmentOptions);
      
      Object.keys(groupedTreatments).forEach(function(type) {
        var typeOptions = groupedTreatments[type];
        var typeDisplayName = getTreatmentTypeDisplay(type);
        var typeIcon = getTreatmentTypeIcon(type);
        
        html += '<div class="treatment-group mb-4">';
        html += '<h6 class="text-primary mb-3">';
        html += '<i class="' + typeIcon + '"></i> ' + typeDisplayName;
        html += '<small class="text-muted ml-2">(' + typeOptions.length + 'é¡¹)</small>';
        html += '</h6>';
        
        html += '<div class="row">';
        typeOptions.forEach(function(option) {
          html += '<div class="col-md-6 mb-3">';
          html += '<div class="card treatment-option h-100';
          
          // æ ¹æ®æ²»ç–—é€‚å®œæ€§æ·»åŠ æ ·å¼ç±»
          if (option.is_optimal) {
            html += ' optimal';
          } else if (option.is_contraindicated) {
            html += ' contraindicated';
          } else if (option.is_acceptable) {
            html += ' acceptable';
          }
          
          html += '" data-treatment-id="' + option.id + '">';
          html += '<div class="card-body">';
          
          html += '<div class="form-check">';
          html += '<input class="form-check-input treatment-checkbox" type="checkbox" ';
          html += 'value="' + option.id + '" id="treat_' + option.id + '">';
          html += '<label class="form-check-label w-100" for="treat_' + option.id + '">';
          html += '<div class="d-flex justify-content-between align-items-start">';
          html += '<strong>' + option.name + '</strong>';
          
          // æ˜¾ç¤ºæ²»ç–—ç‰¹æ€§æ ‡ç­¾
          html += '<div class="treatment-badges">';
          if (option.is_optimal) {
            html += '<span class="badge badge-success">æœ€ä½³</span>';
          }
          if (option.is_contraindicated) {
            html += '<span class="badge badge-danger">ç¦å¿Œ</span>';
          }
          if (option.efficacy_score === 'high') {
            html += '<span class="badge badge-info">é«˜æ•ˆ</span>';
          }
          html += '</div>';
          
          html += '</div>';
          html += '<div class="text-muted small mt-2">' + (option.description || '') + '</div>';
          
          // æ˜¾ç¤ºç–—æ•ˆå’Œå®‰å…¨æ€§ä¿¡æ¯
          html += '<div class="treatment-info mt-2">';
          html += '<div class="row small text-muted">';
          html += '<div class="col-4">ç–—æ•ˆ: ' + (option.efficacy_score || 'ä¸­') + '</div>';
          html += '<div class="col-4">å®‰å…¨: ' + (option.safety_score || 'ä¸­') + '</div>';
          html += '<div class="col-4">æˆæœ¬: ' + (option.cost_score || 'ä¸­') + '</div>';
          html += '</div>';
          html += '</div>';
          
          // é¢„æœŸç»“æœ
          if (option.expected_outcome) {
            html += '<div class="expected-outcome mt-2">';
            html += '<small class="text-info"><i class="fas fa-bullseye"></i> ' + option.expected_outcome + '</small>';
          }
          
          html += '</label>';
          html += '</div>';
          html += '</div>';
          html += '</div>';
          html += '</div>';
        });
        html += '</div>';
        html += '</div>';
      });
      
      html += '</form>';
    } else {
      html += '<div class="alert alert-warning">æš‚æ— æ²»ç–—æ–¹æ¡ˆæ•°æ®</div>';
    }
    
    html += '</div>';
    
    // æ·»åŠ æ²»ç–—æ–¹æ¡ˆé€‰æ‹©ç»Ÿè®¡ - æ”¹è¿›æ’ç‰ˆ
    html += '<div class="treatment-summary mt-4">';
    html += '<div class="card bg-light border-0 shadow-sm">';
    html += '<div class="card-body p-4">';
    html += '<h6 class="mb-3"><i class="fas fa-chart-pie text-primary me-2"></i> æ²»ç–—æ–¹æ¡ˆåˆ†æ</h6>';
    
    // ä½¿ç”¨æ›´å¥½çš„ç½‘æ ¼å¸ƒå±€
    html += '<div class="row g-3">';
    
    // å·²é€‰æ–¹æ¡ˆ
    html += '<div class="col-6 col-md-3">';
    html += '<div class="text-center p-3 bg-white rounded border">';
    html += '<div class="h4 mb-1 text-primary" id="selected-treatments-count">0</div>';
    html += '<small class="text-muted fw-500">å·²é€‰æ–¹æ¡ˆ</small>';
    html += '</div>';
    html += '</div>';
    
    // æœ€ä½³æ–¹æ¡ˆ
    html += '<div class="col-6 col-md-3">';
    html += '<div class="text-center p-3 bg-white rounded border">';
    html += '<div class="h4 mb-1 text-success" id="optimal-treatments-count">0</div>';
    html += '<small class="text-muted fw-500">æœ€ä½³æ–¹æ¡ˆ</small>';
    html += '</div>';
    html += '</div>';
    
    // ç»¼åˆç–—æ•ˆ
    html += '<div class="col-6 col-md-3">';
    html += '<div class="text-center p-3 bg-white rounded border">';
    html += '<div class="h4 mb-1 text-warning" id="treatment-efficacy">--</div>';
    html += '<small class="text-muted fw-500">ç»¼åˆç–—æ•ˆ</small>';
    html += '</div>';
    html += '</div>';
    
    // å®‰å…¨è¯„çº§
    html += '<div class="col-6 col-md-3">';
    html += '<div class="text-center p-3 bg-white rounded border">';
    html += '<div class="h4 mb-1 text-info" id="treatment-safety">--</div>';
    html += '<small class="text-muted fw-500">å®‰å…¨è¯„çº§</small>';
    html += '</div>';
    html += '</div>';
    
    html += '</div>'; // rowç»“æŸ
    html += '</div>';
    html += '</div>';
    html += '</div>';
    
    html += '</div>';
    
    $('#stage-content').html(html);
    
    // æ¢å¤ä¹‹å‰çš„é€‰æ‹©çŠ¶æ€ï¼ˆå¦‚æœæœ‰çš„è¯ï¼‰
    if (clinicalSession.selectedTreatments && clinicalSession.selectedTreatments.length > 0) {
      clinicalSession.selectedTreatments.forEach(function(treatmentId) {
        var checkbox = $('#treat_' + treatmentId);
        if (checkbox.length) {
          checkbox.prop('checked', true);
          checkbox.closest('.treatment-option').addClass('selected');
        }
      });
      updateTreatmentSummary();
    }
    
    // ç»‘å®šæ²»ç–—é€‰æ‹©äº‹ä»¶
    bindTreatmentEvents();
    showClinicalThinkingPrompt('treatment');
    
    // ç¡®ä¿æŒ‰é’®çŠ¶æ€æ­£ç¡® - æ²»ç–—é˜¶æ®µæŒ‰é’®åº”å§‹ç»ˆå¯ç”¨
    setTimeout(function() {
      ensureButtonEnabled();
    }, 100);
  }
  
  function groupTreatmentsByType(options) {
    var grouped = {};
    options.forEach(function(option) {
      var type = option.type || 'medication';
      if (!grouped[type]) {
        grouped[type] = [];
      }
      grouped[type].push(option);
    });
    return grouped;
  }
  
  function getTreatmentTypeDisplay(type) {
    var displays = {
      'medication': 'è¯ç‰©æ²»ç–—',
      'surgery': 'æ‰‹æœ¯æ²»ç–—',
      'observation': 'è§‚å¯Ÿéšè®¿',
      'referral': 'è½¬è¯Šæ²»ç–—',
      'education': 'å¥åº·æ•™è‚²'
    };
    return displays[type] || type;
  }
  
  function getTreatmentTypeIcon(type) {
    var icons = {
      'medication': 'fas fa-pills',
      'surgery': 'fas fa-scalpel-path',
      'observation': 'fas fa-eye',
      'referral': 'fas fa-hospital',
      'education': 'fas fa-graduation-cap'
    };
    return icons[type] || 'fas fa-medical-kit';
  }
  
  function bindTreatmentEvents() {
    $('.treatment-checkbox').off('change').on('change', function() {
      var $card = $(this).closest('.treatment-option');
      var treatmentId = parseInt($(this).val());
      
      if ($(this).is(':checked')) {
        $card.addClass('selected');
        clinicalSession.selectedTreatments.push(treatmentId);
        addToLearningTimeline('é€‰æ‹©æ²»ç–—', $(this).siblings('label').find('strong').text());
      } else {
        $card.removeClass('selected');
        var index = clinicalSession.selectedTreatments.indexOf(treatmentId);
        if (index > -1) {
          clinicalSession.selectedTreatments.splice(index, 1);
        }
      }
      
      updateTreatmentSummary();
      provideLiveTreatmentFeedback();
    });
    
    $('.treatment-option').on('click', function(e) {
      if (e.target.type !== 'checkbox') {
        var checkbox = $(this).find('.treatment-checkbox');
        checkbox.prop('checked', !checkbox.prop('checked')).trigger('change');
      }
    });
  }
  
  function updateTreatmentSummary() {
    // ç›´æ¥ä»DOMè·å–å®é™…é€‰æ‹©çŠ¶æ€ï¼Œé¿å…ä¼šè¯æ•°æ®æ±¡æŸ“
    var $checkedTreatments = $('.treatment-checkbox:checked');
    var selectedCount = $checkedTreatments.length;
    var optimalCount = 0;
    var efficacyScores = [];
    var safetyScores = [];
    
    // åŒæ—¶æ›´æ–°ä¼šè¯æ•°æ®ä»¥ä¿æŒä¸€è‡´æ€§
    clinicalSession.selectedTreatments = [];
    
    $checkedTreatments.each(function() {
      var treatmentId = $(this).val();
      var $card = $(this).closest('.treatment-option');
      
      // æ›´æ–°ä¼šè¯æ•°æ®
      clinicalSession.selectedTreatments.push(parseInt(treatmentId));
      
      if ($card.find('.badge-success').length > 0) {
        optimalCount++;
      }
      
      // ç®€å•çš„è¯„åˆ†é€»è¾‘
      var efficacyText = $card.find('.treatment-info').text();
      if (efficacyText.includes('ç–—æ•ˆ: é«˜')) efficacyScores.push(3);
      else if (efficacyText.includes('ç–—æ•ˆ: ä¸­')) efficacyScores.push(2);
      else efficacyScores.push(1);
      
      if (efficacyText.includes('å®‰å…¨: é«˜')) safetyScores.push(3);
      else if (efficacyText.includes('å®‰å…¨: ä¸­')) safetyScores.push(2);
      else safetyScores.push(1);
    });
    
    // è®¡ç®—å¹³å‡ç–—æ•ˆå’Œå®‰å…¨æ€§
    var avgEfficacy = efficacyScores.length > 0 ? efficacyScores.reduce((a, b) => a + b, 0) / efficacyScores.length : 0;
    var avgSafety = safetyScores.length > 0 ? safetyScores.reduce((a, b) => a + b, 0) / safetyScores.length : 0;
    
    var efficacyLevel = avgEfficacy >= 2.5 ? 'é«˜' : avgEfficacy >= 1.5 ? 'ä¸­' : 'ä½';
    var safetyLevel = avgSafety >= 2.5 ? 'é«˜' : avgSafety >= 1.5 ? 'ä¸­' : 'ä½';
    
    $('#selected-treatments-count').text(selectedCount);
    $('#optimal-treatments-count').text(optimalCount);
    $('#treatment-efficacy').text(efficacyLevel);
    $('#treatment-safety').text(safetyLevel);
  }
  
  function provideLiveTreatmentFeedback() {
    var selectedCount = clinicalSession.selectedTreatments.length;
    var feedback = '';
    
    if (selectedCount === 0) {
      feedback = '<div class="alert alert-info">è¯·å¼€å§‹é€‰æ‹©æ²»ç–—æ–¹æ¡ˆ</div>';
    } else if (selectedCount === 1) {
      feedback = '<div class="alert alert-warning">è€ƒè™‘æ˜¯å¦éœ€è¦è”åˆæ²»ç–—</div>';
    } else if (selectedCount > 5) {
      feedback = '<div class="alert alert-danger">æ²»ç–—æ–¹æ¡ˆè¿‡å¤šå¯èƒ½å¢åŠ å‰¯ä½œç”¨é£é™©</div>';
    } else {
      feedback = '<div class="alert alert-success">æ²»ç–—æ–¹æ¡ˆé€‰æ‹©åˆç†</div>';
    }
    
    $('#feedback-panel').html(feedback);
  }

  function submitTreatments() {
    // æ˜¾ç¤ºæäº¤ä¸­çŠ¶æ€
    $('#btn-next').prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i> æäº¤ä¸­...');
    showFeedbackMessage('æ­£åœ¨æäº¤æ²»ç–—æ–¹æ¡ˆ...', 'info');
    
    // å‡†å¤‡æäº¤æ•°æ®
    var submitData = {
      case_id: clinicalSession.caseId,
      selected_treatments: clinicalSession.selectedTreatments,
      reasoning: $('#clinical-notes').val() || ''
    };
    
    $.ajax({
      url: '/api/clinical/submit-treatments/',
      method: 'POST',
      contentType: 'application/json',
      headers: {
        'X-CSRFToken': $('[name=csrfmiddlewaretoken]').val() || getCsrfToken()
      },
      data: JSON.stringify(submitData),
      success: function(resp) {
        $('#btn-next').prop('disabled', false).html('å®Œæˆå­¦ä¹  <i class="fas fa-check"></i>');
        
        if (resp.success) {
          // è®°å½•æ²»ç–—é˜¶æ®µå®Œæˆ
          addToLearningTimeline('å®Œæˆæ²»ç–—é€‰æ‹©', 'é€‰æ‹©äº† ' + clinicalSession.selectedTreatments.length + ' ç§æ²»ç–—æ–¹æ¡ˆ');
          
          // æ›´æ–°åˆ†æ•°
          if (resp.data.treatment_score !== undefined) {
            clinicalSession.scores.treatment = resp.data.treatment_score;
          }
          
          // è®¡ç®—æ€»åˆ†
          if (resp.data.scores && resp.data.scores.overall_score !== undefined) {
            clinicalSession.scores.overall = resp.data.scores.overall_score;
            $('#current-score').text(resp.data.scores.overall_score.toFixed(1));
          }
          
          // è¿›å…¥åé¦ˆé˜¶æ®µ
          clinicalSession.currentStage = 'feedback';
          updateClinicalProgress();
          showFinalFeedback(resp.data);
          // è§†è§‰ä¸åŠ¨ç”»åé¦ˆ
          flashCard($('#stage-content'), 'success');
          launchConfetti(40);
        } else {
          showFeedbackMessage('æäº¤å¤±è´¥: ' + resp.message + 'ã€‚è¯·é‡æ–°é€‰æ‹©æ²»ç–—æ–¹æ¡ˆ', 'danger');
          // æ¢å¤æŒ‰é’®çŠ¶æ€ï¼Œå…è®¸ç”¨æˆ·é‡æ–°é€‰æ‹©
          $('#btn-next').prop('disabled', false).html('æäº¤æ²»ç–—æ–¹æ¡ˆ â†’').removeClass('btn-primary').addClass('btn-success');
        }
      },
      error: function(xhr, status, error) {
        $('#btn-next').prop('disabled', false).html('æäº¤æ²»ç–—æ–¹æ¡ˆ â†’').removeClass('btn-primary').addClass('btn-success');
        console.error('Submit treatment error:', error, xhr.responseText);
        
        if (xhr.status === 404) {
          showFeedbackMessage('APIæ¥å£æœªæ‰¾åˆ°ï¼Œè¯·æ£€æŸ¥åç«¯é…ç½®ã€‚è¯·é‡æ–°é€‰æ‹©æ²»ç–—æ–¹æ¡ˆ', 'danger');
        } else if (xhr.status === 403) {
          showFeedbackMessage('æƒé™ä¸è¶³ï¼Œè¯·é‡æ–°ç™»å½•ã€‚è¯·é‡æ–°é€‰æ‹©æ²»ç–—æ–¹æ¡ˆ', 'danger');
        } else if (xhr.status === 500) {
          showFeedbackMessage('æœåŠ¡å™¨å†…éƒ¨é”™è¯¯ï¼Œè¯·è”ç³»ç®¡ç†å‘˜ã€‚è¯·é‡æ–°é€‰æ‹©æ²»ç–—æ–¹æ¡ˆ', 'danger');
        } else {
          showFeedbackMessage('ç½‘ç»œé”™è¯¯ï¼Œè¯·æ£€æŸ¥è¿æ¥: ' + error + 'ã€‚è¯·é‡æ–°é€‰æ‹©æ²»ç–—æ–¹æ¡ˆ', 'danger');
        }
      }
    });
  }

  function showFinalFeedback(data) {
    clinicalSession.currentStage = 'feedback';
    updateClinicalProgress();
    updateStageProgress();
    
    updateStageCard('å­¦ä¹ å®Œæˆ', 'complete');
    
    // æ˜¾ç¤ºæœ€ç»ˆåé¦ˆ
    var feedbackHtml = '<div class="alert alert-success feedback-animation">';
    feedbackHtml += '<h6><i class="fas fa-trophy"></i> å­¦ä¹ å®Œæˆï¼</h6>';
    feedbackHtml += (data.overall_feedback || 'æ­å–œæ‚¨å®Œæˆäº†æœ¬æ¬¡ä¸´åºŠæ¨ç†å­¦ä¹ ï¼');
    feedbackHtml += '</div>';
    $('#feedback-panel').html(feedbackHtml);
    
    // æ„å»ºæœ€ç»ˆå­¦ä¹ æ€»ç»“é¡µé¢
    var html = '<div class="final-feedback text-center">';
    
    // æ ‡é¢˜
    html += '<div class="completion-header mb-4">';
    html += '<h3 class="text-success"><i class="fas fa-graduation-cap"></i> ä¸´åºŠæ¨ç†å­¦ä¹ å®Œæˆ</h3>';
    html += '<p class="text-muted">æ‚¨å·²æˆåŠŸå®Œæˆæœ¬æ¡ˆä¾‹çš„å®Œæ•´ä¸´åºŠæ¨ç†è¿‡ç¨‹</p>';
    html += '</div>';
    
    // æˆç»©å±•ç¤º
    html += '<div class="row mb-4">';
    
    // æ€»ä½“å¾—åˆ†
    html += '<div class="col-md-6 offset-md-3">';
    html += '<div class="card border-success">';
    html += '<div class="card-body text-center">';
    html += '<h4 class="text-success">æ€»ä½“å¾—åˆ†</h4>';
    var overallScore = (data.scores && data.scores.overall_score) ? data.scores.overall_score : clinicalSession.scores.overall;
    html += '<div class="display-3 text-primary font-weight-bold">' + (overallScore ? overallScore.toFixed(1) : '0.0') + '</div>';
    html += '<p class="text-muted">æ»¡åˆ† 100 åˆ†</p>';
    
    // è¯„çº§
    var grade = 'A';
    var gradeColor = 'success';
    if (overallScore < 60) {
      grade = 'D'; gradeColor = 'danger';
    } else if (overallScore < 70) {
      grade = 'C'; gradeColor = 'warning';
    } else if (overallScore < 85) {
      grade = 'B'; gradeColor = 'info';
    }
    html += '<h5><span class="badge badge-' + gradeColor + ' p-2">' + grade + ' çº§</span></h5>';
    html += '</div>';
    html += '</div>';
    html += '</div>';
    html += '</div>';
    
    // åˆ†é¡¹å¾—åˆ†
    html += '<div class="row mb-4">';
    html += '<div class="col-md-12">';
    html += '<div class="card">';
    html += '<div class="card-body">';
    html += '<h5 class="card-title"><i class="fas fa-chart-bar"></i> åˆ†é¡¹æˆç»©</h5>';
    html += '<div class="row text-center">';
    
    html += '<div class="col-4">';
    html += '<div class="score-item">';
    html += '<div class="h4 text-warning">' + (clinicalSession.scores.examination || 0).toFixed(1) + '</div>';
    html += '<small class="text-muted">æ£€æŸ¥é€‰æ‹© (30%)</small>';
    html += '</div>';
    html += '</div>';
    
    html += '<div class="col-4">';
    html += '<div class="score-item">';
    html += '<div class="h4 text-info">' + (clinicalSession.scores.diagnosis || 0).toFixed(1) + '</div>';
    html += '<small class="text-muted">è¯Šæ–­å‡†ç¡®æ€§ (50%)</small>';
    html += '</div>';
    html += '</div>';
    
    html += '<div class="col-4">';
    html += '<div class="score-item">';
    html += '<div class="h4 text-success">' + (clinicalSession.scores.treatment || 0).toFixed(1) + '</div>';
    html += '<small class="text-muted">æ²»ç–—æ–¹æ¡ˆ (20%)</small>';
    html += '</div>';
    html += '</div>';
    
    html += '</div>';
    html += '</div>';
    html += '</div>';
    html += '</div>';
    html += '</div>';
    
    // å­¦ä¹ æ€»ç»“
    if (data.overall_feedback || data.improvement_suggestions) {
      html += '<div class="row mb-4">';
      html += '<div class="col-md-12">';
      html += '<div class="card">';
      html += '<div class="card-body text-left">';
      html += '<h5 class="card-title"><i class="fas fa-lightbulb"></i> å­¦ä¹ æ€»ç»“</h5>';
      if (data.overall_feedback) {
        html += '<p>' + data.overall_feedback + '</p>';
      }
      if (data.improvement_suggestions) {
        html += '<h6 class="text-primary">æ”¹è¿›å»ºè®®ï¼š</h6>';
        html += '<p>' + data.improvement_suggestions + '</p>';
      }
      html += '</div>';
      html += '</div>';
      html += '</div>';
      html += '</div>';
    }
    
    // æ“ä½œæŒ‰é’® - æ’‘æ»¡æ•´è¡Œå¹¶å±…ä¸­
    html += '<div class="action-buttons mt-4">';
    html += '<div class="d-flex justify-content-center align-items-center">';
    html += '<div class="d-flex w-100" style="max-width: 600px;">';
    html += '<button class="btn btn-outline-primary flex-fill mx-2" onclick="location.reload()">';
    html += '<i class="fas fa-redo"></i> é‡æ–°å­¦ä¹ ';
    html += '</button>';
    html += '<a href="/student/clinical-cases/" class="btn btn-outline-secondary flex-fill mx-2">';
    html += '<i class="fas fa-list"></i> è¿”å›æ¡ˆä¾‹åˆ—è¡¨';
    html += '</a>';
    html += '<a href="/student/" class="btn btn-outline-success flex-fill mx-2">';
    html += '<i class="fas fa-home"></i> è¿”å›é¦–é¡µ';
    html += '</a>';
    html += '</div>';
    html += '</div>';
    html += '</div>';
    
    html += '</div>';
    
    $('#stage-content').html(html);
    
    // å®Œå…¨é‡æ„å¯¼èˆªå¡ç‰‡ä»¥æ˜¾ç¤ºå®ŒæˆçŠ¶æ€
    var completionNavHtml = '<div class="card-body">';
    completionNavHtml += '<div class="text-center">';
    completionNavHtml += '<div style="padding: 20px; background: linear-gradient(135deg, #d4edda, #c3e6cb); border-radius: 10px; border: 2px solid #28a745; box-shadow: 0 4px 8px rgba(40, 167, 69, 0.2);">';
    completionNavHtml += '<i class="fas fa-check-circle text-success me-2" style="font-size: 1.2em;"></i>';
    completionNavHtml += '<span class="text-success fw-bold" style="font-size: 1.1em;">ä¸´åºŠæ¨ç†è¿›åº¦å·²ç»å®Œæˆ</span>';
    completionNavHtml += '<div class="mt-3">';
    completionNavHtml += '<div style="width: 350px; height: 15px; background-color: #e9ecef; border-radius: 10px; margin: 0 auto; overflow: hidden; border: 1px solid #28a745;">';
    completionNavHtml += '<div style="width: 100%; height: 100%; background: linear-gradient(90deg, #28a745, #20c997); border-radius: 10px; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 0.8em;">';
    completionNavHtml += '100%';
    completionNavHtml += '</div>';
    completionNavHtml += '</div>';
    completionNavHtml += '<small class="text-success mt-2 d-block fw-bold">å­¦ä¹ å®Œæˆ</small>';
    completionNavHtml += '</div>';
    completionNavHtml += '</div>';
    completionNavHtml += '</div>';
    completionNavHtml += '</div>';
    
    $('#navigation-card').html(completionNavHtml);
    
    // æ¸…é™¤ä¿å­˜çš„è¿›åº¦
    localStorage.removeItem('clinical_progress_' + clinicalSession.caseId);
    
    // è®°å½•å®Œæˆæ—¶é—´
    clinicalSession.timeSpent.total = new Date() - clinicalSession.startTime;
    addToLearningTimeline('å®Œæˆå­¦ä¹ ', 'æ€»ç”¨æ—¶: ' + Math.floor(clinicalSession.timeSpent.total / 60000) + ' åˆ†é’Ÿ');
  }

  // ==================== åŠ¨ç”»ä¸è§†è§‰æ•ˆæœ ====================
  
  // ç®€å• confetti æ•ˆæœï¼ˆæ— å¤–éƒ¨åº“ï¼Œè½»é‡ï¼‰
  function launchConfetti(count) {
    count = count || 30;
    for (var i = 0; i < count; i++) {
      (function() {
        var conf = document.createElement('div');
        conf.className = 'confetti-piece';
        var size = Math.floor(Math.random() * 8) + 6;
        conf.style.width = size + 'px';
        conf.style.height = (size * 0.6) + 'px';
        conf.style.background = ['#28a745','#007bff','#ffc107','#dc3545','#6610f2'][Math.floor(Math.random() * 5)];
        conf.style.position = 'fixed';
        conf.style.zIndex = 9999;
        conf.style.left = (Math.random() * window.innerWidth) + 'px';
        conf.style.top = '-20px';
        conf.style.opacity = Math.random() * 0.9 + 0.1;
        conf.style.transform = 'rotate(' + (Math.random() * 360) + 'deg)';
        conf.style.pointerEvents = 'none';
        document.body.appendChild(conf);
        var endY = window.innerHeight + 100 + Math.random() * 200;
        var duration = 1000 + Math.random() * 1200;
        conf.animate([
          { transform: conf.style.transform + ' translateY(0px)', opacity: conf.style.opacity },
          { transform: conf.style.transform + ' translateY(' + endY + 'px)', opacity: 0.6 }
        ], { duration: duration, easing: 'cubic-bezier(.2,.8,.2,1)' });
        setTimeout(function() { conf.remove(); }, duration + 200);
      })();
    }
  }

  // å¡ç‰‡é«˜äº®è·³åŠ¨ï¼Œç”¨äºå¼ºè°ƒæˆåŠŸ/é”™è¯¯
  function flashCard($el, type) {
    var cls = (type === 'success') ? 'flash-success' : 'flash-warning';
    $el.addClass(cls);
    setTimeout(function() { $el.removeClass(cls); }, 900);
  }

  // æ­¥éª¤é—ªå…‰ï¼ˆçŸ­æš‚æ”¾å¤§ã€å…‰æ™•ï¼‰
  function highlightStep(stepName) {
    var $step = $('.stepper-item[data-step="' + stepName + '"]');
    $step.addClass('step-highlight');
    setTimeout(function() { $step.removeClass('step-highlight'); }, 800);
  }


  
  // ==================== é€šç”¨åŠŸèƒ½å‡½æ•° ====================
  
  function showClinicalThinkingPrompt(stage) {
    var prompts = {
      'history': 'æ€è€ƒï¼šæ‚£è€…çš„ç—‡çŠ¶ç‰¹ç‚¹æ˜¯ä»€ä¹ˆï¼Ÿå¯èƒ½çš„ç—…å› æœ‰å“ªäº›ï¼Ÿéœ€è¦é‡ç‚¹å…³æ³¨ä»€ä¹ˆï¼Ÿ',
      'examination': 'æ€è€ƒï¼šåŸºäºç—…å²ï¼Œå“ªäº›æ£€æŸ¥æœ€æœ‰åŠ©äºæ˜ç¡®è¯Šæ–­ï¼Ÿå¦‚ä½•å¹³è¡¡è¯Šæ–­ä»·å€¼å’Œæˆæœ¬ï¼Ÿ',
      'diagnosis': 'æ€è€ƒï¼šæ£€æŸ¥ç»“æœæ”¯æŒå“ªäº›è¯Šæ–­ï¼Ÿå¦‚ä½•è¿›è¡Œé‰´åˆ«è¯Šæ–­ï¼Ÿæ¦‚ç‡æœ€é«˜çš„æ˜¯ä»€ä¹ˆï¼Ÿ',
      'treatment': 'æ€è€ƒï¼šé’ˆå¯¹ç¡®å®šçš„è¯Šæ–­ï¼Œæœ€ä½³æ²»ç–—æ–¹æ¡ˆæ˜¯ä»€ä¹ˆï¼Ÿå¦‚ä½•è¯„ä¼°é£é™©è·ç›Šæ¯”ï¼Ÿ',
      'feedback': 'æ€è€ƒï¼šå›é¡¾æ•´ä¸ªè¯Šç–—è¿‡ç¨‹ï¼Œæœ‰å“ªäº›å€¼å¾—æ€»ç»“çš„ç»éªŒï¼Ÿ'
    };
    
    if (prompts[stage]) {
      showFeedbackMessage(prompts[stage], 'guidance');
    }
  }
  
  function showFeedbackMessage(message, type = 'info') {
    var alertClass = {
      'info': 'alert-info',
      'success': 'alert-success feedback-positive',
      'warning': 'alert-warning feedback-corrective', 
      'danger': 'alert-danger',
      'guidance': 'alert-info feedback-guidance'
    }[type] || 'alert-info';
    
    var icon = {
      'info': 'fas fa-info-circle',
      'success': 'fas fa-check-circle',
      'warning': 'fas fa-exclamation-triangle',
      'danger': 'fas fa-times-circle',
      'guidance': 'fas fa-lightbulb'
    }[type] || 'fas fa-info-circle';
    
    var html = '<div class="alert ' + alertClass + ' feedback-animation">';
    html += '<i class="' + icon + '"></i> ' + message;
    html += '</div>';
    
    $('#feedback-panel').html(html);
    
    // è®°å½•åé¦ˆå†å²
    clinicalSession.feedbackHistory.push({
      timestamp: new Date(),
      stage: clinicalSession.currentStage,
      message: message,
      type: type
    });
  }
  
  function showErrorMessage(message) {
    showFeedbackMessage('é”™è¯¯ï¼š' + message, 'danger');
  }
  
  function addToLearningTimeline(action, detail) {
    var timestamp = new Date().toLocaleTimeString();
    var html = '<div class="timeline-item">';
    html += '<div class="d-flex justify-content-between">';
    html += '<strong>' + action + '</strong>';
    html += '<small class="text-muted">' + timestamp + '</small>';
    html += '</div>';
    html += '<div class="text-muted small">' + detail + '</div>';
    html += '</div>';
    
    $('#learning-timeline').prepend(html);
    
    // ä¿æŒæœ€å¤šæ˜¾ç¤º10æ¡è®°å½•
    var items = $('#learning-timeline .timeline-item');
    if (items.length > 10) {
      items.slice(10).remove();
    }
  }
  
  function updateTimeSpent() {
    var now = new Date();
    var elapsed = Math.floor((now - clinicalSession.startTime) / 1000); // ç§’
    var minutes = Math.floor(elapsed / 60);
    var seconds = elapsed % 60;
    
    var timeStr = String(minutes).padStart(2, '0') + ':' + String(seconds).padStart(2, '0');
    $('#time-spent').text(timeStr);
  }
  
  function updateStageProgress() {
    var stages = clinicalSession.stages;
    var currentIndex = stages.indexOf(clinicalSession.currentStage);
    var progress = Math.round(((currentIndex + 1) / stages.length) * 100);
    
    // ä½¿ç”¨ç»Ÿä¸€çš„è¿›åº¦æ›´æ–°å‡½æ•°
    updateNavigationProgress();
    $('#current-stage-text').text(getStageDisplayName(clinicalSession.currentStage));
  }
  
  function getStageDisplayName(stage) {
    var names = {
      'history': 'ç—…å²é‡‡é›†',
      'examination': 'æ£€æŸ¥é€‰æ‹©',
      'diagnosis': 'è¯Šæ–­æ¨ç†',
      'treatment': 'æ²»ç–—å†³ç­–',
      'feedback': 'å­¦ä¹ åé¦ˆ'
    };
    return names[stage] || stage;
  }
  
  function saveCurrentProgress() {
    // ä¿å­˜å½“å‰å­¦ä¹ è¿›åº¦åˆ°æœ¬åœ°å­˜å‚¨
    var progressData = {
      caseId: clinicalSession.caseId,
      stage: clinicalSession.currentStage,
      selectedExaminations: clinicalSession.selectedExaminations,
      selectedDiagnosis: clinicalSession.selectedDiagnosis,
      selectedTreatments: clinicalSession.selectedTreatments,
      notes: $('#clinical-notes').val(),
      timestamp: new Date().toISOString()
    };
    
    localStorage.setItem('clinical_progress_' + clinicalSession.caseId, JSON.stringify(progressData));
  }
  
  function loadSavedProgress() {
    // å°è¯•åŠ è½½ä¹‹å‰ä¿å­˜çš„è¿›åº¦
    var saved = localStorage.getItem('clinical_progress_' + clinicalSession.caseId);
    if (saved) {
      try {
        var progressData = JSON.parse(saved);
        // å¦‚æœæ˜¯å½“å¤©çš„è¿›åº¦ï¼Œåˆ™æ¢å¤
        var savedTime = new Date(progressData.timestamp);
        var now = new Date();
        if (now.toDateString() === savedTime.toDateString()) {
          return progressData;
        }
      } catch (e) {
        console.log('Failed to load saved progress:', e);
      }
    }
    return null;
  }
  
  // ==================== ä¸»ç¨‹åºå…¥å£å’Œäº‹ä»¶ç»‘å®š ====================
  
  // æ›´æ–°é˜¶æ®µå¡ç‰‡æ ·å¼å’Œå†…å®¹
  function updateStageCard(stageName, stageKey) {
    const stageConfig = {
      'history': {
        text: 'ç—…å²é‡‡é›†é˜¶æ®µ',
        icon: 'fas fa-clipboard-list',
        textColor: 'text-success',
        cardClass: 'stage-history'
      },
      'examination': {
        text: 'æ£€æŸ¥é€‰æ‹©é˜¶æ®µ', 
        icon: 'fas fa-stethoscope',
        textColor: 'text-warning',
        cardClass: 'stage-examination'
      },
      'diagnosis': {
        text: 'è¯Šæ–­æ¨ç†é˜¶æ®µ',
        icon: 'fas fa-brain',
        textColor: 'text-purple',
        cardClass: 'stage-diagnosis'
      },
      'treatment': {
        text: 'æ²»ç–—å†³ç­–é˜¶æ®µ',
        icon: 'fas fa-pills',
        textColor: 'text-info',
        cardClass: 'stage-treatment'
      },
      'complete': {
        text: 'å­¦ä¹ å®Œæˆ',
        icon: 'fas fa-check-circle',
        textColor: 'text-success',
        cardClass: 'stage-complete'
      }
    };
    
    const config = stageConfig[stageKey] || stageConfig['history'];
    const $stageBadge = $('#current-stage-badge');
    const $stageCard = $stageBadge.closest('.stage-info-card');
    
    // æ›´æ–°æ–‡å­—å’Œå›¾æ ‡
    $stageBadge.text(config.text)
              .removeClass()
              .addClass('fw-bold ' + config.textColor)
              .css('font-size', '0.9rem');
    
    // æ›´æ–°å¡ç‰‡æ ·å¼
    $stageCard.removeClass('stage-history stage-examination stage-diagnosis stage-treatment stage-complete')
              .addClass(config.cardClass);
    
    // æ›´æ–°å›¾æ ‡
    $stageCard.find('i').removeClass().addClass(config.icon + ' me-2').css('font-size', '0.9em');
    
    // æ›´æ–°å›¾æ ‡é¢œè‰²
    const iconColorClass = config.textColor.replace('text-', '');
    if (iconColorClass === 'purple') {
      $stageCard.find('i').removeClass().addClass(config.icon + ' me-2').css({'font-size': '0.9em', 'color': '#9c27b0'});
    } else {
      $stageCard.find('i').removeClass().addClass(config.icon + ' ' + config.textColor + ' me-2').css('font-size', '0.9em');
    }
  }

  // è¿›åº¦æ¡æ›´æ–°å‡½æ•°
  function updateNavigationProgress() {
    const stageMapping = {
      'history': 1,
      'examination': 2, 
      'diagnosis': 3,
      'treatment': 4,
      'feedback': 4
    };
    
    const totalSteps = 4;
    const currentStepNum = stageMapping[clinicalSession.currentStage] || 1;
    const progressPercent = Math.round((currentStepNum / totalSteps) * 100);
    
    // æ›´æ–°è¿›åº¦æ¡
    const progressBar = document.getElementById('overall-progress');
    if (progressBar) {
      progressBar.style.width = progressPercent + '%';
      progressBar.textContent = progressPercent + '%';
      progressBar.setAttribute('aria-valuenow', progressPercent);
      
      // æ ¹æ®è¿›åº¦è°ƒæ•´é¢œè‰²
      let gradient;
      if (progressPercent <= 25) {
        gradient = 'linear-gradient(90deg, #dc3545, #c82333)'; // çº¢è‰²
      } else if (progressPercent <= 50) {
        gradient = 'linear-gradient(90deg, #ffc107, #e0a800)'; // é»„è‰²
      } else if (progressPercent <= 75) {
        gradient = 'linear-gradient(90deg, #007bff, #0056b3)'; // è“è‰²
      } else {
        gradient = 'linear-gradient(90deg, #28a745, #20c997)'; // ç»¿è‰²
      }
      progressBar.style.background = gradient;
    }
    
    // æ›´æ–°è¿›åº¦æ–‡æœ¬
    const progressText = document.getElementById('progress-text');
    if (progressText) {
      progressText.textContent = `æ­¥éª¤ ${currentStepNum}/${totalSteps} (${progressPercent}%)`;
    }
  }
  
  $(document).ready(function() {
    // åˆå§‹åŒ–æ—¶é—´æ˜¾ç¤ºæ›´æ–°
    setInterval(updateTimeSpent, 1000);
    
    // æ¸…ç©ºå¯èƒ½çš„å†å²è¿›åº¦æ•°æ®ï¼Œé¿å…æ±¡æŸ“
    localStorage.removeItem('clinical_progress_' + clinicalSession.caseId);
    
    // ç¡®ä¿ä¼šè¯æ•°æ®å¹²å‡€åˆå§‹åŒ–
    clinicalSession.selectedExaminations = [];
    clinicalSession.selectedTreatments = [];
    clinicalSession.selectedDiagnosis = null;
    
    // å°è¯•æ¢å¤ä¹‹å‰çš„å­¦ä¹ è¿›åº¦ï¼ˆå·²ç¦ç”¨ï¼Œé¿å…æ•°æ®æ±¡æŸ“ï¼‰
    /*
    var savedProgress = loadSavedProgress();
    if (savedProgress && confirm('æ£€æµ‹åˆ°ä¹‹å‰çš„å­¦ä¹ è¿›åº¦ï¼Œæ˜¯å¦ç»§ç»­ä¹‹å‰çš„å­¦ä¹ ï¼Ÿ')) {
      // æ¢å¤è¿›åº¦é€»è¾‘
      clinicalSession.currentStage = savedProgress.stage;
      clinicalSession.selectedExaminations = savedProgress.selectedExaminations || [];
      clinicalSession.selectedDiagnosis = savedProgress.selectedDiagnosis;
      clinicalSession.selectedTreatments = savedProgress.selectedTreatments || [];
      $('#clinical-notes').val(savedProgress.notes || '');
    }
    */
    
    // å¼€å§‹ç—…å²é˜¶æ®µ
    initializeHistoryStage();
    
    // åˆå§‹åŒ–è¿›åº¦æ˜¾ç¤º
    updateNavigationProgress();
    
    // ç´§æ€¥ä¿®å¤ï¼šå¼ºåˆ¶ç¡®ä¿æŒ‰é’®å¯ç”¨
    setTimeout(function() {
      ensureButtonEnabled();
    }, 500);
    
    // ç»‘å®šå¯¼èˆªæŒ‰é’®äº‹ä»¶
    $('#btn-next').on('click', function() {
      debugButtonStatus();
      
      if ($(this).prop('disabled')) {
        console.log('æŒ‰é’®è¢«ç¦ç”¨ï¼Œå¼ºåˆ¶å¯ç”¨!');
        ensureButtonEnabled();
        return false;
      }
      
      handleNextStage();
    });

    $('#btn-prev').on('click', function() {
      handlePreviousStage();
    });
    
    // ç»‘å®šä¸´åºŠç¬”è®°è‡ªåŠ¨ä¿å­˜
    $('#clinical-notes').on('input', function() {
      clearTimeout(window.notesSaveTimeout);
      window.notesSaveTimeout = setTimeout(saveCurrentProgress, 2000);
    });
    
    // é¡µé¢ç¦»å¼€æ—¶ä¿å­˜è¿›åº¦
    $(window).on('beforeunload', function() {
      saveCurrentProgress();
    });
  });
  
  function handleNextStage() {
    var currentStage = clinicalSession.currentStage;
    
    switch (currentStage) {
      case 'history':
        // è®°å½•ç—…å²é˜¶æ®µç”¨æ—¶
        clinicalSession.timeSpent.history = new Date() - clinicalSession.timeSpent.history;
        loadExaminationStage();
        break;
        
      case 'examination':
        if (!clinicalSession.isExaminationConfirmed) {
          // ç¬¬ä¸€æ¬¡ç‚¹å‡»ï¼šç¡®è®¤æ£€æŸ¥é€‰æ‹©
          if (clinicalSession.selectedExaminations.length === 0) {
            showFeedbackMessage('è¯·è‡³å°‘é€‰æ‹©ä¸€é¡¹æ£€æŸ¥', 'warning');
            return;
          }
          confirmExaminationSelection();
        } else {
          // æ£€æŸ¥å·²ç¡®è®¤ï¼Œæ˜¾ç¤ºæ£€æŸ¥ç»“æœ
          if (clinicalSession.currentExaminationIndex < clinicalSession.examinationOrder.length) {
            // éšè—çœ¼åº•å­—å¹•ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
            if ($('#fundus-overlay').length) {
              hideFundusSubtitle();
            }
            showNextExaminationResult();
          } else {
            // æ‰€æœ‰æ£€æŸ¥ç»“æœå·²æŸ¥çœ‹å®Œæ¯•ï¼Œè¿›å…¥è¯Šæ–­é˜¶æ®µ
            // éšè—çœ¼åº•å­—å¹•ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
            if ($('#fundus-overlay').length) {
              hideFundusSubtitle();
            }
            submitExaminations();
          }
        }
        break;
        
      case 'diagnosis':
        console.log('=== handleNextStage - è¯Šæ–­é˜¶æ®µ ===');
        console.log('å½“å‰é€‰ä¸­è¯Šæ–­ID:', clinicalSession.selectedDiagnosis);
        
        // éšè—çœ¼åº•å­—å¹•ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
        if ($('#fundus-overlay').length) {
          hideFundusSubtitle();
        }
        if (!clinicalSession.selectedDiagnosis) {
          console.log('æ²¡æœ‰é€‰æ‹©è¯Šæ–­ï¼Œæ˜¾ç¤ºè­¦å‘Š');
          showFeedbackMessage('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªè¯Šæ–­é€‰é¡¹ï¼Œç„¶åå†æäº¤', 'warning');
          return;
        }
        console.log('å¼€å§‹è°ƒç”¨submitDiagnosis()');
        submitDiagnosis();
        break;
        
      case 'treatment':
        // éšè—çœ¼åº•å­—å¹•ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
        if ($('#fundus-overlay').length) {
          hideFundusSubtitle();
        }
        if (clinicalSession.selectedTreatments.length === 0) {
          showFeedbackMessage('è¯·å…ˆé€‰æ‹©è‡³å°‘ä¸€ç§æ²»ç–—æ–¹æ¡ˆï¼Œç„¶åå†æäº¤', 'warning');
          return;
        }
        submitTreatments();
        break;
        
      default:
        showFeedbackMessage('å½“å‰é˜¶æ®µæ— æ³•ç»§ç»­', 'warning');
    }
    
    // æ›´æ–°å¯¼èˆªè¿›åº¦
    updateNavigationProgress();
  }
  
  function handlePreviousStage() {
    var currentStage = clinicalSession.currentStage;
    var stages = clinicalSession.stages;
    var currentIndex = stages.indexOf(currentStage);
    
    if (currentIndex > 0) {
      var previousStage = stages[currentIndex - 1];
      
      // éšè—çœ¼åº•å­—å¹•ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
      if ($('#fundus-overlay').length) {
        hideFundusSubtitle();
      }
      
      // æ›´æ–°å½“å‰é˜¶æ®µ
      clinicalSession.currentStage = previousStage;
      
      // æ ¹æ®ç›®æ ‡é˜¶æ®µæ‰§è¡Œç›¸åº”çš„åŠ è½½é€»è¾‘
      switch (previousStage) {
        case 'history':
          initializeHistoryStage();
          break;
          
        case 'examination':
          loadExaminationStage();
          // æ¢å¤æ£€æŸ¥é€‰æ‹©çŠ¶æ€
          if (clinicalSession.selectedExaminations.length > 0) {
            // å¦‚æœä¹‹å‰å·²ç»é€‰æ‹©äº†æ£€æŸ¥ï¼Œæ¢å¤åˆ°é€‰æ‹©ç¡®è®¤çŠ¶æ€
            setTimeout(function() {
              updateExaminationOrderList();
              clinicalSession.selectedExaminations.forEach(function(examId) {
                $('.examination-checkbox[value="' + examId + '"]').prop('checked', true);
              });
              updateExaminationSummary();
            }, 100);
          }
          break;
          
        case 'diagnosis':
          // é‡æ–°åŠ è½½è¯Šæ–­é˜¶æ®µï¼Œéœ€è¦ä»åç«¯è·å–è¯Šæ–­é€‰é¡¹
          loadDiagnosisStage();
          break;
          
        case 'treatment':
          // é‡æ–°åŠ è½½æ²»ç–—é˜¶æ®µ
          loadTreatmentStage();
          break;
          
        default:
          showFeedbackMessage('æ— æ³•è¿”å›åˆ°æŒ‡å®šé˜¶æ®µ', 'warning');
          return;
      }
      
      // æä¾›ç”¨æˆ·åé¦ˆ
      showFeedbackMessage('å·²è¿”å›åˆ°' + getStageDisplayName(previousStage) + 'é˜¶æ®µ', 'info');
      
      // è®°å½•åˆ°å­¦ä¹ æ—¶é—´çº¿
      addToLearningTimeline('è¿”å›ä¸Šä¸€é˜¶æ®µ', 'ä»' + getStageDisplayName(currentStage) + 'è¿”å›åˆ°' + getStageDisplayName(previousStage));
    } else {
      showFeedbackMessage('å·²ç»æ˜¯ç¬¬ä¸€ä¸ªé˜¶æ®µï¼Œæ— æ³•è¿”å›', 'warning');
    }
    
    // æ›´æ–°å¯¼èˆªè¿›åº¦å’ŒæŒ‰é’®çŠ¶æ€
    updateNavigationProgress();
  }
  
  // è·å–é˜¶æ®µæ˜¾ç¤ºåç§°
  function getStageDisplayName(stage) {
    var stageNames = {
      'history': 'ç—…å²é‡‡é›†',
      'examination': 'ä¸´åºŠæ£€æŸ¥',
      'diagnosis': 'è¯Šæ–­åˆ†æ',
      'treatment': 'æ²»ç–—æ–¹æ¡ˆ',
      'feedback': 'å­¦ä¹ åé¦ˆ'
    };
    return stageNames[stage] || stage;
  }
  
  // åŠ è½½è¯Šæ–­é˜¶æ®µ
  function loadDiagnosisStage() {
    // å¦‚æœæœ‰ç¼“å­˜çš„è¯Šæ–­é€‰é¡¹ï¼Œç›´æ¥ä½¿ç”¨ï¼›å¦åˆ™é‡æ–°è·å–
    if (clinicalSession.diagnosisOptions && clinicalSession.diagnosisOptions.length > 0) {
      renderDiagnosisStage({
        diagnosis_options: clinicalSession.diagnosisOptions,
        examination_score: clinicalSession.scores.examination
      });
    } else {
      // é‡æ–°è·å–è¯Šæ–­é€‰é¡¹
      $.getJSON('/api/clinical/case/' + clinicalSession.caseId + '/diagnoses/', function(resp) {
        if (resp.success) {
          clinicalSession.diagnosisOptions = resp.data.diagnosis_options;
          renderDiagnosisStage(resp.data);
        } else {
          showErrorMessage('åŠ è½½è¯Šæ–­é€‰é¡¹å¤±è´¥: ' + resp.message);
        }
      }).fail(function() {
        showErrorMessage('ç½‘ç»œé”™è¯¯ï¼Œè¯·æ£€æŸ¥è¿æ¥åé‡è¯•');
      });
    }
  }
  
  // åŠ è½½æ²»ç–—é˜¶æ®µ
  function loadTreatmentStage() {
    // å¦‚æœæœ‰ç¼“å­˜çš„æ²»ç–—é€‰é¡¹ï¼Œç›´æ¥ä½¿ç”¨ï¼›å¦åˆ™é‡æ–°è·å–
    if (clinicalSession.treatmentOptions && clinicalSession.treatmentOptions.length > 0) {
      renderTreatmentStage({
        treatment_options: clinicalSession.treatmentOptions,
        diagnosis_score: clinicalSession.scores.diagnosis
      });
    } else {
      // é‡æ–°è·å–æ²»ç–—é€‰é¡¹
      $.getJSON('/api/clinical/case/' + clinicalSession.caseId + '/treatments/', function(resp) {
        if (resp.success) {
          clinicalSession.treatmentOptions = resp.data.treatment_options;
          renderTreatmentStage(resp.data);
        } else {
          showErrorMessage('åŠ è½½æ²»ç–—é€‰é¡¹å¤±è´¥: ' + resp.message);
        }
      }).fail(function() {
        showErrorMessage('ç½‘ç»œé”™è¯¯ï¼Œè¯·æ£€æŸ¥è¿æ¥åé‡è¯•');
      });
    }
  }
  
  // ==================== OCTå›¾åƒäº¤äº’åŠŸèƒ½ ====================
  
  // å›¾åƒç¼©æ”¾åŠŸèƒ½
  var currentZoom = 1;
  
  function zoomImage(direction) {
    var $image = $('.oct-modal-image');
    if ($image.length === 0) return;
    
    if (direction === 'in') {
      currentZoom = Math.min(currentZoom * 1.2, 5); // æœ€å¤§5å€
    } else if (direction === 'out') {
      currentZoom = Math.max(currentZoom / 1.2, 0.5); // æœ€å°0.5å€
    }
    
    $image.css('transform', 'scale(' + currentZoom + ')');
    
    // æ˜¾ç¤ºç¼©æ”¾çº§åˆ«
    showZoomLevel(currentZoom);
  }
  
  function resetImageZoom() {
    currentZoom = 1;
    $('.oct-modal-image').css('transform', 'scale(1)');
    showZoomLevel(1);
  }
  
  function showZoomLevel(level) {
    var percentage = Math.round(level * 100);
    
    // ç§»é™¤å·²å­˜åœ¨çš„ç¼©æ”¾æŒ‡ç¤ºå™¨
    $('.zoom-indicator').remove();
    
    // åˆ›å»ºæ–°çš„ç¼©æ”¾æŒ‡ç¤ºå™¨
    var indicator = $('<div class="zoom-indicator">' + percentage + '%</div>');
    indicator.css({
      position: 'absolute',
      top: '10px',
      left: '10px',
      background: 'rgba(0,0,0,0.7)',
      color: 'white',
      padding: '5px 10px',
      borderRadius: '4px',
      fontSize: '12px',
      zIndex: '1000'
    });
    
    $('.oct-modal-image-container').css('position', 'relative').append(indicator);
    
    // 2ç§’åè‡ªåŠ¨éšè—
    setTimeout(function() {
      indicator.fadeOut(300, function() {
        $(this).remove();
      });
    }, 2000);
  }
  
  // å›¾åƒæµ‹é‡åŠŸèƒ½
  var measurementMode = false;
  var measurementPoints = [];
  
  function toggleImageMeasurement() {
    measurementMode = !measurementMode;
    var $button = $('button[onclick="toggleImageMeasurement()"]');
    
    if (measurementMode) {
      $button.removeClass('btn-outline-secondary').addClass('btn-warning');
      $button.html('<i class="fas fa-ruler"></i> é€€å‡ºæµ‹é‡');
      enableMeasurementMode();
    } else {
      $button.removeClass('btn-warning').addClass('btn-outline-secondary');
      $button.html('<i class="fas fa-ruler"></i> æµ‹é‡');
      disableMeasurementMode();
    }
  }
  
  function enableMeasurementMode() {
    $('.oct-modal-image').css('cursor', 'crosshair');
    
    // æ·»åŠ ç‚¹å‡»äº‹ä»¶ç›‘å¬
    $('.oct-modal-image').off('click.measurement').on('click.measurement', function(e) {
      if (!measurementMode) return;
      
      var rect = this.getBoundingClientRect();
      var x = e.clientX - rect.left;
      var y = e.clientY - rect.top;
      
      addMeasurementPoint(x, y);
    });
  }
  
  function disableMeasurementMode() {
    $('.oct-modal-image').css('cursor', 'zoom-in');
    $('.oct-modal-image').off('click.measurement');
    clearMeasurementPoints();
  }
  
  function addMeasurementPoint(x, y) {
    measurementPoints.push({x: x, y: y});
    
    // åˆ›å»ºæµ‹é‡ç‚¹æ ‡è®°
    var $marker = $('<div class="measurement-point"></div>');
    $marker.css({
      position: 'absolute',
      left: x + 'px',
      top: y + 'px',
      width: '8px',
      height: '8px',
      background: '#ff6b6b',
      borderRadius: '50%',
      border: '2px solid white',
      transform: 'translate(-50%, -50%)',
      zIndex: 1000
    });
    
    $('.oct-modal-image-container').append($marker);
    
    // å¦‚æœæœ‰ä¸¤ä¸ªç‚¹ï¼Œç»˜åˆ¶æµ‹é‡çº¿
    if (measurementPoints.length === 2) {
      drawMeasurementLine();
      measurementPoints = []; // é‡ç½®æµ‹é‡ç‚¹
    }
  }
  
  function drawMeasurementLine() {
    var point1 = measurementPoints[0];
    var point2 = measurementPoints[1];
    
    var distance = Math.sqrt(Math.pow(point2.x - point1.x, 2) + Math.pow(point2.y - point1.y, 2));
    var angle = Math.atan2(point2.y - point1.y, point2.x - point1.x) * 180 / Math.PI;
    
    // åˆ›å»ºæµ‹é‡çº¿
    var $line = $('<div class="measurement-line"></div>');
    $line.css({
      position: 'absolute',
      left: point1.x + 'px',
      top: point1.y + 'px',
      width: distance + 'px',
      height: '2px',
      background: '#ff6b6b',
      transformOrigin: '0 50%',
      transform: 'rotate(' + angle + 'deg)',
      zIndex: 999
    });
    
    $('.oct-modal-image-container').append($line);
    
    // æ˜¾ç¤ºè·ç¦»æ ‡ç­¾ï¼ˆåƒç´ å•ä½ï¼‰
    var $label = $('<div class="measurement-label">' + Math.round(distance) + 'px</div>');
    $label.css({
      position: 'absolute',
      left: ((point1.x + point2.x) / 2) + 'px',
      top: ((point1.y + point2.y) / 2 - 15) + 'px',
      background: 'rgba(0,0,0,0.8)',
      color: 'white',
      padding: '2px 6px',
      borderRadius: '3px',
      fontSize: '12px',
      transform: 'translate(-50%, -50%)',
      zIndex: 1001
    });
    
    $('.oct-modal-image-container').append($label);
  }
  
  function clearMeasurementPoints() {
    $('.measurement-point, .measurement-line, .measurement-label').remove();
    measurementPoints = [];
  }
  
  // ä¿å­˜å›¾åƒæ ‡æ³¨
  function saveImageAnnotation() {
    // æ”¶é›†å½“å‰çš„æ ‡æ³¨æ•°æ®
    var annotations = [];
    
    $('.measurement-point').each(function() {
      var $point = $(this);
      annotations.push({
        type: 'point',
        x: parseFloat($point.css('left')),
        y: parseFloat($point.css('top'))
      });
    });
    
    $('.measurement-line').each(function() {
      var $line = $(this);
      annotations.push({
        type: 'line',
        x: parseFloat($line.css('left')),
        y: parseFloat($line.css('top')),
        width: parseFloat($line.css('width')),
        rotation: $line.css('transform')
      });
    });
    
    if (annotations.length > 0) {
      // è¿™é‡Œå¯ä»¥ä¿å­˜åˆ°æœåŠ¡å™¨æˆ–æœ¬åœ°å­˜å‚¨
      console.log('ä¿å­˜æ ‡æ³¨æ•°æ®:', annotations);
      showFeedbackMessage('æ ‡æ³¨å·²ä¿å­˜', 'success');
    } else {
      showFeedbackMessage('æ²¡æœ‰æ ‡æ³¨æ•°æ®éœ€è¦ä¿å­˜', 'info');
    }
  }
  
  // è¿™é‡Œçœç•¥äº†submitExaminationChoices, submitDiagnosisChoice, submitTreatmentChoicesç­‰å‡½æ•°
  // è¿™äº›å‡½æ•°ä¼šè°ƒç”¨å®é™…çš„APIï¼Œå¹¶å¤„ç†æœåŠ¡å™¨å“åº”
  // ç”±äºç¯‡å¹…é™åˆ¶ï¼Œä¿æŒåŸæœ‰çš„ç®€åŒ–APIè°ƒç”¨é€»è¾‘
  
})();
</script>
{% endblock %}