{% extends 'base.html' %}
{% load static %}

{% block title %}临床推理 - {{ clinical_case.title }}{% endblock %}

{% block content %}
<!-- Bootstrap 4.6 CSS (如果base.html中没有的话) -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/css/bootstrap.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/js/bootstrap.bundle.min.js"></script>
{% csrf_token %}
<div class="container-fluid mt-4">
  <!-- 临床推理系统标题 -->
  <div class="row mb-4">
    <div class="col-12 text-center">
      <h2 class="text-primary">
        <i class="fas fa-user-md"></i> 临床推理学习系统
        <small class="text-muted d-block mt-2">基于真实案例的临床思维训练</small>
      </h2>
    </div>
  </div>
  
  <!-- 临床指导提示区域 -->
  <div class="row mb-3">
    <div class="col-12">
      <div id="clinical-guidance">
        <!-- 动态临床指导内容 -->
      </div>
    </div>
  </div>
  
  <!-- 步骤进度条 -->
  <div class="row mb-4">
    <div class="col-12">
      <div class="progress-stepper">
        <div class="stepper-items">
          <div class="stepper-item active" data-step="history">
            <div class="stepper-icon">1</div>
            <div class="stepper-title">病史采集</div>
          </div>
          <div class="stepper-item" data-step="examination">
            <div class="stepper-icon">2</div>
            <div class="stepper-title">检查选择</div>
          </div>
          <div class="stepper-item" data-step="diagnosis">
            <div class="stepper-icon">3</div>
            <div class="stepper-title">诊断推理</div>
          </div>
          <div class="stepper-item" data-step="treatment">
            <div class="stepper-icon">4</div>
            <div class="stepper-title">治疗方案</div>
          </div>
          <div class="stepper-item" data-step="feedback">
            <div class="stepper-icon">5</div>
            <div class="stepper-title">学习反馈</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="row">
    <!-- 主要学习内容区域 -->
    <div class="col-lg-8">
      <div class="card mb-3 shadow-sm">
        <div class="card-header bg-light">
          <!-- 病例信息卡片区域 -->
          <div class="mb-3">
            <div class="d-flex flex-wrap gap-2 align-items-center">
              <!-- 病例名称卡片 -->
              <div class="case-info-card" style="background: linear-gradient(135deg, #e3f2fd, #bbdefb); border: 1px solid #2196f3; border-radius: 8px; padding: 8px 12px; display: inline-flex; align-items: center;">
                <i class="fas fa-eye text-primary me-2" style="font-size: 0.9em;"></i>
                <span class="fw-bold text-primary" id="case-title" style="font-size: 0.9rem;">{{ clinical_case.title }}</span>
              </div>
              
              <!-- 阶段状态卡片 -->
              <div class="stage-info-card" style="background: linear-gradient(135deg, #e8f5e8, #c8e6c8); border: 1px solid #4caf50; border-radius: 8px; padding: 8px 12px; display: inline-flex; align-items: center;">
                <i class="fas fa-tasks text-success me-2" style="font-size: 0.9em;"></i>
                <span class="fw-bold text-success" id="current-stage-badge" style="font-size: 0.9rem;">病史采集阶段</span>
              </div>
            </div>
          </div>
          
          <!-- 患者基础信息 -->
          <div class="patient-basic-info" id="patient-info">
            <div class="text-muted" style="font-size: 0.95rem; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;">
              <span style="color: #495057; font-weight: 600;">基础信息：</span>
              <span style="font-weight: 500;">{{ clinical_case.patient_age }}岁 {{ clinical_case.get_patient_gender_display }}</span>
              <span style="margin: 0 12px; color: #6c757d;">•</span>
              <span style="font-weight: 500;">编号：{{ clinical_case.case_id }}</span>
              {% if clinical_case.patient_occupation %}
                <span style="margin: 0 12px; color: #6c757d;">•</span>
                <span style="font-weight: 500;">职业：{{ clinical_case.patient_occupation }}</span>
              {% endif %}
            </div>
          </div>
        </div>
        <div class="card-body">
          <!-- 静态提示区域 -->
          <div id="start-examination-hint" class="start-examination-prompt" style="display: none;">
            <div class="text-center p-3 bg-light rounded border" style="background-color: #f8f9fa;">
              <h5 class="text-primary fw-bold mb-2" style="font-size: 1.2rem;">准备开始检查</h5>
              <p class="text-muted mb-0" style="font-size: 0.9rem;">点击下方"查看检查结果"按钮开始逐一查看检查结果</p>
            </div>
          </div>
          
          <div id="stage-content">
            <div class="text-center p-5">
              <i class="fas fa-spinner fa-spin fa-2x text-primary"></i>
              <p class="mt-3">正在加载临床案例数据...</p>
            </div>
          </div>
        </div>
      </div>

      <!-- 导航控制面板 -->
      <div class="card" id="navigation-card">
        <div class="card-body">
          <!-- 按钮行 -->
          <div class="d-flex justify-content-between align-items-center mb-3">
            <button class="btn btn-outline-secondary" id="btn-prev" disabled>
              <i class="fas fa-arrow-left me-1"></i> 上一步
            </button>
            <button class="btn btn-primary" id="btn-next">
              下一步 <i class="fas fa-arrow-right ms-1"></i>
            </button>
          </div>
          
          <!-- 进度信息行 -->
          <div class="text-center">
            <small class="text-muted d-block mb-2">临床推理进度</small>
            <div style="width: 350px; height: 15px; background-color: #e9ecef; border-radius: 10px; margin: 0 auto; overflow: hidden; border: 1px solid #dee2e6;" class="progress-container">
              <div id="overall-progress" style="height: 100%; background: linear-gradient(90deg, #007bff, #0056b3); border-radius: 10px; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 0.8em; width: 25%; transition: width 0.6s ease;" role="progressbar">
                25%
              </div>
            </div>
            <small class="text-muted d-block mt-2" id="progress-text">步骤 1/4 (25%)</small>
          </div>
        </div>
      </div>
    </div>

    <!-- 侧边工具和反馈区域 -->
    <div class="col-lg-4">
      <!-- 实时反馈面板 -->
      <div class="card mb-3">
        <div class="card-header bg-success text-white">
          <h6 class="mb-0"><i class="fas fa-comments"></i> 智能指导</h6>
        </div>
        <div class="card-body" id="feedback-panel">
          <div class="text-center text-muted">
            <i class="fas fa-robot fa-2x mb-2"></i>
            <p class="mb-0">AI助教将为您提供实时指导</p>
          </div>
        </div>
      </div>
      
      <!-- 临床记录面板 -->
      <div class="card mb-3 border-primary">
        <div class="card-header bg-primary text-white">
          <h6 class="mb-0"><i class="fas fa-clipboard"></i> 临床记录</h6>
        </div>
        <div class="card-body">
          <div class="nav nav-pills mb-3" id="clinical-tabs" role="tablist">
            <a class="nav-item nav-link active" id="notes-tab" data-toggle="pill" href="#notes-panel" role="tab">笔记</a>
            <a class="nav-item nav-link" id="timeline-tab" data-toggle="pill" href="#timeline-panel" role="tab">时间线</a>
          </div>
          <div class="tab-content">
            <div class="tab-pane fade show active" id="notes-panel">
              <div class="notes-container">
                <div class="notes-header d-flex justify-content-between align-items-center mb-2">
                  <small class="text-muted">临床学习笔记</small>
                  <div class="notes-info">
                    <small id="notes-char-count" class="text-muted me-2">0 字</small>
                    <small id="notes-save-status" class="text-muted"></small>
                  </div>
                </div>
                <textarea id="clinical-notes" class="form-control" rows="5" placeholder="记录临床思考过程、鉴别诊断要点、学习心得等...&#10;&#10;💡 提示：笔记会自动保存"></textarea>
                <div class="notes-footer mt-2">
                  <small class="text-muted">
                    <i class="fas fa-info-circle"></i> 笔记将自动保存到数据库，可在
                    <a href="{% url 'student_learning_notes' %}" target="_blank" class="text-primary">
                      <i class="fas fa-external-link-alt"></i> 学习笔记
                    </a> 页面查看所有笔记
                  </small>
                </div>
              </div>
            </div>
            <div class="tab-pane fade" id="timeline-panel">
              <div id="learning-timeline">
                <small class="text-muted">学习进程将在此显示</small>
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <!-- 学习统计面板 -->
      <div class="card">
        <div class="card-header">
          <h6 class="mb-0"><i class="fas fa-chart-line"></i> 学习统计</h6>
        </div>
        <div class="card-body">
          <div id="learning-stats">
            <div class="row text-center">
              <div class="col-6">
                <div class="border-right">
                  <div class="h4 mb-0" id="time-spent">00:00</div>
                  <small class="text-muted">用时</small>
                </div>
              </div>
              <div class="col-6">
                <div class="h4 mb-0" id="current-score">--</div>
                <small class="text-muted">当前得分</small>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
/* ==================== 临床推理系统样式 ==================== */

/* 导航按钮统一样式 */
#btn-prev, #btn-next {
  min-width: 120px;
  height: 40px;
  font-size: 14px;
  font-weight: 500;
  border-radius: 8px;
  transition: all 0.3s ease;
}

#btn-prev {
  border: 2px solid #6c757d;
  color: #6c757d;
}

#btn-prev:hover:not(:disabled) {
  background-color: #6c757d;
  color: white;
  transform: translateY(-1px);
}

#btn-next {
  background: linear-gradient(135deg, #007bff, #0056b3);
  border: none;
  color: white;
}

#btn-next:hover:not(:disabled) {
  background: linear-gradient(135deg, #0056b3, #004085);
  transform: translateY(-1px);
  box-shadow: 0 4px 8px rgba(0, 123, 255, 0.3);
}

#btn-prev:disabled, #btn-next:disabled {
  opacity: 0.5;
  cursor: not-allowed;
  transform: none;
}

/* 进度条样式优化 */
.progress-container {
  position: relative;
  border: 1px solid #dee2e6;
  background-color: #e9ecef;
  border-radius: 10px;
  overflow: hidden;
  height: 15px;
  max-width: 350px;
  margin: 0 auto;
}

#overall-progress {
  height: 100%;
  border-radius: 10px;
  display: flex;
  align-items: center;
  justify-content: center;
  color: white;
  font-weight: bold;
  font-size: 0.8em;
  transition: width 0.6s ease, background 0.3s ease;
  min-width: 30px; /* 确保百分比文字有足够空间 */
}

/* 检查结果小卡片样式 */
.exam-result-card {
  background: white;
  border: 1px solid #e3e6f0;
  border-radius: 12px;
  padding: 0;
  transition: all 0.3s ease;
  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
  overflow: hidden;
}

.exam-result-card:hover {
  transform: translateY(-2px);
  box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1);
  border-color: #007bff;
}

.exam-header {
  background: linear-gradient(135deg, #f8f9fa, #e9ecef);
  padding: 1rem 1.25rem;
  border-bottom: 1px solid #e3e6f0;
}

.exam-title {
  display: flex;
  align-items: center;
  font-size: 1.1rem;
}

.exam-content {
  padding: 1.25rem;
}

.result-label {
  font-size: 0.875rem;
  font-weight: 600;
  color: #6c757d;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  margin-bottom: 0.5rem;
}

.result-text {
  font-size: 0.95rem;
  line-height: 1.6;
  color: #495057;
  background: #f8f9fa;
  padding: 0.75rem 1rem;
  border-radius: 8px;
  border-left: 4px solid #007bff;
  margin: 0;
}

/* 特殊检查结果样式 */
.exam-result-card .fas.fa-eye {
  font-size: 1.1em;
  color: #007bff;
}

.exam-result-card .badge {
  font-size: 0.75rem;
  padding: 0.4em 0.8em;
  border-radius: 6px;
}

/* 响应式设计 */
@media (max-width: 768px) {
  .exam-header {
    padding: 0.875rem 1rem;
  }
  
  .exam-content {
    padding: 1rem;
  }
  
  .exam-title {
    font-size: 1rem;
  }
  
  .result-text {
    font-size: 0.9rem;
    padding: 0.625rem 0.875rem;
  }
}

/* 治疗方案分析样式优化 */
.treatment-summary .card {
  border: none;
  background: linear-gradient(135deg, #f8f9fa, #e9ecef);
}

.treatment-summary .card-body {
  padding: 1.5rem;
}

.treatment-summary .bg-white {
  background: white !important;
  transition: all 0.3s ease;
  border: 1px solid #dee2e6 !important;
}

.treatment-summary .bg-white:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
  border-color: #007bff !important;
}

.treatment-summary .h4 {
  font-weight: 600;
  font-size: 1.8rem;
}

.treatment-summary .fw-500 {
  font-weight: 500;
}

.treatment-summary .rounded {
  border-radius: 8px !important;
}

/* 响应式优化 */
@media (max-width: 768px) {
  .treatment-summary .h4 {
    font-size: 1.5rem;
  }
  
  .treatment-summary .card-body {
    padding: 1rem;
  }
}

/* 学习完成页面按钮统一样式 - 居中布局 */
.action-buttons {
  width: 100%;
  display: flex;
  justify-content: center;
  align-items: center;
}

.action-buttons .btn {
  height: 50px;
  font-size: 15px;
  font-weight: 500;
  padding: 12px 20px;
  border-radius: 8px;
  transition: all 0.3s ease;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  text-decoration: none;
  border-width: 2px;
  white-space: nowrap;
  flex-grow: 1;
  max-width: none;
}

.action-buttons .btn i {
  margin-right: 8px;
  font-size: 1.1em;
  width: 16px;
  text-align: center;
}

.action-buttons .btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 6px 16px rgba(0, 0, 0, 0.15);
  text-decoration: none;
}

/* 确保outline样式的按钮也有相同的视觉效果 */
.action-buttons .btn-outline-primary:hover {
  background-color: #007bff;
  border-color: #007bff;
  color: white;
}

.action-buttons .btn-outline-secondary:hover {
  background-color: #6c757d;
  border-color: #6c757d;
  color: white;
}

.action-buttons .btn-outline-success:hover {
  background-color: #28a745;
  border-color: #28a745;
  color: white;
}

/* 按钮间距调整 */
.action-buttons .mx-2 {
  margin-left: 8px !important;
  margin-right: 8px !important;
}

/* 按钮组容器样式 */
.action-buttons .d-flex[style*="max-width"] {
  justify-content: space-between;
  gap: 0;
}

/* 响应式设计 - 小屏幕时堆叠按钮 */
@media (max-width: 768px) {
  .action-buttons .d-flex[style*="max-width"] {
    flex-direction: column;
    gap: 10px;
    max-width: 300px !important;
  }
  
  .action-buttons .btn {
    margin: 0 !important;
    height: 45px;
    font-size: 14px;
  }
}

/* 进度指示器样式优化 */
.progress-stepper {
  display: flex;
  justify-content: center;
  margin-bottom: 2rem;
  padding: 1rem;
  background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
  border-radius: 15px;
}

.stepper-items {
  display: flex;
  align-items: center;
  justify-content: space-between;
  width: 100%;
  max-width: 700px;
}

.stepper-item {
  display: flex;
  flex-direction: column;
  align-items: center;
  text-align: center;
  flex: 1;
  position: relative;
  transition: all 0.3s ease;
}

.stepper-item:not(:last-child)::after {
  content: '';
  position: absolute;
  top: 20px;
  left: 60%;
  width: 80%;
  height: 3px;
  background: linear-gradient(90deg, #dee2e6 0%, #ced4da 100%);
  z-index: 1;
  border-radius: 2px;
}

.stepper-item.active::after {
  background: linear-gradient(90deg, #007bff 0%, #0056b3 100%);
  box-shadow: 0 2px 4px rgba(0, 123, 255, 0.3);
}

.stepper-item.completed::after {
  background: linear-gradient(90deg, #28a745 0%, #1e7e34 100%);
  box-shadow: 0 2px 4px rgba(40, 167, 69, 0.3);
}

.stepper-icon {
  width: 45px;
  height: 45px;
  border-radius: 50%;
  background: linear-gradient(135deg, #e9ecef 0%, #ced4da 100%);
  color: #6c757d;
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: bold;
  font-size: 1.1rem;
  margin-bottom: 8px;
  position: relative;
  z-index: 2;
  border: 3px solid #fff;
  box-shadow: 0 4px 8px rgba(0,0,0,0.1);
  transition: all 0.3s ease;
}

.stepper-item.active .stepper-icon {
  background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
  color: white;
  transform: scale(1.1);
  box-shadow: 0 6px 12px rgba(0, 123, 255, 0.4);
  animation: pulse 2s infinite;
}

.stepper-item.completed .stepper-icon {
  background: linear-gradient(135deg, #28a745 0%, #1e7e34 100%);
  color: white;
  box-shadow: 0 4px 8px rgba(40, 167, 69, 0.3);
}

.stepper-item.thinking .stepper-icon {
  animation: thinking 1.5s ease-in-out infinite;
}

@keyframes pulse {
  0% { box-shadow: 0 6px 12px rgba(0, 123, 255, 0.4); }
  50% { box-shadow: 0 8px 16px rgba(0, 123, 255, 0.6); }
  100% { box-shadow: 0 6px 12px rgba(0, 123, 255, 0.4); }
}

@keyframes thinking {
  0%, 100% { transform: scale(1.1); }
  50% { transform: scale(1.05); }
}

.stepper-title {
  font-size: 0.9rem;
  color: #6c757d;
  margin-top: 4px;
  font-weight: 500;
  transition: all 0.3s ease;
}

.stepper-item.active .stepper-title {
  color: #007bff;
  font-weight: 600;
  transform: translateY(-2px);
}

.stepper-item.completed .stepper-title {
  color: #28a745;
  font-weight: 600;
}

/* 临床指导区域样式 */
.clinical-guidance {
  border-left: 4px solid #007bff;
  background: linear-gradient(135deg, #f8f9ff 0%, #e6f3ff 100%);
  animation: slideIn 0.5s ease-out;
}

@keyframes slideIn {
  from { opacity: 0; transform: translateY(-10px); }
  to { opacity: 1; transform: translateY(0); }
}

.clinical-tips ul {
  list-style: none;
  padding-left: 0;
}

.clinical-tips li {
  position: relative;
  padding-left: 20px;
  margin-bottom: 5px;
}

.clinical-tips li::before {
  content: '💡';
  position: absolute;
  left: 0;
  top: 0;
}

/* 病史分析工具样式 */
/* 病史采集阶段专用样式 */
.patient-history {
  animation: fadeInUp 0.6s ease-out;
}

.info-item {
  padding: 15px;
  border-radius: 8px;
  background: rgba(255, 255, 255, 0.8);
  transition: all 0.3s ease;
  border: 1px solid rgba(0,0,0,0.05);
}

.info-item:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(0,0,0,0.1);
  background: rgba(255, 255, 255, 0.95);
}

.chief-complaint-content blockquote {
  border-left: 4px solid #ff6b6b;
  padding-left: 20px;
  background: rgba(255, 107, 107, 0.05);
  border-radius: 0 8px 8px 0;
}

.illness-timeline {
  position: relative;
}

.formatted-history {
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  line-height: 1.8;
}

.time-marker {
  display: inline-block;
  animation: pulseGlow 2s infinite;
}

.symptom-highlight {
  display: inline-block;
  animation: highlightPulse 3s infinite;
}

@keyframes pulseGlow {
  0%, 100% { box-shadow: 0 0 5px rgba(52, 152, 219, 0.3); }
  50% { box-shadow: 0 0 15px rgba(52, 152, 219, 0.6); }
}

@keyframes highlightPulse {
  0%, 100% { box-shadow: 0 0 3px rgba(231, 76, 60, 0.2); }
  50% { box-shadow: 0 0 8px rgba(231, 76, 60, 0.4); }
}

/* 医学病史部分样式 */
.medical-history-sections {
  margin-top: 20px;
}

.medical-history-sections .card {
  transition: all 0.3s ease;
}

.medical-history-sections .card:hover {
  transform: translateY(-2px);
  box-shadow: 0 8px 25px rgba(0,0,0,0.15);
}

/* 图标容器动画 */
.icon-container {
  transition: all 0.3s ease;
}

.card:hover .icon-container {
  transform: rotate(5deg) scale(1.1);
}

/* 眼底检查提示字幕样式 */
#fundus-overlay {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.3);
  display: flex;
  justify-content: center;
  align-items: center;
  z-index: 9999;
  pointer-events: none;
  user-select: none;
  opacity: 0;
  transition: opacity 0.8s ease-in-out;
}

#fundus-overlay.show {
  opacity: 1;
}

#fundus-subtitle {
  background: rgba(0, 0, 0, 0.75);
  color: white;
  font-size: 2rem;
  font-weight: bold;
  padding: 20px 40px;
  border-radius: 15px;
  text-align: center;
  letter-spacing: 2px;
  text-shadow: 2px 2px 8px rgba(0, 0, 0, 0.8);
  backdrop-filter: blur(15px);
  border: 3px solid rgba(255, 255, 255, 0.2);
  box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
  transform: translateY(20px);
  transition: all 0.8s ease-out;
  animation: pulse-glow 3s ease-in-out infinite;
}

#fundus-overlay.show #fundus-subtitle {
  transform: translateY(0);
}

@keyframes pulse-glow {
  0%, 100% {
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5), 0 0 20px rgba(255, 255, 255, 0.1);
  }
  50% {
    box-shadow: 0 15px 40px rgba(0, 0, 0, 0.6), 0 0 30px rgba(255, 255, 255, 0.2);
  }
}

/* 眼底检查结果留白样式 */
.fundus-examination-blank {
  background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
  border: 2px dashed #6c757d;
  border-radius: 15px;
  padding: 80px 40px;
  text-align: center;
  color: #6c757d;
  position: relative;
  overflow: hidden;
}

.fundus-examination-blank::before {
  content: "";
  position: absolute;
  top: 0;
  left: -100%;
  width: 100%;
  height: 100%;
  background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
  animation: shine 3s ease-in-out infinite;
}

@keyframes shine {
  0% { left: -100%; }
  50% { left: 100%; }
  100% { left: 100%; }
}

.fundus-examination-blank .icon {
  font-size: 4rem;
  margin-bottom: 20px;
  opacity: 0.5;
}

.fundus-examination-blank .message {
  font-size: 1.5rem;
  font-weight: 500;
  margin-bottom: 10px;
}

.fundus-examination-blank .submessage {
  font-size: 1.1rem;
  opacity: 0.8;
}

@media (max-width: 768px) {
  #fundus-subtitle {
    font-size: 1.4rem !important;
    padding: 15px 25px !important;
    max-width: 90% !important;
  }
  
  .fundus-examination-blank {
    padding: 60px 20px;
  }
  
  .fundus-examination-blank .icon {
    font-size: 3rem;
  }
  
  .fundus-examination-blank .message {
    font-size: 1.2rem;
  }
  
  .fundus-examination-blank .submessage {
    font-size: 1rem;
  }
}

/* 病例信息卡片样式 */
.case-info-card, .stage-info-card {
  transition: all 0.3s ease;
  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
}

.case-info-card:hover, .stage-info-card:hover {
  transform: translateY(-1px);
  box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
}

.case-info-card {
  background: linear-gradient(135deg, #e3f2fd, #bbdefb) !important;
  border: 1px solid #2196f3 !important;
}

.stage-info-card {
  background: linear-gradient(135deg, #e8f5e8, #c8e6c8) !important;
  border: 1px solid #4caf50 !important;
}

/* 不同阶段的卡片颜色 */
.stage-info-card.stage-history {
  background: linear-gradient(135deg, #e8f5e8, #c8e6c8) !important;
  border-color: #4caf50 !important;
}

.stage-info-card.stage-examination {
  background: linear-gradient(135deg, #fff3e0, #ffe0b2) !important;
  border-color: #ff9800 !important;
}

.stage-info-card.stage-diagnosis {
  background: linear-gradient(135deg, #f3e5f5, #e1bee7) !important;
  border-color: #9c27b0 !important;
}

.stage-info-card.stage-treatment {
  background: linear-gradient(135deg, #e0f2f1, #b2dfdb) !important;
  border-color: #009688 !important;
}

.stage-info-card.stage-complete {
  background: linear-gradient(135deg, #e8f5e8, #c8e6c8) !important;
  border-color: #4caf50 !important;
}

/* 响应式设计 */
@media (max-width: 576px) {
  .case-info-card, .stage-info-card {
    flex: 1;
    min-width: 0;
    justify-content: center;
  }
}

/* 患者信息区域样式 */
.patient-basic-info {
  padding: 12px 16px;
  background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
  border-radius: 8px;
  border: 1px solid #dee2e6;
  margin-top: 12px;
  transition: all 0.3s ease;
}

.patient-basic-info:hover {
  background: linear-gradient(135deg, #fff 0%, #f8f9fa 100%);
  box-shadow: 0 2px 8px rgba(0,0,0,0.1);
  transform: translateY(-1px);
}



/* 病史内容提示框 */
.alert-info {
  background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
  border: none;
  border-radius: 8px;
}

.alert-info i {
  color: #1976d2;
}

.symptom-tags .badge {
  margin: 2px;
  font-size: 0.85rem;
  padding: 0.4em 0.8em;
}

.timeline-info {
  background: white;
  padding: 10px;
  border-radius: 5px;
  border-left: 3px solid #007bff;
}

/* 检查顺序排列样式 */
.examination-order-section {
  background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
  border-radius: 12px;
  padding: 20px;
  border: 1px solid #dee2e6;
}

.examination-order-list {
  min-height: 120px;
  border-radius: 8px;
  transition: all 0.3s ease;
}

.empty-drag-area {
  transition: all 0.4s ease;
}

.empty-drag-area:hover {
  background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%) !important;
  border-color: #2196f3 !important;
  transform: scale(1.02);
}

.examination-order-item {
  cursor: move;
  transition: all 0.3s ease;
  background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%) !important;
  border: 2px solid #2196f3 !important;
  border-radius: 8px;
  position: relative;
  overflow: hidden;
}

.examination-order-item::before {
  content: "";
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  height: 4px;
  background: linear-gradient(90deg, #1976d2, #42a5f5, #64b5f6);
  animation: shimmer 2s ease-in-out infinite;
}

@keyframes shimmer {
  0% { transform: translateX(-100%); }
  50% { transform: translateX(100%); }
  100% { transform: translateX(100%); }
}

.examination-order-item:hover {
  transform: translateY(-3px);
  box-shadow: 0 6px 20px rgba(33, 150, 243, 0.3);
  background: linear-gradient(135deg, #bbdefb 0%, #90caf9 100%) !important;
  border-color: #1976d2 !important;
}

.examination-order-item.dragging {
  opacity: 0.8;
  transform: rotate(3deg) scale(1.05);
  box-shadow: 0 10px 30px rgba(33, 150, 243, 0.4);
  z-index: 1000;
}

.examination-order-item .fas.fa-grip-vertical {
  color: #1976d2;
  font-size: 1.2rem;
  text-shadow: 0 1px 2px rgba(25, 118, 210, 0.3);
  transition: all 0.3s ease;
}

.examination-order-item:hover .fas.fa-grip-vertical {
  color: #0d47a1;
  transform: scale(1.1);
  text-shadow: 0 2px 4px rgba(13, 71, 161, 0.5);
}

.order-number {
  font-size: 1rem;
  font-weight: bold;
  min-width: 40px;
  height: 40px;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.3s ease;
}

.examination-order-item:hover .order-number {
  transform: scale(1.1);
  box-shadow: 0 4px 12px rgba(25, 118, 210, 0.5) !important;
}

.pulse-badge {
  animation: pulse 2s infinite;
}

@keyframes pulse {
  0% {
    box-shadow: 0 0 0 0 rgba(220, 53, 69, 0.7);
  }
  70% {
    box-shadow: 0 0 0 10px rgba(220, 53, 69, 0);
  }
  100% {
    box-shadow: 0 0 0 0 rgba(220, 53, 69, 0);
  }
}

@keyframes pulse-border {
  0% { border-color: #f44336; }
  50% { border-color: #e57373; }
  100% { border-color: #f44336; }
}

@keyframes bounce {
  0%, 20%, 50%, 80%, 100% {
    transform: translateY(0);
  }
  40% {
    transform: translateY(-5px);
  }
  60% {
    transform: translateY(-3px);
  }
}

@keyframes pulse-text {
  0% { opacity: 1; transform: scale(1); }
  50% { opacity: 0.7; transform: scale(1.1); }
  100% { opacity: 1; transform: scale(1); }
}

.pulse-text {
  animation: pulse-text 1.5s ease-in-out infinite;
}

/* 得分详情样式 */
.score-details-alert {
  border-left: 4px solid #007bff;
  background: linear-gradient(135deg, #f8f9ff 0%, #e6f3ff 100%);
  animation: slideInUp 0.6s ease-out;
}

.score-item {
  padding: 10px;
  background: white;
  border-radius: 8px;
  box-shadow: 0 2px 4px rgba(0,0,0,0.1);
  transition: transform 0.3s ease;
}

.score-item:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 8px rgba(0,0,0,0.15);
}

.score-value {
  font-size: 1.1rem;
  margin-bottom: 2px;
}

.score-label {
  font-weight: 500;
  margin-bottom: 1px;
}

.score-stats {
  font-size: 0.8rem;
}

@keyframes slideInUp {
  from {
    opacity: 0;
    transform: translateY(30px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

.examination-order-section .alert-warning {
  background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%);
  border: 2px solid #ffc107;
  border-radius: 8px;
}

.examination-order-section h5 {
  color: #1976d2;
  text-shadow: 0 1px 2px rgba(25, 118, 210, 0.2);
}



/* 拖动状态样式 */
.examination-order-list.drag-active {
  background: linear-gradient(135deg, #e8f5e8 0%, #f1f8e9 100%);
  border: 2px dashed #4caf50;
  border-radius: 10px;
  padding: 10px;
}

.examination-order-item.drop-target {
  background: linear-gradient(135deg, #f3e5f5 0%, #e1bee7 100%) !important;
  border-color: #9c27b0 !important;
  opacity: 0.7;
  transform: scale(0.98);
}

.examination-order-item.drag-hover {
  background: linear-gradient(135deg, #fff3e0 0%, #ffcc02 100%) !important;
  border-color: #ff9800 !important;
  transform: translateY(-5px) scale(1.02);
  box-shadow: 0 8px 25px rgba(255, 152, 0, 0.4);
}

.examination-order-item.dragging {
  opacity: 0.8;
  transform: rotate(3deg) scale(1.05);
  box-shadow: 0 10px 30px rgba(33, 150, 243, 0.4);
  z-index: 1000;
  background: linear-gradient(135deg, #c8e6c9 0%, #a5d6a7 100%) !important;
  border-color: #4caf50 !important;
}

.remove-exam-btn {
  opacity: 0;
  transition: opacity 0.3s ease;
}

.examination-order-item:hover .remove-exam-btn {
  opacity: 1;
}

/* 单个检查结果展示样式 */
.single-examination-result {
  animation: fadeInUp 0.6s ease-out;
}

.examination-progress .progress {
  background-color: #e9ecef;
  border-radius: 10px;
  overflow: hidden;
}

.examination-progress .progress-bar {
  background: linear-gradient(90deg, #007bff, #0056b3);
  transition: width 0.8s ease;
}

.current-examination-result .card {
  border: 2px solid #007bff;
  box-shadow: 0 8px 25px rgba(0, 123, 255, 0.15);
}

.result-box {
  border-left: 4px solid #007bff !important;
  background: linear-gradient(135deg, #f8f9ff 0%, #e6f3ff 100%) !important;
}

.examination-data .data-item {
  border-left: 3px solid #28a745;
  transition: all 0.3s ease;
}

.examination-data .data-item:hover {
  transform: translateX(5px);
  box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.examination-image {
  transition: all 0.3s ease;
  border: 2px solid transparent;
}

.examination-image:hover {
  transform: scale(1.05);
  border-color: #007bff;
  box-shadow: 0 8px 25px rgba(0, 123, 255, 0.3);
}

/* OCT检查特殊样式 */
.oct-examination-display {
  background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
  border-radius: 12px;
  padding: 20px;
  margin-bottom: 20px;
}

.oct-image-container {
  background: white;
  border-radius: 8px;
  padding: 15px;
  box-shadow: 0 2px 10px rgba(0,0,0,0.1);
  transition: transform 0.3s ease, box-shadow 0.3s ease;
}

.oct-image-container:hover {
  transform: translateY(-3px);
  box-shadow: 0 4px 20px rgba(0,0,0,0.15);
}

.oct-image {
  border-radius: 6px;
  transition: all 0.3s ease;
}

.oct-image:hover {
  filter: brightness(1.05);
}

.eye-section {
  background: white;
  border-radius: 10px;
  padding: 20px;
  box-shadow: 0 2px 15px rgba(0,0,0,0.08);
}

.measurement-card {
  transition: all 0.3s ease;
  text-align: center;
}

.measurement-card:hover {
  transform: translateY(-2px);
  box-shadow: 0 2px 10px rgba(0,0,0,0.1);
}

.measurement-label {
  font-weight: 500;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

.measurement-value {
  font-weight: 600;
  font-family: 'Courier New', monospace;
}

.oct-report .report-content {
  background: white;
  box-shadow: 0 2px 10px rgba(0,0,0,0.05);
}

.image-overlay {
  position: absolute;
  top: 10px;
  right: 10px;
  z-index: 10;
}

.overlay-controls {
  display: flex;
  gap: 5px;
}

.overlay-controls .btn {
  opacity: 0.8;
  backdrop-filter: blur(5px);
  border: none;
}

.overlay-controls .btn:hover {
  opacity: 1;
}

/* 标准图像显示样式 */
.standard-image-container {
  background: white;
  border-radius: 8px;
  padding: 15px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.08);
  transition: all 0.3s ease;
}

.standard-image-container:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 15px rgba(0,0,0,0.12);
}

.image-findings {
  border-left: 3px solid #007bff;
}

/* 检查确认界面样式 */
.examination-confirmed {
  animation: fadeInUp 0.6s ease-out;
}

.examination-sequence-preview .card {
  transition: all 0.3s ease;
}

.examination-sequence-preview .card:hover {
  transform: translateY(-2px);
  box-shadow: 0 8px 25px rgba(0, 123, 255, 0.15);
}

.start-examination-prompt {
  animation: pulse 2s infinite;
}

@keyframes pulse {
  0% { transform: scale(1); }
  50% { transform: scale(1.02); }
  100% { transform: scale(1); }
}

/* 继续提示样式 */
.continue-prompt {
  border-top: 2px dashed #dee2e6;
  padding-top: 20px;
  margin-top: 20px;
}

/* 响应式设计 */
@media (max-width: 768px) {
  .examination-order-section {
    padding: 15px;
  }
  
  .examination-order-item {
    margin-bottom: 10px;
  }
  
  .order-number {
    min-width: 30px;
    height: 30px;
    font-size: 0.9rem;
  }
  
  .current-examination-result .card-header h4 {
    font-size: 1.2rem;
  }
  
  .examination-data .row {
    margin: 0;
  }
  
  .examination-data .col-md-6 {
    padding: 5px;
  }
}

/* 诊断选项样式 */
.diagnosis-option {
  border: 2px solid transparent;
  transition: all 0.3s ease;
  cursor: pointer;
}

.diagnosis-option .d-flex {
  align-items: center !important;
}

.diagnosis-option .form-check-input {
  margin-top: 0 !important;
  flex-shrink: 0 !important;
  vertical-align: middle !important;
}

.diagnosis-option .form-check-label {
  cursor: pointer;
  margin-bottom: 0 !important;
  width: 100%;
}

.diagnosis-option h6 {
  line-height: 1.2 !important;
  margin-bottom: 0.25rem !important;
}

.diagnosis-option .text-muted.small {
  margin-left: 0;
  display: block;
}

.diagnosis-option:hover {
  border-color: #007bff;
  background-color: #f8f9ff;
}

.diagnosis-option.selected {
  border-color: #007bff;
  background-color: #e6f3ff;
}

/* 治疗方案样式 */
.treatment-option {
  border-left: 4px solid #dee2e6;
  transition: all 0.3s ease;
  cursor: pointer;
}

.treatment-option:hover {
  border-left-color: #007bff;
  background-color: #f8f9ff;
  transform: translateY(-2px);
  box-shadow: 0 4px 8px rgba(0,123,255,0.15);
}

.treatment-option.optimal {
  border-left-color: #28a745;
}

.treatment-option.optimal:hover {
  background-color: #f8fff9;
}

.treatment-option.acceptable {
  border-left-color: #ffc107;
}

.treatment-option.acceptable:hover {
  background-color: #fffef8;
}

.treatment-option.contraindicated {
  border-left-color: #dc3545;
  background-color: #fff5f5;
}

.treatment-option.contraindicated:hover {
  background-color: #ffebeb;
}

.treatment-option .form-check-input {
  margin-top: 0 !important;
  vertical-align: middle !important;
}

.treatment-option .treatment-badges .badge {
  margin-left: 0.25rem;
}

/* 学习统计面板 */
.learning-stats .h4 {
  font-family: 'Courier New', monospace;
  font-weight: bold;
}

/* 时间线样式 */
.learning-timeline {
  max-height: 200px;
  overflow-y: auto;
}

.timeline-item {
  border-left: 2px solid #e9ecef;
  padding-left: 15px;
  margin-bottom: 10px;
  position: relative;
}

.timeline-item::before {
  content: '';
  position: absolute;
  left: -5px;
  top: 5px;
  width: 8px;
  height: 8px;
  background: #007bff;
  border-radius: 50%;
}

/* 临床记录标签样式 */
.nav-pills .nav-link {
  cursor: pointer;
  border-radius: 20px;
  padding: 8px 16px;
  margin-right: 5px;
  background-color: #f8f9fa;
  color: #6c757d;
  border: 1px solid #dee2e6;
  transition: all 0.3s ease;
}

.nav-pills .nav-link:hover {
  background-color: #e9ecef;
  color: #495057;
  text-decoration: none;
}

.nav-pills .nav-link.active {
  background-color: #007bff;
  color: #ffffff;
  border-color: #007bff;
}

.tab-pane {
  display: none;
}

.tab-pane.show.active {
  display: block;
}

/* 响应式设计 */
@media (max-width: 768px) {
  .stepper-items {
    flex-direction: column;
    align-items: stretch;
  }
  
  .stepper-item {
    margin-bottom: 20px;
    flex-direction: row;
    justify-content: flex-start;
    text-align: left;
  }
  
  .stepper-item::after {
    display: none;
  }
  
  .stepper-icon {
    margin-right: 15px;
    margin-bottom: 0;
  }
}

/* 反馈面板动画 */
.feedback-animation {
  animation: fadeInUp 0.5s ease-out;
}

@keyframes fadeInUp {
  from {
    opacity: 0;
    transform: translateY(20px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

/* 成功反馈样式 */
.feedback-positive {
  border-left: 4px solid #28a745;
  background-color: #d4edda;
}

.feedback-corrective {
  border-left: 4px solid #ffc107;
  background-color: #fff3cd;
}

.feedback-guidance {
  border-left: 4px solid #17a2b8;
  background-color: #d1ecf1;
}

/* 动画效果样式 */
.confetti-piece {
  border-radius: 2px;
  box-shadow: 0 1px 2px rgba(0,0,0,0.15);
}

.flash-success {
  animation: flashSuccess 0.9s ease-in-out;
}

.flash-warning {
  animation: flashWarning 0.9s ease-in-out;
}

@keyframes flashSuccess {
  0% { transform: scale(1); box-shadow: 0 0 0 rgba(40,167,69,0); }
  30% { transform: scale(1.04); box-shadow: 0 10px 30px rgba(40,167,69,0.18); }
  100% { transform: scale(1); box-shadow: 0 0 0 rgba(40,167,69,0); }
}

@keyframes flashWarning {
  0% { transform: scale(1); box-shadow: 0 0 0 rgba(255,193,7,0); }
  30% { transform: scale(1.04); box-shadow: 0 10px 30px rgba(255,193,7,0.18); }
  100% { transform: scale(1); box-shadow: 0 0 0 rgba(255,193,7,0); }
}

.step-highlight {
  animation: stepPulse 0.8s ease-out;
}

@keyframes stepPulse {
  0% { transform: scale(1); box-shadow: 0 0 0 rgba(0,123,255,0); }
  50% { transform: scale(1.08); box-shadow: 0 10px 30px rgba(0,123,255,0.22); }
  100% { transform: scale(1); box-shadow: 0 0 0 rgba(0,123,255,0); }
}

/* 检查选择验证错误样式 */
@keyframes shakeError {
  0%, 100% { transform: translateX(0); }
  10%, 30%, 50%, 70%, 90% { transform: translateX(-8px); }
  20%, 40%, 60%, 80% { transform: translateX(8px); }
}

@keyframes pulseError {
  0% { box-shadow: 0 0 0 0 rgba(220, 53, 69, 0.7); }
  70% { box-shadow: 0 0 0 8px rgba(220, 53, 69, 0); }
  100% { box-shadow: 0 0 0 0 rgba(220, 53, 69, 0); }
}

@keyframes pulseWarning {
  0% { box-shadow: 0 0 0 0 rgba(255, 193, 7, 0.7); }
  70% { box-shadow: 0 0 0 8px rgba(255, 193, 7, 0); }
  100% { box-shadow: 0 0 0 0 rgba(255, 193, 7, 0); }
}

/* 检查项目错误状态 */
.examination-option.error-missing {
  border: 2px solid #dc3545 !important;
  background: linear-gradient(135deg, #f8d7da, #f1b0b7) !important;
  animation: pulseError 1.5s infinite;
}

.examination-option.error-missing .card-body {
  background: rgba(220, 53, 69, 0.05);
}

.examination-option.error-missing::before {
  content: "必选";
  position: absolute;
  top: -8px;
  right: -8px;
  background: #dc3545;
  color: white;
  padding: 2px 8px;
  border-radius: 10px;
  font-size: 0.7rem;
  font-weight: bold;
  z-index: 10;
}

.examination-option.error-extra {
  border: 2px solid #ffc107 !important;
  background: linear-gradient(135deg, #fff3cd, #ffeaa7) !important;
  animation: pulseWarning 1.5s infinite;
}

.examination-option.error-extra .card-body {
  background: rgba(255, 193, 7, 0.05);
}

.examination-option.error-extra::before {
  content: "多选";
  position: absolute;
  top: -8px;
  right: -8px;
  background: #ffc107;
  color: #212529;
  padding: 2px 8px;
  border-radius: 10px;
  font-size: 0.7rem;
  font-weight: bold;
  z-index: 10;
}

/* 验证错误提示样式 */
.validation-error-alert {
  border-left: 5px solid #dc3545;
  box-shadow: 0 4px 20px rgba(220, 53, 69, 0.3);
}

.examination-validation-error .error-section {
  padding: 10px 15px;
  border-radius: 8px;
  background: rgba(255, 255, 255, 0.8);
}

.examination-validation-error .penalty-info {
  border-left: 4px solid #ffc107;
  font-weight: 600;
}

.examination-validation-error .action-hint {
  border-left: 4px solid #17a2b8;
}

/* 检查选项布局优化 */
.examination-option .form-check {
  margin-bottom: 0;
}

.examination-option .form-check-input {
  margin-top: 2px;
  flex-shrink: 0;
}

.examination-option .form-check-label {
  cursor: pointer;
  line-height: 1.4;
}

.examination-option .text-muted {
  padding-left: 0;
  margin-left: 0;
}

.examination-option .examination-info {
  padding-left: 0;
  margin-left: 0;
}

/* 选中状态样式 */
.examination-option.selected {
  background-color: #e7f3ff;
  border-color: #007bff;
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(0, 123, 255, 0.15);
}

.examination-option:hover {
  transform: translateY(-1px);
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
  transition: all 0.2s ease;
}

/* 统计区域样式优化 */
.examination-summary h5 {
  border-bottom: 2px solid #007bff;
  padding-bottom: 8px;
  display: inline-block;
  margin-bottom: 25px;
}

.examination-summary .card-body {
  padding: 2rem;
}

/* 检查顺序预览样式 */
.examination-sequence-preview h3 {
  text-shadow: 0 2px 4px rgba(0,123,255,0.1);
}

.sequence-cards-container {
  max-width: 100%;
  margin: 0 auto;
  overflow-x: auto;
}

.sequence-cards-container > div {
  display: flex !important;
  flex-wrap: wrap !important;
  gap: 15px !important;
  justify-content: flex-start !important;
}

.sequence-card {
  background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
  border: 2px solid #007bff;
  border-radius: 12px;
  padding: 15px 20px;
  text-align: center;
  min-width: 140px;
  width: calc(33.333% - 10px); /* 每行最多3个，考虑间距 */
  max-width: 200px;
  box-shadow: 0 4px 12px rgba(0, 123, 255, 0.15);
  transition: all 0.3s ease;
  position: relative;
  flex: 0 0 calc(33.333% - 10px) !important;
  display: inline-block !important;
}

.sequence-card:hover {
  transform: translateY(-3px);
  box-shadow: 0 8px 20px rgba(0, 123, 255, 0.25);
}

.sequence-number {
  background: #007bff;
  color: white;
  width: 30px;
  height: 30px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: bold;
  font-size: 1.1rem;
  margin: 0 auto 10px auto;
}

.sequence-name {
  font-weight: 600;
  color: #2c3e50;
  font-size: 0.9rem;
  line-height: 1.3;
  word-wrap: break-word;
}

/* 响应式调整 */
@media (max-width: 768px) {
  .examination-summary .card-body {
    padding: 1.5rem;
  }
  
  .examination-summary h5 {
    font-size: 1.1rem;
    margin-bottom: 20px;
  }
  
  .examination-sequence-preview h3 {
    font-size: 1.4rem !important;
  }
  
  .sequence-cards-container > div {
    flex-direction: row !important;
    flex-wrap: wrap !important;
    justify-content: flex-start !important;
  }
  
  .sequence-card {
    min-width: 100px;
    width: calc(33.333% - 10px); /* 移动端也保持每行3个 */
    max-width: 130px;
    flex: 0 0 calc(33.333% - 10px) !important;
    margin: 5px 0;
  }
}

/* 临床笔记样式增强 */
.notes-container {
  position: relative;
}

.notes-header {
  border-bottom: 1px solid #e9ecef;
  padding-bottom: 8px;
}

.notes-info {
  display: flex;
  align-items: center;
  gap: 8px;
}

#clinical-notes {
  resize: vertical;
  min-height: 120px;
  border: 2px solid #dee2e6;
  transition: border-color 0.3s ease, box-shadow 0.3s ease;
}

#clinical-notes:focus {
  border-color: #007bff;
  box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
}

/* 笔记保存成功闪烁效果 */
.notes-saved-flash {
  border-color: #28a745 !important;
  box-shadow: 0 0 0 0.2rem rgba(40, 167, 69, 0.25) !important;
  animation: notesSavedPulse 1s ease-in-out;
}

@keyframes notesSavedPulse {
  0% { transform: scale(1); }
  50% { transform: scale(1.02); }
  100% { transform: scale(1); }
}

/* 字数统计样式 */
#notes-char-count {
  font-weight: 500;
  transition: color 0.3s ease;
}

/* 保存状态样式 */
#notes-save-status {
  font-weight: 500;
  transition: opacity 0.3s ease;
}

#notes-save-status i {
  margin-right: 4px;
}

/* 笔记底部提示样式 */
.notes-footer {
  border-top: 1px solid #e9ecef;
  padding-top: 8px;
}

.notes-footer .text-muted {
  font-size: 0.875rem;
}

.notes-footer i {
  color: #007bff;
  margin-right: 6px;
}
</style>
{% endblock %}

{% block extra_js %}
<script>
// 临床推理教学系统 - 重新设计的交互逻辑
// 作为医疗教育工程师，我设计了一个更贴近真实临床思维的学习系统

(function() {
  // ==================== 核心状态管理 ====================
  var clinicalSession = {
    caseId: '{{ clinical_case.case_id }}',
    currentStage: 'history',
    stages: ['history', 'examination', 'diagnosis', 'treatment', 'feedback'],
    
    // 临床数据收集
    selectedExaminations: [],
    examinationResults: [],
    clinicalFindings: {},
    
    // 诊断推理
    diagnosticHypotheses: [],
    selectedDiagnosis: null,
    differentialAnalysis: {},
    
    // 治疗决策
    selectedTreatments: [],
    treatmentRationale: '',
    
    // 学习评估
    scores: {
      examination: 0,
      diagnosis: 0,
      treatment: 0,
      overall: 0,
      clinicalThinking: 0
    },
    
    // 时间跟踪
    timeSpent: {},
    startTime: new Date(),
    
    // 眼底检查字幕控制
    fundusSubtitleDismissed: false,
    
    // 缓存的数据选项
    diagnosisOptions: [],
    treatmentOptions: [],
    
    // 教学反馈
    feedbackHistory: [],
    clinicalMistakes: [],
    learningInsights: []
  };

  // ==================== 医学教育核心功能 ====================
  
  // 紧急修复：确保按钮可用的函数
  function ensureButtonEnabled() {
    var stage = clinicalSession.currentStage;
    console.log('确保按钮可用 - 当前阶段:', stage);
    
    $('#btn-next').prop('disabled', false);
    
    switch(stage) {
      case 'examination':
        $('#btn-next').removeClass('btn-secondary btn-info btn-success').addClass('btn-warning').text('确认检查选择 →');
        break;
      case 'diagnosis':
        $('#btn-next').removeClass('btn-warning btn-secondary btn-success').addClass('btn-info').text('提交诊断选择 →');
        break;
      case 'treatment':
        $('#btn-next').removeClass('btn-warning btn-info btn-secondary').addClass('btn-success').text('提交治疗方案 →');
        break;
    }
    
    console.log('按钮状态已强制启用:', $('#btn-next').prop('disabled'));
  }
  
  // 调试函数
  function debugButtonStatus() {
    console.log('=== 按钮状态调试 ===');
    console.log('按钮是否禁用:', $('#btn-next').prop('disabled'));
    console.log('按钮文本:', $('#btn-next').text());
    console.log('按钮类名:', $('#btn-next').attr('class'));
    console.log('当前阶段:', clinicalSession.currentStage);
    console.log('已选择诊断:', clinicalSession.selectedDiagnosis);
    console.log('====================');
  }
  
  function updateClinicalProgress() {
    // 更新可视化进度指示器
    $('.stepper-item').removeClass('active completed thinking');
    var currentIndex = clinicalSession.stages.indexOf(clinicalSession.currentStage);
    
    for (var i = 0; i <= currentIndex; i++) {
      var $step = $('.stepper-item[data-step="' + clinicalSession.stages[i] + '"]');
      if (i === currentIndex) {
        $step.addClass('active thinking');
        // 添加思考动画效果
        $step.find('.stepper-icon').html('<i class="fas fa-brain fa-pulse"></i>');
      } else {
        $step.addClass('completed');
        $step.find('.stepper-icon').html('<i class="fas fa-check"></i>');
      }
    }
    // 高亮当前步骤一次
    highlightStep(clinicalSession.currentStage);
    
    // 更新阶段提示
    updateStageGuidance();
  }
  
  function updateStageGuidance() {
    var guidance = {
      'history': {
        title: '📋 病史采集阶段',
        instruction: '仔细阅读患者的主诉和病史信息，这是临床推理的基础。思考：患者的主要问题是什么？可能的病因有哪些？',
        tips: ['注意症状的时间顺序', '关注既往史的相关性', '思考症状的严重程度']
      },
      'examination': {
        title: '🔍 临床检查阶段', 
        instruction: '基于病史分析，选择最有价值的检查项目。记住：合理的检查选择体现临床思维能力。',
        tips: ['优先选择性价比高的检查', '避免过度检查', '考虑检查的诊断价值']
      },
      'diagnosis': {
        title: '🎯 诊断推理阶段',
        instruction: '综合病史和检查结果，进行鉴别诊断。思考各种可能性的概率，选择最可能的诊断。',
        tips: ['列出鉴别诊断', '分析支持和反对证据', '考虑疾病的流行病学特点']
      },
      'treatment': {
        title: '💊 治疗决策阶段',
        instruction: '基于确定的诊断，制定合理的治疗方案。考虑治疗的有效性、安全性和成本效益。',
        tips: ['个体化治疗方案', '考虑患者承受能力', '权衡获益和风险']
      },
      'feedback': {
        title: '📚 学习总结阶段',
        instruction: '回顾整个临床推理过程，总结学习要点和改进方向。',
        tips: ['反思决策过程', '巩固关键知识点', '制定学习计划']
      }
    };
    
    var current = guidance[clinicalSession.currentStage];
    if (current) {
      var html = '<div class="clinical-guidance card mb-3">';
      html += '<div class="card-body">';
      html += '<h6 class="card-title text-primary">' + current.title + '</h6>';
      html += '<p class="card-text">' + current.instruction + '</p>';
      html += '<div class="clinical-tips">';
      html += '<small class="text-muted"><strong>临床思维要点：</strong></small>';
      html += '<ul class="small text-muted mb-0">';
      current.tips.forEach(function(tip) {
        html += '<li>' + tip + '</li>';
      });
      html += '</ul>';
      html += '</div>';
      html += '</div>';
      html += '</div>';
      
      $('#clinical-guidance').html(html);
    }
  }

  
  // ==================== 病史阶段：建立临床印象 ====================
  
  function updatePatientInfoInHeader(data) {
    // 更新标题区域的患者信息 - 带标签显示
    var patientInfoHtml = '<div class="text-muted" style="font-size: 0.95rem; font-family: -apple-system, BlinkMacSystemFont, \'Segoe UI\', Roboto, Arial, sans-serif;">';
    
    // 添加基础信息标签，然后是年龄性别、编号、职业
    patientInfoHtml += '<span style="color: #495057; font-weight: 600;">基础信息：</span>';
    patientInfoHtml += '<span style="font-weight: 500;">' + (data.patient_info.age || '未知') + '岁 ' + (data.patient_info.gender || '未知') + '</span>';
    patientInfoHtml += '<span style="margin: 0 12px; color: #6c757d;">•</span>';
    patientInfoHtml += '<span style="font-weight: 500;">编号：' + data.case_id + '</span>';
    
    // 职业（如果有）
    if (data.patient_info.occupation) {
      patientInfoHtml += '<span style="margin: 0 12px; color: #6c757d;">•</span>';
      patientInfoHtml += '<span style="font-weight: 500;">职业：' + data.patient_info.occupation + '</span>';
    }
    
    patientInfoHtml += '</div>';
    
    // 更新DOM
    $('#patient-info').html(patientInfoHtml);
  }
  
  function initializeHistoryStage() {
    clinicalSession.currentStage = 'history';
    updateClinicalProgress();
    
    // 记录开始时间
    clinicalSession.timeSpent.history = new Date();
    
    $('#btn-prev').prop('disabled', true);
    $('#btn-next').text('开始检查选择 →').removeClass('btn-secondary').addClass('btn-primary');
    
    $.getJSON('/api/clinical/case/' + clinicalSession.caseId + '/', function(resp) {
      if (resp.success) {
        window.caseData = resp.data;
        
        // 更新标题区域的患者信息
        updatePatientInfoInHeader(resp.data);
        
        // 渲染病史内容
        renderPatientHistory(resp.data);
        
        // 添加临床思考提示
        showClinicalThinkingPrompt('history');
      } else {
        showErrorMessage('加载病史信息失败: ' + resp.message);
      }
    }).fail(function() {
      showErrorMessage('网络错误，请检查连接后重试');
    });
  }
  
  function renderPatientHistory(data) {
    var html = '<div class="patient-history">';
    
    // 直接开始主诉，患者基本信息已在标题区域显示
    
    // 主诉卡片 - 重新设计
    html += '<div class="card mb-4 shadow-sm border-0">';
    html += '<div class="card-header border-0" style="background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%); border-radius: 12px 12px 0 0;">';
    html += '<div class="d-flex align-items-center justify-content-between">';
    html += '<h5 class="mb-0 text-white d-flex align-items-center" style="font-weight: 600; letter-spacing: 0.5px;">';
    html += '<i class="fas fa-exclamation-circle me-2" style="font-size: 1.2rem;"></i>';
    html += '主诉 <span style="font-size: 0.9rem; font-weight: 400; opacity: 0.8; margin-left: 8px;">Chief Complaint</span>';
    html += '</h5>';
    html += '</div>';
    html += '</div>';
    html += '<div class="card-body" style="padding: 1.5rem; background: #fff8f0;">';
    html += '<div class="chief-complaint-content">';
    html += '<blockquote class="blockquote text-center mb-0">';
    html += '<p class="mb-0" style="font-size: 1.1rem; color: #2c3e50; font-weight: 500; line-height: 1.6; font-style: italic;">"' + (data.clinical_info.chief_complaint || '无记录') + '"</p>';
    html += '</blockquote>';
    html += '</div>';
    html += '</div>';
    html += '</div>';
    
    // 现病史卡片 - 重新设计
    html += '<div class="card mb-4 shadow-sm border-0">';
    html += '<div class="card-header border-0" style="background: linear-gradient(135deg, #2980b9 0%, #3498db 100%); border-radius: 12px 12px 0 0;">';
    html += '<div class="d-flex align-items-center justify-content-between">';
    html += '<h5 class="mb-0 text-white d-flex align-items-center" style="font-weight: 600; letter-spacing: 0.5px;">';
    html += '<i class="fas fa-clipboard-list me-2" style="font-size: 1.2rem;"></i>';
    html += '现病史 <span style="font-size: 0.9rem; font-weight: 400; opacity: 0.8; margin-left: 8px;">History of Present Illness</span>';
    html += '</h5>';
    html += '</div>';
    html += '</div>';
    html += '<div class="card-body" style="padding: 1.5rem; background: #f0f8ff;">';
    html += '<div class="present-illness-content" style="line-height: 1.8; font-size: 1rem; color: #2c3e50;">';
    
    var presentIllness = data.clinical_info.present_illness || data.clinical_info.history_of_present_illness || '无记录';
    
    html += '<div class="illness-timeline">';
    html += formatMedicalHistory(presentIllness);
    html += '</div>';
    
    html += '</div>';
    html += '</div>';
    html += '</div>';
    
    // 既往史、个人史、家族史 - 按标准医学病史格式排列
    html += '<div class="medical-history-sections">';
    
    // 既往史
    if (data.clinical_info.past_history || data.clinical_info.past_medical_history) {
      html += '<div class="card mb-4 shadow-sm border-0">';
      html += '<div class="card-header border-0" style="background: linear-gradient(135deg, #27ae60 0%, #2ecc71 100%); border-radius: 12px 12px 0 0;">';
      html += '<div class="d-flex align-items-center justify-content-between">';
      html += '<h5 class="mb-0 text-white d-flex align-items-center" style="font-weight: 600; letter-spacing: 0.5px;">';
      html += '<i class="fas fa-history me-2" style="font-size: 1.2rem;"></i>';
      html += '既往史 <span style="font-size: 0.9rem; font-weight: 400; opacity: 0.8; margin-left: 8px;">Past Medical History</span>';
      html += '</h5>';
      html += '</div>';
      html += '</div>';
      html += '<div class="card-body" style="padding: 1.5rem; background: #f8fff8;">';
      var pastHistory = data.clinical_info.past_history || data.clinical_info.past_medical_history || '无特殊既往史';
      html += '<p class="mb-0" style="line-height: 1.6; color: #2c3e50; font-size: 1rem;">' + formatMedicalHistory(pastHistory) + '</p>';
      html += '</div>';
      html += '</div>';
    }
    
    // 个人史
    if (data.clinical_info.personal_history || data.clinical_info.social_history) {
      html += '<div class="card mb-4 shadow-sm border-0">';
      html += '<div class="card-header border-0" style="background: linear-gradient(135deg, #8e44ad 0%, #9b59b6 100%); border-radius: 12px 12px 0 0;">';
      html += '<div class="d-flex align-items-center justify-content-between">';
      html += '<h5 class="mb-0 text-white d-flex align-items-center" style="font-weight: 600; letter-spacing: 0.5px;">';
      html += '<i class="fas fa-user-cog me-2" style="font-size: 1.2rem;"></i>';
      html += '个人史 <span style="font-size: 0.9rem; font-weight: 400; opacity: 0.8; margin-left: 8px;">Personal & Social History</span>';
      html += '</h5>';
      html += '</div>';
      html += '</div>';
      html += '<div class="card-body" style="padding: 1.5rem; background: #faf8ff;">';
      var personalHistory = data.clinical_info.personal_history || data.clinical_info.social_history || '无特殊个人史记录';
      html += '<p class="mb-0" style="line-height: 1.6; color: #2c3e50; font-size: 1rem;">' + formatMedicalHistory(personalHistory) + '</p>';
      html += '</div>';
      html += '</div>';
    }
    
    // 家族史
    if (data.clinical_info.family_history) {
      html += '<div class="card mb-4 shadow-sm border-0">';
      html += '<div class="card-header border-0" style="background: linear-gradient(135deg, #e67e22 0%, #f39c12 100%); border-radius: 12px 12px 0 0;">';
      html += '<div class="d-flex align-items-center justify-content-between">';
      html += '<h5 class="mb-0 text-white d-flex align-items-center" style="font-weight: 600; letter-spacing: 0.5px;">';
      html += '<i class="fas fa-users me-2" style="font-size: 1.2rem;"></i>';
      html += '家族史 <span style="font-size: 0.9rem; font-weight: 400; opacity: 0.8; margin-left: 8px;">Family History</span>';
      html += '</h5>';
      html += '</div>';
      html += '</div>';
      html += '<div class="card-body" style="padding: 1.5rem; background: #fffaf0;">';
      html += '<p class="mb-0" style="line-height: 1.6; color: #2c3e50; font-size: 1rem;">' + formatMedicalHistory(data.clinical_info.family_history) + '</p>';
      html += '</div>';
      html += '</div>';
    }
    
    html += '</div>';
    
    html += '</div>';
    $('#stage-content').html(html);
  }
  
  function formatMedicalHistory(text) {
    // 格式化病史文本，突出关键信息并改善可读性
    var formatted = text
      // 时间标记
      .replace(/(\d+[天月年周])/g, '<span class="time-marker" style="background: linear-gradient(135deg, #3498db, #2980b9); color: white; padding: 2px 8px; border-radius: 12px; font-size: 0.85rem; font-weight: 500; margin: 0 2px;">$1</span>')
      // 症状关键词
      .replace(/(疼痛|不适|模糊|下降|出血|红肿|瘙痒|干涩|流泪|畏光|复视|黑影|闪光)/g, '<span class="symptom-highlight" style="background: #ffe6e6; color: #c0392b; padding: 1px 4px; border-radius: 4px; font-weight: 600; border-left: 3px solid #e74c3c;">$1</span>')
      // 否定词汇
      .replace(/(无|否认|未见|正常|阴性)/g, '<span class="negative-finding" style="background: #e8f5e8; color: #27ae60; padding: 1px 4px; border-radius: 4px; font-weight: 500;">$1</span>')
      // 程度词汇
      .replace(/(轻度|中度|重度|严重|明显|显著)/g, '<span class="severity-marker" style="background: #fff3cd; color: #856404; padding: 1px 4px; border-radius: 4px; font-weight: 500;">$1</span>');
    
    // 将文本分段并添加适当的间距
    return '<div class="formatted-history">' + formatted.replace(/。/g, '。<br style="margin-bottom: 8px;">') + '</div>';
  }
  

  


  
  // ==================== 检查阶段：循证医学指导 ====================
  
  function loadExaminationStage() {
    clinicalSession.currentStage = 'examination';
    updateClinicalProgress();
    updateStageProgress();
    
    $('#btn-prev').prop('disabled', false);
    $('#btn-next').prop('disabled', false).text('确认检查选择 →').removeClass('btn-secondary').addClass('btn-warning');
    updateStageCard('检查选择阶段', 'examination');
    
    $.getJSON('/api/clinical/case/' + clinicalSession.caseId + '/examinations/', function(resp) {
      if (resp.success) {
        // 存储检查选项统计信息
        clinicalSession.examinationStats = {
          totalCount: resp.data.total_count || 0,
          requiredCount: resp.data.required_count || 0,
          distractorCount: resp.data.distractor_count || 0,
          mode: resp.data.mode || 'standard'
        };
        
        renderExaminationOptions(resp.data.examination_options || []);
        addExaminationGuidance();
        showClinicalThinkingPrompt('examination');
        
        // 显示检查选项统计信息
        showExaminationStats();
        
        // 初始化检查选择顺序数组
        clinicalSession.examinationOrder = [];
        clinicalSession.isExaminationConfirmed = false;
        clinicalSession.currentExaminationIndex = 0;
        
        console.log('检查选项加载成功:', clinicalSession.examinationStats);
      } else {
        showErrorMessage('加载检查选项失败: ' + resp.message);
      }
    }).fail(function() {
      showErrorMessage('网络错误，请检查连接后重试');
    });
  }
  
  function clearExaminationErrors() {
    /**
     * 清除检查选择的错误状态和高亮
     */
    // 清除错误高亮
    $('.examination-option').removeClass('error-missing error-extra');
    
    // 清除反馈面板中的错误信息
    const feedbackPanel = $('#feedback-panel');
    if (feedbackPanel.find('.examination-validation-error').length > 0) {
      feedbackPanel.html('<div class="alert alert-secondary"><i class="fas fa-info-circle me-2"></i>等待检查选择...</div>');
    }
  }
  
  function renderExaminationOptions(options) {
    // 清除之前的错误状态
    clearExaminationErrors();
    
    var html = '<div class="examination-selection">';
    
    // 检查选择说明
    html += '<div class="alert alert-info" style="background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%); border: none; border-radius: 12px; padding: 20px; margin-bottom: 15px;">';
    html += '<h4 class="mb-3" style="color: #1565c0; font-weight: 700; display: flex; align-items: center;">';
    html += '<i class="fas fa-lightbulb me-2" style="font-size: 1.2rem; color: #ffa726;"></i>检查选择指导';
    html += '</h4>';
    html += '<p class="mb-2" style="font-size: 1rem; line-height: 1.6; color: #424242;">请选择您认为有助于诊断的检查项目，然后安排检查顺序。</p>';
    html += '<p class="mb-0" style="font-size: 0.9rem; line-height: 1.6; color: #424242;"><strong>提示：</strong>选择检查项目后，可以拖拽调整检查顺序，系统将按顺序逐一展示检查结果。</p>';
    html += '</div>';
    
    // 检查选项统计信息（仅在混合模式下显示）
    if (clinicalSession.examinationStats && clinicalSession.examinationStats.mode === 'mixed') {
      html += '<div id="examination-stats" class="alert alert-secondary" style="background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); border: none; border-radius: 10px; padding: 15px; margin-bottom: 15px;">';
      html += '<div class="d-flex align-items-center justify-content-center">';
      html += '<i class="fas fa-info-circle me-2" style="color: #6c757d; font-size: 1.1rem;"></i>';
      html += '<span style="font-size: 0.95rem; color: #495057; font-weight: 500;">本次共提供 <strong>' + clinicalSession.examinationStats.totalCount + '</strong> 项检查选择，包含教学重点和辅助选项</span>';
      html += '</div>';
      html += '</div>';
    }
    



    
    // 按类型分组显示检查选项
    var groupedOptions = groupExaminationsByType(options);
    
    Object.keys(groupedOptions).forEach(function(type) {
      var typeOptions = groupedOptions[type];
      var typeDisplayName = getExaminationTypeDisplay(type);
      var typeIcon = getExaminationTypeIcon(type);
      
      html += '<div class="examination-group mb-4">';
      html += '<h4 class="text-primary mb-3" style="font-weight: 700; display: flex; align-items: center;">';
      html += '<i class="' + typeIcon + ' me-2" style="font-size: 1.3rem;"></i>' + typeDisplayName;
      html += '<span class="text-muted ms-2" style="font-size: 1rem; font-weight: 500;">(' + typeOptions.length + '项)</span>';
      html += '</h4>';
      
      html += '<div class="row">';
      typeOptions.forEach(function(option) {
        var imagesAttr = (option.images && option.images.length) ? JSON.stringify(option.images) : '[]';
        var isRequiredAttr = option.is_required ? 1 : 0;
        var allowMultipleAttr = option.is_multiple_choice ? 1 : 0;
        html += '<div class="col-md-6 mb-3">';
        var cardClass = 'card examination-option h-100';
        html += '<div class="' + cardClass + '" data-exam-id="' + option.id + '" data-images=\'' + imagesAttr + '\' data-is-required="' + isRequiredAttr + '" data-allow-multiple="' + allowMultipleAttr + '">';
        html += '<div class="card-body">';
        
        html += '<div class="form-check">';
        html += '<div class="d-flex align-items-center mb-2">';
        html += '<input class="form-check-input examination-checkbox me-3" type="checkbox" ';
        html += 'value="' + option.id + '" id="exam_' + option.id + '" data-is-recommended="' + (option.is_recommended ? '1' : '0') + '" data-is-fundus="' + ((option.type && option.type.toLowerCase().indexOf('眼底') !== -1) ? '1' : '0') + '" data-is-required="' + isRequiredAttr + '" data-allow-multiple="' + allowMultipleAttr + '" style="width: 18px; height: 18px; flex-shrink: 0;">';
        html += '<label class="form-check-label flex-grow-1 mb-0" for="exam_' + option.id + '">';
        html += '<strong style="font-size: 1.1rem; color: #2c3e50;">' + option.name + '</strong>';
        html += '</label>';
        html += '</div>';
        
        // 移除检查特性标签，避免给学生隐性提示
        // html += '<div class="examination-badges d-flex gap-1">';
        // if (option.is_recommended) {
        //   html += '<span class="badge bg-success text-white" style="font-size: 0.8rem;">推荐</span>';
        // }
        // if (option.diagnostic_value && option.diagnostic_value.toLowerCase().indexOf('高') !== -1) {
        //   html += '<span class="badge bg-warning text-dark" style="font-size: 0.8rem;"><i class="fas fa-star me-1"></i>高价值</span>';
        // }
        // html += '</div>';
        
        html += '<div class="text-muted small mt-2 ms-0">' + (option.description || '') + '</div>';
        
        // 显示风险和成本信息
        html += '<div class="examination-info mt-2 ms-0">';
        html += '<div class="row small text-muted">';
        html += '<div class="col-6">风险: ' + (option.risk_level || '低') + '</div>';
        html += '<div class="col-6">费用: ¥' + (option.cost || 50) + '</div>';
        html += '</div>';
        html += '</div>';
        
        html += '</div>';
        html += '</div>';
        html += '</div>';
        html += '</div>';
      });
      html += '</div>';
      html += '</div>';
    });
    
    // 检查顺序安排区域
    html += '<div class="examination-order-section mt-4" id="examination-order-section" style="display: none;">';
    html += '<h5 class="mb-3" style="background: linear-gradient(135deg, #1976d2, #42a5f5); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; font-weight: bold; font-size: 1.3rem;"><i class="fas fa-sort" style="color: #1976d2; margin-right: 8px;"></i> 安排检查顺序</h5>';
    html += '<div class="alert alert-info" style="background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%); border: 2px solid #2196f3; border-radius: 10px;">';
    html += '<i class="fas fa-hand-rock" style="color: #1976d2; margin-right: 8px;"></i> <strong>请拖拽下方的检查项目调整检查顺序</strong>，系统将按顺序逐一展示检查结果。';
    html += '<br><small class="text-muted mt-1 d-block"><i class="fas fa-lightbulb"></i> 提示：抓住 <i class="fas fa-grip-vertical" style="color: #1976d2;"></i> 图标拖动项目来改变顺序</small>';
    html += '</div>';
    html += '<div id="examination-order-list" class="examination-order-list">';
    html += '<!-- 检查项目排序区域 -->';
    html += '</div>';
    html += '</div>';
    
    html += '</div>';
    
    // 添加选择统计 - 改进布局
    html += '<div class="examination-summary mt-4">';
    html += '<div class="card bg-light">';
    html += '<div class="card-body text-center">';
    
    // 标题独立一行
    html += '<h5 class="mb-4" style="color: #2c3e50; font-weight: 600;">';
    html += '<i class="fas fa-calculator me-2"></i>选择统计';
    html += '</h5>';
    
    // 统计项目：使用inline-block确保水平布局
    html += '<div style="text-align: center;">';
    
    // 标签行
    html += '<div style="margin-bottom: 10px;">';
    html += '<span style="display: inline-block; width: 120px; text-align: center; font-size: 0.9rem; font-weight: 500;" class="text-muted">已选检查</span>';
    html += '<span style="display: inline-block; width: 40px;"></span>'; // 间距
    html += '<span style="display: inline-block; width: 120px; text-align: center; font-size: 0.9rem; font-weight: 500;" class="text-muted">总费用</span>';
    html += '</div>';
    
    // 数值行
    html += '<div>';
    html += '<span style="display: inline-block; width: 120px; text-align: center;" class="h3 mb-0 text-primary fw-bold" id="selected-count">0</span>';
    html += '<span style="display: inline-block; width: 40px;"></span>'; // 间距
    html += '<span style="display: inline-block; width: 120px; text-align: center;" class="h3 mb-0 text-success fw-bold" id="total-cost">¥0</span>';
    html += '</div>';
    
    html += '</div>';
    html += '</div>';
    html += '</div>';
    html += '</div>';
    
    $('#stage-content').html(html);
    
    // 绑定检查选择事件
    bindExaminationEvents();
    
    // 初始化拖拽排序功能
    initializeExaminationOrderSorting();
    
    // 确保按钮状态正确 - 检查阶段按钮应始终可用
    setTimeout(function() {
      ensureButtonEnabled();
    }, 100);
  }
  
  function groupExaminationsByType(options) {
    var grouped = {};
    options.forEach(function(option) {
      var type = option.examination_type || 'basic';
      if (!grouped[type]) {
        grouped[type] = [];
      }
      grouped[type].push(option);
    });
    return grouped;
  }
  
  function getExaminationTypeDisplay(type) {
    var displays = {
      'basic': '基础检查',
      'imaging': '影像学检查', 
      'laboratory': '实验室检查',
      'special': '特殊检查'
    };
    return displays[type] || type;
  }
  
  function getExaminationTypeIcon(type) {
    var icons = {
      'basic': 'fas fa-stethoscope',
      'imaging': 'fas fa-x-ray',
      'laboratory': 'fas fa-flask',
      'special': 'fas fa-microscope'
    };
    return icons[type] || 'fas fa-medical-kit';
  }
  
  function getRiskLevelDisplay(level) {
    var displays = {
      'low': '<span class="text-success">低</span>',
      'medium': '<span class="text-warning">中</span>',
      'high': '<span class="text-danger">高</span>'
    };
    return displays[level] || level;
  }
  
  function bindExaminationEvents() {
    $('.examination-checkbox').off('change').on('change', function() {
      var $card = $(this).closest('.examination-option');
      var examId = parseInt($(this).val());
      var isChecked = $(this).is(':checked');
      var isFundus = $(this).data('is-fundus') == 1;

      if (isChecked) {
        $card.addClass('selected');
        if (clinicalSession.selectedExaminations.indexOf(examId) === -1) {
          clinicalSession.selectedExaminations.push(examId);
        }
        addToLearningTimeline('选择检查', $card.find('strong').text());
      } else {
        $card.removeClass('selected');
        var index = clinicalSession.selectedExaminations.indexOf(examId);
        if (index > -1) {
          clinicalSession.selectedExaminations.splice(index, 1);
        }
      }

      updateExaminationSummary();
      updateExaminationOrderList();
      provideLiveExaminationFeedback();
    });
    
    $('.examination-option').on('click', function(e) {
      if (e.target.type !== 'checkbox') {
        var checkbox = $(this).find('.examination-checkbox');
        checkbox.prop('checked', !checkbox.prop('checked')).trigger('change');
      }
    });
  }
  
  function updateExaminationOrderList() {
    var $orderSection = $('#examination-order-section');
    var $orderList = $('#examination-order-list');
    
    if (clinicalSession.selectedExaminations.length === 0) {
      $orderSection.hide();
      return;
    }
    
    $orderSection.show();
    
    var html = '';
    clinicalSession.selectedExaminations.forEach(function(examId, index) {
      var $examCard = $('.examination-option[data-exam-id="' + examId + '"]');
      var examName = $examCard.find('strong').text();
      var isRequired = $examCard.data('is-required');
      
      html += '<div class="examination-order-item" data-exam-id="' + examId + '" draggable="true">';
      html += '<div class="d-flex align-items-center justify-content-between p-3 mb-2 border rounded position-relative">';
      html += '<div class="d-flex align-items-center">';
      html += '<i class="fas fa-grip-vertical me-3" style="cursor: grab;" title="拖拽调整顺序"></i>';
      html += '<span class="order-number badge me-3" style="background: linear-gradient(135deg, #1976d2, #42a5f5); color: white; font-size: 0.9rem; padding: 8px 12px; border-radius: 50%; min-width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; box-shadow: 0 2px 8px rgba(25, 118, 210, 0.3);">' + (index + 1) + '</span>';
      html += '<div class="exam-info">';
      html += '<span class="exam-name fw-bold d-block" style="color: #0d47a1; font-size: 1rem;">' + examName + '</span>';
      html += '<small class="text-muted"><i class="fas fa-hand-rock"></i> 可拖拽排序</small>';
      html += '</div>';

      html += '</div>';
      html += '<button class="btn btn-sm btn-outline-danger remove-exam-btn" data-exam-id="' + examId + '" title="移除此项检查">';
      html += '<i class="fas fa-times"></i>';
      html += '</button>';
      html += '</div>';
      html += '</div>';
    });
    
    // 如果没有选中任何项目，显示空提示
    if (clinicalSession.selectedExaminations.length === 0) {
      html += '<div class="empty-drag-area text-center py-4" style="background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); border: 2px dashed #ced4da; border-radius: 10px; color: #6c757d;">';
      html += '<i class="fas fa-mouse-pointer fa-2x mb-2" style="color: #adb5bd;"></i>';
      html += '<p class="mb-0">选中的检查项目将在这里显示，可拖拽排序</p>';
      html += '<small class="text-muted">请先从上方选择检查项目</small>';
      html += '</div>';
    }
    
    $orderList.html(html);
    
    // 绑定移除按钮事件
    $('.remove-exam-btn').on('click', function() {
      var examId = parseInt($(this).data('exam-id'));
      var $checkbox = $('.examination-checkbox[value="' + examId + '"]');
      $checkbox.prop('checked', false).trigger('change');
    });
    
    // 重新初始化拖拽排序
    initializeExaminationOrderSorting();
  }
  
  function initializeExaminationOrderSorting() {
    var $orderList = $('#examination-order-list');
    
    if (!$orderList.length) return;
    
    // 简单的拖拽排序实现（不依赖外部库）
    var draggedItem = null;
    
    $orderList.off('dragstart dragover drop dragend');
    
    $orderList.on('dragstart', '.examination-order-item', function(e) {
      draggedItem = this;
      $(this).addClass('dragging');
      $('.examination-order-item').not(this).addClass('drop-target');
      $('#examination-order-list').addClass('drag-active');
      e.originalEvent.dataTransfer.effectAllowed = 'move';
    });
    
    $orderList.on('dragover', '.examination-order-item', function(e) {
      e.preventDefault();
      e.originalEvent.dataTransfer.dropEffect = 'move';
      
      var $this = $(this);
      $('.examination-order-item').removeClass('drag-hover');
      
      if (this !== draggedItem) {
        $this.addClass('drag-hover');
        var draggedRect = draggedItem.getBoundingClientRect();
        var targetRect = this.getBoundingClientRect();
        
        if (e.originalEvent.clientY < targetRect.top + targetRect.height / 2) {
          $this.before(draggedItem);
        } else {
          $this.after(draggedItem);
        }
      }
    });
    
    $orderList.on('dragleave', '.examination-order-item', function(e) {
      $(this).removeClass('drag-hover');
    });
    
    $orderList.on('dragend', '.examination-order-item', function(e) {
      $(this).removeClass('dragging');
      $('.examination-order-item').removeClass('drop-target drag-hover');
      $('#examination-order-list').removeClass('drag-active');
      draggedItem = null;
      
      // 更新检查顺序
      updateExaminationOrder();
    });
    
    $orderList.on('drop', function(e) {
      e.preventDefault();
    });
  }
  
  function updateExaminationOrder() {
    var newOrder = [];
    $('#examination-order-list .examination-order-item').each(function(index) {
      var examId = parseInt($(this).data('exam-id'));
      newOrder.push(examId);
      
      // 更新顺序号显示
      $(this).find('.order-number').text(index + 1);
    });
    
    clinicalSession.selectedExaminations = newOrder;
    clinicalSession.examinationOrder = newOrder;
  }

  function confirmExaminationSelection() {
    // 基础验证：确保至少选择了一项检查
    if (clinicalSession.selectedExaminations.length === 0) {
      showFeedbackMessage('请至少选择一项检查', 'warning');
      return;
    }
    
    // 清除之前的错误状态
    clearExaminationErrors();

    // 显示确认中状态
    $('#btn-next').prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i> 确认中...');
    showFeedbackMessage('正在确认检查选择...', 'info');

    // 准备提交数据
    var submitData = {
      case_id: clinicalSession.caseId,
      selected_examinations: clinicalSession.selectedExaminations,
      examination_order: clinicalSession.examinationOrder || clinicalSession.selectedExaminations
    };

    $.ajax({
      url: '/api/clinical/confirm-examination-selection/',
      method: 'POST',
      contentType: 'application/json',
      headers: {
        'X-CSRFToken': $('[name=csrfmiddlewaretoken]').val() || getCsrfToken()
      },
      data: JSON.stringify(submitData),
      success: function(resp) {
        if (resp.success) {
          // 标记检查已确认
          clinicalSession.isExaminationConfirmed = true;
          clinicalSession.examinationOrder = resp.data.examination_order;
          clinicalSession.currentExaminationIndex = 0;
          
          // 更新按钮状态
          $('#btn-next').prop('disabled', false).html('查看检查结果 <i class="fas fa-arrow-right"></i>');
          
          // 显示确认成功界面
          showExaminationConfirmedInterface();
          
          // 显示成功消息，包含尝试次数信息
          var successMessage = resp.data.message || resp.message;
          
          // 不再在成功消息中显示扣分信息，因为容易造成误解
          // 扣分信息应该只在错误时显示，成功时只显示鼓励信息
          
          showFeedbackMessage(successMessage, 'success');
          
          // 记录到时间线
          addToLearningTimeline('确认检查选择', '共选择 ' + clinicalSession.selectedExaminations.length + ' 项检查');
        } else {
          $('#btn-next').prop('disabled', false).html('确认检查选择 →');
          showFeedbackMessage('确认失败: ' + resp.message, 'danger');
        }
      },
      error: function(xhr, status, error) {
        $('#btn-next').prop('disabled', false).html('确认检查选择 →');
        
        // 处理验证错误（400状态码）
        if (xhr.status === 400) {
          try {
            var errorResp = JSON.parse(xhr.responseText);
            if (errorResp.error_details) {
              showExaminationValidationError(errorResp);
            } else {
              showFeedbackMessage('验证失败: ' + errorResp.message, 'warning');
            }
          } catch (e) {
            showFeedbackMessage('请求失败，请重试', 'danger');
          }
        } else {
          console.error('Confirm examination error:', error, xhr.responseText);
          showFeedbackMessage('网络错误，请检查连接: ' + error, 'danger');
        }
      }
    });
  }
  
  function showExaminationValidationError(errorResponse) {
    var details = errorResponse.error_details;
    var message = errorResponse.message;
    
    // 创建详细的错误提示界面
    var html = '<div class="examination-validation-error">';
    
    // 主要错误提示
    html += '<div class="alert alert-danger" style="background: linear-gradient(135deg, #f8d7da 0%, #f5c6cb 100%); border: none; border-radius: 12px; padding: 20px; margin-bottom: 20px;">';
    html += '<h4 class="mb-3" style="color: #721c24; font-weight: 700; display: flex; align-items: center;">';
    html += '<i class="fas fa-exclamation-triangle me-2" style="font-size: 1.2rem; color: #dc3545;"></i>检查选择验证失败';
    html += '</h4>';
    html += '<p class="mb-2" style="font-size: 1rem; line-height: 1.6; color: #721c24;">' + message + '</p>';
    
    // 显示尝试次数和惩罚信息
    if (details.attempt_count) {
      html += '<div class="mt-3 p-3" style="background: rgba(220, 53, 69, 0.1); border-radius: 8px;">';
      html += '<small class="text-danger"><strong>第 ' + details.attempt_count + ' 次尝试失败</strong></small>';
      if (details.penalty_applied > 0) {
        html += '<br><small class="text-danger">本次错误将扣除 ' + details.penalty_applied + ' 分</small>';
      }
      html += '</div>';
    }
    html += '</div>';
    
    // 错误详情卡片
    if (details.missing_required && details.missing_required.length > 0) {
      html += '<div class="card mb-3" style="border: 2px solid #dc3545; border-radius: 10px;">';
      html += '<div class="card-header bg-danger text-white" style="border-radius: 8px 8px 0 0;">';
      html += '<h6 class="mb-0"><i class="fas fa-times-circle me-2"></i>缺少必选检查项目</h6>';
      html += '</div>';
      html += '<div class="card-body">';
      html += '<p class="text-danger mb-2">以下检查项目是必须选择的，请重新选择：</p>';
      html += '<div class="missing-required-list">';
      // 这里需要通过检查选项列表来显示缺少的项目名称
      details.missing_required.forEach(function(examId) {
        // 从当前页面的检查选项中找到对应名称
        var examElement = $('.examination-option[data-exam-id="' + examId + '"]');
        if (examElement.length > 0) {
          var examName = examElement.find('.form-check-label strong').text();
          html += '<div class="alert alert-warning py-2 mb-2">';
          html += '<i class="fas fa-star text-warning me-2"></i>' + examName;
          html += '</div>';
        }
      });
      html += '</div>';
      html += '</div>';
      html += '</div>';
    }
    
    if (details.extra_selected && details.extra_selected.length > 0) {
      html += '<div class="card mb-3" style="border: 2px solid #fd7e14; border-radius: 10px;">';
      html += '<div class="card-header bg-warning text-dark" style="border-radius: 8px 8px 0 0;">';
      html += '<h6 class="mb-0"><i class="fas fa-exclamation-circle me-2"></i>不应选择的检查项目</h6>';
      html += '</div>';
      html += '<div class="card-body">';
      html += '<p class="text-warning mb-2">以下检查项目不是必选的，请取消选择：</p>';
      html += '<div class="extra-selected-list">';
      details.extra_selected.forEach(function(examId) {
        var examElement = $('.examination-option[data-exam-id="' + examId + '"]');
        if (examElement.length > 0) {
          var examName = examElement.find('.form-check-label strong').text();
          html += '<div class="alert alert-info py-2 mb-2">';
          html += '<i class="fas fa-info-circle text-info me-2"></i>' + examName;
          html += '</div>';
        }
      });
      html += '</div>';
      html += '</div>';
      html += '</div>';
    }
    
    // 重新选择指导
    html += '<div class="card" style="border: 2px solid #17a2b8; border-radius: 10px;">';
    html += '<div class="card-header bg-info text-white" style="border-radius: 8px 8px 0 0;">';
    html += '<h6 class="mb-0"><i class="fas fa-lightbulb me-2"></i>重新选择指导</h6>';
    html += '</div>';
    html += '<div class="card-body">';
    html += '<ol class="mb-0">';
    html += '<li>仔细阅读病例描述，理解患者的症状和体征</li>';
    html += '<li>选择所有<strong>必选的检查项目</strong>（通常是诊断最关键的检查）</li>';
    html += '<li>不要选择额外的非必选项目</li>';
    html += '<li>确认选择后，点击"确认检查选择"按钮</li>';
    html += '</ol>';
    html += '</div>';
    html += '</div>';
    
    html += '</div>';
    
    // 更新主要内容区域
    $('#main-content').html(html);
    
    // 高亮显示相关的检查选项
    if (details.missing_required) {
      details.missing_required.forEach(function(examId) {
        $('.examination-option[data-exam-id="' + examId + '"]').addClass('border-danger').css('animation', 'pulse 1s infinite');
      });
    }
    
    if (details.extra_selected) {
      details.extra_selected.forEach(function(examId) {
        $('.examination-option[data-exam-id="' + examId + '"]').addClass('border-warning');
      });
    }
    
    // 滚动到顶部
    $('html, body').animate({ scrollTop: 0 }, 300);
  }
  
  function showExaminationValidationError(errorResponse) {
    /**
     * 显示检查选择验证错误的详细信息
     */
    const details = errorResponse.error_details || {};
    const message = errorResponse.message || '选择验证失败';
    
    // 构建详细的错误提示
    let errorHtml = '<div class="examination-validation-error">';
    
    // 主要错误信息
    errorHtml += '<div class="alert alert-danger validation-error-alert" style="background: linear-gradient(135deg, #f8d7da 0%, #f1b0b7 100%); border: none; border-radius: 10px; margin-bottom: 15px; animation: shakeError 0.6s ease-in-out;">';
    errorHtml += '<div class="d-flex align-items-center mb-3">';
    errorHtml += '<i class="fas fa-exclamation-triangle text-danger me-3" style="font-size: 1.5rem;"></i>';
    errorHtml += '<div>';
    errorHtml += `<h6 class="mb-1 text-danger font-weight-bold">第${details.attempt_count || 1}次尝试失败</h6>`;
    errorHtml += `<p class="mb-0 text-danger">${message}</p>`;
    errorHtml += '</div>';
    errorHtml += '</div>';
    
    // 详细错误分析
    if (details.missing_required && details.missing_required.length > 0) {
      errorHtml += '<div class="error-section mb-3">';
      errorHtml += '<h6 class="text-danger mb-2"><i class="fas fa-minus-circle me-2"></i>缺少必选检查项：</h6>';
      errorHtml += '<ul class="text-danger mb-0">';
      details.missing_required.forEach(function(examId) {
        const examName = getExaminationNameById(examId);
        errorHtml += `<li>${examName || '检查项目ID: ' + examId}</li>`;
      });
      errorHtml += '</ul>';
      errorHtml += '</div>';
    }
    
    if (details.extra_selected && details.extra_selected.length > 0) {
      errorHtml += '<div class="error-section mb-3">';
      errorHtml += '<h6 class="text-warning mb-2"><i class="fas fa-plus-circle me-2"></i>不应选择的检查项：</h6>';
      errorHtml += '<ul class="text-warning mb-0">';
      details.extra_selected.forEach(function(examId) {
        const examName = getExaminationNameById(examId);
        errorHtml += `<li>${examName || '检查项目ID: ' + examId}</li>`;
      });
      errorHtml += '</ul>';
      errorHtml += '</div>';
    }
    
    // 惩罚信息
    if (details.penalty_applied && details.penalty_applied > 0) {
      errorHtml += '<div class="penalty-info alert alert-warning" style="background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%); border: none; border-radius: 8px; padding: 12px;">';
      errorHtml += `<i class="fas fa-exclamation-triangle me-2"></i>本次错误将扣除 <strong>${details.penalty_applied}分</strong>`;
      errorHtml += '</div>';
    }
    
    // 操作提示
    errorHtml += '<div class="action-hint alert alert-info" style="background: linear-gradient(135deg, #d1ecf1 0%, #bee5eb 100%); border: none; border-radius: 8px; padding: 12px;">';
    errorHtml += '<i class="fas fa-lightbulb me-2"></i>';
    if (details.attempt_count === 1) {
      errorHtml += '请仔细阅读案例信息，重新选择必要的检查项目。';
    } else if (details.attempt_count === 2) {
      errorHtml += '这是您第二次尝试，请更加仔细地分析案例需求。';
    } else {
      errorHtml += '多次尝试失败，建议重新阅读案例详情和检查项目描述。';
    }
    errorHtml += '</div>';
    
    errorHtml += '</div>';
    
    // 显示错误信息到反馈面板
    $('#feedback-panel').html(errorHtml);
    
    // 高亮显示错误的检查项
    highlightErrorExaminations(details);
    
    // 滚动到反馈面板
    $('#feedback-panel')[0].scrollIntoView({ behavior: 'smooth' });
    
    // 记录错误到时间线
    addToLearningTimeline(
      `检查选择错误 (第${details.attempt_count}次)`, 
      `惩罚: -${details.penalty_applied || 0}分`
    );
  }
  
  function getExaminationNameById(examId) {
    /**
     * 根据检查项目ID获取名称
     */
    const examCheckbox = $(`input[value="${examId}"]`);
    if (examCheckbox.length > 0) {
      return examCheckbox.closest('.examination-option').find('strong').first().text();
    }
    return null;
  }
  
  function highlightErrorExaminations(errorDetails) {
    /**
     * 高亮显示错误的检查项目
     */
    // 清除之前的高亮
    $('.examination-option').removeClass('error-missing error-extra');
    
    // 高亮缺少的必选项
    if (errorDetails.missing_required) {
      errorDetails.missing_required.forEach(function(examId) {
        $(`.examination-option[data-exam-id="${examId}"]`).addClass('error-missing');
      });
    }
    
    // 高亮多选的项目
    if (errorDetails.extra_selected) {
      errorDetails.extra_selected.forEach(function(examId) {
        $(`.examination-option[data-exam-id="${examId}"]`).addClass('error-extra');
      });
    }
  }
  
  function showExaminationConfirmedInterface() {
    var html = '<div class="examination-confirmed">';
    
    // 确认状态提示
    html += '<div class="alert alert-success" style="background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%); border: none; border-radius: 12px; padding: 20px;">';
    html += '<h4 class="mb-3" style="color: #155724; font-weight: 700; display: flex; align-items: center;">';
    html += '<i class="fas fa-check-circle me-2" style="font-size: 1.2rem; color: #28a745;"></i>检查选择已确认';
    html += '</h4>';
    html += '<p class="mb-0" style="font-size: 1rem; line-height: 1.6; color: #155724;">您已选择 ' + clinicalSession.selectedExaminations.length + ' 项检查，系统将按顺序逐一展示检查结果。</p>';
    html += '</div>';
    
    // 检查顺序预览 - 优化设计
    html += '<div class="examination-sequence-preview mb-5">';
    
    // 大标题
    html += '<div class="text-center mb-4">';
    html += '<h3 class="text-primary fw-bold" style="font-size: 1.8rem; border-bottom: 3px solid #007bff; display: inline-block; padding-bottom: 10px;">';
    html += '<i class="fas fa-list-ol me-3"></i>检查顺序预览';
    html += '</h3>';
    html += '</div>';
    
    // 检查项目卡片 - 强制水平排列
    html += '<div class="sequence-cards-container mb-4">';
    html += '<div style="display: flex; flex-wrap: wrap; gap: 10px; align-items: flex-start;">';
    
    clinicalSession.examinationOrder.forEach(function(examId, index) {
      var $examCard = $('.examination-option[data-exam-id="' + examId + '"]');
      var examName = $examCard.find('strong').text();
      var isRequired = $examCard.data('is-required');
      
      // 小卡片样式 - 使用flex子项
      html += '<div class="sequence-card" style="flex: 0 0 auto;">';
      html += '<div class="sequence-number">' + (index + 1) + '</div>';
      html += '<div class="sequence-name">' + examName + '</div>';
      html += '</div>';
    });
    
    html += '</div>';
    html += '</div>';
    
    // 显示静态开始检查提示
    $('#start-examination-hint').show();
    
    html += '</div>';
    
    $('#stage-content').html(html);
  }
  
  function showNextExaminationResult() {
    var currentIndex = clinicalSession.currentExaminationIndex;
    var examId = clinicalSession.examinationOrder[currentIndex];
    
    // 隐藏静态提示并显示加载状态
    $('#start-examination-hint').hide();
    $('#btn-next').prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i> 加载中...');
    
    // 获取检查结果
    $.getJSON('/api/clinical/case/' + clinicalSession.caseId + '/examination/' + examId + '/', function(resp) {
      if (resp.success) {
        renderSingleExaminationResult(resp.data, currentIndex);
        
        // 更新索引
        clinicalSession.currentExaminationIndex++;
        
        // 更新按钮文本
        if (clinicalSession.currentExaminationIndex < clinicalSession.examinationOrder.length) {
          $('#btn-next').prop('disabled', false).html('查看下一项检查 <i class="fas fa-arrow-right"></i>');
        } else {
          $('#btn-next').prop('disabled', false).html('完成检查阶段 <i class="fas fa-check"></i>');
        }
        
        // 记录到时间线
        addToLearningTimeline('查看检查结果', resp.data.name);
      } else {
        $('#btn-next').prop('disabled', false).html('查看检查结果 <i class="fas fa-arrow-right"></i>');
        showFeedbackMessage('获取检查结果失败: ' + resp.message, 'danger');
      }
    }).fail(function() {
      $('#btn-next').prop('disabled', false).html('查看检查结果 <i class="fas fa-arrow-right"></i>');
      showFeedbackMessage('网络错误，请检查连接后重试', 'danger');
    });
  }
  
  function renderSingleExaminationResult(resultData, examIndex) {
    var html = '<div class="single-examination-result">';
    
    // 检查进度指示
    var totalExams = clinicalSession.examinationOrder.length;
    var progressPercent = Math.round(((examIndex + 1) / totalExams) * 100);
    
    html += '<div class="examination-progress mb-4">';
    html += '<div class="d-flex justify-content-between align-items-center mb-2">';
    html += '<h5 class="text-primary mb-0">检查进度</h5>';
    html += '<span class="text-muted">' + (examIndex + 1) + ' / ' + totalExams + '</span>';
    html += '</div>';
    html += '<div class="progress" style="height: 8px;">';
    html += '<div class="progress-bar bg-primary" style="width: ' + progressPercent + '%"></div>';
    html += '</div>';
    html += '</div>';
    
    // 当前检查结果展示
    html += '<div class="current-examination-result">';
    html += '<div class="card border-primary">';
    html += '<div class="card-header bg-primary text-white">';
    html += '<h4 class="mb-0"><i class="fas fa-microscope me-2"></i>' + resultData.name + '</h4>';
    html += '</div>';
    html += '<div class="card-body">';
    
    // 检查描述 - 已隐藏，不再显示检查说明
    // if (resultData.description) {
    //   html += '<div class="examination-description mb-3">';
    //   html += '<h6 class="text-muted">检查说明</h6>';
    //   html += '<p class="text-muted">' + resultData.description + '</p>';
    //   html += '</div>';
    // }
    
    // 特殊处理：眼底检查 - 留白显示
    var isFundusExam = resultData.is_fundus_exam || 
                      (resultData.name && (
                        resultData.name.toLowerCase().indexOf('眼底') !== -1 ||
                        resultData.name.toLowerCase().indexOf('fundus') !== -1 ||
                        resultData.name.toLowerCase().indexOf('眼底照片') !== -1 ||
                        resultData.name.toLowerCase().indexOf('眼底镜') !== -1 ||
                        resultData.name.toLowerCase().indexOf('眼底检查') !== -1
                      )) ||
                      (resultData.type && (
                        resultData.type.toLowerCase().indexOf('眼底') !== -1 ||
                        resultData.type.toLowerCase().indexOf('fundus') !== -1
                      ));
    
    if (isFundusExam) {
      // 眼底检查留白区域
      html += '<div class="fundus-examination-blank">';
      html += '<div class="icon">';
      html += '<i class="fas fa-eye"></i>';
      html += '</div>';
      html += '<div class="message">请移步旁边进行观察</div>';
      html += '<div class="submessage">眼底检查需要实际操作观察</div>';
      html += '</div>';
      
      // 显示浮现字幕
      setTimeout(function() {
        showFundusSubtitle();
      }, 500);
    } else {
      // 普通检查显示完整结果
      // 检查描述 - 已隐藏，不再显示检查说明
      // if (resultData.description) {
      //   html += '<div class="examination-description mb-3">';
      //   html += '<h6 class="text-muted">检查说明</h6>';
      //   html += '<p class="text-muted">' + resultData.description + '</p>';
      //   html += '</div>';
      // }
      
      // 检查结果
      html += '<div class="examination-result-content">';
      html += '<h6 class="text-primary">检查结果</h6>';
      html += '<div class="result-box p-3 bg-light rounded border-left-primary">';
      html += '<p class="mb-0" style="font-size: 1.1rem; line-height: 1.6;">' + resultData.result + '</p>';
      html += '</div>';
      html += '</div>';
      
      // 检查数据（视力、眼压等）
      if (resultData.examination_data && Object.keys(resultData.examination_data).length > 0) {
        html += '<div class="examination-data mt-3">';
        html += '<h6 class="text-primary">检查数据</h6>';
        html += '<div class="row">';
        
        if (resultData.examination_data.left_eye_vision) {
          html += '<div class="col-md-6">';
          html += '<div class="data-item p-2 bg-light rounded">';
          html += '<strong>左眼视力:</strong> ' + resultData.examination_data.left_eye_vision;
          html += '</div>';
          html += '</div>';
        }
        
        if (resultData.examination_data.right_eye_vision) {
          html += '<div class="col-md-6">';
          html += '<div class="data-item p-2 bg-light rounded">';
          html += '<strong>右眼视力:</strong> ' + resultData.examination_data.right_eye_vision;
          html += '</div>';
          html += '</div>';
        }
        
        if (resultData.examination_data.left_eye_pressure) {
          html += '<div class="col-md-6">';
          html += '<div class="data-item p-2 bg-light rounded">';
          html += '<strong>左眼眼压:</strong> ' + resultData.examination_data.left_eye_pressure + ' mmHg';
          html += '</div>';
          html += '</div>';
        }
        
        if (resultData.examination_data.right_eye_pressure) {
          html += '<div class="col-md-6">';
          html += '<div class="data-item p-2 bg-light rounded">';
          html += '<strong>右眼眼压:</strong> ' + resultData.examination_data.right_eye_pressure + ' mmHg';
          html += '</div>';
          html += '</div>';
        }
        
        html += '</div>';
        html += '</div>';
      }
      
      // 检查图像 - 增强显示
      console.log('检查结果数据:', resultData); // 调试信息
      console.log('图像数据:', resultData.images); // 调试信息
      
      if (resultData.images && resultData.images.length > 0) {
        html += '<div class="examination-images mt-3">';
        html += '<h6 class="text-primary mb-3"><i class="fas fa-image me-2"></i>检查图像</h6>';
        
        // 检查是否为OCT检查
        var isOctExam = resultData.is_oct_exam || 
                       (resultData.name && (
                         resultData.name.indexOf('OCT') !== -1 ||
                         resultData.name.indexOf('光学相干断层扫描') !== -1 ||
                         resultData.name.indexOf('光相干断层') !== -1
                       ));
        
        console.log('是否OCT检查:', isOctExam); // 调试信息
        
        if (isOctExam) {
          // OCT检查特殊显示
          html += renderOctImages(resultData);
        } else {
          // 普通检查图像显示
          html += renderStandardImages(resultData);
        }
        
        html += '</div>';
      } else {
        // 添加调试信息显示没有图像的情况
        html += '<div class="alert alert-warning mt-3">';
        html += '<i class="fas fa-info-circle me-2"></i>';
        html += '暂无检查图像数据';
        if (resultData.is_oct_exam) {
          html += ' (OCT检查)';
        }
        html += '</div>';
        console.log('没有图像数据或图像数组为空'); // 调试信息
      }
    }
    
    html += '</div>';
    html += '</div>';
    html += '</div>';
    
    // 继续提示
    html += '<div class="continue-prompt mt-4">';
    html += '<div class="text-center p-3 bg-light rounded">';
    if (examIndex + 1 < totalExams) {
      html += '<p class="text-muted mb-0">请仔细查看检查结果，准备查看下一项检查</p>';
    } else {
      html += '<p class="text-muted mb-0">所有检查结果已展示完毕，准备进入诊断阶段</p>';
    }
    html += '</div>';
    html += '</div>';
    
    html += '</div>';
    
    $('#stage-content').html(html);
    
    // 绑定图像点击事件
    $('.examination-image').on('click', function() {
      var imageSrc = $(this).data('image-src');
      showImageModal(imageSrc);
    });
    
    // 绑定OCT图像点击事件
    $('.oct-image').on('click', function() {
      var imageSrc = $(this).data('image-src') || $(this).attr('src');
      var eye = $(this).data('eye') || 'unknown';
      var measurements = $(this).data('measurements') || {};
      
      if (clinicalSession.examination_images_viewed.indexOf(imageSrc) === -1) {
        clinicalSession.examination_images_viewed.push(imageSrc);
        saveSessionData();
      }
      
      showOctImageModal(imageSrc, eye, measurements);
    });
  }

  function renderExaminationImagesForCard($card, images) {
    // images 为数组路径
    if (!images || images.length === 0) return;
    var html = '<div class="examination-images mt-3">';
    images.forEach(function(img) {
      html += '<img src="' + img + '" class="img-fluid mb-2 exam-image" style="max-height:220px; cursor:zoom-in;" data-src="' + img + '">';
    });
    html += '</div>';

    // 防止重复插入
    $card.find('.examination-images').remove();
    $card.find('.card-body').append(html);

    // 点击图片记录为已查看
    $card.find('.exam-image').on('click', function() {
      var src = $(this).data('src');
      if (clinicalSession.examination_images_viewed.indexOf(src) === -1) {
        clinicalSession.examination_images_viewed.push(src);
      }
      showImageModal(src);
    });
  }

  function showImageModal(src) {
    var modalHtml = '';
    modalHtml += '<div class="modal fade" id="examImageModal" tabindex="-1" role="dialog">';
    modalHtml += '<div class="modal-dialog modal-lg" role="document">';
    modalHtml += '<div class="modal-content">';
    modalHtml += '<div class="modal-body text-center">';
    modalHtml += '<img src="' + src + '" class="img-fluid">';
    modalHtml += '</div>';
    modalHtml += '<div class="modal-footer">';
    modalHtml += '<button type="button" class="btn btn-secondary" data-dismiss="modal">关闭</button>'; 
    modalHtml += '</div></div></div></div>';

    $('#examImageModal').remove();
    $('body').append(modalHtml);
    $('#examImageModal').modal('show');
  }
  
  // OCT图像专用模态框
  function showOctImageModal(src, eye, measurements) {
    var modalHtml = '';
    modalHtml += '<div class="modal fade" id="octImageModal" tabindex="-1" role="dialog">';
    modalHtml += '<div class="modal-dialog modal-xl" role="document">';
    modalHtml += '<div class="modal-content">';
    
    // 模态框头部
    modalHtml += '<div class="modal-header bg-primary text-white">';
    modalHtml += '<h5 class="modal-title">';
    modalHtml += '<i class="fas fa-microscope me-2"></i>OCT检查图像 - ' + (eye === 'left' ? '左眼' : '右眼');
    modalHtml += '</h5>';
    modalHtml += '<button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>';
    modalHtml += '</div>';
    
    // 模态框内容
    modalHtml += '<div class="modal-body">';
    modalHtml += '<div class="row">';
    
    // 图像显示区域
    modalHtml += '<div class="col-md-8">';
    modalHtml += '<div class="oct-modal-image-container">';
    modalHtml += '<img src="' + src + '" class="img-fluid oct-modal-image" ';
    modalHtml += 'style="width: 100%; border-radius: 8px; border: 2px solid #dee2e6;">';
    
    // 图像工具栏
    modalHtml += '<div class="image-toolbar mt-3">';
    modalHtml += '<div class="btn-group" role="group">';
    modalHtml += '<button type="button" class="btn btn-outline-primary btn-sm" onclick="zoomImage(\'in\')">';
    modalHtml += '<i class="fas fa-search-plus"></i> 放大</button>';
    modalHtml += '<button type="button" class="btn btn-outline-primary btn-sm" onclick="zoomImage(\'out\')">';
    modalHtml += '<i class="fas fa-search-minus"></i> 缩小</button>';
    modalHtml += '<button type="button" class="btn btn-outline-primary btn-sm" onclick="resetImageZoom()">';
    modalHtml += '<i class="fas fa-expand-arrows-alt"></i> 重置</button>';
    modalHtml += '<button type="button" class="btn btn-outline-secondary btn-sm" onclick="toggleImageMeasurement()">';
    modalHtml += '<i class="fas fa-ruler"></i> 测量</button>';
    modalHtml += '</div>';
    modalHtml += '</div>';
    
    modalHtml += '</div>';
    modalHtml += '</div>';
    
    // 测量数据和分析面板
    modalHtml += '<div class="col-md-4">';
    modalHtml += '<div class="oct-analysis-panel">';
    
    modalHtml += '<h6 class="text-primary mb-3">';
    modalHtml += '<i class="fas fa-chart-line me-2"></i>分析数据';
    modalHtml += '</h6>';
    
    if (measurements && Object.keys(measurements).length > 0) {
      modalHtml += '<div class="measurements-list">';
      Object.keys(measurements).forEach(function(key) {
        var value = measurements[key];
        var displayName = getOctMeasurementDisplayName(key);
        modalHtml += '<div class="measurement-item mb-3 p-3 bg-light rounded">';
        modalHtml += '<div class="measurement-name small text-muted mb-1">' + displayName + '</div>';
        modalHtml += '<div class="measurement-value h6 text-primary mb-0">' + value + '</div>';
        modalHtml += '</div>';
      });
      modalHtml += '</div>';
    } else {
      modalHtml += '<div class="alert alert-light">';
      modalHtml += '<small class="text-muted">暂无测量数据</small>';
      modalHtml += '</div>';
    }
    
    // 分析要点
    modalHtml += '<div class="analysis-points mt-4">';
    modalHtml += '<h6 class="text-secondary mb-3">';
    modalHtml += '<i class="fas fa-eye me-2"></i>观察要点';
    modalHtml += '</h6>';
    modalHtml += '<ul class="list-unstyled small">';
    modalHtml += '<li class="mb-2"><i class="fas fa-arrow-right text-primary me-2"></i>视网膜各层结构</li>';
    modalHtml += '<li class="mb-2"><i class="fas fa-arrow-right text-primary me-2"></i>视网膜厚度变化</li>';
    modalHtml += '<li class="mb-2"><i class="fas fa-arrow-right text-primary me-2"></i>病理性改变</li>';
    modalHtml += '<li class="mb-2"><i class="fas fa-arrow-right text-primary me-2"></i>积液或出血</li>';
    modalHtml += '</ul>';
    modalHtml += '</div>';
    
    modalHtml += '</div>';
    modalHtml += '</div>';
    
    modalHtml += '</div>';
    modalHtml += '</div>';
    
    // 模态框底部
    modalHtml += '<div class="modal-footer">';
    modalHtml += '<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">';
    modalHtml += '<i class="fas fa-times me-2"></i>关闭';
    modalHtml += '</button>';
    modalHtml += '<button type="button" class="btn btn-primary" onclick="saveImageAnnotation()">';
    modalHtml += '<i class="fas fa-save me-2"></i>保存标注';
    modalHtml += '</button>';
    modalHtml += '</div>';
    
    modalHtml += '</div></div></div>';

    // 移除已存在的模态框并添加新的
    $('#octImageModal').remove();
    $('body').append(modalHtml);
    
    // 显示模态框
    $('#octImageModal').modal('show');
  }

  // 显示眼底检查字幕
  function showFundusSubtitle() {
    // 创建字幕覆盖层
    if (!$('#fundus-overlay').length) {
      var overlayHtml = '<div id="fundus-overlay">';
      overlayHtml += '<div id="fundus-subtitle">请移步旁边进行观察</div>';
      overlayHtml += '</div>';
      $('body').append(overlayHtml);
    }
    
    var $overlay = $('#fundus-overlay');
    var $subtitle = $('#fundus-subtitle');
    
    // 显示动画序列
    $overlay.addClass('show');
    
    // 3秒后开始淡出，但保持显示直到用户操作
    setTimeout(function() {
      if (!clinicalSession.fundusSubtitleDismissed) {
        // 添加轻微的脉冲提醒，但不完全消失
        $subtitle.css('animation', 'pulse-glow 2s ease-in-out infinite');
      }
    }, 3000);
  }
  
  // 隐藏眼底检查字幕
  function hideFundusSubtitle() {
    var $overlay = $('#fundus-overlay');
    clinicalSession.fundusSubtitleDismissed = true;
    
    $overlay.removeClass('show');
    setTimeout(function() {
      $overlay.remove();
    }, 800); // 等待淡出动画完成
  }

  function updateExaminationSummary() {
    var selectedCount = clinicalSession.selectedExaminations.length;
    var totalCost = 0;
    var riskLevels = [];
    var efficiencyScore = 100; // 基础效率分
    
    $('.examination-checkbox:checked').each(function() {
      var $card = $(this).closest('.examination-option');
      var cost = parseInt($card.find('.examination-info').text().match(/¥(\d+)/)?.[1] || 0);
      totalCost += cost;
      
      // 移除高价值检查统计，避免隐性提示
      
      var riskText = $card.find('.examination-info').text();
      if (riskText.includes('高')) riskLevels.push('high');
      else if (riskText.includes('中')) riskLevels.push('medium');
      else riskLevels.push('low');
    });
    
    // 综合风险评估
    var overallRisk = '低';
    if (riskLevels.includes('high')) overallRisk = '高';
    else if (riskLevels.includes('medium')) overallRisk = '中';
    
    // 计算检查效率（基于选择数量的合理性）
    if (selectedCount > 8) efficiencyScore -= (selectedCount - 8) * 10;
    if (selectedCount < 2) efficiencyScore -= (2 - selectedCount) * 20;
    
    $('#selected-count').text(selectedCount);
    $('#total-cost').text('¥' + totalCost);
  }
  
  // 显示检查选择得分详情
  function showExaminationScoreDetails(scoreDetails) {
    var html = '<div class="alert alert-info score-details-alert" style="margin-top: 15px;">';
    html += '<h6 class="mb-3"><i class="fas fa-chart-bar me-2"></i>检查选择得分详情</h6>';
    html += '<div class="row text-center">';
    
    html += '<div class="col-md-3 col-6 mb-2">';
    html += '<div class="score-item">';
    html += '<div class="score-value text-primary fw-bold" style="font-size: 1.2rem;">' + scoreDetails.total_score + '</div>';
    html += '<div class="score-label small text-muted">总分</div>';
    html += '</div>';
    html += '</div>';
    
    html += '<div class="col-md-3 col-6 mb-2">';
    html += '<div class="score-item">';
    html += '<div class="score-value text-danger fw-bold">' + scoreDetails.required_score + '</div>';
    html += '<div class="score-label small text-muted">必选检查 (60%)</div>';
    html += '<div class="score-stats small text-muted">(' + scoreDetails.required_stats + ')</div>';
    html += '</div>';
    html += '</div>';
    
    html += '<div class="col-md-4 col-6 mb-2">';
    html += '<div class="score-item">';
    html += '<div class="score-value text-info fw-bold">' + scoreDetails.required_score + '</div>';
    html += '<div class="score-label small text-muted">必选检查 (70%)</div>';
    html += '<div class="score-stats small text-muted">(' + scoreDetails.required_stats + ')</div>';
    html += '</div>';
    html += '</div>';
    
    html += '<div class="col-md-4 col-6 mb-2">';
    html += '<div class="score-item">';
    html += '<div class="score-value text-warning fw-bold">' + scoreDetails.efficiency_score + '</div>';
    html += '<div class="score-label small text-muted">检查效率 (30%)</div>';
    html += '<div class="score-stats small text-muted">(' + scoreDetails.efficiency_stats + ')</div>';
    html += '</div>';
    html += '</div>';
    
    html += '</div>';
    
    // 添加得分说明
    html += '<div class="mt-3 p-2 bg-light rounded">';
    html += '<small class="text-muted">';
    html += '<i class="fas fa-info-circle me-1"></i>';
    html += '<strong>评分说明：</strong> ';
    html += '必选检查占70%（临床诊断必需），检查效率占30%（避免不必要的重复检查，提高诊断效率）';
    html += '</small>';
    html += '</div>';
    
    html += '</div>';
    
    // 显示得分详情，8秒后自动隐藏
    $('#feedback-panel').append(html);
    
    setTimeout(function() {
      $('.score-details-alert').fadeOut(800, function() {
        $(this).remove();
      });
    }, 8000);
  }

  function provideLiveExaminationFeedback() {
    var selectedCount = clinicalSession.selectedExaminations.length;
    var feedback = '';
    
    if (selectedCount === 0) {
      feedback = '<div class="alert alert-info">请开始选择检查项目</div>';
    } else if (selectedCount < 3) {
      feedback = '<div class="alert alert-warning">考虑是否需要更多检查来明确诊断</div>';
    } else if (selectedCount > 8) {
      feedback = '<div class="alert alert-danger">检查过多可能增加成本和患者负担</div>';
    } else {
      feedback = '<div class="alert alert-success">检查选择合理，请继续</div>';
    }
    
    $('#feedback-panel').html(feedback);
  }

  function submitExaminations() {
    // 验证必选检查是否被选中
    var requiredMissing = [];
    $('.examination-checkbox').each(function() {
      var isRequired = $(this).data('is-required') === 1 || $(this).data('is-required') === true;
      if (isRequired) {
        var id = parseInt($(this).val());
        if (clinicalSession.selectedExaminations.indexOf(id) === -1) {
          requiredMissing.push(id);
        }
      }
    });

    if (requiredMissing.length > 0) {
      showFeedbackMessage('存在重要检查项目未选择，建议完善检查后再继续', 'warning');
      return;
    }

    // 显示提交中状态
    $('#btn-next').prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i> 提交中...');
    showFeedbackMessage('正在提交检查选择...', 'info');

    // 准备提交数据
    var submitData = {
      case_id: clinicalSession.caseId,
      selected_examinations: clinicalSession.selectedExaminations,
      images_viewed: clinicalSession.examination_images_viewed
    };

    $.ajax({
      url: '/api/clinical/submit-examinations/',
      method: 'POST',
      contentType: 'application/json',
      headers: {
        'X-CSRFToken': $('[name=csrfmiddlewaretoken]').val() || getCsrfToken()
      },
      data: JSON.stringify(submitData),
      success: function(resp) {
        $('#btn-next').prop('disabled', false).html('下一步 <i class="fas fa-arrow-right"></i>');

        if (resp.success) {
          // 记录检查阶段完成
          addToLearningTimeline('完成检查选择', '选择了 ' + clinicalSession.selectedExaminations.length + ' 项检查');

          // 更新分数
          if (resp.data.examination_score !== undefined) {
            clinicalSession.scores.examination = resp.data.examination_score;
            $('#current-score').text(resp.data.examination_score.toFixed(1));
            
            // 显示得分详情
            if (resp.data.score_details) {
              showExaminationScoreDetails(resp.data.score_details);
            }
          }

          // 进入诊断阶段
          renderDiagnosisStage(resp.data);
          showFeedbackMessage('检查结果已获得，请开始诊断分析', 'success');
          // 视觉反馈
          flashCard($('#feedback-panel'), 'success');
          launchConfetti(25);
        } else {
          showFeedbackMessage('提交失败: ' + resp.message, 'danger');
        }
      },
      error: function(xhr, status, error) {
        $('#btn-next').prop('disabled', false).html('下一步 <i class="fas fa-arrow-right"></i>');
        console.error('Submit examination error:', error, xhr.responseText);

        if (xhr.status === 404) {
          showFeedbackMessage('API接口未找到，请检查后端配置', 'danger');
        } else if (xhr.status === 403) {
          showFeedbackMessage('权限不足，请重新登录', 'danger');
        } else if (xhr.status === 500) {
          showFeedbackMessage('服务器内部错误，请联系管理员', 'danger');
        } else {
          showFeedbackMessage('网络错误，请检查连接: ' + error, 'danger');
        }
      }
    });
  }

  
  // ==================== 诊断阶段：鉴别诊断推理 ====================
  
  function renderDiagnosisStage(data) {
    clinicalSession.currentStage = 'diagnosis';
    updateClinicalProgress();
    updateStageProgress();
    
    $('#btn-next').prop('disabled', false).text('提交诊断选择 →').removeClass('btn-warning').addClass('btn-info');
    updateStageCard('诊断推理阶段', 'diagnosis');
    
    var html = '<div class="diagnosis-stage">';
    
    // 检查结果展示 - 小卡片形式
    html += '<div class="examination-results mb-4">';
    html += '<h5 class="text-primary mb-3"><i class="fas fa-microscope me-2"></i> 检查结果</h5>';
    
    if (data.examination_results && data.examination_results.length > 0) {
      html += '<div class="row g-3">';
      data.examination_results.forEach(function(result) {
        html += '<div class="col-12">';
        html += '<div class="exam-result-card">';
        
        // 检查项目头部
        html += '<div class="exam-header">';
        html += '<div class="d-flex align-items-center justify-content-between">';
        html += '<div class="exam-title">';
        html += '<i class="fas fa-eye text-primary me-2"></i>';
        html += '<span class="fw-bold text-dark">' + result.name + '</span>';
        html += '</div>';
        // 移除推荐检查标签，避免隐性提示
        // if (result.is_recommended) {
        //   html += '<span class="badge bg-success">推荐检查</span>';
        // }
        html += '</div>';
        html += '</div>';
        
        // 检查结果内容
        html += '<div class="exam-content">';
        html += '<div class="result-label">检查结果</div>';
        html += '<div class="result-text">' + (result.result || '未记录') + '</div>';
        html += '</div>';
        
        html += '</div>';
        html += '</div>';
      });
      html += '</div>';
    } else {
      html += '<div class="alert alert-warning border-0 bg-warning bg-opacity-10">';
      html += '<i class="fas fa-exclamation-triangle text-warning me-2"></i>';
      html += '暂无检查结果数据';
      html += '</div>';
    }
    html += '</div>';
    
    // 诊断选项 - Layout Version 2.0
    console.log('Rendering diagnosis options - Layout Updated at ' + new Date().toLocaleString());
    html += '<div class="diagnosis-options">';
    html += '<h4 class="text-info mb-4" style="font-weight: 700; display: flex; align-items: center;">';
    html += '<i class="fas fa-user-md me-2" style="font-size: 1.3rem; color: #17a2b8;"></i>鉴别诊断';
    html += '</h4>';
    html += '<div class="alert alert-info" style="background: linear-gradient(135deg, #d1ecf1 0%, #bee5eb 100%); border: none; border-radius: 12px; padding: 20px;">';
    html += '<h5 class="mb-3" style="color: #0c5460; font-weight: 700; display: flex; align-items: center;">';
    html += '<i class="fas fa-brain me-2" style="font-size: 1.2rem; color: #6f42c1;"></i>诊断思维指导';
    html += '</h5>';
    html += '<p class="mb-0" style="font-size: 1rem; line-height: 1.6; color: #0c5460;">综合患者病史和检查结果，进行鉴别诊断。仔细分析每个诊断的符合度，选择最可能的诊断选项。</p>';
    html += '</div>';
    
    // 如果后端没有诊断选项，创建基于案例的临床诊断选项
    var diagnosisOptions = data.diagnosis_options;
    if (!diagnosisOptions || diagnosisOptions.length === 0) {
      // 基于眼底出血病例的常见诊断选项
      diagnosisOptions = [
        {
          id: 1,
          name: '糖尿病视网膜病变',
          code: 'H36.0',
          description: '糖尿病引起的视网膜微血管病变，出现出血、渗出等',
          probability_score: 0.75,
          is_correct: false
        },
        {
          id: 2, 
          name: '高血压性视网膜病变',
          code: 'H35.0',
          description: '高血压引起的视网膜血管改变，可见出血、渗出',
          probability_score: 0.65,
          is_correct: false
        },
        {
          id: 3,
          name: '视网膜静脉阻塞',
          code: 'H34.8',
          description: '视网膜静脉血流受阻，导致视网膜出血和水肿',
          probability_score: 0.85,
          is_correct: true
        },
        {
          id: 4,
          name: 'Valsalva视网膜病变',
          code: 'H35.6',
          description: '用力过度引起的视网膜表层出血，多见于年轻人',
          probability_score: 0.90,
          is_correct: true
        },
        {
          id: 5,
          name: '外伤性视网膜病变',
          code: 'S05.8',
          description: '眼外伤导致的视网膜出血，需询问外伤史',
          probability_score: 0.45,
          is_correct: false
        }
      ];
    }
    
    // 缓存诊断选项数据
    clinicalSession.diagnosisOptions = diagnosisOptions;
    
    if (diagnosisOptions && diagnosisOptions.length > 0) {
      html += '<form id="diagnosis-form">';
      diagnosisOptions.forEach(function(option) {
        // Layout Version 2.0 - Updated structure for better alignment
        html += '<div class="card diagnosis-option mb-3" data-diagnosis-id="' + option.id + '" data-layout-version="2.0" style="border: 2px solid transparent; transition: all 0.3s ease;">';
        html += '<div class="card-body">';
        html += '<div class="d-flex align-items-center mb-2">';
        html += '<input class="form-check-input diagnosis-radio me-3" type="radio" name="diagnosis" ';
        html += 'value="' + option.id + '" id="diag_' + option.id + '" style="flex-shrink: 0; margin-top: 0;">';
        html += '<label class="form-check-label me-3" for="diag_' + option.id + '" style="cursor: pointer; flex-grow: 1;">';
        html += '<h6 class="mb-0" style="color: #2c3e50; font-weight: 600;">' + option.name + '</h6>';
        html += '</label>';
        if (option.probability_score !== undefined) {
          var percentage = (option.probability_score * 100).toFixed(0);
          var badgeClass = percentage >= 80 ? 'badge-success' : percentage >= 60 ? 'badge-warning' : 'badge-secondary';
          html += '<span class="badge ' + badgeClass + '" style="flex-shrink: 0;">符合度: ' + percentage + '%</span>';
        }
        html += '</div>';
        if (option.code) {
          html += '<div class="text-muted small mb-1" style="margin-left: 2.5rem;"><i class="fas fa-code me-1"></i>ICD: ' + option.code + '</div>';
        }
        if (option.description) {
          html += '<div class="text-muted small" style="line-height: 1.4; margin-left: 2.5rem;">' + option.description + '</div>';
        }
        html += '</div>';
        html += '</div>';
        html += '</div>';
      });
      html += '</form>';
    } else {
      html += '<div class="alert alert-warning">暂无诊断选项数据</div>';
    }
    
    html += '</div>';
    html += '</div>';
    
    $('#stage-content').html(html);
    
    // 恢复之前的选择状态（如果有的话）
    if (clinicalSession.selectedDiagnosis) {
      $('input[name="diagnosis"][value="' + clinicalSession.selectedDiagnosis + '"]').prop('checked', true);
      $('.diagnosis-option[data-diagnosis-id="' + clinicalSession.selectedDiagnosis + '"]').addClass('selected');
    }
    
    // 绑定诊断选择事件
    bindDiagnosisEvents();
    showClinicalThinkingPrompt('diagnosis');
    
    // 确保按钮状态正确 - 诊断阶段按钮应始终可用
    setTimeout(function() {
      ensureButtonEnabled();
    }, 100);
  }
  
  function bindDiagnosisEvents() {
    $('.diagnosis-radio').off('change').on('change', function() {
      var diagnosisId = parseInt($(this).val());
      var $card = $(this).closest('.diagnosis-option');
      
      console.log('=== 诊断选择事件触发 ===');
      console.log('选中的诊断ID:', diagnosisId);
      console.log('诊断选项卡:', $card);
      
      // 移除其他选中状态
      $('.diagnosis-option').removeClass('selected');
      
      // 设置当前选中
      $card.addClass('selected');
      clinicalSession.selectedDiagnosis = diagnosisId;
      
      console.log('clinicalSession.selectedDiagnosis已设置为:', clinicalSession.selectedDiagnosis);
      
      // 验证选择是否成功
      setTimeout(function() {
        console.log('延时验证 - selectedDiagnosis:', clinicalSession.selectedDiagnosis);
        if (clinicalSession.selectedDiagnosis) {
          console.log('✅ 诊断选择成功！');
        } else {
          console.log('❌ 诊断选择失败！');
        }
      }, 100);
      
      // 记录选择
      var diagnosisName = $(this).siblings('label').find('h6').text();
      addToLearningTimeline('选择诊断', diagnosisName);
      
      // 提供即时反馈
      showFeedbackMessage('已选择诊断：' + diagnosisName + '，可以点击提交按钮继续', 'success');
      
      // 按钮始终保持可用状态
      ensureButtonEnabled();
      console.log('诊断已选择，按钮保持可用:', clinicalSession.selectedDiagnosis);
    });
    
    $('.diagnosis-option').off('click').on('click', function(e) {
      console.log('诊断选项卡片被点击:', $(this));
      if (e.target.type !== 'radio') {
        var radio = $(this).find('.diagnosis-radio');
        console.log('找到的radio按钮:', radio);
        radio.prop('checked', true).trigger('change');
      }
    });
  }
  
  // ==================== 影像检查渲染函数 ====================
  
  // OCT检查图像渲染
  function renderOctImages(resultData) {
    var html = '';
    
    html += '<div class="oct-examination-display">';
    html += '<div class="oct-header mb-3">';
    html += '<div class="alert alert-info border-0" style="background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);">';
    html += '<div class="d-flex align-items-center">';
    html += '<i class="fas fa-microscope text-primary me-3" style="font-size: 1.5rem;"></i>';
    html += '<div>';
    html += '<h6 class="mb-1" style="color: #1565c0;">OCT光学相干断层扫描</h6>';
    html += '<small class="text-muted">请仔细观察视网膜各层结构和病理改变</small>';
    html += '</div>';
    html += '</div>';
    html += '</div>';
    html += '</div>';
    
    // OCT测量数据显示（如果有）
    if (resultData.oct_measurement_data) {
      html += '<div class="oct-measurements mb-4">';
      html += '<h6 class="text-primary mb-3"><i class="fas fa-ruler me-2"></i>测量数据</h6>';
      html += '<div class="row g-3">';
      
      Object.keys(resultData.oct_measurement_data).forEach(function(key) {
        var value = resultData.oct_measurement_data[key];
        var displayName = getOctMeasurementDisplayName(key);
        html += '<div class="col-md-4 col-6">';
        html += '<div class="measurement-card p-3 bg-light rounded border">';
        html += '<div class="measurement-label small text-muted mb-1">' + displayName + '</div>';
        html += '<div class="measurement-value h6 mb-0 text-primary">' + value + '</div>';
        html += '</div>';
        html += '</div>';
      });
      
      html += '</div>';
      html += '</div>';
    }
    
    // 双眼对比显示
    html += '<div class="oct-images-display">';
    html += '<div class="row g-4">';
    
    // 处理图像数组
    var leftEyeImages = [];
    var rightEyeImages = [];
    
    resultData.images.forEach(function(image) {
      var imageObj = typeof image === 'string' ? {url: image} : image;
      
      if (imageObj.eye === 'left' || imageObj.label === '左眼' || 
          (imageObj.description && imageObj.description.indexOf('左眼') !== -1)) {
        leftEyeImages.push(imageObj);
      } else if (imageObj.eye === 'right' || imageObj.label === '右眼' || 
                (imageObj.description && imageObj.description.indexOf('右眼') !== -1)) {
        rightEyeImages.push(imageObj);
      } else {
        // 如果无法确定，默认按顺序分配
        if (leftEyeImages.length <= rightEyeImages.length) {
          leftEyeImages.push(imageObj);
        } else {
          rightEyeImages.push(imageObj);
        }
      }
    });
    
    // 左眼显示
    if (leftEyeImages.length > 0) {
      html += '<div class="col-md-6">';
      html += '<div class="eye-section">';
      html += '<h6 class="text-center mb-3 p-2 bg-primary text-white rounded">';
      html += '<i class="fas fa-eye me-2"></i>左眼 OCT</h6>';
      
      leftEyeImages.forEach(function(image) {
        html += '<div class="oct-image-container mb-3">';
        html += '<div class="position-relative">';
        html += '<img src="' + (image.url || image) + '" class="img-fluid rounded oct-image" ';
        html += 'style="width: 100%; cursor: zoom-in; border: 2px solid #dee2e6;" ';
        html += 'data-bs-toggle="modal" data-bs-target="#octImageModal" ';
        html += 'data-image-src="' + (image.url || image) + '" ';
        html += 'data-eye="left">';
        
        // 图像标注层
        html += '<div class="image-overlay d-none">';
        html += '<div class="overlay-controls">';
        html += '<button class="btn btn-sm btn-light me-2" onclick="toggleImageAnnotations(this)">';
        html += '<i class="fas fa-tags"></i> 标注</button>';
        html += '<button class="btn btn-sm btn-light" onclick="toggleImageMeasurement(this)">';
        html += '<i class="fas fa-ruler"></i> 测量</button>';
        html += '</div>';
        html += '</div>';
        
        html += '</div>';
        
        if (image.description) {
          html += '<p class="text-muted small mt-2 text-center">' + image.description + '</p>';
        }
        html += '</div>';
      });
      
      html += '</div>';
      html += '</div>';
    }
    
    // 右眼显示
    if (rightEyeImages.length > 0) {
      html += '<div class="col-md-6">';
      html += '<div class="eye-section">';
      html += '<h6 class="text-center mb-3 p-2 bg-success text-white rounded">';
      html += '<i class="fas fa-eye me-2"></i>右眼 OCT</h6>';
      
      rightEyeImages.forEach(function(image) {
        html += '<div class="oct-image-container mb-3">';
        html += '<div class="position-relative">';
        html += '<img src="' + (image.url || image) + '" class="img-fluid rounded oct-image" ';
        html += 'style="width: 100%; cursor: zoom-in; border: 2px solid #dee2e6;" ';
        html += 'data-bs-toggle="modal" data-bs-target="#octImageModal" ';
        html += 'data-image-src="' + (image.url || image) + '" ';
        html += 'data-eye="right">';
        
        // 图像标注层
        html += '<div class="image-overlay d-none">';
        html += '<div class="overlay-controls">';
        html += '<button class="btn btn-sm btn-light me-2" onclick="toggleImageAnnotations(this)">';
        html += '<i class="fas fa-tags"></i> 标注</button>';
        html += '<button class="btn btn-sm btn-light" onclick="toggleImageMeasurement(this)">';
        html += '<i class="fas fa-ruler"></i> 测量</button>';
        html += '</div>';
        html += '</div>';
        
        html += '</div>';
        
        if (image.description) {
          html += '<p class="text-muted small mt-2 text-center">' + image.description + '</p>';
        }
        html += '</div>';
      });
      
      html += '</div>';
      html += '</div>';
    }
    
    html += '</div>';
    html += '</div>';
    
    // OCT报告文字（如果有）
    if (resultData.oct_report_text) {
      html += '<div class="oct-report mt-4">';
      html += '<h6 class="text-primary mb-3"><i class="fas fa-file-medical-alt me-2"></i>OCT报告</h6>';
      html += '<div class="report-content p-4 bg-light rounded border-start border-primary border-4">';
      html += '<div class="report-text" style="line-height: 1.8; font-size: 0.95rem;">';
      html += resultData.oct_report_text.replace(/\n/g, '<br>');
      html += '</div>';
      html += '</div>';
      html += '</div>';
    }
    
    html += '</div>';
    
    return html;
  }
  
  // 标准检查图像渲染
  function renderStandardImages(resultData) {
    var html = '';
    
    html += '<div class="standard-images-display">';
    html += '<div class="row g-3">';
    
    resultData.images.forEach(function(image, index) {
      var imageObj = typeof image === 'string' ? {url: image} : image;
      var colClass = resultData.images.length === 1 ? 'col-12' : 
                    resultData.images.length === 2 ? 'col-md-6' : 'col-md-4';
      
      html += '<div class="' + colClass + ' mb-3">';
      html += '<div class="standard-image-container">';
      html += '<div class="position-relative">';
      html += '<img src="' + (imageObj.url || imageObj) + '" class="img-fluid rounded examination-image" ';
      html += 'style="max-height: 400px; width: 100%; object-fit: contain; cursor: zoom-in; border: 1px solid #dee2e6;" ';
      html += 'data-bs-toggle="modal" data-bs-target="#imageModal" ';
      html += 'data-image-src="' + (imageObj.url || imageObj) + '" ';
      html += 'data-image-index="' + index + '">';
      html += '</div>';
      
      if (imageObj.description) {
        html += '<p class="text-muted small mt-2 text-center">' + imageObj.description + '</p>';
      }
      
      // 图像所见（如果有）
      if (imageObj.findings) {
        html += '<div class="image-findings mt-2 p-2 bg-light rounded">';
        html += '<small class="text-muted"><strong>影像所见：</strong>' + imageObj.findings + '</small>';
        html += '</div>';
      }
      
      html += '</div>';
      html += '</div>';
    });
    
    html += '</div>';
    html += '</div>';
    
    return html;
  }
  
  // OCT测量数据显示名称转换
  function getOctMeasurementDisplayName(key) {
    var displayNames = {
      'central_thickness': '中心凹厚度',
      'average_thickness': '平均厚度',
      'volume': '黄斑体积',
      'rnfl_superior': '上方RNFL厚度',
      'rnfl_inferior': '下方RNFL厚度',
      'rnfl_nasal': '鼻侧RNFL厚度',
      'rnfl_temporal': '颞侧RNFL厚度',
      'cup_disc_ratio': '杯盘比',
      'rim_area': '视盘缘面积'
    };
    return displayNames[key] || key;
  }
  
  // ==================== 工具函数 ====================
  
  function getCsrfToken() {
    // 尝试从cookie获取CSRF token
    var cookieValue = null;
    if (document.cookie && document.cookie !== '') {
      var cookies = document.cookie.split(';');
      for (var i = 0; i < cookies.length; i++) {
        var cookie = cookies[i].trim();
        if (cookie.substring(0, 10) === 'csrftoken=') {
          cookieValue = decodeURIComponent(cookie.substring(10));
          break;
        }
      }
    }
    return cookieValue;
  }

  function submitDiagnosis() {
    console.log('=== 开始提交诊断 ===');
    console.log('当前选中诊断ID:', clinicalSession.selectedDiagnosis);
    console.log('案例ID:', clinicalSession.caseId);
    
    // 显示提交中状态
    $('#btn-next').prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i> 提交中...');
    showFeedbackMessage('正在提交诊断选择...', 'info');
    
    // 准备提交数据
    var submitData = {
      case_id: clinicalSession.caseId,
      selected_diagnosis_id: clinicalSession.selectedDiagnosis,
      reasoning: $('#clinical-notes').val() || ''
    };
    
    console.log('提交数据:', submitData);
    
    $.ajax({
      url: '/api/clinical/submit-diagnosis/',
      method: 'POST',
      contentType: 'application/json',
      headers: {
        'X-CSRFToken': $('[name=csrfmiddlewaretoken]').val() || getCsrfToken()
      },
      data: JSON.stringify(submitData),
      success: function(resp) {
        console.log('诊断提交成功响应:', resp);
        $('#btn-next').prop('disabled', false).html('下一步 <i class="fas fa-arrow-right"></i>');
        
        if (resp.success) {
          // 记录诊断阶段完成
          var selectedDiagName = $('.diagnosis-option.selected').find('h6').text();
          addToLearningTimeline('提交诊断', selectedDiagName);
          
          // 更新分数
          if (resp.data.diagnosis_score !== undefined) {
            clinicalSession.scores.diagnosis = resp.data.diagnosis_score;
            $('#current-score').text(resp.data.diagnosis_score.toFixed(1));
          }
          
          // 显示诊断反馈
          if (resp.data.diagnosis_feedback) {
            showFeedbackMessage(resp.data.diagnosis_feedback, 'success');
          }
          
          // 进入治疗阶段
          renderTreatmentStage(resp.data);
          // 视觉反馈
          flashCard($('#feedback-panel'), 'success');
          launchConfetti(20);
        } else {
          showFeedbackMessage('提交失败: ' + resp.message + '。请重新选择诊断', 'danger');
          // 恢复按钮状态，允许用户重新选择
          $('#btn-next').prop('disabled', false).html('提交诊断选择 →').removeClass('btn-primary').addClass('btn-info');
        }
      },
      error: function(xhr, status, error) {
        console.log('=== 诊断提交失败 ===');
        console.log('错误状态:', status);
        console.log('错误信息:', error);
        console.log('响应状态码:', xhr.status);
        console.log('响应内容:', xhr.responseText);
        console.log('====================');
        
        $('#btn-next').prop('disabled', false).html('提交诊断选择 →').removeClass('btn-primary').addClass('btn-info');
        console.error('Submit diagnosis error:', error, xhr.responseText);
        
        if (xhr.status === 404) {
          showFeedbackMessage('API接口未找到，请检查后端配置。请重新选择诊断', 'danger');
        } else if (xhr.status === 403) {
          showFeedbackMessage('权限不足，请重新登录。请重新选择诊断', 'danger');
        } else if (xhr.status === 500) {
          showFeedbackMessage('服务器内部错误，请联系管理员。请重新选择诊断', 'danger');
        } else {
          showFeedbackMessage('网络错误，请检查连接: ' + error + '。请重新选择诊断', 'danger');
        }
      }
    });
  }

  
  // ==================== 治疗阶段：治疗决策 ====================
  
  function renderTreatmentStage(data) {
    clinicalSession.currentStage = 'treatment';
    
    // 如果这是从其他阶段导航回来的，不要清空选择数据
    // 只有在首次进入治疗阶段时才清空
    if (!clinicalSession.treatmentOptions || clinicalSession.treatmentOptions.length === 0) {
      clinicalSession.selectedTreatments = [];
    }
    
    updateClinicalProgress();
    updateStageProgress();
    
    $('#btn-next').prop('disabled', false).text('提交治疗方案 →').removeClass('btn-info').addClass('btn-success');
    updateStageCard('治疗决策阶段', 'treatment');
    
    var html = '<div class="treatment-stage">';
    
    // 诊断确认展示
    if (data.selected_diagnosis) {
      html += '<div class="diagnosis-confirmation mb-4">';
      html += '<h5 class="text-success"><i class="fas fa-check-circle"></i> 确认诊断</h5>';
      html += '<div class="card border-success">';
      html += '<div class="card-body">';
      html += '<h6>' + data.selected_diagnosis.name + '</h6>';
      if (data.selected_diagnosis.code) {
        html += '<small class="text-muted">ICD编码: ' + data.selected_diagnosis.code + '</small><br>';
      }
      if (data.selected_diagnosis.is_correct) {
        html += '<span class="badge badge-success">诊断正确</span>';
      } else {
        html += '<span class="badge badge-warning">需要进一步确认</span>';
      }
      html += '</div>';
      html += '</div>';
      html += '</div>';
    }
    
    // 治疗方案选择
    html += '<div class="treatment-options">';
    html += '<h4 class="text-success mb-4" style="font-weight: 700; font-size: 1.5rem;"><i class="fas fa-prescription-bottle-alt mr-2"></i>治疗方案选择</h4>';
    html += '<div class="alert alert-success" style="background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%); border: none; border-radius: 12px; padding: 20px;">';
    html += '<h5 class="mb-3" style="color: #155724; font-weight: 700; font-size: 1.2rem;"><i class="fas fa-medkit mr-2" style="color: #28a745;"></i>治疗决策指导</h5>';
    html += '<p class="mb-0" style="font-size: 1rem; line-height: 1.6; color: #155724;">基于确定的诊断，选择合适的治疗方案。考虑治疗的有效性、安全性、成本效益和患者个体情况。</p>';
    html += '</div>';
    
    // 缓存治疗选项数据
    if (data.treatment_options) {
      clinicalSession.treatmentOptions = data.treatment_options;
    }
    
    if (clinicalSession.treatmentOptions && clinicalSession.treatmentOptions.length > 0) {
      html += '<form id="treatment-form">';
      
      // 按治疗类型分组
      var groupedTreatments = groupTreatmentsByType(clinicalSession.treatmentOptions);
      
      Object.keys(groupedTreatments).forEach(function(type) {
        var typeOptions = groupedTreatments[type];
        var typeDisplayName = getTreatmentTypeDisplay(type);
        var typeIcon = getTreatmentTypeIcon(type);
        
        html += '<div class="treatment-group mb-4">';
        html += '<h5 class="text-primary mb-3" style="font-weight: 600; font-size: 1.1rem; border-bottom: 2px solid #007bff; padding-bottom: 8px;">';
        html += '<i class="' + typeIcon + ' mr-2" style="font-size: 1.2rem;"></i>' + typeDisplayName;
        html += '<small class="text-muted ml-2" style="font-size: 0.875rem;">(' + typeOptions.length + '项)</small>';
        html += '</h5>';
        
        html += '<div class="row">';
        typeOptions.forEach(function(option) {
          html += '<div class="col-md-6 mb-3">';
          html += '<div class="card treatment-option h-100';
          
          // 根据治疗适宜性添加样式类
          if (option.is_optimal) {
            html += ' optimal';
          } else if (option.is_contraindicated) {
            html += ' contraindicated';
          } else if (option.is_acceptable) {
            html += ' acceptable';
          }
          
          html += '" data-treatment-id="' + option.id + '">';
          html += '<div class="card-body">';
          
          html += '<div class="d-flex align-items-center mb-2">';
          html += '<input class="form-check-input treatment-checkbox mr-3" type="checkbox" ';
          html += 'value="' + option.id + '" id="treat_' + option.id + '" style="flex-shrink: 0; margin-top: 0;">';
          html += '<label class="form-check-label flex-grow-1" for="treat_' + option.id + '" style="cursor: pointer;">';
          html += '<div class="d-flex justify-content-between align-items-center">';
          html += '<strong style="font-size: 1.1rem; color: #2c3e50;">' + option.name + '</strong>';
          
          // 显示治疗特性标签
          html += '<div class="treatment-badges">';
          if (option.is_optimal) {
            html += '<span class="badge badge-success">最佳</span>';
          }
          if (option.is_contraindicated) {
            html += '<span class="badge badge-danger">禁忌</span>';
          }
          if (option.efficacy_score === 'high') {
            html += '<span class="badge badge-info">高效</span>';
          }
          html += '</div>';
          
          html += '</div>';
          html += '</label>';
          html += '</div>';
          if (option.description) {
            html += '<div class="text-muted small mb-2" style="margin-left: 2.5rem; font-size: 0.9rem; line-height: 1.4;">' + option.description + '</div>';
          }
          
          // 显示疗效和安全性信息
          html += '<div class="treatment-info" style="margin-left: 2.5rem;">';
          html += '<div class="row small text-muted" style="font-size: 0.875rem;">';
          html += '<div class="col-4"><i class="fas fa-chart-line mr-1 text-primary"></i>疗效: <span class="font-weight-bold">' + (option.efficacy_score || '中') + '</span></div>';
          html += '<div class="col-4"><i class="fas fa-shield-alt mr-1 text-success"></i>安全: <span class="font-weight-bold">' + (option.safety_score || '中') + '</span></div>';
          html += '<div class="col-4"><i class="fas fa-dollar-sign mr-1 text-warning"></i>成本: <span class="font-weight-bold">' + (option.cost_score || '中') + '</span></div>';
          html += '</div>';
          html += '</div>';
          
          // 预期结果
          if (option.expected_outcome) {
            html += '<div class="expected-outcome mt-2" style="margin-left: 2.5rem;">';
            html += '<small class="text-info" style="font-size: 0.875rem;"><i class="fas fa-bullseye mr-1"></i>预期结果: ' + option.expected_outcome + '</small>';
            html += '</div>';
          }
          html += '</div>';
          html += '</div>';
          html += '</div>';
        });
        html += '</div>';
        html += '</div>';
      });
      
      html += '</form>';
    } else {
      html += '<div class="alert alert-warning">暂无治疗方案数据</div>';
    }
    
    html += '</div>';
    
    // 添加治疗方案选择统计 - 改进排版
    html += '<div class="treatment-summary mt-4">';
    html += '<div class="card bg-light border-0 shadow-sm">';
    html += '<div class="card-body p-4">';
    html += '<h6 class="mb-3"><i class="fas fa-chart-pie text-primary me-2"></i> 治疗方案分析</h6>';
    
    // 使用更好的网格布局
    html += '<div class="row g-3">';
    
    // 已选方案
    html += '<div class="col-6 col-md-3">';
    html += '<div class="text-center p-3 bg-white rounded border">';
    html += '<div class="h4 mb-1 text-primary" id="selected-treatments-count">0</div>';
    html += '<small class="text-muted fw-500">已选方案</small>';
    html += '</div>';
    html += '</div>';
    
    // 最佳方案
    html += '<div class="col-6 col-md-3">';
    html += '<div class="text-center p-3 bg-white rounded border">';
    html += '<div class="h4 mb-1 text-success" id="optimal-treatments-count">0</div>';
    html += '<small class="text-muted fw-500">最佳方案</small>';
    html += '</div>';
    html += '</div>';
    
    // 综合疗效
    html += '<div class="col-6 col-md-3">';
    html += '<div class="text-center p-3 bg-white rounded border">';
    html += '<div class="h4 mb-1 text-warning" id="treatment-efficacy">--</div>';
    html += '<small class="text-muted fw-500">综合疗效</small>';
    html += '</div>';
    html += '</div>';
    
    // 安全评级
    html += '<div class="col-6 col-md-3">';
    html += '<div class="text-center p-3 bg-white rounded border">';
    html += '<div class="h4 mb-1 text-info" id="treatment-safety">--</div>';
    html += '<small class="text-muted fw-500">安全评级</small>';
    html += '</div>';
    html += '</div>';
    
    html += '</div>'; // row结束
    html += '</div>';
    html += '</div>';
    html += '</div>';
    
    html += '</div>';
    
    $('#stage-content').html(html);
    
    // 恢复之前的选择状态（如果有的话）
    if (clinicalSession.selectedTreatments && clinicalSession.selectedTreatments.length > 0) {
      clinicalSession.selectedTreatments.forEach(function(treatmentId) {
        var checkbox = $('#treat_' + treatmentId);
        if (checkbox.length) {
          checkbox.prop('checked', true);
          checkbox.closest('.treatment-option').addClass('selected');
        }
      });
      updateTreatmentSummary();
    }
    
    // 绑定治疗选择事件
    bindTreatmentEvents();
    showClinicalThinkingPrompt('treatment');
    
    // 确保按钮状态正确 - 治疗阶段按钮应始终可用
    setTimeout(function() {
      ensureButtonEnabled();
    }, 100);
  }
  
  function groupTreatmentsByType(options) {
    var grouped = {};
    options.forEach(function(option) {
      var type = option.type || 'medication';
      if (!grouped[type]) {
        grouped[type] = [];
      }
      grouped[type].push(option);
    });
    return grouped;
  }
  
  function getTreatmentTypeDisplay(type) {
    var displays = {
      'medication': '药物治疗',
      'surgery': '手术治疗',
      'observation': '观察随访',
      'referral': '转诊治疗',
      'education': '健康教育'
    };
    return displays[type] || type;
  }
  
  function getTreatmentTypeIcon(type) {
    var icons = {
      'medication': 'fas fa-pills',
      'surgery': 'fas fa-scalpel-path',
      'observation': 'fas fa-eye',
      'referral': 'fas fa-hospital',
      'education': 'fas fa-graduation-cap'
    };
    return icons[type] || 'fas fa-medical-kit';
  }
  
  function bindTreatmentEvents() {
    $('.treatment-checkbox').off('change').on('change', function() {
      var $card = $(this).closest('.treatment-option');
      var treatmentId = parseInt($(this).val());
      
      if ($(this).is(':checked')) {
        $card.addClass('selected');
        clinicalSession.selectedTreatments.push(treatmentId);
        addToLearningTimeline('选择治疗', $(this).siblings('label').find('strong').text());
      } else {
        $card.removeClass('selected');
        var index = clinicalSession.selectedTreatments.indexOf(treatmentId);
        if (index > -1) {
          clinicalSession.selectedTreatments.splice(index, 1);
        }
      }
      
      updateTreatmentSummary();
      provideLiveTreatmentFeedback();
    });
    
    $('.treatment-option').on('click', function(e) {
      if (e.target.type !== 'checkbox') {
        var checkbox = $(this).find('.treatment-checkbox');
        checkbox.prop('checked', !checkbox.prop('checked')).trigger('change');
      }
    });
  }
  
  function updateTreatmentSummary() {
    // 直接从DOM获取实际选择状态，避免会话数据污染
    var $checkedTreatments = $('.treatment-checkbox:checked');
    var selectedCount = $checkedTreatments.length;
    var optimalCount = 0;
    var efficacyScores = [];
    var safetyScores = [];
    
    // 同时更新会话数据以保持一致性
    clinicalSession.selectedTreatments = [];
    
    $checkedTreatments.each(function() {
      var treatmentId = $(this).val();
      var $card = $(this).closest('.treatment-option');
      
      // 更新会话数据
      clinicalSession.selectedTreatments.push(parseInt(treatmentId));
      
      if ($card.find('.badge-success').length > 0) {
        optimalCount++;
      }
      
      // 简单的评分逻辑
      var efficacyText = $card.find('.treatment-info').text();
      if (efficacyText.includes('疗效: 高')) efficacyScores.push(3);
      else if (efficacyText.includes('疗效: 中')) efficacyScores.push(2);
      else efficacyScores.push(1);
      
      if (efficacyText.includes('安全: 高')) safetyScores.push(3);
      else if (efficacyText.includes('安全: 中')) safetyScores.push(2);
      else safetyScores.push(1);
    });
    
    // 计算平均疗效和安全性
    var avgEfficacy = efficacyScores.length > 0 ? efficacyScores.reduce((a, b) => a + b, 0) / efficacyScores.length : 0;
    var avgSafety = safetyScores.length > 0 ? safetyScores.reduce((a, b) => a + b, 0) / safetyScores.length : 0;
    
    var efficacyLevel = avgEfficacy >= 2.5 ? '高' : avgEfficacy >= 1.5 ? '中' : '低';
    var safetyLevel = avgSafety >= 2.5 ? '高' : avgSafety >= 1.5 ? '中' : '低';
    
    $('#selected-treatments-count').text(selectedCount);
    $('#optimal-treatments-count').text(optimalCount);
    $('#treatment-efficacy').text(efficacyLevel);
    $('#treatment-safety').text(safetyLevel);
  }
  
  function provideLiveTreatmentFeedback() {
    var selectedCount = clinicalSession.selectedTreatments.length;
    var feedback = '';
    
    if (selectedCount === 0) {
      feedback = '<div class="alert alert-info">请开始选择治疗方案</div>';
    } else if (selectedCount === 1) {
      feedback = '<div class="alert alert-warning">考虑是否需要联合治疗</div>';
    } else if (selectedCount > 5) {
      feedback = '<div class="alert alert-danger">治疗方案过多可能增加副作用风险</div>';
    } else {
      feedback = '<div class="alert alert-success">治疗方案选择合理</div>';
    }
    
    $('#feedback-panel').html(feedback);
  }

  function submitTreatments() {
    // 显示提交中状态
    $('#btn-next').prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i> 提交中...');
    showFeedbackMessage('正在提交治疗方案...', 'info');
    
    // 准备提交数据
    var submitData = {
      case_id: clinicalSession.caseId,
      selected_treatments: clinicalSession.selectedTreatments,
      reasoning: $('#clinical-notes').val() || ''
    };
    
    $.ajax({
      url: '/api/clinical/submit-treatments/',
      method: 'POST',
      contentType: 'application/json',
      headers: {
        'X-CSRFToken': $('[name=csrfmiddlewaretoken]').val() || getCsrfToken()
      },
      data: JSON.stringify(submitData),
      success: function(resp) {
        $('#btn-next').prop('disabled', false).html('完成学习 <i class="fas fa-check"></i>');
        
        if (resp.success) {
          // 记录治疗阶段完成
          addToLearningTimeline('完成治疗选择', '选择了 ' + clinicalSession.selectedTreatments.length + ' 种治疗方案');
          
          // 更新分数
          if (resp.data.treatment_score !== undefined) {
            clinicalSession.scores.treatment = resp.data.treatment_score;
          }
          
          // 计算总分
          if (resp.data.scores && resp.data.scores.overall_score !== undefined) {
            clinicalSession.scores.overall = resp.data.scores.overall_score;
            $('#current-score').text(resp.data.scores.overall_score.toFixed(1));
          }
          
          // 进入反馈阶段
          clinicalSession.currentStage = 'feedback';
          updateClinicalProgress();
          showFinalFeedback(resp.data);
          // 视觉与动画反馈
          flashCard($('#stage-content'), 'success');
          launchConfetti(40);
        } else {
          showFeedbackMessage('提交失败: ' + resp.message + '。请重新选择治疗方案', 'danger');
          // 恢复按钮状态，允许用户重新选择
          $('#btn-next').prop('disabled', false).html('提交治疗方案 →').removeClass('btn-primary').addClass('btn-success');
        }
      },
      error: function(xhr, status, error) {
        $('#btn-next').prop('disabled', false).html('提交治疗方案 →').removeClass('btn-primary').addClass('btn-success');
        console.error('Submit treatment error:', error, xhr.responseText);
        
        if (xhr.status === 404) {
          showFeedbackMessage('API接口未找到，请检查后端配置。请重新选择治疗方案', 'danger');
        } else if (xhr.status === 403) {
          showFeedbackMessage('权限不足，请重新登录。请重新选择治疗方案', 'danger');
        } else if (xhr.status === 500) {
          showFeedbackMessage('服务器内部错误，请联系管理员。请重新选择治疗方案', 'danger');
        } else {
          showFeedbackMessage('网络错误，请检查连接: ' + error + '。请重新选择治疗方案', 'danger');
        }
      }
    });
  }

  function showFinalFeedback(data) {
    clinicalSession.currentStage = 'feedback';
    updateClinicalProgress();
    updateStageProgress();
    
    updateStageCard('学习完成', 'complete');
    
    // 显示最终反馈
    var feedbackHtml = '<div class="alert alert-success feedback-animation">';
    feedbackHtml += '<h6><i class="fas fa-trophy"></i> 学习完成！</h6>';
    feedbackHtml += (data.overall_feedback || '恭喜您完成了本次临床推理学习！');
    feedbackHtml += '</div>';
    $('#feedback-panel').html(feedbackHtml);
    
    // 构建最终学习总结页面
    var html = '<div class="final-feedback text-center">';
    
    // 标题
    html += '<div class="completion-header mb-4">';
    html += '<h3 class="text-success"><i class="fas fa-graduation-cap"></i> 临床推理学习完成</h3>';
    html += '<p class="text-muted">您已成功完成本案例的完整临床推理过程</p>';
    html += '</div>';
    
    // 成绩展示
    html += '<div class="row mb-4">';
    
    // 总体得分
    html += '<div class="col-md-6 offset-md-3">';
    html += '<div class="card border-success">';
    html += '<div class="card-body text-center">';
    html += '<h4 class="text-success">总体得分</h4>';
    var overallScore = (data.scores && data.scores.overall_score) ? data.scores.overall_score : clinicalSession.scores.overall;
    html += '<div class="display-3 text-primary font-weight-bold">' + (overallScore ? overallScore.toFixed(1) : '0.0') + '</div>';
    html += '<p class="text-muted">满分 100 分</p>';
    
    // 评级
    var grade = 'A';
    var gradeColor = 'success';
    if (overallScore < 60) {
      grade = 'D'; gradeColor = 'danger';
    } else if (overallScore < 70) {
      grade = 'C'; gradeColor = 'warning';
    } else if (overallScore < 85) {
      grade = 'B'; gradeColor = 'info';
    }
    html += '<h5><span class="badge badge-' + gradeColor + ' p-2">' + grade + ' 级</span></h5>';
    html += '</div>';
    html += '</div>';
    html += '</div>';
    html += '</div>';
    
    // 分项得分
    html += '<div class="row mb-4">';
    html += '<div class="col-md-12">';
    html += '<div class="card">';
    html += '<div class="card-body">';
    html += '<h5 class="card-title"><i class="fas fa-chart-bar"></i> 分项成绩</h5>';
    html += '<div class="row text-center">';
    
    html += '<div class="col-4">';
    html += '<div class="score-item">';
    html += '<div class="h4 text-warning">' + (clinicalSession.scores.examination || 0).toFixed(1) + '</div>';
    html += '<small class="text-muted">检查选择 (30%)</small>';
    html += '</div>';
    html += '</div>';
    
    html += '<div class="col-4">';
    html += '<div class="score-item">';
    html += '<div class="h4 text-info">' + (clinicalSession.scores.diagnosis || 0).toFixed(1) + '</div>';
    html += '<small class="text-muted">诊断准确性 (50%)</small>';
    html += '</div>';
    html += '</div>';
    
    html += '<div class="col-4">';
    html += '<div class="score-item">';
    html += '<div class="h4 text-success">' + (clinicalSession.scores.treatment || 0).toFixed(1) + '</div>';
    html += '<small class="text-muted">治疗方案 (20%)</small>';
    html += '</div>';
    html += '</div>';
    
    html += '</div>';
    html += '</div>';
    html += '</div>';
    html += '</div>';
    html += '</div>';
    
    // 学习总结
    if (data.overall_feedback || data.improvement_suggestions) {
      html += '<div class="row mb-4">';
      html += '<div class="col-md-12">';
      html += '<div class="card">';
      html += '<div class="card-body text-left">';
      html += '<h5 class="card-title"><i class="fas fa-lightbulb"></i> 学习总结</h5>';
      if (data.overall_feedback) {
        html += '<p>' + data.overall_feedback + '</p>';
      }
      if (data.improvement_suggestions) {
        html += '<h6 class="text-primary">改进建议：</h6>';
        html += '<p>' + data.improvement_suggestions + '</p>';
      }
      html += '</div>';
      html += '</div>';
      html += '</div>';
      html += '</div>';
    }
    
    // 操作按钮 - 撑满整行并居中
    html += '<div class="action-buttons mt-4">';
    html += '<div class="d-flex justify-content-center align-items-center">';
    html += '<div class="d-flex w-100" style="max-width: 600px;">';
    html += '<button class="btn btn-outline-primary flex-fill mx-2" onclick="location.reload()">';
    html += '<i class="fas fa-redo"></i> 重新学习';
    html += '</button>';
    html += '<a href="/student/clinical-cases/" class="btn btn-outline-secondary flex-fill mx-2">';
    html += '<i class="fas fa-list"></i> 返回案例列表';
    html += '</a>';
    html += '<a href="/student/" class="btn btn-outline-success flex-fill mx-2">';
    html += '<i class="fas fa-home"></i> 返回首页';
    html += '</a>';
    html += '</div>';
    html += '</div>';
    html += '</div>';
    
    html += '</div>';
    
    $('#stage-content').html(html);
    
    // 完全重构导航卡片以显示完成状态
    var completionNavHtml = '<div class="card-body">';
    completionNavHtml += '<div class="text-center">';
    completionNavHtml += '<div style="padding: 20px; background: linear-gradient(135deg, #d4edda, #c3e6cb); border-radius: 10px; border: 2px solid #28a745; box-shadow: 0 4px 8px rgba(40, 167, 69, 0.2);">';
    completionNavHtml += '<i class="fas fa-check-circle text-success me-2" style="font-size: 1.2em;"></i>';
    completionNavHtml += '<span class="text-success fw-bold" style="font-size: 1.1em;">临床推理进度已经完成</span>';
    completionNavHtml += '<div class="mt-3">';
    completionNavHtml += '<div style="width: 350px; height: 15px; background-color: #e9ecef; border-radius: 10px; margin: 0 auto; overflow: hidden; border: 1px solid #28a745;">';
    completionNavHtml += '<div style="width: 100%; height: 100%; background: linear-gradient(90deg, #28a745, #20c997); border-radius: 10px; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 0.8em;">';
    completionNavHtml += '100%';
    completionNavHtml += '</div>';
    completionNavHtml += '</div>';
    completionNavHtml += '<small class="text-success mt-2 d-block fw-bold">学习完成</small>';
    completionNavHtml += '</div>';
    completionNavHtml += '</div>';
    completionNavHtml += '</div>';
    completionNavHtml += '</div>';
    
    $('#navigation-card').html(completionNavHtml);
    
    // 清除保存的进度
    localStorage.removeItem('clinical_progress_' + clinicalSession.caseId);
    
    // 记录完成时间
    clinicalSession.timeSpent.total = new Date() - clinicalSession.startTime;
    addToLearningTimeline('完成学习', '总用时: ' + Math.floor(clinicalSession.timeSpent.total / 60000) + ' 分钟');
  }

  // ==================== 动画与视觉效果 ====================
  
  // 简单 confetti 效果（无外部库，轻量）
  function launchConfetti(count) {
    count = count || 30;
    for (var i = 0; i < count; i++) {
      (function() {
        var conf = document.createElement('div');
        conf.className = 'confetti-piece';
        var size = Math.floor(Math.random() * 8) + 6;
        conf.style.width = size + 'px';
        conf.style.height = (size * 0.6) + 'px';
        conf.style.background = ['#28a745','#007bff','#ffc107','#dc3545','#6610f2'][Math.floor(Math.random() * 5)];
        conf.style.position = 'fixed';
        conf.style.zIndex = 9999;
        conf.style.left = (Math.random() * window.innerWidth) + 'px';
        conf.style.top = '-20px';
        conf.style.opacity = Math.random() * 0.9 + 0.1;
        conf.style.transform = 'rotate(' + (Math.random() * 360) + 'deg)';
        conf.style.pointerEvents = 'none';
        document.body.appendChild(conf);
        var endY = window.innerHeight + 100 + Math.random() * 200;
        var duration = 1000 + Math.random() * 1200;
        conf.animate([
          { transform: conf.style.transform + ' translateY(0px)', opacity: conf.style.opacity },
          { transform: conf.style.transform + ' translateY(' + endY + 'px)', opacity: 0.6 }
        ], { duration: duration, easing: 'cubic-bezier(.2,.8,.2,1)' });
        setTimeout(function() { conf.remove(); }, duration + 200);
      })();
    }
  }

  // 卡片高亮跳动，用于强调成功/错误
  function flashCard($el, type) {
    var cls = (type === 'success') ? 'flash-success' : 'flash-warning';
    $el.addClass(cls);
    setTimeout(function() { $el.removeClass(cls); }, 900);
  }

  // 步骤闪光（短暂放大、光晕）
  function highlightStep(stepName) {
    var $step = $('.stepper-item[data-step="' + stepName + '"]');
    $step.addClass('step-highlight');
    setTimeout(function() { $step.removeClass('step-highlight'); }, 800);
  }


  
  // ==================== 检查选项统计功能 ====================
  
  function showExaminationStats() {
    if (!clinicalSession.examinationStats) return;
    
    var stats = clinicalSession.examinationStats;
    var message = '';
    
    if (stats.mode === 'mixed') {
      message = '🎯 检查项目已为您智能组合，包含重点项目和辅助选项，请仔细评估每项检查的价值';
      showFeedbackMessage(message, 'examination-stats');
    } else {
      message = '📋 已为您加载该案例的所有检查选项，共 ' + stats.totalCount + ' 项';
      showFeedbackMessage(message, 'info');
    }
  }
  
  // ==================== 通用功能函数 ====================
  
  function showClinicalThinkingPrompt(stage) {
    var prompts = {
      'history': '思考：患者的症状特点是什么？可能的病因有哪些？需要重点关注什么？',
      'examination': '思考：基于病史，哪些检查最有助于明确诊断？如何平衡诊断价值和成本？',
      'diagnosis': '思考：检查结果支持哪些诊断？如何进行鉴别诊断？概率最高的是什么？',
      'treatment': '思考：针对确定的诊断，最佳治疗方案是什么？如何评估风险获益比？',
      'feedback': '思考：回顾整个诊疗过程，有哪些值得总结的经验？'
    };
    
    if (prompts[stage]) {
      showFeedbackMessage(prompts[stage], 'guidance');
    }
  }
  
  function showFeedbackMessage(message, type = 'info') {
    var alertClass = {
      'info': 'alert-info',
      'success': 'alert-success feedback-positive',
      'warning': 'alert-warning feedback-corrective', 
      'danger': 'alert-danger',
      'guidance': 'alert-info feedback-guidance',
      'examination-stats': 'alert-secondary'
    }[type] || 'alert-info';
    
    var icon = {
      'info': 'fas fa-info-circle',
      'success': 'fas fa-check-circle',
      'warning': 'fas fa-exclamation-triangle',
      'danger': 'fas fa-times-circle',
      'guidance': 'fas fa-lightbulb',
      'examination-stats': 'fas fa-chart-bar'
    }[type] || 'fas fa-info-circle';
    
    var html = '<div class="alert ' + alertClass + ' feedback-animation">';
    html += '<i class="' + icon + '"></i> ' + message;
    html += '</div>';
    
    $('#feedback-panel').html(html);
    
    // 记录反馈历史
    clinicalSession.feedbackHistory.push({
      timestamp: new Date(),
      stage: clinicalSession.currentStage,
      message: message,
      type: type
    });
  }
  
  function showErrorMessage(message) {
    showFeedbackMessage('错误：' + message, 'danger');
  }
  
  function addToLearningTimeline(action, detail) {
    var timestamp = new Date().toLocaleTimeString();
    var html = '<div class="timeline-item">';
    html += '<div class="d-flex justify-content-between">';
    html += '<strong>' + action + '</strong>';
    html += '<small class="text-muted">' + timestamp + '</small>';
    html += '</div>';
    html += '<div class="text-muted small">' + detail + '</div>';
    html += '</div>';
    
    $('#learning-timeline').prepend(html);
    
    // 保持最多显示10条记录
    var items = $('#learning-timeline .timeline-item');
    if (items.length > 10) {
      items.slice(10).remove();
    }
  }
  
  function initializeClinicalRecordTabs() {
    // 手动实现标签切换功能（替代Bootstrap的pill功能）
    console.log('初始化临床记录标签...');
    
    // 确保初始状态正确
    $('#notes-tab').addClass('active');
    $('#notes-panel').addClass('show active');
    $('#timeline-panel').removeClass('show active');
    
    // 绑定点击事件
    $('#clinical-tabs a').off('click').on('click', function(e) {
      e.preventDefault();
      console.log('点击标签:', $(this).text());
      
      var $this = $(this);
      var targetPanel = $this.attr('href');
      
      // 如果点击的是当前激活的标签，不做任何操作
      if ($this.hasClass('active')) {
        return;
      }
      
      // 移除所有标签的active状态
      $('#clinical-tabs a').removeClass('active');
      // 添加当前标签的active状态
      $this.addClass('active');
      
      // 隐藏所有面板
      $('.tab-pane').removeClass('show active').hide();
      
      // 显示目标面板
      $(targetPanel).addClass('show active').fadeIn(300);
      
      console.log('成功切换到标签:', targetPanel);
    });
    
    console.log('标签初始化完成');
  }
  
  function updateTimeSpent() {
    var now = new Date();
    var elapsed = Math.floor((now - clinicalSession.startTime) / 1000); // 秒
    var minutes = Math.floor(elapsed / 60);
    var seconds = elapsed % 60;
    
    var timeStr = String(minutes).padStart(2, '0') + ':' + String(seconds).padStart(2, '0');
    $('#time-spent').text(timeStr);
  }
  
  function updateStageProgress() {
    var stages = clinicalSession.stages;
    var currentIndex = stages.indexOf(clinicalSession.currentStage);
    var progress = Math.round(((currentIndex + 1) / stages.length) * 100);
    
    // 使用统一的进度更新函数
    updateNavigationProgress();
    $('#current-stage-text').text(getStageDisplayName(clinicalSession.currentStage));
  }
  
  function getStageDisplayName(stage) {
    var names = {
      'history': '病史采集',
      'examination': '检查选择',
      'diagnosis': '诊断推理',
      'treatment': '治疗决策',
      'feedback': '学习反馈'
    };
    return names[stage] || stage;
  }
  
  function saveCurrentProgress() {
    // 保存当前学习进度到本地存储（保持兼容性）
    var progressData = {
      caseId: clinicalSession.caseId,
      stage: clinicalSession.currentStage,
      selectedExaminations: clinicalSession.selectedExaminations,
      selectedDiagnosis: clinicalSession.selectedDiagnosis,
      selectedTreatments: clinicalSession.selectedTreatments,
      notes: $('#clinical-notes').val(),
      timestamp: new Date().toISOString()
    };
    
    localStorage.setItem('clinical_progress_' + clinicalSession.caseId, JSON.stringify(progressData));
  }
  
  function saveClinicalNotesToDB() {
    // 保存临床笔记到数据库
    var notes = $('#clinical-notes').val();
    
    // 显示保存中状态
    showNotesSaveStatus('<i class="fas fa-spinner fa-spin"></i> 保存中...', 'info');
    
    $.ajax({
      url: '/api/clinical/notes/save/',
      method: 'POST',
      contentType: 'application/json',
      headers: {
        'X-CSRFToken': $('[name=csrfmiddlewaretoken]').val() || getCsrfToken()
      },
      data: JSON.stringify({
        case_id: clinicalSession.caseId,
        notes: notes
      }),
      success: function(resp) {
        if (resp.success) {
          // 显示保存成功提示
          showNotesSaveStatus('<i class="fas fa-check-circle"></i> 已保存 (' + resp.data.save_time + ')', 'success');
          
          // 更新字数统计
          updateNotesCharCount();
          
          // 添加视觉反馈 - 文本框短暂高亮
          $('#clinical-notes').addClass('notes-saved-flash');
          setTimeout(function() {
            $('#clinical-notes').removeClass('notes-saved-flash');
          }, 1000);
        } else {
          showNotesSaveStatus('<i class="fas fa-exclamation-triangle"></i> 保存失败', 'error');
        }
      },
      error: function(xhr, status, error) {
        console.log('保存笔记失败:', error);
        showNotesSaveStatus('<i class="fas fa-exclamation-circle"></i> 保存失败', 'error');
      }
    });
  }
  
  function loadClinicalNotesFromDB() {
    // 从数据库加载临床笔记
    $.ajax({
      url: '/api/clinical/notes/' + clinicalSession.caseId + '/',
      method: 'GET',
      success: function(resp) {
        if (resp.success && resp.data.notes) {
          $('#clinical-notes').val(resp.data.notes);
          updateNotesCharCount();
          
          if (resp.data.last_updated) {
            showNotesSaveStatus('<i class="fas fa-cloud-download-alt"></i> 已加载 (上次更新: ' + resp.data.last_updated + ')', 'info');
          } else {
            showNotesSaveStatus('<i class="fas fa-cloud-download-alt"></i> 已加载历史笔记', 'info');
          }
          
          // 5秒后清除加载状态
          setTimeout(function() {
            $('#notes-save-status').fadeOut(500);
          }, 5000);
        } else {
          // 没有保存的笔记，显示欢迎信息
          updateNotesCharCount();
          showNotesSaveStatus('<i class="fas fa-edit"></i> 开始记录您的临床思考', 'info');
          setTimeout(function() {
            $('#notes-save-status').fadeOut(500);
          }, 3000);
        }
      },
      error: function(xhr, status, error) {
        console.log('加载笔记失败:', error);
        updateNotesCharCount();
        showNotesSaveStatus('<i class="fas fa-exclamation-triangle"></i> 加载笔记失败', 'error');
      }
    });
  }
  
  function showNotesSaveStatus(message, type) {
    // 显示笔记保存状态
    var $status = $('#notes-save-status');
    
    // 清除之前的淡出定时器
    if (window.notesStatusTimeout) {
      clearTimeout(window.notesStatusTimeout);
    }
    
    // 显示新状态
    $status.stop(true, true).show();
    $status.html(message);
    
    // 根据类型设置样式
    $status.removeClass('text-success text-danger text-info text-warning');
    switch (type) {
      case 'success':
        $status.addClass('text-success');
        break;
      case 'error':
        $status.addClass('text-danger');
        break;
      case 'warning':
        $status.addClass('text-warning');
        break;
      default:
        $status.addClass('text-info');
    }
    
    // 对于成功和错误状态，设置自动淡出
    if (type === 'success' || type === 'error') {
      window.notesStatusTimeout = setTimeout(function() {
        $status.fadeOut(1000);
      }, 3000);
    }
  }
  
  function updateNotesCharCount() {
    // 更新字数统计
    var notes = $('#clinical-notes').val();
    var charCount = notes.length;
    $('#notes-char-count').text(charCount + ' 字');
    
    // 根据字数给出颜色提示
    var $counter = $('#notes-char-count');
    $counter.removeClass('text-muted text-info text-warning text-danger');
    
    if (charCount === 0) {
      $counter.addClass('text-muted');
    } else if (charCount < 50) {
      $counter.addClass('text-info');
    } else if (charCount < 200) {
      $counter.addClass('text-success');
    } else if (charCount < 500) {
      $counter.addClass('text-warning');
    } else {
      $counter.addClass('text-danger');
    }
  }
  
  function loadSavedProgress() {
    // 尝试加载之前保存的进度
    var saved = localStorage.getItem('clinical_progress_' + clinicalSession.caseId);
    if (saved) {
      try {
        var progressData = JSON.parse(saved);
        // 如果是当天的进度，则恢复
        var savedTime = new Date(progressData.timestamp);
        var now = new Date();
        if (now.toDateString() === savedTime.toDateString()) {
          return progressData;
        }
      } catch (e) {
        console.log('Failed to load saved progress:', e);
      }
    }
    return null;
  }
  
  // ==================== 主程序入口和事件绑定 ====================
  
  // 更新阶段卡片样式和内容
  function updateStageCard(stageName, stageKey) {
    const stageConfig = {
      'history': {
        text: '病史采集阶段',
        icon: 'fas fa-clipboard-list',
        textColor: 'text-success',
        cardClass: 'stage-history'
      },
      'examination': {
        text: '检查选择阶段', 
        icon: 'fas fa-stethoscope',
        textColor: 'text-warning',
        cardClass: 'stage-examination'
      },
      'diagnosis': {
        text: '诊断推理阶段',
        icon: 'fas fa-brain',
        textColor: 'text-purple',
        cardClass: 'stage-diagnosis'
      },
      'treatment': {
        text: '治疗决策阶段',
        icon: 'fas fa-pills',
        textColor: 'text-info',
        cardClass: 'stage-treatment'
      },
      'complete': {
        text: '学习完成',
        icon: 'fas fa-check-circle',
        textColor: 'text-success',
        cardClass: 'stage-complete'
      }
    };
    
    const config = stageConfig[stageKey] || stageConfig['history'];
    const $stageBadge = $('#current-stage-badge');
    const $stageCard = $stageBadge.closest('.stage-info-card');
    
    // 更新文字和图标
    $stageBadge.text(config.text)
              .removeClass()
              .addClass('fw-bold ' + config.textColor)
              .css('font-size', '0.9rem');
    
    // 更新卡片样式
    $stageCard.removeClass('stage-history stage-examination stage-diagnosis stage-treatment stage-complete')
              .addClass(config.cardClass);
    
    // 更新图标
    $stageCard.find('i').removeClass().addClass(config.icon + ' me-2').css('font-size', '0.9em');
    
    // 更新图标颜色
    const iconColorClass = config.textColor.replace('text-', '');
    if (iconColorClass === 'purple') {
      $stageCard.find('i').removeClass().addClass(config.icon + ' me-2').css({'font-size': '0.9em', 'color': '#9c27b0'});
    } else {
      $stageCard.find('i').removeClass().addClass(config.icon + ' ' + config.textColor + ' me-2').css('font-size', '0.9em');
    }
  }

  // 进度条更新函数
  function updateNavigationProgress() {
    const stageMapping = {
      'history': 1,
      'examination': 2, 
      'diagnosis': 3,
      'treatment': 4,
      'feedback': 4
    };
    
    const totalSteps = 4;
    const currentStepNum = stageMapping[clinicalSession.currentStage] || 1;
    const progressPercent = Math.round((currentStepNum / totalSteps) * 100);
    
    // 更新进度条
    const progressBar = document.getElementById('overall-progress');
    if (progressBar) {
      progressBar.style.width = progressPercent + '%';
      progressBar.textContent = progressPercent + '%';
      progressBar.setAttribute('aria-valuenow', progressPercent);
      
      // 根据进度调整颜色
      let gradient;
      if (progressPercent <= 25) {
        gradient = 'linear-gradient(90deg, #dc3545, #c82333)'; // 红色
      } else if (progressPercent <= 50) {
        gradient = 'linear-gradient(90deg, #ffc107, #e0a800)'; // 黄色
      } else if (progressPercent <= 75) {
        gradient = 'linear-gradient(90deg, #007bff, #0056b3)'; // 蓝色
      } else {
        gradient = 'linear-gradient(90deg, #28a745, #20c997)'; // 绿色
      }
      progressBar.style.background = gradient;
    }
    
    // 更新进度文本
    const progressText = document.getElementById('progress-text');
    if (progressText) {
      progressText.textContent = `步骤 ${currentStepNum}/${totalSteps} (${progressPercent}%)`;
    }
  }
  
  $(document).ready(function() {
    // 初始化临床记录标签切换功能
    initializeClinicalRecordTabs();
    
    // 初始化时间显示更新
    setInterval(updateTimeSpent, 1000);
    
    // 加载保存的临床笔记
    loadClinicalNotesFromDB();
    
    // 清空可能的历史进度数据，避免污染
    localStorage.removeItem('clinical_progress_' + clinicalSession.caseId);
    
    // 确保会话数据干净初始化
    clinicalSession.selectedExaminations = [];
    clinicalSession.selectedTreatments = [];
    clinicalSession.selectedDiagnosis = null;
    
    // 尝试恢复之前的学习进度（已禁用，避免数据污染）
    /*
    var savedProgress = loadSavedProgress();
    if (savedProgress && confirm('检测到之前的学习进度，是否继续之前的学习？')) {
      // 恢复进度逻辑
      clinicalSession.currentStage = savedProgress.stage;
      clinicalSession.selectedExaminations = savedProgress.selectedExaminations || [];
      clinicalSession.selectedDiagnosis = savedProgress.selectedDiagnosis;
      clinicalSession.selectedTreatments = savedProgress.selectedTreatments || [];
      $('#clinical-notes').val(savedProgress.notes || '');
    }
    */
    
    // 开始病史阶段
    initializeHistoryStage();
    
    // 初始化进度显示
    updateNavigationProgress();
    
    // 紧急修复：强制确保按钮可用
    setTimeout(function() {
      ensureButtonEnabled();
    }, 500);
    
    // 绑定导航按钮事件
    $('#btn-next').on('click', function() {
      debugButtonStatus();
      
      if ($(this).prop('disabled')) {
        console.log('按钮被禁用，强制启用!');
        ensureButtonEnabled();
        return false;
      }
      
      handleNextStage();
    });

    $('#btn-prev').on('click', function() {
      handlePreviousStage();
    });
    
    // 绑定临床笔记自动保存到数据库和字数统计
    $('#clinical-notes').on('input', function() {
      updateNotesCharCount();
      clearTimeout(window.notesSaveTimeout);
      window.notesSaveTimeout = setTimeout(saveClinicalNotesToDB, 2000);
    });
    
    // 绑定笔记字段的焦点事件，实时更新字数
    $('#clinical-notes').on('focus', function() {
      updateNotesCharCount();
    });
    
    // 页面离开时保存进度
    $(window).on('beforeunload', function() {
      saveCurrentProgress();
    });
  });
  
  function handleNextStage() {
    var currentStage = clinicalSession.currentStage;
    
    switch (currentStage) {
      case 'history':
        // 记录病史阶段用时
        clinicalSession.timeSpent.history = new Date() - clinicalSession.timeSpent.history;
        loadExaminationStage();
        break;
        
      case 'examination':
        if (!clinicalSession.isExaminationConfirmed) {
          // 第一次点击：确认检查选择
          if (clinicalSession.selectedExaminations.length === 0) {
            showFeedbackMessage('请至少选择一项检查', 'warning');
            return;
          }
          confirmExaminationSelection();
        } else {
          // 检查已确认，显示检查结果
          if (clinicalSession.currentExaminationIndex < clinicalSession.examinationOrder.length) {
            // 隐藏眼底字幕（如果存在）
            if ($('#fundus-overlay').length) {
              hideFundusSubtitle();
            }
            showNextExaminationResult();
          } else {
            // 所有检查结果已查看完毕，进入诊断阶段
            // 隐藏眼底字幕（如果存在）
            if ($('#fundus-overlay').length) {
              hideFundusSubtitle();
            }
            submitExaminations();
          }
        }
        break;
        
      case 'diagnosis':
        console.log('=== handleNextStage - 诊断阶段 ===');
        console.log('当前选中诊断ID:', clinicalSession.selectedDiagnosis);
        
        // 隐藏眼底字幕（如果存在）
        if ($('#fundus-overlay').length) {
          hideFundusSubtitle();
        }
        if (!clinicalSession.selectedDiagnosis) {
          console.log('没有选择诊断，显示警告');
          showFeedbackMessage('请先选择一个诊断选项，然后再提交', 'warning');
          return;
        }
        console.log('开始调用submitDiagnosis()');
        submitDiagnosis();
        break;
        
      case 'treatment':
        // 隐藏眼底字幕（如果存在）
        if ($('#fundus-overlay').length) {
          hideFundusSubtitle();
        }
        if (clinicalSession.selectedTreatments.length === 0) {
          showFeedbackMessage('请先选择至少一种治疗方案，然后再提交', 'warning');
          return;
        }
        submitTreatments();
        break;
        
      default:
        showFeedbackMessage('当前阶段无法继续', 'warning');
    }
    
    // 更新导航进度
    updateNavigationProgress();
  }
  
  function handlePreviousStage() {
    var currentStage = clinicalSession.currentStage;
    var stages = clinicalSession.stages;
    var currentIndex = stages.indexOf(currentStage);
    
    if (currentIndex > 0) {
      var previousStage = stages[currentIndex - 1];
      
      // 隐藏眼底字幕（如果存在）
      if ($('#fundus-overlay').length) {
        hideFundusSubtitle();
      }
      
      // 更新当前阶段
      clinicalSession.currentStage = previousStage;
      
      // 根据目标阶段执行相应的加载逻辑
      switch (previousStage) {
        case 'history':
          initializeHistoryStage();
          break;
          
        case 'examination':
          loadExaminationStage();
          // 恢复检查选择状态
          if (clinicalSession.selectedExaminations.length > 0) {
            // 如果之前已经选择了检查，恢复到选择确认状态
            setTimeout(function() {
              updateExaminationOrderList();
              clinicalSession.selectedExaminations.forEach(function(examId) {
                $('.examination-checkbox[value="' + examId + '"]').prop('checked', true);
              });
              updateExaminationSummary();
            }, 100);
          }
          break;
          
        case 'diagnosis':
          // 重新加载诊断阶段，需要从后端获取诊断选项
          loadDiagnosisStage();
          break;
          
        case 'treatment':
          // 重新加载治疗阶段
          loadTreatmentStage();
          break;
          
        default:
          showFeedbackMessage('无法返回到指定阶段', 'warning');
          return;
      }
      
      // 提供用户反馈
      showFeedbackMessage('已返回到' + getStageDisplayName(previousStage) + '阶段', 'info');
      
      // 记录到学习时间线
      addToLearningTimeline('返回上一阶段', '从' + getStageDisplayName(currentStage) + '返回到' + getStageDisplayName(previousStage));
    } else {
      showFeedbackMessage('已经是第一个阶段，无法返回', 'warning');
    }
    
    // 更新导航进度和按钮状态
    updateNavigationProgress();
  }
  
  // 获取阶段显示名称
  function getStageDisplayName(stage) {
    var stageNames = {
      'history': '病史采集',
      'examination': '临床检查',
      'diagnosis': '诊断分析',
      'treatment': '治疗方案',
      'feedback': '学习反馈'
    };
    return stageNames[stage] || stage;
  }
  
  // 加载诊断阶段
  function loadDiagnosisStage() {
    // 如果有缓存的诊断选项，直接使用；否则重新获取
    if (clinicalSession.diagnosisOptions && clinicalSession.diagnosisOptions.length > 0) {
      renderDiagnosisStage({
        diagnosis_options: clinicalSession.diagnosisOptions,
        examination_score: clinicalSession.scores.examination
      });
    } else {
      // 重新获取诊断选项
      $.getJSON('/api/clinical/case/' + clinicalSession.caseId + '/diagnoses/', function(resp) {
        if (resp.success) {
          clinicalSession.diagnosisOptions = resp.data.diagnosis_options;
          renderDiagnosisStage(resp.data);
        } else {
          showErrorMessage('加载诊断选项失败: ' + resp.message);
        }
      }).fail(function() {
        showErrorMessage('网络错误，请检查连接后重试');
      });
    }
  }
  
  // 加载治疗阶段
  function loadTreatmentStage() {
    // 如果有缓存的治疗选项，直接使用；否则重新获取
    if (clinicalSession.treatmentOptions && clinicalSession.treatmentOptions.length > 0) {
      renderTreatmentStage({
        treatment_options: clinicalSession.treatmentOptions,
        diagnosis_score: clinicalSession.scores.diagnosis
      });
    } else {
      // 重新获取治疗选项
      $.getJSON('/api/clinical/case/' + clinicalSession.caseId + '/treatments/', function(resp) {
        if (resp.success) {
          clinicalSession.treatmentOptions = resp.data.treatment_options;
          renderTreatmentStage(resp.data);
        } else {
          showErrorMessage('加载治疗选项失败: ' + resp.message);
        }
      }).fail(function() {
        showErrorMessage('网络错误，请检查连接后重试');
      });
    }
  }
  
  // ==================== OCT图像交互功能 ====================
  
  // 图像缩放功能
  var currentZoom = 1;
  
  function zoomImage(direction) {
    var $image = $('.oct-modal-image');
    if ($image.length === 0) return;
    
    if (direction === 'in') {
      currentZoom = Math.min(currentZoom * 1.2, 5); // 最大5倍
    } else if (direction === 'out') {
      currentZoom = Math.max(currentZoom / 1.2, 0.5); // 最小0.5倍
    }
    
    $image.css('transform', 'scale(' + currentZoom + ')');
    
    // 显示缩放级别
    showZoomLevel(currentZoom);
  }
  
  function resetImageZoom() {
    currentZoom = 1;
    $('.oct-modal-image').css('transform', 'scale(1)');
    showZoomLevel(1);
  }
  
  function showZoomLevel(level) {
    var percentage = Math.round(level * 100);
    
    // 移除已存在的缩放指示器
    $('.zoom-indicator').remove();
    
    // 创建新的缩放指示器
    var indicator = $('<div class="zoom-indicator">' + percentage + '%</div>');
    indicator.css({
      position: 'absolute',
      top: '10px',
      left: '10px',
      background: 'rgba(0,0,0,0.7)',
      color: 'white',
      padding: '5px 10px',
      borderRadius: '4px',
      fontSize: '12px',
      zIndex: '1000'
    });
    
    $('.oct-modal-image-container').css('position', 'relative').append(indicator);
    
    // 2秒后自动隐藏
    setTimeout(function() {
      indicator.fadeOut(300, function() {
        $(this).remove();
      });
    }, 2000);
  }
  
  // 图像测量功能
  var measurementMode = false;
  var measurementPoints = [];
  
  function toggleImageMeasurement() {
    measurementMode = !measurementMode;
    var $button = $('button[onclick="toggleImageMeasurement()"]');
    
    if (measurementMode) {
      $button.removeClass('btn-outline-secondary').addClass('btn-warning');
      $button.html('<i class="fas fa-ruler"></i> 退出测量');
      enableMeasurementMode();
    } else {
      $button.removeClass('btn-warning').addClass('btn-outline-secondary');
      $button.html('<i class="fas fa-ruler"></i> 测量');
      disableMeasurementMode();
    }
  }
  
  function enableMeasurementMode() {
    $('.oct-modal-image').css('cursor', 'crosshair');
    
    // 添加点击事件监听
    $('.oct-modal-image').off('click.measurement').on('click.measurement', function(e) {
      if (!measurementMode) return;
      
      var rect = this.getBoundingClientRect();
      var x = e.clientX - rect.left;
      var y = e.clientY - rect.top;
      
      addMeasurementPoint(x, y);
    });
  }
  
  function disableMeasurementMode() {
    $('.oct-modal-image').css('cursor', 'zoom-in');
    $('.oct-modal-image').off('click.measurement');
    clearMeasurementPoints();
  }
  
  function addMeasurementPoint(x, y) {
    measurementPoints.push({x: x, y: y});
    
    // 创建测量点标记
    var $marker = $('<div class="measurement-point"></div>');
    $marker.css({
      position: 'absolute',
      left: x + 'px',
      top: y + 'px',
      width: '8px',
      height: '8px',
      background: '#ff6b6b',
      borderRadius: '50%',
      border: '2px solid white',
      transform: 'translate(-50%, -50%)',
      zIndex: 1000
    });
    
    $('.oct-modal-image-container').append($marker);
    
    // 如果有两个点，绘制测量线
    if (measurementPoints.length === 2) {
      drawMeasurementLine();
      measurementPoints = []; // 重置测量点
    }
  }
  
  function drawMeasurementLine() {
    var point1 = measurementPoints[0];
    var point2 = measurementPoints[1];
    
    var distance = Math.sqrt(Math.pow(point2.x - point1.x, 2) + Math.pow(point2.y - point1.y, 2));
    var angle = Math.atan2(point2.y - point1.y, point2.x - point1.x) * 180 / Math.PI;
    
    // 创建测量线
    var $line = $('<div class="measurement-line"></div>');
    $line.css({
      position: 'absolute',
      left: point1.x + 'px',
      top: point1.y + 'px',
      width: distance + 'px',
      height: '2px',
      background: '#ff6b6b',
      transformOrigin: '0 50%',
      transform: 'rotate(' + angle + 'deg)',
      zIndex: 999
    });
    
    $('.oct-modal-image-container').append($line);
    
    // 显示距离标签（像素单位）
    var $label = $('<div class="measurement-label">' + Math.round(distance) + 'px</div>');
    $label.css({
      position: 'absolute',
      left: ((point1.x + point2.x) / 2) + 'px',
      top: ((point1.y + point2.y) / 2 - 15) + 'px',
      background: 'rgba(0,0,0,0.8)',
      color: 'white',
      padding: '2px 6px',
      borderRadius: '3px',
      fontSize: '12px',
      transform: 'translate(-50%, -50%)',
      zIndex: 1001
    });
    
    $('.oct-modal-image-container').append($label);
  }
  
  function clearMeasurementPoints() {
    $('.measurement-point, .measurement-line, .measurement-label').remove();
    measurementPoints = [];
  }
  
  // 保存图像标注
  function saveImageAnnotation() {
    // 收集当前的标注数据
    var annotations = [];
    
    $('.measurement-point').each(function() {
      var $point = $(this);
      annotations.push({
        type: 'point',
        x: parseFloat($point.css('left')),
        y: parseFloat($point.css('top'))
      });
    });
    
    $('.measurement-line').each(function() {
      var $line = $(this);
      annotations.push({
        type: 'line',
        x: parseFloat($line.css('left')),
        y: parseFloat($line.css('top')),
        width: parseFloat($line.css('width')),
        rotation: $line.css('transform')
      });
    });
    
    if (annotations.length > 0) {
      // 这里可以保存到服务器或本地存储
      console.log('保存标注数据:', annotations);
      showFeedbackMessage('标注已保存', 'success');
    } else {
      showFeedbackMessage('没有标注数据需要保存', 'info');
    }
  }
  
  // 这里省略了submitExaminationChoices, submitDiagnosisChoice, submitTreatmentChoices等函数
  // 这些函数会调用实际的API，并处理服务器响应
  // 由于篇幅限制，保持原有的简化API调用逻辑
  
})();
</script>
{% endblock %}