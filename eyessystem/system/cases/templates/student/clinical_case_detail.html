{% extends 'base.html' %}
{% load static %}

{% block title %}ä¸´åºŠæ¨ç† - {{ clinical_case.title }}{% endblock %}

{% block content %}
<!-- Bootstrap 4.6 CSS (å¦‚æœbase.htmlä¸­æ²¡æœ‰çš„è¯) -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/css/bootstrap.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/js/bootstrap.bundle.min.js"></script>
{% csrf_token %}
<div class="container-fluid px-0">
  <!-- ä¸´åºŠæ¨ç†ç³»ç»Ÿæ ‡é¢˜ -->
  <div class="row mb-2">
    <div class="col-12 py-2 bg-gradient" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); position: relative;">
      <!-- æ ‡é¢˜ -->
      <h4 class="text-white mb-0 text-center">
        <i class="fas fa-user-md me-2"></i>ä¸´åºŠæ¨ç†å­¦ä¹ ç³»ç»Ÿ
        <small class="d-block mt-1" style="font-size: 0.8rem; opacity: 0.9;">åŸºäºçœŸå®æ¡ˆä¾‹çš„ä¸´åºŠæ€ç»´è®­ç»ƒ</small>
      </h4>
      
      <!-- è¿”å›ä¸»é¡µæŒ‰é’®ï¼ˆå³ä¸Šè§’ï¼‰ -->
      <a href="{% url 'student_dashboard' %}" class="btn btn-light btn-sm" style="position: absolute; right: 20px; top: 50%; transform: translateY(-50%); box-shadow: 0 2px 8px rgba(0,0,0,0.2);" title="è¿”å›ä¸»é¡µ">
        <i class="fas fa-home me-1"></i>è¿”å›ä¸»é¡µ
      </a>
    </div>
  </div>
  
  <!-- ä¸´åºŠæŒ‡å¯¼æç¤ºåŒºåŸŸ -->
  <div class="row mb-1">
    <div class="col-12 px-2">
      <div id="clinical-guidance">
        <!-- åŠ¨æ€ä¸´åºŠæŒ‡å¯¼å†…å®¹ -->
      </div>
    </div>
  </div>
  
  <!-- æ­¥éª¤è¿›åº¦æ¡ -->
  <div class="row mb-2">
    <div class="col-12">
      <div class="progress-stepper">
        <div class="stepper-items">
          <div class="stepper-item active" data-step="case_presentation">
            <div class="stepper-icon">1</div>
            <div class="stepper-title">ç—…å²é‡‡é›†</div>
          </div>
          <div class="stepper-item" data-step="examination_selection">
            <div class="stepper-icon">2</div>
            <div class="stepper-title">æ£€æŸ¥é€‰æ‹©</div>
          </div>
          <div class="stepper-item" data-step="diagnosis_reasoning">
            <div class="stepper-icon">3</div>
            <div class="stepper-title">è¯Šæ–­æ¨ç†</div>
          </div>
          <div class="stepper-item" data-step="treatment_selection">
            <div class="stepper-icon">4</div>
            <div class="stepper-title">æ²»ç–—æ–¹æ¡ˆ</div>
          </div>
          <div class="stepper-item" data-step="learning_feedback">
            <div class="stepper-icon">5</div>
            <div class="stepper-title">å­¦ä¹ åé¦ˆ</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- ç—…å²é‡‡é›†é˜¶æ®µç‰¹æ®Šå…¨å±å¸ƒå±€ -->
  <div id="history-collection-fullscreen" style="display: flex; flex-direction: column; min-height: 100vh; position: fixed; top: 0; left: 0; right: 0; bottom: 0; z-index: 1000; background: #f8f9fa; overflow: hidden;">
    
    <!-- é¡¶éƒ¨æ ‡é¢˜æ å’Œè¿›åº¦æ¡ä¸€ä½“åŒ– -->
    <div class="px-4 py-3 d-flex align-items-center" style="background: linear-gradient(135deg, #87CEEB 0%, #4682B4 50%, #1E90FF 100%); box-shadow: 0 3px 15px rgba(30, 144, 255, 0.4); flex-shrink: 0; position: relative;">
      <!-- å·¦ä¾§Logo -->
      <div class="me-4" style="flex-shrink: 0;">
        <div class="d-flex align-items-center">
          <div class="logo-circle me-3" style="width: 40px; height: 40px; background: rgba(255, 255, 255, 0.25); border-radius: 12px; display: flex; align-items: center; justify-content: center; backdrop-filter: blur(10px); border: 2px solid rgba(255, 255, 255, 0.3);">
            <i class="fas fa-user-md text-white" style="font-size: 18px; text-shadow: 0 2px 4px rgba(0,0,0,0.3);"></i>
          </div>
          <div>
            <h6 class="mb-0 fw-bold text-white" style="font-size: 1.1rem; text-shadow: 0 2px 4px rgba(0,0,0,0.3);">ä¸´åºŠæ¨ç†ç³»ç»Ÿ</h6>
            <small class="text-white" style="font-size: 0.8rem; opacity: 0.9; text-shadow: 0 1px 2px rgba(0,0,0,0.2);">ç—…å²é‡‡é›†é˜¶æ®µ</small>
          </div>
        </div>
      </div>
      
      <!-- ä¸­é—´è¿›åº¦æ¡ -->
      <div class="flex-grow-1">
        <div class="progress-stepper">
          <div class="stepper-items">
            <div class="stepper-item active" data-step="case_presentation">
              <div class="stepper-icon">1</div>
              <div class="stepper-title">ç—…å²é‡‡é›†</div>
            </div>
            <div class="stepper-item" data-step="examination_selection">
              <div class="stepper-icon">2</div>
              <div class="stepper-title">æ£€æŸ¥é€‰æ‹©</div>
            </div>
            <div class="stepper-item" data-step="diagnosis_reasoning">
              <div class="stepper-icon">3</div>
              <div class="stepper-title">è¯Šæ–­æ¨ç†</div>
            </div>
            <div class="stepper-item" data-step="treatment_selection">
              <div class="stepper-icon">4</div>
              <div class="stepper-title">æ²»ç–—æ–¹æ¡ˆ</div>
            </div>
            <div class="stepper-item" data-step="learning_feedback">
              <div class="stepper-icon">5</div>
              <div class="stepper-title">å­¦ä¹ åé¦ˆ</div>
            </div>
          </div>
        </div>
      </div>
      
      <!-- å³ä¾§è¿”å›ä¸»é¡µæŒ‰é’® -->
      <a href="{% url 'student_dashboard' %}" class="btn btn-light btn-sm ms-3" style="box-shadow: 0 2px 8px rgba(0,0,0,0.2); flex-shrink: 0;" title="è¿”å›ä¸»é¡µ">
        <i class="fas fa-home me-1"></i>è¿”å›ä¸»é¡µ
      </a>
    </div>
    
    <!-- ä¸»è¦å†…å®¹åŒºåŸŸ -->
    <div class="container-fluid flex-grow-1 p-2 d-flex" style="min-height: 0; overflow: hidden;">
      <div class="row g-2 flex-grow-1 w-100" style="min-height: 0; max-height: 100%;">
        <!-- å·¦ä¾§ï¼šä¿¡æ¯æ±‡æ€»é¢æ¿ -->
        <div class="col-6 left-panel-scroll" style="overflow-y: auto; overflow-x: hidden; max-height: 100%; padding-right: 8px;">
          <div class="card shadow-sm w-100" id="history-summary-panel">
            <div class="card-header bg-primary text-white py-2">
              <h6 class="mb-0 fw-bold">
                <i class="fas fa-clipboard-list me-2"></i>
                ç—…å²ä¿¡æ¯æ±‡æ€»
              </h6>
            </div>
            <div class="card-body p-3">
          <!-- ä¸»è¯‰ -->
          <div class="mb-3">
            <h6 class="text-primary mb-2">
              <i class="fas fa-comment-medical me-1"></i>
              ä¸»è¯‰
            </h6>
            <div class="border rounded p-3 bg-light info-summary-card" id="chief-complaint-summary">
              <div class="text-muted text-center py-2">
                <i class="fas fa-comments me-1"></i>
                é€šè¿‡å¯¹è¯è·å–ä¸»è¯‰ä¿¡æ¯
              </div>
            </div>
          </div>
          
          <!-- ç°ç—…å² -->
          <div class="mb-3">
            <h6 class="text-primary mb-2">
              <i class="fas fa-history me-1"></i>
              ç°ç—…å²
            </h6>
            <div class="border rounded p-3 bg-light info-summary-card" id="present-illness-summary">
              <div class="text-muted text-center py-2">
                <i class="fas fa-file-alt me-1"></i>
                é€šè¿‡é—®è¯Šäº†è§£ç°ç—…å²
              </div>
            </div>
          </div>
          
          <!-- æ—¢å¾€å² -->
          <div class="mb-3">
            <h6 class="text-primary mb-2">
              <i class="fas fa-file-medical me-1"></i>
              æ—¢å¾€å²
            </h6>
            <div class="border rounded p-3 bg-light info-summary-card" id="past-history-summary">
              <div class="text-muted text-center py-1">
                é€šè¿‡é—®è¯Šäº†è§£æ—¢å¾€ç—…å²
              </div>
            </div>
          </div>
          
          <!-- å®¶æ—å² -->
          <div class="mb-3">
            <h6 class="text-primary mb-2">
              <i class="fas fa-users me-1"></i>
              å®¶æ—å²
            </h6>
            <div class="border rounded p-3 bg-light info-summary-card" id="family-history-summary">
              <div class="text-muted text-center py-1">
                é€šè¿‡é—®è¯Šäº†è§£å®¶æ—å²
              </div>
            </div>
          </div>
          
          <!-- ä½“æ ¼æ£€æŸ¥ -->
          <div class="mb-3" id="physical-exam-section" style="display: none;">
            <h6 class="text-success mb-2">
              <i class="fas fa-stethoscope me-1"></i>
              ä½“æ ¼æ£€æŸ¥
            </h6>
            <div class="border rounded p-3 bg-light info-summary-card" id="physical-exam-summary">
              <!-- ä½“æ ¼æ£€æŸ¥å†…å®¹å°†é€šè¿‡JavaScriptåŠ¨æ€æ’å…¥ -->
            </div>
          </div>
        </div>
      </div>
    </div>
        
        <!-- å³ä¾§ï¼šæ“ä½œåŒºåŸŸ -->
        <div class="col-6 d-flex">
          <div class="card shadow-sm d-flex flex-column w-100">
            <div class="card-header bg-success text-white py-2 flex-shrink-0">
              <h6 class="mb-0 fw-bold">
                <i class="fas fa-stethoscope me-2"></i>
                é—®è¯ŠæŒ‡å¯¼
              </h6>
            </div>
            <div class="card-body text-center p-3 d-flex flex-column justify-content-center flex-grow-1" style="min-height: 0; overflow-y: auto;">
          <div class="mb-4">
            <i class="fas fa-user-md fa-3x text-success mb-3"></i>
            <h5 class="text-primary">è¯·è¿›è¡Œé—®è¯Šé—®é¢˜</h5>
            <p class="text-muted mb-4">
              è¯·æ ¹æ®æ‚£è€…å›ç­”ï¼ŒæŒ‰ç…§æ‚¨æƒ³è¦è¿›è¡Œçš„è¯Šæ–­æ–¹å‘ç»§ç»­é—®è¯Šã€‚<br>
              è·å–è¶³å¤Ÿç—…å²ä¿¡æ¯åï¼Œå¯ä»¥é€‰æ‹©è¿›å…¥ä¸‹ä¸€é˜¶æ®µã€‚
            </p>
          </div>
          
          <div class="mb-4">
            <div class="row">
              <div class="col-6">
                <button class="btn btn-outline-success w-100 mb-2" onclick="requestPhysicalExam()">
                  <i class="fas fa-hand-paper me-1"></i>
                  éœ€è¦ä½“æ ¼æ£€æŸ¥
                </button>
              </div>
              <div class="col-6">
                <button class="btn btn-success w-100 mb-2" onclick="proceedToExamination()">
                  <i class="fas fa-arrow-right me-1"></i>
                  å·²è·å¾—è¶³å¤Ÿä¿¡æ¯
                </button>
              </div>
            </div>
          </div>
          
          <div class="mt-auto">
            <div class="progress mb-2" style="height: 10px;">
              <div class="progress-bar bg-info" role="progressbar" 
                   style="width: 0%" id="history-collection-progress"></div>
            </div>
            <small class="text-muted">
              é—®è¯Šè¿›åº¦ï¼š<span id="questions-asked-count" class="fw-bold text-primary">0</span> ä¸ªé—®é¢˜
            </small>
          </div>
        </div>
      </div>
    </div>
    
        <!-- åŸå³ä¾§èŠå¤©çª—å£æ”¹ä¸ºæµ®åŠ¨çª—å£ -->
      </div> <!-- å…³é—­ä¸»è¦å†…å®¹åŒºåŸŸçš„row -->
      
      <!-- åŸæµ®åŠ¨èŠå¤©çª—å£å·²ç§»è‡³é¡µé¢åº•éƒ¨ --> <!-- å…³é—­ä¸»è¦å†…å®¹åŒºåŸŸ row -->
    </div> <!-- å…³é—­container-fluid -->
  </div> <!-- å…³é—­ç—…å²é‡‡é›†å…¨å±å¸ƒå±€ -->

  <!-- ä¼ ç»Ÿå¸ƒå±€ï¼ˆéç—…å²é‡‡é›†é˜¶æ®µï¼‰ -->
  <div class="row g-2 d-none" id="traditional-layout" style="display: none;">
    <!-- ä¸»è¦å­¦ä¹ å†…å®¹åŒºåŸŸ -->
    <div class="col-lg-8" id="main-content-area">
      <div class="card mb-3 shadow-sm">
        <div class="card-header bg-light">
          <!-- ç—…ä¾‹ä¿¡æ¯å¡ç‰‡åŒºåŸŸ -->
          <div class="mb-3">
            <div class="d-flex flex-wrap gap-2 align-items-center">
              <!-- ç—…ä¾‹åç§°å¡ç‰‡ -->
              <div class="case-info-card" style="background: linear-gradient(135deg, #e3f2fd, #bbdefb); border: 1px solid #2196f3; border-radius: 8px; padding: 8px 12px; display: inline-flex; align-items: center;">
                <i class="fas fa-eye text-primary me-2" style="font-size: 0.9em;"></i>
                <span class="fw-bold text-primary" id="case-title" style="font-size: 0.9rem;">{{ clinical_case.title }}</span>
              </div>
              
              <!-- é˜¶æ®µçŠ¶æ€å¡ç‰‡ -->
              <div class="stage-info-card" style="background: linear-gradient(135deg, #e8f5e8, #c8e6c8); border: 1px solid #4caf50; border-radius: 8px; padding: 8px 12px; display: inline-flex; align-items: center;">
                <i class="fas fa-tasks text-success me-2" style="font-size: 0.9em;"></i>
                <span class="fw-bold text-success" id="current-stage-badge" style="font-size: 0.9rem;">ç—…å²é‡‡é›†é˜¶æ®µ</span>
              </div>
            </div>
          </div>
          
          <!-- æ‚£è€…åŸºç¡€ä¿¡æ¯ -->
          <div class="patient-basic-info" id="patient-info">
            <div class="text-muted" style="font-size: 0.95rem; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;">
              <span style="color: #495057; font-weight: 600;">åŸºç¡€ä¿¡æ¯ï¼š</span>
              <span style="font-weight: 500;">{{ clinical_case.patient_age }}å² {{ clinical_case.get_patient_gender_display }}</span>
              <span style="margin: 0 12px; color: #6c757d;">â€¢</span>
              <span style="font-weight: 500;">ç¼–å·ï¼š{{ clinical_case.case_id }}</span>
              {% if clinical_case.patient_occupation %}
                <span style="margin: 0 12px; color: #6c757d;">â€¢</span>
                <span style="font-weight: 500;">èŒä¸šï¼š{{ clinical_case.patient_occupation }}</span>
              {% endif %}
            </div>
          </div>
        </div>
        <div class="card-body">
          <!-- é™æ€æç¤ºåŒºåŸŸ -->
          <div id="start-examination-hint" class="start-examination-prompt" style="display: none;">
            <div class="text-center p-3 bg-light rounded border" style="background-color: #f8f9fa;">
              <h5 class="text-primary fw-bold mb-2" style="font-size: 1.2rem;">å‡†å¤‡å¼€å§‹æ£€æŸ¥</h5>
              <p class="text-muted mb-0" style="font-size: 0.9rem;">ç‚¹å‡»ä¸‹æ–¹"æŸ¥çœ‹æ£€æŸ¥ç»“æœ"æŒ‰é’®å¼€å§‹é€ä¸€æŸ¥çœ‹æ£€æŸ¥ç»“æœ</p>
            </div>
          </div>
          

          
          <div id="stage-content">
            <div class="text-center p-5">
              <i class="fas fa-spinner fa-spin fa-2x text-primary"></i>
              <p class="mt-3">æ­£åœ¨åŠ è½½ä¸´åºŠæ¡ˆä¾‹æ•°æ®...</p>
            </div>
          </div>
        </div>
      </div>

      <!-- å¯¼èˆªæ§åˆ¶é¢æ¿ -->
      <div class="card" id="navigation-card">
        <div class="card-body">
          <!-- æŒ‰é’®è¡Œ -->
          <div class="d-flex justify-content-between align-items-center mb-3">
            <button class="btn btn-outline-secondary" id="btn-prev" disabled>
              <i class="fas fa-arrow-left me-1"></i> ä¸Šä¸€æ­¥
            </button>
            <button class="btn btn-primary" id="btn-next">
              ä¸‹ä¸€æ­¥ <i class="fas fa-arrow-right ms-1"></i>
            </button>
          </div>
          
          <!-- è¿›åº¦ä¿¡æ¯è¡Œ -->
          <div class="text-center">
            <small class="text-muted d-block mb-2">ä¸´åºŠæ¨ç†è¿›åº¦</small>
            <div style="width: 350px; height: 15px; background-color: #e9ecef; border-radius: 10px; margin: 0 auto; overflow: hidden; border: 1px solid #dee2e6;" class="progress-container">
              <div id="overall-progress" style="height: 100%; background: linear-gradient(90deg, #007bff, #0056b3); border-radius: 10px; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 0.8em; width: 25%; transition: width 0.6s ease;" role="progressbar">
                25%
              </div>
            </div>
            <small class="text-muted d-block mt-2" id="progress-text">æ­¥éª¤ 1/4 (25%)</small>
          </div>
        </div>
      </div>
    </div>

    <!-- ä¾§è¾¹å·¥å…·å’Œåé¦ˆåŒºåŸŸ -->
    <div class="col-lg-4 px-2" id="sidebar-panel">


      
      <!-- ä¸´åºŠè®°å½•é¢æ¿ï¼ˆæŒ‰éœ€æ±‚ä¸æ˜¾ç¤ºï¼›ä¿ç•™DOMé¿å…å½±å“æ—§é€»è¾‘ï¼‰ -->
      <div class="card mb-2 border-primary shadow-sm d-none" id="clinical-record-card">
        <div class="card-header bg-primary text-white">
          <h6 class="mb-0"><i class="fas fa-clipboard"></i> ä¸´åºŠè®°å½•</h6>
        </div>
        <div class="card-body">
          <div class="nav nav-pills mb-3" id="clinical-tabs" role="tablist">
            <a class="nav-item nav-link active" id="notes-tab" data-toggle="pill" href="#notes-panel" role="tab">ç¬”è®°</a>
            <a class="nav-item nav-link" id="timeline-tab" data-toggle="pill" href="#timeline-panel" role="tab">æ—¶é—´çº¿</a>
          </div>
          <div class="tab-content">
            <div class="tab-pane fade show active" id="notes-panel">
              <div class="notes-container">
                <div class="notes-header d-flex justify-content-between align-items-center mb-2">
                  <small class="text-muted">ä¸´åºŠå­¦ä¹ ç¬”è®°</small>
                  <div class="notes-info">
                    <small id="notes-char-count" class="text-muted me-2">0 å­—</small>
                    <small id="notes-save-status" class="text-muted"></small>
                  </div>
                </div>
                <textarea id="clinical-notes" class="form-control" rows="5" placeholder="è®°å½•ä¸´åºŠæ€è€ƒè¿‡ç¨‹ã€é‰´åˆ«è¯Šæ–­è¦ç‚¹ã€å­¦ä¹ å¿ƒå¾—ç­‰...&#10;&#10;ğŸ’¡ æç¤ºï¼šç¬”è®°ä¼šè‡ªåŠ¨ä¿å­˜"></textarea>
                <div class="notes-footer mt-2">
                  <small class="text-muted">
                    <i class="fas fa-info-circle"></i> ç¬”è®°å°†è‡ªåŠ¨ä¿å­˜åˆ°æ•°æ®åº“ï¼Œå¯åœ¨
                    <a href="{% url 'student_learning_notes' %}" target="_blank" class="text-primary">
                      <i class="fas fa-external-link-alt"></i> å­¦ä¹ ç¬”è®°
                    </a> é¡µé¢æŸ¥çœ‹æ‰€æœ‰ç¬”è®°
                  </small>
                </div>
              </div>
            </div>
            <div class="tab-pane fade" id="timeline-panel">
              <div id="learning-timeline">
                <small class="text-muted">å­¦ä¹ è¿›ç¨‹å°†åœ¨æ­¤æ˜¾ç¤º</small>
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <!-- å­¦ä¹ ç»Ÿè®¡é¢æ¿ -->
      <div class="card shadow-sm">
        <div class="card-header">
          <h6 class="mb-0"><i class="fas fa-chart-line"></i> å­¦ä¹ ç»Ÿè®¡</h6>
        </div>
        <div class="card-body">
          <div id="learning-stats">
            <div class="row text-center">
              <div class="col-6">
                <div class="border-right">
                  <div class="h4 mb-0" id="time-spent">00:00</div>
                  <small class="text-muted">ç”¨æ—¶</small>
                </div>
              </div>
              <div class="col-6">
                <div class="h4 mb-0" id="current-score">--</div>
                <small class="text-muted">å½“å‰å¾—åˆ†</small>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
/* ==================== ä¸´åºŠæ¨ç†ç³»ç»Ÿæ ·å¼ ==================== */

/* å¯¼èˆªæŒ‰é’®ç»Ÿä¸€æ ·å¼ */
#btn-prev, #btn-next {
  min-width: 120px;
  height: 40px;
  font-size: 14px;
  font-weight: 500;
  border-radius: 8px;
  transition: all 0.3s ease;
}

#btn-prev {
  border: 2px solid #6c757d;
  color: #6c757d;
}

#btn-prev:hover:not(:disabled) {
  background-color: #6c757d;
  color: white;
  transform: translateY(-1px);
}

#btn-next {
  background: linear-gradient(135deg, #007bff, #0056b3);
  border: none;
  color: white;
}

#btn-next:hover:not(:disabled) {
  background: linear-gradient(135deg, #0056b3, #004085);
  transform: translateY(-1px);
  box-shadow: 0 4px 8px rgba(0, 123, 255, 0.3);
}

#btn-prev:disabled, #btn-next:disabled {
  opacity: 0.5;
  cursor: not-allowed;
  transform: none;
}

/* è¿›åº¦æ¡æ ·å¼ä¼˜åŒ– */
.progress-container {
  position: relative;
  border: 1px solid #dee2e6;
  background-color: #e9ecef;
  border-radius: 10px;
  overflow: hidden;
  height: 15px;
  max-width: 350px;
  margin: 0 auto;
}

#overall-progress {
  height: 100%;
  border-radius: 10px;
  display: flex;
  align-items: center;
  justify-content: center;
  color: white;
  font-weight: bold;
  font-size: 0.8em;
  transition: width 0.6s ease, background 0.3s ease;
  min-width: 30px; /* ç¡®ä¿ç™¾åˆ†æ¯”æ–‡å­—æœ‰è¶³å¤Ÿç©ºé—´ */
}

/* æ£€æŸ¥ç»“æœå°å¡ç‰‡æ ·å¼ */
.exam-result-card {
  background: white;
  border: 1px solid #e3e6f0;
  border-radius: 12px;
  padding: 0;
  transition: all 0.3s ease;
  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
  overflow: hidden;
}

.exam-result-card:hover {
  transform: translateY(-2px);
  box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1);
  border-color: #007bff;
}

.exam-header {
  background: linear-gradient(135deg, #f8f9fa, #e9ecef);
  padding: 1rem 1.25rem;
  border-bottom: 1px solid #e3e6f0;
}

.exam-title {
  display: flex;
  align-items: center;
  font-size: 1.1rem;
}

.exam-content {
  padding: 1.25rem;
}

.result-label {
  font-size: 0.875rem;
  font-weight: 600;
  color: #6c757d;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  margin-bottom: 0.5rem;
}

.result-text {
  font-size: 0.95rem;
  line-height: 1.6;
  color: #495057;
  background: #f8f9fa;
  padding: 0.75rem 1rem;
  border-radius: 8px;
  border-left: 4px solid #007bff;
  margin: 0;
}

/* ç‰¹æ®Šæ£€æŸ¥ç»“æœæ ·å¼ */
.exam-result-card .fas.fa-eye {
  font-size: 1.1em;
  color: #007bff;
}

.exam-result-card .badge {
  font-size: 0.75rem;
  padding: 0.4em 0.8em;
  border-radius: 6px;
}

/* å“åº”å¼è®¾è®¡ */
@media (max-width: 768px) {
  .exam-header {
    padding: 0.875rem 1rem;
  }
  
  .exam-content {
    padding: 1rem;
  }
  
  .exam-title {
    font-size: 1rem;
  }
  
  .result-text {
    font-size: 0.9rem;
    padding: 0.625rem 0.875rem;
  }
}

/* æ²»ç–—æ–¹æ¡ˆåˆ†ææ ·å¼ä¼˜åŒ– */
.treatment-summary .card {
  border: none;
  background: linear-gradient(135deg, #f8f9fa, #e9ecef);
}

.treatment-summary .card-body {
  padding: 1.5rem;
}

.treatment-summary .bg-white {
  background: white !important;
  transition: all 0.3s ease;
  border: 1px solid #dee2e6 !important;
}

.treatment-summary .bg-white:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
  border-color: #007bff !important;
}

.treatment-summary .h4 {
  font-weight: 600;
  font-size: 1.8rem;
}

.treatment-summary .fw-500 {
  font-weight: 500;
}

.treatment-summary .rounded {
  border-radius: 8px !important;
}

/* å“åº”å¼ä¼˜åŒ– */
@media (max-width: 768px) {
  .treatment-summary .h4 {
    font-size: 1.5rem;
  }
  
  .treatment-summary .card-body {
    padding: 1rem;
  }
}

/* å­¦ä¹ å®Œæˆé¡µé¢æŒ‰é’®ç»Ÿä¸€æ ·å¼ - å±…ä¸­å¸ƒå±€ */
.action-buttons {
  width: 100%;
  display: flex;
  justify-content: center;
  align-items: center;
}

.action-buttons .btn {
  height: 50px;
  font-size: 15px;
  font-weight: 500;
  padding: 12px 20px;
  border-radius: 8px;
  transition: all 0.3s ease;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  text-decoration: none;
  border-width: 2px;
  white-space: nowrap;
  flex-grow: 1;
  max-width: none;
}

.action-buttons .btn i {
  margin-right: 8px;
  font-size: 1.1em;
  width: 16px;
  text-align: center;
}

.action-buttons .btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 6px 16px rgba(0, 0, 0, 0.15);
  text-decoration: none;
}

/* ç¡®ä¿outlineæ ·å¼çš„æŒ‰é’®ä¹Ÿæœ‰ç›¸åŒçš„è§†è§‰æ•ˆæœ */
.action-buttons .btn-outline-primary:hover {
  background-color: #007bff;
  border-color: #007bff;
  color: white;
}

.action-buttons .btn-outline-secondary:hover {
  background-color: #6c757d;
  border-color: #6c757d;
  color: white;
}

.action-buttons .btn-outline-success:hover {
  background-color: #28a745;
  border-color: #28a745;
  color: white;
}

/* æŒ‰é’®é—´è·è°ƒæ•´ */
.action-buttons .mx-2 {
  margin-left: 8px !important;
  margin-right: 8px !important;
}

/* æŒ‰é’®ç»„å®¹å™¨æ ·å¼ */
.action-buttons .d-flex[style*="max-width"] {
  justify-content: space-between;
  gap: 0;
}

/* å“åº”å¼è®¾è®¡ - å°å±å¹•æ—¶å †å æŒ‰é’® */
@media (max-width: 768px) {
  .action-buttons .d-flex[style*="max-width"] {
    flex-direction: column;
    gap: 10px;
    max-width: 300px !important;
  }
  
  .action-buttons .btn {
    margin: 0 !important;
    height: 45px;
    font-size: 14px;
  }
}

/* è¿›åº¦æŒ‡ç¤ºå™¨æ ·å¼ä¼˜åŒ– */
.progress-stepper {
  display: flex;
  justify-content: center;
  margin-bottom: 0;
  padding: 0.5rem 1rem;
  background: transparent;
  border-radius: 0;
}

/* å…¨å±æ¨¡å¼ä¸‹çš„è¿›åº¦æ¡æ ·å¼ */
#history-collection-fullscreen .progress-stepper {
  margin-bottom: 0;
  padding: 0;
}

.stepper-items {
  display: flex;
  align-items: center;
  justify-content: space-between;
  width: 100%;
  max-width: 700px;
}

.stepper-item {
  display: flex;
  flex-direction: column;
  align-items: center;
  text-align: center;
  flex: 1;
  position: relative;
  transition: all 0.3s ease;
}

/* å…¨å±æ¨¡å¼ä¸‹æ­¥éª¤é¡¹æ›´ç´§å‡‘ä¸”æ›´é†’ç›® */
#history-collection-fullscreen .stepper-item {
  margin: 0 0.5rem;
}

#history-collection-fullscreen .stepper-icon {
  width: 28px !important;
  height: 28px !important;
  font-size: 12px !important;
  margin-bottom: 3px !important;
  background: rgba(255, 255, 255, 0.9) !important;
  color: #ff6b6b !important;
  border: 2px solid rgba(255, 255, 255, 1) !important;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2) !important;
}

#history-collection-fullscreen .stepper-item.active .stepper-icon {
  background: linear-gradient(135deg, #FF6347 0%, #FF1493 100%) !important;
  color: white !important;
  font-weight: bold !important;
  transform: scale(1.15) !important;
  border: 3px solid rgba(255, 255, 255, 0.9) !important;
  box-shadow: 0 4px 15px rgba(255, 99, 71, 0.6) !important;
}

#history-collection-fullscreen .stepper-title {
  font-size: 0.8rem !important;
  margin-top: 3px !important;
  color: white !important;
  text-shadow: 0 1px 3px rgba(0, 0, 0, 0.3) !important;
  font-weight: 500 !important;
}

/* å…¨å±æ¨¡å¼ä¸‹çš„è¿æ¥çº¿æ ·å¼ */
#history-collection-fullscreen .stepper-item:not(:last-child)::after {
  content: '';
  position: absolute;
  top: 14px;
  left: 60%;
  width: 80%;
  height: 3px;
  background: rgba(255, 255, 255, 0.4);
  z-index: 1;
  border-radius: 3px;
  box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
}

.stepper-item:not(:last-child)::after {
  content: '';
  position: absolute;
  top: 20px;
  left: 60%;
  width: 80%;
  height: 3px;
  background: linear-gradient(90deg, #dee2e6 0%, #ced4da 100%);
  z-index: 1;
  border-radius: 2px;
}

.stepper-item.active::after {
  background: linear-gradient(90deg, #007bff 0%, #0056b3 100%);
  box-shadow: 0 2px 4px rgba(0, 123, 255, 0.3);
}

.stepper-item.completed::after {
  background: linear-gradient(90deg, #28a745 0%, #1e7e34 100%);
  box-shadow: 0 2px 4px rgba(40, 167, 69, 0.3);
}

.stepper-icon {
  width: 45px;
  height: 45px;
  border-radius: 50%;
  background: linear-gradient(135deg, #e9ecef 0%, #ced4da 100%);
  color: #6c757d;
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: bold;
  font-size: 1.1rem;
  margin-bottom: 8px;
  position: relative;
  z-index: 2;
  border: 3px solid #fff;
  box-shadow: 0 4px 8px rgba(0,0,0,0.1);
  transition: all 0.3s ease;
}

.stepper-item.active .stepper-icon {
  background: linear-gradient(135deg, #FF6347 0%, #FF4500 50%, #FF1493 100%);
  color: white;
  transform: scale(1.15);
  box-shadow: 0 8px 20px rgba(255, 99, 71, 0.6);
  animation: pulse 1.5s infinite;
  border: 3px solid rgba(255, 255, 255, 0.8);
}

.stepper-item.completed .stepper-icon {
  background: linear-gradient(135deg, #28a745 0%, #1e7e34 100%);
  color: white;
  box-shadow: 0 4px 8px rgba(40, 167, 69, 0.3);
}

.stepper-item.thinking .stepper-icon {
  animation: thinking 1.5s ease-in-out infinite;
}

@keyframes pulse {
  0% { 
    box-shadow: 0 8px 20px rgba(255, 99, 71, 0.6);
    transform: scale(1.15);
  }
  50% { 
    box-shadow: 0 12px 30px rgba(255, 99, 71, 0.9);
    transform: scale(1.2);
  }
  100% { 
    box-shadow: 0 8px 20px rgba(255, 99, 71, 0.6);
    transform: scale(1.15);
  }
}

@keyframes thinking {
  0%, 100% { transform: scale(1.1); }
  50% { transform: scale(1.05); }
}

.stepper-title {
  font-size: 0.9rem;
  color: #6c757d;
  margin-top: 4px;
  font-weight: 500;
  transition: all 0.3s ease;
}

.stepper-item.active .stepper-title {
  color: #FF6347;
  font-weight: 700;
  transform: translateY(-2px);
  text-shadow: 0 2px 4px rgba(255, 99, 71, 0.3);
}

.stepper-item.completed .stepper-title {
  color: #28a745;
  font-weight: 600;
}

/* ä¸´åºŠæŒ‡å¯¼åŒºåŸŸæ ·å¼ */
.clinical-guidance {
  border-left: 4px solid #007bff;
  background: linear-gradient(135deg, #f8f9ff 0%, #e6f3ff 100%);
  animation: slideIn 0.5s ease-out;
}

@keyframes slideIn {
  from { opacity: 0; transform: translateY(-10px); }
  to { opacity: 1; transform: translateY(0); }
}

.clinical-tips ul {
  list-style: none;
  padding-left: 0;
}

.clinical-tips li {
  position: relative;
  padding-left: 20px;
  margin-bottom: 5px;
}

.clinical-tips li::before {
  content: 'ğŸ’¡';
  position: absolute;
  left: 0;
  top: 0;
}

/* ç—…å²åˆ†æå·¥å…·æ ·å¼ */
/* ç—…å²é‡‡é›†é˜¶æ®µä¸“ç”¨æ ·å¼ */

/* ç—…å²é‡‡é›†å¸ƒå±€æ ·å¼ */
#history-collection-layout {
  margin-top: 20px;
}

#history-summary-panel {
  border: 1px solid #dee2e6;
  border-radius: 8px;
  box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

#history-summary-panel .card-header {
  background: linear-gradient(135deg, #007bff, #0056b3);
  color: white;
  border-radius: 8px 8px 0 0;
}

#patient-chat-panel {
  border: 1px solid #dee2e6;
  border-radius: 8px;
  box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

#patient-chat-panel .card-header {
  background: linear-gradient(135deg, #17a2b8, #138496);
  color: white;
  border-radius: 8px 8px 0 0;
}

#history-control-panel {
  border: 1px solid #28a745;
  border-radius: 8px;
  box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

/* ç—…å²ä¿¡æ¯æ±‡æ€»åŒºåŸŸæ ·å¼ */
.history-info-item {
  background: #f8f9fa;
  border: 1px solid #e9ecef;
  border-radius: 6px;
  padding: 15px;
  margin-bottom: 15px;
  transition: all 0.3s ease;
}

.history-info-item:hover {
  background: #e9ecef;
  border-color: #007bff;
  transform: translateY(-2px);
}

.history-info-item h6 {
  color: #007bff;
  font-weight: 600;
  margin-bottom: 10px;
  border-bottom: 2px solid #007bff;
  padding-bottom: 5px;
}

.history-info-item .info-content {
  color: #495057;
  line-height: 1.6;
}

.history-info-item .info-placeholder {
  color: #6c757d;
  font-style: italic;
  text-align: center;
  padding: 20px 0;
}

/* å¿«é€Ÿé—®é¢˜æŒ‰é’®æ ·å¼ */
.quick-questions {
  background: #f1f3f4;
  border-top: 1px solid #dee2e6;
}

.quick-questions .btn {
  margin: 2px;
  border-radius: 15px;
  font-size: 0.75rem;
  padding: 4px 8px;
  transition: all 0.2s ease;
}

.quick-questions .btn:hover {
  transform: scale(1.05);
  box-shadow: 0 2px 4px rgba(0,0,0,0.2);
}

/* æµ®åŠ¨èŠå¤©çª—å£æ ·å¼ */
.floating-chat-window {
  position: fixed;
  right: 20px;
  bottom: 20px;
  width: 350px;
  height: 500px;
  background: white;
  border-radius: 12px;
  box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
  z-index: 1050;
  display: flex;
  flex-direction: column;
  border: 1px solid #dee2e6;
  overflow: hidden;
  transition: all 0.3s ease;
  min-width: 300px;
  min-height: 200px;
}

/* è°ƒæ•´å¤§å°æ‰‹æŸ„æ ·å¼ */
.resize-handle {
  position: absolute;
  background: transparent;
  z-index: 10001;
}

.resize-handle-nw, .resize-handle-ne, .resize-handle-sw, .resize-handle-se {
  width: 15px;
  height: 15px;
}

.resize-handle-n, .resize-handle-s {
  width: 100%;
  height: 8px;
  left: 0;
}

.resize-handle-w, .resize-handle-e {
  width: 8px;
  height: 100%;
  top: 0;
}

/* è§’è½è°ƒæ•´æ‰‹æŸ„ */
.resize-handle-nw {
  top: -5px;
  left: -5px;
  cursor: nw-resize;
}

.resize-handle-ne {
  top: -5px;
  right: -5px;
  cursor: ne-resize;
}

.resize-handle-sw {
  bottom: -5px;
  left: -5px;
  cursor: sw-resize;
}

.resize-handle-se {
  bottom: -5px;
  right: -5px;
  cursor: se-resize;
}

/* è¾¹æ¡†è°ƒæ•´æ‰‹æŸ„ */
.resize-handle-n {
  top: -4px;
  cursor: n-resize;
}

.resize-handle-s {
  bottom: -4px;
  cursor: s-resize;
}

.resize-handle-w {
  left: -4px;
  cursor: w-resize;
}

.resize-handle-e {
  right: -4px;
  cursor: e-resize;
}

/* è°ƒæ•´å¤§å°æ—¶ç¦ç”¨è¿‡æ¸¡æ•ˆæœ */
.floating-chat-window.resizing {
  transition: none !important;
}

/* æœ€å°åŒ–çŠ¶æ€ä¸‹éšè—è°ƒæ•´å¤§å°æ‰‹æŸ„ */
.floating-chat-window.minimized .resize-handle {
  display: none;
}

.floating-chat-window.minimized {
  width: 60px;
  height: 60px;
  border-radius: 50%;
  background: linear-gradient(135deg, #17a2b8, #138496);
  border: 3px solid #fff;
  box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
  display: flex;
  align-items: center;
  justify-content: center;
  flex-direction: row;
}

.floating-chat-window.minimized .chat-header {
  border-radius: 50%;
  background: transparent !important;
  padding: 0;
  justify-content: center;
  flex: 1;
  width: 100%;
  height: 100%;
  cursor: move;
}

.floating-chat-window.minimized .chat-body {
  display: none;
}

.floating-chat-window.minimized .chat-header .d-flex:first-child {
  display: none;
}

.floating-chat-window.minimized .chat-header .chat-controls {
  display: flex !important;
  width: 100%;
  height: 100%;
  justify-content: center;
  align-items: center;
}

.floating-chat-window.minimized .chat-controls button {
  background: none !important;
  border: none !important;
  color: white !important;
  font-size: 18px;
  padding: 0;
  width: 100%;
  height: 100%;
  display: flex;
  align-items: center;
  justify-content: center;
}

/* å°åœ†åœˆæ‚¬åœæ•ˆæœ */
.floating-chat-window.minimized:hover {
  transform: scale(1.1);
  box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
}

.floating-chat-window.minimized .chat-controls button:hover {
  transform: scale(1.2);
}

.chat-header {
  padding: 10px 15px;
  border-radius: 12px 12px 0 0;
  cursor: move;
  user-select: none;
  flex-shrink: 0;
}

.floating-chat-window.minimized {
  cursor: move;
}

.floating-chat-window.minimized .chat-header {
  cursor: move;
  width: 100%;
  height: 100%;
  padding: 0;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
}

.chat-controls button {
  padding: 2px 6px;
  font-size: 12px;
  border: none;
}

.chat-body {
  flex: 1;
  display: flex;
  flex-direction: column;
  min-height: 0;
}

.chat-messages {
  flex: 1;
  overflow-y: auto;
  padding: 10px;
  min-height: 0;
}

.quick-questions {
  padding: 8px;
  border-top: 1px solid #e9ecef;
  background: #f8f9fa;
  max-height: 80px;
  overflow-y: auto;
}

.chat-input {
  padding: 10px;
  border-top: 1px solid #e9ecef;
  background: white;
}

/* ç—…å²èŠå¤©æ¶ˆæ¯æ ·å¼ */
.chat-message.patient-message .chat-bubble {
  background: linear-gradient(135deg, #e3f2fd, #bbdefb);
  border: 1px solid #2196f3;
  color: #1976d2;
}

.chat-message.student-message .chat-bubble {
  background: linear-gradient(135deg, #007bff, #0056b3);
  color: white;
}

.chat-message.system-message .chat-bubble {
  background: linear-gradient(135deg, #fff3cd, #ffeaa7);
  border: 1px solid #ffc107;
  color: #856404;
}

/* èŠå¤©æ¶ˆæ¯å®¹å™¨æ ·å¼ */
.chat-message-container {
  display: flex;
  margin-bottom: 0.8rem;
  align-items: flex-start;
}

.chat-message {
  max-width: 80%;
  word-wrap: break-word;
  padding: 0.6rem 0.8rem;
  border-radius: 8px;
  font-size: 0.85rem;
  line-height: 1.3;
}

.chat-message.doctor {
  background-color: #e3f2fd;
  border: 1px solid #bbdefb;
  margin-left: 0;
  border-top-left-radius: 4px;
}

.chat-message.patient {
  background-color: #e8f5e8;
  border: 1px solid #c8e6c8;
  margin-left: auto;
  border-top-right-radius: 4px;
}

.chat-message.system {
  background-color: #fff3e0;
  border: 1px solid #ffcc80;
  font-style: italic;
  text-align: center;
  margin: 0 auto;
  width: fit-content;
}

/* è¿›åº¦æŒ‡ç¤ºå™¨æ ·å¼ */
#history-collection-progress {
  background: linear-gradient(90deg, #17a2b8, #138496);
  transition: width 0.5s ease;
}

/* æµ®åŠ¨çª—å£å“åº”å¼è°ƒæ•´ */
@media (max-width: 768px) {
  .floating-chat-window {
    width: 90%;
    right: 5%;
    bottom: 10px;
    height: 60vh;
    left: 5% !important;
    transform: none !important;
  }
  
  .floating-chat-window.minimized {
    width: 50px;
    height: 50px;
  }
}

@media (max-width: 576px) {
  .floating-chat-window {
    width: 95%;
    right: 2.5%;
    left: 2.5% !important;
    bottom: 5px;
    height: 70vh;
  }
  
  .floating-chat-window.minimized {
    width: 45px;
    height: 45px;
  }
}

/* å“åº”å¼è°ƒæ•´ */
@media (max-width: 992px) {
  #history-collection-layout .col-lg-6 {
    margin-bottom: 20px;
  }
  
  #patient-chat-panel {
    height: auto !important;
  }
  
  #chat-messages-history {
    height: 250px !important;
  }
}
.patient-history {
  animation: fadeInUp 0.6s ease-out;
}

.info-item {
  padding: 15px;
  border-radius: 8px;
  background: rgba(255, 255, 255, 0.8);
  transition: all 0.3s ease;
  border: 1px solid rgba(0,0,0,0.05);
}

.info-item:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(0,0,0,0.1);
  background: rgba(255, 255, 255, 0.95);
}

.chief-complaint-content blockquote {
  border-left: 4px solid #ff6b6b;
  padding-left: 20px;
  background: rgba(255, 107, 107, 0.05);
  border-radius: 0 8px 8px 0;
}

.illness-timeline {
  position: relative;
}

.formatted-history {
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  line-height: 1.8;
}

.time-marker {
  display: inline-block;
  animation: pulseGlow 2s infinite;
}

.symptom-highlight {
  display: inline-block;
  animation: highlightPulse 3s infinite;
}

@keyframes pulseGlow {
  0%, 100% { box-shadow: 0 0 5px rgba(52, 152, 219, 0.3); }
  50% { box-shadow: 0 0 15px rgba(52, 152, 219, 0.6); }
}

@keyframes highlightPulse {
  0%, 100% { box-shadow: 0 0 3px rgba(231, 76, 60, 0.2); }
  50% { box-shadow: 0 0 8px rgba(231, 76, 60, 0.4); }
}

/* åŒ»å­¦ç—…å²éƒ¨åˆ†æ ·å¼ */
.medical-history-sections {
  margin-top: 20px;
}

.medical-history-sections .card {
  transition: all 0.3s ease;
}

.medical-history-sections .card:hover {
  transform: translateY(-2px);
  box-shadow: 0 8px 25px rgba(0,0,0,0.15);
}

/* å›¾æ ‡å®¹å™¨åŠ¨ç”» */
.icon-container {
  transition: all 0.3s ease;
}

.card:hover .icon-container {
  transform: rotate(5deg) scale(1.1);
}

/* çœ¼åº•æ£€æŸ¥æç¤ºå­—å¹•æ ·å¼ */
#fundus-overlay {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.3);
  display: flex;
  justify-content: center;
  align-items: center;
  z-index: 9999;
  pointer-events: none;
  user-select: none;
  opacity: 0;
  transition: opacity 0.8s ease-in-out;
}

#fundus-overlay.show {
  opacity: 1;
}

#fundus-subtitle {
  background: rgba(0, 0, 0, 0.75);
  color: white;
  font-size: 2rem;
  font-weight: bold;
  padding: 20px 40px;
  border-radius: 15px;
  text-align: center;
  letter-spacing: 2px;
  text-shadow: 2px 2px 8px rgba(0, 0, 0, 0.8);
  backdrop-filter: blur(15px);
  border: 3px solid rgba(255, 255, 255, 0.2);
  box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
  transform: translateY(20px);
  transition: all 0.8s ease-out;
  animation: pulse-glow 3s ease-in-out infinite;
}

#fundus-overlay.show #fundus-subtitle {
  transform: translateY(0);
}

@keyframes pulse-glow {
  0%, 100% {
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5), 0 0 20px rgba(255, 255, 255, 0.1);
  }
  50% {
    box-shadow: 0 15px 40px rgba(0, 0, 0, 0.6), 0 0 30px rgba(255, 255, 255, 0.2);
  }
}

/* çœ¼åº•æ£€æŸ¥ç»“æœç•™ç™½æ ·å¼ */
.fundus-examination-blank {
  background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
  border: 2px dashed #6c757d;
  border-radius: 15px;
  padding: 80px 40px;
  text-align: center;
  color: #6c757d;
  position: relative;
  overflow: hidden;
}

.fundus-examination-blank::before {
  content: "";
  position: absolute;
  top: 0;
  left: -100%;
  width: 100%;
  height: 100%;
  background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
  animation: shine 3s ease-in-out infinite;
}

@keyframes shine {
  0% { left: -100%; }
  50% { left: 100%; }
  100% { left: 100%; }
}

.fundus-examination-blank .icon {
  font-size: 4rem;
  margin-bottom: 20px;
  opacity: 0.5;
}

.fundus-examination-blank .message {
  font-size: 1.5rem;
  font-weight: 500;
  margin-bottom: 10px;
}

.fundus-examination-blank .submessage {
  font-size: 1.1rem;
  opacity: 0.8;
}

@media (max-width: 768px) {
  #fundus-subtitle {
    font-size: 1.4rem !important;
    padding: 15px 25px !important;
    max-width: 90% !important;
  }
  
  .fundus-examination-blank {
    padding: 60px 20px;
  }
  
  .fundus-examination-blank .icon {
    font-size: 3rem;
  }
  
  .fundus-examination-blank .message {
    font-size: 1.2rem;
  }
  
  .fundus-examination-blank .submessage {
    font-size: 1rem;
  }
}

/* ç—…ä¾‹ä¿¡æ¯å¡ç‰‡æ ·å¼ */
.case-info-card, .stage-info-card {
  transition: all 0.3s ease;
  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
}

.case-info-card:hover, .stage-info-card:hover {
  transform: translateY(-1px);
  box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
}

.case-info-card {
  background: linear-gradient(135deg, #e3f2fd, #bbdefb) !important;
  border: 1px solid #2196f3 !important;
}

.stage-info-card {
  background: linear-gradient(135deg, #e8f5e8, #c8e6c8) !important;
  border: 1px solid #4caf50 !important;
}

/* ä¸åŒé˜¶æ®µçš„å¡ç‰‡é¢œè‰² */
.stage-info-card.stage-history {
  background: linear-gradient(135deg, #e8f5e8, #c8e6c8) !important;
  border-color: #4caf50 !important;
}

.stage-info-card.stage-examination {
  background: linear-gradient(135deg, #fff3e0, #ffe0b2) !important;
  border-color: #ff9800 !important;
}

.stage-info-card.stage-diagnosis {
  background: linear-gradient(135deg, #f3e5f5, #e1bee7) !important;
  border-color: #9c27b0 !important;
}

.stage-info-card.stage-treatment {
  background: linear-gradient(135deg, #e0f2f1, #b2dfdb) !important;
  border-color: #009688 !important;
}

.stage-info-card.stage-complete {
  background: linear-gradient(135deg, #e8f5e8, #c8e6c8) !important;
  border-color: #4caf50 !important;
}

/* å“åº”å¼è®¾è®¡ */
@media (max-width: 576px) {
  .case-info-card, .stage-info-card {
    flex: 1;
    min-width: 0;
    justify-content: center;
  }
}

/* æ‚£è€…ä¿¡æ¯åŒºåŸŸæ ·å¼ */
.patient-basic-info {
  padding: 12px 16px;
  background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
  border-radius: 8px;
  border: 1px solid #dee2e6;
  margin-top: 12px;
  transition: all 0.3s ease;
}

.patient-basic-info:hover {
  background: linear-gradient(135deg, #fff 0%, #f8f9fa 100%);
  box-shadow: 0 2px 8px rgba(0,0,0,0.1);
  transform: translateY(-1px);
}



/* ç—…å²å†…å®¹æç¤ºæ¡† */
.alert-info {
  background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
  border: none;
  border-radius: 8px;
}

.alert-info i {
  color: #1976d2;
}

.symptom-tags .badge {
  margin: 2px;
  font-size: 0.85rem;
  padding: 0.4em 0.8em;
}

.timeline-info {
  background: white;
  padding: 10px;
  border-radius: 5px;
  border-left: 3px solid #007bff;
}

/* æ£€æŸ¥é¡ºåºæ’åˆ—æ ·å¼ */
.examination-order-section {
  background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
  border-radius: 12px;
  padding: 20px;
  border: 1px solid #dee2e6;
}

.examination-order-list {
  min-height: 120px;
  border-radius: 8px;
  transition: all 0.3s ease;
}

.empty-drag-area {
  transition: all 0.4s ease;
}

.empty-drag-area:hover {
  background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%) !important;
  border-color: #2196f3 !important;
  transform: scale(1.02);
}

.examination-order-item {
  cursor: move;
  transition: all 0.3s ease;
  background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%) !important;
  border: 2px solid #2196f3 !important;
  border-radius: 8px;
  position: relative;
  overflow: hidden;
}

.examination-order-item::before {
  content: "";
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  height: 4px;
  background: linear-gradient(90deg, #1976d2, #42a5f5, #64b5f6);
  animation: shimmer 2s ease-in-out infinite;
}

@keyframes shimmer {
  0% { transform: translateX(-100%); }
  50% { transform: translateX(100%); }
  100% { transform: translateX(100%); }
}

.examination-order-item:hover {
  transform: translateY(-3px);
  box-shadow: 0 6px 20px rgba(33, 150, 243, 0.3);
  background: linear-gradient(135deg, #bbdefb 0%, #90caf9 100%) !important;
  border-color: #1976d2 !important;
}

.examination-order-item.dragging {
  opacity: 0.8;
  transform: rotate(3deg) scale(1.05);
  box-shadow: 0 10px 30px rgba(33, 150, 243, 0.4);
  z-index: 1000;
}

.examination-order-item .fas.fa-grip-vertical {
  color: #1976d2;
  font-size: 1.2rem;
  text-shadow: 0 1px 2px rgba(25, 118, 210, 0.3);
  transition: all 0.3s ease;
}

.examination-order-item:hover .fas.fa-grip-vertical {
  color: #0d47a1;
  transform: scale(1.1);
  text-shadow: 0 2px 4px rgba(13, 71, 161, 0.5);
}

.order-number {
  font-size: 1rem;
  font-weight: bold;
  min-width: 40px;
  height: 40px;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.3s ease;
}

.examination-order-item:hover .order-number {
  transform: scale(1.1);
  box-shadow: 0 4px 12px rgba(25, 118, 210, 0.5) !important;
}

.pulse-badge {
  animation: pulse 2s infinite;
}

@keyframes pulse {
  0% {
    box-shadow: 0 0 0 0 rgba(220, 53, 69, 0.7);
  }
  70% {
    box-shadow: 0 0 0 10px rgba(220, 53, 69, 0);
  }
  100% {
    box-shadow: 0 0 0 0 rgba(220, 53, 69, 0);
  }
}

@keyframes pulse-border {
  0% { border-color: #f44336; }
  50% { border-color: #e57373; }
  100% { border-color: #f44336; }
}

@keyframes bounce {
  0%, 20%, 50%, 80%, 100% {
    transform: translateY(0);
  }
  40% {
    transform: translateY(-5px);
  }
  60% {
    transform: translateY(-3px);
  }
}

@keyframes pulse-text {
  0% { opacity: 1; transform: scale(1); }
  50% { opacity: 0.7; transform: scale(1.1); }
  100% { opacity: 1; transform: scale(1); }
}

.pulse-text {
  animation: pulse-text 1.5s ease-in-out infinite;
}

/* å¾—åˆ†è¯¦æƒ…æ ·å¼ */
.score-details-alert {
  border-left: 4px solid #007bff;
  background: linear-gradient(135deg, #f8f9ff 0%, #e6f3ff 100%);
  animation: slideInUp 0.6s ease-out;
}

.score-item {
  padding: 10px;
  background: white;
  border-radius: 8px;
  box-shadow: 0 2px 4px rgba(0,0,0,0.1);
  transition: transform 0.3s ease;
}

.score-item:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 8px rgba(0,0,0,0.15);
}

/* å­¦ä¹ åé¦ˆï¼ˆé‡æ–°è®¾è®¡ï¼‰è¾…åŠ©æ ·å¼ï¼šæ›´æ¸…æ™°çš„å±‚çº§ä¸ç•™ç™½ */
.ff-wrapper {
  max-width: 1400px;
  margin: 0 auto;
}

.ff-hero {
  background: linear-gradient(135deg, #f8f9ff 0%, #eef7ff 100%);
}

.ff-hero-icon {
  width: 44px;
  height: 44px;
  border-radius: 12px;
  background: rgba(0, 123, 255, 0.12);
  color: #007bff;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 1.1rem;
  flex-shrink: 0;
}

.ff-score {
  font-size: 2.6rem;
  font-weight: 700;
  line-height: 1;
  color: #007bff;
}

.ff-subtitle {
  font-weight: 600;
  margin-bottom: 0.35rem;
}

.ff-subtitle i {
  margin-right: 6px;
}

.ff-review-item {
  padding-bottom: 0.75rem;
  margin-bottom: 0.75rem;
  border-bottom: 1px solid #f1f3f5;
}

.ff-review-item:last-child {
  border-bottom: none;
  padding-bottom: 0;
  margin-bottom: 0;
}

.score-value {
  font-size: 1.1rem;
  margin-bottom: 2px;
}

.score-label {
  font-weight: 500;
  margin-bottom: 1px;
}

.score-stats {
  font-size: 0.8rem;
}

@keyframes slideInUp {
  from {
    opacity: 0;
    transform: translateY(30px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

.examination-order-section .alert-warning {
  background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%);
  border: 2px solid #ffc107;
  border-radius: 8px;
}

.examination-order-section h5 {
  color: #1976d2;
  text-shadow: 0 1px 2px rgba(25, 118, 210, 0.2);
}



/* æ‹–åŠ¨çŠ¶æ€æ ·å¼ */
.examination-order-list.drag-active {
  background: linear-gradient(135deg, #e8f5e8 0%, #f1f8e9 100%);
  border: 2px dashed #4caf50;
  border-radius: 10px;
  padding: 10px;
}

.examination-order-item.drop-target {
  background: linear-gradient(135deg, #f3e5f5 0%, #e1bee7 100%) !important;
  border-color: #9c27b0 !important;
  opacity: 0.7;
  transform: scale(0.98);
}

.examination-order-item.drag-hover {
  background: linear-gradient(135deg, #fff3e0 0%, #ffcc02 100%) !important;
  border-color: #ff9800 !important;
  transform: translateY(-5px) scale(1.02);
  box-shadow: 0 8px 25px rgba(255, 152, 0, 0.4);
}

.examination-order-item.dragging {
  opacity: 0.8;
  transform: rotate(3deg) scale(1.05);
  box-shadow: 0 10px 30px rgba(33, 150, 243, 0.4);
  z-index: 1000;
  background: linear-gradient(135deg, #c8e6c9 0%, #a5d6a7 100%) !important;
  border-color: #4caf50 !important;
}

.remove-exam-btn {
  opacity: 0;
  transition: opacity 0.3s ease;
}

.examination-order-item:hover .remove-exam-btn {
  opacity: 1;
}

/* å•ä¸ªæ£€æŸ¥ç»“æœå±•ç¤ºæ ·å¼ */
.single-examination-result {
  animation: fadeInUp 0.6s ease-out;
}

.examination-progress .progress {
  background-color: #e9ecef;
  border-radius: 10px;
  overflow: hidden;
}

.examination-progress .progress-bar {
  background: linear-gradient(90deg, #007bff, #0056b3);
  transition: width 0.8s ease;
}

.current-examination-result .card {
  border: 2px solid #007bff;
  box-shadow: 0 8px 25px rgba(0, 123, 255, 0.15);
}

.result-box {
  border-left: 4px solid #007bff !important;
  background: linear-gradient(135deg, #f8f9ff 0%, #e6f3ff 100%) !important;
}

.examination-data .data-item {
  border-left: 3px solid #28a745;
  transition: all 0.3s ease;
}

.examination-data .data-item:hover {
  transform: translateX(5px);
  box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.examination-image {
  transition: all 0.3s ease;
  border: 2px solid transparent;
}

.examination-image:hover {
  transform: scale(1.05);
  border-color: #007bff;
  box-shadow: 0 8px 25px rgba(0, 123, 255, 0.3);
}

/* OCTæ£€æŸ¥ç‰¹æ®Šæ ·å¼ */
.oct-examination-display {
  background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
  border-radius: 12px;
  padding: 20px;
  margin-bottom: 20px;
}

.oct-image-container {
  background: white;
  border-radius: 8px;
  padding: 15px;
  box-shadow: 0 2px 10px rgba(0,0,0,0.1);
  transition: transform 0.3s ease, box-shadow 0.3s ease;
}

.oct-image-container:hover {
  transform: translateY(-3px);
  box-shadow: 0 4px 20px rgba(0,0,0,0.15);
}

.oct-image {
  border-radius: 6px;
  transition: all 0.3s ease;
}

.oct-image:hover {
  filter: brightness(1.05);
}

.eye-section {
  background: white;
  border-radius: 10px;
  padding: 20px;
  box-shadow: 0 2px 15px rgba(0,0,0,0.08);
}

.measurement-card {
  transition: all 0.3s ease;
  text-align: center;
}

.measurement-card:hover {
  transform: translateY(-2px);
  box-shadow: 0 2px 10px rgba(0,0,0,0.1);
}

.measurement-label {
  font-weight: 500;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

.measurement-value {
  font-weight: 600;
  font-family: 'Courier New', monospace;
}

.oct-report .report-content {
  background: white;
  box-shadow: 0 2px 10px rgba(0,0,0,0.05);
}

.image-overlay {
  position: absolute;
  top: 10px;
  right: 10px;
  z-index: 10;
}

.overlay-controls {
  display: flex;
  gap: 5px;
}

.overlay-controls .btn {
  opacity: 0.8;
  backdrop-filter: blur(5px);
  border: none;
}

.overlay-controls .btn:hover {
  opacity: 1;
}

/* æ ‡å‡†å›¾åƒæ˜¾ç¤ºæ ·å¼ */
.standard-image-container {
  background: white;
  border-radius: 8px;
  padding: 15px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.08);
  transition: all 0.3s ease;
}

.standard-image-container:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 15px rgba(0,0,0,0.12);
}

.image-findings {
  border-left: 3px solid #007bff;
}

/* æ£€æŸ¥ç¡®è®¤ç•Œé¢æ ·å¼ */
.examination-confirmed {
  animation: fadeInUp 0.6s ease-out;
}

.examination-sequence-preview .card {
  transition: all 0.3s ease;
}

.examination-sequence-preview .card:hover {
  transform: translateY(-2px);
  box-shadow: 0 8px 25px rgba(0, 123, 255, 0.15);
}

.start-examination-prompt {
  animation: pulse 2s infinite;
}

@keyframes pulse {
  0% { transform: scale(1); }
  50% { transform: scale(1.02); }
  100% { transform: scale(1); }
}

/* ç»§ç»­æç¤ºæ ·å¼ */
.continue-prompt {
  border-top: 2px dashed #dee2e6;
  padding-top: 20px;
  margin-top: 20px;
}

/* å“åº”å¼è®¾è®¡ */
@media (max-width: 768px) {
  .examination-order-section {
    padding: 15px;
  }
  
  .examination-order-item {
    margin-bottom: 10px;
  }
  
  .order-number {
    min-width: 30px;
    height: 30px;
    font-size: 0.9rem;
  }
  
  .current-examination-result .card-header h4 {
    font-size: 1.2rem;
  }
  
  .examination-data .row {
    margin: 0;
  }
  
  .examination-data .col-md-6 {
    padding: 5px;
  }
}

/* è¯Šæ–­é€‰é¡¹æ ·å¼ */
.diagnosis-option {
  border: 2px solid transparent;
  transition: all 0.3s ease;
  cursor: pointer;
}

.diagnosis-option .d-flex {
  align-items: center !important;
}

.diagnosis-option .form-check-input {
  margin-top: 0 !important;
  flex-shrink: 0 !important;
  vertical-align: middle !important;
}

.diagnosis-option .form-check-label {
  cursor: pointer;
  margin-bottom: 0 !important;
  width: 100%;
}

.diagnosis-option h6 {
  line-height: 1.2 !important;
  margin-bottom: 0.25rem !important;
}

.diagnosis-option .text-muted.small {
  margin-left: 0;
  display: block;
}

.diagnosis-option:hover {
  border-color: #007bff;
  background-color: #f8f9ff;
}

.diagnosis-option.selected {
  border-color: #007bff;
  background-color: #e6f3ff;
}

/* æ²»ç–—æ–¹æ¡ˆæ ·å¼ */
.treatment-option {
  border-left: 4px solid #dee2e6;
  transition: all 0.3s ease;
  cursor: pointer;
}

.treatment-option:hover {
  border-left-color: #007bff;
  background-color: #f8f9ff;
  transform: translateY(-2px);
  box-shadow: 0 4px 8px rgba(0,123,255,0.15);
}

.treatment-option.optimal {
  border-left-color: #28a745;
}

.treatment-option.optimal:hover {
  background-color: #f8fff9;
}

.treatment-option.acceptable {
  border-left-color: #ffc107;
}

.treatment-option.acceptable:hover {
  background-color: #fffef8;
}

.treatment-option.contraindicated {
  border-left-color: #dc3545;
  background-color: #fff5f5;
}

.treatment-option.contraindicated:hover {
  background-color: #ffebeb;
}

.treatment-option .form-check-input {
  margin-top: 0 !important;
  vertical-align: middle !important;
}

.treatment-option .treatment-badges .badge {
  margin-left: 0.25rem;
}

/* å­¦ä¹ ç»Ÿè®¡é¢æ¿ */
.learning-stats .h4 {
  font-family: 'Courier New', monospace;
  font-weight: bold;
}

/* æ—¶é—´çº¿æ ·å¼ */
.learning-timeline {
  max-height: 200px;
  overflow-y: auto;
}

.timeline-item {
  border-left: 2px solid #e9ecef;
  padding-left: 15px;
  margin-bottom: 10px;
  position: relative;
}

.timeline-item::before {
  content: '';
  position: absolute;
  left: -5px;
  top: 5px;
  width: 8px;
  height: 8px;
  background: #007bff;
  border-radius: 50%;
}

/* ä¸´åºŠè®°å½•æ ‡ç­¾æ ·å¼ */
.nav-pills .nav-link {
  cursor: pointer;
  border-radius: 20px;
  padding: 8px 16px;
  margin-right: 5px;
  background-color: #f8f9fa;
  color: #6c757d;
  border: 1px solid #dee2e6;
  transition: all 0.3s ease;
}

.nav-pills .nav-link:hover {
  background-color: #e9ecef;
  color: #495057;
  text-decoration: none;
}

.nav-pills .nav-link.active {
  background-color: #007bff;
  color: #ffffff;
  border-color: #007bff;
}

.tab-pane {
  display: none;
}

.tab-pane.show.active {
  display: block;
}

/* å“åº”å¼è®¾è®¡ */
@media (max-width: 768px) {
  .stepper-items {
    flex-direction: column;
    align-items: stretch;
  }
  
  .stepper-item {
    margin-bottom: 20px;
    flex-direction: row;
    justify-content: flex-start;
    text-align: left;
  }
  
  .stepper-item::after {
    display: none;
  }
  
  .stepper-icon {
    margin-right: 15px;
    margin-bottom: 0;
  }
}

/* åé¦ˆé¢æ¿åŠ¨ç”» */
.feedback-animation {
  animation: fadeInUp 0.5s ease-out;
}

@keyframes fadeInUp {
  from {
    opacity: 0;
    transform: translateY(20px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

/* æˆåŠŸåé¦ˆæ ·å¼ */
.feedback-positive {
  border-left: 4px solid #28a745;
  background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%);
  border-radius: 10px;
  box-shadow: 0 4px 8px rgba(40, 167, 69, 0.2);
  font-weight: 500;
}

.feedback-positive i {
  color: #ffc107;
  text-shadow: 0 1px 2px rgba(0,0,0,0.1);
}

.feedback-corrective {
  border-left: 4px solid #ffc107;
  background-color: #fff3cd;
}

.feedback-guidance {
  border-left: 4px solid #17a2b8;
  background-color: #d1ecf1;
}

/* åŠ¨ç”»æ•ˆæœæ ·å¼ */
.confetti-piece {
  border-radius: 2px;
  box-shadow: 0 1px 2px rgba(0,0,0,0.15);
}

.flash-success {
  animation: flashSuccess 0.9s ease-in-out;
}

.flash-warning {
  animation: flashWarning 0.9s ease-in-out;
}

@keyframes flashSuccess {
  0% { transform: scale(1); box-shadow: 0 0 0 rgba(40,167,69,0); }
  30% { transform: scale(1.04); box-shadow: 0 10px 30px rgba(40,167,69,0.18); }
  100% { transform: scale(1); box-shadow: 0 0 0 rgba(40,167,69,0); }
}

@keyframes flashWarning {
  0% { transform: scale(1); box-shadow: 0 0 0 rgba(255,193,7,0); }
  30% { transform: scale(1.04); box-shadow: 0 10px 30px rgba(255,193,7,0.18); }
  100% { transform: scale(1); box-shadow: 0 0 0 rgba(255,193,7,0); }
}

.step-highlight {
  animation: stepPulse 0.8s ease-out;
}

@keyframes stepPulse {
  0% { transform: scale(1); box-shadow: 0 0 0 rgba(0,123,255,0); }
  50% { transform: scale(1.08); box-shadow: 0 10px 30px rgba(0,123,255,0.22); }
  100% { transform: scale(1); box-shadow: 0 0 0 rgba(0,123,255,0); }
}

/* æ£€æŸ¥é€‰æ‹©éªŒè¯é”™è¯¯æ ·å¼ */
@keyframes shakeError {
  0%, 100% { transform: translateX(0); }
  10%, 30%, 50%, 70%, 90% { transform: translateX(-8px); }
  20%, 40%, 60%, 80% { transform: translateX(8px); }
}

@keyframes pulseError {
  0% { box-shadow: 0 0 0 0 rgba(220, 53, 69, 0.7); }
  70% { box-shadow: 0 0 0 8px rgba(220, 53, 69, 0); }
  100% { box-shadow: 0 0 0 0 rgba(220, 53, 69, 0); }
}

@keyframes pulseWarning {
  0% { box-shadow: 0 0 0 0 rgba(255, 193, 7, 0.7); }
  70% { box-shadow: 0 0 0 8px rgba(255, 193, 7, 0); }
  100% { box-shadow: 0 0 0 0 rgba(255, 193, 7, 0); }
}

/* æ£€æŸ¥é¡¹ç›®é”™è¯¯çŠ¶æ€ */
.examination-option.error-missing {
  border: 2px solid #dc3545 !important;
  background: linear-gradient(135deg, #f8d7da, #f1b0b7) !important;
  animation: pulseError 1.5s infinite;
}

.examination-option.error-missing .card-body {
  background: rgba(220, 53, 69, 0.05);
}

.examination-option.error-missing::before {
  content: "å¿…é€‰";
  position: absolute;
  top: -8px;
  right: -8px;
  background: #dc3545;
  color: white;
  padding: 2px 8px;
  border-radius: 10px;
  font-size: 0.7rem;
  font-weight: bold;
  z-index: 10;
}

.examination-option.error-extra {
  border: 2px solid #ffc107 !important;
  background: linear-gradient(135deg, #fff3cd, #ffeaa7) !important;
  animation: pulseWarning 1.5s infinite;
}

.examination-option.error-extra .card-body {
  background: rgba(255, 193, 7, 0.05);
}

.examination-option.error-extra::before {
  content: "å¤šé€‰";
  position: absolute;
  top: -8px;
  right: -8px;
  background: #ffc107;
  color: #212529;
  padding: 2px 8px;
  border-radius: 10px;
  font-size: 0.7rem;
  font-weight: bold;
  z-index: 10;
}

/* éªŒè¯é”™è¯¯æç¤ºæ ·å¼ */
.validation-error-alert {
  border-left: 5px solid #dc3545;
  box-shadow: 0 4px 20px rgba(220, 53, 69, 0.3);
}

.examination-validation-error .error-section {
  padding: 10px 15px;
  border-radius: 8px;
  background: rgba(255, 255, 255, 0.8);
}

.examination-validation-error .penalty-info {
  border-left: 4px solid #ffc107;
  font-weight: 600;
}

.examination-validation-error .action-hint {
  border-left: 4px solid #17a2b8;
}

/* æ£€æŸ¥ç»“æœå›¾ç‰‡ç¼©ç•¥å›¾æ ·å¼ */
.examination-image-thumbnail {
  cursor: pointer;
  transition: all 0.3s ease;
  box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.examination-image-thumbnail:hover {
  transform: scale(1.1);
  box-shadow: 0 4px 12px rgba(0,123,255,0.3);
  border-color: #007bff !important;
}

/* å›¾ç‰‡æ¨¡æ€æ¡†æ ·å¼ */
.examination-image-modal .modal-header {
  background: linear-gradient(135deg, #007bff, #0056b3);
  color: white;
}

.examination-image-modal .modal-header .btn-close {
  filter: brightness(0) invert(1);
}

.examination-image-modal .modal-body {
  display: flex;
  justify-content: center;
  align-items: center;
  padding: 20px;
  background: #f8f9fa;
}

.examination-image-modal .modal-body img {
  max-width: 100%;
  max-height: 70vh;
  object-fit: contain;
  border-radius: 8px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.15);
}

/* æ£€æŸ¥é€‰é¡¹å¸ƒå±€ä¼˜åŒ– */
.examination-option .form-check {
  margin-bottom: 0;
}

.examination-option .form-check-input {
  margin-top: 2px;
  flex-shrink: 0;
}

.examination-option .form-check-label {
  cursor: pointer;
  line-height: 1.4;
}

.examination-option .text-muted {
  padding-left: 0;
  margin-left: 0;
}

.examination-option .examination-info {
  padding-left: 0;
  margin-left: 0;
}

/* é€‰ä¸­çŠ¶æ€æ ·å¼ */
.examination-option.selected {
  background-color: #e7f3ff;
  border-color: #007bff;
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(0, 123, 255, 0.15);
}

.examination-option:hover {
  transform: translateY(-1px);
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
  transition: all 0.2s ease;
}

/* ç»Ÿè®¡åŒºåŸŸæ ·å¼ä¼˜åŒ– */
.examination-summary h5 {
  border-bottom: 2px solid #007bff;
  padding-bottom: 8px;
  display: inline-block;
  margin-bottom: 25px;
}

.examination-summary .card-body {
  padding: 2rem;
}

/* æ£€æŸ¥é¡ºåºé¢„è§ˆæ ·å¼ */
.examination-sequence-preview h3 {
  text-shadow: 0 2px 4px rgba(0,123,255,0.1);
}

.sequence-cards-container {
  max-width: 100%;
  margin: 0 auto;
  overflow-x: auto;
}

.sequence-cards-container > div {
  display: flex !important;
  flex-wrap: wrap !important;
  gap: 15px !important;
  justify-content: flex-start !important;
}

.sequence-card {
  background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
  border: 2px solid #007bff;
  border-radius: 12px;
  padding: 15px 20px;
  text-align: center;
  min-width: 140px;
  width: calc(33.333% - 10px); /* æ¯è¡Œæœ€å¤š3ä¸ªï¼Œè€ƒè™‘é—´è· */
  max-width: 200px;
  box-shadow: 0 4px 12px rgba(0, 123, 255, 0.15);
  transition: all 0.3s ease;
  position: relative;
  flex: 0 0 calc(33.333% - 10px) !important;
  display: inline-block !important;
}

.sequence-card:hover {
  transform: translateY(-3px);
  box-shadow: 0 8px 20px rgba(0, 123, 255, 0.25);
}

.sequence-number {
  background: #007bff;
  color: white;
  width: 30px;
  height: 30px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: bold;
  font-size: 1.1rem;
  margin: 0 auto 10px auto;
}

.sequence-name {
  font-weight: 600;
  color: #2c3e50;
  font-size: 0.9rem;
  line-height: 1.3;
  word-wrap: break-word;
}

/* å“åº”å¼è°ƒæ•´ */
@media (max-width: 768px) {
  .examination-summary .card-body {
    padding: 1.5rem;
  }
  
  .examination-summary h5 {
    font-size: 1.1rem;
    margin-bottom: 20px;
  }
  
  .examination-sequence-preview h3 {
    font-size: 1.4rem !important;
  }
  
  .sequence-cards-container > div {
    flex-direction: row !important;
    flex-wrap: wrap !important;
    justify-content: flex-start !important;
  }
  
  .sequence-card {
    min-width: 100px;
    width: calc(33.333% - 10px); /* ç§»åŠ¨ç«¯ä¹Ÿä¿æŒæ¯è¡Œ3ä¸ª */
    max-width: 130px;
    flex: 0 0 calc(33.333% - 10px) !important;
    margin: 5px 0;
  }
}

/* ä¸´åºŠç¬”è®°æ ·å¼å¢å¼º */
.notes-container {
  position: relative;
}

.notes-header {
  border-bottom: 1px solid #e9ecef;
  padding-bottom: 8px;
}

.notes-info {
  display: flex;
  align-items: center;
  gap: 8px;
}

#clinical-notes {
  resize: vertical;
  min-height: 120px;
  border: 2px solid #dee2e6;
  transition: border-color 0.3s ease, box-shadow 0.3s ease;
}

#clinical-notes:focus {
  border-color: #007bff;
  box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
}

/* ç¬”è®°ä¿å­˜æˆåŠŸé—ªçƒæ•ˆæœ */
.notes-saved-flash {
  border-color: #28a745 !important;
  box-shadow: 0 0 0 0.2rem rgba(40, 167, 69, 0.25) !important;
  animation: notesSavedPulse 1s ease-in-out;
}

@keyframes notesSavedPulse {
  0% { transform: scale(1); }
  50% { transform: scale(1.02); }
  100% { transform: scale(1); }
}

/* å­—æ•°ç»Ÿè®¡æ ·å¼ */
#notes-char-count {
  font-weight: 500;
  transition: color 0.3s ease;
}

/* ==================== ç—…å²é‡‡é›†ç‰¹æ®Šå¸ƒå±€æ ·å¼ ==================== */

/* å…¨å±ä¼˜åŒ– */
body {
  overflow-x: hidden;
}

#history-collection-fullscreen.show {
  display: flex !important;
}

/* ç¡®ä¿æ‰€æœ‰åˆ—çš„é«˜åº¦ä¸€è‡´ä¸”è‡ªé€‚åº” */
#history-collection-fullscreen .row > .col-6 {
  display: flex !important;
  flex-direction: column;
  max-height: calc(100vh - 140px);
}

#history-collection-fullscreen .card {
  flex: 1;
  display: flex;
  flex-direction: column;
  height: 100%;
}

#traditional-layout.hide {
  display: none !important;
}

/* å¡ç‰‡æ ·å¼ä¼˜åŒ– */
#history-collection-fullscreen .card {
  border: 1px solid #dee2e6 !important;
  box-shadow: 0 2px 10px rgba(0,0,0,0.1) !important;
}

/* èŠå¤©åŒºåŸŸè‡ªé€‚åº” */
#history-collection-fullscreen .chat-messages {
  flex: 1 !important;
  min-height: 0 !important;
  overflow-y: auto !important;
}

/* å¡ç‰‡ä¸»ä½“è‡ªé€‚åº” */
#history-collection-fullscreen .card-body {
  flex: 1 !important;
  min-height: 0 !important;
  display: flex !important;
  flex-direction: column !important;
}

/* ä¿¡æ¯æ±‡æ€»å¡ç‰‡ç´§å‡‘æ ·å¼ */
#history-summary-panel .mb-3 {
  margin-bottom: 0.8rem !important;
}

#history-summary-panel .border {
  border: 1px solid #e9ecef !important;
  margin-bottom: 0.5rem;
}

/* èŠå¤©åŒºåŸŸä¼˜åŒ– */
.chat-messages {
  background: linear-gradient(180deg, #ffffff 0%, #f8f9fa 100%);
}

/* å¿«é€ŸæŒ‰é’®åŒºåŸŸä¼˜åŒ– */
.quick-questions {
  border-top: 2px solid #e9ecef !important;
}

/* è¾“å…¥æ¡†åŒºåŸŸä¼˜åŒ– */
.chat-input-container {
  border-top: 2px solid #dee2e6 !important;
}

/* å“åº”å¼è®¾è®¡ - å……åˆ†åˆ©ç”¨å±å¹•ç©ºé—´ */
@media (max-width: 1199.98px) {
  #history-collection-fullscreen {
    height: calc(100vh - 140px) !important;
  }
  
  .chat-messages {
    height: calc(100vh - 320px) !important;
  }
  
  #history-summary-panel .card-body {
    height: calc(100vh - 200px) !important;
  }
}

@media (max-width: 991.98px) {
  #history-collection-fullscreen .col-6 {
    margin-bottom: 1rem;
  }
  
  #history-collection-fullscreen {
    height: auto !important;
  }
  
  .chat-messages {
    height: 300px !important;
  }
  
  #history-summary-panel .card-body {
    height: 400px !important;
  }
}

@media (max-width: 767.98px) {
  .container-fluid {
    padding-left: 0.5rem !important;
    padding-right: 0.5rem !important;
  }
  
  #history-collection-fullscreen .px-1 {
    padding-left: 0.25rem !important;
    padding-right: 0.25rem !important;
  }
  
  .chat-messages {
    height: 250px !important;
    padding: 0.5rem !important;
  }
}

/* å¤§å±å¹•ä¼˜åŒ– */
@media (min-width: 1400px) {
  #history-collection-fullscreen {
    height: calc(100vh - 180px) !important;
  }
  
  .chat-messages {
    height: calc(100vh - 360px) !important;
  }
  
  #history-summary-panel .card-body {
    height: calc(100vh - 240px) !important;
  }
}

#history-summary-panel .card-body {
  background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
}

/* å·¦ä¾§é¢æ¿å®¹å™¨æ»šåŠ¨æ¡æ ·å¼ */
.left-panel-scroll {
  scrollbar-width: thin;
  scrollbar-color: #007bff #e9ecef;
}

/* è‡ªå®šä¹‰æ»šåŠ¨æ¡æ ·å¼ï¼ˆWebkitæµè§ˆå™¨ï¼‰ */
.left-panel-scroll::-webkit-scrollbar {
  width: 10px;
}

.left-panel-scroll::-webkit-scrollbar-track {
  background: #e9ecef;
  border-radius: 5px;
  margin: 4px 0;
}

.left-panel-scroll::-webkit-scrollbar-thumb {
  background: linear-gradient(180deg, #007bff, #0056b3);
  border-radius: 5px;
  border: 2px solid #e9ecef;
  transition: background 0.3s;
}

.left-panel-scroll::-webkit-scrollbar-thumb:hover {
  background: linear-gradient(180deg, #0056b3, #004085);
}

#patient-chat-panel .card-body {
  background: #f8f9fa;
}

.quick-questions .btn {
  font-size: 0.75rem;
  margin: 2px;
  border-radius: 15px;
  transition: all 0.2s ease;
}

.quick-questions .btn:hover {
  transform: translateY(-1px);
  box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.chat-messages-history {
  background: linear-gradient(180deg, #ffffff 0%, #f8f9fa 100%);
}

.student-message .chat-bubble {
  background: linear-gradient(135deg, #007bff, #0056b3) !important;
  color: white !important;
  border-radius: 18px 4px 18px 18px !important;
}

.patient-message .chat-bubble {
  background: #ffffff !important;
  border: 1px solid #e9ecef !important;
  border-radius: 4px 18px 18px 18px !important;
}

.system-message .chat-bubble {
  background: linear-gradient(135deg, #ffc107, #ff8f00) !important;
  color: white !important;
  border-radius: 15px !important;
}

#history-control-panel {
  background: linear-gradient(135deg, #e3f2fd, #bbdefb);
  border: none;
  box-shadow: 0 4px 6px rgba(0,0,0,0.1);
}

#history-collection-progress {
  background: linear-gradient(90deg, #17a2b8, #138496) !important;
  transition: width 0.5s ease;
}

/* ä¿¡æ¯æ±‡æ€»é¢æ¿ä¸­çš„å„ä¸ªä¿¡æ¯å¡ç‰‡ */
.info-summary-card {
  background: white;
  border: 1px solid #e9ecef;
  border-radius: 8px;
  transition: all 0.3s ease;
  position: relative;
  overflow: hidden;
}

.info-summary-card::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  width: 4px;
  height: 100%;
  background: linear-gradient(180deg, #007bff, #0056b3);
}

.info-summary-card.has-info {
  border-color: #007bff;
  box-shadow: 0 2px 4px rgba(0,123,255,0.1);
}

.info-summary-card.has-info::before {
  background: linear-gradient(180deg, #28a745, #20c997);
}

/* ä¿å­˜çŠ¶æ€æ ·å¼ */
#notes-save-status {
  font-weight: 500;
  transition: opacity 0.3s ease;
}

#notes-save-status i {
  margin-right: 4px;
}

/* ç¬”è®°åº•éƒ¨æç¤ºæ ·å¼ */
.notes-footer {
  border-top: 1px solid #e9ecef;
  padding-top: 8px;
}

.notes-footer .text-muted {
  font-size: 0.875rem;
}

.notes-footer i {
  color: #007bff;
  margin-right: 6px;
}

/* ==================== èŠå¤©çª—å£æ ·å¼ ==================== */
.chat-window-container {
  position: relative;
  transition: all 0.3s ease;
}

.chat-header {
  cursor: pointer;
  transition: background-color 0.3s ease;
}

.chat-header:hover {
  background-color: #138496 !important;
}

.chat-body {
  transition: all 0.3s ease;
}

.chat-body.collapsed {
  height: 0 !important;
  overflow: hidden;
}

.chat-messages {
  padding: 15px;
  background: #f8f9fa;
}

.chat-message {
  margin-bottom: 15px;
  animation: slideInUp 0.3s ease-out;
}

@keyframes slideInUp {
  from {
    opacity: 0;
    transform: translateY(20px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

.message-student {
  display: flex;
  justify-content: flex-end;
}

.message-patient {
  display: flex;
  justify-content: flex-start;
}

.message-system {
  display: flex;
  justify-content: center;
}

.message-bubble {
  max-width: 80%;
  padding: 10px 15px;
  border-radius: 18px;
  position: relative;
  word-wrap: break-word;
  box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
}

.message-student .message-bubble {
  background: linear-gradient(135deg, #007bff, #0056b3);
  color: white;
  border-bottom-right-radius: 5px;
}

.message-patient .message-bubble {
  background: white;
  color: #333;
  border: 1px solid #e9ecef;
  border-bottom-left-radius: 5px;
}

.message-system .message-bubble {
  background: #fff3cd;
  color: #856404;
  border: 1px solid #ffeaa7;
  font-size: 0.9em;
  font-style: italic;
  border-radius: 15px;
}

.message-avatar {
  width: 32px;
  height: 32px;
  border-radius: 50%;
  margin: 0 8px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 0.8em;
  font-weight: bold;
  flex-shrink: 0;
}

.avatar-student {
  background: linear-gradient(135deg, #28a745, #20c997);
  color: white;
}

.avatar-patient {
  background: linear-gradient(135deg, #6f42c1, #e83e8c);
  color: white;
}

.message-timestamp {
  font-size: 0.75em;
  color: #6c757d;
  margin-top: 5px;
  text-align: right;
}

.message-patient .message-timestamp {
  text-align: left;
}

.message-system .message-timestamp {
  text-align: center;
}

.chat-input-container {
  border-top: 2px solid #e9ecef;
  background: white;
}

.chat-input-container input:focus {
  border-color: #17a2b8;
  box-shadow: 0 0 0 0.2rem rgba(23, 162, 184, 0.25);
}

.chat-input-container button:hover {
  background: #138496;
}

/* èŠå¤©çª—å£çŠ¶æ€æŒ‡ç¤º */
.chat-stage-badge {
  font-size: 0.75em;
  padding: 2px 6px;
}

/* ç¦ç”¨çŠ¶æ€æ ·å¼ */
.chat-disabled .chat-input-container input {
  background-color: #e9ecef;
  color: #6c757d;
  cursor: not-allowed;
}

.chat-disabled .chat-input-container button {
  background-color: #6c757d;
  cursor: not-allowed;
}

/* æ¶ˆæ¯åŠ è½½åŠ¨ç”» */
.message-loading {
  display: flex;
  align-items: center;
  justify-content: flex-start;
  margin-bottom: 15px;
}

.message-loading .message-bubble {
  background: #f8f9fa;
  border: 1px solid #dee2e6;
  padding: 15px;
  border-radius: 18px;
}

.typing-indicator {
  display: flex;
  align-items: center;
  gap: 4px;
}

.typing-dot {
  width: 8px;
  height: 8px;
  background-color: #6c757d;
  border-radius: 50%;
  animation: typingAnimation 1.4s infinite ease-in-out both;
}

.typing-dot:nth-child(1) { animation-delay: -0.32s; }
.typing-dot:nth-child(2) { animation-delay: -0.16s; }
.typing-dot:nth-child(3) { animation-delay: 0s; }

@keyframes typingAnimation {
  0%, 80%, 100% {
    opacity: 0.3;
    transform: scale(0.8);
  }
  40% {
    opacity: 1;
    transform: scale(1);
  }
}

/* å“åº”å¼é€‚é… */
@media (max-width: 768px) {
  .chat-body {
    height: 350px !important;
  }
  
  .chat-messages {
    height: 270px !important;
  }
  
  .message-bubble {
    max-width: 90%;
    font-size: 0.9em;
  }
  
  .message-avatar {
    width: 28px;
    height: 28px;
    font-size: 0.7em;
  }
}
</style>
{% endblock %}

{% block extra_js %}
<script src="{% static 'clinical_config.js' %}"></script>
<script>
// ä¸´åºŠæ¨ç†æ•™å­¦ç³»ç»Ÿ - é‡æ–°è®¾è®¡çš„äº¤äº’é€»è¾‘
// ä½œä¸ºåŒ»ç–—æ•™è‚²å·¥ç¨‹å¸ˆï¼Œæˆ‘è®¾è®¡äº†ä¸€ä¸ªæ›´è´´è¿‘çœŸå®ä¸´åºŠæ€ç»´çš„å­¦ä¹ ç³»ç»Ÿ

// ==================== å…¨å±€å‡½æ•°å®šä¹‰ ====================
// è¿™äº›å‡½æ•°å¿…é¡»åœ¨å…¨å±€ä½œç”¨åŸŸä¸­ï¼Œä»¥ä¾¿HTML onclickå±æ€§èƒ½å¤Ÿè®¿é—®

// å¿«é€Ÿé—®é¢˜å‡½æ•°
window.quickQuestion = function(question) {
  console.log('å¿«é€Ÿé—®é¢˜è¢«ç‚¹å‡»:', question);
  
  const inputElement = $('#chat-input-history');
  if (inputElement.length === 0) {
    console.error('æ‰¾ä¸åˆ°èŠå¤©è¾“å…¥æ¡†å…ƒç´ ');
    return;
  }
  
  inputElement.val(question);
  window.sendHistoryChatMessage();
};

// å‘é€ç—…å²èŠå¤©æ¶ˆæ¯
window.sendHistoryChatMessage = function() {
  console.log('å‘é€èŠå¤©æ¶ˆæ¯å‡½æ•°è¢«è°ƒç”¨');
  
  const inputElement = document.getElementById('chat-input-history');
  if (!inputElement) {
    console.error('æ‰¾ä¸åˆ°èŠå¤©è¾“å…¥æ¡†');
    return;
  }
  
  const message = inputElement.value.trim();
  console.log('æ¶ˆæ¯å†…å®¹:', message);
  
  if (!message) {
    console.log('æ¶ˆæ¯ä¸ºç©ºï¼Œä¸å‘é€');
    return;
  }
  
  // è·å–clinicalSessionä»å…¨å±€å˜é‡
  if (!window.clinicalSessionGlobal) {
    console.error('clinicalSessionæœªåˆå§‹åŒ–');
    return;
  }
  
  // æ˜¾ç¤ºå­¦ç”Ÿé—®é¢˜
  window.addHistoryChatMessage('student_question', message, 'student');
  inputElement.value = '';
  
  // æ›´æ–°é—®é¢˜è®¡æ•°
  window.updateQuestionCount();
  
  // å‘é€åˆ°åç«¯è·å–æ‚£è€…å›ç­”
  $.ajax({
    url: '/api/clinical/case/' + window.clinicalSessionGlobal.caseId + '/chat/',
    method: 'POST',
    data: JSON.stringify({
      message: message
    }),
    contentType: 'application/json',
    headers: {
      'X-CSRFToken': $('[name=csrfmiddlewaretoken]').val()
    },
    success: function(response) {
      if (response.success) {
        window.addHistoryChatMessage('patient_response', response.response.content, 'patient');
        // åˆ†æå›ç­”å¹¶æ›´æ–°ä¿¡æ¯æ±‡æ€»
        if (window.analyzePatientResponse) {
          window.analyzePatientResponse(message, response.response.content);
        }
      } else {
        window.addHistoryChatMessage('system_hint', 'æŠ±æ­‰ï¼Œå‡ºç°äº†ä¸€äº›é—®é¢˜ï¼š' + response.error, 'system');
      }
    },
    error: function() {
      window.addHistoryChatMessage('system_hint', 'ç½‘ç»œè¿æ¥å‡ºç°é—®é¢˜ï¼Œè¯·é‡è¯•ã€‚', 'system');
    }
  });
};

// ç”³è¯·ä½“æ ¼æ£€æŸ¥
window.requestPhysicalExam = function() {
  console.log('ç”³è¯·ä½“æ ¼æ£€æŸ¥');
  
  // æ˜¾ç¤ºåŠ è½½æç¤º
  addChatMessage('system_hint', 'æ­£åœ¨è¿›è¡Œä½“æ ¼æ£€æŸ¥...');
  
  // è¯·æ±‚ä½“æ ¼æ£€æŸ¥ä¿¡æ¯
  $.ajax({
    url: `/api/clinical/case/${clinicalSession.caseId}/physical-exam/`,
    method: 'GET',
    headers: {
      'X-CSRFToken': $('[name=csrfmiddlewaretoken]').val()
    },
    success: function(response) {
      if (response.success && response.data) {
        // æ˜¾ç¤ºä½“æ ¼æ£€æŸ¥åŒºåŸŸ
        $('#physical-exam-section').show();
        
        // æ„å»ºä½“æ ¼æ£€æŸ¥ç»“æœHTML
        let examHtml = '<div class="physical-exam-results">';
        
        if (response.data.visual_acuity) {
          examHtml += `
            <div class="exam-item mb-2">
              <strong class="text-primary"><i class="fas fa-eye me-1"></i>è§†åŠ›ï¼š</strong>
              <span>${response.data.visual_acuity}</span>
            </div>`;
        }
        if (response.data.intraocular_pressure) {
          examHtml += `
            <div class="exam-item mb-2">
              <strong class="text-primary"><i class="fas fa-compress me-1"></i>çœ¼å‹ï¼š</strong>
              <span>${response.data.intraocular_pressure}</span>
            </div>`;
        }
        if (response.data.external_eye) {
          examHtml += `
            <div class="exam-item mb-2">
              <strong class="text-primary"><i class="fas fa-eye-slash me-1"></i>çœ¼å¤–è§‚ï¼š</strong>
              <span>${response.data.external_eye}</span>
            </div>`;
        }
        if (response.data.pupil) {
          examHtml += `
            <div class="exam-item mb-2">
              <strong class="text-primary"><i class="fas fa-circle me-1"></i>ç³å­”ï¼š</strong>
              <span>${response.data.pupil}</span>
            </div>`;
        }
        if (response.data.conjunctiva) {
          examHtml += `
            <div class="exam-item mb-2">
              <strong class="text-primary"><i class="fas fa-low-vision me-1"></i>ç»“è†œï¼š</strong>
              <span>${response.data.conjunctiva}</span>
            </div>`;
        }
        if (response.data.cornea) {
          examHtml += `
            <div class="exam-item mb-2">
              <strong class="text-primary"><i class="fas fa-circle-notch me-1"></i>è§’è†œï¼š</strong>
              <span>${response.data.cornea}</span>
            </div>`;
        }
        
        examHtml += '</div>';
        
        // æ›´æ–°ä½“æ ¼æ£€æŸ¥æ˜¾ç¤ºåŒºåŸŸ
        $('#physical-exam-summary').html(examHtml);
        
        // åœ¨èŠå¤©çª—å£æ˜¾ç¤ºç®€çŸ­æç¤º
        addChatMessage('system_hint', 'âœ… ä½“æ ¼æ£€æŸ¥å·²å®Œæˆï¼Œç»“æœå·²æ˜¾ç¤ºåœ¨å·¦ä¾§ä¿¡æ¯æ±‡æ€»åŒºåŸŸ');
        
        // æ›´æ–°é—®è¯Šè®¡æ•°
        window.updateQuestionCount();
      } else {
        addChatMessage('system_hint', 'æš‚æ— ä½“æ ¼æ£€æŸ¥ä¿¡æ¯');
      }
    },
    error: function(xhr, status, error) {
      console.error('ä½“æ ¼æ£€æŸ¥è¯·æ±‚å¤±è´¥:', error);
      addChatMessage('system_hint', 'è·å–ä½“æ ¼æ£€æŸ¥ä¿¡æ¯å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
    }
  });
};

// è¿›å…¥æ£€æŸ¥é€‰æ‹©é˜¶æ®µ
window.proceedToExamination = function() {
  console.log('è¿›å…¥æ£€æŸ¥é€‰æ‹©é˜¶æ®µ');

  // ä½¿ç”¨ç»Ÿä¸€ç»Ÿè®¡å£å¾„ï¼Œç¡®ä¿ä¸å³ä¾§â€œé—®è¯Šè¿›åº¦â€ä¸€è‡´
  const asked = (typeof window.getAskedQuestionCount === 'function') ? window.getAskedQuestionCount() : (window.questionCount || 0);
  window.questionCount = asked;
  const minQuestions = (window.CLINICAL_CONFIG && Number.isFinite(window.CLINICAL_CONFIG.MIN_HISTORY_QUESTIONS))
    ? window.CLINICAL_CONFIG.MIN_HISTORY_QUESTIONS
    : 3;
  if (asked < minQuestions) {
    if (!confirm('æ‚¨åªé—®äº†' + asked + 'ä¸ªé—®é¢˜ï¼Œå»ºè®®å¤šè¯¢é—®ä¸€äº›ç—…å²ä¿¡æ¯ã€‚æ˜¯å¦ç¡®å®šè¿›å…¥ä¸‹ä¸€é˜¶æ®µï¼Ÿ')) {
      return;
    }
  }
  
  // åŒæ­¥é˜¶æ®µåˆ‡æ¢åˆ°åç«¯
  if (typeof updateSessionStage === 'function') {
    updateSessionStage('examination_selection').then(() => {
      // éšè—ç—…å²é‡‡é›†å¸ƒå±€
      if (typeof hideHistoryCollectionLayout === 'function') {
        hideHistoryCollectionLayout();
      }
      
      // è¿›å…¥ä¸‹ä¸€é˜¶æ®µ
      clinicalSession.currentStage = 'examination_selection';
      if (typeof updateClinicalProgress === 'function') {
        updateClinicalProgress();
      }
      
      // åŠ è½½æ£€æŸ¥é˜¶æ®µæ•°æ®
      if (typeof initializeExaminationStage === 'function') {
        initializeExaminationStage();
      }
    }).catch(error => {
      console.error('é˜¶æ®µåˆ‡æ¢å¤±è´¥:', error);
      alert('é˜¶æ®µåˆ‡æ¢å¤±è´¥ï¼Œè¯·é‡è¯•');
    });
  } else {
    console.error('updateSessionStageå‡½æ•°æœªå®šä¹‰');
  }
};

// åˆå§‹åŒ–æ£€æŸ¥é€‰æ‹©é˜¶æ®µ
window.initializeExaminationStage = function() {
  console.log('åˆå§‹åŒ–æ£€æŸ¥é€‰æ‹©é˜¶æ®µ');
  
  // æ›´æ–°å½“å‰é˜¶æ®µ
  clinicalSession.currentStage = 'examination_selection';
  
  // æ£€æŸ¥é˜¶æ®µå…è®¸èŠå¤©ï¼Œä¸éœ€è¦ç¦ç”¨
  
  // æ›´æ–°å…¨å±ç•Œé¢æ ‡é¢˜æ çš„é˜¶æ®µæ–‡å­—
  $('#history-collection-fullscreen .logo-circle + div small').text('è¾…åŠ©æ£€æŸ¥é˜¶æ®µ');
  
  // å·¦ä¾§ç—…å²ä¿¡æ¯æ±‡æ€»ä¿æŒä¸å˜
  // åªæ›´æ–°å³ä¾§æ“ä½œåŒºåŸŸ
  
  const rightPanel = $('#history-collection-fullscreen .col-6').eq(1);
  if (rightPanel.length) {
    // æ›´æ–°å³ä¾§å¡ç‰‡å†…å®¹
    const newContent = `
      <div class="card shadow-sm d-flex flex-column w-100" style="height: 100%;">
        <div class="card-header bg-warning text-white py-2 flex-shrink-0">
          <h6 class="mb-0 fw-bold">
            <i class="fas fa-microscope me-2"></i>
            è¾…åŠ©æ£€æŸ¥ç”³è¯·
          </h6>
        </div>
        <div class="card-body p-3 flex-grow-1" style="overflow-y: auto; min-height: 0;">
          <div class="alert alert-info mb-3">
            <i class="fas fa-info-circle me-2"></i>
            æ ¹æ®ç—…å²å’Œä½“æ ¼æ£€æŸ¥ï¼Œé€‰æ‹©æ‚¨è®¤ä¸ºå¿…è¦çš„è¾…åŠ©æ£€æŸ¥
          </div>
          
          <div id="examination-options-container">
            <div class="text-center text-muted py-3">
              <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">åŠ è½½ä¸­...</span>
              </div>
              <p class="mt-2">æ­£åœ¨åŠ è½½æ£€æŸ¥é€‰é¡¹...</p>
            </div>
          </div>
        </div>
        <div class="card-footer bg-light border-top flex-shrink-0">
          <div class="d-flex justify-content-between align-items-center">
            <div class="text-muted small">
              <i class="fas fa-info-circle me-1"></i>
              å·²é€‰æ‹© <span id="selected-exam-count" class="fw-bold text-primary">0</span> é¡¹æ£€æŸ¥
            </div>
            <button class="btn btn-success" id="btn-proceed-to-diagnosis" onclick="proceedToDiagnosis()">
              <i class="fas fa-stethoscope me-1"></i>
              è¿›å…¥è¯Šæ–­æ¨ç†
              <i class="fas fa-arrow-right ms-1"></i>
            </button>
          </div>
        </div>
      </div>
    `;
    
    rightPanel.html(newContent);
    
    // åŠ è½½æ£€æŸ¥é€‰é¡¹
    loadExaminationOptionsFromAPI();
  }
};

// ä»APIåŠ è½½æ£€æŸ¥é€‰é¡¹
window.loadExaminationOptionsFromAPI = function() {
  $.ajax({
    url: `/api/clinical/case/${clinicalSession.caseId}/examinations/`,
    method: 'GET',
    headers: {
      'X-CSRFToken': $('[name=csrfmiddlewaretoken]').val()
    },
    success: function(response) {
      console.log('æ£€æŸ¥é€‰é¡¹APIå“åº”:', response);
      if (response.success && response.data && response.data.examination_options) {
        displayExaminationOptions(response.data.examination_options);
      } else {
        $('#examination-options-container').html(`
          <div class="alert alert-warning">
            <i class="fas fa-exclamation-triangle me-2"></i>
            æš‚æ— å¯ç”¨çš„æ£€æŸ¥é€‰é¡¹
          </div>
        `);
      }
    },
    error: function(xhr, status, error) {
      console.error('åŠ è½½æ£€æŸ¥é€‰é¡¹å¤±è´¥:', error);
      $('#examination-options-container').html(`
        <div class="alert alert-danger">
          <i class="fas fa-times-circle me-2"></i>
          åŠ è½½å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•
        </div>
      `);
    }
  });
};

// æ˜¾ç¤ºæ£€æŸ¥é€‰é¡¹
window.displayExaminationOptions = function(options) {
  console.log('æ˜¾ç¤ºæ£€æŸ¥é€‰é¡¹:', options);
  let html = '<div class="examination-options-list">';
  
  options.forEach(function(option) {
    const examName = option.name || option.examination_name;
    const examDesc = option.description || option.examination_description || '';
    const examId = typeof option.id === 'string' ? `'${option.id}'` : option.id;
    
    html += `
      <div class="card mb-3 examination-option-card" data-exam-id="${option.id}">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-start">
            <div class="flex-grow-1">
              <h6 class="mb-1">${examName}</h6>
              <small class="text-muted">${examDesc}</small>
            </div>
            <button class="btn btn-sm btn-primary ms-2" 
                    onclick="requestExamination(${examId}, '${examName.replace(/'/g, "\\'")}')">
              <i class="fas fa-play me-1"></i>
              ç”³è¯·æ£€æŸ¥
            </button>
          </div>
        </div>
      </div>
    `;
  });
  
  html += '</div>';
  
  $('#examination-options-container').html(html);
};

// ç”³è¯·å•é¡¹æ£€æŸ¥
window.requestExamination = function(examId, examName) {
  console.log(`ç”³è¯·æ£€æŸ¥: ${examName} (ID: ${examId})`);
  
  // ç¦ç”¨æŒ‰é’®ï¼Œé˜²æ­¢é‡å¤ç‚¹å‡»
  const button = $(`.examination-option-card[data-exam-id="${examId}"] button`);
  button.prop('disabled', true).html('<i class="fas fa-spinner fa-spin me-1"></i>å¤„ç†ä¸­...');
  
  // ç‰¹æ®Šå¤„ç†ï¼šä½“æ ¼æ£€æŸ¥
  if (examId === 'physical_exam') {
    // è·å–ä½“æ ¼æ£€æŸ¥å†…å®¹
    const physicalExamContent = $('#physical-exam-summary').html();
    
    if (physicalExamContent && physicalExamContent.trim() !== '') {
      // æ·»åŠ ä½“æ ¼æ£€æŸ¥ç»“æœ
      addExaminationResult('ä½“æ ¼æ£€æŸ¥', {
        actual_result: physicalExamContent,
        is_relevant: true,
        images: []
      });
      
      // æ›´æ–°æŒ‰é’®çŠ¶æ€
      button.removeClass('btn-primary').addClass('btn-success')
            .html('<i class="fas fa-check me-1"></i>å·²å®Œæˆ');
      
      // é«˜äº®å¡ç‰‡
      $(`.examination-option-card[data-exam-id="${examId}"]`)
        .addClass('border-success').css('background-color', '#f0fff4');
      
      // æ›´æ–°å·²é€‰æ‹©æ£€æŸ¥è®¡æ•°
      updateSelectedExamCount();
    } else {
      button.prop('disabled', false)
            .removeClass('btn-primary').addClass('btn-warning')
            .html('<i class="fas fa-exclamation me-1"></i>æš‚æ— æ•°æ®');
    }
    return;
  }
  
  // æ™®é€šæ£€æŸ¥ - è¯·æ±‚æ£€æŸ¥ç»“æœ
  $.ajax({
    url: `/api/clinical/case/${clinicalSession.caseId}/examination/${examId}/`,
    method: 'GET',
    headers: {
      'X-CSRFToken': $('[name=csrfmiddlewaretoken]').val()
    },
    success: function(response) {
      console.log('æ£€æŸ¥ç»“æœAPIå“åº”:', response);
      
      // æ­£ç¡®æ£€æŸ¥ï¼šresponse.success = true, response.data åŒ…å«è¯¦ç»†ç»“æœ
      // å¹²æ‰°é¡¹ï¼šresponse.success = false, response.result åŒ…å«"æ— ç›¸å…³æ£€æŸ¥ä¿¡æ¯"
      
      if (response.success && response.data) {
        // æ­£ç¡®æ£€æŸ¥ - æ˜¾ç¤ºè¯¦ç»†ç»“æœ
        addExaminationResult(examName, {
          actual_result: response.data.result || response.data.actual_result,
          is_relevant: true,
          images: response.data.images || []
        });
        
        // æ›´æ–°æŒ‰é’®çŠ¶æ€
        button.removeClass('btn-primary').addClass('btn-success')
              .html('<i class="fas fa-check me-1"></i>å·²å®Œæˆ');
        
        // é«˜äº®å¡ç‰‡
        $(`.examination-option-card[data-exam-id="${examId}"]`)
          .addClass('border-success').css('background-color', '#f0fff4');
        
        // æ›´æ–°å·²é€‰æ‹©æ£€æŸ¥è®¡æ•°
        updateSelectedExamCount();
      } else if (response.result) {
        // å¹²æ‰°é¡¹ - æ˜¾ç¤º"æ— ç›¸å…³æ£€æŸ¥ä¿¡æ¯"
        addExaminationResult(examName, response.result);
        
        // æ›´æ–°æŒ‰é’®çŠ¶æ€
        button.removeClass('btn-primary').addClass('btn-secondary')
              .html('<i class="fas fa-times me-1"></i>æ— å…³æ£€æŸ¥');
        
        // ç°è‰²å¡ç‰‡
        $(`.examination-option-card[data-exam-id="${examId}"]`)
          .addClass('border-secondary').css('background-color', '#f8f9fa');
        
        // æ›´æ–°å·²é€‰æ‹©æ£€æŸ¥è®¡æ•°
        updateSelectedExamCount();
      }
    },
    error: function(xhr, status, error) {
      console.error('æ£€æŸ¥è¯·æ±‚å¤±è´¥:', error);
      button.prop('disabled', false)
            .removeClass('btn-primary').addClass('btn-danger')
            .html('<i class="fas fa-exclamation-triangle me-1"></i>è¯·æ±‚å¤±è´¥');
    }
  });
};

// è‡ªåŠ¨å°†ä½“æ ¼æ£€æŸ¥æ·»åŠ åˆ°è¾…åŠ©æ£€æŸ¥ç»“æœåŒºåŸŸ
window.addPhysicalExamToResults = function() {
  // æ£€æŸ¥ä½“æ ¼æ£€æŸ¥åŒºåŸŸæ˜¯å¦å·²æ˜¾ç¤º
  const physicalExamSection = $('#physical-exam-section');
  if (physicalExamSection.length === 0 || physicalExamSection.is(':hidden')) {
    console.log('ä½“æ ¼æ£€æŸ¥åŒºåŸŸæœªæ˜¾ç¤ºï¼Œè·³è¿‡è‡ªåŠ¨æ·»åŠ ');
    return;
  }
  
  // è·å–ä½“æ ¼æ£€æŸ¥å†…å®¹
  const physicalExamContent = $('#physical-exam-summary').html();
  if (!physicalExamContent || physicalExamContent.trim() === '') {
    console.log('ä½“æ ¼æ£€æŸ¥å†…å®¹ä¸ºç©ºï¼Œè·³è¿‡è‡ªåŠ¨æ·»åŠ ');
    return;
  }
  
  // åˆ›å»ºä½“æ ¼æ£€æŸ¥ç»“æœå¯¹è±¡
  const physicalExamResult = {
    actual_result: physicalExamContent,
    is_relevant: true
  };
  
  // æ·»åŠ åˆ°è¾…åŠ©æ£€æŸ¥ç»“æœåŒºåŸŸ
  addExaminationResult('ä½“æ ¼æ£€æŸ¥', physicalExamResult);
  console.log('å·²è‡ªåŠ¨æ·»åŠ ä½“æ ¼æ£€æŸ¥åˆ°è¾…åŠ©æ£€æŸ¥ç»“æœåŒºåŸŸ');
};

// åœ¨å·¦ä¾§é¢æ¿æ·»åŠ æ£€æŸ¥ç»“æœ
window.addExaminationResult = function(examName, result) {
  // æ£€æŸ¥æ˜¯å¦å·²æœ‰æ£€æŸ¥ç»“æœåŒºåŸŸ
  let resultsSection = $('#examination-results-section');
  if (resultsSection.length === 0) {
    // åˆ›å»ºæ£€æŸ¥ç»“æœåŒºåŸŸ
    const newSection = `
      <div class="mb-3" id="examination-results-section">
        <h6 class="text-warning mb-2">
          <i class="fas fa-flask me-1"></i>
          è¾…åŠ©æ£€æŸ¥ç»“æœ
        </h6>
        <div id="examination-results-container" class="border rounded p-3 bg-light">
        </div>
      </div>
    `;
    $('#physical-exam-section').after(newSection);
    resultsSection = $('#examination-results-section');
  }
  
  // æ·»åŠ æ£€æŸ¥ç»“æœ
  const isRelevant = result.is_relevant !== false;
  
  // æ„å»ºå›¾ç‰‡éƒ¨åˆ†ï¼ˆå¦‚æœæœ‰å›¾ç‰‡ï¼‰
  let imagesHtml = '';
  if (result.images && result.images.length > 0) {
    imagesHtml = '<div class="mt-2 d-flex gap-2 flex-wrap">';
    result.images.forEach(function(image, index) {
      const imageUrl = image.url || image;
      const imageDesc = image.description || 'æ£€æŸ¥å›¾ç‰‡';
      const imageId = `exam-image-${Date.now()}-${index}`;
      
      imagesHtml += `
        <div class="examination-image-thumb" 
             id="${imageId}"
             data-image-url="${imageUrl.replace(/"/g, '&quot;')}" 
             data-exam-name="${examName.replace(/"/g, '&quot;')}" 
             data-image-desc="${imageDesc.replace(/"/g, '&quot;')}"
             style="cursor: pointer;">
          <img src="${imageUrl}" alt="${imageDesc}" 
               style="width: 80px; height: 80px; object-fit: cover; border-radius: 8px; border: 2px solid #e0e0e0;"
               class="examination-image-thumbnail">
          <small class="d-block text-center text-muted mt-1" style="font-size: 0.75rem;">${imageDesc}</small>
        </div>
      `;
    });
    imagesHtml += '</div>';
  }
  
  const resultHtml = `
    <div class="exam-result-item mb-3 pb-3 border-bottom">
      <div class="d-flex align-items-start">
        <i class="fas ${isRelevant ? 'fa-check-circle text-success' : 'fa-times-circle text-muted'} me-2 mt-1"></i>
        <div class="flex-grow-1">
          <strong class="${isRelevant ? 'text-primary' : 'text-muted'}">${examName}:</strong>
          <p class="mb-0 mt-1 ${isRelevant ? '' : 'text-muted'}" style="white-space: pre-line;">${result.actual_result}</p>
          ${imagesHtml}
        </div>
      </div>
    </div>
  `;
  
  $('#examination-results-container').append(resultHtml);
  
  // ç»‘å®šå›¾ç‰‡ç‚¹å‡»äº‹ä»¶
  $('.examination-image-thumb').off('click').on('click', function() {
    const imageUrl = $(this).data('image-url');
    const examName = $(this).data('exam-name');
    const imageDesc = $(this).data('image-desc');
    viewExaminationImage(imageUrl, examName, imageDesc);
  });
  
  // æ˜¾ç¤ºåŒºåŸŸ
  resultsSection.show();
};

// æŸ¥çœ‹æ£€æŸ¥å›¾ç‰‡ï¼ˆå¤§å›¾æ¨¡å¼ï¼‰
window.viewExaminationImage = function(imageUrl, examName, imageDesc) {
  console.log('æŸ¥çœ‹å›¾ç‰‡:', imageUrl, examName, imageDesc);
  
  // åˆ›å»ºæ¨¡æ€æ¡†æ˜¾ç¤ºå¤§å›¾
  const modalHtml = `
    <div class="modal fade" id="imageViewModal" tabindex="-1" role="dialog" aria-hidden="true">
      <div class="modal-dialog modal-lg modal-dialog-centered" role="document">
        <div class="modal-content">
          <div class="modal-header bg-primary text-white">
            <h5 class="modal-title">${examName} - ${imageDesc}</h5>
            <button type="button" class="close text-white" onclick="closeImageModal()" aria-label="å…³é—­">
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
          <div class="modal-body text-center p-4" style="background: #f8f9fa;">
            <img src="${imageUrl}" alt="${imageDesc}" style="max-width: 100%; max-height: 70vh; height: auto; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15);">
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" onclick="closeImageModal()">å…³é—­</button>
          </div>
        </div>
      </div>
    </div>
  `;
  
  // ç§»é™¤æ—§æ¨¡æ€æ¡†
  const oldModal = document.getElementById('imageViewModal');
  if (oldModal) {
    oldModal.remove();
  }
  
  // æ·»åŠ æ–°æ¨¡æ€æ¡†åˆ°body
  document.body.insertAdjacentHTML('beforeend', modalHtml);
  
  // æ˜¾ç¤ºæ¨¡æ€æ¡†ï¼ˆä½¿ç”¨åŸç”ŸJavaScriptï¼‰
  const modalElement = document.getElementById('imageViewModal');
  modalElement.style.display = 'block';
  modalElement.classList.add('show');
  document.body.classList.add('modal-open');
  
  // æ·»åŠ backdrop
  const backdrop = document.createElement('div');
  backdrop.className = 'modal-backdrop fade show';
  backdrop.id = 'imageViewBackdrop';
  document.body.appendChild(backdrop);
  
  // ç‚¹å‡»èƒŒæ™¯å…³é—­
  backdrop.onclick = function() {
    closeImageModal();
  };
};

// å…³é—­å›¾ç‰‡æ¨¡æ€æ¡†
window.closeImageModal = function() {
  const modal = document.getElementById('imageViewModal');
  const backdrop = document.getElementById('imageViewBackdrop');
  
  if (modal) {
    modal.classList.remove('show');
    setTimeout(() => {
      modal.remove();
    }, 150);
  }
  
  if (backdrop) {
    backdrop.remove();
  }
  
  document.body.classList.remove('modal-open');
};

// æ›´æ–°å·²é€‰æ‹©æ£€æŸ¥è®¡æ•°
window.updateSelectedExamCount = function() {
  // ç»Ÿè®¡å·²å®Œæˆçš„æ£€æŸ¥ï¼ˆæŒ‰é’®ä¸ºç»¿è‰²æˆåŠŸçŠ¶æ€ï¼‰
  const completedCount = $('.examination-option-card .btn-success').length;
  $('#selected-exam-count').text(completedCount);

  // åŒæ­¥è®°å½•ï¼šæŠŠå½“å‰å·²â€œç”³è¯·/å®Œæˆâ€çš„æ£€æŸ¥é€‰é¡¹å†™å…¥ä¼šè¯ï¼ˆç”¨äºå¤ç›˜æ˜¾ç¤ºï¼‰
  // - ç»¿è‰²ï¼šå·²å®Œæˆ
  // - ç°è‰²ï¼šæ— å…³æ£€æŸ¥ï¼ˆä¹Ÿå±äºå­¦ç”Ÿåšè¿‡çš„é€‰æ‹©ï¼Œå¤ç›˜åº”æ˜¾ç¤ºï¼‰
  try {
    const selectedIds = [];
    const selectedDetails = [];
    $('.examination-option-card').each(function() {
      const $card = $(this);
      const $btn = $card.find('button').first();
      if (!$btn.length) return;

      const isChosen = $btn.hasClass('btn-success') || $btn.hasClass('btn-secondary');
      if (!isChosen) return;

      const rawId = $card.attr('data-exam-id');
      const idNum = parseInt(rawId, 10);
      if (!Number.isFinite(idNum)) return; // åªè®°å½•æ•°å€¼IDï¼ˆæ’é™¤ physical_exam ç­‰éæ•°å­—ï¼‰

      if (selectedIds.indexOf(idNum) === -1) {
        selectedIds.push(idNum);
        const name = ($card.find('h6').first().text() || '').trim();
        selectedDetails.push({ id: idNum, name: name || ('æ£€æŸ¥#' + idNum) });
      }
    });
    clinicalSession.selectedExaminations = selectedIds;
    clinicalSession.selectedExaminationsDetail = selectedDetails;
  } catch (e) {}
  
  // å¦‚æœè‡³å°‘é€‰æ‹©äº†ä¸€é¡¹ï¼Œå¯ç”¨è¿›å…¥è¯Šæ–­æŒ‰é’®
  const proceedBtn = $('#btn-proceed-to-diagnosis');
  if (completedCount > 0) {
    proceedBtn.prop('disabled', false).removeClass('btn-secondary').addClass('btn-success');
  } else {
    proceedBtn.prop('disabled', true).removeClass('btn-success').addClass('btn-secondary');
  }
};

// è¿›å…¥è¯Šæ–­æ¨ç†é˜¶æ®µ
window.proceedToDiagnosis = function() {
  // ä»å…¨å±æ£€æŸ¥å¡ç‰‡ä¸­æ”¶é›†â€œå·²ç”³è¯·/å®Œæˆâ€çš„æ£€æŸ¥é€‰æ‹©ï¼ˆç”¨äºåç«¯è®°å½•ä¸å¤ç›˜å±•ç¤ºï¼‰
  let selectedIds = [];
  let selectedDetails = [];
  try {
    $('.examination-option-card').each(function() {
      const $card = $(this);
      const $btn = $card.find('button').first();
      if (!$btn.length) return;

      const isChosen = $btn.hasClass('btn-success') || $btn.hasClass('btn-secondary');
      if (!isChosen) return;

      const rawId = $card.attr('data-exam-id');
      const idNum = parseInt(rawId, 10);
      if (!Number.isFinite(idNum)) return;

      if (selectedIds.indexOf(idNum) === -1) {
        selectedIds.push(idNum);
        const name = ($card.find('h6').first().text() || '').trim();
        selectedDetails.push({ id: idNum, name: name || ('æ£€æŸ¥#' + idNum) });
      }
    });
  } catch (e) {
    selectedIds = [];
    selectedDetails = [];
  }

  const completedCount = $('.examination-option-card .btn-success').length;
  
  if (completedCount === 0) {
    alert('è¯·è‡³å°‘é€‰æ‹©ä¸€é¡¹æ£€æŸ¥åå†è¿›å…¥è¯Šæ–­æ¨ç†é˜¶æ®µ');
    return;
  }
  
  // ç¡®è®¤å¯¹è¯æ¡†
  if (!confirm(`æ‚¨å·²å®Œæˆ ${completedCount} é¡¹æ£€æŸ¥ã€‚ç¡®å®šè¿›å…¥è¯Šæ–­æ¨ç†é˜¶æ®µå—ï¼Ÿ\n\nè¿›å…¥åå°†æ— æ³•è¿”å›ç»§ç»­é€‰æ‹©æ£€æŸ¥ã€‚`)) {
    return;
  }
  
  console.log('å‡†å¤‡è¿›å…¥è¯Šæ–­æ¨ç†é˜¶æ®µ');

  // å†™å…¥å‰ç«¯ä¼šè¯ï¼ˆå¤ç›˜ç›´æ¥å¯è§ï¼‰
  clinicalSession.selectedExaminations = selectedIds;
  clinicalSession.selectedExaminationsDetail = selectedDetails;
  
  // ç¦ç”¨æŒ‰é’®é˜²æ­¢é‡å¤ç‚¹å‡»
  $('#btn-proceed-to-diagnosis')
    .prop('disabled', true)
    .html('<i class="fas fa-spinner fa-spin me-1"></i>æ­£åœ¨è¿›å…¥...');
  
  // 1) å…ˆè®°å½•é˜¶æ®µåˆ‡æ¢ï¼ˆç”¨äºé˜¶æ®µç”¨æ—¶/åç«¯ stage_timesï¼‰
  updateSessionStage('diagnosis_reasoning').then(() => {
    // 2) å†æäº¤æ£€æŸ¥é€‰æ‹©åˆ°åç«¯ï¼ˆç”¨äºå¤ç›˜â€œæ£€æŸ¥é€‰æ‹©â€åˆ—è¡¨ï¼‰
    return $.ajax({
      url: '/api/clinical/submit-examinations/',
      method: 'POST',
      contentType: 'application/json',
      headers: {
        'X-CSRFToken': $('[name=csrfmiddlewaretoken]').val() || getCsrfToken()
      },
      data: JSON.stringify({
        case_id: clinicalSession.caseId,
        selected_examinations: selectedIds
      })
    });
  }).then((resp) => {
    // æ›´æ–°å‰ç«¯åˆ†æ•°ï¼ˆå¦‚æœ‰ï¼‰
    try {
      if (resp && resp.success && resp.data && typeof resp.data.examination_score === 'number') {
        clinicalSession.scores.examination = resp.data.examination_score;
        $('#current-score').text(resp.data.examination_score.toFixed(1));
      }
    } catch (e) {}

    // æ›´æ–°å‰ç«¯çŠ¶æ€
    clinicalSession.currentStage = 'diagnosis_reasoning';
    updateClinicalProgress();
    
    // éšè—å…¨å±ç—…å²é‡‡é›†å¸ƒå±€ï¼Œæ˜¾ç¤ºè¯Šæ–­æ¨ç†ç•Œé¢
    $('#history-collection-fullscreen').fadeOut(300, function() {
      initializeDiagnosisStage();
    });
  }).catch(error => {
    console.error('è¿›å…¥è¯Šæ–­æ¨ç†é˜¶æ®µå¤±è´¥:', error);
    alert('è¿›å…¥è¯Šæ–­æ¨ç†é˜¶æ®µå¤±è´¥ï¼Œè¯·é‡è¯•');
    $('#btn-proceed-to-diagnosis')
      .prop('disabled', false)
      .html('<i class="fas fa-stethoscope me-1"></i>è¿›å…¥è¯Šæ–­æ¨ç†<i class="fas fa-arrow-right ms-1"></i>');
  });
};

// åˆå§‹åŒ–è¯Šæ–­æ¨ç†é˜¶æ®µ
window.initializeDiagnosisStage = function() {
  console.log('åˆå§‹åŒ–è¯Šæ–­æ¨ç†é˜¶æ®µ');
  
  // æ›´æ–°å½“å‰é˜¶æ®µ
  clinicalSession.currentStage = 'diagnosis_reasoning';
  syncStageToBackend('diagnosis_reasoning');  // åŒæ­¥åˆ°åç«¯
  
  // ç¦ç”¨å·¦ä¾§èŠå¤©è¾“å…¥åŠŸèƒ½
  $('#patient-question-global').prop('disabled', true).attr('placeholder', 'è¯Šæ–­æ¨ç†é˜¶æ®µä¸æ”¯æŒèŠå¤©åŠŸèƒ½');
  $('.chat-input button').prop('disabled', true).css('opacity', '0.5');
  $('#quick-question-buttons button').prop('disabled', true).addClass('disabled').css('opacity', '0.5');
  
  // æ›´æ–°å…¨å±ç•Œé¢æ ‡é¢˜æ 
  $('#history-collection-fullscreen .logo-circle + div h6').text('è¯Šæ–­æ¨ç†ç³»ç»Ÿ');
  $('#history-collection-fullscreen .logo-circle + div small').text('è¯Šæ–­æ¨ç†é˜¶æ®µ');
  
  // æ›´æ–°å³ä¾§é¢æ¿ä¸ºè¯Šæ–­é€‰é¡¹
  const rightPanel = $('#history-collection-fullscreen .col-6').eq(1);
  if (rightPanel.length) {
    const diagnosisContent = `
      <div class="card shadow-sm d-flex flex-column w-100" style="height: 100%;">
        <div class="card-header bg-info text-white py-2 flex-shrink-0">
          <h6 class="mb-0 fw-bold">
            <i class="fas fa-brain me-2"></i>
            é‰´åˆ«è¯Šæ–­æ¨ç†
          </h6>
        </div>
        <div class="card-body p-3 flex-grow-1" style="overflow-y: auto; min-height: 0;">
          <div class="alert alert-primary mb-3">
            <i class="fas fa-lightbulb me-2"></i>
            æ ¹æ®ç—…å²ã€ä½“æ ¼æ£€æŸ¥å’Œè¾…åŠ©æ£€æŸ¥ç»“æœï¼Œè¯·é€‰æ‹©æ‚¨è®¤ä¸ºæœ€å¯èƒ½çš„è¯Šæ–­
          </div>
          
          <div id="diagnosis-options-container">
            <div class="text-center text-muted py-5">
              <div class="spinner-border text-primary mb-3" role="status">
                <span class="visually-hidden">åŠ è½½ä¸­...</span>
              </div>
              <p>æ­£åœ¨åŠ è½½è¯Šæ–­é€‰é¡¹...</p>
            </div>
          </div>
        </div>
        <div class="card-footer bg-light border-top flex-shrink-0">
          <div class="d-flex justify-content-between align-items-center">
            <button class="btn btn-outline-secondary" onclick="returnToExamination()">
              <i class="fas fa-arrow-left me-1"></i>
              è¿”å›æ£€æŸ¥
            </button>
            <button class="btn btn-primary" id="btn-submit-diagnosis" onclick="submitDiagnosisFullscreen()" disabled>
              <i class="fas fa-check-circle me-1"></i>
              æäº¤è¯Šæ–­
              <i class="fas fa-arrow-right ms-1"></i>
            </button>
          </div>
        </div>
      </div>
    `;
    
    rightPanel.html(diagnosisContent);
    
    // æ˜¾ç¤ºå…¨å±å¸ƒå±€
    $('#history-collection-fullscreen').fadeIn(300);
    
    // åŠ è½½è¯Šæ–­é€‰é¡¹
    loadDiagnosisOptions();
  }
};

// åŠ è½½è¯Šæ–­é€‰é¡¹
window.loadDiagnosisOptions = function() {
  $.ajax({
    url: `/api/clinical/case/${clinicalSession.caseId}/diagnosis-options/`,
    method: 'GET',
    headers: {
      'X-CSRFToken': $('[name=csrfmiddlewaretoken]').val()
    },
    success: function(response) {
      console.log('è¯Šæ–­é€‰é¡¹APIå“åº”:', response);
      if (response.success && response.data) {
        // è®°å½•æ˜¯å¦å…è®¸å¤šé€‰ï¼ˆä¸æ³„éœ²ç­”æ¡ˆï¼Œåªå½±å“UIé€‰æ‹©æ–¹å¼ï¼‰
        try {
          clinicalSession.diagnosisAllowMultiple = !!response.data.allow_multiple;
        } catch (e) {}
        displayDiagnosisOptions(response.data);
      } else {
        $('#diagnosis-options-container').html(`
          <div class="alert alert-warning">
            <i class="fas fa-exclamation-triangle me-2"></i>
            åŠ è½½è¯Šæ–­é€‰é¡¹å¤±è´¥: ${response.message || 'æœªçŸ¥é”™è¯¯'}
          </div>
        `);
      }
    },
    error: function(xhr, status, error) {
      console.error('åŠ è½½è¯Šæ–­é€‰é¡¹å¤±è´¥:', error);
      const msg = (xhr && xhr.responseJSON && xhr.responseJSON.message) ? xhr.responseJSON.message : null;
      $('#diagnosis-options-container').html(`
        <div class="alert alert-danger">
          <i class="fas fa-exclamation-circle me-2"></i>
          ${msg ? ('åŠ è½½è¯Šæ–­é€‰é¡¹å¤±è´¥: ' + msg) : 'åŠ è½½è¯Šæ–­é€‰é¡¹å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•'}
        </div>
      `);
    }
  });
};

// æ˜¾ç¤ºè¯Šæ–­é€‰é¡¹
window.displayDiagnosisOptions = function(options) {
  // å…¼å®¹ï¼šæ—¢æ”¯æŒç›´æ¥ä¼ æ•°ç»„ï¼Œä¹Ÿæ”¯æŒä¼  {diagnosis_options, allow_multiple}
  let payload = options;
  let diagnosisOptions = payload;
  let allowMultiple = false;
  if (payload && !Array.isArray(payload) && typeof payload === 'object') {
    allowMultiple = !!payload.allow_multiple;
    diagnosisOptions = payload.diagnosis_options || [];
  }

  // è®°å½•åˆ°ä¼šè¯ï¼ˆé¿å…åç»­ submit çš„å‘½åå†²çª/çŠ¶æ€ä¸åŒæ­¥ï¼‰
  clinicalSession.diagnosisAllowMultiple = !!allowMultiple;
  clinicalSession.selectedDiagnoses = Array.isArray(clinicalSession.selectedDiagnoses) ? clinicalSession.selectedDiagnoses : [];
  clinicalSession.selectedDiagnosisNames = clinicalSession.selectedDiagnosisNames || {};

  if (!diagnosisOptions || diagnosisOptions.length === 0) {
    $('#diagnosis-options-container').html(`
      <div class="alert alert-info">
        <i class="fas fa-info-circle me-2"></i>
        æš‚æ— è¯Šæ–­é€‰é¡¹
      </div>
    `);
    return;
  }
  
  let html = '<div class="diagnosis-options-list">';
  
  // è¯Šæ–­é€‰é¡¹å¡ç‰‡
  html += '<div class="mb-4">';
  html += '<h6 class="text-primary mb-3"><i class="fas fa-diagnoses me-2"></i>è¯·é€‰æ‹©è¯Šæ–­ï¼ˆ' + (allowMultiple ? 'å¯å¤šé€‰' : 'å•é€‰') + 'ï¼‰</h6>';
  
  diagnosisOptions.forEach(function(option, index) {
    const diagnosisName = option.name || option.diagnosis_name || option.title;
    const diagnosisDesc = option.description || option.diagnosis_description || '';
    const diagnosisId = option.id || index;
    const safeName = String(diagnosisName || '').replace(/'/g, "\\'");
    const inputType = allowMultiple ? 'checkbox' : 'radio';
    const inputClass = allowMultiple ? 'diagnosis-checkbox' : 'diagnosis-radio';
    const inputName = allowMultiple ? 'diagnosis_multi' : 'diagnosis';
    const onChange = allowMultiple
      ? `onchange="toggleDiagnosisSelection(${diagnosisId}, '${safeName}', this.checked)"`
      : `onchange="selectDiagnosis(${diagnosisId}, '${safeName}')"`;
    const isChecked = allowMultiple
      ? (Array.isArray(clinicalSession.selectedDiagnoses) && clinicalSession.selectedDiagnoses.includes(diagnosisId))
      : (clinicalSession.selectedDiagnosis && clinicalSession.selectedDiagnosis.id === diagnosisId);
    const checkedAttr = isChecked ? 'checked' : '';
    
    html += `
      <div class="card mb-3 diagnosis-option-card" data-diagnosis-id="${diagnosisId}">
        <div class="card-body">
          <div class="form-check">
            <input class="form-check-input ${inputClass}" 
                   type="${inputType}" 
                   name="${inputName}" 
                   id="diagnosis-${diagnosisId}" 
                   value="${diagnosisId}"
                   ${checkedAttr}
                   ${onChange}>
            <label class="form-check-label w-100" for="diagnosis-${diagnosisId}" style="cursor: pointer;">
              <h6 class="mb-1">${diagnosisName}</h6>
              ${diagnosisDesc ? `<small class="text-muted">${diagnosisDesc}</small>` : ''}
            </label>
          </div>
        </div>
      </div>
    `;
  });
  
  html += '</div>';
  
  // è¯Šæ–­ä¾æ®è¾“å…¥åŒºåŸŸ
  html += `
    <div class="card border-warning" id="diagnosis-rationale-section" style="display: none;">
      <div class="card-header bg-warning text-white">
        <h6 class="mb-0">
          <i class="fas fa-edit me-2"></i>
          è¯·è¾“å…¥è¯Šæ–­ä¾æ®
          <span class="badge bg-light text-dark ms-2">å¿…å¡«</span>
        </h6>
      </div>
      <div class="card-body">
        <div class="alert alert-info mb-3">
          <i class="fas fa-lightbulb me-2"></i>
          <strong>æç¤ºï¼š</strong>è¯·æ ¹æ®ç—…å²ã€ä½“æ ¼æ£€æŸ¥å’Œè¾…åŠ©æ£€æŸ¥ç»“æœï¼Œè¯¦ç»†è¯´æ˜æ‚¨çš„è¯Šæ–­ä¾æ®ã€‚åŒ…æ‹¬ï¼š
          <ul class="mb-0 mt-2">
            <li>ä¸»è¦ç—‡çŠ¶å’Œä½“å¾</li>
            <li>å…³é”®çš„æ£€æŸ¥ç»“æœ</li>
            <li>é‰´åˆ«è¯Šæ–­è¦ç‚¹</li>
            <li>è¯Šæ–­çš„ä¾æ®å’Œç†ç”±</li>
          </ul>
        </div>
        <div class="form-group">
          <label for="diagnosis-rationale-text" class="fw-bold">è¯Šæ–­ä¾æ®ï¼š</label>
          <textarea 
            class="form-control" 
            id="diagnosis-rationale-text" 
            rows="8" 
            placeholder="è¯·è¯¦ç»†æè¿°æ‚¨çš„è¯Šæ–­ä¾æ®...&#10;&#10;ä¾‹å¦‚ï¼š&#10;1. æ‚£è€…ä¸»è¯‰ï¼š...&#10;2. ä½“æ ¼æ£€æŸ¥å‘ç°ï¼š...&#10;3. è¾…åŠ©æ£€æŸ¥ç»“æœï¼š...&#10;4. ç»¼åˆåˆ†æï¼š..."
            oninput="checkDiagnosisComplete()"></textarea>
          <small class="form-text text-muted mt-2">
            <i class="fas fa-info-circle me-1"></i>
            å·²è¾“å…¥ <span id="rationale-char-count">0</span> å­—ï¼Œè‡³å°‘10å­—
          </small>
        </div>
      </div>
    </div>
  `;
  
  html += '</div>';
  
  $('#diagnosis-options-container').html(html);
};

// é€‰æ‹©è¯Šæ–­
window.selectDiagnosis = function(diagnosisId, diagnosisName) {
  console.log('é€‰æ‹©è¯Šæ–­:', diagnosisName, diagnosisId);
  
  // ä¿å­˜é€‰æ‹©
  clinicalSession.selectedDiagnosis = {
    id: diagnosisId,
    name: diagnosisName
  };
  // å•é€‰æ¨¡å¼ä¹ŸåŒæ­¥å†™å…¥å¤šé€‰æ•°ç»„ï¼Œé¿å…åç»­æäº¤é€»è¾‘è¯»ä¸åˆ°
  clinicalSession.selectedDiagnoses = [diagnosisId];
  clinicalSession.selectedDiagnosisNames = clinicalSession.selectedDiagnosisNames || {};
  clinicalSession.selectedDiagnosisNames[diagnosisId] = diagnosisName;
  
  // é«˜äº®é€‰ä¸­çš„å¡ç‰‡
  $('.diagnosis-option-card').removeClass('border-primary bg-light');
  $(`.diagnosis-option-card[data-diagnosis-id="${diagnosisId}"]`)
    .addClass('border-primary')
    .css('background-color', '#e7f3ff');
  
  // æ˜¾ç¤ºè¯Šæ–­ä¾æ®è¾“å…¥åŒºåŸŸ
  $('#diagnosis-rationale-section').slideDown(300);
  
  // æ»šåŠ¨åˆ°è¯Šæ–­ä¾æ®åŒºåŸŸ
  setTimeout(function() {
    $('#diagnosis-rationale-section')[0].scrollIntoView({ 
      behavior: 'smooth', 
      block: 'nearest' 
    });
  }, 350);
  
  // æ£€æŸ¥æ˜¯å¦å®Œæ•´
  checkDiagnosisComplete();
};

// å¤šé€‰ï¼šåˆ‡æ¢è¯Šæ–­é€‰æ‹©
window.toggleDiagnosisSelection = function(diagnosisId, diagnosisName, checked) {
  try {
    if (!Array.isArray(clinicalSession.selectedDiagnoses)) {
      clinicalSession.selectedDiagnoses = [];
    }
    clinicalSession.selectedDiagnosisNames = clinicalSession.selectedDiagnosisNames || {};

    if (checked) {
      if (!clinicalSession.selectedDiagnoses.includes(diagnosisId)) {
        clinicalSession.selectedDiagnoses.push(diagnosisId);
      }
      clinicalSession.selectedDiagnosisNames[diagnosisId] = diagnosisName;

      $(`.diagnosis-option-card[data-diagnosis-id="${diagnosisId}"]`)
        .addClass('border-primary')
        .css('background-color', '#e7f3ff');

      // æ˜¾ç¤ºè¯Šæ–­ä¾æ®è¾“å…¥åŒºåŸŸ
      $('#diagnosis-rationale-section').slideDown(300);
    } else {
      clinicalSession.selectedDiagnoses = clinicalSession.selectedDiagnoses.filter(id => id !== diagnosisId);
      delete clinicalSession.selectedDiagnosisNames[diagnosisId];

      $(`.diagnosis-option-card[data-diagnosis-id="${diagnosisId}"]`)
        .removeClass('border-primary bg-light')
        .css('background-color', '');
    }
  } catch (e) {
    console.warn('toggleDiagnosisSelection failed:', e);
  }

  checkDiagnosisComplete();
};

// æ£€æŸ¥è¯Šæ–­æ˜¯å¦å®Œæ•´ï¼ˆé€‰æ‹©+ä¾æ®ï¼‰
window.checkDiagnosisComplete = function() {
  const rationale = $('#diagnosis-rationale-text').val().trim();
  const charCount = rationale.length;
  
  // æ›´æ–°å­—ç¬¦è®¡æ•°
  $('#rationale-char-count').text(charCount);
  
  // æ£€æŸ¥æ˜¯å¦å®Œæ•´ï¼ˆè‡³å°‘10å­—ï¼‰
  const hasSelection = Array.isArray(clinicalSession.selectedDiagnoses) && clinicalSession.selectedDiagnoses.length > 0;
  const isComplete = hasSelection && charCount >= 10;
  
  // æ›´æ–°æäº¤æŒ‰é’®çŠ¶æ€
  if (isComplete) {
    $('#btn-submit-diagnosis')
      .prop('disabled', false)
      .removeClass('btn-secondary')
      .addClass('btn-primary');
  } else {
    $('#btn-submit-diagnosis')
      .prop('disabled', true)
      .removeClass('btn-primary')
      .addClass('btn-secondary');
  }
  
  return isComplete;
};

// æäº¤è¯Šæ–­ï¼ˆå…¨å±ç‰ˆï¼Œé¿å…ä¸é¡µé¢å…¶ä»– submitDiagnosis å†²çªï¼‰
window.submitDiagnosisFullscreen = function() {
  const selectedIds = Array.isArray(clinicalSession.selectedDiagnoses) ? clinicalSession.selectedDiagnoses : [];
  if (selectedIds.length === 0) {
    alert('è¯·å…ˆé€‰æ‹©è¯Šæ–­');
    return;
  }
  
  const rationale = $('#diagnosis-rationale-text').val().trim();
  
  if (!rationale) {
    alert('è¯·è¾“å…¥è¯Šæ–­ä¾æ®');
    $('#diagnosis-rationale-text').focus();
    return;
  }
  
  if (rationale.length < 10) {
    alert('è¯Šæ–­ä¾æ®è‡³å°‘éœ€è¦10å­—ï¼Œè¯·è¡¥å……å®Œæ•´');
    $('#diagnosis-rationale-text').focus();
    return;
  }

  // å‰ç«¯å…ˆç¼“å­˜ä¸€ä»½å¤ç›˜æ•°æ®ï¼Œé¿å…ä»»ä½•æ¥å£å·®å¼‚å¯¼è‡´â€œæœªè®°å½•â€
  try {
    clinicalSession.reviewDiagnosisRationale = rationale;
    clinicalSession.reviewDiagnosisNames = selectedIds.map(function(id) {
      return (clinicalSession.selectedDiagnosisNames && clinicalSession.selectedDiagnosisNames[id]) ? clinicalSession.selectedDiagnosisNames[id] : String(id);
    });
  } catch (e) {}

  const selectedNames = (clinicalSession.reviewDiagnosisNames && clinicalSession.reviewDiagnosisNames.length > 0)
    ? clinicalSession.reviewDiagnosisNames
    : selectedIds.map(String);
  
  if (!confirm(`ç¡®å®šæäº¤ä»¥ä¸‹å†…å®¹å—ï¼Ÿ\n\nè¯Šæ–­ï¼š${selectedNames.join('ã€')}\n\nè¯Šæ–­ä¾æ®ï¼š${rationale.substring(0, 100)}${rationale.length > 100 ? '...' : ''}\n\næäº¤åå°†è·å¾—è¯„åˆ†å¹¶è¿›å…¥ä¸‹ä¸€é˜¶æ®µã€‚`)) {
    return;
  }
  
  console.log('æäº¤è¯Šæ–­IDs:', selectedIds, 'ä¾æ®é•¿åº¦:', rationale.length);
  
  // ç¦ç”¨æŒ‰é’®å’Œè¾“å…¥æ¡†
  $('#btn-submit-diagnosis')
    .prop('disabled', true)
    .html('<i class="fas fa-spinner fa-spin me-1"></i>è¯„åˆ†ä¸­...');
  $('#diagnosis-rationale-text').prop('disabled', true);
  $('.diagnosis-radio, .diagnosis-checkbox').prop('disabled', true);
  
  // æäº¤åˆ°åç«¯è¯„åˆ†
  $.ajax({
    url: `/api/clinical/case/${clinicalSession.caseId}/submit-diagnosis/`,
    method: 'POST',
    headers: {
      'X-CSRFToken': $('[name=csrfmiddlewaretoken]').val()
    },
    contentType: 'application/json',
    data: JSON.stringify({
      diagnosis_ids: selectedIds,
      diagnosis_rationale: rationale
    }),
    success: function(response) {
      console.log('è¯Šæ–­æäº¤å“åº”:', response);
      
      if (response.success) {
        // æˆåŠŸåå†åˆ·æ–°ä¸€æ¬¡å¤ç›˜æ•°æ®ï¼Œç¡®ä¿åç«¯å·²æŒä¹…ä¿å­˜ï¼ˆå­¦ä¹ åé¦ˆå±•ç¤ºç”¨ï¼‰
        if (typeof window.refreshReviewData === 'function') {
          window.refreshReviewData();
        }
        // æ›´æ–°ä¼šè¯æ•°æ®
        if (response.data.diagnosis_score !== undefined) {
          clinicalSession.scores = clinicalSession.scores || {};
          clinicalSession.scores.diagnosis = response.data.diagnosis_score;
        }
        
        // å¦‚æœè¯Šæ–­æ­£ç¡®ï¼Œç›´æ¥è¿›å…¥æ²»ç–—é˜¶æ®µï¼ˆä¸æ˜¾ç¤ºè¯„åˆ†ç•Œé¢ï¼‰
        if (response.data.is_correct) {
          console.log('âœ“ è¯Šæ–­å®Œå…¨æ­£ç¡®ï¼å¾—åˆ†:', response.data.total_score);
          console.log('ç«‹å³è¿›å…¥æ²»ç–—é˜¶æ®µ');
          
          // éšè—å…¨å±è¯Šæ–­å¸ƒå±€
          $('#history-collection-fullscreen').fadeOut(300);
          
          // ç«‹å³è·³è½¬åˆ°æ²»ç–—é˜¶æ®µ
          setTimeout(function() {
            clinicalSession.currentStage = 'treatment_selection';
            loadTreatmentStage();
          }, 400);
          
        } else {
          // è¯Šæ–­ä¸æ­£ç¡®ï¼Œæ˜¾ç¤ºè¯„åˆ†å’Œåé¦ˆ
          showDiagnosisScore(response.data);
          
          // åœ¨è¯Šæ–­ä¾æ®åŒºåŸŸåæ˜¾ç¤ºè­¦å‘Šæç¤º
          var warningHtml = '<div class="alert alert-warning mt-3" id="diagnosis-feedback-alert">';
          warningHtml += '<i class="fas fa-exclamation-triangle me-2"></i>';
          warningHtml += '<strong>è¯Šæ–­ä¸å®Œå…¨æ­£ç¡®</strong><br>';
          warningHtml += '<small>å¾—åˆ†: ' + (response.data.total_score || 0) + ' åˆ†ã€‚è¯·æ ¹æ®åé¦ˆé‡æ–°åˆ†æå¹¶é€‰æ‹©æ­£ç¡®çš„è¯Šæ–­ã€‚</small>';
          warningHtml += '</div>';
          
          // ç§»é™¤æ—§çš„åé¦ˆæç¤º
          $('#diagnosis-feedback-alert').remove();
          // åœ¨è¯Šæ–­ä¾æ®åŒºåŸŸåæ’å…¥æ–°çš„æç¤º
          $('#diagnosis-rationale-section').after(warningHtml);
          
          // æ¢å¤æŒ‰é’®çŠ¶æ€ï¼Œå…è®¸é‡æ–°æäº¤
          $('#btn-submit-diagnosis')
            .prop('disabled', false)
            .html('<i class="fas fa-check-circle me-1"></i>é‡æ–°æäº¤è¯Šæ–­<i class="fas fa-arrow-right ms-1"></i>');
          $('#diagnosis-rationale-text').prop('disabled', false);
          $('.diagnosis-radio').prop('disabled', false);
        }
      } else {
        alert('è¯Šæ–­æäº¤å¤±è´¥: ' + (response.message || 'æœªçŸ¥é”™è¯¯'));
        // æ¢å¤æŒ‰é’®çŠ¶æ€
        $('#btn-submit-diagnosis')
          .prop('disabled', false)
          .html('<i class="fas fa-check-circle me-1"></i>æäº¤è¯Šæ–­<i class="fas fa-arrow-right ms-1"></i>');
        $('#diagnosis-rationale-text').prop('disabled', false);
        $('.diagnosis-radio, .diagnosis-checkbox').prop('disabled', false);
      }
    },
    error: function(xhr, status, error) {
      console.error('è¯Šæ–­æäº¤å¤±è´¥:', error);
      alert('è¯Šæ–­æäº¤å¤±è´¥ï¼Œè¯·é‡è¯•');
      // æ¢å¤æŒ‰é’®çŠ¶æ€
      $('#btn-submit-diagnosis')
        .prop('disabled', false)
        .html('<i class="fas fa-check-circle me-1"></i>æäº¤è¯Šæ–­<i class="fas fa-arrow-right ms-1"></i>');
      $('#diagnosis-rationale-text').prop('disabled', false);
      $('.diagnosis-radio, .diagnosis-checkbox').prop('disabled', false);
    }
  });
};

// æ˜¾ç¤ºè¯Šæ–­è¯„åˆ†ç»“æœ
window.showDiagnosisScore = function(scoreData) {
  const diagnosisScore = scoreData.diagnosis_score || 0;
  const rationaleScore = scoreData.rationale_score || 0;
  const totalScore = scoreData.total_score || 0;
  const feedback = scoreData.feedback || '';
  const isCorrect = scoreData.is_correct || false;
  
  let scoreHtml = `
    <div class="alert ${isCorrect ? 'alert-success' : 'alert-warning'} mt-3" role="alert">
      <h5 class="alert-heading">
        <i class="fas ${isCorrect ? 'fa-check-circle' : 'fa-exclamation-triangle'} me-2"></i>
        è¯Šæ–­è¯„åˆ†ç»“æœ
      </h5>
      <hr>
      <div class="row mb-3">
        <div class="col-4 text-center">
          <div class="mb-1"><strong>è¯Šæ–­å¾—åˆ†</strong></div>
          <div class="h3 mb-0 ${isCorrect ? 'text-success' : 'text-warning'}">${diagnosisScore}</div>
          <small class="text-muted">/ 100åˆ†</small>
        </div>
        <div class="col-4 text-center border-start border-end">
          <div class="mb-1"><strong>ä¾æ®å¾—åˆ†</strong></div>
          <div class="h3 mb-0 text-info">${rationaleScore}</div>
          <small class="text-muted">/ 100åˆ†</small>
        </div>
        <div class="col-4 text-center">
          <div class="mb-1"><strong>æ€»åˆ†</strong></div>
          <div class="h3 mb-0 text-primary">${totalScore}</div>
          <small class="text-muted">/ 100åˆ†</small>
        </div>
      </div>
      ${feedback ? `<div class="mt-3"><strong>åé¦ˆï¼š</strong><p class="mb-0 mt-2">${feedback}</p></div>` : ''}
    </div>
  `;
  
  $('#diagnosis-rationale-section').after(scoreHtml);
};

// è¿”å›æ£€æŸ¥é˜¶æ®µ
window.returnToExamination = function() {
  if (!confirm('ç¡®å®šè¿”å›æ£€æŸ¥é˜¶æ®µå—ï¼Ÿå·²é€‰æ‹©çš„è¯Šæ–­å°†è¢«æ¸…é™¤ã€‚')) {
    return;
  }
  
  clinicalSession.selectedDiagnosis = null;
  clinicalSession.currentStage = 'examination_selection';
  updateClinicalProgress();
  initializeExaminationStage();
  $('#history-collection-fullscreen').fadeIn(300);
};

// å¤„ç†ç—…å²èŠå¤©é”®ç›˜äº‹ä»¶
window.handleHistoryChatKeyPress = function(event) {
  if (event.key === 'Enter') {
    window.sendHistoryChatMessage();
  }
};

// æ·»åŠ ç—…å²èŠå¤©æ¶ˆæ¯
window.addHistoryChatMessage = function(type, content, sender) {
  const container = document.getElementById('chat-messages-history');
  if (!container) {
    console.error('æ‰¾ä¸åˆ°èŠå¤©æ¶ˆæ¯å®¹å™¨');
    return;
  }
  
  // æ¸…é™¤åˆå§‹æç¤º
  if (container.querySelector('.text-center.text-muted')) {
    container.innerHTML = '';
  }
  
  const messageDiv = document.createElement('div');
  messageDiv.className = `chat-message ${sender}-message mb-2`;
  
  let iconClass, bgClass, alignClass;
  switch (sender) {
    case 'patient':
      iconClass = 'fas fa-user';
      bgClass = 'bg-light';
      alignClass = 'justify-content-start';
      break;
    case 'student':
      iconClass = 'fas fa-user-md';
      bgClass = 'bg-primary text-white';
      alignClass = 'justify-content-end';
      break;
    case 'system':
      iconClass = 'fas fa-info-circle';
      bgClass = 'bg-warning';
      alignClass = 'justify-content-start';
      break;
    default:
      iconClass = 'fas fa-comment';
      bgClass = 'bg-secondary text-white';
      alignClass = 'justify-content-start';
  }
  
  messageDiv.innerHTML = `
    <div class="d-flex ${alignClass}">
      <div class="message-bubble ${bgClass} rounded px-3 py-2 max-width-75">
        <div class="d-flex align-items-center mb-1">
          <i class="${iconClass} me-2" style="font-size: 0.8rem;"></i>
          <small class="fw-bold">${sender === 'patient' ? 'æ‚£è€…' : sender === 'student' ? 'åŒ»ç”Ÿ' : 'ç³»ç»Ÿ'}</small>
        </div>
        <div>${content}</div>
        <small class="d-block mt-1 opacity-75" style="font-size: 0.7rem;">
          ${new Date().toLocaleTimeString()}
        </small>
      </div>
    </div>
  `;
  
  container.appendChild(messageDiv);
  
  // æ»šåŠ¨åˆ°åº•éƒ¨
  setTimeout(() => {
    container.scrollTop = container.scrollHeight;
  }, 100);

  // åŒæ­¥åˆ°ç»Ÿä¸€çš„ä¼šè¯æ¶ˆæ¯åˆ—è¡¨ï¼Œç¡®ä¿â€œå·²é—®é—®é¢˜æ•°â€ç»Ÿè®¡ä¸€è‡´
  if (window.clinicalSession && Array.isArray(window.clinicalSession.chatMessages)) {
    window.clinicalSession.chatMessages.push({
      type: type,
      content: content,
      timestamp: new Date()
    });
  }
};

// ==================== ç»Ÿä¸€ï¼šå·²é—®é—®é¢˜æ•°ç»Ÿè®¡ ====================
// å³ä¾§â€œé—®è¯Šè¿›åº¦â€å’Œâ€œå·²è·å¾—è¶³å¤Ÿä¿¡æ¯â€å¼¹çª—å¿…é¡»ä½¿ç”¨åŒä¸€æ•°æ®æºï¼Œé¿å…å‡ºç°ä¸ä¸€è‡´ã€‚
window.questionCount = 0;
window.getAskedQuestionCount = function() {
  try {
    const session = window.clinicalSession || window.clinicalSessionGlobal;
    if (session && Array.isArray(session.chatMessages)) {
      return session.chatMessages.filter(m => m && m.type === 'student_question').length;
    }
  } catch (e) {
    console.warn('ç»Ÿè®¡å·²é—®é—®é¢˜æ•°å¤±è´¥ï¼Œå°†ä½¿ç”¨DOMå…œåº•ç»Ÿè®¡:', e);
  }

  // å…œåº•ï¼šä»DOMä¸­ç»Ÿè®¡å­¦ç”Ÿæ¶ˆæ¯ï¼ˆé¿å…ä¼šè¯å¯¹è±¡æœªåˆå§‹åŒ–æ—¶æ˜¾ç¤ºå¼‚å¸¸ï¼‰
  return document.querySelectorAll('#chat-messages-history .message-student, #chat-messages .message-student').length;
};

window.updateQuestionCount = function() {
  const count = window.getAskedQuestionCount();
  window.questionCount = count;

  const countElement = $('#questions-asked-count');
  if (countElement.length > 0) {
    countElement.text(count);
  }

  // æ›´æ–°è¿›åº¦æ¡ï¼ˆä»¥8ä¸ªé—®é¢˜ä¸ºâ€œæ”¶é›†å……åˆ†â€çš„å‚è€ƒå€¼ï¼‰
  const targetQuestions = (window.CLINICAL_CONFIG && Number.isFinite(window.CLINICAL_CONFIG.HISTORY_PROGRESS_TARGET_QUESTIONS))
    ? window.CLINICAL_CONFIG.HISTORY_PROGRESS_TARGET_QUESTIONS
    : 8;
  const progress = Math.min((count / targetQuestions) * 100, 100);
  const progressElement = $('#history-collection-progress');
  if (progressElement.length > 0) {
    progressElement.css('width', progress + '%');
  }

  return count;
};

(function() {
  // ==================== æ ¸å¿ƒçŠ¶æ€ç®¡ç† ====================
  window.clinicalSession = {
    caseId: '{{ clinical_case.case_id }}',
    currentStage: 'case_presentation',
    stages: ['case_presentation', 'examination_selection', 'diagnosis_reasoning', 'treatment_selection', 'learning_feedback'],
    
    // ä¸´åºŠæ•°æ®æ”¶é›†
    selectedExaminations: [],
    examinationResults: [],
    clinicalFindings: {},
    
    // è¯Šæ–­æ¨ç†
    diagnosticHypotheses: [],
    selectedDiagnosis: null, // ä¿ç•™å…¼å®¹æ€§
    selectedDiagnoses: [], // å¤šé€‰é‰´åˆ«è¯Šæ–­
    differentialAnalysis: {},
    
    // æ²»ç–—å†³ç­–
    selectedTreatments: [],
    treatmentRationale: '',
    
    // å­¦ä¹ è¯„ä¼°
    scores: {
      examination: 0,
      diagnosis: 0,
      treatment: 0,
      overall: 0,
      clinicalThinking: 0
    },
    
    // èŠå¤©é—®è¯Šç›¸å…³
    chatMessages: [],
    chatEnabled: true,
    chatCollapsed: false,
    
    // æ—¶é—´è·Ÿè¸ª
    timeSpent: {},
    startTime: new Date(),
    
    // çœ¼åº•æ£€æŸ¥å­—å¹•æ§åˆ¶
    fundusSubtitleDismissed: false,
    
    // ç¼“å­˜çš„æ•°æ®é€‰é¡¹
    diagnosisOptions: [],
    treatmentOptions: [],
    
    // æ•™å­¦åé¦ˆ
    feedbackHistory: [],
    clinicalMistakes: [],
    learningInsights: []
  };

  // å°†clinicalSessionè®¾ä¸ºå…¨å±€å˜é‡ï¼Œä¾›å…¨å±€å‡½æ•°ä½¿ç”¨
  window.clinicalSessionGlobal = clinicalSession;

  // é¡µé¢åŠ è½½æ—¶è·å–å½“å‰ä¼šè¯çŠ¶æ€
  function applyReviewDataFromProgress(progressData) {
    // progressData: response.data from /api/clinical/get-progress/<case_id>/
    try {
      if (!progressData || !progressData.review) return;

      var review = progressData.review;

      // ç”¨åç«¯ä¼šè¯æ—¶é—´æ ¡å‡†å‰ç«¯ startTime / totalï¼ˆç¡®ä¿â€œå„é˜¶æ®µç”¨æ—¶â€ä¸â€œæ€»ç”¨æ—¶â€å£å¾„ä¸€è‡´ï¼‰
      try {
        if (review.session_started_at) {
          var st = new Date(review.session_started_at);
          if (!isNaN(st.getTime())) {
            clinicalSession.startTime = st;
          }
        }
        if (typeof review.session_total_ms === 'number' && isFinite(review.session_total_ms) && review.session_total_ms >= 0) {
          clinicalSession.timeSpent = clinicalSession.timeSpent || {};
          clinicalSession.timeSpent.total = Math.max(0, review.session_total_ms);
        }
      } catch (eTime) {}

      // æ£€æŸ¥é€‰æ‹©ï¼šä¼˜å…ˆç”¨åç«¯å¸¦å›çš„è¯¦æƒ…ï¼ˆå«åç§°ï¼‰
      if (Array.isArray(review.selected_examinations)) {
        clinicalSession.selectedExaminationsDetail = review.selected_examinations;
        clinicalSession.selectedExaminations = review.selected_examinations
          .map(function(x) { return x && typeof x.id !== 'undefined' ? parseInt(x.id) : null; })
          .filter(function(x) { return x !== null && !isNaN(x); });
      }

      // è¯Šæ–­æäº¤ï¼šæ¥è‡ª session_data['diagnosis']
      if (review.diagnosis && Array.isArray(review.diagnosis.diagnosis_ids)) {
        clinicalSession.selectedDiagnoses = review.diagnosis.diagnosis_ids;
        clinicalSession.reviewDiagnosisNames = Array.isArray(review.diagnosis.diagnosis_names)
          ? review.diagnosis.diagnosis_names
          : [];
        clinicalSession.reviewDiagnosisRationale = (review.diagnosis.diagnosis_rationale || '');
      }

      // æ²»ç–—æäº¤ï¼šæ¥è‡ª session_data['treatment']
      if (Array.isArray(review.selected_treatments)) {
        clinicalSession.selectedTreatmentsDetail = review.selected_treatments;
        clinicalSession.selectedTreatments = review.selected_treatments
          .map(function(x) { return x && typeof x.id !== 'undefined' ? parseInt(x.id) : null; })
          .filter(function(x) { return x !== null && !isNaN(x); });
      }
      if (review.treatment) {
        if (Array.isArray(review.treatment.treatment_names)) {
          clinicalSession.reviewTreatmentNames = review.treatment.treatment_names;
        }
        if (review.treatment.treatment_rationale) {
          clinicalSession.treatmentRationale = review.treatment.treatment_rationale;
        }
      }

      // é˜¶æ®µç”¨æ—¶ï¼ˆåç«¯è®°å½•çš„ stage_timesï¼Œä¾›éœ€è¦æ—¶ä½¿ç”¨ï¼‰
      if (review.stage_durations_ms && typeof review.stage_durations_ms === 'object') {
        clinicalSession.backendStageDurationsMs = review.stage_durations_ms;
      }
    } catch (e) {
      console.warn('å¤ç›˜æ•°æ®å›å¡«å¤±è´¥:', e);
    }
  }

  window.refreshReviewData = function(done) {
    $.ajax({
      url: `/api/clinical/get-progress/{{ clinical_case.case_id }}/`,
      method: 'GET',
      timeout: 15000,
      success: function(response) {
        if (response && response.success && response.data) {
          try {
            if (response.data.review) {
              console.log('ğŸ” get-progress review.diagnosis:', response.data.review.diagnosis);
              console.log('ğŸ” get-progress review.selected_examinations:', response.data.review.selected_examinations);
            }
          } catch (e) {}
          applyReviewDataFromProgress(response.data);
        }
      },
      error: function(xhr, status, error) {
        console.warn('åˆ·æ–°å¤ç›˜æ•°æ®å¤±è´¥:', status, error);
      },
      complete: function() {
        if (typeof done === 'function') done();
      }
    });
  };

  function initializeSessionState() {
    $.ajax({
      url: `/api/clinical/get-progress/{{ clinical_case.case_id }}/`,
      method: 'GET',
      success: function(response) {
        if (response.success && response.data) {
          const sessionStatus = response.data.session_status;
          console.log('ğŸ” åç«¯ä¼šè¯çŠ¶æ€:', sessionStatus);

          // é¡µé¢åŠ è½½æ—¶å›å¡«ä¸€æ¬¡å¤ç›˜æ•°æ®
          applyReviewDataFromProgress(response.data);
          
          // æ›´æ–°currentStage - æ˜ å°„åç«¯session_statusåˆ°å‰ç«¯currentStage
          if (sessionStatus === 'case_presentation') {
            clinicalSession.currentStage = 'case_presentation';
            console.log('âœ“ å½“å‰é˜¶æ®µ: ç—…å²é‡‡é›† (å…è®¸èŠå¤©)');
          } else if (sessionStatus === 'examination_selection' || sessionStatus === 'examination_results') {
            clinicalSession.currentStage = 'examination_selection';
            console.log('âœ“ å½“å‰é˜¶æ®µ: æ£€æŸ¥é€‰æ‹© (å…è®¸èŠå¤©)');
          } else if (sessionStatus === 'diagnosis_reasoning') {
            clinicalSession.currentStage = 'diagnosis_reasoning';
            console.log('âœ— å½“å‰é˜¶æ®µ: è¯Šæ–­æ¨ç† (ç¦æ­¢èŠå¤©)');
            // ç¦ç”¨èŠå¤©åŠŸèƒ½
            $('#patient-question-global').prop('disabled', true).attr('placeholder', 'è¯Šæ–­æ¨ç†é˜¶æ®µä¸æ”¯æŒèŠå¤©åŠŸèƒ½');
            $('.chat-input button').prop('disabled', true).css('opacity', '0.5');
            $('#quick-question-buttons button').prop('disabled', true).addClass('disabled').css('opacity', '0.5');
          } else if (sessionStatus === 'treatment_selection') {
            clinicalSession.currentStage = 'treatment_selection';
            console.log('âœ— å½“å‰é˜¶æ®µ: æ²»ç–—é€‰æ‹© (ç¦æ­¢èŠå¤©)');
            // ç¦ç”¨èŠå¤©åŠŸèƒ½
            $('#patient-question-global').prop('disabled', true).attr('placeholder', 'æ²»ç–—é˜¶æ®µä¸æ”¯æŒèŠå¤©åŠŸèƒ½');
            $('.chat-input button').prop('disabled', true).css('opacity', '0.5');
            $('#quick-question-buttons button').prop('disabled', true).addClass('disabled').css('opacity', '0.5');
          } else if (sessionStatus === 'learning_feedback' || sessionStatus === 'completed') {
            // é‡è¦ï¼šåˆ·æ–°/é‡è¿›é¡µé¢æ—¶å¿…é¡»æ­£ç¡®è¯†åˆ«å­¦ä¹ åé¦ˆé˜¶æ®µ
            // å¦åˆ™ä¼šä¿æŒé»˜è®¤ case_presentation å¹¶åŒæ­¥åˆ°åç«¯ï¼Œè¯¯è§¦å‘â€œé‡å¼€è®¡æ—¶â€å¯¼è‡´é˜¶æ®µç”¨æ—¶å…¨éƒ¨å˜æˆæœªè®°å½•ã€‚
            clinicalSession.currentStage = 'learning_feedback';
            console.log('âœ“ å½“å‰é˜¶æ®µ: å­¦ä¹ åé¦ˆ');
          } else {
            console.log('âš ï¸ æœªçŸ¥é˜¶æ®µ:', sessionStatus);
          }
          
          console.log('ğŸ“Œ å‰ç«¯currentStage:', clinicalSession.currentStage);

          // ç»Ÿä¸€é˜¶æ®µå‘½åï¼ˆå…¼å®¹æ—§å…¥å£/æ—§å­˜é‡ï¼‰
          try {
            if (typeof window.normalizeClinicalStage === 'function') {
              clinicalSession.currentStage = window.normalizeClinicalStage(clinicalSession.currentStage);
            }
          } catch (eNormInit) {}

          // å…³é”®ï¼šé¡µé¢åŠ è½½æ—¶ä¹Ÿè¦è§¦å‘ä¸€æ¬¡é˜¶æ®µåŒæ­¥ï¼Œç¡®ä¿åç«¯å†™å…¥ run_started_at/stage_start_times
          try {
            window.syncStageToBackend(clinicalSession.currentStage);
          } catch (eSyncInit) {}
        }
      },
      error: function(xhr, status, error) {
        console.error('âŒ è·å–ä¼šè¯çŠ¶æ€å¤±è´¥:', error);
      }
    });
  }
  
  // åŒæ­¥å‰ç«¯é˜¶æ®µçŠ¶æ€åˆ°åç«¯
  // åŒæ—¶åœ¨å‰ç«¯è®°å½•â€œå„é˜¶æ®µç”¨æ—¶â€ï¼ˆç”¨äºå¸ˆç”Ÿå¤ç›˜å±•ç¤ºï¼‰
  window.normalizeClinicalStage = function(stage) {
    try {
      if (stage === null || stage === undefined) return stage;
      var s = String(stage);

      // æ—§å‘½å/åˆ«å -> åç«¯æ ‡å‡†é˜¶æ®µ
      var alias = {
        'history': 'case_presentation',
        'case': 'case_presentation',
        'presentation': 'case_presentation',

        'examination': 'examination_selection',
        'exam': 'examination_selection',

        'diagnosis': 'diagnosis_reasoning',
        'dx': 'diagnosis_reasoning',

        'treatment': 'treatment_selection',
        'tx': 'treatment_selection',

        'feedback': 'learning_feedback',
        'final_feedback': 'learning_feedback'
      };

      if (alias[s]) return alias[s];
      return s;
    } catch (e) {
      return stage;
    }
  };

  window.trackStageTransition = function(newStage) {
    try {
      if (typeof window.normalizeClinicalStage === 'function') {
        newStage = window.normalizeClinicalStage(newStage);
      }

      if (!clinicalSession.stageTiming) {
        clinicalSession.stageTiming = {
          starts: {},
          ends: {},
          durationsMs: {},
          lastStage: null
        };
      }

      var now = Date.now();
      var timing = clinicalSession.stageTiming;

      // åˆå§‹åŒ–ï¼šé¦–æ¬¡è®°å½•
      if (!timing.lastStage) {
        timing.lastStage = newStage;
        if (!timing.starts[newStage]) timing.starts[newStage] = now;
        return;
      }

      // ç›¸åŒé˜¶æ®µé‡å¤åŒæ­¥ï¼šä¸åšåˆ‡æ¢ï¼Œåªè¡¥é½ start
      if (timing.lastStage === newStage) {
        if (!timing.starts[newStage]) timing.starts[newStage] = now;
        return;
      }

      // å‘ç”Ÿé˜¶æ®µåˆ‡æ¢ï¼šç»“ç®—æ—§é˜¶æ®µç”¨æ—¶ï¼Œå¹¶å¼€å§‹æ–°é˜¶æ®µè®¡æ—¶
      var oldStage = timing.lastStage;
      if (!timing.starts[oldStage]) {
        // å…œåº•ï¼šå¦‚æœæ—§é˜¶æ®µ start ç¼ºå¤±ï¼Œç”¨ startTime ä¼°ç®—
        timing.starts[oldStage] = (clinicalSession.startTime && clinicalSession.startTime.getTime)
          ? clinicalSession.startTime.getTime()
          : now;
      }
      timing.ends[oldStage] = now;
      timing.durationsMs[oldStage] = Math.max(0, timing.ends[oldStage] - timing.starts[oldStage]);

      timing.lastStage = newStage;
      if (!timing.starts[newStage]) timing.starts[newStage] = now;
    } catch (e) {
      console.warn('é˜¶æ®µè®¡æ—¶è®°å½•å¤±è´¥ï¼ˆå¯å¿½ç•¥ï¼‰:', e);
    }
  };

  window.syncStageToBackend = function(newStage) {
    var normalizedStage = newStage;
    try {
      if (typeof window.normalizeClinicalStage === 'function') {
        normalizedStage = window.normalizeClinicalStage(newStage);
      }
    } catch (eNorm) {}

    if (normalizedStage !== newStage) {
      console.log('ğŸ”„ åŒæ­¥é˜¶æ®µåˆ°åç«¯(å½’ä¸€åŒ–):', newStage, '=>', normalizedStage);
    } else {
      console.log('ğŸ”„ åŒæ­¥é˜¶æ®µåˆ°åç«¯:', normalizedStage);
    }

    // å…ˆåœ¨å‰ç«¯è®°å½•é˜¶æ®µåˆ‡æ¢æ—¶é—´ï¼ˆä¸ä¾èµ–åç«¯å“åº”ï¼‰
    if (typeof window.trackStageTransition === 'function') {
      window.trackStageTransition(normalizedStage);
    }
    
    $.ajax({
      url: `/api/clinical/case/${clinicalSession.caseId}/update-stage/`,
      method: 'POST',
      headers: {
        'X-CSRFToken': $('[name=csrfmiddlewaretoken]').val()
      },
      data: JSON.stringify({
        stage: normalizedStage
      }),
      contentType: 'application/json',
      success: function(response) {
        if (response.success) {
          console.log('âœ“ é˜¶æ®µåŒæ­¥æˆåŠŸ:', normalizedStage);
        } else {
          console.error('âŒ é˜¶æ®µåŒæ­¥å¤±è´¥:', response.message);
        }
      },
      error: function(xhr, status, error) {
        console.error('âŒ é˜¶æ®µåŒæ­¥è¯·æ±‚å¤±è´¥:', error);
      }
    });
  };
  
  // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–ä¼šè¯çŠ¶æ€
  $(document).ready(function() {
    initializeSessionState();
  });

  // ==================== åŒ»å­¦æ•™è‚²æ ¸å¿ƒåŠŸèƒ½ ====================
  
  // ç´§æ€¥ä¿®å¤ï¼šç¡®ä¿æŒ‰é’®å¯ç”¨çš„å‡½æ•°
  function ensureButtonEnabled() {
    var stage = clinicalSession.currentStage;
    console.log('ç¡®ä¿æŒ‰é’®å¯ç”¨ - å½“å‰é˜¶æ®µ:', stage);
    
    $('#btn-next').prop('disabled', false);
    
    switch(stage) {
      case 'examination_selection':
        $('#btn-next').removeClass('btn-secondary btn-info btn-success').addClass('btn-warning').text('ç¡®è®¤æ£€æŸ¥é€‰æ‹© â†’');
        break;
      case 'diagnosis_reasoning':
        $('#btn-next').removeClass('btn-warning btn-secondary btn-success').addClass('btn-info').text('æäº¤è¯Šæ–­é€‰æ‹© â†’');
        break;
      case 'treatment_selection':
        $('#btn-next').removeClass('btn-warning btn-info btn-secondary').addClass('btn-success').text('æäº¤æ²»ç–—æ–¹æ¡ˆ â†’');
        break;
    }
    
    console.log('æŒ‰é’®çŠ¶æ€å·²å¼ºåˆ¶å¯ç”¨:', $('#btn-next').prop('disabled'));
  }
  
  // è°ƒè¯•å‡½æ•°
  function debugButtonStatus() {
    console.log('=== æŒ‰é’®çŠ¶æ€è°ƒè¯• ===');
    console.log('æŒ‰é’®æ˜¯å¦ç¦ç”¨:', $('#btn-next').prop('disabled'));
    console.log('æŒ‰é’®æ–‡æœ¬:', $('#btn-next').text());
    console.log('æŒ‰é’®ç±»å:', $('#btn-next').attr('class'));
    console.log('å½“å‰é˜¶æ®µ:', clinicalSession.currentStage);
    console.log('å·²é€‰æ‹©è¯Šæ–­:', clinicalSession.selectedDiagnosis);
    console.log('====================');
  }
  
  window.updateClinicalProgress = function() {
    // ç»Ÿä¸€é˜¶æ®µå‘½åï¼ˆå…¼å®¹æ—§å€¼ï¼šhistory/examination/diagnosis/treatment/feedbackï¼‰
    try {
      if (typeof window.normalizeClinicalStage === 'function') {
        clinicalSession.currentStage = window.normalizeClinicalStage(clinicalSession.currentStage);
      }
    } catch (eNorm) {}

    // æ›´æ–°å¯è§†åŒ–è¿›åº¦æŒ‡ç¤ºå™¨ï¼ˆåŒæ—¶æ›´æ–°é¡µé¢é¡¶éƒ¨å’Œå…¨å±ç•Œé¢é¡¶éƒ¨çš„ä¸¤ä¸ªè¿›åº¦æ¡ï¼‰
    $('.stepper-item').removeClass('active completed thinking');
    var currentIndex = clinicalSession.stages.indexOf(clinicalSession.currentStage);
    
    for (var i = 0; i <= currentIndex; i++) {
      var $step = $('.stepper-item[data-step="' + clinicalSession.stages[i] + '"]');
      if (i === currentIndex) {
        $step.addClass('active thinking');
        // æ·»åŠ æ€è€ƒåŠ¨ç”»æ•ˆæœ
        $step.find('.stepper-icon').html('<i class="fas fa-brain fa-pulse"></i>');
      } else {
        $step.addClass('completed');
        $step.find('.stepper-icon').html('<i class="fas fa-check"></i>');
      }
    }
    
    console.log('è¿›åº¦æ¡å·²æ›´æ–°:', clinicalSession.currentStage, '(ç´¢å¼•:', currentIndex, ')');
    // é«˜äº®å½“å‰æ­¥éª¤ä¸€æ¬¡
    highlightStep(clinicalSession.currentStage);
    
    // æ›´æ–°é˜¶æ®µæç¤º
    updateStageGuidance();
  }
  
  function updateStageGuidance() {
    var guidance = {
      'history': {
        title: 'ğŸ“‹ ç—…å²é‡‡é›†é˜¶æ®µ',
        instruction: 'ä»”ç»†é˜…è¯»æ‚£è€…çš„ä¸»è¯‰å’Œç—…å²ä¿¡æ¯ï¼Œè¿™æ˜¯ä¸´åºŠæ¨ç†çš„åŸºç¡€ã€‚æ€è€ƒï¼šæ‚£è€…çš„ä¸»è¦é—®é¢˜æ˜¯ä»€ä¹ˆï¼Ÿå¯èƒ½çš„ç—…å› æœ‰å“ªäº›ï¼Ÿ',
        tips: ['æ³¨æ„ç—‡çŠ¶çš„æ—¶é—´é¡ºåº', 'å…³æ³¨æ—¢å¾€å²çš„ç›¸å…³æ€§', 'æ€è€ƒç—‡çŠ¶çš„ä¸¥é‡ç¨‹åº¦']
      },
      'examination': {
        title: 'ğŸ” ä¸´åºŠæ£€æŸ¥é˜¶æ®µ', 
        instruction: 'åŸºäºç—…å²åˆ†æï¼Œé€‰æ‹©æœ€æœ‰ä»·å€¼çš„æ£€æŸ¥é¡¹ç›®ã€‚è®°ä½ï¼šåˆç†çš„æ£€æŸ¥é€‰æ‹©ä½“ç°ä¸´åºŠæ€ç»´èƒ½åŠ›ã€‚',
        tips: ['ä¼˜å…ˆé€‰æ‹©æ€§ä»·æ¯”é«˜çš„æ£€æŸ¥', 'é¿å…è¿‡åº¦æ£€æŸ¥', 'è€ƒè™‘æ£€æŸ¥çš„è¯Šæ–­ä»·å€¼']
      },
      'diagnosis': {
        title: 'ğŸ¯ è¯Šæ–­æ¨ç†é˜¶æ®µ',
        instruction: 'ç»¼åˆç—…å²å’Œæ£€æŸ¥ç»“æœï¼Œè¿›è¡Œé‰´åˆ«è¯Šæ–­ã€‚æ€è€ƒå„ç§å¯èƒ½æ€§çš„æ¦‚ç‡ï¼Œé€‰æ‹©æœ€å¯èƒ½çš„è¯Šæ–­ã€‚',
        tips: ['åˆ—å‡ºé‰´åˆ«è¯Šæ–­', 'åˆ†ææ”¯æŒå’Œåå¯¹è¯æ®', 'è€ƒè™‘ç–¾ç—…çš„æµè¡Œç—…å­¦ç‰¹ç‚¹']
      },
      'treatment': {
        title: 'ğŸ’Š æ²»ç–—å†³ç­–é˜¶æ®µ',
        instruction: 'åŸºäºç¡®å®šçš„è¯Šæ–­ï¼Œåˆ¶å®šåˆç†çš„æ²»ç–—æ–¹æ¡ˆã€‚è€ƒè™‘æ²»ç–—çš„æœ‰æ•ˆæ€§ã€å®‰å…¨æ€§å’Œæˆæœ¬æ•ˆç›Šã€‚',
        tips: ['ä¸ªä½“åŒ–æ²»ç–—æ–¹æ¡ˆ', 'è€ƒè™‘æ‚£è€…æ‰¿å—èƒ½åŠ›', 'æƒè¡¡è·ç›Šå’Œé£é™©']
      },
      'feedback': {
        title: 'ğŸ“š å­¦ä¹ æ€»ç»“é˜¶æ®µ',
        instruction: 'å›é¡¾æ•´ä¸ªä¸´åºŠæ¨ç†è¿‡ç¨‹ï¼Œæ€»ç»“å­¦ä¹ è¦ç‚¹å’Œæ”¹è¿›æ–¹å‘ã€‚',
        tips: ['åæ€å†³ç­–è¿‡ç¨‹', 'å·©å›ºå…³é”®çŸ¥è¯†ç‚¹', 'åˆ¶å®šå­¦ä¹ è®¡åˆ’']
      }
    };
    
    var current = guidance[clinicalSession.currentStage];
    if (current) {
      var html = '<div class="clinical-guidance card mb-3">';
      html += '<div class="card-body">';
      html += '<h6 class="card-title text-primary">' + current.title + '</h6>';
      html += '<p class="card-text">' + current.instruction + '</p>';
      html += '<div class="clinical-tips">';
      html += '<small class="text-muted"><strong>ä¸´åºŠæ€ç»´è¦ç‚¹ï¼š</strong></small>';
      html += '<ul class="small text-muted mb-0">';
      current.tips.forEach(function(tip) {
        html += '<li>' + tip + '</li>';
      });
      html += '</ul>';
      html += '</div>';
      html += '</div>';
      html += '</div>';
      
      $('#clinical-guidance').html(html);
    }
  }

  
  // ==================== ç—…å²é˜¶æ®µï¼šå»ºç«‹ä¸´åºŠå°è±¡ ====================
  
  function updatePatientInfoInHeader(data) {
    // æ›´æ–°æ ‡é¢˜åŒºåŸŸçš„æ‚£è€…ä¿¡æ¯ - å¸¦æ ‡ç­¾æ˜¾ç¤º
    var patientInfoHtml = '<div class="text-muted" style="font-size: 0.95rem; font-family: -apple-system, BlinkMacSystemFont, \'Segoe UI\', Roboto, Arial, sans-serif;">';
    
    // æ·»åŠ åŸºç¡€ä¿¡æ¯æ ‡ç­¾ï¼Œç„¶åæ˜¯å¹´é¾„æ€§åˆ«ã€ç¼–å·ã€èŒä¸š
    patientInfoHtml += '<span style="color: #495057; font-weight: 600;">åŸºç¡€ä¿¡æ¯ï¼š</span>';
    patientInfoHtml += '<span style="font-weight: 500;">' + (data.patient_info.age || 'æœªçŸ¥') + 'å² ' + (data.patient_info.gender || 'æœªçŸ¥') + '</span>';
    patientInfoHtml += '<span style="margin: 0 12px; color: #6c757d;">â€¢</span>';
    patientInfoHtml += '<span style="font-weight: 500;">ç¼–å·ï¼š' + data.case_id + '</span>';
    
    // èŒä¸šï¼ˆå¦‚æœæœ‰ï¼‰
    if (data.patient_info.occupation) {
      patientInfoHtml += '<span style="margin: 0 12px; color: #6c757d;">â€¢</span>';
      patientInfoHtml += '<span style="font-weight: 500;">èŒä¸šï¼š' + data.patient_info.occupation + '</span>';
    }
    
    patientInfoHtml += '</div>';
    
    // æ›´æ–°DOM
    $('#patient-info').html(patientInfoHtml);
  }
  
  // ==================== èŠå¤©é—®è¯ŠåŠŸèƒ½ ====================
  
  function updateChatStatus() {
    // ç»Ÿä¸€æ§åˆ¶â€œå…¨å±€æµ®åŠ¨èŠå¤©çª—å£â€ï¼ˆé¡µé¢å®é™…ä½¿ç”¨çš„æ˜¯ *-global è¿™å¥—DOMï¼‰
    const chatWindow = document.getElementById('floating-chat-window-global');
    const chatInput = document.getElementById('patient-question-global');
    const chatSendBtn = document.querySelector('#floating-chat-window-global .chat-input button');
    const quickBtns = document.querySelectorAll('#quick-question-buttons button');

    // è‹¥æŸäº›é¡µé¢/æ—§å¸ƒå±€å­˜åœ¨é˜¶æ®µå¾½ç« ï¼Œä¹Ÿå°½é‡æ›´æ–°ï¼ˆä¸å¼ºä¾èµ–ï¼‰
    const stageBadge = document.getElementById('chat-stage-badge');
    const stageNames = {
      'case_presentation': 'ç—…å²é‡‡é›†',
      'examination_selection': 'è¾…åŠ©æ£€æŸ¥',
      'diagnosis_reasoning': 'è¯Šæ–­æ¨ç†',
      'treatment_selection': 'æ²»ç–—æ–¹æ¡ˆ',
      'learning_feedback': 'å­¦ä¹ åé¦ˆ'
    };
    if (stageBadge) {
      stageBadge.textContent = stageNames[clinicalSession.currentStage] || 'æœªçŸ¥é˜¶æ®µ';
    }

    const stage = clinicalSession.currentStage;
    const disableChat = (stage === 'diagnosis_reasoning' || stage === 'treatment_selection' || stage === 'learning_feedback');

    if (chatWindow) {
      chatWindow.classList.toggle('chat-disabled', disableChat);
      // å­¦ä¹ åé¦ˆé˜¶æ®µï¼šèŠå¤©æ¡†æ•´ä½“ä¸æ˜¾ç¤ºï¼ˆå¤ç›˜ç•Œé¢æ›´å¹²å‡€ï¼‰
      if (stage === 'learning_feedback') {
        chatWindow.style.display = 'none';
      } else {
        chatWindow.style.display = '';
      }
    }
    if (chatInput) {
      chatInput.disabled = disableChat;
      if (!disableChat) {
        chatInput.placeholder = 'è¾“å…¥æ‚¨æƒ³è¯¢é—®æ‚£è€…çš„é—®é¢˜...';
      } else if (stage === 'diagnosis_reasoning') {
        chatInput.placeholder = 'è¯Šæ–­æ¨ç†é˜¶æ®µä¸æ”¯æŒèŠå¤©åŠŸèƒ½';
      } else if (stage === 'treatment_selection') {
        chatInput.placeholder = 'æ²»ç–—é˜¶æ®µä¸æ”¯æŒèŠå¤©åŠŸèƒ½';
      } else {
        chatInput.placeholder = 'é—®è¯Šè®°å½•ï¼ˆåªè¯»ï¼‰';
      }
    }
    if (chatSendBtn) {
      chatSendBtn.disabled = disableChat;
    }
    if (quickBtns && quickBtns.length) {
      quickBtns.forEach(btn => {
        btn.disabled = disableChat;
        btn.classList.toggle('disabled', disableChat);
      });
    }

    clinicalSession.chatEnabled = !disableChat;
  }
  
  function handleChatKeyPress(event) {
    if (event.key === 'Enter' && !event.shiftKey) {
      event.preventDefault();
      askPatient();
    }
    
    // æ›´æ–°å­—ç¬¦è®¡æ•°
    updateCharCount();
  }
  
  // å¤„ç†èŠå¤©è¾“å…¥æ¡†æŒ‰é”®äº‹ä»¶
  window.handleChatKeyPress = function(event) {
    if (event.key === 'Enter' && !event.shiftKey) {
      event.preventDefault();
      askPatient();
    }
  };

  // æµ®åŠ¨çª—å£ä¸“ç”¨çš„é—®æ‚£è€…å‡½æ•°
  window.askPatient = function() {
    // æ£€æŸ¥å½“å‰é˜¶æ®µæ˜¯å¦å…è®¸èŠå¤©ï¼ˆè¯Šæ–­å’Œæ²»ç–—é˜¶æ®µç¦æ­¢èŠå¤©ï¼‰
    console.log('askPatient - å½“å‰é˜¶æ®µ:', clinicalSession.currentStage);
    if (clinicalSession.currentStage === 'diagnosis_reasoning' || clinicalSession.currentStage === 'treatment_selection') {
      alert('å½“å‰é˜¶æ®µä¸æ”¯æŒèŠå¤©åŠŸèƒ½');
      return;
    }
    
    const chatInput = document.getElementById('patient-question-global');
    
    if (!chatInput || !chatInput.value.trim()) {
      return;
    }
    
    const messageText = chatInput.value.trim();
    chatInput.value = '';
    
    // å‘é€æ¶ˆæ¯
    addChatMessage('student_question', messageText);
    getChatResponse(messageText);
  };
  
  function updateCharCount() {
    const chatInput = document.getElementById('patient-question-global');
    const charCount = document.getElementById('chat-char-count');
    
    if (charCount && chatInput) {
      charCount.textContent = chatInput.value.length;
    }
  }
  
  function sendChatMessage() {
    const chatInput = document.getElementById('patient-question') || document.getElementById('chat-input');
    const messageText = chatInput.value.trim();
    
    if (!messageText || !clinicalSession.chatEnabled) {
      return;
    }
    
    // æ·»åŠ å­¦ç”Ÿæ¶ˆæ¯åˆ°ç•Œé¢
    addChatMessage('student_question', messageText);
    
    // æ¸…ç©ºè¾“å…¥æ¡†
    chatInput.value = '';
    updateCharCount();
    
    // å‘é€åˆ°åç«¯è·å–ç—…äººå›ç­”
    getChatResponse(messageText);
  }
  
  window.addChatMessage = function(type, content, timestamp) {
    // ä¼˜å…ˆä½¿ç”¨ç—…å²é˜¶æ®µçš„èŠå¤©å®¹å™¨ï¼Œå¦‚æœä¸å­˜åœ¨åˆ™ä½¿ç”¨é»˜è®¤çš„
    let messagesContainer = document.getElementById('chat-messages-history');
    if (!messagesContainer) {
      messagesContainer = document.getElementById('chat-messages');
    }
    
    if (!messagesContainer) {
      console.error('æ‰¾ä¸åˆ°èŠå¤©æ¶ˆæ¯å®¹å™¨');
      return;
    }
    
    const messageDiv = document.createElement('div');
    messageDiv.className = 'chat-message';
    
    const now = timestamp || new Date();
    const timeStr = now.toLocaleTimeString('zh-CN', { 
      hour: '2-digit', 
      minute: '2-digit'
    });
    
    let messageHtml = '';
    
    if (type === 'student_question') {
      messageHtml = `
        <div class="message-student">
          <div class="message-content">
            <div class="message-bubble">${escapeHtml(content)}</div>
            <div class="message-timestamp">${timeStr}</div>
          </div>
          <div class="message-avatar avatar-student">å­¦</div>
        </div>
      `;
    } else if (type === 'patient_response') {
      messageHtml = `
        <div class="message-patient">
          <div class="message-avatar avatar-patient">æ‚£</div>
          <div class="message-content">
            <div class="message-bubble">${escapeHtml(content)}</div>
            <div class="message-timestamp">${timeStr}</div>
          </div>
        </div>
      `;
    } else if (type === 'system_hint') {
      messageHtml = `
        <div class="message-system">
          <div class="message-bubble">${escapeHtml(content)}</div>
          <div class="message-timestamp">${timeStr}</div>
        </div>
      `;
    }
    
    messageDiv.innerHTML = messageHtml;
    messagesContainer.appendChild(messageDiv);
    
    // æ»šåŠ¨åˆ°åº•éƒ¨
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
    
    // æ·»åŠ åˆ°ä¼šè¯è®°å½•
    clinicalSession.chatMessages.push({
      type: type,
      content: content,
      timestamp: now
    });
  }
  
  function showTypingIndicator() {
    const messagesContainer = document.getElementById('chat-messages-history');
    if (!messagesContainer) {
      console.error('èŠå¤©æ¶ˆæ¯å®¹å™¨æœªæ‰¾åˆ°');
      return;
    }
    
    const typingDiv = document.createElement('div');
    typingDiv.id = 'typing-indicator';
    typingDiv.className = 'message-loading';
    typingDiv.innerHTML = `
      <div class="message-avatar avatar-patient">æ‚£</div>
      <div class="message-bubble">
        <div class="typing-indicator">
          <div class="typing-dot"></div>
          <div class="typing-dot"></div>
          <div class="typing-dot"></div>
        </div>
      </div>
    `;
    
    messagesContainer.appendChild(typingDiv);
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
  }
  
  function hideTypingIndicator() {
    const typingDiv = document.getElementById('typing-indicator');
    if (typingDiv) {
      typingDiv.remove();
    }
  }
  
  function getChatResponse(question) {
    // æ˜¾ç¤ºæ­£åœ¨è¾“å…¥æŒ‡ç¤ºå™¨
    showTypingIndicator();
    
    // å‘é€AJAXè¯·æ±‚è·å–ç—…äººå›ç­”
    $.ajax({
      url: `/api/clinical/case/${clinicalSession.caseId}/chat/`,
      method: 'POST',
      headers: {
        'X-CSRFToken': $('[name=csrfmiddlewaretoken]').val()
      },
      data: JSON.stringify({
        message: question,
        stage: clinicalSession.currentStage
      }),
      contentType: 'application/json',
      success: function(response) {
        hideTypingIndicator();
        
        console.log('ğŸ’¬ æ”¶åˆ°åç«¯å“åº”:', response);
        
        if (response.success) {
          const responseData = response.response || response.data;
          const responseText = responseData.content || responseData.response;
          
          console.log('ğŸ’¬ æå–çš„å›ç­”æ–‡æœ¬:', responseText);
          
          // æ·»åŠ ç—…äººå›ç­”
          addChatMessage('patient_response', responseText);
          
          // æå–å¹¶æ›´æ–°ç—…å²ä¿¡æ¯
          console.log('ğŸ”„ å¼€å§‹æå–ç—…å²ä¿¡æ¯...');
          extractAndUpdateHistoryInfo(question, responseText);
          
          // æ›´æ–°é—®è¯Šè¿›åº¦
          window.updateQuestionCount();
          
          // å¦‚æœæœ‰ç³»ç»Ÿæç¤ºï¼Œä¹Ÿæ·»åŠ 
          if (response.data && response.data.hint) {
            setTimeout(() => {
              addChatMessage('system_hint', response.data.hint);
            }, 500);
          }
        } else {
          console.error('âŒ åç«¯è¿”å›å¤±è´¥:', response);
          addChatMessage('system_hint', 'æŠ±æ­‰ï¼Œæš‚æ—¶æ— æ³•å›ç­”æ‚¨çš„é—®é¢˜ã€‚');
        }
      },
      error: function(xhr, status, error) {
        hideTypingIndicator();
        console.error('èŠå¤©è¯·æ±‚å¤±è´¥:', error);
        addChatMessage('system_hint', 'ç½‘ç»œè¿æ¥å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•ã€‚');
      }
    });
  }
  
  function initializeChatWindow() {
    // æ·»åŠ åˆå§‹æ¬¢è¿æ¶ˆæ¯
    if (clinicalSession.chatMessages.length === 0) {
      addChatMessage('system_hint', 'æ¬¢è¿æ¥åˆ°é—®è¯Šç¯èŠ‚ï¼æ‚¨å¯ä»¥å‘æ‚£è€…è¯¢é—®ç—…å²ä¿¡æ¯ã€‚');
      addChatMessage('patient_response', 'åŒ»ç”Ÿæ‚¨å¥½ï¼Œæˆ‘æœ€è¿‘çœ¼éƒ¨æœ‰äº›ä¸é€‚ï¼Œå¸Œæœ›æ‚¨èƒ½å¸®æˆ‘çœ‹çœ‹ã€‚');
    }
    
    // æ›´æ–°èŠå¤©çŠ¶æ€
    updateChatStatus();
    
    // ç»‘å®šè¾“å…¥æ¡†äº‹ä»¶
    const chatInput = document.getElementById('patient-question-global');
    if (chatInput) {
      chatInput.addEventListener('input', updateCharCount);
    } else {
      console.warn('æœªæ‰¾åˆ°å…¨å±€èŠå¤©è¾“å…¥æ¡†å…ƒç´ ');
    }
  }
  
  // æå–å¹¶æ›´æ–°ç—…å²ä¿¡æ¯
  function extractAndUpdateHistoryInfo(question, response) {
    const questionLower = question.toLowerCase();
    
    console.log('ğŸ” æå–ç—…å²ä¿¡æ¯ - é—®é¢˜:', question);
    console.log('ğŸ” æå–ç—…å²ä¿¡æ¯ - å›ç­”:', response);
    
    // åˆå§‹åŒ–ç—…å²æ•°æ®å­˜å‚¨
    if (!clinicalSession.historyData) {
      clinicalSession.historyData = {
        chiefComplaint: null,
        presentIllness: null,
        pastHistory: null,
        familyHistory: null
      };
    }
    
    // ä¸»è¯‰è¯†åˆ« - æ‰©å±•å…³é”®è¯åŒ¹é…
    const chiefComplaintKeywords = ['ä¸»è¯‰', 'å“ªé‡Œä¸èˆ’æœ', 'ä¸èˆ’æœ', 'ä»€ä¹ˆé—®é¢˜', 'ç—‡çŠ¶', 
                                     'æ€ä¹ˆäº†', 'å“ªä¸èˆ’æœ', 'å“ªå„¿ä¸èˆ’æœ', 'ä»€ä¹ˆæ¯›ç—…', 
                                     'æ€ä¹ˆå›äº‹', 'ä¸é€‚', 'é—®é¢˜'];
    if (chiefComplaintKeywords.some(keyword => questionLower.includes(keyword)) && 
        !clinicalSession.historyData.chiefComplaint) {
      console.log('âœ… è¯†åˆ«åˆ°ä¸»è¯‰ä¿¡æ¯');
      clinicalSession.historyData.chiefComplaint = response;
      updateChiefComplaintDisplay(response);
    }
    
    // å®¶æ—å²è¯†åˆ«ï¼ˆä¼˜å…ˆçº§æœ€é«˜ï¼Œé¿å…è¢«"ç—…å²"å…³é”®è¯è¯¯åˆ¤ä¸ºæ—¢å¾€å²ï¼‰
    const familyHistoryKeywords = ['å®¶æ—', 'å®¶äºº', 'çˆ¶æ¯', 'é—ä¼ ', 'å®¶é‡Œ', 
                                  'äº²å±', 'å®¶åº­'];
    if (familyHistoryKeywords.some(k => questionLower.includes(k)) && 
        !clinicalSession.historyData.familyHistory) {
      console.log('âœ… è¯†åˆ«åˆ°å®¶æ—å²ä¿¡æ¯');
      clinicalSession.historyData.familyHistory = response;
      updateFamilyHistoryDisplay(response);
    }
    // æ—¢å¾€å²è¯†åˆ«
    else if (['æ—¢å¾€', 'ä»¥å‰', 'å¾—è¿‡', 'æœ‰æ²¡æœ‰', 'æ›¾ç»', 'ä¹‹å‰', 'å†å²', 'è¿‡å»'].some(k => questionLower.includes(k)) && 
        !clinicalSession.historyData.pastHistory) {
      console.log('âœ… è¯†åˆ«åˆ°æ—¢å¾€å²ä¿¡æ¯');
      clinicalSession.historyData.pastHistory = response;
      updatePastHistoryDisplay(response);
    }
    // æ—¢å¾€ç—…å²ï¼ˆåŒ…å«"ç—…å²"ä½†ä¸åŒ…å«"å®¶æ—"ï¼‰
    else if (questionLower.includes('ç—…å²') && !familyHistoryKeywords.some(k => questionLower.includes(k)) &&
        !clinicalSession.historyData.pastHistory) {
      console.log('âœ… è¯†åˆ«åˆ°æ—¢å¾€å²ä¿¡æ¯');
      clinicalSession.historyData.pastHistory = response;
      updatePastHistoryDisplay(response);
    }
    // ç°ç—…å²è¯†åˆ«ï¼ˆåŒ…æ‹¬æ—¶é—´ã€ç¨‹åº¦ã€è¯±å› ç­‰æ‰€æœ‰ç°ç—…å²ç›¸å…³é—®é¢˜ï¼‰
    else if (['å¤šé•¿æ—¶é—´', 'å¤šä¹…', 'ä»€ä¹ˆæ—¶å€™å¼€å§‹', 'ä»€ä¹ˆæ—¶å€™', 
              'å‡ å¤©', 'å‡ ä¸ªæœˆ', 'å‡ å¹´', 'å¼€å§‹', 'æŒç»­',
              'ä»€ä¹ˆæ ·', 'æ€ä¹ˆæ ·', 'æ€§è´¨', 'æ„Ÿè§‰', 'è¡¨ç°',
              'ä¸¥é‡', 'ç¨‹åº¦', 'å‰å®³', 'è½»å¾®', 
              'è¯±å› ', 'åŸå› ', 'ä¸ºä»€ä¹ˆ', 'å¼•èµ·', 'å¯¼è‡´',
              'ç°ç—…å²', 'ç—…æƒ…', 'å‘å±•', 'å˜åŒ–'].some(k => questionLower.includes(k)) && 
        !clinicalSession.historyData.presentIllness) {
      console.log('âœ… è¯†åˆ«åˆ°ç°ç—…å²ä¿¡æ¯');
      clinicalSession.historyData.presentIllness = response;
      updatePresentIllnessDisplay(response);
    }
  }
  
  // æ›´æ–°ä¸»è¯‰æ˜¾ç¤º
  function updateChiefComplaintDisplay(content) {
    console.log('ğŸ“ æ›´æ–°ä¸»è¯‰æ˜¾ç¤º:', content);
    const container = $('#chief-complaint-summary');
    console.log('ğŸ“ ä¸»è¯‰å®¹å™¨å…ƒç´ :', container.length > 0 ? 'æ‰¾åˆ°' : 'æœªæ‰¾åˆ°');
    
    if (container.length) {
      container.html(`
        <div class="alert alert-info mb-0">
          <i class="fas fa-quote-left me-2"></i>
          ${escapeHtml(content)}
        </div>
      `).addClass('has-info');
      console.log('âœ… ä¸»è¯‰æ˜¾ç¤ºå·²æ›´æ–°');
    } else {
      console.error('âŒ æœªæ‰¾åˆ°ä¸»è¯‰æ˜¾ç¤ºå®¹å™¨ #chief-complaint-summary');
    }
  }
  
  // æ›´æ–°ç°ç—…å²æ˜¾ç¤º
  function updatePresentIllnessDisplay(content) {
    console.log('ğŸ“ æ›´æ–°ç°ç—…å²æ˜¾ç¤º:', content);
    const container = $('#present-illness-summary');
    console.log('ğŸ“ ç°ç—…å²å®¹å™¨å…ƒç´ :', container.length > 0 ? 'æ‰¾åˆ°' : 'æœªæ‰¾åˆ°');
    
    if (container.length) {
      container.html(`
        <div class="alert alert-light mb-0" style="border-left: 4px solid #17a2b8;">
          <i class="fas fa-file-medical-alt me-2"></i>
          ${escapeHtml(content)}
        </div>
      `).addClass('has-info');
      console.log('âœ… ç°ç—…å²æ˜¾ç¤ºå·²æ›´æ–°');
    } else {
      console.error('âŒ æœªæ‰¾åˆ°ç°ç—…å²æ˜¾ç¤ºå®¹å™¨ #present-illness-summary');
    }
  }
  
  // æ›´æ–°æ—¢å¾€å²æ˜¾ç¤º
  function updatePastHistoryDisplay(content) {
    console.log('ğŸ“ æ›´æ–°æ—¢å¾€å²æ˜¾ç¤º:', content);
    const container = $('#past-history-summary');
    if (container.length) {
      container.html(`
        <div class="alert alert-secondary mb-0">
          <i class="fas fa-file-medical me-2"></i>
          ${escapeHtml(content)}
        </div>
      `).addClass('has-info');
    }
  }
  
  // æ›´æ–°å®¶æ—å²æ˜¾ç¤º
  function updateFamilyHistoryDisplay(content) {
    const container = $('#family-history-summary');
    if (container.length) {
      container.html(`
        <div class="alert alert-secondary mb-0">
          <i class="fas fa-users me-2"></i>
          ${escapeHtml(content)}
        </div>
      `).addClass('has-info');
    }
  }
  
  // ï¼ˆå·²ç»Ÿä¸€ä½¿ç”¨ window.updateQuestionCount / window.getAskedQuestionCountï¼Œé¿å…å±€éƒ¨åŒåå‡½æ•°å¯¼è‡´ç»Ÿè®¡ä¸ä¸€è‡´ï¼‰
  
  window.escapeHtml = function(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }
  
  // ==================== ç—…å²é˜¶æ®µï¼šä¸´åºŠæ¨ç†è®­ç»ƒ ====================
  
  function initializeHistoryStage() {
    clinicalSession.currentStage = 'case_presentation';
    syncStageToBackend('case_presentation');  // åŒæ­¥åˆ°åç«¯
    updateClinicalProgress();
    
    // è®°å½•å¼€å§‹æ—¶é—´
    clinicalSession.timeSpent.history = new Date();
    
    $('#btn-prev').prop('disabled', true);
    $('#btn-next').text('å¼€å§‹æ£€æŸ¥é€‰æ‹© â†’').removeClass('btn-secondary').addClass('btn-primary');
    
    // æ˜¾ç¤ºç—…å²é‡‡é›†ç‰¹æ®Šå¸ƒå±€
    showHistoryCollectionLayout();
    
    $.getJSON('/api/clinical/case/' + clinicalSession.caseId + '/', function(resp) {
      if (resp.success) {
        window.caseData = resp.data;
        
        // æ›´æ–°æ ‡é¢˜åŒºåŸŸçš„æ‚£è€…ä¿¡æ¯
        updatePatientInfoInHeader(resp.data);
        
        // ä¸å†æ¸²æŸ“ä¼ ç»Ÿçš„ç—…å²å†…å®¹ï¼Œå› ä¸ºç°åœ¨æ˜¯äº¤äº’å¼é—®è¯Š
        // renderPatientHistory(resp.data);
        
        // æ·»åŠ ä¸´åºŠæ€è€ƒæç¤º
        showClinicalThinkingPrompt('history');
      } else {
        showErrorMessage('åŠ è½½ç—…å²ä¿¡æ¯å¤±è´¥: ' + resp.message);
      }
    }).fail(function() {
      showErrorMessage('ç½‘ç»œé”™è¯¯ï¼Œè¯·æ£€æŸ¥è¿æ¥åé‡è¯•');
    });
  }
  
  function renderPatientHistory(data) {
    var html = '<div class="patient-history">';
    
    // ç›´æ¥å¼€å§‹ä¸»è¯‰ï¼Œæ‚£è€…åŸºæœ¬ä¿¡æ¯å·²åœ¨æ ‡é¢˜åŒºåŸŸæ˜¾ç¤º
    
    // ä¸»è¯‰å¡ç‰‡ - é‡æ–°è®¾è®¡
    html += '<div class="card mb-4 shadow-sm border-0">';
    html += '<div class="card-header border-0" style="background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%); border-radius: 12px 12px 0 0;">';
    html += '<div class="d-flex align-items-center justify-content-between">';
    html += '<h5 class="mb-0 text-white d-flex align-items-center" style="font-weight: 600; letter-spacing: 0.5px;">';
    html += '<i class="fas fa-exclamation-circle me-2" style="font-size: 1.2rem;"></i>';
    html += 'ä¸»è¯‰ <span style="font-size: 0.9rem; font-weight: 400; opacity: 0.8; margin-left: 8px;">Chief Complaint</span>';
    html += '</h5>';
    html += '</div>';
    html += '</div>';
    html += '<div class="card-body" style="padding: 1.5rem; background: #fff8f0;">';
    html += '<div class="chief-complaint-content">';
    html += '<blockquote class="blockquote text-center mb-0">';
    html += '<p class="mb-0" style="font-size: 1.1rem; color: #2c3e50; font-weight: 500; line-height: 1.6; font-style: italic;">"' + (data.clinical_info.chief_complaint || 'æ— è®°å½•') + '"</p>';
    html += '</blockquote>';
    html += '</div>';
    html += '</div>';
    html += '</div>';
    
    // ç°ç—…å²å¡ç‰‡ - é‡æ–°è®¾è®¡
    html += '<div class="card mb-4 shadow-sm border-0">';
    html += '<div class="card-header border-0" style="background: linear-gradient(135deg, #2980b9 0%, #3498db 100%); border-radius: 12px 12px 0 0;">';
    html += '<div class="d-flex align-items-center justify-content-between">';
    html += '<h5 class="mb-0 text-white d-flex align-items-center" style="font-weight: 600; letter-spacing: 0.5px;">';
    html += '<i class="fas fa-clipboard-list me-2" style="font-size: 1.2rem;"></i>';
    html += 'ç°ç—…å² <span style="font-size: 0.9rem; font-weight: 400; opacity: 0.8; margin-left: 8px;">History of Present Illness</span>';
    html += '</h5>';
    html += '</div>';
    html += '</div>';
    html += '<div class="card-body" style="padding: 1.5rem; background: #f0f8ff;">';
    html += '<div class="present-illness-content" style="line-height: 1.8; font-size: 1rem; color: #2c3e50;">';
    
    var presentIllness = data.clinical_info.present_illness || data.clinical_info.history_of_present_illness || 'æ— è®°å½•';
    
    html += '<div class="illness-timeline">';
    html += formatMedicalHistory(presentIllness);
    html += '</div>';
    
    html += '</div>';
    html += '</div>';
    html += '</div>';
    
    // æ—¢å¾€å²ã€ä¸ªäººå²ã€å®¶æ—å² - æŒ‰æ ‡å‡†åŒ»å­¦ç—…å²æ ¼å¼æ’åˆ—
    html += '<div class="medical-history-sections">';
    
    // æ—¢å¾€å²
    if (data.clinical_info.past_history || data.clinical_info.past_medical_history) {
      html += '<div class="card mb-4 shadow-sm border-0">';
      html += '<div class="card-header border-0" style="background: linear-gradient(135deg, #27ae60 0%, #2ecc71 100%); border-radius: 12px 12px 0 0;">';
      html += '<div class="d-flex align-items-center justify-content-between">';
      html += '<h5 class="mb-0 text-white d-flex align-items-center" style="font-weight: 600; letter-spacing: 0.5px;">';
      html += '<i class="fas fa-history me-2" style="font-size: 1.2rem;"></i>';
      html += 'æ—¢å¾€å² <span style="font-size: 0.9rem; font-weight: 400; opacity: 0.8; margin-left: 8px;">Past Medical History</span>';
      html += '</h5>';
      html += '</div>';
      html += '</div>';
      html += '<div class="card-body" style="padding: 1.5rem; background: #f8fff8;">';
      var pastHistory = data.clinical_info.past_history || data.clinical_info.past_medical_history || 'æ— ç‰¹æ®Šæ—¢å¾€å²';
      html += '<p class="mb-0" style="line-height: 1.6; color: #2c3e50; font-size: 1rem;">' + formatMedicalHistory(pastHistory) + '</p>';
      html += '</div>';
      html += '</div>';
    }
    
    // ä¸ªäººå²
    if (data.clinical_info.personal_history || data.clinical_info.social_history) {
      html += '<div class="card mb-4 shadow-sm border-0">';
      html += '<div class="card-header border-0" style="background: linear-gradient(135deg, #8e44ad 0%, #9b59b6 100%); border-radius: 12px 12px 0 0;">';
      html += '<div class="d-flex align-items-center justify-content-between">';
      html += '<h5 class="mb-0 text-white d-flex align-items-center" style="font-weight: 600; letter-spacing: 0.5px;">';
      html += '<i class="fas fa-user-cog me-2" style="font-size: 1.2rem;"></i>';
      html += 'ä¸ªäººå² <span style="font-size: 0.9rem; font-weight: 400; opacity: 0.8; margin-left: 8px;">Personal & Social History</span>';
      html += '</h5>';
      html += '</div>';
      html += '</div>';
      html += '<div class="card-body" style="padding: 1.5rem; background: #faf8ff;">';
      var personalHistory = data.clinical_info.personal_history || data.clinical_info.social_history || 'æ— ç‰¹æ®Šä¸ªäººå²è®°å½•';
      html += '<p class="mb-0" style="line-height: 1.6; color: #2c3e50; font-size: 1rem;">' + formatMedicalHistory(personalHistory) + '</p>';
      html += '</div>';
      html += '</div>';
    }
    
    // å®¶æ—å²
    if (data.clinical_info.family_history) {
      html += '<div class="card mb-4 shadow-sm border-0">';
      html += '<div class="card-header border-0" style="background: linear-gradient(135deg, #e67e22 0%, #f39c12 100%); border-radius: 12px 12px 0 0;">';
      html += '<div class="d-flex align-items-center justify-content-between">';
      html += '<h5 class="mb-0 text-white d-flex align-items-center" style="font-weight: 600; letter-spacing: 0.5px;">';
      html += '<i class="fas fa-users me-2" style="font-size: 1.2rem;"></i>';
      html += 'å®¶æ—å² <span style="font-size: 0.9rem; font-weight: 400; opacity: 0.8; margin-left: 8px;">Family History</span>';
      html += '</h5>';
      html += '</div>';
      html += '</div>';
      html += '<div class="card-body" style="padding: 1.5rem; background: #fffaf0;">';
      html += '<p class="mb-0" style="line-height: 1.6; color: #2c3e50; font-size: 1rem;">' + formatMedicalHistory(data.clinical_info.family_history) + '</p>';
      html += '</div>';
      html += '</div>';
    }
    
    html += '</div>';
    
    html += '</div>';
    $('#stage-content').html(html);
  }
  
  function formatMedicalHistory(text) {
    // æ ¼å¼åŒ–ç—…å²æ–‡æœ¬ï¼Œçªå‡ºå…³é”®ä¿¡æ¯å¹¶æ”¹å–„å¯è¯»æ€§
    var formatted = text
      // æ—¶é—´æ ‡è®°
      .replace(/(\d+[å¤©æœˆå¹´å‘¨])/g, '<span class="time-marker" style="background: linear-gradient(135deg, #3498db, #2980b9); color: white; padding: 2px 8px; border-radius: 12px; font-size: 0.85rem; font-weight: 500; margin: 0 2px;">$1</span>')
      // ç—‡çŠ¶å…³é”®è¯
      .replace(/(ç–¼ç—›|ä¸é€‚|æ¨¡ç³Š|ä¸‹é™|å‡ºè¡€|çº¢è‚¿|ç˜™ç—’|å¹²æ¶©|æµæ³ª|ç•å…‰|å¤è§†|é»‘å½±|é—ªå…‰)/g, '<span class="symptom-highlight" style="background: #ffe6e6; color: #c0392b; padding: 1px 4px; border-radius: 4px; font-weight: 600; border-left: 3px solid #e74c3c;">$1</span>')
      // å¦å®šè¯æ±‡
      .replace(/(æ— |å¦è®¤|æœªè§|æ­£å¸¸|é˜´æ€§)/g, '<span class="negative-finding" style="background: #e8f5e8; color: #27ae60; padding: 1px 4px; border-radius: 4px; font-weight: 500;">$1</span>')
      // ç¨‹åº¦è¯æ±‡
      .replace(/(è½»åº¦|ä¸­åº¦|é‡åº¦|ä¸¥é‡|æ˜æ˜¾|æ˜¾è‘—)/g, '<span class="severity-marker" style="background: #fff3cd; color: #856404; padding: 1px 4px; border-radius: 4px; font-weight: 500;">$1</span>');
    
    // å°†æ–‡æœ¬åˆ†æ®µå¹¶æ·»åŠ é€‚å½“çš„é—´è·
    return '<div class="formatted-history">' + formatted.replace(/ã€‚/g, 'ã€‚<br style="margin-bottom: 8px;">') + '</div>';
  }
  

  


  
  // ==================== æ£€æŸ¥é˜¶æ®µï¼šå¾ªè¯åŒ»å­¦æŒ‡å¯¼ ====================
  
  function loadExaminationStage() {
    clinicalSession.currentStage = 'examination_selection';
    syncStageToBackend('examination_selection');  // åŒæ­¥åˆ°åç«¯
    updateClinicalProgress();
    updateStageProgress();
    
    $('#btn-prev').prop('disabled', false);
    $('#btn-next').prop('disabled', false).text('ç¡®è®¤æ£€æŸ¥é€‰æ‹© â†’').removeClass('btn-secondary').addClass('btn-warning');
    updateStageCard('æ£€æŸ¥é€‰æ‹©é˜¶æ®µ', 'examination');
    
    $.getJSON('/api/clinical/case/' + clinicalSession.caseId + '/examinations/', function(resp) {
      if (resp.success) {
        // å­˜å‚¨æ£€æŸ¥é€‰é¡¹ç»Ÿè®¡ä¿¡æ¯
        clinicalSession.examinationStats = {
          totalCount: resp.data.total_count || 0,
          requiredCount: resp.data.required_count || 0,
          distractorCount: resp.data.distractor_count || 0,
          mode: resp.data.mode || 'standard'
        };
        
        renderExaminationOptions(resp.data.examination_options || []);
        addExaminationGuidance();
        showClinicalThinkingPrompt('examination');
        
        // æ˜¾ç¤ºæ£€æŸ¥é€‰é¡¹ç»Ÿè®¡ä¿¡æ¯
        showExaminationStats();
        
        // åˆå§‹åŒ–æ£€æŸ¥é€‰æ‹©é¡ºåºæ•°ç»„
        clinicalSession.examinationOrder = [];
        clinicalSession.isExaminationConfirmed = false;
        clinicalSession.currentExaminationIndex = 0;
        
        console.log('æ£€æŸ¥é€‰é¡¹åŠ è½½æˆåŠŸ:', clinicalSession.examinationStats);
      } else {
        showErrorMessage('åŠ è½½æ£€æŸ¥é€‰é¡¹å¤±è´¥: ' + resp.message);
      }
    }).fail(function() {
      showErrorMessage('ç½‘ç»œé”™è¯¯ï¼Œè¯·æ£€æŸ¥è¿æ¥åé‡è¯•');
    });
  }
  
  function clearExaminationErrors() {
    /**
     * æ¸…é™¤æ£€æŸ¥é€‰æ‹©çš„é”™è¯¯çŠ¶æ€å’Œé«˜äº®
     */
    // æ¸…é™¤é”™è¯¯é«˜äº®
    $('.examination-option').removeClass('error-missing error-extra');
    
    // æ¸…é™¤åé¦ˆé¢æ¿ä¸­çš„é”™è¯¯ä¿¡æ¯
    const feedbackPanel = $('#feedback-panel');
    if (feedbackPanel.find('.examination-validation-error').length > 0) {
      feedbackPanel.html('<div class="alert alert-secondary"><i class="fas fa-info-circle me-2"></i>ç­‰å¾…æ£€æŸ¥é€‰æ‹©...</div>');
    }
  }
  
  function renderExaminationOptions(options) {
    // æ¸…é™¤ä¹‹å‰çš„é”™è¯¯çŠ¶æ€
    clearExaminationErrors();
    
    var html = '<div class="examination-selection">';
    
    // æ£€æŸ¥é€‰æ‹©è¯´æ˜
    html += '<div class="alert alert-info" style="background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%); border: none; border-radius: 12px; padding: 20px; margin-bottom: 15px;">';
    html += '<h4 class="mb-3" style="color: #1565c0; font-weight: 700; display: flex; align-items: center;">';
    html += '<i class="fas fa-lightbulb me-2" style="font-size: 1.2rem; color: #ffa726;"></i>æ£€æŸ¥é€‰æ‹©æŒ‡å¯¼';
    html += '</h4>';
    html += '<p class="mb-2" style="font-size: 1rem; line-height: 1.6; color: #424242;">è¯·é€‰æ‹©æ‚¨è®¤ä¸ºæœ‰åŠ©äºè¯Šæ–­çš„æ£€æŸ¥é¡¹ç›®ï¼Œç„¶åå®‰æ’æ£€æŸ¥é¡ºåºã€‚</p>';
    html += '<p class="mb-0" style="font-size: 0.9rem; line-height: 1.6; color: #424242;"><strong>æç¤ºï¼š</strong>é€‰æ‹©æ£€æŸ¥é¡¹ç›®åï¼Œå¯ä»¥æ‹–æ‹½è°ƒæ•´æ£€æŸ¥é¡ºåºï¼Œç³»ç»Ÿå°†æŒ‰é¡ºåºé€ä¸€å±•ç¤ºæ£€æŸ¥ç»“æœã€‚</p>';
    html += '</div>';
    
    // æ£€æŸ¥é€‰é¡¹ç»Ÿè®¡ä¿¡æ¯ï¼ˆä»…åœ¨æ··åˆæ¨¡å¼ä¸‹æ˜¾ç¤ºï¼‰
    if (clinicalSession.examinationStats && clinicalSession.examinationStats.mode === 'mixed') {
      html += '<div id="examination-stats" class="alert alert-secondary" style="background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); border: none; border-radius: 10px; padding: 15px; margin-bottom: 15px;">';
      html += '<div class="d-flex align-items-center justify-content-center">';
      html += '<i class="fas fa-info-circle me-2" style="color: #6c757d; font-size: 1.1rem;"></i>';
      html += '<span style="font-size: 0.95rem; color: #495057; font-weight: 500;">æœ¬æ¬¡å…±æä¾› <strong>' + clinicalSession.examinationStats.totalCount + '</strong> é¡¹æ£€æŸ¥é€‰æ‹©ï¼ŒåŒ…å«æ•™å­¦é‡ç‚¹å’Œè¾…åŠ©é€‰é¡¹</span>';
      html += '</div>';
      html += '</div>';
    }
    



    
    // æŒ‰ç±»å‹åˆ†ç»„æ˜¾ç¤ºæ£€æŸ¥é€‰é¡¹
    var groupedOptions = groupExaminationsByType(options);
    
    Object.keys(groupedOptions).forEach(function(type) {
      var typeOptions = groupedOptions[type];
      var typeDisplayName = getExaminationTypeDisplay(type);
      var typeIcon = getExaminationTypeIcon(type);
      
      html += '<div class="examination-group mb-4">';
      html += '<h4 class="text-primary mb-3" style="font-weight: 700; display: flex; align-items: center;">';
      html += '<i class="' + typeIcon + ' me-2" style="font-size: 1.3rem;"></i>' + typeDisplayName;
      html += '<span class="text-muted ms-2" style="font-size: 1rem; font-weight: 500;">(' + typeOptions.length + 'é¡¹)</span>';
      html += '</h4>';
      
      html += '<div class="row">';
      typeOptions.forEach(function(option) {
        var imagesAttr = (option.images && option.images.length) ? JSON.stringify(option.images) : '[]';
        var isRequiredAttr = option.is_required ? 1 : 0;
        var allowMultipleAttr = option.is_multiple_choice ? 1 : 0;
        html += '<div class="col-md-6 mb-3">';
        var cardClass = 'card examination-option h-100';
        html += '<div class="' + cardClass + '" data-exam-id="' + option.id + '" data-images=\'' + imagesAttr + '\' data-is-required="' + isRequiredAttr + '" data-allow-multiple="' + allowMultipleAttr + '">';
        html += '<div class="card-body">';
        
        html += '<div class="form-check">';
        html += '<div class="d-flex align-items-center mb-2">';
        html += '<input class="form-check-input examination-checkbox me-3" type="checkbox" ';
        html += 'value="' + option.id + '" id="exam_' + option.id + '" data-is-recommended="' + (option.is_recommended ? '1' : '0') + '" data-is-fundus="' + ((option.type && option.type.toLowerCase().indexOf('çœ¼åº•') !== -1) ? '1' : '0') + '" data-is-required="' + isRequiredAttr + '" data-allow-multiple="' + allowMultipleAttr + '" style="width: 18px; height: 18px; flex-shrink: 0;">';
        html += '<label class="form-check-label flex-grow-1 mb-0" for="exam_' + option.id + '">';
        html += '<strong style="font-size: 1.1rem; color: #2c3e50;">' + option.name + '</strong>';
        html += '</label>';
        html += '</div>';
        
        // ç§»é™¤æ£€æŸ¥ç‰¹æ€§æ ‡ç­¾ï¼Œé¿å…ç»™å­¦ç”Ÿéšæ€§æç¤º
        // html += '<div class="examination-badges d-flex gap-1">';
        // if (option.is_recommended) {
        //   html += '<span class="badge bg-success text-white" style="font-size: 0.8rem;">æ¨è</span>';
        // }
        // if (option.diagnostic_value && option.diagnostic_value.toLowerCase().indexOf('é«˜') !== -1) {
        //   html += '<span class="badge bg-warning text-dark" style="font-size: 0.8rem;"><i class="fas fa-star me-1"></i>é«˜ä»·å€¼</span>';
        // }
        // html += '</div>';
        
        html += '<div class="text-muted small mt-2 ms-0">' + (option.description || '') + '</div>';
        
        // æ˜¾ç¤ºé£é™©å’Œæˆæœ¬ä¿¡æ¯
        html += '<div class="examination-info mt-2 ms-0">';
        html += '<div class="row small text-muted">';
        html += '<div class="col-6">é£é™©: ' + (option.risk_level || 'ä½') + '</div>';
        html += '<div class="col-6">è´¹ç”¨: Â¥' + (option.cost || 50) + '</div>';
        html += '</div>';
        html += '</div>';
        
        html += '</div>';
        html += '</div>';
        html += '</div>';
        html += '</div>';
      });
      html += '</div>';
      html += '</div>';
    });
    
    // æ£€æŸ¥é¡ºåºå®‰æ’åŒºåŸŸ
    html += '<div class="examination-order-section mt-4" id="examination-order-section" style="display: none;">';
    html += '<h5 class="mb-3" style="background: linear-gradient(135deg, #1976d2, #42a5f5); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; font-weight: bold; font-size: 1.3rem;"><i class="fas fa-sort" style="color: #1976d2; margin-right: 8px;"></i> å®‰æ’æ£€æŸ¥é¡ºåº</h5>';
    html += '<div class="alert alert-info" style="background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%); border: 2px solid #2196f3; border-radius: 10px;">';
    html += '<i class="fas fa-hand-rock" style="color: #1976d2; margin-right: 8px;"></i> <strong>è¯·æ‹–æ‹½ä¸‹æ–¹çš„æ£€æŸ¥é¡¹ç›®è°ƒæ•´æ£€æŸ¥é¡ºåº</strong>ï¼Œç³»ç»Ÿå°†æŒ‰é¡ºåºé€ä¸€å±•ç¤ºæ£€æŸ¥ç»“æœã€‚';
    html += '<br><small class="text-muted mt-1 d-block"><i class="fas fa-lightbulb"></i> æç¤ºï¼šæŠ“ä½ <i class="fas fa-grip-vertical" style="color: #1976d2;"></i> å›¾æ ‡æ‹–åŠ¨é¡¹ç›®æ¥æ”¹å˜é¡ºåº</small>';
    html += '</div>';
    html += '<div id="examination-order-list" class="examination-order-list">';
    html += '<!-- æ£€æŸ¥é¡¹ç›®æ’åºåŒºåŸŸ -->';
    html += '</div>';
    html += '</div>';
    
    html += '</div>';
    
    // æ·»åŠ é€‰æ‹©ç»Ÿè®¡ - æ”¹è¿›å¸ƒå±€
    html += '<div class="examination-summary mt-4">';
    html += '<div class="card bg-light">';
    html += '<div class="card-body text-center">';
    
    // æ ‡é¢˜ç‹¬ç«‹ä¸€è¡Œ
    html += '<h5 class="mb-4" style="color: #2c3e50; font-weight: 600;">';
    html += '<i class="fas fa-calculator me-2"></i>é€‰æ‹©ç»Ÿè®¡';
    html += '</h5>';
    
    // ç»Ÿè®¡é¡¹ç›®ï¼šä½¿ç”¨inline-blockç¡®ä¿æ°´å¹³å¸ƒå±€
    html += '<div style="text-align: center;">';
    
    // æ ‡ç­¾è¡Œ
    html += '<div style="margin-bottom: 10px;">';
    html += '<span style="display: inline-block; width: 120px; text-align: center; font-size: 0.9rem; font-weight: 500;" class="text-muted">å·²é€‰æ£€æŸ¥</span>';
    html += '<span style="display: inline-block; width: 40px;"></span>'; // é—´è·
    html += '<span style="display: inline-block; width: 120px; text-align: center; font-size: 0.9rem; font-weight: 500;" class="text-muted">æ€»è´¹ç”¨</span>';
    html += '</div>';
    
    // æ•°å€¼è¡Œ
    html += '<div>';
    html += '<span style="display: inline-block; width: 120px; text-align: center;" class="h3 mb-0 text-primary fw-bold" id="selected-count">0</span>';
    html += '<span style="display: inline-block; width: 40px;"></span>'; // é—´è·
    html += '<span style="display: inline-block; width: 120px; text-align: center;" class="h3 mb-0 text-success fw-bold" id="total-cost">Â¥0</span>';
    html += '</div>';
    
    html += '</div>';
    html += '</div>';
    html += '</div>';
    html += '</div>';
    
    $('#stage-content').html(html);
    
    // ç»‘å®šæ£€æŸ¥é€‰æ‹©äº‹ä»¶
    bindExaminationEvents();
    
    // åˆå§‹åŒ–æ‹–æ‹½æ’åºåŠŸèƒ½
    initializeExaminationOrderSorting();
    
    // ç¡®ä¿æŒ‰é’®çŠ¶æ€æ­£ç¡® - æ£€æŸ¥é˜¶æ®µæŒ‰é’®åº”å§‹ç»ˆå¯ç”¨
    setTimeout(function() {
      ensureButtonEnabled();
    }, 100);
  }
  
  function groupExaminationsByType(options) {
    var grouped = {};
    options.forEach(function(option) {
      var type = option.examination_type || 'basic';
      if (!grouped[type]) {
        grouped[type] = [];
      }
      grouped[type].push(option);
    });
    return grouped;
  }
  
  function getExaminationTypeDisplay(type) {
    var displays = {
      'basic': 'åŸºç¡€æ£€æŸ¥',
      'imaging': 'å½±åƒå­¦æ£€æŸ¥', 
      'laboratory': 'å®éªŒå®¤æ£€æŸ¥',
      'special': 'ç‰¹æ®Šæ£€æŸ¥'
    };
    return displays[type] || type;
  }
  
  function getExaminationTypeIcon(type) {
    var icons = {
      'basic': 'fas fa-stethoscope',
      'imaging': 'fas fa-x-ray',
      'laboratory': 'fas fa-flask',
      'special': 'fas fa-microscope'
    };
    return icons[type] || 'fas fa-medical-kit';
  }
  
  function getRiskLevelDisplay(level) {
    var displays = {
      'low': '<span class="text-success">ä½</span>',
      'medium': '<span class="text-warning">ä¸­</span>',
      'high': '<span class="text-danger">é«˜</span>'
    };
    return displays[level] || level;
  }
  
  function bindExaminationEvents() {
    $('.examination-checkbox').off('change').on('change', function() {
      var $card = $(this).closest('.examination-option');
      var examId = parseInt($(this).val());
      var isChecked = $(this).is(':checked');
      var isFundus = $(this).data('is-fundus') == 1;

      if (isChecked) {
        $card.addClass('selected');
        if (clinicalSession.selectedExaminations.indexOf(examId) === -1) {
          clinicalSession.selectedExaminations.push(examId);
        }
        addToLearningTimeline('é€‰æ‹©æ£€æŸ¥', $card.find('strong').text());
      } else {
        $card.removeClass('selected');
        var index = clinicalSession.selectedExaminations.indexOf(examId);
        if (index > -1) {
          clinicalSession.selectedExaminations.splice(index, 1);
        }
      }

      updateExaminationSummary();
      updateExaminationOrderList();
      provideLiveExaminationFeedback();
    });
    
    $('.examination-option').on('click', function(e) {
      if (e.target.type !== 'checkbox') {
        var checkbox = $(this).find('.examination-checkbox');
        checkbox.prop('checked', !checkbox.prop('checked')).trigger('change');
      }
    });
  }
  
  function updateExaminationOrderList() {
    var $orderSection = $('#examination-order-section');
    var $orderList = $('#examination-order-list');
    
    if (clinicalSession.selectedExaminations.length === 0) {
      $orderSection.hide();
      return;
    }
    
    $orderSection.show();
    
    var html = '';
    clinicalSession.selectedExaminations.forEach(function(examId, index) {
      var $examCard = $('.examination-option[data-exam-id="' + examId + '"]');
      var examName = $examCard.find('strong').text();
      var isRequired = $examCard.data('is-required');
      
      html += '<div class="examination-order-item" data-exam-id="' + examId + '" draggable="true">';
      html += '<div class="d-flex align-items-center justify-content-between p-3 mb-2 border rounded position-relative">';
      html += '<div class="d-flex align-items-center">';
      html += '<i class="fas fa-grip-vertical me-3" style="cursor: grab;" title="æ‹–æ‹½è°ƒæ•´é¡ºåº"></i>';
      html += '<span class="order-number badge me-3" style="background: linear-gradient(135deg, #1976d2, #42a5f5); color: white; font-size: 0.9rem; padding: 8px 12px; border-radius: 50%; min-width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; box-shadow: 0 2px 8px rgba(25, 118, 210, 0.3);">' + (index + 1) + '</span>';
      html += '<div class="exam-info">';
      html += '<span class="exam-name fw-bold d-block" style="color: #0d47a1; font-size: 1rem;">' + examName + '</span>';
      html += '<small class="text-muted"><i class="fas fa-hand-rock"></i> å¯æ‹–æ‹½æ’åº</small>';
      html += '</div>';

      html += '</div>';
      html += '<button class="btn btn-sm btn-outline-danger remove-exam-btn" data-exam-id="' + examId + '" title="ç§»é™¤æ­¤é¡¹æ£€æŸ¥">';
      html += '<i class="fas fa-times"></i>';
      html += '</button>';
      html += '</div>';
      html += '</div>';
    });
    
    // å¦‚æœæ²¡æœ‰é€‰ä¸­ä»»ä½•é¡¹ç›®ï¼Œæ˜¾ç¤ºç©ºæç¤º
    if (clinicalSession.selectedExaminations.length === 0) {
      html += '<div class="empty-drag-area text-center py-4" style="background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); border: 2px dashed #ced4da; border-radius: 10px; color: #6c757d;">';
      html += '<i class="fas fa-mouse-pointer fa-2x mb-2" style="color: #adb5bd;"></i>';
      html += '<p class="mb-0">é€‰ä¸­çš„æ£€æŸ¥é¡¹ç›®å°†åœ¨è¿™é‡Œæ˜¾ç¤ºï¼Œå¯æ‹–æ‹½æ’åº</p>';
      html += '<small class="text-muted">è¯·å…ˆä»ä¸Šæ–¹é€‰æ‹©æ£€æŸ¥é¡¹ç›®</small>';
      html += '</div>';
    }
    
    $orderList.html(html);
    
    // ç»‘å®šç§»é™¤æŒ‰é’®äº‹ä»¶
    $('.remove-exam-btn').on('click', function() {
      var examId = parseInt($(this).data('exam-id'));
      var $checkbox = $('.examination-checkbox[value="' + examId + '"]');
      $checkbox.prop('checked', false).trigger('change');
    });
    
    // é‡æ–°åˆå§‹åŒ–æ‹–æ‹½æ’åº
    initializeExaminationOrderSorting();
  }
  
  function initializeExaminationOrderSorting() {
    var $orderList = $('#examination-order-list');
    
    if (!$orderList.length) return;
    
    // ç®€å•çš„æ‹–æ‹½æ’åºå®ç°ï¼ˆä¸ä¾èµ–å¤–éƒ¨åº“ï¼‰
    var draggedItem = null;
    
    $orderList.off('dragstart dragover drop dragend');
    
    $orderList.on('dragstart', '.examination-order-item', function(e) {
      draggedItem = this;
      $(this).addClass('dragging');
      $('.examination-order-item').not(this).addClass('drop-target');
      $('#examination-order-list').addClass('drag-active');
      e.originalEvent.dataTransfer.effectAllowed = 'move';
    });
    
    $orderList.on('dragover', '.examination-order-item', function(e) {
      e.preventDefault();
      e.originalEvent.dataTransfer.dropEffect = 'move';
      
      var $this = $(this);
      $('.examination-order-item').removeClass('drag-hover');
      
      if (this !== draggedItem) {
        $this.addClass('drag-hover');
        var draggedRect = draggedItem.getBoundingClientRect();
        var targetRect = this.getBoundingClientRect();
        
        if (e.originalEvent.clientY < targetRect.top + targetRect.height / 2) {
          $this.before(draggedItem);
        } else {
          $this.after(draggedItem);
        }
      }
    });
    
    $orderList.on('dragleave', '.examination-order-item', function(e) {
      $(this).removeClass('drag-hover');
    });
    
    $orderList.on('dragend', '.examination-order-item', function(e) {
      $(this).removeClass('dragging');
      $('.examination-order-item').removeClass('drop-target drag-hover');
      $('#examination-order-list').removeClass('drag-active');
      draggedItem = null;
      
      // æ›´æ–°æ£€æŸ¥é¡ºåº
      updateExaminationOrder();
    });
    
    $orderList.on('drop', function(e) {
      e.preventDefault();
    });
  }
  
  function updateExaminationOrder() {
    var newOrder = [];
    $('#examination-order-list .examination-order-item').each(function(index) {
      var examId = parseInt($(this).data('exam-id'));
      newOrder.push(examId);
      
      // æ›´æ–°é¡ºåºå·æ˜¾ç¤º
      $(this).find('.order-number').text(index + 1);
    });
    
    clinicalSession.selectedExaminations = newOrder;
    clinicalSession.examinationOrder = newOrder;
  }

  function confirmExaminationSelection() {
    // åŸºç¡€éªŒè¯ï¼šç¡®ä¿è‡³å°‘é€‰æ‹©äº†ä¸€é¡¹æ£€æŸ¥
    if (clinicalSession.selectedExaminations.length === 0) {
      showFeedbackMessage('è¯·è‡³å°‘é€‰æ‹©ä¸€é¡¹æ£€æŸ¥', 'warning');
      return;
    }
    
    // æ¸…é™¤ä¹‹å‰çš„é”™è¯¯çŠ¶æ€
    clearExaminationErrors();

    // æ˜¾ç¤ºç¡®è®¤ä¸­çŠ¶æ€
    $('#btn-next').prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i> ç¡®è®¤ä¸­...');
    showFeedbackMessage('æ­£åœ¨ç¡®è®¤æ£€æŸ¥é€‰æ‹©...', 'info');

    // å‡†å¤‡æäº¤æ•°æ®
    var submitData = {
      case_id: clinicalSession.caseId,
      selected_examinations: clinicalSession.selectedExaminations,
      examination_order: clinicalSession.examinationOrder || clinicalSession.selectedExaminations
    };

    $.ajax({
      url: '/api/clinical/confirm-examination-selection/',
      method: 'POST',
      contentType: 'application/json',
      headers: {
        'X-CSRFToken': $('[name=csrfmiddlewaretoken]').val() || getCsrfToken()
      },
      data: JSON.stringify(submitData),
      success: function(resp) {
        if (resp.success) {
          // æ ‡è®°æ£€æŸ¥å·²ç¡®è®¤
          clinicalSession.isExaminationConfirmed = true;
          clinicalSession.examinationOrder = resp.data.examination_order;
          clinicalSession.currentExaminationIndex = 0;
          
          // æ›´æ–°æŒ‰é’®çŠ¶æ€
          $('#btn-next').prop('disabled', false).html('æŸ¥çœ‹æ£€æŸ¥ç»“æœ <i class="fas fa-arrow-right"></i>');
          
          // æ˜¾ç¤ºç¡®è®¤æˆåŠŸç•Œé¢
          showExaminationConfirmedInterface();
          
          // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯ï¼ŒåŒ…å«å°è¯•æ¬¡æ•°ä¿¡æ¯
          var successMessage = resp.data.message || resp.message;
          
          // ä¸å†åœ¨æˆåŠŸæ¶ˆæ¯ä¸­æ˜¾ç¤ºæ‰£åˆ†ä¿¡æ¯ï¼Œå› ä¸ºå®¹æ˜“é€ æˆè¯¯è§£
          // æ‰£åˆ†ä¿¡æ¯åº”è¯¥åªåœ¨é”™è¯¯æ—¶æ˜¾ç¤ºï¼ŒæˆåŠŸæ—¶åªæ˜¾ç¤ºé¼“åŠ±ä¿¡æ¯
          
          showFeedbackMessage(successMessage, 'success');
          
          // è®°å½•åˆ°æ—¶é—´çº¿
          addToLearningTimeline('ç¡®è®¤æ£€æŸ¥é€‰æ‹©', 'å…±é€‰æ‹© ' + clinicalSession.selectedExaminations.length + ' é¡¹æ£€æŸ¥');
        } else {
          $('#btn-next').prop('disabled', false).html('ç¡®è®¤æ£€æŸ¥é€‰æ‹© â†’');
          showFeedbackMessage('ç¡®è®¤å¤±è´¥: ' + resp.message, 'danger');
        }
      },
      error: function(xhr, status, error) {
        $('#btn-next').prop('disabled', false).html('ç¡®è®¤æ£€æŸ¥é€‰æ‹© â†’');
        
        // å¤„ç†éªŒè¯é”™è¯¯ï¼ˆ400çŠ¶æ€ç ï¼‰
        if (xhr.status === 400) {
          try {
            var errorResp = JSON.parse(xhr.responseText);
            if (errorResp.error_details) {
              showExaminationValidationError(errorResp);
            } else {
              showFeedbackMessage('éªŒè¯å¤±è´¥: ' + errorResp.message, 'warning');
            }
          } catch (e) {
            showFeedbackMessage('è¯·æ±‚å¤±è´¥ï¼Œè¯·é‡è¯•', 'danger');
          }
        } else {
          console.error('Confirm examination error:', error, xhr.responseText);
          showFeedbackMessage('ç½‘ç»œé”™è¯¯ï¼Œè¯·æ£€æŸ¥è¿æ¥: ' + error, 'danger');
        }
      }
    });
  }
  
  function showExaminationValidationError(errorResponse) {
    var details = errorResponse.error_details;
    var message = errorResponse.message;
    
    // åˆ›å»ºè¯¦ç»†çš„é”™è¯¯æç¤ºç•Œé¢
    var html = '<div class="examination-validation-error">';
    
    // ä¸»è¦é”™è¯¯æç¤º
    html += '<div class="alert alert-danger" style="background: linear-gradient(135deg, #f8d7da 0%, #f5c6cb 100%); border: none; border-radius: 12px; padding: 20px; margin-bottom: 20px;">';
    html += '<h4 class="mb-3" style="color: #721c24; font-weight: 700; display: flex; align-items: center;">';
    html += '<i class="fas fa-exclamation-triangle me-2" style="font-size: 1.2rem; color: #dc3545;"></i>æ£€æŸ¥é€‰æ‹©éªŒè¯å¤±è´¥';
    html += '</h4>';
    html += '<p class="mb-2" style="font-size: 1rem; line-height: 1.6; color: #721c24;">' + message + '</p>';
    
    // æ˜¾ç¤ºå°è¯•æ¬¡æ•°å’Œæƒ©ç½šä¿¡æ¯
    if (details.attempt_count) {
      html += '<div class="mt-3 p-3" style="background: rgba(220, 53, 69, 0.1); border-radius: 8px;">';
      html += '<small class="text-danger"><strong>ç¬¬ ' + details.attempt_count + ' æ¬¡å°è¯•å¤±è´¥</strong></small>';
      if (details.penalty_applied > 0) {
        html += '<br><small class="text-danger">æœ¬æ¬¡é”™è¯¯å°†æ‰£é™¤ ' + details.penalty_applied + ' åˆ†</small>';
      }
      html += '</div>';
    }
    html += '</div>';
    
    // é”™è¯¯ç±»å‹åˆ†æå¡ç‰‡ï¼ˆä¸æ˜¾ç¤ºå…·ä½“é¡¹ç›®åç§°ï¼‰
    if (details.missing_required && details.missing_required.length > 0) {
      html += '<div class="card mb-3" style="border: 2px solid #17a2b8; border-radius: 10px;">';
      html += '<div class="card-header bg-info text-white" style="border-radius: 8px 8px 0 0;">';
      html += '<h6 class="mb-0"><i class="fas fa-search me-2"></i>æ£€æŸ¥é€‰æ‹©åˆ†æ</h6>';
      html += '</div>';
      html += '<div class="card-body">';
      html += '<div class="alert alert-primary mb-3" style="border-radius: 8px;">';
      html += '<i class="fas fa-lightbulb me-2"></i>';
      html += '<strong>é—æ¼åˆ†æï¼š</strong>æ‚¨çš„é€‰æ‹©ä¸­ç¼ºå°‘äº† ' + details.missing_required.length + ' é¡¹é‡è¦æ£€æŸ¥ã€‚';
      html += '</div>';
      html += '<p class="text-muted mb-2">ğŸ’¡ <strong>æ€è€ƒæç¤ºï¼š</strong></p>';
      html += '<ul class="list-unstyled mb-0">';
      html += '<li class="mb-2"><i class="fas fa-arrow-right text-primary me-2"></i>æ‚£è€…çš„ä¸»è¦ç—‡çŠ¶æç¤ºå“ªäº›ç³»ç»Ÿå¯èƒ½å—ç´¯ï¼Ÿ</li>';
      html += '<li class="mb-2"><i class="fas fa-arrow-right text-primary me-2"></i>å“ªäº›åŸºç¡€æ£€æŸ¥æ˜¯è¯„ä¼°è¯¥ç—‡çŠ¶çš„å¸¸è§„é¡¹ç›®ï¼Ÿ</li>';
      html += '<li class="mb-0"><i class="fas fa-arrow-right text-primary me-2"></i>æ˜¯å¦é—æ¼äº†æŸäº›è¯Šæ–­ä»·å€¼é«˜çš„æ£€æŸ¥ï¼Ÿ</li>';
      html += '</ul>';
      html += '</div>';
      html += '</div>';
    }
    
    if (details.extra_selected && details.extra_selected.length > 0) {
      html += '<div class="card mb-3" style="border: 2px solid #ffc107; border-radius: 10px;">';
      html += '<div class="card-header bg-warning text-dark" style="border-radius: 8px 8px 0 0;">';
      html += '<h6 class="mb-0"><i class="fas fa-balance-scale me-2"></i>é€‰æ‹©ä¼˜åŒ–å»ºè®®</h6>';
      html += '</div>';
      html += '<div class="card-body">';
      html += '<div class="alert alert-warning mb-3" style="border-radius: 8px;">';
      html += '<i class="fas fa-exclamation-triangle me-2"></i>';
      html += '<strong>æ•ˆç‡åˆ†æï¼š</strong>æ‚¨é€‰æ‹©äº† ' + details.extra_selected.length + ' é¡¹å¯èƒ½éå¿…éœ€çš„æ£€æŸ¥ã€‚';
      html += '</div>';
      html += '<p class="text-muted mb-2">ğŸ’¡ <strong>ä¼˜åŒ–å»ºè®®ï¼š</strong></p>';
      html += '<ul class="list-unstyled mb-0">';
      html += '<li class="mb-2"><i class="fas fa-arrow-right text-warning me-2"></i>é‡æ–°è¯„ä¼°æ¯é¡¹æ£€æŸ¥çš„è¯Šæ–­ä»·å€¼</li>';
      html += '<li class="mb-2"><i class="fas fa-arrow-right text-warning me-2"></i>è€ƒè™‘æ£€æŸ¥çš„æˆæœ¬æ•ˆç›Šæ¯”</li>';
      html += '<li class="mb-0"><i class="fas fa-arrow-right text-warning me-2"></i>ä¼˜å…ˆé€‰æ‹©å¯¹å½“å‰ç—‡çŠ¶æœ€æœ‰é’ˆå¯¹æ€§çš„æ£€æŸ¥</li>';
      html += '</ul>';
      html += '</div>';
      html += '</div>';
    }
    
    // å­¦ä¹ ç­–ç•¥æŒ‡å¯¼
    html += '<div class="card" style="border: 2px solid #28a745; border-radius: 10px;">';
    html += '<div class="card-header bg-success text-white" style="border-radius: 8px 8px 0 0;">';
    html += '<h6 class="mb-0"><i class="fas fa-graduation-cap me-2"></i>ä¸´åºŠæ€ç»´è®­ç»ƒ</h6>';
    html += '</div>';
    html += '<div class="card-body">';
    html += '<div class="row">';
    html += '<div class="col-md-6">';
    html += '<h6 class="text-primary mb-2">ğŸ“‹ ç—…ä¾‹åˆ†ææ­¥éª¤</h6>';
    html += '<ul class="list-unstyled">';
    html += '<li class="mb-1"><i class="fas fa-check-circle text-success me-2"></i>é‡è¯»æ‚£è€…ä¸»è¯‰å’Œç°ç—…å²</li>';
    html += '<li class="mb-1"><i class="fas fa-check-circle text-success me-2"></i>åˆ†æç—‡çŠ¶çš„ä¸´åºŠæ„ä¹‰</li>';
    html += '<li class="mb-0"><i class="fas fa-check-circle text-success me-2"></i>ç¡®å®šè¯Šæ–­æ€è·¯å’Œæ–¹å‘</li>';
    html += '</ul>';
    html += '</div>';
    html += '<div class="col-md-6">';
    html += '<h6 class="text-info mb-2">ğŸ¯ æ£€æŸ¥é€‰æ‹©åŸåˆ™</h6>';
    html += '<ul class="list-unstyled">';
    html += '<li class="mb-1"><i class="fas fa-star text-warning me-2"></i>ä¼˜å…ˆé€‰æ‹©é«˜è¯Šæ–­ä»·å€¼çš„æ£€æŸ¥</li>';
    html += '<li class="mb-1"><i class="fas fa-dollar-sign text-info me-2"></i>è€ƒè™‘æ£€æŸ¥çš„æˆæœ¬æ•ˆç›Šæ¯”</li>';
    html += '<li class="mb-0"><i class="fas fa-target text-danger me-2"></i>é¿å…è¿‡åº¦æ£€æŸ¥å’Œæ¼æ£€</li>';
    html += '</ul>';
    html += '</div>';
    html += '</div>';
    html += '</div>';
    html += '</div>';
    
    html += '</div>';
    
    // æ›´æ–°ä¸»è¦å†…å®¹åŒºåŸŸ
    $('#main-content').html(html);
    
    // ç§»é™¤çº¢è‰²è¾¹æ¡†é«˜äº®æç¤º - è®©å­¦ç”Ÿè‡ªå·±æ€è€ƒè€Œä¸æ˜¯ç›´æ¥æç¤ºç­”æ¡ˆ
    // æ³¨é‡Šæ‰é«˜äº®æ˜¾ç¤ºï¼Œé¿å…è¿‡åº¦æç¤º
    // if (details.missing_required) {
    //   details.missing_required.forEach(function(examId) {
    //     $('.examination-option[data-exam-id="' + examId + '"]').addClass('border-danger').css('animation', 'pulse 1s infinite');
    //   });
    // }
    
    // if (details.extra_selected) {
    //   details.extra_selected.forEach(function(examId) {
    //     $('.examination-option[data-exam-id="' + examId + '"]').addClass('border-warning');
    //   });
    // }
    
    // æ»šåŠ¨åˆ°é¡¶éƒ¨
    $('html, body').animate({ scrollTop: 0 }, 300);
  }
  
  function showExaminationValidationError(errorResponse) {
    /**
     * æ˜¾ç¤ºæ£€æŸ¥é€‰æ‹©éªŒè¯é”™è¯¯çš„è¯¦ç»†ä¿¡æ¯
     */
    const details = errorResponse.error_details || {};
    const message = errorResponse.message || 'é€‰æ‹©éªŒè¯å¤±è´¥';
    
    // æ„å»ºè¯¦ç»†çš„é”™è¯¯æç¤º
    let errorHtml = '<div class="examination-validation-error">';
    
    // ä¸»è¦é”™è¯¯ä¿¡æ¯
    errorHtml += '<div class="alert alert-danger validation-error-alert" style="background: linear-gradient(135deg, #f8d7da 0%, #f1b0b7 100%); border: none; border-radius: 10px; margin-bottom: 15px; animation: shakeError 0.6s ease-in-out;">';
    errorHtml += '<div class="d-flex align-items-center mb-3">';
    errorHtml += '<i class="fas fa-exclamation-triangle text-danger me-3" style="font-size: 1.5rem;"></i>';
    errorHtml += '<div>';
    errorHtml += `<h6 class="mb-1 text-danger font-weight-bold">ç¬¬${details.attempt_count || 1}æ¬¡å°è¯•å¤±è´¥</h6>`;
    errorHtml += `<p class="mb-0 text-danger">${message}</p>`;
    errorHtml += '</div>';
    errorHtml += '</div>';
    
    // å­¦ä¹ æç¤ºåŒºåŸŸï¼ˆä¸æ˜¾ç¤ºå…·ä½“æ£€æŸ¥é¡¹ç›®åç§°ï¼‰
    if ((details.missing_required && details.missing_required.length > 0) || 
        (details.extra_selected && details.extra_selected.length > 0)) {
      
      errorHtml += '<div class="learning-tips mb-3" style="background: linear-gradient(135deg, #f8f9fc 0%, #e9ecef 100%); border-radius: 8px; padding: 15px;">';
      
      if (details.attempt_count <= 2) {
        errorHtml += '<h6 class="text-primary mb-3"><i class="fas fa-compass me-2"></i>å­¦ä¹ æŒ‡å¯¼</h6>';
        
        if (details.missing_required && details.missing_required.length > 0) {
          errorHtml += '<div class="mb-2"><i class="fas fa-search text-info me-2"></i>';
          errorHtml += '<span class="text-dark">é‡æ–°å®¡è§†æ‚£è€…ç—‡çŠ¶ï¼Œè¿˜æœ‰å“ªäº›åŸºç¡€æ£€æŸ¥æ˜¯è¯Šæ–­å¿…éœ€çš„ï¼Ÿ</span></div>';
        }
        
        if (details.extra_selected && details.extra_selected.length > 0) {
          errorHtml += '<div class="mb-2"><i class="fas fa-filter text-warning me-2"></i>';
          errorHtml += '<span class="text-dark">è€ƒè™‘æ£€æŸ¥çš„æˆæœ¬æ•ˆç›Šï¼Œæ˜¯å¦é€‰æ‹©äº†ä¸€äº›éå¿…éœ€çš„é¡¹ç›®ï¼Ÿ</span></div>';
        }
        
        errorHtml += '<div class="mt-3 p-2" style="background: rgba(0,123,255,0.1); border-radius: 4px;">';
        errorHtml += '<small class="text-primary"><i class="fas fa-lightbulb me-1"></i> ';
        errorHtml += 'æç¤ºï¼šå…³æ³¨æ£€æŸ¥é¡¹ç›®çš„"è¯Šæ–­ä»·å€¼"å’Œ"æˆæœ¬æ•ˆç›Š"æ ‡è¯†ï¼Œä¼˜å…ˆé€‰æ‹©é«˜ä»·å€¼çš„æ£€æŸ¥ã€‚</small>';
        errorHtml += '</div>';
        
      } else {
        errorHtml += '<h6 class="text-secondary mb-3"><i class="fas fa-book me-2"></i>æ·±åº¦å­¦ä¹ å»ºè®®</h6>';
        errorHtml += '<div class="row">';
        errorHtml += '<div class="col-md-6">';
        errorHtml += '<div class="mb-2"><i class="fas fa-eye text-primary me-2"></i>é‡æ–°é˜…è¯»ç—…ä¾‹å…³é”®ä¿¡æ¯</div>';
        errorHtml += '<div class="mb-2"><i class="fas fa-list-check text-success me-2"></i>å›é¡¾æ ‡å‡†è¯Šæ–­æµç¨‹</div>';
        errorHtml += '</div>';
        errorHtml += '<div class="col-md-6">';
        errorHtml += '<div class="mb-2"><i class="fas fa-balance-scale text-warning me-2"></i>è¯„ä¼°æ£€æŸ¥å¿…è¦æ€§</div>';
        errorHtml += '<div class="mb-2"><i class="fas fa-star text-info me-2"></i>å‚è€ƒè¯Šæ–­ä»·å€¼æ ‡è¯†</div>';
        errorHtml += '</div>';
        errorHtml += '</div>';
      }
      
      errorHtml += '</div>';
    }
    
    // æƒ©ç½šä¿¡æ¯
    if (details.penalty_applied && details.penalty_applied > 0) {
      errorHtml += '<div class="penalty-info alert alert-warning" style="background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%); border: none; border-radius: 8px; padding: 12px;">';
      errorHtml += `<i class="fas fa-exclamation-triangle me-2"></i>æœ¬æ¬¡é”™è¯¯å°†æ‰£é™¤ <strong>${details.penalty_applied}åˆ†</strong>`;
      errorHtml += '</div>';
    }
    
    // é¼“åŠ±æ€§æ“ä½œæç¤º
    errorHtml += '<div class="encouragement-section alert alert-light" style="background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); border: 1px solid #dee2e6; border-radius: 8px; padding: 15px;">';
    errorHtml += '<div class="text-center">';
    errorHtml += '<i class="fas fa-graduation-cap text-primary mb-2" style="font-size: 1.5rem;"></i>';
    
    if (details.attempt_count === 1) {
      errorHtml += '<p class="mb-2 text-dark"><strong>å­¦ä¹ æ˜¯ä¸€ä¸ªæ¢ç´¢è¿‡ç¨‹</strong></p>';
      errorHtml += '<p class="mb-0 text-muted">ä»”ç»†åˆ†ææ‚£è€…ç—‡çŠ¶ï¼Œæ€è€ƒè¯Šæ–­æ‰€éœ€çš„å…³é”®æ£€æŸ¥ã€‚æ¯æ¬¡å°è¯•éƒ½æ˜¯å®è´µçš„å­¦ä¹ æœºä¼šï¼</p>';
    } else if (details.attempt_count === 2) {
      errorHtml += '<p class="mb-2 text-dark"><strong>ç»§ç»­æ·±å…¥æ€è€ƒ</strong></p>';
      errorHtml += '<p class="mb-0 text-muted">ç»“åˆæ‚£è€…çš„å…·ä½“ç—‡çŠ¶å’Œä½“å¾ï¼Œé‡æ–°è¯„ä¼°å“ªäº›æ£€æŸ¥æœ€æœ‰è¯Šæ–­ä»·å€¼ã€‚åŠ æ²¹ï¼</p>';
    } else {
      errorHtml += '<p class="mb-2 text-dark"><strong>åšæŒå°±æ˜¯èƒœåˆ©</strong></p>';
      errorHtml += '<p class="mb-0 text-muted">ä¸´åºŠæ¨ç†éœ€è¦åå¤ç»ƒä¹ ã€‚å»ºè®®ç³»ç»Ÿå›é¡¾è¯Šæ–­æ€è·¯ï¼Œæ¯ä¸ªåŒ»ç”Ÿéƒ½æ˜¯è¿™æ ·æˆé•¿çš„ï¼</p>';
    }
    
    errorHtml += '</div>';
    errorHtml += '</div>';
    
    errorHtml += '</div>';
    
    // æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯åˆ°åé¦ˆé¢æ¿
    $('#feedback-panel').html(errorHtml);
    
    // é«˜äº®æ˜¾ç¤ºé”™è¯¯çš„æ£€æŸ¥é¡¹
    highlightErrorExaminations(details);
    
    // æ»šåŠ¨åˆ°åé¦ˆé¢æ¿
    $('#feedback-panel')[0].scrollIntoView({ behavior: 'smooth' });
    
    // è®°å½•é”™è¯¯åˆ°æ—¶é—´çº¿
    addToLearningTimeline(
      `æ£€æŸ¥é€‰æ‹©é”™è¯¯ (ç¬¬${details.attempt_count}æ¬¡)`, 
      `æƒ©ç½š: -${details.penalty_applied || 0}åˆ†`
    );
  }
  
  function getExaminationNameById(examId) {
    /**
     * æ ¹æ®æ£€æŸ¥é¡¹ç›®IDè·å–åç§°
     */
    const examCheckbox = $(`input[value="${examId}"]`);
    if (examCheckbox.length > 0) {
      return examCheckbox.closest('.examination-option').find('strong').first().text();
    }
    return null;
  }
  
  function highlightErrorExaminations(errorDetails) {
    /**
     * é«˜äº®æ˜¾ç¤ºé”™è¯¯çš„æ£€æŸ¥é¡¹ç›®
     */
    // æ¸…é™¤ä¹‹å‰çš„é«˜äº®
    $('.examination-option').removeClass('error-missing error-extra');
    
    // é«˜äº®ç¼ºå°‘çš„å¿…é€‰é¡¹
    if (errorDetails.missing_required) {
      errorDetails.missing_required.forEach(function(examId) {
        $(`.examination-option[data-exam-id="${examId}"]`).addClass('error-missing');
      });
    }
    
    // é«˜äº®å¤šé€‰çš„é¡¹ç›®
    if (errorDetails.extra_selected) {
      errorDetails.extra_selected.forEach(function(examId) {
        $(`.examination-option[data-exam-id="${examId}"]`).addClass('error-extra');
      });
    }
  }
  
  function showExaminationConfirmedInterface() {
    var html = '<div class="examination-confirmed">';
    
    // ç¡®è®¤çŠ¶æ€æç¤º
    html += '<div class="alert alert-success" style="background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%); border: none; border-radius: 12px; padding: 20px;">';
    html += '<h4 class="mb-3" style="color: #155724; font-weight: 700; display: flex; align-items: center;">';
    html += '<i class="fas fa-check-circle me-2" style="font-size: 1.2rem; color: #28a745;"></i>æ£€æŸ¥é€‰æ‹©å·²ç¡®è®¤';
    html += '</h4>';
    html += '<p class="mb-0" style="font-size: 1rem; line-height: 1.6; color: #155724;">æ‚¨å·²é€‰æ‹© ' + clinicalSession.selectedExaminations.length + ' é¡¹æ£€æŸ¥ï¼Œç³»ç»Ÿå°†æŒ‰é¡ºåºé€ä¸€å±•ç¤ºæ£€æŸ¥ç»“æœã€‚</p>';
    html += '</div>';
    
    // æ£€æŸ¥é¡ºåºé¢„è§ˆ - ä¼˜åŒ–è®¾è®¡
    html += '<div class="examination-sequence-preview mb-5">';
    
    // å¤§æ ‡é¢˜
    html += '<div class="text-center mb-4">';
    html += '<h3 class="text-primary fw-bold" style="font-size: 1.8rem; border-bottom: 3px solid #007bff; display: inline-block; padding-bottom: 10px;">';
    html += '<i class="fas fa-list-ol me-3"></i>æ£€æŸ¥é¡ºåºé¢„è§ˆ';
    html += '</h3>';
    html += '</div>';
    
    // æ£€æŸ¥é¡¹ç›®å¡ç‰‡ - å¼ºåˆ¶æ°´å¹³æ’åˆ—
    html += '<div class="sequence-cards-container mb-4">';
    html += '<div style="display: flex; flex-wrap: wrap; gap: 10px; align-items: flex-start;">';
    
    clinicalSession.examinationOrder.forEach(function(examId, index) {
      var $examCard = $('.examination-option[data-exam-id="' + examId + '"]');
      var examName = $examCard.find('strong').text();
      var isRequired = $examCard.data('is-required');
      
      // å°å¡ç‰‡æ ·å¼ - ä½¿ç”¨flexå­é¡¹
      html += '<div class="sequence-card" style="flex: 0 0 auto;">';
      html += '<div class="sequence-number">' + (index + 1) + '</div>';
      html += '<div class="sequence-name">' + examName + '</div>';
      html += '</div>';
    });
    
    html += '</div>';
    html += '</div>';
    
    // æ˜¾ç¤ºé™æ€å¼€å§‹æ£€æŸ¥æç¤º
    $('#start-examination-hint').show();
    
    html += '</div>';
    
    $('#stage-content').html(html);
  }
  
  function showNextExaminationResult() {
    var currentIndex = clinicalSession.currentExaminationIndex;
    var examId = clinicalSession.examinationOrder[currentIndex];
    
    // éšè—é™æ€æç¤ºå¹¶æ˜¾ç¤ºåŠ è½½çŠ¶æ€
    $('#start-examination-hint').hide();
    $('#btn-next').prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i> åŠ è½½ä¸­...');
    
    // è·å–æ£€æŸ¥ç»“æœ
    $.getJSON('/api/clinical/case/' + clinicalSession.caseId + '/examination/' + examId + '/', function(resp) {
      if (resp.success) {
        renderSingleExaminationResult(resp.data, currentIndex);
        
        // æ›´æ–°ç´¢å¼•
        clinicalSession.currentExaminationIndex++;
        
        // æ›´æ–°æŒ‰é’®æ–‡æœ¬
        if (clinicalSession.currentExaminationIndex < clinicalSession.examinationOrder.length) {
          $('#btn-next').prop('disabled', false).html('æŸ¥çœ‹ä¸‹ä¸€é¡¹æ£€æŸ¥ <i class="fas fa-arrow-right"></i>');
        } else {
          $('#btn-next').prop('disabled', false).html('å®Œæˆæ£€æŸ¥é˜¶æ®µ <i class="fas fa-check"></i>');
        }
        
        // è®°å½•åˆ°æ—¶é—´çº¿
        addToLearningTimeline('æŸ¥çœ‹æ£€æŸ¥ç»“æœ', resp.data.name);
      } else {
        $('#btn-next').prop('disabled', false).html('æŸ¥çœ‹æ£€æŸ¥ç»“æœ <i class="fas fa-arrow-right"></i>');
        showFeedbackMessage('è·å–æ£€æŸ¥ç»“æœå¤±è´¥: ' + resp.message, 'danger');
      }
    }).fail(function() {
      $('#btn-next').prop('disabled', false).html('æŸ¥çœ‹æ£€æŸ¥ç»“æœ <i class="fas fa-arrow-right"></i>');
      showFeedbackMessage('ç½‘ç»œé”™è¯¯ï¼Œè¯·æ£€æŸ¥è¿æ¥åé‡è¯•', 'danger');
    });
  }
  
  function renderSingleExaminationResult(resultData, examIndex) {
    var html = '<div class="single-examination-result">';
    
    // æ£€æŸ¥è¿›åº¦æŒ‡ç¤º
    var totalExams = clinicalSession.examinationOrder.length;
    var progressPercent = Math.round(((examIndex + 1) / totalExams) * 100);
    
    html += '<div class="examination-progress mb-4">';
    html += '<div class="d-flex justify-content-between align-items-center mb-2">';
    html += '<h5 class="text-primary mb-0">æ£€æŸ¥è¿›åº¦</h5>';
    html += '<span class="text-muted">' + (examIndex + 1) + ' / ' + totalExams + '</span>';
    html += '</div>';
    html += '<div class="progress" style="height: 8px;">';
    html += '<div class="progress-bar bg-primary" style="width: ' + progressPercent + '%"></div>';
    html += '</div>';
    html += '</div>';
    
    // å½“å‰æ£€æŸ¥ç»“æœå±•ç¤º
    html += '<div class="current-examination-result">';
    html += '<div class="card border-primary">';
    html += '<div class="card-header bg-primary text-white">';
    html += '<h4 class="mb-0"><i class="fas fa-microscope me-2"></i>' + resultData.name + '</h4>';
    html += '</div>';
    html += '<div class="card-body">';
    
    // æ£€æŸ¥æè¿° - å·²éšè—ï¼Œä¸å†æ˜¾ç¤ºæ£€æŸ¥è¯´æ˜
    // if (resultData.description) {
    //   html += '<div class="examination-description mb-3">';
    //   html += '<h6 class="text-muted">æ£€æŸ¥è¯´æ˜</h6>';
    //   html += '<p class="text-muted">' + resultData.description + '</p>';
    //   html += '</div>';
    // }
    
    // ç‰¹æ®Šå¤„ç†ï¼šçœ¼åº•æ£€æŸ¥ - ç•™ç™½æ˜¾ç¤º
    var isFundusExam = resultData.is_fundus_exam || 
                      (resultData.name && (
                        resultData.name.toLowerCase().indexOf('çœ¼åº•') !== -1 ||
                        resultData.name.toLowerCase().indexOf('fundus') !== -1 ||
                        resultData.name.toLowerCase().indexOf('çœ¼åº•ç…§ç‰‡') !== -1 ||
                        resultData.name.toLowerCase().indexOf('çœ¼åº•é•œ') !== -1 ||
                        resultData.name.toLowerCase().indexOf('çœ¼åº•æ£€æŸ¥') !== -1
                      )) ||
                      (resultData.type && (
                        resultData.type.toLowerCase().indexOf('çœ¼åº•') !== -1 ||
                        resultData.type.toLowerCase().indexOf('fundus') !== -1
                      ));
    
    if (isFundusExam) {
      // çœ¼åº•æ£€æŸ¥ç•™ç™½åŒºåŸŸ
      html += '<div class="fundus-examination-blank">';
      html += '<div class="icon">';
      html += '<i class="fas fa-eye"></i>';
      html += '</div>';
      html += '<div class="message">è¯·ç§»æ­¥æ—è¾¹è¿›è¡Œè§‚å¯Ÿ</div>';
      html += '<div class="submessage">çœ¼åº•æ£€æŸ¥éœ€è¦å®é™…æ“ä½œè§‚å¯Ÿ</div>';
      html += '</div>';
      
      // æ˜¾ç¤ºæµ®ç°å­—å¹•
      setTimeout(function() {
        showFundusSubtitle();
      }, 500);
    } else {
      // æ™®é€šæ£€æŸ¥æ˜¾ç¤ºå®Œæ•´ç»“æœ
      // æ£€æŸ¥æè¿° - å·²éšè—ï¼Œä¸å†æ˜¾ç¤ºæ£€æŸ¥è¯´æ˜
      // if (resultData.description) {
      //   html += '<div class="examination-description mb-3">';
      //   html += '<h6 class="text-muted">æ£€æŸ¥è¯´æ˜</h6>';
      //   html += '<p class="text-muted">' + resultData.description + '</p>';
      //   html += '</div>';
      // }
      
      // æ£€æŸ¥ç»“æœ
      html += '<div class="examination-result-content">';
      html += '<h6 class="text-primary">æ£€æŸ¥ç»“æœ</h6>';
      html += '<div class="result-box p-3 bg-light rounded border-left-primary">';
      html += '<p class="mb-0" style="font-size: 1.1rem; line-height: 1.6;">' + resultData.result + '</p>';
      html += '</div>';
      html += '</div>';
      
      // æ£€æŸ¥æ•°æ®ï¼ˆè§†åŠ›ã€çœ¼å‹ç­‰ï¼‰
      if (resultData.examination_data && Object.keys(resultData.examination_data).length > 0) {
        html += '<div class="examination-data mt-3">';
        html += '<h6 class="text-primary">æ£€æŸ¥æ•°æ®</h6>';
        html += '<div class="row">';
        
        if (resultData.examination_data.left_eye_vision) {
          html += '<div class="col-md-6">';
          html += '<div class="data-item p-2 bg-light rounded">';
          html += '<strong>å·¦çœ¼è§†åŠ›:</strong> ' + resultData.examination_data.left_eye_vision;
          html += '</div>';
          html += '</div>';
        }
        
        if (resultData.examination_data.right_eye_vision) {
          html += '<div class="col-md-6">';
          html += '<div class="data-item p-2 bg-light rounded">';
          html += '<strong>å³çœ¼è§†åŠ›:</strong> ' + resultData.examination_data.right_eye_vision;
          html += '</div>';
          html += '</div>';
        }
        
        if (resultData.examination_data.left_eye_pressure) {
          html += '<div class="col-md-6">';
          html += '<div class="data-item p-2 bg-light rounded">';
          html += '<strong>å·¦çœ¼çœ¼å‹:</strong> ' + resultData.examination_data.left_eye_pressure + ' mmHg';
          html += '</div>';
          html += '</div>';
        }
        
        if (resultData.examination_data.right_eye_pressure) {
          html += '<div class="col-md-6">';
          html += '<div class="data-item p-2 bg-light rounded">';
          html += '<strong>å³çœ¼çœ¼å‹:</strong> ' + resultData.examination_data.right_eye_pressure + ' mmHg';
          html += '</div>';
          html += '</div>';
        }
        
        html += '</div>';
        html += '</div>';
      }
      
      // æ£€æŸ¥å›¾åƒ - å¢å¼ºæ˜¾ç¤º
      console.log('æ£€æŸ¥ç»“æœæ•°æ®:', resultData); // è°ƒè¯•ä¿¡æ¯
      console.log('å›¾åƒæ•°æ®:', resultData.images); // è°ƒè¯•ä¿¡æ¯
      
      if (resultData.images && resultData.images.length > 0) {
        html += '<div class="examination-images mt-3">';
        html += '<h6 class="text-primary mb-3"><i class="fas fa-image me-2"></i>æ£€æŸ¥å›¾åƒ</h6>';
        
        // æ£€æŸ¥æ˜¯å¦ä¸ºOCTæ£€æŸ¥
        var isOctExam = resultData.is_oct_exam || 
                       (resultData.name && (
                         resultData.name.indexOf('OCT') !== -1 ||
                         resultData.name.indexOf('å…‰å­¦ç›¸å¹²æ–­å±‚æ‰«æ') !== -1 ||
                         resultData.name.indexOf('å…‰ç›¸å¹²æ–­å±‚') !== -1
                       ));
        
        console.log('æ˜¯å¦OCTæ£€æŸ¥:', isOctExam); // è°ƒè¯•ä¿¡æ¯
        
        if (isOctExam) {
          // OCTæ£€æŸ¥ç‰¹æ®Šæ˜¾ç¤º
          html += renderOctImages(resultData);
        } else {
          // æ™®é€šæ£€æŸ¥å›¾åƒæ˜¾ç¤º
          html += renderStandardImages(resultData);
        }
        
        html += '</div>';
      } else {
        // æ·»åŠ è°ƒè¯•ä¿¡æ¯æ˜¾ç¤ºæ²¡æœ‰å›¾åƒçš„æƒ…å†µ
        html += '<div class="alert alert-warning mt-3">';
        html += '<i class="fas fa-info-circle me-2"></i>';
        html += 'æš‚æ— æ£€æŸ¥å›¾åƒæ•°æ®';
        if (resultData.is_oct_exam) {
          html += ' (OCTæ£€æŸ¥)';
        }
        html += '</div>';
        console.log('æ²¡æœ‰å›¾åƒæ•°æ®æˆ–å›¾åƒæ•°ç»„ä¸ºç©º'); // è°ƒè¯•ä¿¡æ¯
      }
    }
    
    html += '</div>';
    html += '</div>';
    html += '</div>';
    
    // ç»§ç»­æç¤º
    html += '<div class="continue-prompt mt-4">';
    html += '<div class="text-center p-3 bg-light rounded">';
    if (examIndex + 1 < totalExams) {
      html += '<p class="text-muted mb-0">è¯·ä»”ç»†æŸ¥çœ‹æ£€æŸ¥ç»“æœï¼Œå‡†å¤‡æŸ¥çœ‹ä¸‹ä¸€é¡¹æ£€æŸ¥</p>';
    } else {
      html += '<p class="text-muted mb-0">æ‰€æœ‰æ£€æŸ¥ç»“æœå·²å±•ç¤ºå®Œæ¯•ï¼Œå‡†å¤‡è¿›å…¥è¯Šæ–­é˜¶æ®µ</p>';
    }
    html += '</div>';
    html += '</div>';
    
    html += '</div>';
    
    $('#stage-content').html(html);
    
    // ç»‘å®šå›¾åƒç‚¹å‡»äº‹ä»¶
    $('.examination-image').on('click', function() {
      var imageSrc = $(this).data('image-src');
      showImageModal(imageSrc);
    });
    
    // ç»‘å®šOCTå›¾åƒç‚¹å‡»äº‹ä»¶
    $('.oct-image').on('click', function() {
      var imageSrc = $(this).data('image-src') || $(this).attr('src');
      var eye = $(this).data('eye') || 'unknown';
      var measurements = $(this).data('measurements') || {};
      
      if (clinicalSession.examination_images_viewed.indexOf(imageSrc) === -1) {
        clinicalSession.examination_images_viewed.push(imageSrc);
        saveSessionData();
      }
      
      showOctImageModal(imageSrc, eye, measurements);
    });
  }

  function renderExaminationImagesForCard($card, images) {
    // images ä¸ºæ•°ç»„è·¯å¾„
    if (!images || images.length === 0) return;
    var html = '<div class="examination-images mt-3">';
    images.forEach(function(img) {
      html += '<img src="' + img + '" class="img-fluid mb-2 exam-image" style="max-height:220px; cursor:zoom-in;" data-src="' + img + '">';
    });
    html += '</div>';

    // é˜²æ­¢é‡å¤æ’å…¥
    $card.find('.examination-images').remove();
    $card.find('.card-body').append(html);

    // ç‚¹å‡»å›¾ç‰‡è®°å½•ä¸ºå·²æŸ¥çœ‹
    $card.find('.exam-image').on('click', function() {
      var src = $(this).data('src');
      if (clinicalSession.examination_images_viewed.indexOf(src) === -1) {
        clinicalSession.examination_images_viewed.push(src);
      }
      showImageModal(src);
    });
  }

  function showImageModal(src) {
    var modalHtml = '';
    modalHtml += '<div class="modal fade" id="examImageModal" tabindex="-1" role="dialog">';
    modalHtml += '<div class="modal-dialog modal-lg" role="document">';
    modalHtml += '<div class="modal-content">';
    modalHtml += '<div class="modal-body text-center">';
    modalHtml += '<img src="' + src + '" class="img-fluid">';
    modalHtml += '</div>';
    modalHtml += '<div class="modal-footer">';
    modalHtml += '<button type="button" class="btn btn-secondary" data-dismiss="modal">å…³é—­</button>'; 
    modalHtml += '</div></div></div></div>';

    $('#examImageModal').remove();
    $('body').append(modalHtml);
    $('#examImageModal').modal('show');
  }
  
  // OCTå›¾åƒä¸“ç”¨æ¨¡æ€æ¡†
  function showOctImageModal(src, eye, measurements) {
    var modalHtml = '';
    modalHtml += '<div class="modal fade" id="octImageModal" tabindex="-1" role="dialog">';
    modalHtml += '<div class="modal-dialog modal-xl" role="document">';
    modalHtml += '<div class="modal-content">';
    
    // æ¨¡æ€æ¡†å¤´éƒ¨
    modalHtml += '<div class="modal-header bg-primary text-white">';
    modalHtml += '<h5 class="modal-title">';
    modalHtml += '<i class="fas fa-microscope me-2"></i>OCTæ£€æŸ¥å›¾åƒ - ' + (eye === 'left' ? 'å·¦çœ¼' : 'å³çœ¼');
    modalHtml += '</h5>';
    modalHtml += '<button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>';
    modalHtml += '</div>';
    
    // æ¨¡æ€æ¡†å†…å®¹
    modalHtml += '<div class="modal-body">';
    modalHtml += '<div class="row">';
    
    // å›¾åƒæ˜¾ç¤ºåŒºåŸŸ
    modalHtml += '<div class="col-md-8">';
    modalHtml += '<div class="oct-modal-image-container">';
    modalHtml += '<img src="' + src + '" class="img-fluid oct-modal-image" ';
    modalHtml += 'style="width: 100%; border-radius: 8px; border: 2px solid #dee2e6;">';
    
    // å›¾åƒå·¥å…·æ 
    modalHtml += '<div class="image-toolbar mt-3">';
    modalHtml += '<div class="btn-group" role="group">';
    modalHtml += '<button type="button" class="btn btn-outline-primary btn-sm" onclick="zoomImage(\'in\')">';
    modalHtml += '<i class="fas fa-search-plus"></i> æ”¾å¤§</button>';
    modalHtml += '<button type="button" class="btn btn-outline-primary btn-sm" onclick="zoomImage(\'out\')">';
    modalHtml += '<i class="fas fa-search-minus"></i> ç¼©å°</button>';
    modalHtml += '<button type="button" class="btn btn-outline-primary btn-sm" onclick="resetImageZoom()">';
    modalHtml += '<i class="fas fa-expand-arrows-alt"></i> é‡ç½®</button>';
    modalHtml += '<button type="button" class="btn btn-outline-secondary btn-sm" onclick="toggleImageMeasurement()">';
    modalHtml += '<i class="fas fa-ruler"></i> æµ‹é‡</button>';
    modalHtml += '</div>';
    modalHtml += '</div>';
    
    modalHtml += '</div>';
    modalHtml += '</div>';
    
    // æµ‹é‡æ•°æ®å’Œåˆ†æé¢æ¿
    modalHtml += '<div class="col-md-4">';
    modalHtml += '<div class="oct-analysis-panel">';
    
    modalHtml += '<h6 class="text-primary mb-3">';
    modalHtml += '<i class="fas fa-chart-line me-2"></i>åˆ†ææ•°æ®';
    modalHtml += '</h6>';
    
    if (measurements && Object.keys(measurements).length > 0) {
      modalHtml += '<div class="measurements-list">';
      Object.keys(measurements).forEach(function(key) {
        var value = measurements[key];
        var displayName = getOctMeasurementDisplayName(key);
        modalHtml += '<div class="measurement-item mb-3 p-3 bg-light rounded">';
        modalHtml += '<div class="measurement-name small text-muted mb-1">' + displayName + '</div>';
        modalHtml += '<div class="measurement-value h6 text-primary mb-0">' + value + '</div>';
        modalHtml += '</div>';
      });
      modalHtml += '</div>';
    } else {
      modalHtml += '<div class="alert alert-light">';
      modalHtml += '<small class="text-muted">æš‚æ— æµ‹é‡æ•°æ®</small>';
      modalHtml += '</div>';
    }
    
    // åˆ†æè¦ç‚¹
    modalHtml += '<div class="analysis-points mt-4">';
    modalHtml += '<h6 class="text-secondary mb-3">';
    modalHtml += '<i class="fas fa-eye me-2"></i>è§‚å¯Ÿè¦ç‚¹';
    modalHtml += '</h6>';
    modalHtml += '<ul class="list-unstyled small">';
    modalHtml += '<li class="mb-2"><i class="fas fa-arrow-right text-primary me-2"></i>è§†ç½‘è†œå„å±‚ç»“æ„</li>';
    modalHtml += '<li class="mb-2"><i class="fas fa-arrow-right text-primary me-2"></i>è§†ç½‘è†œåšåº¦å˜åŒ–</li>';
    modalHtml += '<li class="mb-2"><i class="fas fa-arrow-right text-primary me-2"></i>ç—…ç†æ€§æ”¹å˜</li>';
    modalHtml += '<li class="mb-2"><i class="fas fa-arrow-right text-primary me-2"></i>ç§¯æ¶²æˆ–å‡ºè¡€</li>';
    modalHtml += '</ul>';
    modalHtml += '</div>';
    
    modalHtml += '</div>';
    modalHtml += '</div>';
    
    modalHtml += '</div>';
    modalHtml += '</div>';
    
    // æ¨¡æ€æ¡†åº•éƒ¨
    modalHtml += '<div class="modal-footer">';
    modalHtml += '<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">';
    modalHtml += '<i class="fas fa-times me-2"></i>å…³é—­';
    modalHtml += '</button>';
    modalHtml += '<button type="button" class="btn btn-primary" onclick="saveImageAnnotation()">';
    modalHtml += '<i class="fas fa-save me-2"></i>ä¿å­˜æ ‡æ³¨';
    modalHtml += '</button>';
    modalHtml += '</div>';
    
    modalHtml += '</div></div></div>';

    // ç§»é™¤å·²å­˜åœ¨çš„æ¨¡æ€æ¡†å¹¶æ·»åŠ æ–°çš„
    $('#octImageModal').remove();
    $('body').append(modalHtml);
    
    // æ˜¾ç¤ºæ¨¡æ€æ¡†
    $('#octImageModal').modal('show');
  }

  // æ˜¾ç¤ºçœ¼åº•æ£€æŸ¥å­—å¹•
  function showFundusSubtitle() {
    // åˆ›å»ºå­—å¹•è¦†ç›–å±‚
    if (!$('#fundus-overlay').length) {
      var overlayHtml = '<div id="fundus-overlay">';
      overlayHtml += '<div id="fundus-subtitle">è¯·ç§»æ­¥æ—è¾¹è¿›è¡Œè§‚å¯Ÿ</div>';
      overlayHtml += '</div>';
      $('body').append(overlayHtml);
    }
    
    var $overlay = $('#fundus-overlay');
    var $subtitle = $('#fundus-subtitle');
    
    // æ˜¾ç¤ºåŠ¨ç”»åºåˆ—
    $overlay.addClass('show');
    
    // 3ç§’åå¼€å§‹æ·¡å‡ºï¼Œä½†ä¿æŒæ˜¾ç¤ºç›´åˆ°ç”¨æˆ·æ“ä½œ
    setTimeout(function() {
      if (!clinicalSession.fundusSubtitleDismissed) {
        // æ·»åŠ è½»å¾®çš„è„‰å†²æé†’ï¼Œä½†ä¸å®Œå…¨æ¶ˆå¤±
        $subtitle.css('animation', 'pulse-glow 2s ease-in-out infinite');
      }
    }, 3000);
  }
  
  // éšè—çœ¼åº•æ£€æŸ¥å­—å¹•
  function hideFundusSubtitle() {
    var $overlay = $('#fundus-overlay');
    clinicalSession.fundusSubtitleDismissed = true;
    
    $overlay.removeClass('show');
    setTimeout(function() {
      $overlay.remove();
    }, 800); // ç­‰å¾…æ·¡å‡ºåŠ¨ç”»å®Œæˆ
  }

  function updateExaminationSummary() {
    var selectedCount = clinicalSession.selectedExaminations.length;
    var totalCost = 0;
    var riskLevels = [];
    var efficiencyScore = 100; // åŸºç¡€æ•ˆç‡åˆ†
    
    $('.examination-checkbox:checked').each(function() {
      var $card = $(this).closest('.examination-option');
      var cost = parseInt($card.find('.examination-info').text().match(/Â¥(\d+)/)?.[1] || 0);
      totalCost += cost;
      
      // ç§»é™¤é«˜ä»·å€¼æ£€æŸ¥ç»Ÿè®¡ï¼Œé¿å…éšæ€§æç¤º
      
      var riskText = $card.find('.examination-info').text();
      if (riskText.includes('é«˜')) riskLevels.push('high');
      else if (riskText.includes('ä¸­')) riskLevels.push('medium');
      else riskLevels.push('low');
    });
    
    // ç»¼åˆé£é™©è¯„ä¼°
    var overallRisk = 'ä½';
    if (riskLevels.includes('high')) overallRisk = 'é«˜';
    else if (riskLevels.includes('medium')) overallRisk = 'ä¸­';
    
    // è®¡ç®—æ£€æŸ¥æ•ˆç‡ï¼ˆåŸºäºé€‰æ‹©æ•°é‡çš„åˆç†æ€§ï¼‰
    if (selectedCount > 8) efficiencyScore -= (selectedCount - 8) * 10;
    if (selectedCount < 2) efficiencyScore -= (2 - selectedCount) * 20;
    
    $('#selected-count').text(selectedCount);
    $('#total-cost').text('Â¥' + totalCost);
  }
  
  // æ˜¾ç¤ºæ£€æŸ¥é€‰æ‹©å¾—åˆ†è¯¦æƒ…
  function showExaminationScoreDetails(scoreDetails) {
    var html = '<div class="alert alert-info score-details-alert" style="margin-top: 15px;">';
    html += '<h6 class="mb-3"><i class="fas fa-chart-bar me-2"></i>æ£€æŸ¥é€‰æ‹©å¾—åˆ†è¯¦æƒ…</h6>';
    html += '<div class="row text-center">';
    
    html += '<div class="col-md-3 col-6 mb-2">';
    html += '<div class="score-item">';
    html += '<div class="score-value text-primary fw-bold" style="font-size: 1.2rem;">' + scoreDetails.total_score + '</div>';
    html += '<div class="score-label small text-muted">æ€»åˆ†</div>';
    html += '</div>';
    html += '</div>';
    
    html += '<div class="col-md-3 col-6 mb-2">';
    html += '<div class="score-item">';
    html += '<div class="score-value text-danger fw-bold">' + scoreDetails.required_score + '</div>';
    html += '<div class="score-label small text-muted">å¿…é€‰æ£€æŸ¥ (60%)</div>';
    html += '<div class="score-stats small text-muted">(' + scoreDetails.required_stats + ')</div>';
    html += '</div>';
    html += '</div>';
    
    html += '<div class="col-md-4 col-6 mb-2">';
    html += '<div class="score-item">';
    html += '<div class="score-value text-info fw-bold">' + scoreDetails.required_score + '</div>';
    html += '<div class="score-label small text-muted">å¿…é€‰æ£€æŸ¥ (70%)</div>';
    html += '<div class="score-stats small text-muted">(' + scoreDetails.required_stats + ')</div>';
    html += '</div>';
    html += '</div>';
    
    html += '<div class="col-md-4 col-6 mb-2">';
    html += '<div class="score-item">';
    html += '<div class="score-value text-warning fw-bold">' + scoreDetails.efficiency_score + '</div>';
    html += '<div class="score-label small text-muted">æ£€æŸ¥æ•ˆç‡ (30%)</div>';
    html += '<div class="score-stats small text-muted">(' + scoreDetails.efficiency_stats + ')</div>';
    html += '</div>';
    html += '</div>';
    
    html += '</div>';
    
    // æ·»åŠ å¾—åˆ†è¯´æ˜
    html += '<div class="mt-3 p-2 bg-light rounded">';
    html += '<small class="text-muted">';
    html += '<i class="fas fa-info-circle me-1"></i>';
    html += '<strong>è¯„åˆ†è¯´æ˜ï¼š</strong> ';
    html += 'å¿…é€‰æ£€æŸ¥å 70%ï¼ˆä¸´åºŠè¯Šæ–­å¿…éœ€ï¼‰ï¼Œæ£€æŸ¥æ•ˆç‡å 30%ï¼ˆé¿å…ä¸å¿…è¦çš„é‡å¤æ£€æŸ¥ï¼Œæé«˜è¯Šæ–­æ•ˆç‡ï¼‰';
    html += '</small>';
    html += '</div>';
    
    html += '</div>';
    
    // æ˜¾ç¤ºå¾—åˆ†è¯¦æƒ…ï¼Œ8ç§’åè‡ªåŠ¨éšè—
    $('#feedback-panel').append(html);
    
    setTimeout(function() {
      $('.score-details-alert').fadeOut(800, function() {
        $(this).remove();
      });
    }, 8000);
  }

  function provideLiveExaminationFeedback() {
    var selectedCount = clinicalSession.selectedExaminations.length;
    var feedback = '';
    
    if (selectedCount === 0) {
      feedback = '<div class="alert alert-info">è¯·å¼€å§‹é€‰æ‹©æ£€æŸ¥é¡¹ç›®</div>';
    } else if (selectedCount < 3) {
      feedback = '<div class="alert alert-warning">è€ƒè™‘æ˜¯å¦éœ€è¦æ›´å¤šæ£€æŸ¥æ¥æ˜ç¡®è¯Šæ–­</div>';
    } else if (selectedCount > 8) {
      feedback = '<div class="alert alert-danger">æ£€æŸ¥è¿‡å¤šå¯èƒ½å¢åŠ æˆæœ¬å’Œæ‚£è€…è´Ÿæ‹…</div>';
    } else {
      feedback = '<div class="alert alert-success" style="background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%); border: 2px solid #28a745; border-radius: 10px;">' +
                 '<div class="d-flex align-items-center">' +
                 '<i class="fas fa-trophy text-warning fs-4 me-3"></i>' +
                 '<div>' +
                 '<h6 class="mb-1 text-success">ğŸ‰ æ£€æŸ¥é€‰æ‹©åˆç†ï¼</h6>' +
                 '<small class="text-success-emphasis">ä½ å±•ç°äº†è‰¯å¥½çš„ä¸´åºŠåˆ¤æ–­èƒ½åŠ›ï¼Œè¯·ç»§ç»­è¿›è¡Œä¸‹ä¸€æ­¥</small>' +
                 '</div>' +
                 '</div>' +
                 '</div>';
    }
    
    $('#feedback-panel').html(feedback);
  }

  function submitExaminations() {
    // éªŒè¯å¿…é€‰æ£€æŸ¥æ˜¯å¦è¢«é€‰ä¸­
    var requiredMissing = [];
    $('.examination-checkbox').each(function() {
      var isRequired = $(this).data('is-required') === 1 || $(this).data('is-required') === true;
      if (isRequired) {
        var id = parseInt($(this).val());
        if (clinicalSession.selectedExaminations.indexOf(id) === -1) {
          requiredMissing.push(id);
        }
      }
    });

    if (requiredMissing.length > 0) {
      showFeedbackMessage('å­˜åœ¨é‡è¦æ£€æŸ¥é¡¹ç›®æœªé€‰æ‹©ï¼Œå»ºè®®å®Œå–„æ£€æŸ¥åå†ç»§ç»­', 'warning');
      return;
    }

    // æ˜¾ç¤ºæäº¤ä¸­çŠ¶æ€
    $('#btn-next').prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i> æäº¤ä¸­...');
    showFeedbackMessage('æ­£åœ¨æäº¤æ£€æŸ¥é€‰æ‹©...', 'info');

    // å‡†å¤‡æäº¤æ•°æ®
    var submitData = {
      case_id: clinicalSession.caseId,
      selected_examinations: clinicalSession.selectedExaminations,
      images_viewed: clinicalSession.examination_images_viewed
    };

    $.ajax({
      url: '/api/clinical/submit-examinations/',
      method: 'POST',
      contentType: 'application/json',
      headers: {
        'X-CSRFToken': $('[name=csrfmiddlewaretoken]').val() || getCsrfToken()
      },
      data: JSON.stringify(submitData),
      success: function(resp) {
        $('#btn-next').prop('disabled', false).html('ä¸‹ä¸€æ­¥ <i class="fas fa-arrow-right"></i>');

        if (resp.success) {
          // è®°å½•æ£€æŸ¥é˜¶æ®µå®Œæˆ
          addToLearningTimeline('å®Œæˆæ£€æŸ¥é€‰æ‹©', 'é€‰æ‹©äº† ' + clinicalSession.selectedExaminations.length + ' é¡¹æ£€æŸ¥');

          // æ›´æ–°åˆ†æ•°
          if (resp.data.examination_score !== undefined) {
            clinicalSession.scores.examination = resp.data.examination_score;
            $('#current-score').text(resp.data.examination_score.toFixed(1));
            
            // æ˜¾ç¤ºå¾—åˆ†è¯¦æƒ…
            if (resp.data.score_details) {
              showExaminationScoreDetails(resp.data.score_details);
            }
          }

          // è¿›å…¥è¯Šæ–­é˜¶æ®µ
          renderDiagnosisStage(resp.data);
          showFeedbackMessage('ğŸ‰ æ£€æŸ¥å®Œæˆï¼ä½ å·²æˆåŠŸè·å¾—æ£€æŸ¥ç»“æœï¼Œç°åœ¨è¯·åŸºäºè¿™äº›è¯æ®è¿›è¡Œè¯Šæ–­åˆ†æ', 'success');
          // è§†è§‰åé¦ˆ
          flashCard($('#feedback-panel'), 'success');
          launchConfetti(25);
        } else {
          showFeedbackMessage('æäº¤å¤±è´¥: ' + resp.message, 'danger');
        }
      },
      error: function(xhr, status, error) {
        $('#btn-next').prop('disabled', false).html('ä¸‹ä¸€æ­¥ <i class="fas fa-arrow-right"></i>');
        console.error('Submit examination error:', error, xhr.responseText);

        if (xhr.status === 404) {
          showFeedbackMessage('APIæ¥å£æœªæ‰¾åˆ°ï¼Œè¯·æ£€æŸ¥åç«¯é…ç½®', 'danger');
        } else if (xhr.status === 403) {
          showFeedbackMessage('æƒé™ä¸è¶³ï¼Œè¯·é‡æ–°ç™»å½•', 'danger');
        } else if (xhr.status === 500) {
          showFeedbackMessage('æœåŠ¡å™¨å†…éƒ¨é”™è¯¯ï¼Œè¯·è”ç³»ç®¡ç†å‘˜', 'danger');
        } else {
          showFeedbackMessage('ç½‘ç»œé”™è¯¯ï¼Œè¯·æ£€æŸ¥è¿æ¥: ' + error, 'danger');
        }
      }
    });
  }

  
  // ==================== è¯Šæ–­é˜¶æ®µï¼šé‰´åˆ«è¯Šæ–­æ¨ç† ====================
  
  function renderDiagnosisStage(data) {
    clinicalSession.currentStage = 'diagnosis_reasoning';
    updateClinicalProgress();
    updateStageProgress();
    
    $('#btn-next').prop('disabled', false).text('æäº¤è¯Šæ–­é€‰æ‹© â†’').removeClass('btn-warning').addClass('btn-info');
    updateStageCard('è¯Šæ–­æ¨ç†é˜¶æ®µ', 'diagnosis');
    
    var html = '<div class="diagnosis-stage">';
    
    // æ£€æŸ¥ç»“æœå±•ç¤º - å°å¡ç‰‡å½¢å¼
    html += '<div class="examination-results mb-4">';
    html += '<h5 class="text-primary mb-3"><i class="fas fa-microscope me-2"></i> æ£€æŸ¥ç»“æœ</h5>';
    
    if (data.examination_results && data.examination_results.length > 0) {
      html += '<div class="row g-3">';
      data.examination_results.forEach(function(result) {
        html += '<div class="col-12">';
        html += '<div class="exam-result-card">';
        
        // æ£€æŸ¥é¡¹ç›®å¤´éƒ¨
        html += '<div class="exam-header">';
        html += '<div class="d-flex align-items-center justify-content-between">';
        html += '<div class="exam-title">';
        html += '<i class="fas fa-eye text-primary me-2"></i>';
        html += '<span class="fw-bold text-dark">' + result.name + '</span>';
        html += '</div>';
        // ç§»é™¤æ¨èæ£€æŸ¥æ ‡ç­¾ï¼Œé¿å…éšæ€§æç¤º
        // if (result.is_recommended) {
        //   html += '<span class="badge bg-success">æ¨èæ£€æŸ¥</span>';
        // }
        html += '</div>';
        html += '</div>';
        
        // æ£€æŸ¥ç»“æœå†…å®¹
        html += '<div class="exam-content">';
        html += '<div class="result-label">æ£€æŸ¥ç»“æœ</div>';
        html += '<div class="result-text">' + (result.result || 'æœªè®°å½•') + '</div>';
        html += '</div>';
        
        html += '</div>';
        html += '</div>';
      });
      html += '</div>';
    } else {
      html += '<div class="alert alert-warning border-0 bg-warning bg-opacity-10">';
      html += '<i class="fas fa-exclamation-triangle text-warning me-2"></i>';
      html += 'æš‚æ— æ£€æŸ¥ç»“æœæ•°æ®';
      html += '</div>';
    }
    html += '</div>';
    
    // è¯Šæ–­é€‰é¡¹ - Layout Version 2.0
    console.log('Rendering diagnosis options - Layout Updated at ' + new Date().toLocaleString());
    html += '<div class="diagnosis-options">';
    html += '<h4 class="text-info mb-4" style="font-weight: 700; display: flex; align-items: center;">';
    html += '<i class="fas fa-user-md me-2" style="font-size: 1.3rem; color: #17a2b8;"></i>é‰´åˆ«è¯Šæ–­';
    html += '</h4>';
    html += '<div class="alert alert-info" style="background: linear-gradient(135deg, #d1ecf1 0%, #bee5eb 100%); border: none; border-radius: 12px; padding: 20px;">';
    html += '<h5 class="mb-3" style="color: #0c5460; font-weight: 700; display: flex; align-items: center;">';
    html += '<i class="fas fa-brain me-2" style="font-size: 1.2rem; color: #6f42c1;"></i>è¯Šæ–­æ€ç»´æŒ‡å¯¼';
    html += '</h5>';
    html += '<p class="mb-0" style="font-size: 1rem; line-height: 1.6; color: #0c5460;">ç»¼åˆæ‚£è€…ç—…å²å’Œæ£€æŸ¥ç»“æœï¼Œè¿›è¡Œé‰´åˆ«è¯Šæ–­ã€‚ä»”ç»†åˆ†ææ¯ä¸ªè¯Šæ–­çš„ç¬¦åˆåº¦ï¼Œé€‰æ‹©æœ€å¯èƒ½çš„è¯Šæ–­é€‰é¡¹ã€‚</p>';
    html += '</div>';
    
    // å¦‚æœåç«¯æ²¡æœ‰è¯Šæ–­é€‰é¡¹ï¼Œåˆ›å»ºåŸºäºæ¡ˆä¾‹çš„ä¸´åºŠè¯Šæ–­é€‰é¡¹
    var diagnosisOptions = data.diagnosis_options;
    if (!diagnosisOptions || diagnosisOptions.length === 0) {
      // åŸºäºçœ¼åº•å‡ºè¡€ç—…ä¾‹çš„å¸¸è§è¯Šæ–­é€‰é¡¹
      diagnosisOptions = [
        {
          id: 1,
          name: 'ç³–å°¿ç—…è§†ç½‘è†œç—…å˜',
          code: 'H36.0',
          description: 'ç³–å°¿ç—…å¼•èµ·çš„è§†ç½‘è†œå¾®è¡€ç®¡ç—…å˜ï¼Œå‡ºç°å‡ºè¡€ã€æ¸—å‡ºç­‰',
          probability_score: 0.75,
          is_correct: false
        },
        {
          id: 2, 
          name: 'é«˜è¡€å‹æ€§è§†ç½‘è†œç—…å˜',
          code: 'H35.0',
          description: 'é«˜è¡€å‹å¼•èµ·çš„è§†ç½‘è†œè¡€ç®¡æ”¹å˜ï¼Œå¯è§å‡ºè¡€ã€æ¸—å‡º',
          probability_score: 0.65,
          is_correct: false
        },
        {
          id: 3,
          name: 'è§†ç½‘è†œé™è„‰é˜»å¡',
          code: 'H34.8',
          description: 'è§†ç½‘è†œé™è„‰è¡€æµå—é˜»ï¼Œå¯¼è‡´è§†ç½‘è†œå‡ºè¡€å’Œæ°´è‚¿',
          probability_score: 0.85,
          is_correct: true
        },
        {
          id: 4,
          name: 'Valsalvaè§†ç½‘è†œç—…å˜',
          code: 'H35.6',
          description: 'ç”¨åŠ›è¿‡åº¦å¼•èµ·çš„è§†ç½‘è†œè¡¨å±‚å‡ºè¡€ï¼Œå¤šè§äºå¹´è½»äºº',
          probability_score: 0.90,
          is_correct: true
        },
        {
          id: 5,
          name: 'å¤–ä¼¤æ€§è§†ç½‘è†œç—…å˜',
          code: 'S05.8',
          description: 'çœ¼å¤–ä¼¤å¯¼è‡´çš„è§†ç½‘è†œå‡ºè¡€ï¼Œéœ€è¯¢é—®å¤–ä¼¤å²',
          probability_score: 0.45,
          is_correct: false
        }
      ];
    }
    
    // ç¼“å­˜è¯Šæ–­é€‰é¡¹æ•°æ®
    clinicalSession.diagnosisOptions = diagnosisOptions;
    
    if (diagnosisOptions && diagnosisOptions.length > 0) {
      html += '<form id="diagnosis-form">';
      diagnosisOptions.forEach(function(option) {
        // Layout Version 2.0 - Updated structure for better alignment
        html += '<div class="card diagnosis-option mb-3" data-diagnosis-id="' + option.id + '" data-layout-version="2.0" style="border: 2px solid transparent; transition: all 0.3s ease;">';
        html += '<div class="card-body">';
        html += '<div class="d-flex align-items-center mb-2">';
        html += '<input class="form-check-input diagnosis-checkbox me-3" type="checkbox" name="diagnosis" ';
        html += 'value="' + option.id + '" id="diag_' + option.id + '" style="flex-shrink: 0; margin-top: 0;">';
        html += '<label class="form-check-label me-3" for="diag_' + option.id + '" style="cursor: pointer; flex-grow: 1;">';
        html += '<h6 class="mb-0" style="color: #2c3e50; font-weight: 600;">' + option.name + '</h6>';
        html += '</label>';
        if (option.probability_score !== undefined) {
          var percentage = (option.probability_score * 100).toFixed(0);
          var badgeClass = percentage >= 80 ? 'badge-success' : percentage >= 60 ? 'badge-warning' : 'badge-secondary';
          html += '<span class="badge ' + badgeClass + '" style="flex-shrink: 0;">ç¬¦åˆåº¦: ' + percentage + '%</span>';
        }
        html += '</div>';
        if (option.code) {
          html += '<div class="text-muted small mb-1" style="margin-left: 2.5rem;"><i class="fas fa-code me-1"></i>ICD: ' + option.code + '</div>';
        }
        if (option.description) {
          html += '<div class="text-muted small" style="line-height: 1.4; margin-left: 2.5rem;">' + option.description + '</div>';
        }
        html += '</div>';
        html += '</div>';
        html += '</div>';
      });
      html += '</form>';
    } else {
      html += '<div class="alert alert-warning">æš‚æ— è¯Šæ–­é€‰é¡¹æ•°æ®</div>';
    }
    
    html += '</div>';
    html += '</div>';
    
    $('#stage-content').html(html);
    
    // æ¢å¤ä¹‹å‰çš„é€‰æ‹©çŠ¶æ€ï¼ˆå¦‚æœæœ‰çš„è¯ï¼‰
    if (clinicalSession.selectedDiagnosis) {
      $('input[name="diagnosis"][value="' + clinicalSession.selectedDiagnosis + '"]').prop('checked', true);
      $('.diagnosis-option[data-diagnosis-id="' + clinicalSession.selectedDiagnosis + '"]').addClass('selected');
    }
    
    // ç»‘å®šè¯Šæ–­é€‰æ‹©äº‹ä»¶
    bindDiagnosisEvents();
    showClinicalThinkingPrompt('diagnosis');
    
    // ç¡®ä¿æŒ‰é’®çŠ¶æ€æ­£ç¡® - è¯Šæ–­é˜¶æ®µæŒ‰é’®åº”å§‹ç»ˆå¯ç”¨
    setTimeout(function() {
      ensureButtonEnabled();
    }, 100);
  }
  
  function bindDiagnosisEvents() {
    $('.diagnosis-checkbox').off('change').on('change', function() {
      var diagnosisId = parseInt($(this).val());
      var $card = $(this).closest('.diagnosis-option');
      var isChecked = $(this).is(':checked');
      
      console.log('=== é‰´åˆ«è¯Šæ–­é€‰æ‹©äº‹ä»¶è§¦å‘ ===');
      console.log('é€‰ä¸­çš„è¯Šæ–­ID:', diagnosisId);
      console.log('æ˜¯å¦é€‰ä¸­:', isChecked);
      
      // åˆå§‹åŒ–é€‰ä¸­çš„è¯Šæ–­æ•°ç»„
      if (!clinicalSession.selectedDiagnoses) {
        clinicalSession.selectedDiagnoses = [];
      }
      
      if (isChecked) {
        // æ·»åŠ é€‰ä¸­çŠ¶æ€
        $card.addClass('selected');
        if (!clinicalSession.selectedDiagnoses.includes(diagnosisId)) {
          clinicalSession.selectedDiagnoses.push(diagnosisId);
        }
        // è®°å½•é€‰æ‹©
        var diagnosisName = $(this).siblings('label').find('h6').text();
        addToLearningTimeline('é€‰æ‹©é‰´åˆ«è¯Šæ–­', diagnosisName);
      } else {
        // ç§»é™¤é€‰ä¸­çŠ¶æ€
        $card.removeClass('selected');
        clinicalSession.selectedDiagnoses = clinicalSession.selectedDiagnoses.filter(id => id !== diagnosisId);
      }
      
      console.log('å½“å‰é€‰ä¸­çš„é‰´åˆ«è¯Šæ–­:', clinicalSession.selectedDiagnoses);
      
      // æ›´æ–°æŒ‰é’®çŠ¶æ€
      if (clinicalSession.selectedDiagnoses.length > 0) {
        $('#btn-next').removeClass('disabled').addClass('btn-info');
        console.log('âœ… å·²é€‰æ‹©', clinicalSession.selectedDiagnoses.length, 'ä¸ªé‰´åˆ«è¯Šæ–­');
      } else {
        $('#btn-next').addClass('disabled').removeClass('btn-info');
        console.log('âŒ æœªé€‰æ‹©ä»»ä½•è¯Šæ–­');
      }
      
      // æä¾›å³æ—¶åé¦ˆ
      showFeedbackMessage('âœ… è¯Šæ–­å·²é€‰æ‹©ï¼š' + diagnosisName + 'ã€‚ä½ çš„è¯Šæ–­æ€è·¯å¾ˆæ¸…æ™°ï¼Œå¯ä»¥ç‚¹å‡»æäº¤æŒ‰é’®ç»§ç»­', 'success');
      
      // æŒ‰é’®å§‹ç»ˆä¿æŒå¯ç”¨çŠ¶æ€
      ensureButtonEnabled();
      console.log('è¯Šæ–­å·²é€‰æ‹©ï¼ŒæŒ‰é’®ä¿æŒå¯ç”¨:', clinicalSession.selectedDiagnosis);
    });
    
    $('.diagnosis-option').off('click').on('click', function(e) {
      console.log('è¯Šæ–­é€‰é¡¹å¡ç‰‡è¢«ç‚¹å‡»:', $(this));
      if (e.target.type !== 'checkbox') {
        var checkbox = $(this).find('.diagnosis-checkbox');
        console.log('æ‰¾åˆ°çš„checkboxæŒ‰é’®:', checkbox);
        checkbox.prop('checked', !checkbox.prop('checked')).trigger('change');
      }
    });
  }
  
  // ==================== å½±åƒæ£€æŸ¥æ¸²æŸ“å‡½æ•° ====================
  
  // OCTæ£€æŸ¥å›¾åƒæ¸²æŸ“
  function renderOctImages(resultData) {
    var html = '';
    
    html += '<div class="oct-examination-display">';
    html += '<div class="oct-header mb-3">';
    html += '<div class="alert alert-info border-0" style="background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);">';
    html += '<div class="d-flex align-items-center">';
    html += '<i class="fas fa-microscope text-primary me-3" style="font-size: 1.5rem;"></i>';
    html += '<div>';
    html += '<h6 class="mb-1" style="color: #1565c0;">OCTå…‰å­¦ç›¸å¹²æ–­å±‚æ‰«æ</h6>';
    html += '<small class="text-muted">è¯·ä»”ç»†è§‚å¯Ÿè§†ç½‘è†œå„å±‚ç»“æ„å’Œç—…ç†æ”¹å˜</small>';
    html += '</div>';
    html += '</div>';
    html += '</div>';
    html += '</div>';
    
    // OCTæµ‹é‡æ•°æ®æ˜¾ç¤ºï¼ˆå¦‚æœæœ‰ï¼‰
    if (resultData.oct_measurement_data) {
      html += '<div class="oct-measurements mb-4">';
      html += '<h6 class="text-primary mb-3"><i class="fas fa-ruler me-2"></i>æµ‹é‡æ•°æ®</h6>';
      html += '<div class="row g-3">';
      
      Object.keys(resultData.oct_measurement_data).forEach(function(key) {
        var value = resultData.oct_measurement_data[key];
        var displayName = getOctMeasurementDisplayName(key);
        html += '<div class="col-md-4 col-6">';
        html += '<div class="measurement-card p-3 bg-light rounded border">';
        html += '<div class="measurement-label small text-muted mb-1">' + displayName + '</div>';
        html += '<div class="measurement-value h6 mb-0 text-primary">' + value + '</div>';
        html += '</div>';
        html += '</div>';
      });
      
      html += '</div>';
      html += '</div>';
    }
    
    // åŒçœ¼å¯¹æ¯”æ˜¾ç¤º
    html += '<div class="oct-images-display">';
    html += '<div class="row g-4">';
    
    // å¤„ç†å›¾åƒæ•°ç»„
    var leftEyeImages = [];
    var rightEyeImages = [];
    
    resultData.images.forEach(function(image) {
      var imageObj = typeof image === 'string' ? {url: image} : image;
      
      if (imageObj.eye === 'left' || imageObj.label === 'å·¦çœ¼' || 
          (imageObj.description && imageObj.description.indexOf('å·¦çœ¼') !== -1)) {
        leftEyeImages.push(imageObj);
      } else if (imageObj.eye === 'right' || imageObj.label === 'å³çœ¼' || 
                (imageObj.description && imageObj.description.indexOf('å³çœ¼') !== -1)) {
        rightEyeImages.push(imageObj);
      } else {
        // å¦‚æœæ— æ³•ç¡®å®šï¼Œé»˜è®¤æŒ‰é¡ºåºåˆ†é…
        if (leftEyeImages.length <= rightEyeImages.length) {
          leftEyeImages.push(imageObj);
        } else {
          rightEyeImages.push(imageObj);
        }
      }
    });
    
    // å·¦çœ¼æ˜¾ç¤º
    if (leftEyeImages.length > 0) {
      html += '<div class="col-md-6">';
      html += '<div class="eye-section">';
      html += '<h6 class="text-center mb-3 p-2 bg-primary text-white rounded">';
      html += '<i class="fas fa-eye me-2"></i>å·¦çœ¼ OCT</h6>';
      
      leftEyeImages.forEach(function(image) {
        html += '<div class="oct-image-container mb-3">';
        html += '<div class="position-relative">';
        html += '<img src="' + (image.url || image) + '" class="img-fluid rounded oct-image" ';
        html += 'style="width: 100%; cursor: zoom-in; border: 2px solid #dee2e6;" ';
        html += 'data-bs-toggle="modal" data-bs-target="#octImageModal" ';
        html += 'data-image-src="' + (image.url || image) + '" ';
        html += 'data-eye="left">';
        
        // å›¾åƒæ ‡æ³¨å±‚
        html += '<div class="image-overlay d-none">';
        html += '<div class="overlay-controls">';
        html += '<button class="btn btn-sm btn-light me-2" onclick="toggleImageAnnotations(this)">';
        html += '<i class="fas fa-tags"></i> æ ‡æ³¨</button>';
        html += '<button class="btn btn-sm btn-light" onclick="toggleImageMeasurement(this)">';
        html += '<i class="fas fa-ruler"></i> æµ‹é‡</button>';
        html += '</div>';
        html += '</div>';
        
        html += '</div>';
        
        if (image.description) {
          html += '<p class="text-muted small mt-2 text-center">' + image.description + '</p>';
        }
        html += '</div>';
      });
      
      html += '</div>';
      html += '</div>';
    }
    
    // å³çœ¼æ˜¾ç¤º
    if (rightEyeImages.length > 0) {
      html += '<div class="col-md-6">';
      html += '<div class="eye-section">';
      html += '<h6 class="text-center mb-3 p-2 bg-success text-white rounded">';
      html += '<i class="fas fa-eye me-2"></i>å³çœ¼ OCT</h6>';
      
      rightEyeImages.forEach(function(image) {
        html += '<div class="oct-image-container mb-3">';
        html += '<div class="position-relative">';
        html += '<img src="' + (image.url || image) + '" class="img-fluid rounded oct-image" ';
        html += 'style="width: 100%; cursor: zoom-in; border: 2px solid #dee2e6;" ';
        html += 'data-bs-toggle="modal" data-bs-target="#octImageModal" ';
        html += 'data-image-src="' + (image.url || image) + '" ';
        html += 'data-eye="right">';
        
        // å›¾åƒæ ‡æ³¨å±‚
        html += '<div class="image-overlay d-none">';
        html += '<div class="overlay-controls">';
        html += '<button class="btn btn-sm btn-light me-2" onclick="toggleImageAnnotations(this)">';
        html += '<i class="fas fa-tags"></i> æ ‡æ³¨</button>';
        html += '<button class="btn btn-sm btn-light" onclick="toggleImageMeasurement(this)">';
        html += '<i class="fas fa-ruler"></i> æµ‹é‡</button>';
        html += '</div>';
        html += '</div>';
        
        html += '</div>';
        
        if (image.description) {
          html += '<p class="text-muted small mt-2 text-center">' + image.description + '</p>';
        }
        html += '</div>';
      });
      
      html += '</div>';
      html += '</div>';
    }
    
    html += '</div>';
    html += '</div>';
    
    // OCTæŠ¥å‘Šæ–‡å­—ï¼ˆå¦‚æœæœ‰ï¼‰
    if (resultData.oct_report_text) {
      html += '<div class="oct-report mt-4">';
      html += '<h6 class="text-primary mb-3"><i class="fas fa-file-medical-alt me-2"></i>OCTæŠ¥å‘Š</h6>';
      html += '<div class="report-content p-4 bg-light rounded border-start border-primary border-4">';
      html += '<div class="report-text" style="line-height: 1.8; font-size: 0.95rem;">';
      html += resultData.oct_report_text.replace(/\n/g, '<br>');
      html += '</div>';
      html += '</div>';
      html += '</div>';
    }
    
    html += '</div>';
    
    return html;
  }
  
  // æ ‡å‡†æ£€æŸ¥å›¾åƒæ¸²æŸ“
  function renderStandardImages(resultData) {
    var html = '';
    
    html += '<div class="standard-images-display">';
    html += '<div class="row g-3">';
    
    resultData.images.forEach(function(image, index) {
      var imageObj = typeof image === 'string' ? {url: image} : image;
      var colClass = resultData.images.length === 1 ? 'col-12' : 
                    resultData.images.length === 2 ? 'col-md-6' : 'col-md-4';
      
      html += '<div class="' + colClass + ' mb-3">';
      html += '<div class="standard-image-container">';
      html += '<div class="position-relative">';
      html += '<img src="' + (imageObj.url || imageObj) + '" class="img-fluid rounded examination-image" ';
      html += 'style="max-height: 400px; width: 100%; object-fit: contain; cursor: zoom-in; border: 1px solid #dee2e6;" ';
      html += 'data-bs-toggle="modal" data-bs-target="#imageModal" ';
      html += 'data-image-src="' + (imageObj.url || imageObj) + '" ';
      html += 'data-image-index="' + index + '">';
      html += '</div>';
      
      if (imageObj.description) {
        html += '<p class="text-muted small mt-2 text-center">' + imageObj.description + '</p>';
      }
      
      // å›¾åƒæ‰€è§ï¼ˆå¦‚æœæœ‰ï¼‰
      if (imageObj.findings) {
        html += '<div class="image-findings mt-2 p-2 bg-light rounded">';
        html += '<small class="text-muted"><strong>å½±åƒæ‰€è§ï¼š</strong>' + imageObj.findings + '</small>';
        html += '</div>';
      }
      
      html += '</div>';
      html += '</div>';
    });
    
    html += '</div>';
    html += '</div>';
    
    return html;
  }
  
  // OCTæµ‹é‡æ•°æ®æ˜¾ç¤ºåç§°è½¬æ¢
  function getOctMeasurementDisplayName(key) {
    var displayNames = {
      'central_thickness': 'ä¸­å¿ƒå‡¹åšåº¦',
      'average_thickness': 'å¹³å‡åšåº¦',
      'volume': 'é»„æ–‘ä½“ç§¯',
      'rnfl_superior': 'ä¸Šæ–¹RNFLåšåº¦',
      'rnfl_inferior': 'ä¸‹æ–¹RNFLåšåº¦',
      'rnfl_nasal': 'é¼»ä¾§RNFLåšåº¦',
      'rnfl_temporal': 'é¢ä¾§RNFLåšåº¦',
      'cup_disc_ratio': 'æ¯ç›˜æ¯”',
      'rim_area': 'è§†ç›˜ç¼˜é¢ç§¯'
    };
    return displayNames[key] || key;
  }
  
  // ==================== å·¥å…·å‡½æ•° ====================
  
  function getCsrfToken() {
    // å°è¯•ä»cookieè·å–CSRF token
    var cookieValue = null;
    if (document.cookie && document.cookie !== '') {
      var cookies = document.cookie.split(';');
      for (var i = 0; i < cookies.length; i++) {
        var cookie = cookies[i].trim();
        if (cookie.substring(0, 10) === 'csrftoken=') {
          cookieValue = decodeURIComponent(cookie.substring(10));
          break;
        }
      }
    }
    return cookieValue;
  }

  function submitDiagnosis() {
    console.log('=== å¼€å§‹æäº¤é‰´åˆ«è¯Šæ–­ ===');
    console.log('å½“å‰é€‰ä¸­è¯Šæ–­IDs:', clinicalSession.selectedDiagnoses);
    console.log('æ¡ˆä¾‹ID:', clinicalSession.caseId);
    
    // æ£€æŸ¥æ˜¯å¦é€‰æ‹©äº†è¯Šæ–­
    if (!clinicalSession.selectedDiagnoses || clinicalSession.selectedDiagnoses.length === 0) {
      showFeedbackMessage('è¯·è‡³å°‘é€‰æ‹©ä¸€ä¸ªè¯Šæ–­é€‰é¡¹', 'warning');
      return;
    }
    
    // æ˜¾ç¤ºæäº¤ä¸­çŠ¶æ€
    $('#btn-next').prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i> æäº¤ä¸­...');
    showFeedbackMessage('æ­£åœ¨æäº¤é‰´åˆ«è¯Šæ–­é€‰æ‹©...', 'info');
    
    // å‡†å¤‡æäº¤æ•°æ® - æ”¯æŒå¤šä¸ªè¯Šæ–­
    // è¯Šæ–­ä¾æ®ï¼šä¼˜å…ˆä½¿ç”¨è¯Šæ–­é˜¶æ®µä¸“ç”¨è¾“å…¥æ¡†ï¼ˆ#diagnosis-rationale-textï¼‰ï¼Œé¿å…è¯¯è¯»ä¸ºä¸´åºŠç¬”è®°
    var diagnosisRationale = ($('#diagnosis-rationale-text').val() || '').trim();
    var rationaleSource = 'diagnosis-rationale-text';
    if (!diagnosisRationale) {
      diagnosisRationale = ($('#clinical-notes').val() || '').trim();
      rationaleSource = 'clinical-notes';
    }
    console.log('è¯Šæ–­ä¾æ®æ¥æº:', rationaleSource, 'é•¿åº¦:', diagnosisRationale.length);

    // å…ˆåœ¨å‰ç«¯ç¼“å­˜ä¸€ä»½ï¼Œé¿å…åç»­å¤ç›˜å±•ç¤ºç©ºç™½
    clinicalSession.reviewDiagnosisRationale = diagnosisRationale;

    var submitData = {
      case_id: clinicalSession.caseId,
      selected_diagnosis_ids: clinicalSession.selectedDiagnoses,  // æ”¹ä¸ºæ•°ç»„
      // å…¼å®¹ä¸¤å¥—åç«¯æ¥å£ï¼šviews.submit_diagnosis_choice ä½¿ç”¨ reasoningï¼›diagnosis_views.submit_diagnosis ä½¿ç”¨ diagnosis_rationale
      reasoning: diagnosisRationale,
      diagnosis_rationale: diagnosisRationale
    };
    
    console.log('æäº¤æ•°æ®:', submitData);
    
    $.ajax({
      url: '/api/clinical/submit-diagnosis/',
      method: 'POST',
      contentType: 'application/json',
      headers: {
        'X-CSRFToken': $('[name=csrfmiddlewaretoken]').val() || getCsrfToken()
      },
      data: JSON.stringify(submitData),
      success: function(resp) {
        console.log('è¯Šæ–­æäº¤æˆåŠŸå“åº”:', resp);
        console.log('å½“å‰é˜¶æ®µ:', resp.data?.current_stage);
        console.log('å°è¯•æ¬¡æ•°:', resp.data?.attempt_count);
        console.log('æŒ‡å¯¼çº§åˆ«:', resp.data?.guidance_level);
        
        if (resp.success) {
          // æ›´æ–°åˆ†æ•°
          if (resp.data.diagnosis_score !== undefined) {
            clinicalSession.scores.diagnosis = resp.data.diagnosis_score;
            $('#current-score').text(resp.data.diagnosis_score.toFixed(1));
          }
          
          // æ£€æŸ¥è¯Šæ–­æ˜¯å¦å®Œå…¨æ­£ç¡®
          if (resp.data.current_stage === 'treatment_selection') {
            // è¯Šæ–­å®Œå…¨æ­£ç¡®ï¼Œè¿›å…¥æ²»ç–—é˜¶æ®µ
            $('#btn-next').prop('disabled', false).html('ä¸‹ä¸€æ­¥ <i class="fas fa-arrow-right"></i>');
            
            // è®°å½•è¯Šæ–­é˜¶æ®µå®Œæˆ
            var selectedDiagNames = resp.data.selected_diagnoses.map(d => d.name).join(', ');
            addToLearningTimeline('å®Œæˆé‰´åˆ«è¯Šæ–­', selectedDiagNames);
            
            // æ˜¾ç¤ºæˆåŠŸåé¦ˆ
            if (resp.data.diagnosis_feedback) {
              showFeedbackMessage(resp.data.diagnosis_feedback, 'success');
            }
            
            // è¿›å…¥æ²»ç–—é˜¶æ®µ
            renderTreatmentStage(resp.data);
            // è§†è§‰åé¦ˆ
            flashCard($('#feedback-panel'), 'success');
            launchConfetti(20);
            
          } else {
            // è¯Šæ–­ä¸å®Œå…¨æ­£ç¡®ï¼Œæä¾›æŒ‡å¯¼å¹¶å…è®¸é‡æ–°é€‰æ‹©
            $('#btn-next').prop('disabled', false).html('é‡æ–°æäº¤è¯Šæ–­ â†’').removeClass('btn-success').addClass('btn-warning');
            
            // æ˜¾ç¤ºæŒ‡å¯¼åé¦ˆ - ç¡®ä¿æ€»æ˜¯æ˜¾ç¤º
            var feedbackType = 'warning';
            if (resp.data.guidance_level === 1) {
              feedbackType = 'info';
            } else if (resp.data.guidance_level >= 2) {
              feedbackType = 'warning';
            }
            
            if (resp.data.diagnosis_feedback) {
              // ä½¿ç”¨å¤šè¡Œåé¦ˆæ˜¾ç¤º
              var feedbackHtml = resp.data.diagnosis_feedback.replace(/\n/g, '<br>');
              showFeedbackMessage(feedbackHtml, feedbackType);
            }
            
            // æ€»æ˜¯é‡æ–°æ¸²æŸ“è¯Šæ–­é€‰æ‹©ç•Œé¢ï¼ˆå³ä½¿æ²¡æœ‰æ–°é€‰é¡¹ï¼‰
            if (resp.data.diagnosis_options) {
              renderDiagnosisOptionsWithGuidance(resp.data);
            } else {
              // å¦‚æœæ²¡æœ‰è¿”å›æ–°é€‰é¡¹ï¼Œè‡³å°‘æ›´æ–°å½“å‰ç•Œé¢çš„æŒ‡å¯¼ä¿¡æ¯
              console.log('æ²¡æœ‰è¿”å›æ–°çš„è¯Šæ–­é€‰é¡¹ï¼Œä¿æŒå½“å‰ç•Œé¢');
            }
            
            // è®°å½•å°è¯•æ¬¡æ•°
            addToLearningTimeline(`ç¬¬${resp.data.attempt_count}æ¬¡è¯Šæ–­å°è¯•`, 'éœ€è¦è°ƒæ•´é€‰æ‹©');
            
            // è§†è§‰åé¦ˆ
            flashCard($('#feedback-panel'), 'warning');
            
            // æ¸…ç©ºå½“å‰é€‰æ‹©ï¼Œè®©ç”¨æˆ·é‡æ–°é€‰æ‹©
            clinicalSession.selectedDiagnoses = [];
            $('.diagnosis-checkbox').prop('checked', false);
          }
          
        } else {
          showFeedbackMessage('æäº¤å¤±è´¥: ' + resp.message + 'ã€‚è¯·é‡æ–°é€‰æ‹©è¯Šæ–­', 'danger');
          // æ¢å¤æŒ‰é’®çŠ¶æ€ï¼Œå…è®¸ç”¨æˆ·é‡æ–°é€‰æ‹©
          $('#btn-next').prop('disabled', false).html('æäº¤è¯Šæ–­é€‰æ‹© â†’').removeClass('btn-primary').addClass('btn-info');
        }
      },
      error: function(xhr, status, error) {
        console.log('=== è¯Šæ–­æäº¤å¤±è´¥ ===');
        console.log('é”™è¯¯çŠ¶æ€:', status);
        console.log('é”™è¯¯ä¿¡æ¯:', error);
        console.log('å“åº”çŠ¶æ€ç :', xhr.status);
        console.log('å“åº”å†…å®¹:', xhr.responseText);
        console.log('====================');
        
        $('#btn-next').prop('disabled', false).html('æäº¤è¯Šæ–­é€‰æ‹© â†’').removeClass('btn-primary').addClass('btn-info');
        console.error('Submit diagnosis error:', error, xhr.responseText);
        
        if (xhr.status === 404) {
          showFeedbackMessage('APIæ¥å£æœªæ‰¾åˆ°ï¼Œè¯·æ£€æŸ¥åç«¯é…ç½®ã€‚è¯·é‡æ–°é€‰æ‹©è¯Šæ–­', 'danger');
        } else if (xhr.status === 403) {
          showFeedbackMessage('æƒé™ä¸è¶³ï¼Œè¯·é‡æ–°ç™»å½•ã€‚è¯·é‡æ–°é€‰æ‹©è¯Šæ–­', 'danger');
        } else if (xhr.status === 500) {
          showFeedbackMessage('æœåŠ¡å™¨å†…éƒ¨é”™è¯¯ï¼Œè¯·è”ç³»ç®¡ç†å‘˜ã€‚è¯·é‡æ–°é€‰æ‹©è¯Šæ–­', 'danger');
        } else {
          showFeedbackMessage('ç½‘ç»œé”™è¯¯ï¼Œè¯·æ£€æŸ¥è¿æ¥: ' + error + 'ã€‚è¯·é‡æ–°é€‰æ‹©è¯Šæ–­', 'danger');
        }
      }
    });
  }

  // é‡æ–°æ¸²æŸ“è¯Šæ–­é€‰æ‹©ç•Œé¢ï¼ŒåŒ…å«æ™ºèƒ½æŒ‡å¯¼
  function renderDiagnosisOptionsWithGuidance(data) {
    console.log('é‡æ–°æ¸²æŸ“è¯Šæ–­é€‰æ‹©ç•Œé¢ï¼ŒåŒ…å«æŒ‡å¯¼:', data);
    
    // æ›´æ–°è¯Šæ–­é€‰é¡¹åŒºåŸŸ
    var diagnosisHtml = '<div class="diagnosis-options-section">';
    
    // æŒ‡å¯¼çº§åˆ«æç¤º
    if (data.guidance_level > 0) {
      diagnosisHtml += '<div class="guidance-alert mb-4">';
      if (data.guidance_level === 1) {
        diagnosisHtml += '<div class="alert alert-info border-start border-4 border-info">';
        diagnosisHtml += '<h6 class="alert-heading"><i class="fas fa-lightbulb me-2"></i>å­¦ä¹ æŒ‡å¯¼</h6>';
      } else if (data.guidance_level === 2) {
        diagnosisHtml += '<div class="alert alert-warning border-start border-4 border-warning">';
        diagnosisHtml += '<h6 class="alert-heading"><i class="fas fa-compass me-2"></i>è¿›é˜¶æŒ‡å¯¼</h6>';
      } else {
        diagnosisHtml += '<div class="alert alert-primary border-start border-4 border-primary">';
        diagnosisHtml += '<h6 class="alert-heading"><i class="fas fa-graduation-cap me-2"></i>è¯¦ç»†æŒ‡å¯¼</h6>';
      }
      diagnosisHtml += '<p class="mb-0">ç¬¬' + data.attempt_count + 'æ¬¡å°è¯• - è¯·æ ¹æ®ä»¥ä¸‹æŒ‡å¯¼é‡æ–°é€‰æ‹©é‰´åˆ«è¯Šæ–­</p>';
      diagnosisHtml += '</div>';
      diagnosisHtml += '</div>';
    }
    
    // é‰´åˆ«è¯Šæ–­é€‰é¡¹
    diagnosisHtml += '<h4 class="text-primary mb-4" style="font-weight: 700; font-size: 1.5rem;">';
    diagnosisHtml += '<i class="fas fa-stethoscope me-2"></i>é‰´åˆ«è¯Šæ–­é€‰æ‹©';
    if (data.attempt_count > 1) {
      diagnosisHtml += ' <small class="text-muted">ï¼ˆé‡æ–°é€‰æ‹©ï¼‰</small>';
    }
    diagnosisHtml += '</h4>';
    
    diagnosisHtml += '<div class="alert alert-info border-0 bg-info bg-opacity-10 mb-4">';
    diagnosisHtml += '<h6 class="mb-2"><i class="fas fa-info-circle text-info me-2"></i>è¯Šæ–­æ€è·¯æŒ‡å¯¼</h6>';
    diagnosisHtml += '<p class="mb-0">è¯·ç»“åˆæ‚£è€…çš„ç—‡çŠ¶ã€ä½“å¾å’Œæ£€æŸ¥ç»“æœï¼Œé€‰æ‹©æœ€å¯èƒ½çš„é‰´åˆ«è¯Šæ–­ã€‚å¯ä»¥é€‰æ‹©å¤šä¸ªè¯Šæ–­é€‰é¡¹ã€‚</p>';
    diagnosisHtml += '</div>';
    
    // è¯Šæ–­é€‰é¡¹åˆ—è¡¨
    if (data.diagnosis_options && data.diagnosis_options.length > 0) {
      diagnosisHtml += '<div class="row g-3">';
      
      data.diagnosis_options.forEach(function(option, index) {
        diagnosisHtml += '<div class="col-lg-6">';
        diagnosisHtml += '<div class="diagnosis-option card h-100 shadow-sm" data-diagnosis-id="' + option.id + '">';
        diagnosisHtml += '<div class="card-body p-3">';
        
        // å¤é€‰æ¡†å’Œè¯Šæ–­åç§°
        diagnosisHtml += '<div class="d-flex align-items-start mb-2">';
        diagnosisHtml += '<input class="form-check-input diagnosis-checkbox me-3" type="checkbox" ';
        diagnosisHtml += 'value="' + option.id + '" id="diag_' + option.id + '"';
        
        // å¦‚æœä¹‹å‰é€‰æ‹©è¿‡ï¼Œä¿æŒé€‰ä¸­çŠ¶æ€
        if (clinicalSession.selectedDiagnoses && clinicalSession.selectedDiagnoses.includes(option.id)) {
          diagnosisHtml += ' checked';
        }
        
        diagnosisHtml += ' style="margin-top: 0.125rem;">';
        diagnosisHtml += '<div class="flex-grow-1">';
        diagnosisHtml += '<label class="form-check-label" for="diag_' + option.id + '">';
        diagnosisHtml += '<h6 class="mb-1">' + option.name + '</h6>';
        diagnosisHtml += '</label>';
        
        if (option.code) {
          diagnosisHtml += '<small class="text-muted">ICDç¼–ç : ' + option.code + '</small>';
        }
        
        // åœ¨æŒ‡å¯¼æ¨¡å¼ä¸‹æ˜¾ç¤ºæ­£ç¡®æ€§æç¤º
        if (data.guidance_level >= 3 && option.is_correct !== undefined) {
          if (option.is_correct) {
            diagnosisHtml += '<div class="mt-2">';
            diagnosisHtml += '<span class="badge bg-success"><i class="fas fa-check me-1"></i>æ­£ç¡®è¯Šæ–­</span>';
            diagnosisHtml += '</div>';
          }
        }
        
        diagnosisHtml += '</div>';
        diagnosisHtml += '</div>';
        
        diagnosisHtml += '</div>';
        diagnosisHtml += '</div>';
        diagnosisHtml += '</div>';
      });
      
      diagnosisHtml += '</div>';
    }
    
    diagnosisHtml += '</div>';
    
    // æ›´æ–°é¡µé¢å†…å®¹
    var currentHtml = $('#clinical-content').html();
    var updatedHtml = currentHtml.replace(/<div class="diagnosis-options-section">[\s\S]*?<\/div>/, diagnosisHtml);
    
    // å¦‚æœæ²¡æœ‰æ‰¾åˆ°è¦æ›¿æ¢çš„å†…å®¹ï¼Œç›´æ¥åœ¨è¯Šæ–­é˜¶æ®µéƒ¨åˆ†æ·»åŠ 
    if (updatedHtml === currentHtml) {
      // æŸ¥æ‰¾è¯Šæ–­ç›¸å…³åŒºåŸŸå¹¶æ›´æ–°
      var $clinicalContent = $('#clinical-content');
      $clinicalContent.find('.diagnosis-options-section').remove();
      $clinicalContent.find('.diagnosis-stage').append(diagnosisHtml);
    } else {
      $('#clinical-content').html(updatedHtml);
    }
    
    // é‡æ–°ç»‘å®šäº‹ä»¶å¤„ç†å™¨
    bindDiagnosisEvents();
    
    // æ»šåŠ¨åˆ°è¯Šæ–­é€‰é¡¹åŒºåŸŸ
    setTimeout(function() {
      $('.diagnosis-options-section')[0]?.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }, 100);
  }
  
  // ç»‘å®šè¯Šæ–­é€‰æ‹©äº‹ä»¶
  function bindDiagnosisEvents() {
    // è¯Šæ–­å¤é€‰æ¡†äº‹ä»¶
    $('.diagnosis-checkbox').off('change').on('change', function() {
      var diagnosisId = parseInt($(this).val());
      var isChecked = $(this).is(':checked');
      
      if (!clinicalSession.selectedDiagnoses) {
        clinicalSession.selectedDiagnoses = [];
      }
      
      if (isChecked) {
        if (!clinicalSession.selectedDiagnoses.includes(diagnosisId)) {
          clinicalSession.selectedDiagnoses.push(diagnosisId);
        }
      } else {
        clinicalSession.selectedDiagnoses = clinicalSession.selectedDiagnoses.filter(id => id !== diagnosisId);
      }
      
      console.log('æ›´æ–°è¯Šæ–­é€‰æ‹©:', clinicalSession.selectedDiagnoses);
      
      // æ›´æ–°æŒ‰é’®çŠ¶æ€
      if (clinicalSession.selectedDiagnoses.length > 0) {
        $('#btn-next').removeClass('btn-secondary').addClass('btn-warning').prop('disabled', false);
      } else {
        $('#btn-next').removeClass('btn-warning').addClass('btn-secondary').prop('disabled', true);
      }
    });
  }

  
  // ==================== æ²»ç–—é˜¶æ®µï¼šæ²»ç–—å†³ç­– ====================
  
  function renderTreatmentStage(data) {
    console.log('=== renderTreatmentStage è¢«è°ƒç”¨ ===');
    console.log('ä¼ å…¥çš„data:', data);
    console.log('treatment_options:', data.treatment_options);
    
    clinicalSession.currentStage = 'treatment_selection';
    
    // åŒæ­¥é˜¶æ®µåˆ°åç«¯
    syncStageToBackend('treatment_selection');
    
    // å¦‚æœè¿™æ˜¯ä»å…¶ä»–é˜¶æ®µå¯¼èˆªå›æ¥çš„ï¼Œä¸è¦æ¸…ç©ºé€‰æ‹©æ•°æ®
    // åªæœ‰åœ¨é¦–æ¬¡è¿›å…¥æ²»ç–—é˜¶æ®µæ—¶æ‰æ¸…ç©º
    if (!clinicalSession.treatmentOptions || clinicalSession.treatmentOptions.length === 0) {
      clinicalSession.selectedTreatments = [];
    }
    
    updateClinicalProgress();
    updateStageProgress();

    // æ²»ç–—é˜¶æ®µç¦æ­¢é—®è¯Šï¼šåŒæ­¥æ›´æ–°èŠå¤©è¾“å…¥æ¡†çš„ç¦ç”¨æç¤º
    if (typeof updateChatStatus === 'function') {
      updateChatStatus();
    }
    
    // æ˜¾ç¤ºå…¨å±å¸ƒå±€
    $('#history-collection-fullscreen').fadeIn(300);
    $('#traditional-layout').hide();
    
    // æ›´æ–°é¡¶éƒ¨æ ‡é¢˜æ 
    $('#history-collection-fullscreen .logo-circle + div h6').text('æ²»ç–—æ–¹æ¡ˆç³»ç»Ÿ');
    $('#history-collection-fullscreen .logo-circle + div small').text('æ²»ç–—æ–¹æ¡ˆé˜¶æ®µ');
    
    // ç¼“å­˜æ²»ç–—é€‰é¡¹æ•°æ®
    if (data.treatment_options) {
      clinicalSession.treatmentOptions = data.treatment_options;
    }
    
    // æ›´æ–°å·¦ä¾§é¢æ¿ - æ˜¾ç¤ºç¡®è¯Šç»“æœå’Œè¾…åŠ©æ£€æŸ¥æ±‡æ€»
    const leftPanel = $('#history-collection-fullscreen .col-6').eq(0);
    if (leftPanel.length) {
      let leftContent = '';
      
      // ç¡®è¯Šç»“æœåŒºåŸŸ
      leftContent += '<div class="card shadow-sm mb-2">';
      leftContent += '<div class="card-header bg-success text-white py-2">';
      leftContent += '<h6 class="mb-0 fw-bold"><i class="fas fa-check-circle me-2"></i>ç¡®è¯Šç»“æœ</h6>';
      leftContent += '</div>';
      leftContent += '<div class="card-body p-3">';

      // æ²»ç–—é˜¶æ®µâ€œç¡®è¯Šç»“æœâ€ä¼˜å…ˆä½¿ç”¨åç«¯å¤ç›˜æ•°æ®ï¼ˆå«åç§°ï¼‰ï¼Œå¦åˆ™å›é€€åˆ°å‰ç«¯ç¼“å­˜çš„åç§°æ˜ å°„ã€‚
      var diagnosisDisplayNames = [];
      try {
        if (Array.isArray(clinicalSession.reviewDiagnosisNames) && clinicalSession.reviewDiagnosisNames.length > 0) {
          diagnosisDisplayNames = clinicalSession.reviewDiagnosisNames.slice();
        } else if (Array.isArray(data.selected_diagnoses) && data.selected_diagnoses.length > 0) {
          // å…¼å®¹ä¸¤ç§æ ¼å¼ï¼š[{name, ...}, ...] æˆ– [id, id, ...]
          if (typeof data.selected_diagnoses[0] === 'object') {
            diagnosisDisplayNames = data.selected_diagnoses
              .map(function(d) { return d && (d.name || d.id); })
              .filter(function(x) { return typeof x !== 'undefined' && x !== null && String(x).trim() !== ''; })
              .map(function(x) { return String(x); });
          } else {
            diagnosisDisplayNames = data.selected_diagnoses.map(function(id) {
              return (clinicalSession.selectedDiagnosisNames && clinicalSession.selectedDiagnosisNames[id])
                ? clinicalSession.selectedDiagnosisNames[id]
                : String(id);
            });
          }
        } else if (Array.isArray(clinicalSession.selectedDiagnoses) && clinicalSession.selectedDiagnoses.length > 0) {
          diagnosisDisplayNames = clinicalSession.selectedDiagnoses.map(function(id) {
            return (clinicalSession.selectedDiagnosisNames && clinicalSession.selectedDiagnosisNames[id])
              ? clinicalSession.selectedDiagnosisNames[id]
              : String(id);
          });
        }
      } catch (eDx) {
        diagnosisDisplayNames = [];
      }

      if (diagnosisDisplayNames.length > 0) {
        diagnosisDisplayNames.forEach(function(name) {
          leftContent += '<div class="card border-success mb-2">';
          leftContent += '<div class="card-body py-2">';
          leftContent += '<h6 class="mb-1 text-success">' + name + '</h6>';
          leftContent += '</div></div>';
        });
      } else {
        leftContent += '<div class="text-muted text-center py-2">ï¼ˆæœªè®°å½•ï¼‰</div>';
      }
      
      leftContent += '</div></div>';
      
      // ä¿ç•™åŸæœ‰çš„ç—…å²ä¿¡æ¯é¢æ¿ï¼ˆä»ä¹‹å‰é˜¶æ®µè·å–ï¼‰
      let existingHistoryPanel = $('#history-summary-panel');
      if (existingHistoryPanel.length) {
        leftContent += existingHistoryPanel[0].outerHTML;
      }
      
      leftPanel.html(leftContent);
    }
    
    // æ›´æ–°å³ä¾§é¢æ¿ - æ²»ç–—æ–¹æ¡ˆé€‰æ‹©
    const rightPanel = $('#history-collection-fullscreen .col-6').eq(1);
    if (!rightPanel.length) {
      console.error('æœªæ‰¾åˆ°å³ä¾§é¢æ¿å®¹å™¨');
      return;
    }
    
    let treatmentContent = '';
    treatmentContent += '<div class="card shadow-sm d-flex flex-column w-100" style="height: 100%;">';
    treatmentContent += '<div class="card-header bg-success text-white py-2 flex-shrink-0">';
    treatmentContent += '<h6 class="mb-0 fw-bold">';
    treatmentContent += '<i class="fas fa-prescription-bottle-alt me-2"></i>æ²»ç–—æ–¹æ¡ˆé€‰æ‹©';
    treatmentContent += '</h6>';
    treatmentContent += '</div>';
    
    treatmentContent += '<div class="card-body p-3 flex-grow-1" style="overflow-y: auto; min-height: 0;">';
    treatmentContent += '<div class="alert alert-success mb-3">';
    treatmentContent += '<i class="fas fa-info-circle me-2"></i>';
    treatmentContent += 'æ ¹æ®è¯Šæ–­ç»“æœï¼Œè¯·é€‰æ‹©æœ€åˆé€‚çš„æ²»ç–—æ–¹æ¡ˆï¼ˆå¯å¤šé€‰ï¼‰ï¼Œå¹¶è¯´æ˜æ‚¨çš„æ²»ç–—ä¾æ®';
    treatmentContent += '</div>';
    
    if (clinicalSession.treatmentOptions && clinicalSession.treatmentOptions.length > 0) {
      console.log('å¼€å§‹æ¸²æŸ“æ²»ç–—é€‰é¡¹ï¼Œæ•°é‡:', clinicalSession.treatmentOptions.length);
      
      // æŒ‰æ²»ç–—ç±»å‹åˆ†ç»„
      var groupedTreatments = groupTreatmentsByType(clinicalSession.treatmentOptions);
      console.log('åˆ†ç»„åçš„æ²»ç–—é€‰é¡¹:', groupedTreatments);
      
      // æ²»ç–—é€‰é¡¹å®¹å™¨
      treatmentContent += '<div id="treatment-options-container">';
      
      Object.keys(groupedTreatments).forEach(function(type) {
        var typeOptions = groupedTreatments[type];
        var typeDisplayName = getTreatmentTypeDisplay(type);
        var typeIcon = getTreatmentTypeIcon(type);
        
        treatmentContent += '<div class="treatment-group mb-3">';
        treatmentContent += '<h6 class="text-primary fw-bold mb-2">';
        treatmentContent += '<i class="' + typeIcon + ' me-2"></i>' + typeDisplayName;
        treatmentContent += '</h6>';
        
        typeOptions.forEach(function(option) {
          treatmentContent += '<div class="card treatment-option-card border mb-2" data-treatment-id="' + option.id + '">';
          treatmentContent += '<div class="card-body p-2">';
          treatmentContent += '<div class="form-check">';
          treatmentContent += '<input class="form-check-input treatment-checkbox" type="checkbox" ';
          treatmentContent += 'value="' + option.id + '" id="treat_' + option.id + '">';
          treatmentContent += '<label class="form-check-label w-100" for="treat_' + option.id + '">';
          
          treatmentContent += '<div class="d-flex justify-content-between align-items-start">';
          treatmentContent += '<div class="flex-grow-1">';
          treatmentContent += '<h6 class="mb-1">' + option.name + '</h6>';
          
          if (option.description) {
            treatmentContent += '<p class="text-muted small mb-1">' + option.description + '</p>';
          }
          
          // æ˜¾ç¤ºç–—æ•ˆã€å®‰å…¨æ€§ã€æˆæœ¬ä¿¡æ¯
          treatmentContent += '<div class="small text-muted">';
          treatmentContent += '<i class="fas fa-chart-line text-primary me-1"></i>ç–—æ•ˆ: ' + (option.efficacy_score || 'ä¸­');
          treatmentContent += ' | <i class="fas fa-shield-alt text-success ms-1 me-1"></i>å®‰å…¨: ' + (option.safety_score || 'ä¸­');
          treatmentContent += ' | <i class="fas fa-dollar-sign text-warning ms-1 me-1"></i>æˆæœ¬: ' + (option.cost_score || 'ä¸­');
          treatmentContent += '</div>';
          
          if (option.expected_outcome) {
            treatmentContent += '<div class="text-info small mt-1">';
            treatmentContent += '<i class="fas fa-bullseye me-1"></i>' + option.expected_outcome;
            treatmentContent += '</div>';
          }
          
          treatmentContent += '</div>'; // flex-grow-1
          
          // æ˜¾ç¤ºç‰¹æ€§æ ‡ç­¾
          treatmentContent += '<div class="ms-2">';
          if (option.is_contraindicated) {
            treatmentContent += '<span class="badge bg-danger">ç¦å¿Œ</span>';
          }
          treatmentContent += '</div>';
          
          treatmentContent += '</div>'; // d-flex
          treatmentContent += '</label>';
          treatmentContent += '</div>'; // form-check
          treatmentContent += '</div>'; // card-body
          treatmentContent += '</div>'; // card
        });
        
        treatmentContent += '</div>'; // treatment-group
      });
      
      treatmentContent += '</div>'; // treatment-options-container
    } else {
      treatmentContent += '<div class="alert alert-warning">æš‚æ— æ²»ç–—æ–¹æ¡ˆæ•°æ®</div>';
    }
    
    // æ²»ç–—ä¾æ®è¾“å…¥
    treatmentContent += '<div class="mt-3">';
    treatmentContent += '<h6 class="text-primary fw-bold mb-2">';
    treatmentContent += '<i class="fas fa-pen me-2"></i>æ²»ç–—ä¾æ®<span class="text-danger">*</span>';
    treatmentContent += '</h6>';
    treatmentContent += '<div class="card border-primary">';
    treatmentContent += '<div class="card-body p-2">';
    treatmentContent += '<textarea class="form-control" id="treatment-rationale" rows="4" ';
    treatmentContent += 'placeholder="è¯·è¯¦ç»†è¯´æ˜æ‚¨é€‰æ‹©è¯¥æ²»ç–—æ–¹æ¡ˆçš„ä¾æ®&#10;1. ä¸ºä»€ä¹ˆé€‰æ‹©è¿™äº›æ²»ç–—æ–¹æ¡ˆï¼Ÿ&#10;2. æ²»ç–—çš„ç›®æ ‡æ˜¯ä»€ä¹ˆï¼Ÿ&#10;3. é¢„æœŸçš„æ²»ç–—æ•ˆæœå¦‚ä½•ï¼Ÿ" ';
    treatmentContent += 'maxlength="500"></textarea>';
    treatmentContent += '<div class="text-end mt-1">';
    treatmentContent += '<small class="text-muted" id="treatment-rationale-count">0 / 500 å­—</small>';
    treatmentContent += '</div>';
    treatmentContent += '</div>';
    treatmentContent += '</div>';
    treatmentContent += '</div>';
    
    // ç»Ÿè®¡ä¿¡æ¯
    treatmentContent += '<div class="card mt-2 border-info">';
    treatmentContent += '<div class="card-body p-2">';
    treatmentContent += '<div class="row text-center">';
    treatmentContent += '<div class="col-6">';
    treatmentContent += '<div class="text-muted small">å¯é€‰æ–¹æ¡ˆ</div>';
    treatmentContent += '<h5 class="mb-0 text-primary fw-bold">' + clinicalSession.treatmentOptions.length + '</h5>';
    treatmentContent += '</div>';
    treatmentContent += '<div class="col-6">';
    treatmentContent += '<div class="text-muted small">å·²é€‰æ–¹æ¡ˆ</div>';
    treatmentContent += '<h5 class="mb-0 text-success fw-bold" id="selected-treatment-count">0</h5>';
    treatmentContent += '</div>';
    treatmentContent += '</div>';
    treatmentContent += '</div>';
    treatmentContent += '</div>';

    treatmentContent += '</div>'; // card-bodyç»“æŸ
    
    // æ·»åŠ åº•éƒ¨æŒ‰é’®
    treatmentContent += '<div class="card-footer bg-light border-top flex-shrink-0">';
    treatmentContent += '<div class="d-flex justify-content-between align-items-center">';
    treatmentContent += '<button class="btn btn-outline-secondary" onclick="returnToDiagnosis()">';
    treatmentContent += '<i class="fas fa-arrow-left me-1"></i>è¿”å›è¯Šæ–­';
    treatmentContent += '</button>';
    treatmentContent += '<button class="btn btn-success" id="btn-submit-treatment" onclick="window.submitTreatments()" disabled>';
    treatmentContent += '<i class="fas fa-check-circle me-1"></i>æäº¤æ²»ç–—æ–¹æ¡ˆ';
    treatmentContent += '<i class="fas fa-arrow-right ms-1"></i>';
    treatmentContent += '</button>';
    treatmentContent += '</div>';
    treatmentContent += '</div>';
    
    treatmentContent += '</div>'; // cardç»“æŸ
    
    // æ›´æ–°å³ä¾§é¢æ¿å†…å®¹
    rightPanel.html(treatmentContent);
    
    console.log('æ²»ç–—æ–¹æ¡ˆç•Œé¢æ¸²æŸ“å®Œæˆ');
    
    // ç»‘å®šæ²»ç–—é€‰æ‹©äº‹ä»¶
    bindTreatmentEvents();
  }
  
  function groupTreatmentsByType(options) {
    var grouped = {};
    options.forEach(function(option) {
      var type = option.type || 'medication';
      if (!grouped[type]) {
        grouped[type] = [];
      }
      grouped[type].push(option);
    });
    return grouped;
  }
  
  function getTreatmentTypeDisplay(type) {
    var displays = {
      'medication': 'è¯ç‰©æ²»ç–—',
      'surgery': 'æ‰‹æœ¯æ²»ç–—',
      'observation': 'è§‚å¯Ÿéšè®¿',
      'referral': 'è½¬è¯Šæ²»ç–—',
      'education': 'å¥åº·æ•™è‚²'
    };
    return displays[type] || type;
  }
  
  function getTreatmentTypeIcon(type) {
    var icons = {
      'medication': 'fas fa-pills',
      'surgery': 'fas fa-scalpel-path',
      'observation': 'fas fa-eye',
      'referral': 'fas fa-hospital',
      'education': 'fas fa-graduation-cap'
    };
    return icons[type] || 'fas fa-medical-kit';
  }
  
  function bindTreatmentEvents() {
    // ç»‘å®šå¤é€‰æ¡†é€‰æ‹©äº‹ä»¶
    $('.treatment-checkbox').off('change').on('change', function() {
      var $card = $(this).closest('.treatment-option-card');
      var treatmentId = parseInt($(this).val());
      
      if ($(this).is(':checked')) {
        $card.addClass('border-success');
        if (!clinicalSession.selectedTreatments) {
          clinicalSession.selectedTreatments = [];
        }
        if (!clinicalSession.selectedTreatments.includes(treatmentId)) {
          clinicalSession.selectedTreatments.push(treatmentId);
        }
      } else {
        $card.removeClass('border-success');
        if (clinicalSession.selectedTreatments) {
          var index = clinicalSession.selectedTreatments.indexOf(treatmentId);
          if (index > -1) {
            clinicalSession.selectedTreatments.splice(index, 1);
          }
        }
      }
      
      updateTreatmentSelectionCount();
      updateTreatmentSubmitButton();
      console.log('å·²é€‰æ²»ç–—:', clinicalSession.selectedTreatments);
    });
    
    // ç»‘å®šæ²»ç–—ä¾æ®è¾“å…¥æ¡†çš„å­—æ•°ç»Ÿè®¡å’ŒæŒ‰é’®çŠ¶æ€æ›´æ–°
    $('#treatment-rationale').off('input').on('input', function() {
      var text = $(this).val();
      var length = text.length;
      var maxLength = 500;
      
      // æ›´æ–°å­—æ•°æ˜¾ç¤º
      $('#treatment-rationale-count').text(length + ' / ' + maxLength + ' å­—');
      
      // æ ¹æ®å­—æ•°æ”¹å˜é¢œè‰²
      if (length === 0) {
        $('#treatment-rationale-count').removeClass('text-success text-warning text-danger').addClass('text-muted');
      } else if (length < 20) {
        $('#treatment-rationale-count').removeClass('text-success text-danger text-muted').addClass('text-warning');
      } else if (length <= maxLength) {
        $('#treatment-rationale-count').removeClass('text-warning text-danger text-muted').addClass('text-success');
      } else {
        $('#treatment-rationale-count').removeClass('text-success text-warning text-muted').addClass('text-danger');
      }
      
      // é™åˆ¶æœ€å¤§é•¿åº¦
      if (length > maxLength) {
        $(this).val(text.substring(0, maxLength));
        $('#treatment-rationale-count').text(maxLength + ' / ' + maxLength + ' å­—');
      }
      
      updateTreatmentSubmitButton();
    });
  }
  
  // æ›´æ–°å·²é€‰æ²»ç–—æ•°é‡
  function updateTreatmentSelectionCount() {
    var selectedCount = $('.treatment-checkbox:checked').length;
    $('#selected-treatment-count').text(selectedCount);
  }
  
  // æ›´æ–°æäº¤æŒ‰é’®çŠ¶æ€
  function updateTreatmentSubmitButton() {
    var selectedCount = $('.treatment-checkbox:checked').length;
    var rationaleLength = ($('#treatment-rationale').val() || '').trim().length;
    var submitBtn = $('#btn-submit-treatment');
    
    if (selectedCount > 0 && rationaleLength >= 20) {
      submitBtn.prop('disabled', false);
    } else {
      submitBtn.prop('disabled', true);
    }
  }
  
  function updateTreatmentSummary() {
    // ç›´æ¥ä»DOMè·å–å®é™…é€‰æ‹©çŠ¶æ€ï¼Œé¿å…ä¼šè¯æ•°æ®æ±¡æŸ“
    var $checkedTreatments = $('.treatment-checkbox:checked');
    var selectedCount = $checkedTreatments.length;
    var optimalCount = 0;
    var efficacyScores = [];
    var safetyScores = [];
    
    // åŒæ—¶æ›´æ–°ä¼šè¯æ•°æ®ä»¥ä¿æŒä¸€è‡´æ€§
    clinicalSession.selectedTreatments = [];
    
    $checkedTreatments.each(function() {
      var treatmentId = $(this).val();
      var $card = $(this).closest('.treatment-option');
      
      // æ›´æ–°ä¼šè¯æ•°æ®
      clinicalSession.selectedTreatments.push(parseInt(treatmentId));
      
      if ($card.find('.badge-success').length > 0) {
        optimalCount++;
      }
      
      // ç®€å•çš„è¯„åˆ†é€»è¾‘
      var efficacyText = $card.find('.treatment-info').text();
      if (efficacyText.includes('ç–—æ•ˆ: é«˜')) efficacyScores.push(3);
      else if (efficacyText.includes('ç–—æ•ˆ: ä¸­')) efficacyScores.push(2);
      else efficacyScores.push(1);
      
      if (efficacyText.includes('å®‰å…¨: é«˜')) safetyScores.push(3);
      else if (efficacyText.includes('å®‰å…¨: ä¸­')) safetyScores.push(2);
      else safetyScores.push(1);
    });
    
    // è®¡ç®—å¹³å‡ç–—æ•ˆå’Œå®‰å…¨æ€§
    var avgEfficacy = efficacyScores.length > 0 ? efficacyScores.reduce((a, b) => a + b, 0) / efficacyScores.length : 0;
    var avgSafety = safetyScores.length > 0 ? safetyScores.reduce((a, b) => a + b, 0) / safetyScores.length : 0;
    
    var efficacyLevel = avgEfficacy >= 2.5 ? 'é«˜' : avgEfficacy >= 1.5 ? 'ä¸­' : 'ä½';
    var safetyLevel = avgSafety >= 2.5 ? 'é«˜' : avgSafety >= 1.5 ? 'ä¸­' : 'ä½';
    
    $('#selected-treatments-count').text(selectedCount);
    $('#optimal-treatments-count').text(optimalCount);
    $('#treatment-efficacy').text(efficacyLevel);
    $('#treatment-safety').text(safetyLevel);
  }
  
  function provideLiveTreatmentFeedback() {
    var selectedCount = clinicalSession.selectedTreatments.length;
    var feedback = '';
    
    if (selectedCount === 0) {
      feedback = '<div class="alert alert-info">è¯·å¼€å§‹é€‰æ‹©æ²»ç–—æ–¹æ¡ˆ</div>';
    } else if (selectedCount === 1) {
      feedback = '<div class="alert alert-warning">è€ƒè™‘æ˜¯å¦éœ€è¦è”åˆæ²»ç–—</div>';
    } else if (selectedCount > 5) {
      feedback = '<div class="alert alert-danger">æ²»ç–—æ–¹æ¡ˆè¿‡å¤šå¯èƒ½å¢åŠ å‰¯ä½œç”¨é£é™©</div>';
    } else {
      feedback = '<div class="alert alert-success" style="background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%); border: 2px solid #28a745; border-radius: 10px;">' +
                 '<div class="d-flex align-items-center">' +
                 '<i class="fas fa-star text-warning fs-4 me-3"></i>' +
                 '<div>' +
                 '<h6 class="mb-1 text-success">âœ¨ æ²»ç–—æ–¹æ¡ˆåˆç†ï¼</h6>' +
                 '<small class="text-success-emphasis">ä½ çš„æ²»ç–—é€‰æ‹©ä½“ç°äº†è‰¯å¥½çš„å¾ªè¯åŒ»å­¦æ€ç»´</small>' +
                 '</div>' +
                 '</div>' +
                 '</div>';
    }
    
    $('#feedback-panel').html(feedback);
  }

  window.submitTreatments = function() {
    // å…œåº•ï¼šä»»ä½•å¼‚å¸¸éƒ½è¦æ¢å¤æŒ‰é’®ï¼Œé¿å…â€œå¡ä½â€
    var $submitBtn = $('#btn-submit-treatment');
    if ($submitBtn.length === 0) $submitBtn = $('#btn-next');
    var restoreSubmitBtn = function() {
      try {
        if ($submitBtn && $submitBtn.length) {
          $submitBtn.prop('disabled', false)
            .html('<i class="fas fa-check-circle me-1"></i>æäº¤æ²»ç–—æ–¹æ¡ˆ<i class="fas fa-arrow-right ms-1"></i>')
            .removeClass('btn-primary').addClass('btn-success');
        }
      } catch (e) {}
    };

    try {
      console.log('=== æäº¤æ²»ç–—æ–¹æ¡ˆ ===');
      console.log('é€‰ä¸­çš„æ²»ç–—IDs:', clinicalSession.selectedTreatments);

      // éªŒè¯æ˜¯å¦é€‰æ‹©äº†æ²»ç–—æ–¹æ¡ˆ
      if (!clinicalSession.selectedTreatments || clinicalSession.selectedTreatments.length === 0) {
        showFeedbackMessage('è¯·è‡³å°‘é€‰æ‹©ä¸€ç§æ²»ç–—æ–¹æ¡ˆ', 'warning');
        return;
      }

      // è·å–æ²»ç–—ä¾æ®ï¼ˆç©ºå®‰å…¨ï¼‰
      var treatmentRationale = ($('#treatment-rationale').val() || '').trim();
      console.log('æ²»ç–—ä¾æ®é•¿åº¦:', treatmentRationale.length);

      // éªŒè¯æ²»ç–—ä¾æ®
      if (!treatmentRationale) {
        showFeedbackMessage('è¯·å¡«å†™æ²»ç–—ä¾æ®ä¸æ–¹æ¡ˆè¯´æ˜', 'warning');
        $('#treatment-rationale').focus();
        return;
      }

      // å…¼å®¹æ€§ï¼šä¸ä¾èµ– Number.isFinite
      var cfgMin = (window.CLINICAL_CONFIG && window.CLINICAL_CONFIG.TREATMENT_RATIONALE_MIN_CHARS);
      var minChars = (typeof cfgMin === 'number' && isFinite(cfgMin)) ? cfgMin : 20;
      if (treatmentRationale.length < minChars) {
        showFeedbackMessage('æ²»ç–—ä¾æ®è¿‡äºç®€çŸ­ï¼Œå»ºè®®è‡³å°‘' + minChars + 'å­—ä»¥ä¸Š', 'warning');
        $('#treatment-rationale').focus();
        return;
      }

      var csrfToken = $('[name=csrfmiddlewaretoken]').val() || (typeof getCsrfToken === 'function' ? getCsrfToken() : null);
      if (!csrfToken) {
        showFeedbackMessage('CSRFä»¤ç‰Œç¼ºå¤±ï¼Œè¯·åˆ·æ–°é¡µé¢åé‡è¯•', 'danger');
        return;
      }

      // æ˜¾ç¤ºæäº¤ä¸­çŠ¶æ€
      if ($submitBtn && $submitBtn.length) {
        $submitBtn.prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i> æäº¤ä¸­...');
      }
      showFeedbackMessage('æ­£åœ¨æäº¤æ²»ç–—æ–¹æ¡ˆ...', 'info');

      // å‡†å¤‡æäº¤æ•°æ®
      var submitData = {
        treatment_ids: clinicalSession.selectedTreatments,
        treatment_rationale: treatmentRationale
      };
      console.log('æäº¤æ•°æ®:', submitData);

      $.ajax({
        url: '/api/clinical/case/' + clinicalSession.caseId + '/submit-treatment/',
        method: 'POST',
        timeout: 20000,
        contentType: 'application/json',
        headers: {
          'X-CSRFToken': csrfToken
        },
        data: JSON.stringify(submitData),
        success: function(resp) {
        console.log('æ²»ç–—æäº¤å“åº”:', resp);
        
        if (resp.success) {
          // è®°å½•æœ¬æ¬¡æäº¤çš„æ²»ç–—ä¾æ®ï¼Œä¾›å­¦ä¹ åé¦ˆâ€œè¿‡ç¨‹å›é¡¾â€å±•ç¤º
          clinicalSession.treatmentRationale = treatmentRationale;

          // æ£€æŸ¥æ˜¯å¦å®Œå…¨æ­£ç¡®
          if (resp.data.is_perfect) {
            // å®Œå…¨æ­£ç¡®ï¼Œå¯ä»¥è¿›å…¥å­¦ä¹ åé¦ˆé˜¶æ®µ
            console.log('æ²»ç–—æ–¹æ¡ˆå®Œå…¨æ­£ç¡®ï¼');
            
            // è®°å½•æ²»ç–—é˜¶æ®µå®Œæˆ
            addToLearningTimeline('å®Œæˆæ²»ç–—é€‰æ‹©', 
              'é€‰æ‹©äº† ' + resp.data.correct_count + '/' + resp.data.total_optimal + ' ä¸ªæœ€ä½³æ²»ç–—æ–¹æ¡ˆ');
            
            // æ›´æ–°åˆ†æ•°
            clinicalSession.scores.treatment = resp.data.total_score;
            $('#current-score').text(resp.data.total_score.toFixed(1));
            
            // æ˜¾ç¤ºæˆåŠŸåé¦ˆ
            showFeedbackMessage('å¤ªæ£’äº†ï¼æ²»ç–—æ–¹æ¡ˆé€‰æ‹©å®Œå…¨æ­£ç¡®ï¼å¾—åˆ†: ' + resp.data.total_score.toFixed(1), 'success');
            
            // è¿›å…¥å­¦ä¹ åé¦ˆé˜¶æ®µ
            setTimeout(function() {
              clinicalSession.currentStage = 'learning_feedback';
              updateClinicalProgress();
              // è¿›å…¥å­¦ä¹ åé¦ˆå‰ï¼Œå¼ºåˆ¶ä»åç«¯åˆ·æ–°â€œè¿‡ç¨‹å›é¡¾â€è®°å½•ï¼ˆé¿å…æ˜¾ç¤ºæ— è®°å½•ï¼‰
              window.refreshReviewData(function() {
                showFinalFeedback(resp.data);
              });
              flashCard($('#stage-content'), 'success');
              launchConfetti(40);
            }, 2000);
            
          } else {
            // æœªå®Œå…¨æ­£ç¡®ï¼Œæ˜¾ç¤ºè¯¦ç»†åé¦ˆ
            console.log('æ²»ç–—æ–¹æ¡ˆæœªå®Œå…¨æ­£ç¡®');
            
            var feedbackHtml = '<div class="alert alert-warning mt-3">';
            feedbackHtml += '<h5><i class="fas fa-exclamation-triangle"></i> æ²»ç–—æ–¹æ¡ˆåé¦ˆ</h5>';
            feedbackHtml += '<p><strong>é€‰æ‹©æƒ…å†µï¼š</strong></p>';
            feedbackHtml += '<ul>';
            feedbackHtml += '<li>æ­£ç¡®é€‰æ‹©: ' + resp.data.correct_count + ' / ' + resp.data.total_optimal + '</li>';
            if (resp.data.incorrect_count > 0) {
              feedbackHtml += '<li class="text-danger">é”™è¯¯é€‰æ‹©: ' + resp.data.incorrect_count + '</li>';
            }
            feedbackHtml += '</ul>';
            feedbackHtml += '<p><strong>è¯„åˆ†è¯¦æƒ…ï¼š</strong></p>';
            feedbackHtml += '<ul>';
            feedbackHtml += '<li>æ²»ç–—é€‰æ‹©å¾—åˆ†: ' + resp.data.treatment_score.toFixed(1) + ' / 100</li>';
            feedbackHtml += '<li>æ²»ç–—ä¾æ®å¾—åˆ†: ' + resp.data.rationale_score.toFixed(1) + ' / 100</li>';
            feedbackHtml += '<li>æ€»åˆ†: ' + resp.data.total_score.toFixed(1) + ' / 100</li>';
            feedbackHtml += '</ul>';
            if (resp.data.feedback) {
              feedbackHtml += '<p><strong>åé¦ˆå»ºè®®ï¼š</strong></p>';
              feedbackHtml += '<p>' + resp.data.feedback.replace(/\n/g, '<br>') + '</p>';
            }
            feedbackHtml += '<p class="mb-0 mt-3"><strong>è¯·é‡æ–°é€‰æ‹©æ²»ç–—æ–¹æ¡ˆ</strong></p>';
            feedbackHtml += '</div>';
            
            $('#feedback-panel').html(feedbackHtml);
            
            // æ¢å¤æŒ‰é’®çŠ¶æ€
            restoreSubmitBtn();
          }
        } else {
          showFeedbackMessage('æäº¤å¤±è´¥: ' + resp.message, 'danger');
          restoreSubmitBtn();
        }
      },
      error: function(xhr, status, error) {
        restoreSubmitBtn();
        console.error('Submit treatment error:', status, error, xhr && xhr.status, xhr && xhr.responseText);
        
        if (status === 'timeout') {
          showFeedbackMessage('æäº¤è¶…æ—¶ï¼ˆç½‘ç»œæˆ–æœåŠ¡å™¨ç¹å¿™ï¼‰ï¼Œè¯·ç¨åé‡è¯•ã€‚', 'danger');
        } else if (xhr.status === 404) {
          showFeedbackMessage('APIæ¥å£æœªæ‰¾åˆ°ï¼Œè¯·æ£€æŸ¥åç«¯é…ç½®ã€‚è¯·é‡æ–°é€‰æ‹©æ²»ç–—æ–¹æ¡ˆ', 'danger');
        } else if (xhr.status === 403) {
          showFeedbackMessage('æƒé™ä¸è¶³ï¼Œè¯·é‡æ–°ç™»å½•ã€‚è¯·é‡æ–°é€‰æ‹©æ²»ç–—æ–¹æ¡ˆ', 'danger');
        } else if (xhr.status === 500) {
          showFeedbackMessage('æœåŠ¡å™¨å†…éƒ¨é”™è¯¯ï¼Œè¯·è”ç³»ç®¡ç†å‘˜ã€‚è¯·é‡æ–°é€‰æ‹©æ²»ç–—æ–¹æ¡ˆ', 'danger');
        } else {
          showFeedbackMessage('ç½‘ç»œé”™è¯¯ï¼Œè¯·æ£€æŸ¥è¿æ¥: ' + error + 'ã€‚è¯·é‡æ–°é€‰æ‹©æ²»ç–—æ–¹æ¡ˆ', 'danger');
        }
      }
    });
    } catch (e) {
      console.error('submitTreatments å‘ç”Ÿå¼‚å¸¸:', e);
      restoreSubmitBtn();
      showFeedbackMessage('æäº¤è¿‡ç¨‹å‡ºç°å¼‚å¸¸ï¼Œè¯·æ‰“å¼€æ§åˆ¶å°æŸ¥çœ‹é”™è¯¯å¹¶é‡è¯•ã€‚', 'danger');
    }
  };

  function showFinalFeedback(data) {
    clinicalSession.currentStage = 'learning_feedback';
    updateClinicalProgress();
    updateStageProgress();

    // å­¦ä¹ åé¦ˆé˜¶æ®µï¼šé€€å‡ºå…¨å±ï¼ˆæ²»ç–—/ç—…å²ï¼‰å¸ƒå±€ï¼Œç¡®ä¿åé¦ˆé¡µé¢å¯è§
    try {
      if (typeof hideHistoryCollectionLayout === 'function') {
        hideHistoryCollectionLayout();
      } else {
        $('#history-collection-fullscreen').hide();
        $('#traditional-layout').show().removeClass('d-none');
        $('body').css('overflow', 'auto');
      }
    } catch (e) {
      console.warn('åˆ‡æ¢åˆ°å­¦ä¹ åé¦ˆå¸ƒå±€æ—¶å‘ç”Ÿå¼‚å¸¸ï¼ˆå¯å¿½ç•¥ï¼‰:', e);
    }

    // å­¦ä¹ åé¦ˆç”¨äºå¸ˆç”Ÿå¤ç›˜ï¼šéšè—â€œè®°å½•ç¬”è®°â€è¾“å…¥åŒºï¼Œä»…ä¿ç•™æ—¶é—´çº¿
    try {
      $('#notes-tab').hide().removeClass('active');
      $('#notes-panel').hide().removeClass('show active');
      $('#timeline-tab').show().addClass('active');
      $('#timeline-panel').show().addClass('show active');
    } catch (e) {
      console.warn('éšè—ç¬”è®°åŒºå¤±è´¥ï¼ˆå¯å¿½ç•¥ï¼‰:', e);
    }

    // å­¦ä¹ åé¦ˆé˜¶æ®µï¼šéšè—æ‚£è€…å¯¹è¯èŠå¤©çª—å£
    try {
      $('#floating-chat-window-global').hide();
    } catch (e) {
      console.warn('éšè—èŠå¤©çª—å£å¤±è´¥ï¼ˆå¯å¿½ç•¥ï¼‰:', e);
    }

    // è®°å½•è¿›å…¥å­¦ä¹ åé¦ˆé˜¶æ®µçš„è®¡æ—¶ï¼ˆç”¨äºå±•ç¤ºæ²»ç–—é˜¶æ®µç”¨æ—¶ä¸æ€»è§ˆï¼‰
    try {
      if (typeof window.trackStageTransition === 'function') {
        window.trackStageTransition('learning_feedback');
      }
      // å¯é€‰ï¼šåŒæ­¥åˆ°åç«¯ï¼Œä¿è¯é˜¶æ®µä¸€è‡´
      if (typeof window.syncStageToBackend === 'function') {
        window.syncStageToBackend('learning_feedback');
      }
    } catch (e) {
      console.warn('è®°å½•å­¦ä¹ åé¦ˆé˜¶æ®µè®¡æ—¶å¤±è´¥ï¼ˆå¯å¿½ç•¥ï¼‰:', e);
    }
    
    updateStageCard('å­¦ä¹ å®Œæˆ', 'complete');
    
    // æ˜¾ç¤ºæœ€ç»ˆåé¦ˆï¼ˆä¾§æ /åé¦ˆåŒºï¼‰
    var overallText = (data && (data.overall_feedback || data.feedback)) || 'æ­å–œæ‚¨å®Œæˆäº†æœ¬æ¬¡ä¸´åºŠæ¨ç†å­¦ä¹ ï¼';
    var feedbackHtml = '<div class="alert alert-success feedback-animation">';
    feedbackHtml += '<h6><i class="fas fa-trophy"></i> å­¦ä¹ å®Œæˆï¼</h6>';
    feedbackHtml += overallText;
    feedbackHtml += '</div>';
    $('#feedback-panel').html(feedbackHtml);
    
    // ===== å­¦ä¹ åé¦ˆé¡µï¼šé‡æ–°è®¾è®¡ï¼ˆæ›´ç¾è§‚ã€æ›´æœ‰å±‚çº§ã€æ›´ä¾¿æ·ï¼‰ =====
    data = data || {};
    var safeText = function(v) {
      if (v === null || v === undefined) return '';
      if (typeof window.escapeHtml === 'function') return window.escapeHtml(String(v));
      return String(v)
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#39;');
    };
    var safeMultiline = function(v) { return safeText(v).replace(/\n/g, '<br>'); };

    var ex = (typeof clinicalSession.scores.examination === 'number') ? clinicalSession.scores.examination : 0;
    var dx = (typeof clinicalSession.scores.diagnosis === 'number') ? clinicalSession.scores.diagnosis : 0;
    var tx = (typeof clinicalSession.scores.treatment === 'number') ? clinicalSession.scores.treatment : 0;

    var hasBackendOverall = (data.scores && typeof data.scores.overall_score === 'number');
    var overallScore = hasBackendOverall
      ? data.scores.overall_score
      : (typeof clinicalSession.scores.overall === 'number' ? clinicalSession.scores.overall : null);

    // å…œåº•ï¼šå¦‚æœ overall åªæ˜¯é»˜è®¤ 0ï¼Œä½†åˆ†é¡¹å·²ç»æœ‰å€¼ï¼Œåˆ™æŒ‰æƒé‡å³æ—¶é‡ç®—
    // ç›®çš„ï¼šé¿å…â€œåˆ†é¡¹æ»¡åˆ†ä½†æ€»åˆ†=0â€çš„å±•ç¤ºé”™è¯¯
    var hasAnyComponent = (ex > 0 || dx > 0 || tx > 0);
    if ((overallScore === null || (!hasBackendOverall && overallScore === 0 && hasAnyComponent))) {
      overallScore = ex * 0.3 + dx * 0.5 + tx * 0.2;
    }
    if (typeof overallScore !== 'number' || isNaN(overallScore)) overallScore = 0;

    var grade = 'A', gradeColor = 'success', gradeHint = 'ä¼˜ç§€ï¼šæ¨ç†é“¾æ¡å®Œæ•´ï¼Œé€‰æ‹©å‡†ç¡®';
    if (overallScore < 60) {
      grade = 'D'; gradeColor = 'danger'; gradeHint = 'éœ€åŠ å¼ºï¼šå»ºè®®é‡ç‚¹å›é¡¾è¯Šæ–­ä¸æ²»ç–—ä¾æ®';
    } else if (overallScore < 70) {
      grade = 'C'; gradeColor = 'warning'; gradeHint = 'åŠæ ¼ï¼šå»ºè®®è¡¥å¼ºå…³é”®é‰´åˆ«ç‚¹ä¸é€‚åº”è¯';
    } else if (overallScore < 85) {
      grade = 'B'; gradeColor = 'info'; gradeHint = 'è‰¯å¥½ï¼šç»§ç»­å·©å›ºâ€œè¯æ®â†’ç»“è®ºâ†’æ–¹æ¡ˆâ€è¡¨è¾¾';
    }

    var minutesSpent = 0;
    try { minutesSpent = Math.max(0, Math.floor(((new Date()) - clinicalSession.startTime) / 60000)); } catch (e) { minutesSpent = 0; }

    var formatDuration = function(ms) {
      if (typeof ms !== 'number' || isNaN(ms) || ms < 0) return 'ï¼ˆæœªè®°å½•ï¼‰';
      var totalSeconds = Math.floor(ms / 1000);
      var minutes = Math.floor(totalSeconds / 60);
      var seconds = totalSeconds % 60;
      if (minutes <= 0) return seconds + ' ç§’';
      return minutes + ' åˆ† ' + seconds + ' ç§’';
    };

    var getTotalDurationMs = function() {
      try {
        if (clinicalSession.timeSpent && typeof clinicalSession.timeSpent.total === 'number' && isFinite(clinicalSession.timeSpent.total)) {
          return Math.max(0, clinicalSession.timeSpent.total);
        }
      } catch (e) {}
      return null;
    };

    var getStageDurationMs = function(stage) {
      try {
        var d = clinicalSession.backendStageDurationsMs;
        if (!d || typeof d !== 'object') return null;
        var dur = d[stage];
        if (typeof dur !== 'number' || !isFinite(dur) || dur < 0) return null;
        return dur;
      } catch (e) {
        return null;
      }
    };

    // å…³é”®åé¦ˆæ•°æ®ï¼ˆå…ˆç»„è£…æ•°æ®ï¼Œå†æ¸²æŸ“ï¼‰
    var strengths = [];
    var improvements = [];
    if (data.improvement_suggestions) improvements.push(String(data.improvement_suggestions));
    if (typeof data.incorrect_count === 'number' && data.incorrect_count > 0) {
      improvements.push('å­˜åœ¨é”™è¯¯æ²»ç–—é€‰æ‹©ï¼š' + data.incorrect_count + ' é¡¹ï¼ˆå»ºè®®å›é¡¾ç¦å¿Œ/é€‚åº”è¯ï¼‰');
    }
    // å…³é”®åé¦ˆç•™ç™½ç­–ç•¥ï¼šè‹¥åç«¯æœªç»™å‡ºç»“æ„åŒ–å†…å®¹ï¼Œä¸è‡ªåŠ¨ç”Ÿæˆå…œåº•æ–‡æ¡ˆ

    // è¿‡ç¨‹å›é¡¾æ•°æ®
    var diagnosisIdToName = {};
    if (Array.isArray(clinicalSession.diagnosisOptions)) {
      clinicalSession.diagnosisOptions.forEach(function(opt) {
        if (opt && typeof opt.id !== 'undefined') diagnosisIdToName[String(opt.id)] = opt.name || opt.label || String(opt.id);
      });
    }
    var treatmentIdToName = {};
    if (Array.isArray(clinicalSession.treatmentOptions)) {
      clinicalSession.treatmentOptions.forEach(function(opt) {
        if (opt && typeof opt.id !== 'undefined') treatmentIdToName[String(opt.id)] = opt.name || opt.treatment_name || String(opt.id);
      });
    }
    var selectedDiagnoses = Array.isArray(clinicalSession.selectedDiagnoses) ? clinicalSession.selectedDiagnoses : [];
    var selectedTreatments = Array.isArray(clinicalSession.selectedTreatments) ? clinicalSession.selectedTreatments : [];

    var selectedExamsText = '';
    if (Array.isArray(clinicalSession.selectedExaminationsDetail) && clinicalSession.selectedExaminationsDetail.length > 0) {
      selectedExamsText = clinicalSession.selectedExaminationsDetail
        .map(function(x) { return x && (x.name || (x.id ? ('æ£€æŸ¥#' + x.id) : 'æ£€æŸ¥')); })
        .filter(Boolean)
        .join('ã€');
    } else if (Array.isArray(clinicalSession.selectedExaminations) && clinicalSession.selectedExaminations.length > 0) {
      selectedExamsText = clinicalSession.selectedExaminations
        .map(function(x) {
          if (!x) return '';
          if (typeof x === 'string') return x;
          if (typeof x === 'number') return 'æ£€æŸ¥#' + x;
          return x.name || x.title || x.label || (x.id ? ('æ£€æŸ¥#' + x.id) : 'æ£€æŸ¥');
        })
        .filter(Boolean)
        .join('ã€');
    } else if (Array.isArray(clinicalSession.examinationResults) && clinicalSession.examinationResults.length > 0) {
      selectedExamsText = 'å·²æŸ¥çœ‹æ£€æŸ¥ç»“æœ ' + clinicalSession.examinationResults.length + ' é¡¹';
    } else {
      selectedExamsText = 'ï¼ˆæ— è®°å½•ï¼‰';
    }

    var diagnosisText = 'ï¼ˆæ— è®°å½•ï¼‰';
    if (Array.isArray(clinicalSession.reviewDiagnosisNames) && clinicalSession.reviewDiagnosisNames.length > 0) {
      diagnosisText = clinicalSession.reviewDiagnosisNames.filter(Boolean).join('ã€');
    } else if (selectedDiagnoses.length) {
      diagnosisText = selectedDiagnoses.map(function(id) { return diagnosisIdToName[String(id)] || ('è¯Šæ–­#' + id); }).join('ã€');
    }

    var diagnosisRationaleText = (clinicalSession.reviewDiagnosisRationale || '').trim();
    if (!diagnosisRationaleText) diagnosisRationaleText = 'ï¼ˆæœªè®°å½•ï¼‰';
    var treatmentText = selectedTreatments.length
      ? selectedTreatments.map(function(id) { return treatmentIdToName[String(id)] || ('æ²»ç–—#' + id); }).join('ã€')
      : 'ï¼ˆæ— è®°å½•ï¼‰';
    if (Array.isArray(clinicalSession.reviewTreatmentNames) && clinicalSession.reviewTreatmentNames.length > 0) {
      treatmentText = clinicalSession.reviewTreatmentNames.filter(Boolean).join('ã€');
    } else if (Array.isArray(clinicalSession.selectedTreatmentsDetail) && clinicalSession.selectedTreatmentsDetail.length > 0) {
      treatmentText = clinicalSession.selectedTreatmentsDetail
        .map(function(x) { return x && (x.name || (x.id ? ('æ²»ç–—#' + x.id) : 'æ²»ç–—')); })
        .filter(Boolean)
        .join('ã€');
    }
    var rationaleText = (clinicalSession.treatmentRationale || '').trim();
    if (!rationaleText) rationaleText = 'ï¼ˆæœªè®°å½•ï¼‰';

    // é¡µé¢æ¸²æŸ“
    var html = '';
    html += '<div class="final-feedback ff-wrapper">';

    // é¡¶éƒ¨æ€»è§ˆï¼ˆHeroï¼‰
    html += '<div class="card ff-hero border-0 shadow-sm mb-3">';
    html += '<div class="card-body">';
    html += '<div class="d-flex flex-column flex-md-row justify-content-between align-items-md-center">';
    html += '<div class="mb-3 mb-md-0">';
    html += '<div class="d-flex align-items-center">';
    html += '<div class="ff-hero-icon mr-3"><i class="fas fa-graduation-cap"></i></div>';
    html += '<div>';
    html += '<h4 class="mb-1">å­¦ä¹ å®Œæˆ</h4>';
    html += '<div class="text-muted">' + safeMultiline(data.overall_feedback || overallText) + '</div>';
    html += '</div>';
    html += '</div>';
    html += '</div>';
    html += '<div class="text-center">';
    html += '<div class="ff-score">' + overallScore.toFixed(1) + '</div>';
    html += '<div class="small text-muted">æ€»åˆ† / 100</div>';
    html += '<div class="mt-2"><span class="badge badge-' + gradeColor + ' px-3 py-2">' + grade + ' çº§</span></div>';
    html += '<div class="small text-muted mt-2">' + safeText(gradeHint) + '</div>';
    html += '</div>';
    html += '</div>';

    // KPI è¡Œ
    html += '<div class="row mt-4">';
    html += '<div class="col-12 col-md-3 mb-2"><div class="score-item text-center"><div class="text-warning h4 mb-0">' + ex.toFixed(1) + '</div><div class="small text-muted">æ£€æŸ¥é€‰æ‹©ï¼ˆ30%ï¼‰</div></div></div>';
    html += '<div class="col-12 col-md-3 mb-2"><div class="score-item text-center"><div class="text-info h4 mb-0">' + dx.toFixed(1) + '</div><div class="small text-muted">è¯Šæ–­æ¨ç†ï¼ˆ50%ï¼‰</div></div></div>';
    html += '<div class="col-12 col-md-3 mb-2"><div class="score-item text-center"><div class="text-success h4 mb-0">' + tx.toFixed(1) + '</div><div class="small text-muted">æ²»ç–—æ–¹æ¡ˆï¼ˆ20%ï¼‰</div></div></div>';
    html += '<div class="col-12 col-md-3 mb-2"><div class="score-item text-center"><div class="text-primary h4 mb-0">' + minutesSpent + '</div><div class="small text-muted">ç”¨æ—¶ï¼ˆåˆ†é’Ÿï¼‰</div></div></div>';
    html += '</div>';

    html += '</div>';
    html += '</div>';

    // ä¸»ä½“ä¸¤æ ï¼šå…³é”®åé¦ˆ + è¿‡ç¨‹å›é¡¾
    html += '<div class="row">';

    // å…³é”®åé¦ˆ
    html += '<div class="col-lg-7 mb-3">';
    html += '<div class="card shadow-sm">';
    html += '<div class="card-body text-left">';
    html += '<h5 class="mb-3"><i class="fas fa-lightbulb text-warning"></i> å…³é”®åé¦ˆ</h5>';
    html += '<div class="row">';
    html += '<div class="col-md-6 mb-3 mb-md-0">';
    html += '<div class="ff-subtitle text-success"><i class="fas fa-check-circle"></i> åšå¾—å¥½çš„ç‚¹</div>';
    html += '<ul class="mb-0 pl-3">';
    strengths.slice(0, 3).forEach(function(s) { html += '<li>' + safeText(s) + '</li>'; });
    html += '</ul>';
    html += '</div>';
    html += '<div class="col-md-6">';
    html += '<div class="ff-subtitle text-warning"><i class="fas fa-exclamation-triangle"></i> éœ€è¦æ”¹è¿›çš„ç‚¹</div>';
    html += '<ul class="mb-0 pl-3">';
    improvements.slice(0, 3).forEach(function(s) { html += '<li>' + safeText(s) + '</li>'; });
    html += '</ul>';
    html += '</div>';
    html += '</div>';

    // ç•™ç™½ï¼šæš‚ä¸å±•ç¤ºâ€œåé¦ˆåŸæ–‡â€åŒºå—ï¼ˆåç»­å¯æŒ‰å®¢æˆ·å£å¾„å†å¼€å¯ï¼‰

    html += '</div>';
    html += '</div>';
    html += '</div>';

    // è¿‡ç¨‹å›é¡¾
    html += '<div class="col-lg-5 mb-3">';
    html += '<div class="card shadow-sm">';
    html += '<div class="card-body text-left">';
    html += '<h5 class="mb-3"><i class="fas fa-history text-primary"></i> è¿‡ç¨‹å›é¡¾</h5>';

    // å„é˜¶æ®µç”¨æ—¶ï¼ˆå¤ç›˜å…³é”®ï¼‰
    html += '<div class="ff-review-item">';
    html += '<div class="ff-subtitle text-primary"><i class="fas fa-stopwatch"></i> å„é˜¶æ®µç”¨æ—¶</div>';
    html += '<div class="table-responsive">';
    html += '<table class="table table-sm mb-0">';
    html += '<tbody>';
    html += '<tr><td class="text-muted" style="white-space:nowrap;">ç—…å²é‡‡é›†</td><td>' + formatDuration(getStageDurationMs('case_presentation')) + '</td></tr>';
    html += '<tr><td class="text-muted" style="white-space:nowrap;">æ£€æŸ¥é€‰æ‹©</td><td>' + formatDuration(getStageDurationMs('examination_selection')) + '</td></tr>';
    html += '<tr><td class="text-muted" style="white-space:nowrap;">è¯Šæ–­æ¨ç†</td><td>' + formatDuration(getStageDurationMs('diagnosis_reasoning')) + '</td></tr>';
    html += '<tr><td class="text-muted" style="white-space:nowrap;">æ²»ç–—æ–¹æ¡ˆ</td><td>' + formatDuration(getStageDurationMs('treatment_selection')) + '</td></tr>';
    html += '<tr><td class="text-muted" style="white-space:nowrap; font-weight:600;">æ€»ç”¨æ—¶</td><td style="font-weight:600;">' + formatDuration((clinicalSession.timeSpent && typeof clinicalSession.timeSpent.total === 'number') ? clinicalSession.timeSpent.total : ((new Date()) - clinicalSession.startTime)) + '</td></tr>';
    html += '</tbody>';
    html += '</table>';
    html += '</div>';
    html += '</div>';

    html += '<div class="ff-review-item">';
    html += '<div class="ff-subtitle text-primary"><i class="fas fa-search"></i> æ£€æŸ¥é€‰æ‹©</div>';
    html += '<div class="text-muted">' + safeText(selectedExamsText) + '</div>';
    html += '</div>';

    html += '<div class="ff-review-item">';
    html += '<div class="ff-subtitle text-primary"><i class="fas fa-diagnoses"></i> æäº¤çš„è¯Šæ–­</div>';
    html += '<div class="text-muted">' + safeText(diagnosisText) + '</div>';
    html += '</div>';

    html += '<div class="ff-review-item">';
    html += '<div class="ff-subtitle text-primary"><i class="fas fa-notes-medical"></i> è¯Šæ–­ä¾æ®</div>';
    html += '<div class="alert alert-light mb-0" style="white-space: pre-wrap;">' + safeText(diagnosisRationaleText) + '</div>';
    html += '</div>';

    html += '<div class="ff-review-item">';
    html += '<div class="ff-subtitle text-primary"><i class="fas fa-pills"></i> é€‰æ‹©çš„æ²»ç–—æ–¹æ¡ˆ</div>';
    html += '<div class="text-muted">' + safeText(treatmentText) + '</div>';
    html += '</div>';

    html += '<div class="ff-review-item mb-0">';
    html += '<div class="ff-subtitle text-primary"><i class="fas fa-pen"></i> æ²»ç–—ä¾æ®</div>';
    html += '<div class="alert alert-light mb-0" style="white-space: pre-wrap;">' + safeText(rationaleText) + '</div>';
    html += '</div>';

    html += '</div>';
    html += '</div>';
    html += '</div>';

    html += '</div>';

    // å­¦ä¹ æ€»ç»“ï¼ˆå¯é€‰ï¼‰
    if (data.overall_feedback || data.improvement_suggestions) {
      html += '<div class="row">';
      html += '<div class="col-12">';
      html += '<div class="card shadow-sm mb-0">';
      html += '<div class="card-body text-left">';
      html += '<h5 class="mb-3"><i class="fas fa-book-open text-success"></i> å­¦ä¹ æ€»ç»“</h5>';
      if (data.overall_feedback) {
        html += '<div class="mb-3">' + safeMultiline(data.overall_feedback) + '</div>';
      }
      if (data.improvement_suggestions) {
        html += '<div class="ff-subtitle text-primary"><i class="fas fa-bullseye"></i> æ”¹è¿›å»ºè®®</div>';
        html += '<div class="alert alert-light mb-0" style="white-space: pre-wrap;">' + safeText(data.improvement_suggestions) + '</div>';
      }
      html += '</div>';
      html += '</div>';
      html += '</div>';
      html += '</div>';
    }
    
    // æ“ä½œæŒ‰é’® - æ’‘æ»¡æ•´è¡Œå¹¶å±…ä¸­
    html += '<div class="action-buttons mt-4">';
    html += '<div class="d-flex justify-content-center align-items-center">';
    html += '<div class="d-flex w-100" style="max-width: 600px;">';
    html += '<button class="btn btn-outline-primary flex-fill mx-2" onclick="resetClinicalProgressAndReload()">';
    html += '<i class="fas fa-redo"></i> é‡æ–°å­¦ä¹ ';
    html += '</button>';
    html += '<a href="/student/clinical-cases/" class="btn btn-outline-secondary flex-fill mx-2">';
    html += '<i class="fas fa-list"></i> è¿”å›æ¡ˆä¾‹åˆ—è¡¨';
    html += '</a>';
    html += '<a href="/student/" class="btn btn-outline-success flex-fill mx-2">';
    html += '<i class="fas fa-home"></i> è¿”å›é¦–é¡µ';
    html += '</a>';
    html += '</div>';
    html += '</div>';
    html += '</div>';
    
    html += '</div>';
    
    $('#stage-content').html(html);
    
    // å®Œå…¨é‡æ„å¯¼èˆªå¡ç‰‡ä»¥æ˜¾ç¤ºå®ŒæˆçŠ¶æ€
    var completionNavHtml = '';
    completionNavHtml += '<div class="card-body">';
    completionNavHtml += '<div class="text-center">';
    completionNavHtml += '<div class="mb-2"><i class="fas fa-check-circle text-success" style="font-size: 1.6rem;"></i></div>';
    completionNavHtml += '<div class="font-weight-bold text-success mb-2">ä¸´åºŠæ¨ç†è¿›åº¦å·²å®Œæˆ</div>';
    completionNavHtml += '<div class="progress" style="height: 14px; border-radius: 999px; overflow: hidden;">';
    completionNavHtml += '<div class="progress-bar bg-success" role="progressbar" style="width: 100%;">100%</div>';
    completionNavHtml += '</div>';
    completionNavHtml += '<div class="small text-muted mt-2">å¯åœ¨ä¸‹æ–¹é€‰æ‹©é‡æ–°å­¦ä¹ æˆ–è¿”å›åˆ—è¡¨</div>';
    completionNavHtml += '</div>';
    completionNavHtml += '</div>';
    
    $('#navigation-card').html(completionNavHtml);

    // é‡æ–°å­¦ä¹ ï¼šå…ˆé‡ç½®åç«¯ä¼šè¯ï¼ˆæ¸…ç©º stage_times ç­‰å†å²ä¿¡æ¯ï¼‰ï¼Œå†åˆ·æ–°é¡µé¢
    window.resetClinicalProgressAndReload = function() {
      try {
        $.ajax({
          url: '/api/clinical/reset-progress/',
          method: 'POST',
          headers: {
            'X-CSRFToken': $('[name=csrfmiddlewaretoken]').val()
          },
          data: JSON.stringify({ case_id: clinicalSession.caseId }),
          contentType: 'application/json',
          complete: function() {
            window.location.reload();
          }
        });
      } catch (e) {
        window.location.reload();
      }
    };
    
    // æ¸…é™¤ä¿å­˜çš„è¿›åº¦
    localStorage.removeItem('clinical_progress_' + clinicalSession.caseId);
    
    // è®°å½•å®Œæˆæ—¶é—´ï¼šä»¥æœåŠ¡ç«¯å£å¾„ä¸ºå‡†ï¼ˆä¸åœ¨å‰ç«¯ä¼°ç®—æ€»ç”¨æ—¶ï¼‰
    try {
      if (clinicalSession.timeSpent && typeof clinicalSession.timeSpent.total === 'number') {
        addToLearningTimeline('å®Œæˆå­¦ä¹ ', 'æ€»ç”¨æ—¶: ' + Math.floor(clinicalSession.timeSpent.total / 60000) + ' åˆ†é’Ÿ');
      } else {
        addToLearningTimeline('å®Œæˆå­¦ä¹ ', 'æ€»ç”¨æ—¶: ï¼ˆæœªè®°å½•ï¼‰');
      }
    } catch (e) {}
  }

  // ==================== åŠ¨ç”»ä¸è§†è§‰æ•ˆæœ ====================
  
  // ç®€å• confetti æ•ˆæœï¼ˆæ— å¤–éƒ¨åº“ï¼Œè½»é‡ï¼‰
  function launchConfetti(count) {
    count = count || 30;
    for (var i = 0; i < count; i++) {
      (function() {
        var conf = document.createElement('div');
        conf.className = 'confetti-piece';
        var size = Math.floor(Math.random() * 8) + 6;
        conf.style.width = size + 'px';
        conf.style.height = (size * 0.6) + 'px';
        conf.style.background = ['#28a745','#007bff','#ffc107','#dc3545','#6610f2'][Math.floor(Math.random() * 5)];
        conf.style.position = 'fixed';
        conf.style.zIndex = 9999;
        conf.style.left = (Math.random() * window.innerWidth) + 'px';
        conf.style.top = '-20px';
        conf.style.opacity = Math.random() * 0.9 + 0.1;
        conf.style.transform = 'rotate(' + (Math.random() * 360) + 'deg)';
        conf.style.pointerEvents = 'none';
        document.body.appendChild(conf);
        var endY = window.innerHeight + 100 + Math.random() * 200;
        var duration = 1000 + Math.random() * 1200;
        conf.animate([
          { transform: conf.style.transform + ' translateY(0px)', opacity: conf.style.opacity },
          { transform: conf.style.transform + ' translateY(' + endY + 'px)', opacity: 0.6 }
        ], { duration: duration, easing: 'cubic-bezier(.2,.8,.2,1)' });
        setTimeout(function() { conf.remove(); }, duration + 200);
      })();
    }
  }

  // å¡ç‰‡é«˜äº®è·³åŠ¨ï¼Œç”¨äºå¼ºè°ƒæˆåŠŸ/é”™è¯¯
  function flashCard($el, type) {
    var cls = (type === 'success') ? 'flash-success' : 'flash-warning';
    $el.addClass(cls);
    setTimeout(function() { $el.removeClass(cls); }, 900);
  }

  // æ­¥éª¤é—ªå…‰ï¼ˆçŸ­æš‚æ”¾å¤§ã€å…‰æ™•ï¼‰
  function highlightStep(stepName) {
    var $step = $('.stepper-item[data-step="' + stepName + '"]');
    $step.addClass('step-highlight');
    setTimeout(function() { $step.removeClass('step-highlight'); }, 800);
  }


  
  // ==================== æ£€æŸ¥é€‰é¡¹ç»Ÿè®¡åŠŸèƒ½ ====================
  
  function showExaminationStats() {
    if (!clinicalSession.examinationStats) return;
    
    var stats = clinicalSession.examinationStats;
    var message = '';
    
    if (stats.mode === 'mixed') {
      message = 'ğŸ¯ æ£€æŸ¥é¡¹ç›®å·²ä¸ºæ‚¨æ™ºèƒ½ç»„åˆï¼ŒåŒ…å«é‡ç‚¹é¡¹ç›®å’Œè¾…åŠ©é€‰é¡¹ï¼Œè¯·ä»”ç»†è¯„ä¼°æ¯é¡¹æ£€æŸ¥çš„ä»·å€¼';
      showFeedbackMessage(message, 'examination-stats');
    } else {
      message = 'ğŸ“‹ å·²ä¸ºæ‚¨åŠ è½½è¯¥æ¡ˆä¾‹çš„æ‰€æœ‰æ£€æŸ¥é€‰é¡¹ï¼Œå…± ' + stats.totalCount + ' é¡¹';
      showFeedbackMessage(message, 'info');
    }
  }
  
  // ==================== é€šç”¨åŠŸèƒ½å‡½æ•° ====================
  
  function showClinicalThinkingPrompt(stage) {
    var prompts = {
      'history': 'æ€è€ƒï¼šæ‚£è€…çš„ç—‡çŠ¶ç‰¹ç‚¹æ˜¯ä»€ä¹ˆï¼Ÿå¯èƒ½çš„ç—…å› æœ‰å“ªäº›ï¼Ÿéœ€è¦é‡ç‚¹å…³æ³¨ä»€ä¹ˆï¼Ÿ',
      'examination': 'æ€è€ƒï¼šåŸºäºç—…å²ï¼Œå“ªäº›æ£€æŸ¥æœ€æœ‰åŠ©äºæ˜ç¡®è¯Šæ–­ï¼Ÿå¦‚ä½•å¹³è¡¡è¯Šæ–­ä»·å€¼å’Œæˆæœ¬ï¼Ÿ',
      'diagnosis': 'æ€è€ƒï¼šæ£€æŸ¥ç»“æœæ”¯æŒå“ªäº›è¯Šæ–­ï¼Ÿå¦‚ä½•è¿›è¡Œé‰´åˆ«è¯Šæ–­ï¼Ÿæ¦‚ç‡æœ€é«˜çš„æ˜¯ä»€ä¹ˆï¼Ÿ',
      'treatment': 'æ€è€ƒï¼šé’ˆå¯¹ç¡®å®šçš„è¯Šæ–­ï¼Œæœ€ä½³æ²»ç–—æ–¹æ¡ˆæ˜¯ä»€ä¹ˆï¼Ÿå¦‚ä½•è¯„ä¼°é£é™©è·ç›Šæ¯”ï¼Ÿ',
      'feedback': 'æ€è€ƒï¼šå›é¡¾æ•´ä¸ªè¯Šç–—è¿‡ç¨‹ï¼Œæœ‰å“ªäº›å€¼å¾—æ€»ç»“çš„ç»éªŒï¼Ÿ'
    };
    
    if (prompts[stage]) {
      showFeedbackMessage(prompts[stage], 'guidance');
    }
  }
  
  function showFeedbackMessage(message, type = 'info') {
    var alertClass = {
      'info': 'alert-info',
      'success': 'alert-success feedback-positive border-success',
      'warning': 'alert-warning feedback-corrective', 
      'danger': 'alert-danger',
      'guidance': 'alert-info feedback-guidance',
      'examination-stats': 'alert-secondary'
    }[type] || 'alert-info';
    
    var icon = {
      'info': 'fas fa-info-circle',
      'success': 'fas fa-trophy',
      'warning': 'fas fa-exclamation-triangle',
      'danger': 'fas fa-times-circle',
      'guidance': 'fas fa-lightbulb',
      'examination-stats': 'fas fa-chart-bar'
    }[type] || 'fas fa-info-circle';
    
    var html = '<div class="alert ' + alertClass + ' feedback-animation">';
    html += '<i class="' + icon + '"></i> ' + message;
    html += '</div>';
    
    $('#feedback-panel').html(html);
    
    // è®°å½•åé¦ˆå†å²
    clinicalSession.feedbackHistory.push({
      timestamp: new Date(),
      stage: clinicalSession.currentStage,
      message: message,
      type: type
    });
  }
  
  function showErrorMessage(message) {
    showFeedbackMessage('é”™è¯¯ï¼š' + message, 'danger');
  }
  
  function addToLearningTimeline(action, detail) {
    var timestamp = new Date().toLocaleTimeString();
    var html = '<div class="timeline-item">';
    html += '<div class="d-flex justify-content-between">';
    html += '<strong>' + action + '</strong>';
    html += '<small class="text-muted">' + timestamp + '</small>';
    html += '</div>';
    html += '<div class="text-muted small">' + detail + '</div>';
    html += '</div>';
    
    $('#learning-timeline').prepend(html);
    
    // ä¿æŒæœ€å¤šæ˜¾ç¤º10æ¡è®°å½•
    var items = $('#learning-timeline .timeline-item');
    if (items.length > 10) {
      items.slice(10).remove();
    }
  }
  
  function initializeClinicalRecordTabs() {
    // æ‰‹åŠ¨å®ç°æ ‡ç­¾åˆ‡æ¢åŠŸèƒ½ï¼ˆæ›¿ä»£Bootstrapçš„pillåŠŸèƒ½ï¼‰
    console.log('åˆå§‹åŒ–ä¸´åºŠè®°å½•æ ‡ç­¾...');
    
    // ç¡®ä¿åˆå§‹çŠ¶æ€æ­£ç¡®
    $('#notes-tab').addClass('active');
    $('#notes-panel').addClass('show active');
    $('#timeline-panel').removeClass('show active');
    
    // ç»‘å®šç‚¹å‡»äº‹ä»¶
    $('#clinical-tabs a').off('click').on('click', function(e) {
      e.preventDefault();
      console.log('ç‚¹å‡»æ ‡ç­¾:', $(this).text());
      
      var $this = $(this);
      var targetPanel = $this.attr('href');
      
      // å¦‚æœç‚¹å‡»çš„æ˜¯å½“å‰æ¿€æ´»çš„æ ‡ç­¾ï¼Œä¸åšä»»ä½•æ“ä½œ
      if ($this.hasClass('active')) {
        return;
      }
      
      // ç§»é™¤æ‰€æœ‰æ ‡ç­¾çš„activeçŠ¶æ€
      $('#clinical-tabs a').removeClass('active');
      // æ·»åŠ å½“å‰æ ‡ç­¾çš„activeçŠ¶æ€
      $this.addClass('active');
      
      // éšè—æ‰€æœ‰é¢æ¿
      $('.tab-pane').removeClass('show active').hide();
      
      // æ˜¾ç¤ºç›®æ ‡é¢æ¿
      $(targetPanel).addClass('show active').fadeIn(300);
      
      console.log('æˆåŠŸåˆ‡æ¢åˆ°æ ‡ç­¾:', targetPanel);
    });
    
    console.log('æ ‡ç­¾åˆå§‹åŒ–å®Œæˆ');
  }
  
  function updateTimeSpent() {
    var now = new Date();
    var elapsed = Math.floor((now - clinicalSession.startTime) / 1000); // ç§’
    var minutes = Math.floor(elapsed / 60);
    var seconds = elapsed % 60;
    
    var timeStr = String(minutes).padStart(2, '0') + ':' + String(seconds).padStart(2, '0');
    $('#time-spent').text(timeStr);
  }
  
  function updateStageProgress() {
    var stages = clinicalSession.stages;
    var currentIndex = stages.indexOf(clinicalSession.currentStage);
    var progress = Math.round(((currentIndex + 1) / stages.length) * 100);
    
    // ä½¿ç”¨ç»Ÿä¸€çš„è¿›åº¦æ›´æ–°å‡½æ•°
    updateNavigationProgress();
    $('#current-stage-text').text(getStageDisplayName(clinicalSession.currentStage));
  }
  
  function getStageDisplayName(stage) {
    var names = {
      'history': 'ç—…å²é‡‡é›†',
      'examination': 'æ£€æŸ¥é€‰æ‹©',
      'diagnosis': 'è¯Šæ–­æ¨ç†',
      'treatment': 'æ²»ç–—å†³ç­–',
      'feedback': 'å­¦ä¹ åé¦ˆ'
    };
    return names[stage] || stage;
  }
  
  function saveCurrentProgress() {
    // ä¿å­˜å½“å‰å­¦ä¹ è¿›åº¦åˆ°æœ¬åœ°å­˜å‚¨ï¼ˆä¿æŒå…¼å®¹æ€§ï¼‰
    var progressData = {
      caseId: clinicalSession.caseId,
      stage: clinicalSession.currentStage,
      selectedExaminations: clinicalSession.selectedExaminations,
      selectedDiagnosis: clinicalSession.selectedDiagnosis,
      selectedTreatments: clinicalSession.selectedTreatments,
      notes: $('#clinical-notes').val(),
      timestamp: new Date().toISOString()
    };
    
    localStorage.setItem('clinical_progress_' + clinicalSession.caseId, JSON.stringify(progressData));
  }
  
  function saveClinicalNotesToDB() {
    // ä¿å­˜ä¸´åºŠç¬”è®°åˆ°æ•°æ®åº“
    var notes = $('#clinical-notes').val();
    
    // æ˜¾ç¤ºä¿å­˜ä¸­çŠ¶æ€
    showNotesSaveStatus('<i class="fas fa-spinner fa-spin"></i> ä¿å­˜ä¸­...', 'info');
    
    $.ajax({
      url: '/api/clinical/notes/save/',
      method: 'POST',
      contentType: 'application/json',
      headers: {
        'X-CSRFToken': $('[name=csrfmiddlewaretoken]').val() || getCsrfToken()
      },
      data: JSON.stringify({
        case_id: clinicalSession.caseId,
        notes: notes
      }),
      success: function(resp) {
        if (resp.success) {
          // æ˜¾ç¤ºä¿å­˜æˆåŠŸæç¤º
          showNotesSaveStatus('<i class="fas fa-check-circle"></i> å·²ä¿å­˜ (' + resp.data.save_time + ')', 'success');
          
          // æ›´æ–°å­—æ•°ç»Ÿè®¡
          updateNotesCharCount();
          
          // æ·»åŠ è§†è§‰åé¦ˆ - æ–‡æœ¬æ¡†çŸ­æš‚é«˜äº®
          $('#clinical-notes').addClass('notes-saved-flash');
          setTimeout(function() {
            $('#clinical-notes').removeClass('notes-saved-flash');
          }, 1000);
        } else {
          showNotesSaveStatus('<i class="fas fa-exclamation-triangle"></i> ä¿å­˜å¤±è´¥', 'error');
        }
      },
      error: function(xhr, status, error) {
        console.log('ä¿å­˜ç¬”è®°å¤±è´¥:', error);
        showNotesSaveStatus('<i class="fas fa-exclamation-circle"></i> ä¿å­˜å¤±è´¥', 'error');
      }
    });
  }
  
  function loadClinicalNotesFromDB() {
    // ä»æ•°æ®åº“åŠ è½½ä¸´åºŠç¬”è®°
    $.ajax({
      url: '/api/clinical/notes/' + clinicalSession.caseId + '/',
      method: 'GET',
      success: function(resp) {
        if (resp.success && resp.data.notes) {
          $('#clinical-notes').val(resp.data.notes);
          updateNotesCharCount();
          
          if (resp.data.last_updated) {
            showNotesSaveStatus('<i class="fas fa-cloud-download-alt"></i> å·²åŠ è½½ (ä¸Šæ¬¡æ›´æ–°: ' + resp.data.last_updated + ')', 'info');
          } else {
            showNotesSaveStatus('<i class="fas fa-cloud-download-alt"></i> å·²åŠ è½½å†å²ç¬”è®°', 'info');
          }
          
          // 5ç§’åæ¸…é™¤åŠ è½½çŠ¶æ€
          setTimeout(function() {
            $('#notes-save-status').fadeOut(500);
          }, 5000);
        } else {
          // æ²¡æœ‰ä¿å­˜çš„ç¬”è®°ï¼Œæ˜¾ç¤ºæ¬¢è¿ä¿¡æ¯
          updateNotesCharCount();
          showNotesSaveStatus('<i class="fas fa-edit"></i> å¼€å§‹è®°å½•æ‚¨çš„ä¸´åºŠæ€è€ƒ', 'info');
          setTimeout(function() {
            $('#notes-save-status').fadeOut(500);
          }, 3000);
        }
      },
      error: function(xhr, status, error) {
        console.log('åŠ è½½ç¬”è®°å¤±è´¥:', error);
        updateNotesCharCount();
        showNotesSaveStatus('<i class="fas fa-exclamation-triangle"></i> åŠ è½½ç¬”è®°å¤±è´¥', 'error');
      }
    });
  }
  
  function showNotesSaveStatus(message, type) {
    // æ˜¾ç¤ºç¬”è®°ä¿å­˜çŠ¶æ€
    var $status = $('#notes-save-status');
    
    // æ¸…é™¤ä¹‹å‰çš„æ·¡å‡ºå®šæ—¶å™¨
    if (window.notesStatusTimeout) {
      clearTimeout(window.notesStatusTimeout);
    }
    
    // æ˜¾ç¤ºæ–°çŠ¶æ€
    $status.stop(true, true).show();
    $status.html(message);
    
    // æ ¹æ®ç±»å‹è®¾ç½®æ ·å¼
    $status.removeClass('text-success text-danger text-info text-warning');
    switch (type) {
      case 'success':
        $status.addClass('text-success');
        break;
      case 'error':
        $status.addClass('text-danger');
        break;
      case 'warning':
        $status.addClass('text-warning');
        break;
      default:
        $status.addClass('text-info');
    }
    
    // å¯¹äºæˆåŠŸå’Œé”™è¯¯çŠ¶æ€ï¼Œè®¾ç½®è‡ªåŠ¨æ·¡å‡º
    if (type === 'success' || type === 'error') {
      window.notesStatusTimeout = setTimeout(function() {
        $status.fadeOut(1000);
      }, 3000);
    }
  }
  
  function updateNotesCharCount() {
    // æ›´æ–°å­—æ•°ç»Ÿè®¡
    var notes = $('#clinical-notes').val();
    var charCount = notes.length;
    $('#notes-char-count').text(charCount + ' å­—');
    
    // æ ¹æ®å­—æ•°ç»™å‡ºé¢œè‰²æç¤º
    var $counter = $('#notes-char-count');
    $counter.removeClass('text-muted text-info text-warning text-danger');
    
    if (charCount === 0) {
      $counter.addClass('text-muted');
    } else if (charCount < 50) {
      $counter.addClass('text-info');
    } else if (charCount < 200) {
      $counter.addClass('text-success');
    } else if (charCount < 500) {
      $counter.addClass('text-warning');
    } else {
      $counter.addClass('text-danger');
    }
  }
  
  function loadSavedProgress() {
    // å°è¯•åŠ è½½ä¹‹å‰ä¿å­˜çš„è¿›åº¦
    var saved = localStorage.getItem('clinical_progress_' + clinicalSession.caseId);
    if (saved) {
      try {
        var progressData = JSON.parse(saved);
        // å¦‚æœæ˜¯å½“å¤©çš„è¿›åº¦ï¼Œåˆ™æ¢å¤
        var savedTime = new Date(progressData.timestamp);
        var now = new Date();
        if (now.toDateString() === savedTime.toDateString()) {
          return progressData;
        }
      } catch (e) {
        console.log('Failed to load saved progress:', e);
      }
    }
    return null;
  }
  
  // ==================== ä¸»ç¨‹åºå…¥å£å’Œäº‹ä»¶ç»‘å®š ====================
  
  // æ›´æ–°é˜¶æ®µå¡ç‰‡æ ·å¼å’Œå†…å®¹
  function updateStageCard(stageName, stageKey) {
    const stageConfig = {
      'history': {
        text: 'ç—…å²é‡‡é›†é˜¶æ®µ',
        icon: 'fas fa-clipboard-list',
        textColor: 'text-success',
        cardClass: 'stage-history'
      },
      'examination': {
        text: 'æ£€æŸ¥é€‰æ‹©é˜¶æ®µ', 
        icon: 'fas fa-stethoscope',
        textColor: 'text-warning',
        cardClass: 'stage-examination'
      },
      'diagnosis': {
        text: 'è¯Šæ–­æ¨ç†é˜¶æ®µ',
        icon: 'fas fa-brain',
        textColor: 'text-purple',
        cardClass: 'stage-diagnosis'
      },
      'treatment': {
        text: 'æ²»ç–—å†³ç­–é˜¶æ®µ',
        icon: 'fas fa-pills',
        textColor: 'text-info',
        cardClass: 'stage-treatment'
      },
      'complete': {
        text: 'å­¦ä¹ å®Œæˆ',
        icon: 'fas fa-check-circle',
        textColor: 'text-success',
        cardClass: 'stage-complete'
      }
    };
    
    const config = stageConfig[stageKey] || stageConfig['history'];
    const $stageBadge = $('#current-stage-badge');
    const $stageCard = $stageBadge.closest('.stage-info-card');
    
    // æ›´æ–°æ–‡å­—å’Œå›¾æ ‡
    $stageBadge.text(config.text)
              .removeClass()
              .addClass('fw-bold ' + config.textColor)
              .css('font-size', '0.9rem');
    
    // æ›´æ–°å¡ç‰‡æ ·å¼
    $stageCard.removeClass('stage-history stage-examination stage-diagnosis stage-treatment stage-complete')
              .addClass(config.cardClass);
    
    // æ›´æ–°å›¾æ ‡
    $stageCard.find('i').removeClass().addClass(config.icon + ' me-2').css('font-size', '0.9em');
    
    // æ›´æ–°å›¾æ ‡é¢œè‰²
    const iconColorClass = config.textColor.replace('text-', '');
    if (iconColorClass === 'purple') {
      $stageCard.find('i').removeClass().addClass(config.icon + ' me-2').css({'font-size': '0.9em', 'color': '#9c27b0'});
    } else {
      $stageCard.find('i').removeClass().addClass(config.icon + ' ' + config.textColor + ' me-2').css('font-size', '0.9em');
    }
  }

  // è¿›åº¦æ¡æ›´æ–°å‡½æ•°
  function updateNavigationProgress() {
    const stageMapping = {
      'history': 1,
      'examination': 2, 
      'diagnosis': 3,
      'treatment': 4,
      'feedback': 4
    };
    
    const totalSteps = 4;
    const currentStepNum = stageMapping[clinicalSession.currentStage] || 1;
    const progressPercent = Math.round((currentStepNum / totalSteps) * 100);
    
    // æ›´æ–°è¿›åº¦æ¡
    const progressBar = document.getElementById('overall-progress');
    if (progressBar) {
      progressBar.style.width = progressPercent + '%';
      progressBar.textContent = progressPercent + '%';
      progressBar.setAttribute('aria-valuenow', progressPercent);
      
      // æ ¹æ®è¿›åº¦è°ƒæ•´é¢œè‰²
      let gradient;
      if (progressPercent <= 25) {
        gradient = 'linear-gradient(90deg, #dc3545, #c82333)'; // çº¢è‰²
      } else if (progressPercent <= 50) {
        gradient = 'linear-gradient(90deg, #ffc107, #e0a800)'; // é»„è‰²
      } else if (progressPercent <= 75) {
        gradient = 'linear-gradient(90deg, #007bff, #0056b3)'; // è“è‰²
      } else {
        gradient = 'linear-gradient(90deg, #28a745, #20c997)'; // ç»¿è‰²
      }
      progressBar.style.background = gradient;
    }
    
    // æ›´æ–°è¿›åº¦æ–‡æœ¬
    const progressText = document.getElementById('progress-text');
    if (progressText) {
      progressText.textContent = `æ­¥éª¤ ${currentStepNum}/${totalSteps} (${progressPercent}%)`;
    }
  }
  
  $(document).ready(function() {
    // åˆå§‹åŒ–ä¸´åºŠè®°å½•æ ‡ç­¾åˆ‡æ¢åŠŸèƒ½
    initializeClinicalRecordTabs();
    
    // åˆå§‹åŒ–æ—¶é—´æ˜¾ç¤ºæ›´æ–°
    setInterval(updateTimeSpent, 1000);
    
    // åŠ è½½ä¿å­˜çš„ä¸´åºŠç¬”è®°
    loadClinicalNotesFromDB();
    
    // åˆå§‹åŒ–èŠå¤©çª—å£
    initializeChatWindow();
    
    // åˆå§‹åŒ–æµ®åŠ¨èŠå¤©çª—å£æ‹–æ‹½åŠŸèƒ½ - å»¶è¿Ÿåˆå§‹åŒ–ç¡®ä¿DOMå®Œå…¨åŠ è½½
    setTimeout(function() {
      makeChatDraggable();
      makeChatResizable();
      if (typeof window.positionChatWindowToLeftColumn === 'function') {
        window.positionChatWindowToLeftColumn(true);
      }
    }, 100);
    
    // æ¸…ç©ºå¯èƒ½çš„å†å²è¿›åº¦æ•°æ®ï¼Œé¿å…æ±¡æŸ“
    localStorage.removeItem('clinical_progress_' + clinicalSession.caseId);
    
    // ç¡®ä¿ä¼šè¯æ•°æ®å¹²å‡€åˆå§‹åŒ–
    clinicalSession.selectedExaminations = [];
    clinicalSession.selectedTreatments = [];
    clinicalSession.selectedDiagnosis = null;
    
    // å°è¯•æ¢å¤ä¹‹å‰çš„å­¦ä¹ è¿›åº¦ï¼ˆå·²ç¦ç”¨ï¼Œé¿å…æ•°æ®æ±¡æŸ“ï¼‰
    /*
    var savedProgress = loadSavedProgress();
    if (savedProgress && confirm('æ£€æµ‹åˆ°ä¹‹å‰çš„å­¦ä¹ è¿›åº¦ï¼Œæ˜¯å¦ç»§ç»­ä¹‹å‰çš„å­¦ä¹ ï¼Ÿ')) {
      // æ¢å¤è¿›åº¦é€»è¾‘
      clinicalSession.currentStage = savedProgress.stage;
      clinicalSession.selectedExaminations = savedProgress.selectedExaminations || [];
      clinicalSession.selectedDiagnosis = savedProgress.selectedDiagnosis;
      clinicalSession.selectedTreatments = savedProgress.selectedTreatments || [];
      $('#clinical-notes').val(savedProgress.notes || '');
    }
    */
    
    // å¼€å§‹ç—…å²é˜¶æ®µ  
    setTimeout(function() {
      initializeHistoryStage();
      
      // è°ƒè¯•ä¿¡æ¯ï¼šæ£€æŸ¥å…³é”®å…ƒç´ 
      console.log('ğŸ” é¡µé¢åˆå§‹åŒ–æ£€æŸ¥:');
      console.log('  - ç—…å²é‡‡é›†å…¨å±å¸ƒå±€:', $('#history-collection-fullscreen').length > 0 ? 'âœ…å­˜åœ¨' : 'âŒä¸å­˜åœ¨');
      console.log('  - ä¸»è¯‰æ˜¾ç¤ºå®¹å™¨:', $('#chief-complaint-summary').length > 0 ? 'âœ…å­˜åœ¨' : 'âŒä¸å­˜åœ¨');
      console.log('  - å½“å‰é˜¶æ®µ:', clinicalSession.currentStage);
      console.log('  - ç—…ä¾‹ID:', clinicalSession.caseId);
    }, 100);
    
    // åˆå§‹åŒ–è¿›åº¦æ˜¾ç¤º
    updateNavigationProgress();
    updateClinicalProgress(); // åŒæ—¶æ›´æ–°æ­¥éª¤è¿›åº¦æ¡
    
    // ç´§æ€¥ä¿®å¤ï¼šå¼ºåˆ¶ç¡®ä¿æŒ‰é’®å¯ç”¨
    setTimeout(function() {
      ensureButtonEnabled();
    }, 500);
    
    // ç»‘å®šå¯¼èˆªæŒ‰é’®äº‹ä»¶
    $('#btn-next').on('click', function() {
      debugButtonStatus();
      
      if ($(this).prop('disabled')) {
        console.log('æŒ‰é’®è¢«ç¦ç”¨ï¼Œå¼ºåˆ¶å¯ç”¨!');
        ensureButtonEnabled();
        return false;
      }
      
      handleNextStage();
    });

    $('#btn-prev').on('click', function() {
      handlePreviousStage();
    });
    
    // ç»‘å®šä¸´åºŠç¬”è®°è‡ªåŠ¨ä¿å­˜åˆ°æ•°æ®åº“å’Œå­—æ•°ç»Ÿè®¡
    $('#clinical-notes').on('input', function() {
      updateNotesCharCount();
      clearTimeout(window.notesSaveTimeout);
      window.notesSaveTimeout = setTimeout(saveClinicalNotesToDB, 2000);
    });
    
    // ç»‘å®šç¬”è®°å­—æ®µçš„ç„¦ç‚¹äº‹ä»¶ï¼Œå®æ—¶æ›´æ–°å­—æ•°
    $('#clinical-notes').on('focus', function() {
      updateNotesCharCount();
    });
    
    // é¡µé¢ç¦»å¼€æ—¶ä¿å­˜è¿›åº¦
    $(window).on('beforeunload', function() {
      saveCurrentProgress();
    });
  });
  
  function handleNextStage() {
    var currentStage = clinicalSession.currentStage;
    
    switch (currentStage) {
      case 'case_presentation':
        // è®°å½•ç—…å²é˜¶æ®µç”¨æ—¶
        clinicalSession.timeSpent.history = new Date() - clinicalSession.timeSpent.history;
        loadExaminationStage();
        break;
        
      case 'examination_selection':
        if (!clinicalSession.isExaminationConfirmed) {
          // ç¬¬ä¸€æ¬¡ç‚¹å‡»ï¼šç¡®è®¤æ£€æŸ¥é€‰æ‹©
          if (clinicalSession.selectedExaminations.length === 0) {
            showFeedbackMessage('è¯·è‡³å°‘é€‰æ‹©ä¸€é¡¹æ£€æŸ¥', 'warning');
            return;
          }
          confirmExaminationSelection();
        } else {
          // æ£€æŸ¥å·²ç¡®è®¤ï¼Œæ˜¾ç¤ºæ£€æŸ¥ç»“æœ
          if (clinicalSession.currentExaminationIndex < clinicalSession.examinationOrder.length) {
            // éšè—çœ¼åº•å­—å¹•ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
            if ($('#fundus-overlay').length) {
              hideFundusSubtitle();
            }
            showNextExaminationResult();
          } else {
            // æ‰€æœ‰æ£€æŸ¥ç»“æœå·²æŸ¥çœ‹å®Œæ¯•ï¼Œè¿›å…¥è¯Šæ–­é˜¶æ®µ
            // éšè—çœ¼åº•å­—å¹•ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
            if ($('#fundus-overlay').length) {
              hideFundusSubtitle();
            }
            submitExaminations();
          }
        }
        break;
        
      case 'diagnosis_reasoning':
        console.log('=== handleNextStage - è¯Šæ–­é˜¶æ®µ ===');
        console.log('å½“å‰é€‰ä¸­è¯Šæ–­IDs:', clinicalSession.selectedDiagnoses);
        
        // éšè—çœ¼åº•å­—å¹•ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
        if ($('#fundus-overlay').length) {
          hideFundusSubtitle();
        }
        if (!clinicalSession.selectedDiagnoses || clinicalSession.selectedDiagnoses.length === 0) {
          console.log('æ²¡æœ‰é€‰æ‹©è¯Šæ–­ï¼Œæ˜¾ç¤ºè­¦å‘Š');
          showFeedbackMessage('è¯·è‡³å°‘é€‰æ‹©ä¸€ä¸ªè¯Šæ–­é€‰é¡¹ï¼Œç„¶åå†æäº¤', 'warning');
          return;
        }
        console.log('å¼€å§‹è°ƒç”¨submitDiagnosis()');
        submitDiagnosis();
        break;
        
      case 'treatment_selection':
        // éšè—çœ¼åº•å­—å¹•ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
        if ($('#fundus-overlay').length) {
          hideFundusSubtitle();
        }
        if (clinicalSession.selectedTreatments.length === 0) {
          showFeedbackMessage('è¯·å…ˆé€‰æ‹©è‡³å°‘ä¸€ç§æ²»ç–—æ–¹æ¡ˆï¼Œç„¶åå†æäº¤', 'warning');
          return;
        }
        window.submitTreatments();
        break;
        
      default:
        showFeedbackMessage('å½“å‰é˜¶æ®µæ— æ³•ç»§ç»­', 'warning');
    }
    
    // æ›´æ–°å¯¼èˆªè¿›åº¦
    updateNavigationProgress();
  }
  
  function handlePreviousStage() {
    var currentStage = clinicalSession.currentStage;
    var stages = clinicalSession.stages;
    var currentIndex = stages.indexOf(currentStage);
    
    if (currentIndex > 0) {
      var previousStage = stages[currentIndex - 1];
      
      // éšè—çœ¼åº•å­—å¹•ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
      if ($('#fundus-overlay').length) {
        hideFundusSubtitle();
      }
      
      // æ›´æ–°å½“å‰é˜¶æ®µ
      clinicalSession.currentStage = previousStage;
      
      // æ ¹æ®ç›®æ ‡é˜¶æ®µæ‰§è¡Œç›¸åº”çš„åŠ è½½é€»è¾‘
      switch (previousStage) {
        case 'case_presentation':
          initializeHistoryStage();
          break;
          
        case 'examination_selection':
          loadExaminationStage();
          // æ¢å¤æ£€æŸ¥é€‰æ‹©çŠ¶æ€
          if (clinicalSession.selectedExaminations.length > 0) {
            // å¦‚æœä¹‹å‰å·²ç»é€‰æ‹©äº†æ£€æŸ¥ï¼Œæ¢å¤åˆ°é€‰æ‹©ç¡®è®¤çŠ¶æ€
            setTimeout(function() {
              updateExaminationOrderList();
              clinicalSession.selectedExaminations.forEach(function(examId) {
                $('.examination-checkbox[value="' + examId + '"]').prop('checked', true);
              });
              updateExaminationSummary();
            }, 100);
          }
          break;
          
        case 'diagnosis_reasoning':
          // é‡æ–°åŠ è½½è¯Šæ–­é˜¶æ®µï¼Œéœ€è¦ä»åç«¯è·å–è¯Šæ–­é€‰é¡¹
          loadDiagnosisStage();
          break;
          
        case 'treatment_selection':
          // é‡æ–°åŠ è½½æ²»ç–—é˜¶æ®µ
          loadTreatmentStage();
          break;
          
        default:
          showFeedbackMessage('æ— æ³•è¿”å›åˆ°æŒ‡å®šé˜¶æ®µ', 'warning');
          return;
      }
      
      // æä¾›ç”¨æˆ·åé¦ˆ
      showFeedbackMessage('å·²è¿”å›åˆ°' + getStageDisplayName(previousStage) + 'é˜¶æ®µ', 'info');
      
      // è®°å½•åˆ°å­¦ä¹ æ—¶é—´çº¿
      addToLearningTimeline('è¿”å›ä¸Šä¸€é˜¶æ®µ', 'ä»' + getStageDisplayName(currentStage) + 'è¿”å›åˆ°' + getStageDisplayName(previousStage));
    } else {
      showFeedbackMessage('å·²ç»æ˜¯ç¬¬ä¸€ä¸ªé˜¶æ®µï¼Œæ— æ³•è¿”å›', 'warning');
    }
    
    // æ›´æ–°å¯¼èˆªè¿›åº¦å’ŒæŒ‰é’®çŠ¶æ€
    updateNavigationProgress();
  }
  
  // è·å–é˜¶æ®µæ˜¾ç¤ºåç§°
  function getStageDisplayName(stage) {
    var stageNames = {
      'history': 'ç—…å²é‡‡é›†',
      'examination': 'ä¸´åºŠæ£€æŸ¥',
      'diagnosis': 'è¯Šæ–­åˆ†æ',
      'treatment': 'æ²»ç–—æ–¹æ¡ˆ',
      'feedback': 'å­¦ä¹ åé¦ˆ'
    };
    return stageNames[stage] || stage;
  }
  
  // åŠ è½½è¯Šæ–­é˜¶æ®µ
  function loadDiagnosisStage() {
    // å¦‚æœæœ‰ç¼“å­˜çš„è¯Šæ–­é€‰é¡¹ï¼Œç›´æ¥ä½¿ç”¨ï¼›å¦åˆ™é‡æ–°è·å–
    if (clinicalSession.diagnosisOptions && clinicalSession.diagnosisOptions.length > 0) {
      renderDiagnosisStage({
        diagnosis_options: clinicalSession.diagnosisOptions,
        examination_score: clinicalSession.scores.examination
      });
    } else {
      // é‡æ–°è·å–è¯Šæ–­é€‰é¡¹
      $.getJSON('/api/clinical/case/' + clinicalSession.caseId + '/diagnoses/', function(resp) {
        if (resp.success) {
          clinicalSession.diagnosisOptions = resp.data.diagnosis_options;
          renderDiagnosisStage(resp.data);
        } else {
          showErrorMessage('åŠ è½½è¯Šæ–­é€‰é¡¹å¤±è´¥: ' + resp.message);
        }
      }).fail(function() {
        showErrorMessage('ç½‘ç»œé”™è¯¯ï¼Œè¯·æ£€æŸ¥è¿æ¥åé‡è¯•');
      });
    }
  }
  
  // åŠ è½½æ²»ç–—é˜¶æ®µ - å®šä¹‰ä¸ºå…¨å±€å‡½æ•°
  window.loadTreatmentStage = function() {
    console.log('=== åŠ è½½æ²»ç–—é˜¶æ®µ ===');
    console.log('ç—…ä¾‹ID:', clinicalSession.caseId);
    
    // åŒæ­¥é˜¶æ®µåˆ°åç«¯
    syncStageToBackend('treatment_selection');
    
    // ä»åç«¯APIåŠ¨æ€è·å–æ²»ç–—é€‰é¡¹
    $.ajax({
      url: '/api/clinical/case/' + clinicalSession.caseId + '/treatment-options/',
      method: 'GET',
      success: function(resp) {
        console.log('æ²»ç–—é€‰é¡¹APIå“åº”:', resp);
        
        if (resp.success && resp.data && resp.data.treatment_options) {
          // ç¼“å­˜æ²»ç–—é€‰é¡¹æ•°æ®
          clinicalSession.treatmentOptions = resp.data.treatment_options;
          
          // æ¸²æŸ“æ²»ç–—é˜¶æ®µUI
          renderTreatmentStage({
            treatment_options: resp.data.treatment_options,
            treatments: resp.data.treatment_options,
            selected_diagnoses: clinicalSession.selectedDiagnoses || []
          });
          
          console.log('æ²»ç–—é€‰é¡¹åŠ è½½æˆåŠŸï¼Œå…±', resp.data.treatment_options.length, 'ä¸ªé€‰é¡¹');
        } else {
          alert('åŠ è½½æ²»ç–—é€‰é¡¹å¤±è´¥: ' + (resp.message || 'æœªçŸ¥é”™è¯¯'));
          console.error('æ²»ç–—é€‰é¡¹åŠ è½½å¤±è´¥:', resp);
        }
      },
      error: function(xhr, status, error) {
        console.error('æ²»ç–—é€‰é¡¹APIé”™è¯¯:', error, xhr.responseText);
        
        var errorMsg = 'åŠ è½½æ²»ç–—é€‰é¡¹å¤±è´¥';
        if (xhr.status === 404) {
          errorMsg = 'APIæ¥å£æœªæ‰¾åˆ°ï¼Œè¯·æ£€æŸ¥åç«¯é…ç½®';
        } else if (xhr.status === 403) {
          errorMsg = 'æƒé™ä¸è¶³ï¼Œè¯·é‡æ–°ç™»å½•';
        } else if (xhr.status === 500) {
          errorMsg = 'æœåŠ¡å™¨å†…éƒ¨é”™è¯¯: ' + error;
        }
        
        alert(errorMsg);
      }
    });
  }
  
  // æäº¤æ²»ç–—æ–¹æ¡ˆ
  window.submitTreatment = function() {
    // å…¼å®¹æ—§è°ƒç”¨ï¼šç»Ÿä¸€èµ° submitTreatments çš„å®Œæ•´è¯„åˆ†ä¸é˜¶æ®µæ¨è¿›æµç¨‹
    if (typeof window.submitTreatments === 'function') {
      window.submitTreatments();
      return;
    }

    alert('æäº¤æ²»ç–—æ–¹æ¡ˆåŠŸèƒ½æœªåˆå§‹åŒ–ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•');
  }
  
  // è¿”å›è¯Šæ–­é˜¶æ®µ
  window.returnToDiagnosis = function() {
    if (confirm('ç¡®å®šè¦è¿”å›è¯Šæ–­é˜¶æ®µå—ï¼Ÿå½“å‰é€‰æ‹©å°†è¢«ä¿ç•™ã€‚')) {
      $('#history-collection-fullscreen').fadeOut(300, function() {
        // TODO: æ˜¾ç¤ºè¯Šæ–­é˜¶æ®µ
        alert('è¿”å›è¯Šæ–­åŠŸèƒ½å¾…å®ç°');
      });
    }
  }
  
  // ==================== OCTå›¾åƒäº¤äº’åŠŸèƒ½ ====================
  
  // å›¾åƒç¼©æ”¾åŠŸèƒ½
  var currentZoom = 1;
  
  function zoomImage(direction) {
    var $image = $('.oct-modal-image');
    if ($image.length === 0) return;
    
    if (direction === 'in') {
      currentZoom = Math.min(currentZoom * 1.2, 5); // æœ€å¤§5å€
    } else if (direction === 'out') {
      currentZoom = Math.max(currentZoom / 1.2, 0.5); // æœ€å°0.5å€
    }
    
    $image.css('transform', 'scale(' + currentZoom + ')');
    
    // æ˜¾ç¤ºç¼©æ”¾çº§åˆ«
    showZoomLevel(currentZoom);
  }
  
  function resetImageZoom() {
    currentZoom = 1;
    $('.oct-modal-image').css('transform', 'scale(1)');
    showZoomLevel(1);
  }
  
  function showZoomLevel(level) {
    var percentage = Math.round(level * 100);
    
    // ç§»é™¤å·²å­˜åœ¨çš„ç¼©æ”¾æŒ‡ç¤ºå™¨
    $('.zoom-indicator').remove();
    
    // åˆ›å»ºæ–°çš„ç¼©æ”¾æŒ‡ç¤ºå™¨
    var indicator = $('<div class="zoom-indicator">' + percentage + '%</div>');
    indicator.css({
      position: 'absolute',
      top: '10px',
      left: '10px',
      background: 'rgba(0,0,0,0.7)',
      color: 'white',
      padding: '5px 10px',
      borderRadius: '4px',
      fontSize: '12px',
      zIndex: '1000'
    });
    
    $('.oct-modal-image-container').css('position', 'relative').append(indicator);
    
    // 2ç§’åè‡ªåŠ¨éšè—
    setTimeout(function() {
      indicator.fadeOut(300, function() {
        $(this).remove();
      });
    }, 2000);
  }
  
  // å›¾åƒæµ‹é‡åŠŸèƒ½
  var measurementMode = false;
  var measurementPoints = [];
  
  function toggleImageMeasurement() {
    measurementMode = !measurementMode;
    var $button = $('button[onclick="toggleImageMeasurement()"]');
    
    if (measurementMode) {
      $button.removeClass('btn-outline-secondary').addClass('btn-warning');
      $button.html('<i class="fas fa-ruler"></i> é€€å‡ºæµ‹é‡');
      enableMeasurementMode();
    } else {
      $button.removeClass('btn-warning').addClass('btn-outline-secondary');
      $button.html('<i class="fas fa-ruler"></i> æµ‹é‡');
      disableMeasurementMode();
    }
  }
  
  function enableMeasurementMode() {
    $('.oct-modal-image').css('cursor', 'crosshair');
    
    // æ·»åŠ ç‚¹å‡»äº‹ä»¶ç›‘å¬
    $('.oct-modal-image').off('click.measurement').on('click.measurement', function(e) {
      if (!measurementMode) return;
      
      var rect = this.getBoundingClientRect();
      var x = e.clientX - rect.left;
      var y = e.clientY - rect.top;
      
      addMeasurementPoint(x, y);
    });
  }
  
  function disableMeasurementMode() {
    $('.oct-modal-image').css('cursor', 'zoom-in');
    $('.oct-modal-image').off('click.measurement');
    clearMeasurementPoints();
  }
  
  function addMeasurementPoint(x, y) {
    measurementPoints.push({x: x, y: y});
    
    // åˆ›å»ºæµ‹é‡ç‚¹æ ‡è®°
    var $marker = $('<div class="measurement-point"></div>');
    $marker.css({
      position: 'absolute',
      left: x + 'px',
      top: y + 'px',
      width: '8px',
      height: '8px',
      background: '#ff6b6b',
      borderRadius: '50%',
      border: '2px solid white',
      transform: 'translate(-50%, -50%)',
      zIndex: 1000
    });
    
    $('.oct-modal-image-container').append($marker);
    
    // å¦‚æœæœ‰ä¸¤ä¸ªç‚¹ï¼Œç»˜åˆ¶æµ‹é‡çº¿
    if (measurementPoints.length === 2) {
      drawMeasurementLine();
      measurementPoints = []; // é‡ç½®æµ‹é‡ç‚¹
    }
  }
  
  function drawMeasurementLine() {
    var point1 = measurementPoints[0];
    var point2 = measurementPoints[1];
    
    var distance = Math.sqrt(Math.pow(point2.x - point1.x, 2) + Math.pow(point2.y - point1.y, 2));
    var angle = Math.atan2(point2.y - point1.y, point2.x - point1.x) * 180 / Math.PI;
    
    // åˆ›å»ºæµ‹é‡çº¿
    var $line = $('<div class="measurement-line"></div>');
    $line.css({
      position: 'absolute',
      left: point1.x + 'px',
      top: point1.y + 'px',
      width: distance + 'px',
      height: '2px',
      background: '#ff6b6b',
      transformOrigin: '0 50%',
      transform: 'rotate(' + angle + 'deg)',
      zIndex: 999
    });
    
    $('.oct-modal-image-container').append($line);
    
    // æ˜¾ç¤ºè·ç¦»æ ‡ç­¾ï¼ˆåƒç´ å•ä½ï¼‰
    var $label = $('<div class="measurement-label">' + Math.round(distance) + 'px</div>');
    $label.css({
      position: 'absolute',
      left: ((point1.x + point2.x) / 2) + 'px',
      top: ((point1.y + point2.y) / 2 - 15) + 'px',
      background: 'rgba(0,0,0,0.8)',
      color: 'white',
      padding: '2px 6px',
      borderRadius: '3px',
      fontSize: '12px',
      transform: 'translate(-50%, -50%)',
      zIndex: 1001
    });
    
    $('.oct-modal-image-container').append($label);
  }
  
  function clearMeasurementPoints() {
    $('.measurement-point, .measurement-line, .measurement-label').remove();
    measurementPoints = [];
  }
  
  // ä¿å­˜å›¾åƒæ ‡æ³¨
  function saveImageAnnotation() {
    // æ”¶é›†å½“å‰çš„æ ‡æ³¨æ•°æ®
    var annotations = [];
    
    $('.measurement-point').each(function() {
      var $point = $(this);
      annotations.push({
        type: 'point',
        x: parseFloat($point.css('left')),
        y: parseFloat($point.css('top'))
      });
    });
    
    $('.measurement-line').each(function() {
      var $line = $(this);
      annotations.push({
        type: 'line',
        x: parseFloat($line.css('left')),
        y: parseFloat($line.css('top')),
        width: parseFloat($line.css('width')),
        rotation: $line.css('transform')
      });
    });
    
    if (annotations.length > 0) {
      // è¿™é‡Œå¯ä»¥ä¿å­˜åˆ°æœåŠ¡å™¨æˆ–æœ¬åœ°å­˜å‚¨
      console.log('ä¿å­˜æ ‡æ³¨æ•°æ®:', annotations);
      showFeedbackMessage('æ ‡æ³¨å·²ä¿å­˜', 'success');
    } else {
      showFeedbackMessage('æ²¡æœ‰æ ‡æ³¨æ•°æ®éœ€è¦ä¿å­˜', 'info');
    }
  }
  
  // ==================== ç—…å²é‡‡é›†é˜¶æ®µç‰¹æ®ŠåŠŸèƒ½ ====================
  
  // æ˜¾ç¤ºç—…å²é‡‡é›†å¸ƒå±€
  function showHistoryCollectionLayout() {
    console.log('åˆ‡æ¢åˆ°ç—…å²é‡‡é›†å…¨å±æ¨¡å¼');
    
    // æ˜¾ç¤ºå…¨å±å¸ƒå±€
    $('#history-collection-fullscreen').show().css({
      'display': 'flex',
      'position': 'fixed',
      'top': '0',
      'left': '0',
      'width': '100vw',
      'height': '100vh',
      'z-index': '1000',
      'background': 'white'
    });
    
    // ç¡®ä¿å‡½æ•°åœ¨å…¨å±€ä½œç”¨åŸŸä¸­
    window.quickQuestion = quickQuestion;
    window.sendHistoryChatMessage = sendHistoryChatMessage;
    
    console.log('å¿«é€Ÿé—®é¢˜æŒ‰é’®æ•°é‡:', $('.btn[onclick*="quickQuestion"]').length);
    
    // éšè—ä¼ ç»Ÿå¸ƒå±€å’Œå…¶ä»–é¡µé¢å…ƒç´ 
    $('#traditional-layout').hide();
    $('body').css('overflow', 'hidden'); // é˜²æ­¢èƒŒæ™¯æ»šåŠ¨
    
    console.log('å…¨å±å¸ƒå±€æ˜¾ç¤ºçŠ¶æ€:', $('#history-collection-fullscreen').is(':visible'));
    
    initializeHistoryChat();

    // åˆå§‹åŒ–æ—¶å°†èŠå¤©çª—å£æ”¾åœ¨å·¦æ å³ä¸‹è§’
    if (typeof window.positionChatWindowToLeftColumn === 'function') {
      setTimeout(function() { window.positionChatWindowToLeftColumn(true); }, 0);
    }
  }
  
  // éšè—ç—…å²é‡‡é›†å¸ƒå±€
  function hideHistoryCollectionLayout() {
    $('#history-collection-fullscreen').hide().css({
      'position': 'relative',
      'top': 'auto',
      'left': 'auto',
      'width': 'auto',
      'height': 'auto',
      'z-index': 'auto'
    });
    $('#traditional-layout').show().removeClass('d-none');
    $('body').css('overflow', 'auto'); // æ¢å¤é¡µé¢æ»šåŠ¨

    // è¿”å›ä¼ ç»Ÿå¸ƒå±€åï¼ŒåŒæ ·æ”¾åœ¨å·¦æ å³ä¸‹è§’
    if (typeof window.positionChatWindowToLeftColumn === 'function') {
      setTimeout(function() { window.positionChatWindowToLeftColumn(true); }, 0);
    }
  }
  
  // åˆå§‹åŒ–ç—…å²èŠå¤©
  function initializeHistoryChat() {
    if (!$('#chat-messages-history').children().length || 
        $('#chat-messages-history').children().first().hasClass('text-center')) {
      addHistoryChatMessage('system_hint', 'æ‚¨å¥½ï¼æˆ‘æ˜¯æ‚¨çš„æ‚£è€…ã€‚è¯·æ‚¨è¯¢é—®æˆ‘çš„ç—…å²ä¿¡æ¯ã€‚', 'patient');
      addHistoryChatMessage('patient_response', 'åŒ»ç”Ÿï¼Œæˆ‘æœ€è¿‘çœ¼éƒ¨æœ‰äº›ä¸é€‚ï¼Œå¸Œæœ›æ‚¨èƒ½å¸®æˆ‘çœ‹çœ‹ã€‚', 'patient');
    }
    
    // åŠ è½½å·²ä¿å­˜çš„ç—…å²æ±‡æ€»
    loadSavedHistorySummary();
  }
  
  // åŠ è½½å·²ä¿å­˜çš„ç—…å²æ±‡æ€»
  function loadSavedHistorySummary() {
    getHistorySummary().then(data => {
      const summary = data.history_summary;
      if (summary) {
        if (summary.chief_complaint) {
          updateChiefComplaintUI(summary.chief_complaint);
        }
        if (summary.duration) {
          updateDurationInfoUI(summary.duration);
        }
        if (summary.symptom_nature) {
          updateSymptomNatureUI(summary.symptom_nature);
        }
        if (summary.severity) {
          updateSeverityInfoUI(summary.severity);
        }
        if (summary.trigger_factors) {
          updateTriggerFactorsUI(summary.trigger_factors);
        }
        if (summary.past_history) {
          updatePastHistoryUI(summary.past_history);
        }
        if (summary.family_history) {
          updateFamilyHistoryUI(summary.family_history);
        }
      }
    }).catch(error => {
      console.error('åŠ è½½ç—…å²æ±‡æ€»å¤±è´¥:', error);
    });
  }
  
  // UIæ›´æ–°å‡½æ•°ï¼ˆä¸è§¦å‘åç«¯ä¿å­˜ï¼‰
  function updateChiefComplaintUI(content) {
    const summaryElement = $('#chief-complaint-summary');
    summaryElement.html(`
      <div class="d-flex align-items-start">
        <i class="fas fa-quote-left text-primary me-2 mt-1"></i>
        <div>
          <p class="mb-1">${content}</p>
          <small class="text-muted">é€šè¿‡é—®è¯Šè·å¾—</small>
        </div>
      </div>
    `).addClass('info-summary-card has-info');
  }
  
  function updateDurationInfoUI(content) {
    $('#duration-info').text(content).removeClass('text-muted').addClass('text-dark fw-bold text-success');
    $('#present-illness-summary').addClass('info-summary-card has-info');
  }
  
  function updateSymptomNatureUI(content) {
    $('#symptom-nature').text(content).removeClass('text-muted').addClass('text-dark fw-bold text-success');
    $('#present-illness-summary').addClass('info-summary-card has-info');
  }
  
  function updateSeverityInfoUI(content) {
    $('#severity-info').text(content).removeClass('text-muted').addClass('text-dark fw-bold text-success');
    $('#present-illness-summary').addClass('info-summary-card has-info');
  }
  
  function updateTriggerFactorsUI(content) {
    $('#trigger-factors').text(content).removeClass('text-muted').addClass('text-dark fw-bold text-success');
    $('#present-illness-summary').addClass('info-summary-card has-info');
  }
  
  function updatePastHistoryUI(content) {
    const summaryElement = $('#past-history-summary');
    summaryElement.html(`
      <div class="d-flex align-items-start">
        <i class="fas fa-history text-info me-2 mt-1"></i>
        <div>
          <p class="mb-1">${content}</p>
          <small class="text-muted">æ—¢å¾€ç—…å²</small>
        </div>
      </div>
    `).addClass('info-summary-card has-info');
  }
  
  function updateFamilyHistoryUI(content) {
    const summaryElement = $('#family-history-summary');
    summaryElement.html(`
      <div class="d-flex align-items-start">
        <i class="fas fa-users text-success me-2 mt-1"></i>
        <div>
          <p class="mb-1">${content}</p>
          <small class="text-muted">å®¶æ—ç—…å²</small>
        </div>
      </div>
    `).addClass('info-summary-card has-info');
  }
  
  // ==================== APIè°ƒç”¨å‡½æ•° ====================
  
  // æ›´æ–°ä¼šè¯é˜¶æ®µ - è®¾ç½®ä¸ºå…¨å±€å‡½æ•°
  window.updateSessionStage = function(stage) {
    // ç»Ÿä¸€é˜¶æ®µå‘½åï¼ˆå…¼å®¹æ—§å…¥å£ï¼‰
    try {
      if (typeof window.normalizeClinicalStage === 'function') {
        stage = window.normalizeClinicalStage(stage);
      }
    } catch (eNorm) {}

    // å…¼å®¹æ—§å…¥å£ï¼šæœ‰äº›æµç¨‹è°ƒç”¨ updateSessionStage è€Œä¸æ˜¯ syncStageToBackendï¼Œ
    // è¿™é‡Œä¹Ÿéœ€è¦è®°å½•å‰ç«¯é˜¶æ®µç”¨æ—¶ï¼Œé¿å…å¤ç›˜â€œæ£€æŸ¥é€‰æ‹©â€æ˜¾ç¤ºæœªè®°å½•ã€‚
    try {
      if (typeof window.trackStageTransition === 'function') {
        window.trackStageTransition(stage);
      }
    } catch (e) {}

    return $.ajax({
      url: '/api/clinical/case/' + clinicalSession.caseId + '/update-stage/',
      method: 'POST',
      data: JSON.stringify({ stage: stage }),
      contentType: 'application/json',
      headers: {
        'X-CSRFToken': $('[name=csrfmiddlewaretoken]').val()
      }
    }).then(response => {
      if (response.success) {
        console.log('é˜¶æ®µåˆ‡æ¢æˆåŠŸ:', response.message);
        return response;
      } else {
        throw new Error(response.error || 'é˜¶æ®µåˆ‡æ¢å¤±è´¥');
      }
    });
  };
  
  // ä¿å­˜ç—…å²æ±‡æ€»ä¿¡æ¯
  function saveHistorySummary(summaryData) {
    return $.ajax({
      url: '/api/clinical/case/' + clinicalSession.caseId + '/save-history/',
      method: 'POST',
      data: JSON.stringify(summaryData),
      contentType: 'application/json',
      headers: {
        'X-CSRFToken': $('[name=csrfmiddlewaretoken]').val()
      }
    }).then(response => {
      if (response.success) {
        console.log('ç—…å²æ±‡æ€»ä¿å­˜æˆåŠŸ');
        return response;
      } else {
        throw new Error(response.error || 'ç—…å²æ±‡æ€»ä¿å­˜å¤±è´¥');
      }
    });
  }
  
  // è·å–ç—…å²æ±‡æ€»ä¿¡æ¯
  function getHistorySummary() {
    return $.ajax({
      url: '/api/clinical/case/' + clinicalSession.caseId + '/get-history/',
      method: 'GET'
    }).then(response => {
      if (response.success) {
        return response.data;
      } else {
        throw new Error(response.error || 'è·å–ç—…å²æ±‡æ€»å¤±è´¥');
      }
    });
  }

  // å¿«é€Ÿé—®é¢˜å‡½æ•°
  function quickQuestion(question) {
    console.log('å¿«é€Ÿé—®é¢˜è¢«ç‚¹å‡»:', question);
    console.log('clinicalSession.caseId:', clinicalSession.caseId);
    
    // æ£€æŸ¥å½“å‰é˜¶æ®µæ˜¯å¦å…è®¸èŠå¤©ï¼ˆè¯Šæ–­å’Œæ²»ç–—é˜¶æ®µç¦æ­¢èŠå¤©ï¼‰
    if (clinicalSession.currentStage === 'diagnosis_reasoning' || clinicalSession.currentStage === 'treatment_selection') {
      alert('å½“å‰é˜¶æ®µä¸æ”¯æŒèŠå¤©åŠŸèƒ½');
      return;
    }
    
    const inputElement = document.getElementById('patient-question-global');
    if (!inputElement) {
      console.error('æ‰¾ä¸åˆ°å…¨å±€èŠå¤©è¾“å…¥æ¡†å…ƒç´ ');
      return;
    }
    
    inputElement.value = question;
    askPatient();
  }
  
  // å¤„ç†ç—…å²èŠå¤©é”®ç›˜äº‹ä»¶
  function handleHistoryChatKeyPress(event) {
    if (event.key === 'Enter') {
      sendHistoryChatMessage();
    }
  }
  
  // æµ®åŠ¨çª—å£æ§åˆ¶å‡½æ•°
  window.toggleChatWindow = function() {
    const chatWindow = document.getElementById('floating-chat-window-global');
    const chatBody = document.getElementById('chat-body-container-global');
    const toggleIcon = document.getElementById('chat-toggle-icon-global');
    const chatHeaderTitle = chatWindow.querySelector('.chat-header .d-flex:first-child');
    
    if (!chatWindow || !chatBody || !toggleIcon) {
      console.error('Global chat window elements not found');
      return;
    }
    
    if (chatWindow.classList.contains('minimized')) {
      // æ‰©å±•ä¸ºå®Œæ•´çª—å£
      chatWindow.classList.remove('minimized');
      chatBody.style.display = 'flex';
      toggleIcon.className = 'fas fa-minus';
      if (chatHeaderTitle) chatHeaderTitle.style.display = 'flex';
    } else {
      // æœ€å°åŒ–ä¸ºå°åœ†åœˆ
      chatWindow.classList.add('minimized');
      chatBody.style.display = 'none';
      toggleIcon.className = 'fas fa-comments';
      if (chatHeaderTitle) chatHeaderTitle.style.display = 'none';
    }
  };

  // å°†â€œå…¨å±€æµ®åŠ¨èŠå¤©çª—å£â€å®šä½åˆ°å·¦æ çš„å³ä¸‹è§’ï¼ˆåˆå§‹åŒ–ç”¨ï¼›ç”¨æˆ·æ‹–æ‹½åä¸å†å¼ºåˆ¶è¦†ç›–ï¼‰
  window.positionChatWindowToLeftColumn = function(force) {
    const chatWindow = document.getElementById('floating-chat-window-global');
    if (!chatWindow) return;

    if (!force && chatWindow.dataset && chatWindow.dataset.userMoved === '1') {
      return;
    }

    // å­¦ä¹ åé¦ˆé˜¶æ®µä¼šéšè—èŠå¤©çª—å£ï¼Œé¿å…åœ¨éšè—çŠ¶æ€ä¸‹è®¡ç®—å°ºå¯¸
    if (chatWindow.style && chatWindow.style.display === 'none') {
      return;
    }

    // éœ€æ±‚ï¼šå°†åˆå§‹åŒ–ä½ç½®å›ºå®šåˆ°æŒ‡å®šåæ ‡ï¼ˆæ¥è‡ªç”¨æˆ·æ‹–æ‹½åçš„æœŸæœ›ä½ç½®ï¼‰
    // æ³¨æ„ï¼šä»ä¿ç•™ userMoved é˜²è¦†ç›–é€»è¾‘ï¼Œå¹¶å¯¹è§†å£åšè¾¹ç•Œè£å‰ªã€‚
    const defaultLeft = 842;
    const defaultTop = 618.75;

    const chatWidth = chatWindow.offsetWidth || 350;
    const chatHeight = chatWindow.offsetHeight || 420;

    let left = defaultLeft;
    let top = defaultTop;

    // è§†å£è¾¹ç•Œè£å‰ª
    left = Math.max(0, Math.min(left, window.innerWidth - chatWidth));
    top = Math.max(0, Math.min(top, window.innerHeight - chatHeight));

    chatWindow.style.position = 'fixed';
    chatWindow.style.left = left + 'px';
    chatWindow.style.top = top + 'px';
    chatWindow.style.right = 'auto';
    chatWindow.style.bottom = 'auto';
    chatWindow.style.transform = 'none';
    return;
  };

  // è®©èŠå¤©çª—å£å¯æ‹–æ‹½
  window.makeChatDraggable = function() {
    const chatWindow = document.getElementById('floating-chat-window-global');
    if (!chatWindow) {
      console.error('Global chat window not found');
      return;
    }
    console.log('åˆå§‹åŒ–æ‹–æ‹½åŠŸèƒ½ï¼Œçª—å£ID:', chatWindow.id);
    
    let isDragging = false;
    let startX = 0;
    let startY = 0;
    let offsetX = 0;
    let offsetY = 0;

    function getMousePos(e) {
      return {
        x: e.type.indexOf('touch') === 0 ? e.touches[0].clientX : e.clientX,
        y: e.type.indexOf('touch') === 0 ? e.touches[0].clientY : e.clientY
      };
    }

    function dragStart(e) {
      // é˜»æ­¢åœ¨äº¤äº’å…ƒç´ ä¸Šå¼€å§‹æ‹–æ‹½
      if (e.target.tagName === 'INPUT' || 
          e.target.tagName === 'TEXTAREA' || 
          e.target.tagName === 'BUTTON' || 
          e.target.tagName === 'I' ||
          e.target.classList.contains('btn') ||
          e.target.closest('.btn')) {
        return;
      }
      
      // æ£€æŸ¥æ˜¯å¦åœ¨å¯æ‹–æ‹½åŒºåŸŸ
      let canStartDrag = false;
      
      if (chatWindow.classList.contains('minimized')) {
        // æœ€å°åŒ–çŠ¶æ€ï¼šåªæœ‰å¤´éƒ¨åŒºåŸŸå¯æ‹–æ‹½ï¼Œæ’é™¤æŒ‰é’®
        const header = chatWindow.querySelector('.chat-header');
        if (header && (e.target === header || header.contains(e.target))) {
          canStartDrag = true;
        }
      } else {
        // å®Œæ•´çŠ¶æ€ï¼šåªæœ‰æ ‡é¢˜æ å¯æ‹–æ‹½
        const header = chatWindow.querySelector('.chat-header');
        const titleArea = header ? header.querySelector('.d-flex:first-child') : null;
        if (titleArea && (e.target === titleArea || titleArea.contains(e.target) || e.target === header)) {
          canStartDrag = true;
        }
      }
      
      if (!canStartDrag) {
        return;
      }
      
      console.log('å¼€å§‹æ‹–æ‹½');

      const pos = getMousePos(e);
      startX = pos.x;
      startY = pos.y;
      
      // è·å–å½“å‰ä½ç½®
      const rect = chatWindow.getBoundingClientRect();
      offsetX = rect.left;
      offsetY = rect.top;
      
      isDragging = true;
      chatWindow.style.zIndex = '1051';
      document.body.style.userSelect = 'none';
      
      e.preventDefault();
      console.log('å¼€å§‹æ‹–æ‹½ï¼Œåˆå§‹ä½ç½®:', offsetX, offsetY);
    }

    function drag(e) {
      if (!isDragging) return;
      
      e.preventDefault();
      
      const pos = getMousePos(e);
      const deltaX = pos.x - startX;
      const deltaY = pos.y - startY;
      
      let newX = offsetX + deltaX;
      let newY = offsetY + deltaY;
      
      // é™åˆ¶æ‹–æ‹½èŒƒå›´
      const windowWidth = window.innerWidth;
      const windowHeight = window.innerHeight;
      const chatWidth = chatWindow.offsetWidth;
      const chatHeight = chatWindow.offsetHeight;
      
      // è¾¹ç•Œæ£€æŸ¥
      if (newX < 0) newX = 0;
      if (newY < 0) newY = 0;
      if (newX + chatWidth > windowWidth) newX = windowWidth - chatWidth;
      if (newY + chatHeight > windowHeight) newY = windowHeight - chatHeight;
      
      // åº”ç”¨æ–°ä½ç½®
      chatWindow.style.position = 'fixed';
      chatWindow.style.left = newX + 'px';
      chatWindow.style.top = newY + 'px';
      chatWindow.style.right = 'auto';
      chatWindow.style.bottom = 'auto';
      chatWindow.style.transform = 'none';
      
      console.log(`æ‹–æ‹½åˆ°: ${newX}, ${newY}`);
    }

    function dragEnd(e) {
      if (isDragging) {
        isDragging = false;
        chatWindow.style.zIndex = '1050';
        document.body.style.userSelect = '';
        console.log('æ‹–æ‹½ç»“æŸ');

        // æ ‡è®°ç”¨æˆ·å·²æ‰‹åŠ¨ç§»åŠ¨è¿‡çª—å£ï¼Œåç»­é˜¶æ®µåˆ‡æ¢ä¸å†å¼ºåˆ¶é‡ç½®ä½ç½®
        if (chatWindow.dataset) {
          chatWindow.dataset.userMoved = '1';
        }
        
        // å¦‚æœæ˜¯æœ€å°åŒ–çŠ¶æ€çš„å¾ˆå°ç§»åŠ¨ï¼Œå¯èƒ½æ˜¯ç‚¹å‡»è€Œä¸æ˜¯æ‹–æ‹½
        if (chatWindow.classList.contains('minimized')) {
          const pos = getMousePos(e);
          const distance = Math.sqrt(Math.pow(pos.x - startX, 2) + Math.pow(pos.y - startY, 2));
          if (distance < 5) { // ç§»åŠ¨è·ç¦»å°äº5pxï¼Œè®¤ä¸ºæ˜¯ç‚¹å‡»
            // å…è®¸æŒ‰é’®ç‚¹å‡»äº‹ä»¶
            console.log('æ£€æµ‹åˆ°ç‚¹å‡»è€Œéæ‹–æ‹½');
          }
        }
      }
    }

    // ä¸ºæ•´ä¸ªèŠå¤©çª—å£æ·»åŠ äº‹ä»¶ç›‘å¬å™¨
    chatWindow.addEventListener("mousedown", dragStart, false);
    document.addEventListener("mouseup", dragEnd, false);
    document.addEventListener("mousemove", drag, false);
    
    // è§¦æ‘¸äº‹ä»¶æ”¯æŒ
    chatWindow.addEventListener("touchstart", dragStart, false);
    document.addEventListener("touchend", dragEnd, false);
    document.addEventListener("touchmove", drag, false);
  };

  // è®©èŠå¤©çª—å£å¯è°ƒæ•´å¤§å°
  window.makeChatResizable = function() {
    const chatWindow = document.getElementById('floating-chat-window-global');
    if (!chatWindow) {
      console.error('Global chat window not found for resize');
      return;
    }
    
    const resizeHandles = chatWindow.querySelectorAll('.resize-handle');
    let isResizing = false;
    let currentHandle = null;
    let startX = 0;
    let startY = 0;
    let startWidth = 0;
    let startHeight = 0;
    let startLeft = 0;
    let startTop = 0;

    function getMousePos(e) {
      return {
        x: e.type.indexOf('touch') === 0 ? e.touches[0].clientX : e.clientX,
        y: e.type.indexOf('touch') === 0 ? e.touches[0].clientY : e.clientY
      };
    }

    function resizeStart(e) {
      // ä¸åœ¨æœ€å°åŒ–çŠ¶æ€æ—¶æ‰å…è®¸è°ƒæ•´å¤§å°
      if (chatWindow.classList.contains('minimized')) {
        return;
      }

      const handle = e.target;
      if (!handle.classList.contains('resize-handle')) {
        return;
      }

      e.preventDefault();
      e.stopPropagation();

      currentHandle = handle;
      isResizing = true;
      
      const pos = getMousePos(e);
      startX = pos.x;
      startY = pos.y;
      
      const rect = chatWindow.getBoundingClientRect();
      startWidth = rect.width;
      startHeight = rect.height;
      startLeft = rect.left;
      startTop = rect.top;
      
      chatWindow.classList.add('resizing');
      document.body.style.userSelect = 'none';
      document.body.style.cursor = handle.style.cursor;

      console.log('å¼€å§‹è°ƒæ•´å¤§å°ï¼Œæ–¹å‘:', handle.dataset.direction);
    }

    function resize(e) {
      if (!isResizing || !currentHandle) return;
      
      e.preventDefault();
      
      const pos = getMousePos(e);
      const deltaX = pos.x - startX;
      const deltaY = pos.y - startY;
      const direction = currentHandle.dataset.direction;
      
      let newWidth = startWidth;
      let newHeight = startHeight;
      let newLeft = startLeft;
      let newTop = startTop;
      
      // æœ€å°/æœ€å¤§å°ºå¯¸é™åˆ¶
      const minWidth = 300;
      const minHeight = 200;
      const maxWidth = window.innerWidth * 0.9;
      const maxHeight = window.innerHeight * 0.9;
      
      // æ ¹æ®æ‹–æ‹½æ–¹å‘è°ƒæ•´å°ºå¯¸å’Œä½ç½®
      switch(direction) {
        case 'se': // å³ä¸‹è§’
          newWidth = Math.max(minWidth, Math.min(maxWidth, startWidth + deltaX));
          newHeight = Math.max(minHeight, Math.min(maxHeight, startHeight + deltaY));
          break;
        case 'sw': // å·¦ä¸‹è§’
          newWidth = Math.max(minWidth, Math.min(maxWidth, startWidth - deltaX));
          newHeight = Math.max(minHeight, Math.min(maxHeight, startHeight + deltaY));
          if (newWidth > minWidth) newLeft = startLeft + deltaX;
          break;
        case 'ne': // å³ä¸Šè§’
          newWidth = Math.max(minWidth, Math.min(maxWidth, startWidth + deltaX));
          newHeight = Math.max(minHeight, Math.min(maxHeight, startHeight - deltaY));
          if (newHeight > minHeight) newTop = startTop + deltaY;
          break;
        case 'nw': // å·¦ä¸Šè§’
          newWidth = Math.max(minWidth, Math.min(maxWidth, startWidth - deltaX));
          newHeight = Math.max(minHeight, Math.min(maxHeight, startHeight - deltaY));
          if (newWidth > minWidth) newLeft = startLeft + deltaX;
          if (newHeight > minHeight) newTop = startTop + deltaY;
          break;
        case 'e': // å³è¾¹
          newWidth = Math.max(minWidth, Math.min(maxWidth, startWidth + deltaX));
          break;
        case 'w': // å·¦è¾¹
          newWidth = Math.max(minWidth, Math.min(maxWidth, startWidth - deltaX));
          if (newWidth > minWidth) newLeft = startLeft + deltaX;
          break;
        case 's': // ä¸‹è¾¹
          newHeight = Math.max(minHeight, Math.min(maxHeight, startHeight + deltaY));
          break;
        case 'n': // ä¸Šè¾¹
          newHeight = Math.max(minHeight, Math.min(maxHeight, startHeight - deltaY));
          if (newHeight > minHeight) newTop = startTop + deltaY;
          break;
      }
      
      // è¾¹ç•Œæ£€æŸ¥
      if (newLeft < 0) {
        newWidth += newLeft;
        newLeft = 0;
      }
      if (newTop < 0) {
        newHeight += newTop;
        newTop = 0;
      }
      if (newLeft + newWidth > window.innerWidth) {
        newWidth = window.innerWidth - newLeft;
      }
      if (newTop + newHeight > window.innerHeight) {
        newHeight = window.innerHeight - newTop;
      }
      
      // åº”ç”¨æ–°çš„å°ºå¯¸å’Œä½ç½®
      chatWindow.style.width = newWidth + 'px';
      chatWindow.style.height = newHeight + 'px';
      chatWindow.style.left = newLeft + 'px';
      chatWindow.style.top = newTop + 'px';
      chatWindow.style.right = 'auto';
      chatWindow.style.bottom = 'auto';
    }

    function resizeEnd(e) {
      if (isResizing) {
        isResizing = false;
        currentHandle = null;
        chatWindow.classList.remove('resizing');
        document.body.style.userSelect = '';
        document.body.style.cursor = '';
        console.log('è°ƒæ•´å¤§å°ç»“æŸ');
      }
    }

    // ä¸ºæ‰€æœ‰è°ƒæ•´å¤§å°æ‰‹æŸ„æ·»åŠ äº‹ä»¶ç›‘å¬å™¨
    resizeHandles.forEach(handle => {
      handle.addEventListener('mousedown', resizeStart, false);
      handle.addEventListener('touchstart', resizeStart, false);
    });

    // å…¨å±€äº‹ä»¶ç›‘å¬å™¨
    document.addEventListener('mousemove', resize, false);
    document.addEventListener('mouseup', resizeEnd, false);
    document.addEventListener('touchmove', resize, false);
    document.addEventListener('touchend', resizeEnd, false);
  };

  // å‘é€ç—…å²èŠå¤©æ¶ˆæ¯
  function sendHistoryChatMessage() {
    console.log('å‘é€èŠå¤©æ¶ˆæ¯å‡½æ•°è¢«è°ƒç”¨');
    
    const inputElement = document.getElementById('chat-input-history');
    if (!inputElement) {
      console.error('æ‰¾ä¸åˆ°èŠå¤©è¾“å…¥æ¡†');
      return;
    }
    
    const message = inputElement.value.trim();
    console.log('æ¶ˆæ¯å†…å®¹:', message);
    
    if (!message) {
      console.log('æ¶ˆæ¯ä¸ºç©ºï¼Œä¸å‘é€');
      return;
    }
    
    // æ˜¾ç¤ºå­¦ç”Ÿé—®é¢˜
    addHistoryChatMessage('student_question', message, 'student');
    inputElement.value = '';
    
    // æ›´æ–°é—®é¢˜è®¡æ•°
    window.updateQuestionCount();
    
    // å‘é€åˆ°åç«¯è·å–æ‚£è€…å›ç­”
    $.ajax({
      url: '/api/clinical/case/' + clinicalSession.caseId + '/chat/',
      method: 'POST',
      data: JSON.stringify({
        message: message
      }),
      contentType: 'application/json',
      headers: {
        'X-CSRFToken': $('[name=csrfmiddlewaretoken]').val()
      },
      success: function(response) {
        if (response.success) {
          addHistoryChatMessage('patient_response', response.response.content, 'patient');
          // åˆ†æå›ç­”å¹¶æ›´æ–°ä¿¡æ¯æ±‡æ€»
          analyzePatientResponse(message, response.response.content);
        } else {
          addHistoryChatMessage('system_hint', 'æŠ±æ­‰ï¼Œå‡ºç°äº†ä¸€äº›é—®é¢˜ï¼š' + response.error, 'system');
        }
      },
      error: function() {
        addHistoryChatMessage('system_hint', 'ç½‘ç»œè¿æ¥å‡ºç°é—®é¢˜ï¼Œè¯·é‡è¯•ã€‚', 'system');
      }
    });
  }
  
  // æ·»åŠ ç—…å²èŠå¤©æ¶ˆæ¯
  function addHistoryChatMessage(type, content, sender) {
    const container = document.getElementById('chat-messages-history');
    
    // æ¸…é™¤åˆå§‹æç¤º
    if (container.querySelector('.text-center.text-muted')) {
      container.innerHTML = '';
    }
    
    const messageDiv = document.createElement('div');
    messageDiv.className = `chat-message ${sender}-message mb-2`;
    
    let iconClass, bgClass, alignClass;
    switch (sender) {
      case 'patient':
        iconClass = 'fas fa-user';
        bgClass = 'bg-light';
        alignClass = 'justify-content-start';
        break;
      case 'student':
        iconClass = 'fas fa-user-md';
        bgClass = 'bg-primary text-white';
        alignClass = 'justify-content-end';
        break;
      case 'system':
        iconClass = 'fas fa-info-circle';
        bgClass = 'bg-warning';
        alignClass = 'justify-content-center';
        break;
    }
    
    messageDiv.innerHTML = `
      <div class="d-flex ${alignClass}">
        <div class="chat-bubble ${bgClass} rounded p-2 shadow-sm" style="max-width: 85%;">
          <div class="d-flex align-items-start">
            <i class="${iconClass} me-2 mt-1" style="font-size: 0.8rem;"></i>
            <div class="flex-grow-1">
              <div class="message-content">${content}</div>
              <small class="text-muted d-block mt-1" style="font-size: 0.7rem;">
                ${new Date().toLocaleTimeString()}
              </small>
            </div>
          </div>
        </div>
      </div>
    `;
    
    container.appendChild(messageDiv);
    container.scrollTop = container.scrollHeight;
  }
  
  // åˆ†ææ‚£è€…å›ç­”å¹¶æ›´æ–°ä¿¡æ¯æ±‡æ€»
  function analyzePatientResponse(question, response) {
    const questionLower = question.toLowerCase();
    const responseLower = response.toLowerCase();
    
    // åˆ†æä¸åŒç±»å‹çš„ä¿¡æ¯
    if (questionLower.includes('ä¸»è¯‰') || questionLower.includes('å“ªé‡Œä¸èˆ’æœ') || questionLower.includes('ä»€ä¹ˆé—®é¢˜')) {
      updateChiefComplaint(response);
    } else if (questionLower.includes('æ—¶é—´') || questionLower.includes('å¤šä¹…') || questionLower.includes('ä»€ä¹ˆæ—¶å€™')) {
      updateDurationInfo(response);
    } else if (questionLower.includes('æ€§è´¨') || questionLower.includes('æ€ä¹ˆæ ·') || questionLower.includes('æ„Ÿè§‰')) {
      updateSymptomNature(response);
    } else if (questionLower.includes('ä¸¥é‡') || questionLower.includes('ç¨‹åº¦') || questionLower.includes('å‰å®³')) {
      updateSeverityInfo(response);
    } else if (questionLower.includes('åŸå› ') || questionLower.includes('è¯±å‘') || questionLower.includes('å¼•èµ·')) {
      updateTriggerFactors(response);
    } else if (questionLower.includes('ä»¥å‰') || questionLower.includes('æ—¢å¾€') || questionLower.includes('ç—…å²')) {
      updatePastHistory(response);
    } else if (questionLower.includes('å®¶æ—') || questionLower.includes('å®¶äºº') || questionLower.includes('é—ä¼ ')) {
      updateFamilyHistory(response);
    }
  }
  
  // æ›´æ–°ä¸»è¯‰ä¿¡æ¯
  function updateChiefComplaint(content) {
    const summaryElement = $('#chief-complaint-summary');
    summaryElement.html(`
      <div class="d-flex align-items-start">
        <i class="fas fa-quote-left text-primary me-2 mt-1"></i>
        <div>
          <p class="mb-1">${content}</p>
          <small class="text-muted">é€šè¿‡é—®è¯Šè·å¾—</small>
        </div>
      </div>
    `).addClass('info-summary-card has-info');
    
    // ä¿å­˜åˆ°åç«¯
    saveHistorySummary({ chief_complaint: content });
  }
  
  // æ›´æ–°æŒç»­æ—¶é—´ä¿¡æ¯
  function updateDurationInfo(content) {
    $('#duration-info').text(content).removeClass('text-muted').addClass('text-dark fw-bold text-success');
    $('#present-illness-summary').addClass('info-summary-card has-info');
    
    // ä¿å­˜åˆ°åç«¯
    saveHistorySummary({ duration: content });
  }
  
  // æ›´æ–°ç—‡çŠ¶æ€§è´¨
  function updateSymptomNature(content) {
    $('#symptom-nature').text(content).removeClass('text-muted').addClass('text-dark fw-bold text-success');
    $('#present-illness-summary').addClass('info-summary-card has-info');
    
    // ä¿å­˜åˆ°åç«¯
    saveHistorySummary({ symptom_nature: content });
  }
  
  // æ›´æ–°ä¸¥é‡ç¨‹åº¦
  function updateSeverityInfo(content) {
    $('#severity-info').text(content).removeClass('text-muted').addClass('text-dark fw-bold text-success');
    $('#present-illness-summary').addClass('info-summary-card has-info');
    
    // ä¿å­˜åˆ°åç«¯
    saveHistorySummary({ severity: content });
  }
  
  // æ›´æ–°è¯±å‘å› ç´ 
  function updateTriggerFactors(content) {
    $('#trigger-factors').text(content).removeClass('text-muted').addClass('text-dark fw-bold text-success');
    $('#present-illness-summary').addClass('info-summary-card has-info');
    
    // ä¿å­˜åˆ°åç«¯
    saveHistorySummary({ trigger_factors: content });
  }
  
  // æ›´æ–°æ—¢å¾€å²
  function updatePastHistory(content) {
    const summaryElement = $('#past-history-summary');
    summaryElement.html(`
      <div class="d-flex align-items-start">
        <i class="fas fa-history text-info me-2 mt-1"></i>
        <div>
          <p class="mb-1">${content}</p>
          <small class="text-muted">æ—¢å¾€ç—…å²</small>
        </div>
      </div>
    `).addClass('info-summary-card has-info');
    
    // ä¿å­˜åˆ°åç«¯
    saveHistorySummary({ past_history: content });
  }
  
  // æ›´æ–°å®¶æ—å²
  function updateFamilyHistory(content) {
    const summaryElement = $('#family-history-summary');
    summaryElement.html(`
      <div class="d-flex align-items-start">
        <i class="fas fa-users text-success me-2 mt-1"></i>
        <div>
          <p class="mb-1">${content}</p>
          <small class="text-muted">å®¶æ—ç—…å²</small>
        </div>
      </div>
    `).addClass('info-summary-card has-info');
    
    // ä¿å­˜åˆ°åç«¯
    saveHistorySummary({ family_history: content });
  }
  
  // ï¼ˆå·²ç»Ÿä¸€ä½¿ç”¨ window.updateQuestionCount / window.getAskedQuestionCountï¼Œé¿å…é‡å¤å®šä¹‰å¯¼è‡´ç»Ÿè®¡ä¸ä¸€è‡´ï¼‰
  
  // è¯·æ±‚ä½“æ ¼æ£€æŸ¥
  function requestPhysicalExam() {
    addHistoryChatMessage('system_hint', 'æ‚¨å¯ä»¥ç»§ç»­è¯¢é—®æ‚£è€…å…³äºä½“æ ¼æ£€æŸ¥çš„ä¿¡æ¯ï¼Œæˆ–è€…è¯¢é—®æ›´è¯¦ç»†çš„ç—‡çŠ¶ã€‚', 'system');
    // è¿™é‡Œå¯ä»¥æ·»åŠ æ›´å¤šä½“æ ¼æ£€æŸ¥ç›¸å…³çš„å¿«é€Ÿé—®é¢˜æŒ‰é’®
    addQuickQuestionButtons([
      'æœ‰æ²¡æœ‰çœ¼éƒ¨ç–¼ç—›ï¼Ÿ',
      'è§†åŠ›ä¸‹é™æ˜æ˜¾å—ï¼Ÿ',
      'æœ‰æ²¡æœ‰çœ¼çº¢å……è¡€ï¼Ÿ',
      'åˆ†æ³Œç‰©å¤šå—ï¼Ÿ'
    ]);
  }
  
  // è¿›å…¥æ£€æŸ¥é˜¶æ®µ
  // proceedToExaminationå‡½æ•°å·²åœ¨å‰é¢å®šä¹‰ä¸ºwindow.proceedToExaminationï¼Œæ­¤å¤„åˆ é™¤é‡å¤å®šä¹‰
  
  // æ·»åŠ å¿«é€Ÿé—®é¢˜æŒ‰é’®
  function addQuickQuestionButtons(questions) {
    const container = $('#quick-question-buttons');
    questions.forEach(question => {
      const btn = $(`<button class="btn btn-sm btn-outline-secondary me-1 mb-1" onclick="quickQuestion('${question}')">${question}</button>`);
      container.append(btn);
    });
  }
  
  // ä¿®æ”¹åŸæœ‰çš„loadClinicalCaseDataå‡½æ•°ï¼Œæ·»åŠ ç—…å²é‡‡é›†å¸ƒå±€æ§åˆ¶
  const originalLoadClinicalCaseData = window.loadClinicalCaseData;
  window.loadClinicalCaseData = function() {
    if (clinicalSession.currentStage === 'case_presentation') {
      showHistoryCollectionLayout();
    } else {
      hideHistoryCollectionLayout();
      if (originalLoadClinicalCaseData) {
        originalLoadClinicalCaseData();
      }
    }
  };
  
  // è¿™é‡Œçœç•¥äº†submitExaminationChoices, submitDiagnosisChoice, submitTreatmentChoicesç­‰å‡½æ•°
  // è¿™äº›å‡½æ•°ä¼šè°ƒç”¨å®é™…çš„APIï¼Œå¹¶å¤„ç†æœåŠ¡å™¨å“åº”
  // ç”±äºç¯‡å¹…é™åˆ¶ï¼Œä¿æŒåŸæœ‰çš„ç®€åŒ–APIè°ƒç”¨é€»è¾‘
  
})();
</script>

<!-- æµ®åŠ¨èŠå¤©çª—å£ - ç§»åˆ°é¡µé¢æœ€åç¡®ä¿æ­£ç¡®æ˜¾ç¤º -->
<div class="floating-chat-window" id="floating-chat-window-global">
  <!-- è°ƒæ•´å¤§å°æ‰‹æŸ„ -->
  <div class="resize-handle resize-handle-nw" data-direction="nw"></div>
  <div class="resize-handle resize-handle-ne" data-direction="ne"></div>
  <div class="resize-handle resize-handle-sw" data-direction="sw"></div>
  <div class="resize-handle resize-handle-se" data-direction="se"></div>
  <div class="resize-handle resize-handle-n" data-direction="n"></div>
  <div class="resize-handle resize-handle-s" data-direction="s"></div>
  <div class="resize-handle resize-handle-w" data-direction="w"></div>
  <div class="resize-handle resize-handle-e" data-direction="e"></div>

  <div class="chat-header bg-info text-white d-flex justify-content-between align-items-center">
    <div class="d-flex align-items-center">
      <i class="fas fa-user-injured me-2"></i>
      <span class="fw-bold">æ‚£è€…å¯¹è¯</span>
    </div>
    <div class="chat-controls">
      <button class="btn btn-sm btn-outline-light" onclick="toggleChatWindow()" title="æ”¶èµ·/å±•å¼€">
        <i class="fas fa-minus" id="chat-toggle-icon-global"></i>
      </button>
    </div>
  </div>
  
  <div class="chat-body" id="chat-body-container-global">
    <div class="chat-messages" id="chat-messages-history">
      <div class="text-center text-muted py-4">
        <i class="fas fa-comments fa-2x mb-2 text-info"></i>
        <p class="mb-1">å¼€å§‹ä¸æ‚£è€…å¯¹è¯</p>
        <small class="text-muted">è¯¢é—®ç—…å²ä¿¡æ¯ï¼Œäº†è§£æ‚£è€…ç—‡çŠ¶</small>
      </div>
    </div>
    
    <!-- å¿«é€Ÿé—®é¢˜æŒ‰é’® -->
    <div class="quick-questions bg-light border-top p-2 flex-shrink-0" style="max-height: 60px; overflow-y: auto;">
      <div class="d-flex flex-wrap gap-1" id="quick-question-buttons">
        <button class="btn btn-sm btn-outline-primary" onclick="quickQuestion('æ‚¨å“ªé‡Œä¸èˆ’æœï¼Ÿ')">æ‚¨å“ªé‡Œä¸èˆ’æœï¼Ÿ</button>
        <button class="btn btn-sm btn-outline-primary" onclick="quickQuestion('ä»€ä¹ˆæ—¶å€™å¼€å§‹çš„ï¼Ÿ')">ä»€ä¹ˆæ—¶å€™å¼€å§‹çš„ï¼Ÿ</button>
        <button class="btn btn-sm btn-outline-primary" onclick="quickQuestion('ç—‡çŠ¶ä¸¥é‡å—ï¼Ÿ')">ç—‡çŠ¶ä¸¥é‡å—ï¼Ÿ</button>
        <button class="btn btn-sm btn-outline-primary" onclick="quickQuestion('ä»¥å‰æœ‰ç±»ä¼¼ç—…å²å—ï¼Ÿ')">ä»¥å‰æœ‰ç±»ä¼¼ç—…å²å—ï¼Ÿ</button>
      </div>
    </div>
    
    <!-- è¾“å…¥åŒºåŸŸ -->
    <div class="chat-input mt-3">
      <div class="input-group">
        <input type="text" class="form-control" id="patient-question-global" placeholder="è¾“å…¥æ‚¨æƒ³è¯¢é—®æ‚£è€…çš„é—®é¢˜..." onkeypress="handleChatKeyPress(event)">
        <button class="btn btn-info" type="button" onclick="askPatient()">
          <i class="fas fa-paper-plane"></i> å‘é€
        </button>
      </div>
    </div>
  </div>
</div>

{% endblock %}