{% extends 'base.html' %}

{% block title %}{{ title }} - 眼科教学系统{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h2>{{ title }}</h2>
                <a href="{% url 'teacher_case_list' %}" class="btn btn-secondary">
                    <i class="fas fa-arrow-left"></i> 返回病例列表
                </a>
            </div>
            
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">病例信息</h5>
                </div>
                <div class="card-body">
                    <form method="post" enctype="multipart/form-data">
                        {% csrf_token %}
                        
                        <div class="row">
                            <div class="col-md-8">
                                <!-- 基本信息 (用于 ClinicalCase) -->
                                <div class="form-group">
                                    <label for="title" class="required">病例名称 *</label>
                                    <input type="text" class="form-control" id="title" name="title" 
                                           value="{% if case %}{{ case.title }}{% elif form_data %}{{ form_data.title }}{% endif %}" 
                                           required maxlength="200"
                                           placeholder="请输入病例名称">
                                    <small class="form-text text-muted">请输入简洁明确的病例标题</small>
                                </div>
                                <div class="form-group">
                                    <label for="case_id">案例编号</label>
                                    <input type="text" class="form-control" id="case_id" name="case_id"
                                           value="{% if case %}{{ case.case_id }}{% elif form_data %}{{ form_data.case_id }}{% endif %}"
                                           placeholder="留空则系统自动生成">
                                    <small class="form-text text-muted">用于临床推理系统的唯一编号（可选）</small>
                                </div>

                                <div class="form-group">
                                    <label for="patient_age">患者年龄</label>
                                    <input type="number" class="form-control" id="patient_age" name="patient_age"
                                           value="{% if case %}{{ case.patient_age }}{% elif form_data %}{{ form_data.patient_age }}{% endif %}"
                                           placeholder="例如：45">
                                </div>

                                <div class="form-group">
                                    <label for="patient_gender">患者性别</label>
                                    <select class="form-control" id="patient_gender" name="patient_gender">
                                        <option value="M" {% if case.patient_gender == 'M' or form_data.patient_gender == 'M' %}selected{% endif %}>男</option>
                                        <option value="F" {% if case.patient_gender == 'F' or form_data.patient_gender == 'F' %}selected{% endif %}>女</option>
                                    </select>
                                </div>

                                <div class="form-group">
                                    <label for="chief_complaint" class="required">主诉 *</label>
                                    <textarea class="form-control" id="chief_complaint" name="chief_complaint" rows="2" required
                                              placeholder="请输入主诉">{% if case %}{{ case.chief_complaint }}{% elif form_data %}{{ form_data.chief_complaint }}{% endif %}</textarea>
                                </div>

                                <div class="form-group">
                                    <label for="present_illness" class="required">现病史 *</label>
                                    <textarea class="form-control" id="present_illness" name="present_illness" rows="4" required
                                              placeholder="请输入现病史">{% if case %}{{ case.present_illness }}{% elif form_data %}{{ form_data.present_illness }}{% endif %}</textarea>
                                </div>

                                <div class="form-group">
                                    <label for="past_history">既往史</label>
                                    <textarea class="form-control" id="past_history" name="past_history" rows="2"
                                              placeholder="既往史（可选）">{% if case %}{{ case.past_history }}{% elif form_data %}{{ form_data.past_history }}{% endif %}</textarea>
                                </div>

                                <div class="form-group">
                                    <label for="family_history">家族史</label>
                                    <textarea class="form-control" id="family_history" name="family_history" rows="2"
                                              placeholder="家族史（可选）">{% if case %}{{ case.family_history }}{% elif form_data %}{{ form_data.family_history }}{% endif %}</textarea>
                                </div>

                                <div class="form-group">
                                    <label for="learning_objectives">学习目标（每行一个）</label>
                                    <textarea class="form-control" id="learning_objectives" name="learning_objectives" rows="3" placeholder="例如：\n识别白内障的主要临床特征\n理解常见并发症的处理方法">{% if case %}{{ case.learning_objectives|join:"\n" }}{% elif form_data %}{{ form_data.learning_objectives }}{% endif %}</textarea>
                                    <small class="form-text text-muted">每行一个学习目标，系统会保存为 JSON 列表</small>
                                </div>
                            </div>
                            
                            <div class="col-md-4">
                                <!-- 病例配置 -->
                                <div class="form-group">
                                    <label for="difficulty_level">难度等级</label>
                                    <select class="form-control" id="difficulty_level" name="difficulty_level">
                                        <option value="beginner" {% if case.difficulty_level == 'beginner' or form_data.difficulty_level == 'beginner' %}selected{% endif %}>初级</option>
                                        <option value="intermediate" {% if not case and not form_data or case.difficulty_level == 'intermediate' or form_data.difficulty_level == 'intermediate' %}selected{% endif %}>中级</option>
                                        <option value="advanced" {% if case.difficulty_level == 'advanced' or form_data.difficulty_level == 'advanced' %}selected{% endif %}>高级</option>
                                    </select>
                                </div>

                                <div class="form-group">
                                    <label for="case_images">案例图片（可多选）</label>
                                    <input type="file" class="form-control-file" id="case_images" name="case_images" 
                                           accept="image/*" multiple>
                                    <small class="form-text text-muted">可上传多张图片，系统会将路径保存为 JSON 列表</small>

                                    {% if case.case_images %}
                                    <div class="mt-2">
                                        <p class="text-muted small">当前图片：</p>
                                        <div class="d-flex flex-wrap" style="gap:8px;">
                                            {% for img in case.case_images %}
                                            <img src="/{{ img }}" class="img-thumbnail" style="max-width:120px; max-height:90px;" alt="{{ case.title }}">
                                            {% endfor %}
                                        </div>
                                    </div>
                                    {% endif %}
                                </div>
                                
                                <div class="form-group">
                                    <div class="form-check">
                                        <input type="checkbox" class="form-check-input" id="is_active" name="is_active" 
                                               {% if not case or case.is_active %}checked{% endif %}>
                                        <label class="form-check-label" for="is_active">
                                            启用病例
                                        </label>
                                    </div>
                                    <small class="form-text text-muted">是否在教学中使用此病例</small>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 提交按钮 -->
                        <div class="form-group mt-4">
                            <div class="d-flex justify-content-between">
                                <div>
                                    <button type="submit" class="btn btn-primary btn-lg">
                                        <i class="fas fa-save"></i> {{ action }}病例
                                    </button>
                                    <a href="{% url 'teacher_case_list' %}" class="btn btn-outline-secondary btn-lg ml-3">
                                        <i class="fas fa-times"></i> 取消
                                    </a>
                                </div>
                                
                                {% if case %}
                                <div>
                                    <button type="button" class="btn btn-outline-danger" onclick="showDeleteModal()">
                                        <i class="fas fa-trash"></i> 删除病例
                                    </button>
                                </div>
                                {% endif %}
                            </div>
                        </div>
                    </form>

                    <!-- 临床推理相关选项：检查/诊断/治疗 -->
                    <hr />
                    <h5>临床推理配置</h5>

                    <!-- 检查选项 -->
                    <div class="card mb-3">
                        <div class="card-header">检查选项
                            <button class="btn btn-sm btn-primary" id="addExamBtn" style="float:right;">添加检查</button>
                        </div>
                        <div class="card-body" id="examinationsContainer">
                            <!-- 模板项 -->
                        </div>
                    </div>

                    <!-- 诊断选项 -->
                    <div class="card mb-3">
                        <div class="card-header">诊断选项
                            <button class="btn btn-sm btn-primary" id="addDiagBtn" style="float:right;">添加诊断</button>
                        </div>
                        <div class="card-body" id="diagnosisContainer"></div>
                    </div>

                    <!-- 治疗选项 -->
                    <div class="card mb-3">
                        <div class="card-header">治疗选项
                            <button class="btn btn-sm btn-primary" id="addTreatBtn" style="float:right;">添加治疗</button>
                        </div>
                        <div class="card-body" id="treatmentContainer"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

{% if case %}
<!-- 删除确认模态框 -->
<div class="modal fade" id="deleteModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">确认删除</h5>
                <button type="button" class="close" data-dismiss="modal">
                    <span>&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <p>您确定要删除病例 <strong>"{{ case.title }}"</strong> 吗？</p>
                <p class="text-danger">
                    <i class="fas fa-exclamation-triangle"></i> 
                    删除后无法恢复，相关的练习题目也将被删除！
                </p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">取消</button>
                <button type="button" class="btn btn-danger" onclick="deleteCase()">确认删除</button>
            </div>
        </div>
    </div>
</div>
{% endif %}

<style>
.card-header {
    background-color: #007bff;
    color: white;
}
.card-header h5 {
    color: white;
}
.required::after {
    content: " *";
    color: red;
}
.form-group label {
    font-weight: 600;
    margin-bottom: 5px;
}
.img-thumbnail {
    border: 2px solid #dee2e6;
}
</style>

<script>
// 表单验证
document.addEventListener('DOMContentLoaded', function() {
    const form = document.querySelector('form');
    const requiredFields = form.querySelectorAll('[required]');
    
    form.addEventListener('submit', function(e) {
        let isValid = true;
        
        requiredFields.forEach(field => {
            if (!field.value.trim()) {
                field.classList.add('is-invalid');
                isValid = false;
            } else {
                field.classList.remove('is-invalid');
            }
        });
        
        if (!isValid) {
            e.preventDefault();
            alert('请填写所有必填字段！');
        }
    });
    
    // 实时验证
    requiredFields.forEach(field => {
        field.addEventListener('blur', function() {
            if (this.value.trim()) {
                this.classList.remove('is-invalid');
                this.classList.add('is-valid');
            } else {
                this.classList.remove('is-valid');
                this.classList.add('is-invalid');
            }
        });
    });
});

{% if case %}
// 删除功能
function showDeleteModal() {
    $('#deleteModal').modal('show');
}

function deleteCase() {
    fetch('{% url "teacher_case_delete" case.id %}', {
        method: 'POST',
        headers: {
            'X-CSRFToken': '{{ csrf_token }}',
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            window.location.href = '{% url "teacher_case_list" %}';
        } else {
            alert('删除失败：' + (data.error || '未知错误'));
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('删除失败，请稍后重试');
    });
}
{% endif %}

// 图片预览
document.getElementById('image').addEventListener('change', function(e) {
    const file = e.target.files[0];
    if (file) {
        const reader = new FileReader();
        reader.onload = function(e) {
            // 如果已有预览图片，更新它；否则创建新的
            let preview = document.getElementById('imagePreview');
            if (!preview) {
                preview = document.createElement('div');
                preview.id = 'imagePreview';
                preview.className = 'mt-2';
                preview.innerHTML = '<p class="text-muted small">图片预览：</p>';
                e.target.parentElement.appendChild(preview);
            }
            
            preview.innerHTML = `
                <p class="text-muted small">图片预览：</p>
                <img src="${e.target.result}" class="img-thumbnail" 
                     style="max-width: 200px; max-height: 150px;" alt="预览图片">
            `;
        };
        reader.readAsDataURL(file);
    }
});
</script>
<script>
// 临床推理表单动态添加项脚本
document.addEventListener('DOMContentLoaded', function() {
    // Examination template
    const examTpl = function(index) {
        return `
        <div class="exam-item mb-2" data-index="${index}">
            <div class="form-row">
                <div class="col-md-4"><input name="examination_name[]" class="form-control" placeholder="检查名称" required></div>
                <div class="col-md-3"><select name="examination_type[]" class="form-control"><option value="basic">基础</option><option value="imaging">影像</option><option value="laboratory">实验室</option><option value="special">特殊</option><option value="fundus">眼底</option></select></div>
                <div class="col-md-2"><input type="hidden" name="examination_is_required_${index}" value="0"><input type="checkbox" name="examination_is_required_${index}" value="1"> 必选</div>
                <div class="col-md-2"><input type="hidden" name="examination_is_multiple_${index}" value="0"><input type="checkbox" name="examination_is_multiple_${index}" value="1"> 多选</div>
                <div class="col-md-1 text-right"><button class="btn btn-sm btn-danger remove-exam">删除</button></div>
            </div>
        </div>`;
    };

    const diagTpl = function(index) {
        return `
        <div class="diag-item mb-2" data-index="${index}">
            <div class="form-row">
                <div class="col-md-4"><input name="diagnosis_name[]" class="form-control" placeholder="诊断名称" required></div>
                <div class="col-md-3"><input name="diagnosis_code[]" class="form-control" placeholder="编码（可选）"></div>
                <div class="col-md-3"><input name="diagnosis_probability_${index}" class="form-control" placeholder="概率（0-1）" type="number" step="0.01" min="0" max="1"></div>
                <div class="col-md-2 text-right"><button class="btn btn-sm btn-danger remove-diag">删除</button></div>
            </div>
            <div class="form-group mt-2">
                <textarea name="diagnosis_supporting_${index}" class="form-control" placeholder="支持依据（必填）"></textarea>
            </div>
        </div>`;
    };

    const treatTpl = function(index) {
        return `
        <div class="treat-item mb-2" data-index="${index}">
            <div class="form-row">
                <div class="col-md-4"><select name="treatment_type[]" class="form-control"><option value="medication">药物</option><option value="surgery">手术</option><option value="observation">观察</option><option value="referral">转诊</option><option value="lifestyle">生活方式</option><option value="combination">综合</option></select></div>
                <div class="col-md-4"><input name="treatment_name[]" class="form-control" placeholder="治疗名称" required></div>
                <div class="col-md-3"><input name="treatment_efficacy_${index}" type="number" class="form-control" min="1" max="3" value="2"></div>
                <div class="col-md-1 text-right"><button class="btn btn-sm btn-danger remove-treat">删除</button></div>
            </div>
            <div class="form-group mt-2">
                <textarea name="treatment_description_${index}" class="form-control" placeholder="治疗描述"></textarea>
            </div>
        </div>`;
    };

    let examIndex = 0;
    document.getElementById('addExamBtn').addEventListener('click', function(e){
        e.preventDefault();
        document.getElementById('examinationsContainer').insertAdjacentHTML('beforeend', examTpl(examIndex++));
    });

    document.getElementById('addDiagBtn').addEventListener('click', function(e){
        e.preventDefault();
        document.getElementById('diagnosisContainer').insertAdjacentHTML('beforeend', diagTpl(examIndex));
        examIndex++;
    });

    document.getElementById('addTreatBtn').addEventListener('click', function(e){
        e.preventDefault();
        document.getElementById('treatmentContainer').insertAdjacentHTML('beforeend', treatTpl(examIndex));
        examIndex++;
    });

    // 事件委托删除
    document.addEventListener('click', function(e){
        if (e.target && e.target.classList.contains('remove-exam')) {
            e.target.closest('.exam-item').remove();
        }
        if (e.target && e.target.classList.contains('remove-diag')) {
            e.target.closest('.diag-item').remove();
        }
        if (e.target && e.target.classList.contains('remove-treat')) {
            e.target.closest('.treat-item').remove();
        }
    });
});
</script>
{% endblock %}