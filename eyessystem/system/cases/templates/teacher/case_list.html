{% extends 'base.html' %}
{% load static %}

{% block title %}病例管理 - 眼科临床训练系统{% endblock %}

{% block content %}
<div class="card">
    <div class="card-header" style="display: flex; justify-content: space-between; align-items: center;">
        <h2>病例管理</h2>
        <div style="display:flex; gap:8px; align-items: center;">
            <!-- 切换管理类型 -->
            <div>
                <a href="?type=traditional" class="btn {% if list_type != 'clinical' %}active{% endif %}">管理传统病例</a>
                <a href="?type=clinical" class="btn {% if list_type == 'clinical' %}active{% endif %}">管理临床推理案例</a>
            </div>

            <!-- 创建按钮根据类型变更目标 -->
            {% if list_type == 'clinical' %}
                <a href="{% url 'teacher_case_create' %}?type=clinical" class="btn">创建新临床案例</a>
            {% else %}
                <a href="{% url 'teacher_create_traditional_case' %}" class="btn">创建新病例</a>
            {% endif %}

            <button class="btn secondary" onclick="document.getElementById('importModal').style.display='block'">批量导入</button>
        </div>
    </div>
    <div class="card-body">
        <!-- 搜索和筛选 -->
        <form method="get" style="display: flex; gap: 15px; margin-bottom: 20px; align-items: end;">
            <div class="form-group" style="margin-bottom: 0;">
                <label>搜索病例</label>
                <input type="text" name="search" class="form-control" placeholder="输入病例名称或描述" value="{{ search }}" style="width: 300px;">
            </div>
            <div class="form-group" style="margin-bottom: 0;">
                <label>状态筛选</label>
                <select name="status" class="form-control" style="width: 150px;">
                    <option value="">全部</option>
                    <option value="active" {% if status == 'active' %}selected{% endif %}>启用</option>
                    <option value="inactive" {% if status == 'inactive' %}selected{% endif %}>禁用</option>
                </select>
            </div>
            <button type="submit" class="btn secondary">筛选</button>
            {% if search or status %}
                <a href="{% url 'teacher_case_list' %}" class="btn secondary">清除筛选</a>
            {% endif %}
        </form>

        <!-- 病例列表 -->
        <table class="table">
            <thead>
                <tr>
                    <th>病例名称</th>
                    <th>状态</th>
                    <th>练习题数</th>
                    <th>创建时间</th>
                    <th>操作</th>
                </tr>
            </thead>
            <tbody>
                {% for case in page_obj %}
                <tr>
                    <td>
                        <div style="display: flex; align-items: center;">
                            {% if list_type == 'clinical' %}
                                {% if case.case_images and case.case_images.0 %}
                                    <img src="/{{ case.case_images.0 }}" alt="{{ case.title }}" style="width: 50px; height: 50px; object-fit: cover; border-radius: 4px; margin-right: 10px;">
                                {% endif %}
                            {% else %}
                                {% if case.image %}
                                    <img src="{{ case.image.url }}" alt="{{ case.title }}" style="width: 50px; height: 50px; object-fit: cover; border-radius: 4px; margin-right: 10px;">
                                {% endif %}
                            {% endif %}
                            <div>
                                <strong>{{ case.title }}</strong><br>
                                <small style="color: #666;">{% if list_type == 'clinical' %}{{ case.chief_complaint|truncatewords:10 }}{% else %}{{ case.description|truncatewords:10 }}{% endif %}</small>
                            </div>
                        </div>
                    </td>
                    <td>
                        {% if case.is_active %}
                            <span style="color: #28a745; background: #d4edda; padding: 4px 8px; border-radius: 12px; font-size: 0.8rem;">启用</span>
                        {% else %}
                            <span style="color: #dc3545; background: #f8d7da; padding: 4px 8px; border-radius: 12px; font-size: 0.8rem;">禁用</span>
                        {% endif %}
                    </td>
                    <td>
                        {% if list_type == 'clinical' %}
                            <!-- 临床案例暂时无 exercises 计数，显示短横线或 0 -->
                            {{ case.studentclinicalsession_set.count }}
                        {% else %}
                            {{ case.exercises.count }}
                        {% endif %}
                    </td>
                    <td>{{ case.created_at|date:"Y-m-d H:i" }}</td>
                    <td>
                        {% if list_type == 'clinical' %}
                            <a href="{% url 'teacher_clinical_edit' case.case_id %}" class="btn secondary" style="padding: 6px 12px; font-size: 0.8rem; margin-right: 5px;">编辑</a>
                            <a href="{% url 'teacher_clinical_exercise_list' case.case_id %}" class="btn secondary" style="padding: 6px 12px; font-size: 0.8rem; margin-right: 5px;">题目</a>
                            <button class="btn danger" style="padding: 6px 12px; font-size: 0.8rem;" data-case-id="{{ case.case_id }}" data-case-title="{{ case.title|escapejs }}" onclick="deleteClinicalCase(this)">删除</button>
                        {% else %}
                            <a href="{% url 'teacher_case_edit' case.id %}" class="btn secondary" style="padding: 6px 12px; font-size: 0.8rem; margin-right: 5px;">编辑</a>
                            <a href="{% url 'teacher_exercise_list' case.id %}" class="btn secondary" style="padding: 6px 12px; font-size: 0.8rem; margin-right: 5px;">题目</a>
                            <button class="btn danger" style="padding: 6px 12px; font-size: 0.8rem;" data-case-id="{{ case.id }}" data-case-title="{{ case.title|escapejs }}" onclick="deleteCase(this)">删除</button>
                        {% endif %}
                    </td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="5" style="text-align: center; padding: 40px; color: #666;">
                        {% if search or status %}
                            没有找到匹配的病例
                        {% else %}
                            暂无病例数据，<a href="{% url 'teacher_case_create' %}">创建第一个病例</a>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>

        <!-- 分页 -->
        {% if page_obj.has_other_pages %}
        <div class="pagination">
            {% if page_obj.has_previous %}
                <a href="?page=1&search={{ search }}&status={{ status }}">&laquo; 首页</a>
                <a href="?page={{ page_obj.previous_page_number }}&search={{ search }}&status={{ status }}">上一页</a>
            {% endif %}

            {% for num in page_obj.paginator.page_range %}
                {% if page_obj.number == num %}
                    <span class="current">{{ num }}</span>
                {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}
                    <a href="?page={{ num }}&search={{ search }}&status={{ status }}">{{ num }}</a>
                {% endif %}
            {% endfor %}

            {% if page_obj.has_next %}
                <a href="?page={{ page_obj.next_page_number }}&search={{ search }}&status={{ status }}">下一页</a>
                <a href="?page={{ page_obj.paginator.num_pages }}&search={{ search }}&status={{ status }}">末页 &raquo;</a>
            {% endif %}
        </div>
        {% endif %}
    </div>
</div>

<!-- 导入模态框 -->
<div id="importModal" style="display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5);" onclick="closeModalOnBackdrop(event)">
    <div style="background: white; margin: 10% auto; padding: 20px; width: 500px; max-width: 90%; border-radius: 8px; box-shadow: 0 4px 20px rgba(0,0,0,0.3);">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <h3 style="margin: 0;">批量导入病例</h3>
            <button type="button" style="background: none; border: none; font-size: 1.5rem; cursor: pointer; color: #999;" onclick="closeImportModal()">&times;</button>
        </div>
        <form method="post" action="{% url 'import_cases' %}" enctype="multipart/form-data">
            {% csrf_token %}
            <div class="form-group">
                <label>选择CSV文件</label>
                <input type="file" name="csv_file" accept=".csv" class="form-control" required>
                <small style="color: #666; display: block; margin-top: 8px;">
                    <strong>CSV格式：</strong>病例名称,病例描述,症状表现,检查结果,是否启用<br>
                    <strong>示例：</strong>"白内障案例","患者双眼视物模糊","视力下降、畏光","晶状体混浊","true"
                </small>
            </div>
            <div style="text-align: right; margin-top: 20px;">
                <button type="button" class="btn secondary" onclick="closeImportModal()">取消</button>
                <button type="submit" class="btn" style="margin-left: 10px;">导入</button>
            </div>
        </form>
    </div>
</div>

<script>
function deleteCase(button) {
    const caseId = button.dataset.caseId;
    const caseName = button.dataset.caseTitle;
    
    if (confirmDelete('确定要删除病例 "' + caseName + '" 吗？\n删除后相关的练习题目也会被删除。')) {
        fetch('/teacher/cases/' + caseId + '/delete/', {
            method: 'POST',
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                'Content-Type': 'application/json',
            }
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('网络请求失败');
            }
            return response.json();
        })
        .then(data => {
            if (data.success) {
                // 添加成功提示
                const successMsg = document.createElement('div');
                successMsg.className = 'message success';
                successMsg.textContent = '病例删除成功！';
                document.querySelector('.container').insertBefore(successMsg, document.querySelector('.card'));
                
                // 延迟刷新页面
                setTimeout(() => {
                    location.reload();
                }, 1000);
            } else {
                alert('删除失败：' + (data.message || '请重试'));
            }
        })
        .catch(error => {
            console.error('删除操作失败:', error);
            alert('删除操作失败，请检查网络连接后重试');
        });
    }
}

function deleteClinicalCase(button) {
    const caseId = button.dataset.caseId;
    const caseName = button.dataset.caseTitle;
    if (confirmDelete('确定要删除临床案例 "' + caseName + '" 吗？')) {
        fetch('/teacher/clinical/' + caseId + '/delete/', {
            method: 'POST',
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                'Content-Type': 'application/json',
            }
        })
        .then(resp => resp.json())
        .then(data => {
            if (data.success) {
                const successMsg = document.createElement('div');
                successMsg.className = 'message success';
                successMsg.textContent = '临床案例删除成功！';
                document.querySelector('.container').insertBefore(successMsg, document.querySelector('.card'));
                setTimeout(() => { location.reload(); }, 800);
            } else {
                alert('删除失败：' + (data.message || '请重试'));
            }
        })
        .catch(err => { console.error(err); alert('删除失败，请稍后重试'); });
    }
}

function closeImportModal() {
    document.getElementById('importModal').style.display = 'none';
}

function closeModalOnBackdrop(event) {
    // 点击背景关闭模态框
    if (event.target === event.currentTarget) {
        closeImportModal();
    }
}

// 添加键盘支持
document.addEventListener('keydown', function(event) {
    if (event.key === 'Escape') {
        const modal = document.getElementById('importModal');
        if (modal.style.display !== 'none') {
            closeImportModal();
        }
    }
});
</script>
{% endblock %}