{% extends 'base.html' %}

{% block title %}成绩情况 - {{ clinical_case.title }}{% endblock %}

{% block content %}
<div class="card">
    <div class="card-header">
        <h2>成绩情况</h2>
        <p style="margin: 0;">病例：{{ clinical_case.title }}（{{ clinical_case.case_id }}）</p>
    </div>
    <div class="card-body">
        <div class="stats-grid" style="grid-template-columns: repeat(3, 1fr);">
            <div class="stat-card">
                <div class="stat-number">{{ total_sessions }}</div>
                <div class="stat-label">学习会话数</div>
            </div>
            <div class="stat-card">
                <div class="stat-number">{{ completed_sessions }}</div>
                <div class="stat-label">已完成会话</div>
            </div>
            <div class="stat-card">
                <div class="stat-number">{% if avg_score > 0 %}{{ avg_score|floatformat:1 }}{% else %}0{% endif %}</div>
                <div class="stat-label">平均分</div>
            </div>
        </div>

        <div class="card" style="margin-top: 20px;">
            <div class="card-header">
                <h3>学生成绩列表</h3>
            </div>
            <div class="card-body">
                {% if items %}
                <table class="table">
                    <thead>
                        <tr>
                            <th>学生</th>
                            <th>学习状态</th>
                            <th>总分</th>
                            <th>检查分</th>
                            <th>诊断分</th>
                            <th>治疗分</th>
                            <th>单案例学习时长</th>
                            <th>开始时间</th>
                            <th>最后活动</th>
                            <th>复盘</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for item in items %}
                        <tr>
                            <td>{{ item.session.student.get_full_name|default:item.session.student.username }}</td>
                            <td>{{ item.session.get_session_status_display|default:item.session.session_status }}</td>
                            <td>{% if item.session.overall_score %}{{ item.session.overall_score|floatformat:1 }}{% else %}-{% endif %}</td>
                            <td>{% if item.session.examination_score %}{{ item.session.examination_score|floatformat:1 }}{% else %}-{% endif %}</td>
                            <td>{% if item.session.diagnosis_score %}{{ item.session.diagnosis_score|floatformat:1 }}{% else %}-{% endif %}</td>
                            <td>{% if item.session.treatment_score %}{{ item.session.treatment_score|floatformat:1 }}{% else %}-{% endif %}</td>
                            <td>{{ item.study_time }}</td>
                            <td>{{ item.session.started_at|date:"m-d H:i" }}</td>
                            <td>{{ item.session.last_activity|date:"m-d H:i"|default:"-" }}</td>
                            <td>
                                <a href="{% url 'teacher_session_review' item.session.id %}">查看</a>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
                {% else %}
                    <p style="color: #666;">暂无学习记录</p>
                {% endif %}

                {% if page_obj.has_other_pages %}
                    <nav aria-label="分页" style="margin-top: 16px;">
                        <ul class="pagination" style="justify-content: center;">
                            {% if page_obj.has_previous %}
                                <li class="page-item"><a class="page-link" href="?page={{ page_obj.previous_page_number }}">上一页</a></li>
                            {% endif %}
                            <li class="page-item active"><span class="page-link">{{ page_obj.number }}/{{ page_obj.paginator.num_pages }}</span></li>
                            {% if page_obj.has_next %}
                                <li class="page-item"><a class="page-link" href="?page={{ page_obj.next_page_number }}">下一页</a></li>
                            {% endif %}
                        </ul>
                    </nav>
                {% endif %}
            </div>
        </div>

        <div style="margin-top: 20px;">
            <a href="{% url 'teacher_clinical_case_list' %}" class="btn secondary">返回病例列表</a>
        </div>
    </div>
</div>
{% endblock %}
