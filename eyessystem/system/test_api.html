<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>检查选项API测试</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>
<body>
<div class="container mt-5">
    <h1 class="mb-4">检查选项API测试</h1>
    
    <div class="row">
        <div class="col-md-8">
            <div class="card">
                <div class="card-header">
                    <h5>API响应测试</h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label for="caseId" class="form-label">案例ID:</label>
                        <input type="text" class="form-control" id="caseId" value="CASE_001" placeholder="输入案例ID">
                    </div>
                    <button class="btn btn-primary" onclick="testAPI()">测试新的检查选项API</button>
                    
                    <div id="results" class="mt-4"></div>
                </div>
            </div>
        </div>
        
        <div class="col-md-4">
            <div class="card">
                <div class="card-header">
                    <h6>测试说明</h6>
                </div>
                <div class="card-body">
                    <p class="small">这个测试页面用于验证新的检查选项API功能：</p>
                    <ul class="small">
                        <li>混合必选项和干扰项</li>
                        <li>智能数量调整</li>
                        <li>类型多样性保证</li>
                        <li>随机顺序打乱</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
function testAPI() {
    const caseId = document.getElementById('caseId').value;
    const resultsDiv = document.getElementById('results');
    
    resultsDiv.innerHTML = '<div class="spinner-border" role="status"><span class="visually-hidden">Loading...</span></div>';
    
    $.getJSON('/api/clinical/case/' + caseId + '/examinations/')
        .done(function(response) {
            displayResults(response);
        })
        .fail(function(xhr, status, error) {
            resultsDiv.innerHTML = `
                <div class="alert alert-danger">
                    <h6>请求失败</h6>
                    <p>状态码: ${xhr.status}</p>
                    <p>错误信息: ${error}</p>
                    <pre>${xhr.responseText}</pre>
                </div>
            `;
        });
}

function displayResults(response) {
    const resultsDiv = document.getElementById('results');
    
    let html = '';
    
    if (response.success) {
        const data = response.data;
        
        // API响应概览
        html += `
            <div class="alert alert-success">
                <h6>✅ API调用成功</h6>
                <p><strong>消息:</strong> ${response.message}</p>
            </div>
        `;
        
        // 统计信息
        html += `
            <div class="card mb-3">
                <div class="card-header">
                    <h6>📊 统计信息</h6>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-3">
                            <div class="text-center">
                                <h4 class="text-primary">${data.total_count || 0}</h4>
                                <small>总检查项</small>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="text-center">
                                <h4 class="text-success">${data.required_count || 0}</h4>
                                <small>必选项</small>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="text-center">
                                <h4 class="text-warning">${data.distractor_count || 0}</h4>
                                <small>干扰项</small>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="text-center">
                                <span class="badge bg-info">${data.mode || 'unknown'}</span><br>
                                <small>模式</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        // 检查项目列表
        if (data.examination_options && data.examination_options.length > 0) {
            html += `
                <div class="card">
                    <div class="card-header">
                        <h6>🔍 检查项目列表</h6>
                    </div>
                    <div class="card-body">
            `;
            
            data.examination_options.forEach((option, index) => {
                const badgeClass = option.is_case_required ? 'bg-success' : (option.is_distractor ? 'bg-warning' : 'bg-secondary');
                const badgeText = option.is_case_required ? '必选' : (option.is_distractor ? '干扰项' : '常规');
                
                html += `
                    <div class="d-flex justify-content-between align-items-center border-bottom py-2">
                        <div>
                            <strong>${option.name}</strong>
                            <span class="badge ${badgeClass} ms-2">${badgeText}</span>
                            ${option.type ? `<span class="text-muted ms-2">[${option.type}]</span>` : ''}
                            ${option.description ? `<br><small class="text-muted">${option.description}</small>` : ''}
                        </div>
                        <div>
                            <small class="text-muted">#${option.id}</small>
                        </div>
                    </div>
                `;
            });
            
            html += `
                    </div>
                </div>
            `;
        }
        
    } else {
        html += `
            <div class="alert alert-danger">
                <h6>❌ API返回失败</h6>
                <p><strong>错误消息:</strong> ${response.message}</p>
            </div>
        `;
    }
    
    resultsDiv.innerHTML = html;
}

// 页面加载时自动测试
$(document).ready(function() {
    testAPI();
});
</script>

</body>
</html>