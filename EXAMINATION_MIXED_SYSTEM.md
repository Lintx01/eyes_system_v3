# 检查选项智能混合系统

## 功能概述

本系统实现了一个智能的检查选项混合功能，旨在提高眼科临床推理教学的难度和真实性。系统将教师设置的必选检查项目与随机选择的干扰项目混合展示给学生，避免给学生过多的隐性提示。

## 核心特性

### 1. 智能混合算法
- **必选项识别**：系统识别教师为每个案例设置的必选检查项目（`is_required=True`）
- **干扰项生成**：从其他案例或通用检查项池中随机选择干扰项
- **数量自适应**：根据必选项数量智能调整干扰项数量
  - 必选项 ≤ 2个：添加5个干扰项
  - 必选项 3-4个：添加3个干扰项  
  - 必选项 ≥ 5个：添加2个干扰项
- **类型平衡**：保证干扰项类型多样性，优先从不同检查类型中选择

### 2. 两种工作模式

#### 标准模式 (Standard Mode)
- 触发条件：案例没有设置必选检查项目
- 行为：返回该案例的所有检查选项
- 用途：向后兼容，保持原有功能

#### 混合模式 (Mixed Mode)  
- 触发条件：案例设置了必选检查项目
- 行为：混合必选项 + 随机干扰项，随机打乱顺序
- 用途：增加学习难度，更贴近临床实际

### 3. 教师端管理功能

#### 批量设置必选项
- 可视化界面选择必选检查项目
- 实时统计必选项和可选项数量
- 批量更新功能，支持一键设置

#### 统计信息显示
- 必选项数量统计
- 可选项数量统计  
- 混合模式提示信息

## API 接口

### 获取检查选项
```
GET /api/clinical/case/<case_id>/examinations/
```

**响应格式：**
```json
{
  "success": true,
  "data": {
    "examination_options": [...],
    "total_count": 8,
    "required_count": 3,
    "distractor_count": 5,
    "mode": "mixed"
  },
  "message": "检查选项获取成功（含必选项和干扰项）"
}
```

### 批量设置必选项
```
POST /teacher/clinical-cases/<case_id>/batch-set-required/
```

**参数：**
- `required_examinations[]`: 必选检查项目ID数组

## 数据模型

### ExaminationOption 扩展
```python
class ExaminationOption(models.Model):
    # ... 其他字段
    is_required = models.BooleanField(default=False, verbose_name="是否必选")
    # ... 
```

### 新增字段说明
- `is_case_required`: API返回字段，标识是否为当前案例的必选项
- `is_distractor`: API返回字段，标识是否为干扰项

## 实现文件

### 后端实现
1. **views.py**
   - `get_examination_options()`: 智能混合API逻辑
   - `teacher_batch_set_required()`: 批量设置必选项

2. **models.py** 
   - `ExaminationOption.is_required`: 必选项标识字段

3. **urls.py**
   - 添加批量设置路由

### 前端实现
1. **clinical_case_detail.html**
   - 支持新的API响应格式
   - 显示检查选项统计信息
   - 混合模式提示

2. **examination_options.html**
   - 批量设置必选项模态框
   - 实时统计显示
   - 教师管理界面增强

## 测试工具

### 1. API测试页面
- `test_api.html`: 简单的API响应测试
- `examination_test_full.html`: 完整的功能测试和演示

### 2. 管理命令
- `init_distractor_exams.py`: 创建通用干扰项池

## 使用流程

### 教师端操作
1. 进入案例的检查选项管理页面
2. 点击"批量设置必选项"按钮
3. 选择2-6个关键检查项目作为必选项
4. 保存设置

### 学生端体验
1. 进入案例学习，到达检查选择阶段
2. 看到混合后的检查选项（必选项 + 干扰项）
3. 需要根据临床推理选择合适的检查项目
4. 系统不再显示"推荐"、"高价值"等隐性提示

## 教学价值

1. **提高难度**：避免学生直接选择被标记为"推荐"的项目
2. **贴近实际**：模拟临床实际情况，医生需要从众多检查中选择合适的
3. **训练思维**：强化学生的临床推理能力，而非记忆能力
4. **个性化学习**：每次进入都有不同的干扰项组合，增加可重复性

## 技术特点

1. **向后兼容**：未设置必选项的案例继续使用标准模式
2. **随机性保证**：每次访问都有不同的干扰项组合
3. **类型平衡**：确保干扰项涵盖多种检查类型
4. **性能优化**：使用数据库查询优化，避免N+1问题

## 配置建议

### 必选项数量建议
- **简单案例**：2-3个必选项
- **中等难度**：3-4个必选项
- **复杂案例**：4-6个必选项

### 干扰项池维护
- 定期添加新的通用检查项目
- 按检查类型均匀分布
- 避免添加过于明显不相关的检查项

## 监控和分析

系统提供以下数据用于教学效果分析：
- 学生检查选择的准确率变化
- 必选项的选择率统计
- 干扰项的迷惑效果分析
- 不同案例的难度系数评估

## 未来扩展

1. **智能难度调节**：根据学生历史表现动态调整干扰项数量
2. **个性化干扰项**：基于学生弱项生成针对性干扰项
3. **协同过滤**：分析所有学生的选择模式，优化干扰项质量
4. **多维度统计**：提供更详细的教学效果分析报告